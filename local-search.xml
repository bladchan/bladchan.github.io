<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å…³äºLinux IOå¤šè·¯å¤ç”¨é‚£äº›äº‹</title>
    <link href="/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
    <url>/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="å…³äºI-x2F-Oå¤šè·¯å¤ç”¨é‚£äº›äº‹"><a href="#å…³äºI-x2F-Oå¤šè·¯å¤ç”¨é‚£äº›äº‹" class="headerlink" title="å…³äºI/Oå¤šè·¯å¤ç”¨é‚£äº›äº‹"></a>å…³äºI/Oå¤šè·¯å¤ç”¨é‚£äº›äº‹</h1><p><strong>Q1ï¼šä¸ºä»€ä¹ˆéœ€è¦I/Oå¤šè·¯å¤ç”¨ï¼Ÿ</strong>[1]</p><p><strong>A1ï¼š</strong></p><ul><li><p>TCP Socketåªèƒ½å®ç°ä¸€å¯¹ä¸€é€šä¿¡ ==&gt; åŒæ­¥<strong>é˜»å¡</strong>ï¼ˆè¿æ¥è¯·æ±‚é¥¥é¥¿æ€§ï¼‰ï¼šreadé˜»å¡ç›´åˆ°è¯·æ±‚æ•°æ®ä¼ é€è¿‡æ¥å¹¶write</p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ²¡æœ‰I/Oå¤šè·¯å¤ç”¨ï¼Œé‚£å¦‚ä½•æ›´å¥½æœåŠ¡æ›´å¤šçš„ç”¨æˆ·ï¼Ÿ</p><ul><li>ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ ==&gt; ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± </li><li>çº¿ç¨‹æ± çš„ç¼ºç‚¹ï¼š1ï¼‰å¦‚ä½•ç¡®å®šé¢„å…ˆåˆ†é…çš„çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡ï¼Ÿå¦‚æœåˆ†é…å°‘äº†ï¼Œä½†è¿æ¥æ•°æ¿€å¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºç›´æ¥å´©æºƒæˆ–è€…ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€å¤ªå¤§å¯¼è‡´ç¨‹åº<strong>è¿è¡Œæ•ˆç‡å¾ˆä½</strong>ï¼›å¦‚æœåˆ†é…è¿‡å¤šï¼Œä½†è¿æ¥æ•°å¾ˆå°‘ï¼Œä¼šå¯¼è‡´å·²åˆ†é…çš„çº¿ç¨‹å¾—ä¸åˆ°åˆ©ç”¨è€Œé€ æˆ<strong>èµ„æºæµªè´¹</strong></li></ul></li><li><p>I/Oï¼ˆæ—¶åˆ†ï¼‰å¤šè·¯å¤ç”¨ï¼šä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤å¤šä¸ªSocket</p></li></ul><hr><p><strong>Q2ï¼šå¦‚ä½•è¿›è¡ŒI/Oå¤šè·¯å¤ç”¨ï¼Ÿ</strong></p><p><strong>A2ï¼š</strong></p><ul><li><p>ä½¿ç”¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿæœºåˆ¶æ¥è½®è¯¢ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨Linuxä¸­ï¼Œä¸»è¦æœ‰ä¸‰ç§æ“ä½œï¼š<strong>select</strong>ã€<strong>poll</strong>å’Œ<strong>epoll</strong></p></li><li><p>Linuxï¼ˆUnixï¼‰æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„å¤šè·¯å¤ç”¨<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆselectã€pollã€epollï¼‰ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶</p></li></ul><hr><h2 id="E1ï¼šSelectç³»ç»Ÿè°ƒç”¨"><a href="#E1ï¼šSelectç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E1ï¼šSelectç³»ç»Ÿè°ƒç”¨"></a><strong>E1ï¼šSelectç³»ç»Ÿè°ƒç”¨</strong></h2><ul><li><p>å‡½æ•°ç­¾å[3-4]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">select</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">int</span> nfds, <span class="hljs-comment">// æ‰€å…è®¸è®¾ç½®çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼+1</span></span><br><span class="hljs-params">    fd_set *readfds,<span class="hljs-comment">// è¯»æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆselectè¿”å›åï¼Œreadfdsä»…ä¿ç•™é‚£äº›å‡†å¤‡è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰</span></span><br><span class="hljs-params">    fd_set *writefds,<span class="hljs-comment">// å†™æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆselectè¿”å›åï¼Œreadfdsä»…ä¿ç•™é‚£äº›å‡†å¤‡å†™çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰</span></span><br><span class="hljs-params">    fd_set *exceptfds,<span class="hljs-comment">// ç›‘æ§å¼‚å¸¸æ¡ä»¶ï¼ˆexceptional conditionsï¼‰</span></span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> timeval *timeout<span class="hljs-comment">// timevalç»“æ„ä½“ï¼Œç”¨æ¥æè¿°è¶…æ—¶ä¿¡æ¯ï¼ˆå…¨0è¡¨ç¤ºç«‹åˆ»è¿”å›ï¼Œä¸ºNULLè¡¨ç¤ºæ— é™ç­‰å¾…ï¼‰</span></span><br><span class="hljs-params">)</span>;<br></code></pre></td></tr></tbody></table></figure></li><li><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> select()è°ƒç”¨æ¥è§¦é˜»å¡çš„æ¡ä»¶ï¼š</p><ul><li>ä»»æ„ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½äº†</li><li>è°ƒç”¨è¢«ä¸€ä¸ªä¿¡å·å¤„ç†å™¨æ‰€ä¸­æ–­</li><li>è¶…æ—¶ [ç”±å‚æ•°timeoutæ§åˆ¶]</li></ul></li><li><p>ä¸fd_setæ“ä½œæœ‰å…³çš„å®ï¼š</p><ul><li>**FD_ZERO()**ï¼šæ¸…ç©ºset</li><li>**FD_SET()**ï¼šå°†fdæ·»åŠ åˆ°setä¸­</li><li>**FD_CLR()**ï¼šå°†fdä»setä¸­ç§»é™¤</li><li>**FD_ISSET()**ï¼šå¯ä»¥åœ¨è°ƒç”¨select()ä¹‹åï¼Œæ£€æŸ¥æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦ä»ç„¶åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œè¿”å›é0è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦åœ¨é›†åˆä¸­ï¼Œå¦åˆ™è¿”å›0</li></ul></li><li><p><strong>pselect()</strong></p><ul><li><p>å‡½æ•°ç­¾åï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pselect</span><span class="hljs-params">(<span class="hljs-type">int</span> nfds, fd_set *_Nullable <span class="hljs-keyword">restrict</span> readfds,</span><br><span class="hljs-params">                  fd_set *_Nullable <span class="hljs-keyword">restrict</span> writefds,</span><br><span class="hljs-params">                  fd_set *_Nullable <span class="hljs-keyword">restrict</span> exceptfds,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable <span class="hljs-keyword">restrict</span> timeout,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable <span class="hljs-keyword">restrict</span> sigmask)</span>;<br></code></pre></td></tr></tbody></table></figure></li><li><p>æä¾›é¢å¤–ä¸€ä¸ªä¿¡å·æ©ç æ“ä½œï¼Œå…è®¸æ›´å®‰å…¨çš„è°ƒç”¨select</p></li><li><p>ä¸select()çš„åŒºåˆ«ï¼š</p><p>(1) è¶…æ—¶å‚æ•°çš„ç»“æ„ä½“ä¸ä¸€æ ·ï¼šåœ¨<code>select()</code>ä¸­æ˜¯<code>struct timeval</code>ï¼ˆç§’+æ¯«ç§’ï¼‰ï¼Œè€Œåœ¨<code>pselect()</code>ä¸­æ˜¯<code>struct timespec</code>ï¼ˆç§’+çº³ç§’ï¼‰</p><p>(2) æ˜¯å¦ä¿®æ”¹timeoutå€¼ï¼š<code>select()</code>å¯èƒ½ä¼šå°†timeoutå€¼æ›´æ–°ä¸ºè¿˜å‰©ä¸‹çš„æ—¶é—´ï¼Œè€Œ<code>pselect()</code>åˆ™ä¸ä¼šä¿®æ”¹</p><p>(3) sigmaskå‚æ•°</p></li><li><p>ä¸select()ä¹‹é—´çš„ç­‰ä»·è¡¨è¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">ready = pselect(nfds, &amp;readfds, &amp;writefds, &amp;exceptfds,<br>                           timeout, &amp;sigmask);<br><span class="hljs-comment">// Same as ---|:</span><br><span class="hljs-comment">//            v</span><br><span class="hljs-type">sigset_t</span> origmask;<br><br>pthread_sigmask(SIG_SETMASK, &amp;sigmask, &amp;origmask);<br>ready = select(nfds, &amp;readfds, &amp;writefds, &amp;exceptfds, timeout);<br>pthread_sigmask(SIG_SETMASK, &amp;origmask, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>[2]</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXBUF 256</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">child_process</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>  sleep(<span class="hljs-number">2</span>); <span class="hljs-comment">// make sure that server is started</span><br>  <span class="hljs-type">char</span> msg[MAXBUF];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span> =</span> {<span class="hljs-number">0</span>};<br>  <span class="hljs-type">int</span> n, sockfd, num=<span class="hljs-number">1</span>;<br>  srandom(getpid());<br>  <span class="hljs-comment">/* Create socket and connect to server */</span><br>  sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>  addr.sin_family = AF_INET;<br>  addr.sin_port = htons(<span class="hljs-number">2000</span>);<br>  addr.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);<br><br>  connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child {%d} connected \n"</span>, getpid());<br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){  <span class="hljs-comment">// dead loop</span><br>        <span class="hljs-type">int</span> sl = (random() % <span class="hljs-number">10</span>) +  <span class="hljs-number">1</span>;<br>        num++;<br>     sleep(sl);<br>  <span class="hljs-built_in">sprintf</span> (msg, <span class="hljs-string">"Test message %d from client %d"</span>, num, getpid());<br>  n = write(sockfd, msg, <span class="hljs-built_in">strlen</span>(msg));<span class="hljs-comment">/* Send message */</span><br>  }<br><br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">char</span> buffer[MAXBUF];<br>  <span class="hljs-type">int</span> fds[<span class="hljs-number">5</span>];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>  <span class="hljs-type">int</span> addrlen, n,i,max=<span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> sockfd, commfd;<br>  fd_set rset;<br>  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++)<br>  {<br>  <span class="hljs-keyword">if</span>(fork() == <span class="hljs-number">0</span>)<br>  {<br>  child_process();<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  }<br>  }<br><br>  sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (addr));<br>  addr.sin_family = AF_INET;<br>  addr.sin_port = htons(<span class="hljs-number">2000</span>);<br>  addr.sin_addr.s_addr = INADDR_ANY;<br>  bind(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));<br>  listen (sockfd, <span class="hljs-number">5</span>); <br><br>  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>  {<br>    <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (client));<br>    addrlen = <span class="hljs-keyword">sizeof</span>(client);<br>    fds[i] = accept(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>    <span class="hljs-keyword">if</span>(fds[i] &gt; max)<br>    max = fds[i];<br>  }<br>  <br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>FD_ZERO(&amp;rset);<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">5</span>; i++ ) {<br>  FD_SET(fds[i],&amp;rset);<br>  }<br><br>   <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>select(max+<span class="hljs-number">1</span>, &amp;rset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br><span class="hljs-keyword">if</span> (FD_ISSET(fds[i], &amp;rset)){ <span class="hljs-comment">// å¦‚æœæ–‡ä»¶æè¿°ç¬¦åœ¨è¿™ä¸ªé›†åˆé‡Œï¼Œæ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(fds[i], buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>}<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦ä¼ å…¥nfdså¹¶å‘Šè¯‰<code>select()</code>å½“å‰æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­æœ€å¤§å€¼+1ï¼Ÿ</p><p><strong>A:</strong> ä¸fd_setçš„å®ç°æœ‰å…³ï¼šæ¯ä¸ªfdè¡¨ç¤ºä¸ºä¸€ä¸ªæ¯”ç‰¹ï¼Œfd_setæ˜¯ä¸€ä¸ª32ä¸ªæ•´æ•°çš„æ•°ç»„ï¼Œå…±1024æ¯”ç‰¹ï¼›æˆ‘ä»¬è¿›ä¸€æ­¥å‡è®¾æœ‰5ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æœ€é«˜çš„æ–‡ä»¶æè¿°ç¬¦å€¼æ˜¯900ï¼Œé‚£ä¹ˆå‡½æ•°å°†ä¼šæ£€æŸ¥ä»0åˆ°900çš„æ¯”ç‰¹è€Œä¸éœ€è¦æ£€æŸ¥åˆ°1024</p></li></ul><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>åœ¨æ¯ä¸€æ¬¡è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦æ„é€ æ¯ä¸€ä¸ªé›†åˆï¼ˆä¸‰ä¸ªé›†åˆï¼‰</li><li>å‡½æ•°é€ä½æ£€æŸ¥åˆ°æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼ - å¤æ‚åº¦ï¼šO(n)</li><li>éœ€è¦åœ¨selectè°ƒç”¨ä¹‹åæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦åœ¨selectè¿”å›çš„é›†åˆä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†</li><li>selectæœ€å¤šåªèƒ½ç›‘å¬1024ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆåº•å±‚ä½¿ç”¨BitsMapå®ç°ï¼‰</li></ul><h2 id="E2ï¼šPollç³»ç»Ÿè°ƒç”¨"><a href="#E2ï¼šPollç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E2ï¼šPollç³»ç»Ÿè°ƒç”¨"></a>E2ï¼šPollç³»ç»Ÿè°ƒç”¨</h2><ul><li><p>å‡½æ•°ç­¾å[5]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">poll</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> pollfd *fds,</span><br><span class="hljs-params">    <span class="hljs-type">nfds_t</span> nfds,<span class="hljs-comment">// fdsæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼ï¼ˆæ³¨æ„è¿™é‡Œä¸select()å‡½æ•°çš„åŒºåˆ«ï¼‰</span></span><br><span class="hljs-params">    <span class="hljs-type">int</span> timeout</span><br><span class="hljs-params">)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">ppoll</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> pollfd *fds, <span class="hljs-type">nfds_t</span> nfds,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable tmo_p,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask</span><br><span class="hljs-params">)</span>;<br><span class="hljs-comment">/* struct pollfd */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> {</span><br>    <span class="hljs-type">int</span>   fd;         <span class="hljs-comment">/* file descriptor */</span><br>    <span class="hljs-type">short</span> events;     <span class="hljs-comment">/* requested events */</span><br>    <span class="hljs-type">short</span> revents;    <span class="hljs-comment">/* returned events */</span><br>};<br><br></code></pre></td></tr></tbody></table></figure></li><li><p><code>poll()</code>è°ƒç”¨é˜»å¡æ¥è§¦é€»è¾‘ä¸<code>select()</code>ä¸€æ ·</p></li><li><p>åœ¨eventså’Œreventsï¼ˆpoll.hï¼‰ä¸­å®šä¹‰çš„æ¯”ç‰¹ï¼š</p><ul><li><strong>POLLIN</strong>ï¼šæœ‰æ•°æ®è¦è¯»</li><li><strong>POLLPRI</strong>ï¼šæ–‡ä»¶æè¿°ç¬¦å­˜åœ¨ä¸€äº›å¼‚å¸¸ï¼Œå¯èƒ½åŒ…æ‹¬ï¼šTCP socketä¸­æœ‰å¸¦å¤–æ•°æ®ç­‰</li><li><strong>POLLOUT</strong>ï¼šå¯å†™</li><li><strong>POLLRDHUP</strong>ï¼šæµsocketå…³é—­è¿æ¥ or è¿æ¥é€”ä¸­å…³é—­å†™æ“ä½œ</li><li><strong>POLLERR</strong>ï¼šé”™è¯¯æ¡ä»¶ *</li><li><strong>POLLHUP</strong>ï¼šæŒ‚èµ· *</li><li><strong>POLLNVAL</strong>ï¼šæ— æ•ˆè¯·æ±‚ï¼Œfdæœªæ‰“å¼€ *</li></ul><p>ps: * è¡¨ç¤ºåªä¼šå‡ºç°åœ¨reventsä¸­</p></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†ä¸Šè¿°<code>select()</code>ç¤ºä¾‹ä»£ç è¿›è¡Œç›¸åº”çš„ä¿®æ”¹</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br>...<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfds[<span class="hljs-number">5</span>];<br>    ...<br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>    {<br>        <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span> (client));<br>        addrlen = <span class="hljs-built_in">sizeof</span>(client);<br>        pollfds[i].fd = <span class="hljs-built_in">accept</span>(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>        pollfds[i].events = POLLIN;<br>    }<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>        <span class="hljs-built_in">poll</span>(pollfds, <span class="hljs-number">5</span>, <span class="hljs-number">50000</span>);<br><br>        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br>            <span class="hljs-keyword">if</span> (pollfds[i].revents &amp; POLLIN){<br>                pollfds[i].revents = <span class="hljs-number">0</span>;<br>                <span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>                <span class="hljs-built_in">read</span>(pollfds[i].fd, buffer, MAXBUF);<br>                <span class="hljs-built_in">puts</span>(buffer);<br>            }<br>        }<br>    }<br>    ...<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/1.png"></p></li></ul><h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>**poll() <span class="github-emoji"><span>ğŸ†š</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f19a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> select(): **</p><ul><li><p><code>poll()</code>ä¸éœ€è¦ä½¿ç”¨è€…è®¡ç®—æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼+1çš„å€¼ã€‚</p></li><li><p><code>poll()</code>å¯¹äºå¤§æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦æ¥è¯´æ›´æœ‰æ•ˆã€‚ä»ç„¶å‡è®¾æœ€å¤§å€¼ä¸º900çš„äº”ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>poll()</code>ä»…éœ€éå†5æ¬¡ï¼Œè€Œä½¿ç”¨<code>select()</code>åˆ™éœ€è¦éå†900æ¬¡</p></li><li><p><code>select()</code>çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆæ˜¯å®šé•¿çš„ï¼ˆ1024ï¼‰</p></li><li><p>åœ¨<code>select()</code>ä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦é›†åˆåœ¨è¿”å›æ—¶é‡æ–°æ„å»ºï¼Œå› æ­¤éšåæ¯ä¸€æ¬¡è°ƒç”¨æ—¶éƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–ä»–ä»¬ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>FD_ZERO(&amp;rset);<br> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">5</span>; i++ ) {<br> FD_SET(fds[i],&amp;rset);   <span class="hljs-comment">// &lt;================= é‡æ–°åˆå§‹åŒ–ï¼</span><br> }<br>  <br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>select(max+<span class="hljs-number">1</span>, &amp;rset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>  <br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br><span class="hljs-keyword">if</span> (FD_ISSET(fds[i], &amp;rset)){ <span class="hljs-comment">// å¦‚æœæ–‡ä»¶æè¿°ç¬¦åœ¨è¿™ä¸ªé›†åˆé‡Œï¼Œæ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(fds[i], buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>}<br> }<br></code></pre></td></tr></tbody></table></figure><p>è€Œ<code>poll()</code>å°†è¾“å…¥ï¼ˆeventså­—æ®µï¼‰å’Œè¾“å‡ºï¼ˆreventså­—æ®µï¼‰åˆ†éš”å¼€ï¼Œå…è®¸æ•°ç»„é‡æ–°ä½¿ç”¨ï¼ˆè¿™é‡Œå¯ä»¥ç†è§£ä¸º<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</strong>ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>    poll(pollfds, <span class="hljs-number">5</span>, <span class="hljs-number">50000</span>);  <span class="hljs-comment">// &lt;================== ç”Ÿäº§revent</span><br>  <br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br>        <span class="hljs-keyword">if</span> (pollfds[i].revents &amp; POLLIN){<br>            pollfds[i].revents = <span class="hljs-number">0</span>;        <span class="hljs-comment">// &lt;================= æ¶ˆè´¹äº†ï¼Œæ¸…ç©ºrevent</span><br>            <span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>            read(pollfds[i].fd, buffer, MAXBUF);<br>            <span class="hljs-built_in">puts</span>(buffer);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>select()</code>æ›´åŠ å…·æœ‰å¯ç§»æ¤æ€§ï¼Œå› ä¸ºæŸäº›Unixç³»ç»Ÿä¸æ”¯æŒ<code>poll()</code></p></li></ul><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å†æ·±å…¥æ€è€ƒä¸€ä¸‹ï¼Œ<code>select()</code>å’Œ<code>poll()</code>æœ€æœ¬è´¨çš„åŒºåˆ«å…¶å®æ˜¯æ•°æ®ç»“æ„ä¸Šçš„è°ƒæ•´ï¼Œ<code>select()</code>ä½¿ç”¨äº†<strong>ä¸‰ä¸ªæ•°ç»„æ¥åˆ†åˆ«ç»´æŠ¤</strong>è¯»æè¿°ç¬¦ã€å†™æè¿°ç¬¦å’Œå¼‚å¸¸å¤„ç†æè¿°ç¬¦ï¼Œè€Œ<code>poll()</code>ä»…ä½¿ç”¨äº†<strong>ä¸€ä¸ªæ•°ç»„æ¥ç»´æŠ¤æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œä½†æ˜¯ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ä¸€ä¸ªåä¸ºpollfdsçš„ç»“æ„ä½“å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œè€Œ<strong>è¯¥ç»“æ„ä½“ä¸­çš„eventå­—æ®µæè¿°äº†æ–‡ä»¶æè¿°ç¬¦çš„ç±»å‹</strong>ã€‚</p><h2 id="E3-Epollç³»ç»Ÿè°ƒç”¨"><a href="#E3-Epollç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E3: Epollç³»ç»Ÿè°ƒç”¨"></a>E3: Epollç³»ç»Ÿè°ƒç”¨</h2><ul><li><p>å‡½æ•°ç­¾å[7-9]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_create1</span><span class="hljs-params">(<span class="hljs-type">int</span> flags)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *_Nullable event)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_pwait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout, <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_pwait2</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, </span><br><span class="hljs-params">                 <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable timeout, <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask)</span>;<br><br><span class="hljs-comment">// event structure</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> {</span><br>     <span class="hljs-type">uint32_t</span>      events;  <span class="hljs-comment">/* Epoll events */</span><br>     <span class="hljs-type">epoll_data_t</span>  data;    <span class="hljs-comment">/* User data variable */</span><br>};<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">epoll_data</span> {</span><br>     <span class="hljs-type">void</span>     *ptr;<br>     <span class="hljs-type">int</span>       fd;<br>     <span class="hljs-type">uint32_t</span>  u32;<br>     <span class="hljs-type">uint64_t</span>  u64;<br>};<br></code></pre></td></tr></tbody></table></figure></li><li><p>epoll APIæ ¸å¿ƒæ¦‚å¿µæ˜¯epollå®ä¾‹ï¼Œå…¶æ˜¯ä¸€ä¸ªå†…æ ¸æ•°æ®ç»“æ„ï¼Œä»ç”¨æˆ·ç©ºé—´çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯ä»¥è¢«çœ‹åšæ˜¯<strong>ä¸¤ä¸ªåˆ—è¡¨</strong>çš„å®¹å™¨[6]ï¼š</p><ul><li>interest listï¼ˆæœ‰æ—¶ä¹Ÿè¢«ç§°ä½œepoll setï¼‰ï¼šè¿›ç¨‹æ³¨å†Œç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ</li><li>ready listï¼šå·²ç»å‡†å¤‡å¥½ç”¨äºI/Oæ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ˜¯interest listçš„ä¸€ä¸ªå­é›†</li></ul></li><li><p>åˆ›å»ºå¹¶ç®¡ç†epollå®ä¾‹çš„ç³»ç»Ÿè°ƒç”¨æœ‰ï¼š</p><ol><li>epoll_createï¼ˆepoll_create1ï¼‰ï¼šåœ¨å†…æ ¸ä¸­åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆi.e. å®ä¾‹ï¼‰</li><li>epoll_ctlï¼šä»ä¸Šä¸‹æ–‡ä¸­æ·»åŠ æˆ–è€…åˆ é™¤æ–‡ä»¶æè¿°ç¬¦</li><li>epoll_waitï¼š ç­‰å¾…ä¸Šä¸‹æ–‡ä¸­çš„äº‹ä»¶</li></ol></li><li><p>æ°´å¹³è§¦å‘ï¼ˆLevel-triggeredï¼Œ<strong>LT</strong>ï¼‰ å’Œ è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼Œ<strong>ET</strong>ï¼‰</p><ul><li><p>ä¸¤ç§äº‹ä»¶è§¦å‘æœºåˆ¶</p></li><li><p>å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼š</p><ol><li>åœ¨ç®¡é“çš„<strong>è¯»</strong>æ–¹çš„æ–‡ä»¶æè¿°ç¬¦ (rfd) å·²ç»è¢«æ³¨å†Œåˆ°epollå®ä¾‹ä¸­</li><li>åœ¨ç®¡é“å¦ä¸€ä¸ªå†™æ–¹å¾€ç®¡é“ä¸­å†™å…¥2KBçš„æ•°æ®</li><li>è°ƒç”¨epoll_wait()ï¼Œå…¶å°†è¿”å›rfdä½œä¸ºå°±ç»ªæ–‡ä»¶æè¿°ç¬¦</li><li>ç®¡é“è¯»æ–¹ä»rfdä¸­è¯»å…¥1KBæ•°æ®</li><li>å†æ¬¡è°ƒç”¨epoll_wait()</li></ol><p>å¦‚æœåœ¨ä¸Šè¿°åœºæ™¯ä¸­rfdæ–‡ä»¶æè¿°ç¬¦æ·»åŠ äº†<code>EPOLLET</code>ï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰çš„æ ‡å¿—ï¼Œé‚£ä¹ˆåœ¨Step 5ä¸­çš„<code>epoll_wait()</code>å°†ä¼šè¢«é˜»å¡ï¼Œå°½ç®¡ç®¡é“ä¸­è¿˜æœ‰1KBå­—èŠ‚æœªè¯»ã€‚åŸå› åœ¨äºè¾¹ç¼˜è§¦å‘ä»…åœ¨<strong>è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿæ”¹å˜æ—¶</strong>æ‰ä¼šä¼ é€’äº‹ä»¶ï¼›å½“ä½¿ç”¨ä¸€ä¸ªæ°´å¹³è§¦å‘æœºåˆ¶æ—¶ï¼ˆé»˜è®¤ï¼Œä¸æŒ‡å®š<code>EPOLLET</code>ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä»<code>epoll_wait()</code>è°ƒç”¨ä¸­å”¤é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºè¢«è¯»å®Œæ‰ç»“æŸã€‚è¿™æ ·èƒ½ä¿è¯è®©æˆ‘ä»¬çŸ¥é“æœ‰å“ªäº›æ•°æ®éœ€è¦è¯»å–ã€‚</p></li></ul></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¿®æ”¹ä¸Šè¿°çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span><br>...<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">events</span>[5];</span><br>  <span class="hljs-type">int</span> epfd = epoll_create(<span class="hljs-number">10</span>);<br>  ...<br>  ...<br>  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>  {<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">ev</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (client));<br>    addrlen = <span class="hljs-keyword">sizeof</span>(client);<br>    ev.data.fd = accept(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>    ev.events = EPOLLIN;<br>    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev);  <span class="hljs-comment">// å°†äº‹ä»¶æ·»åŠ åˆ°epollå®ä¾‹ä¸­</span><br>  }<br>  <br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>  nfds = epoll_wait(epfd, events, <span class="hljs-number">5</span>, <span class="hljs-number">10000</span>);   <span class="hljs-comment">// wait</span><br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;nfds;i++) {   <span class="hljs-comment">// éå†å°±ç»ªäº‹ä»¶ï¼Œå°±ç»ªäº‹ä»¶å·²æ›´æ–°åˆ°eventsä¸­ï¼Œå–å‡ºç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(events[i].data.fd, buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>  }<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="å°ç»“-2"><a href="#å°ç»“-2" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>Epoll() <span class="github-emoji"><span>ğŸ†š</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f19a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Select()/Poll()</strong></p><ul><li><p><code>select()</code>/<code>poll()</code>ä»…æä¾›ä¸€ä¸ªAPIï¼ˆå½“ç„¶ä¹Ÿæä¾›äº†ä¸€äº›å®å®šä¹‰ï¼‰ï¼Œè€Œ<code>epoll()</code>æä¾›äº†ä¸‰ä¸ªAPI</p></li><li><table><thead><tr><th>[10]</th><th><code>select()</code></th><th><code>poll()</code></th><th><code>epoll()</code></th></tr></thead><tbody><tr><td><strong>æœ€å¤§è¿æ¥æ•°</strong></td><td>1024<br>ã€æ•°ç»„ã€‘</td><td>ä¸æ“ä½œç³»ç»Ÿæœ‰å…³<br>ã€é“¾è¡¨ã€‘</td><td>ä¸æ“ä½œç³»ç»Ÿæœ‰å…³<br></td></tr><tr><td><strong>FDæ¿€å¢åå¸¦æ¥çš„I/Oæ•ˆç‡é—®é¢˜</strong></td><td>O(n) çº¿æ€§ä¸‹é™</td><td>O(n) çº¿æ€§ä¸‹é™</td><td>ä¸æ´»è·ƒsocketæ•°æ®æœ‰å…³</td></tr><tr><td><strong>æ¶ˆæ¯ä¼ é€’æ–¹å¼</strong></td><td>å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œ<br>éƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ</td><td>åŒ<code>select()</code></td><td>é€šè¿‡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„<br>mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’</td></tr><tr><td><strong>éå†å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ–¹å¼</strong></td><td>åŸºäºè½®è¯¢æœºåˆ¶</td><td>åŸºäºè½®è¯¢æœºåˆ¶</td><td>åŸºäºæ“ä½œç³»ç»Ÿçš„I/Oé€šçŸ¥æœºåˆ¶</td></tr></tbody></table></li><li><p><code>epoll()</code>ä»…æ”¯æŒlinuxï¼Œè·¨å¹³å°å¯èƒ½å­˜åœ¨ä¸å…¼å®¹çš„é—®é¢˜</p></li></ul><h2 id="link-Reference"><a href="#link-Reference" class="headerlink" title=":link: Reference:"></a><span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Reference:</h2><ol><li><a href="https://juejin.cn/post/7243609307856683067">I/Oå¤šè·¯å¤ç”¨çš„ä¸‰ç§å®ç° - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/">Linux â€“ IO Multiplexing â€“ Select vs Poll vs Epoll â€“ Developers Area (devarea.com)</a></li><li><a href="https://linux.die.net/man/2/select">select(2): synchronous I/O multiplexing - Linux man page (die.net)</a></li><li><a href="https://man7.org/linux/man-pages/man2/select.2.html">select(2) - Linux manual page (man7.org)</a></li><li><a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll(2) - Linux manual page (man7.org)</a></li><li><a href="https://man7.org/linux/man-pages/man7/epoll.7.html">https://man7.org/linux/man-pages/man7/epoll.7.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_create.2.html">https://man7.org/linux/man-pages/man2/epoll_create.2.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">https://man7.org/linux/man-pages/man2/epoll_ctl.2.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_wait.2.html">https://man7.org/linux/man-pages/man2/epoll_wait.2.html</a></li><li><a href="https://blog.csdn.net/qq_41951923/article/details/107886934">selectã€pollå’Œepoll_epollæœ€å¤§è¿æ¥æ•°_Cudi_çš„åšå®¢-CSDNåšå®¢</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>å¤šè·¯å¤ç”¨</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFLplusplus cmplogæ’æ¡©è§£æ</title>
    <link href="/2023/04/20/AFLplusplus-cmplog%E6%8F%92%E6%A1%A9%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/04/20/AFLplusplus-cmplog%E6%8F%92%E6%A1%A9%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-â€™s-Cmplogæ’æ¡©"><a href="#AFL-â€™s-Cmplogæ’æ¡©" class="headerlink" title="AFL++â€™s Cmplogæ’æ¡©"></a>AFL++â€™s Cmplogæ’æ¡©</h1><h2 id="1-æºç è§£æ"><a href="#1-æºç è§£æ" class="headerlink" title="1. æºç è§£æ"></a>1. æºç è§£æ</h2><h3 id="afl-cc-c"><a href="#afl-cc-c" class="headerlink" title="afl-cc.c"></a>afl-cc.c</h3><ul><li>ä»£ç ç‰‡æ®µï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (cmplog_mode) {<br><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fno-inline"</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_MAJOR &gt;= 11                                <span class="hljs-comment">/* use new pass manager */</span></span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fexperimental-new-pass-manager"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"-fpass-plugin=%s/cmplog-switches-pass.so"</span>, obj_path);<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fexperimental-new-pass-manager"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"-fpass-plugin=%s/split-switches-pass.so"</span>, obj_path);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-load"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"%s/cmplog-switches-pass.so"</span>, obj_path);<br><br>      <span class="hljs-comment">// reuse split switches from laf</span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-load"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"%s/split-switches-pass.so"</span>, obj_path);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>cmplog-switches-pass.so</code>å’Œ<code>split-switches-pass.so</code>æ˜¯ä¸¤ä¸ªå…³é”®çš„åŠ¨æ€å…±äº«åº“</li></ul><h3 id="cmplog-switches-pass-cc"><a href="#cmplog-switches-pass-cc" class="headerlink" title="cmplog-switches-pass.cc"></a>cmplog-switches-pass.cc</h3><ul><li><p>CmplogSwitchesç±»ï¼š</p><ul><li><p>æ„é€ å‡½æ•°ï¼šinitInstrumentList()  ==&gt; ä»ç¯å¢ƒå˜é‡ <code>AFL_LLVM_ALLOWLIST</code>/<code>AFL_LLVM_DENYLIST</code> <strong>è§£æ</strong>ç™½åå•/é»‘åå•</p></li><li><p><code>runOnModule() / run()</code> (LLVM &gt;= 11)</p></li><li><p><code>getPassName()</code>  ==&gt;  è¿”å›å­—ç¬¦ä¸² â€œcmplog switch splitâ€ï¼Œè¡¨ç¤ºè¯¥Passåå­—</p></li><li><p>ç§æœ‰æ–¹æ³•ï¼š<code>hookInstrs()</code> ?</p></li></ul></li><li><p><code>hookInstrs()</code>ï¼š</p><ul><li><p>ä»£ç ç‰‡æ®µï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &gt;= 9</span><br>  FunctionCallee<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  Constant *<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      c1 = M.<span class="hljs-built_in">getOrInsertFunction</span>(<span class="hljs-string">"__cmplog_ins_hook1"</span>, VoidTy, Int8Ty, Int8Ty,<br>                                 Int8Ty<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &lt; 5</span><br>                                 ,<br>                                 <span class="hljs-literal">NULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      );<br>...<br></code></pre></td></tr></tbody></table></figure></li><li><p>c1ã€c2ã€c4ã€c8 ==&gt; <code>__cmplog_ins_hook1()</code> ã€<code>__cmplog_ins_hook2()</code> ã€<code>__cmplog_ins_hook4()</code>ã€<code>__cmplog_ins_hook8()</code></p><ul><li>hookå‡½æ•°åœ¨<code>afl-compiler-rt.o.c</code>ä¸­è¢«å®šä¹‰</li><li>è¿™é‡Œåˆ›å»ºç›¸åº”çš„å‡½æ•°å‡½æ•°</li><li>æ’æ¡©å‡½æ•°åˆ†æ <span class="github-emoji"><span>âœ…</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li></ul></li><li><p><code>__afl_cmp_map</code>ï¼š</p><ul><li>cmpå¼•å…¥çš„ä½å›¾</li><li>ä½œç”¨ï¼Ÿ</li></ul></li><li><p>éå†IRä¸­æ‰€æœ‰SwitchInstæŒ‡ä»¤ï¼Œå°†<strong>NumCases&gt;1</strong>çš„æŒ‡ä»¤ä¿å­˜åˆ°switcheså‘é‡ä¸­ï¼Œè°ƒç”¨vectorçš„erase()å’Œstd::remove()å®ŒæˆSwitchInstæŒ‡ä»¤çš„å»é‡</p></li><li><p>ç„¶åéå†æ¯ä¸€ä¸ªSwitchInstæŒ‡ä»¤ï¼ˆSIï¼‰ï¼š</p><ul><li>è·³è¿‡SIå½“ï¼š1. æ•´æ•°æ¯”ç‰¹å®½åº¦&lt;16çš„æ¡ä»¶åˆ†æ”¯ï¼ˆå¤ªç®€å•äº†ï¼Œå¾ˆå®¹æ˜“å˜å¼‚åˆ°ï¼‰ æˆ– 2. Caseæ•°ä¸º0ï¼Ÿ</li><li>å½“æ¯”ç‰¹å®½åº¦æ¨¡8ä¸ä¸º0æ—¶ï¼Œæ¯”ç‰¹å®½åº¦å–å€¼å‘ä¸Šå–æ•´ä¸º8çš„æ•´æ•°å€ï¼ŒåŒæ—¶éœ€è¦åšå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆcastï¼‰</li><li>è¿›è¡Œæ’æ¡©ï¼Œä¸»è¦å°±æ˜¯å°†<strong>æ¡ä»¶å€¼</strong>ã€<strong>caseæ¯”è¾ƒå€¼</strong>å’Œ<strong>ä¸€ä¸ªå¸¸æ•°1</strong>ä¼ é€’ç»™hookå‡½æ•°ï¼Œä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span>(__afl_cmp_map){<br>    <span class="hljs-comment">// æ˜¯å¦éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢?</span><br>    <span class="hljs-comment">// e.g. for case 1:</span><br>    __cmplog_ins_hook1((cast_size) condition, (cast_size) caseValue1, <span class="hljs-number">1</span>);<br>    __cmplog_ins_hook2((cast_size) condition, (cast_size) caseValue2, <span class="hljs-number">1</span>);<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure></li></ul></li></ul><hr><ul><li><code>runOnModule()</code><ul><li>è°ƒç”¨<code>hookInstrs()</code>å‡½æ•°</li></ul></li></ul><h3 id="split-switches-pass-so-cc"><a href="#split-switches-pass-so-cc" class="headerlink" title="split-switches-pass.so.cc"></a>split-switches-pass.so.cc</h3><ul><li><p>SplitSwitchesTransformç±»ï¼š</p><ul><li>æ„é€ å‡½æ•°ï¼šinitInstrumentList()  ==&gt; ä»ç¯å¢ƒå˜é‡ <code>AFL_LLVM_ALLOWLIST</code>/<code>AFL_LLVM_DENYLIST</code> <strong>è§£æ</strong>ç™½åå•/é»‘åå•</li><li><code>runOnModule() / run()</code> (LLVM &gt;= 11)</li><li><code>getPassName()</code>  ==&gt;  è¿”å›å­—ç¬¦ä¸² â€œsplits switch constructsâ€ï¼Œè¡¨ç¤ºè¯¥Passåå­—</li><li>CaseExprç»“æ„ä½“ï¼š å»ºç«‹Caseå€¼åˆ°åŸºæœ¬å—çš„æ˜ å°„ï¼ŒCaseVectorç”¨æ¥å­˜å‚¨CaseExprä¿¡æ¯</li><li>ç§æœ‰æ–¹æ³•ï¼š1ã€splitSwitches (bool)ï¼› 2ã€transformCmps (bool)ï¼›3ã€switchConvert<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li></ul></li><li><p><code>runOnModule() / run()</code>ï¼š</p><ul><li>è°ƒç”¨<code>splitSwitches(&amp;M);</code></li></ul></li><li><p><code>splitSwitches()</code>ï¼š</p><ul><li>éå†æ¨¡å—ä¸­çš„æ‰€æœ‰åŸºæœ¬å—ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„switchæŒ‡ä»¤ï¼Œå¹¶ä¿å­˜åˆ°switchesæ•°ç»„ä¸­ï¼Œè·³è¿‡NumCase&lt;1çš„åˆ†æ”¯</li><li>éå†æ¯ä¸€ä¸ªswitchè¯­å¥ï¼Œå…·ä½“æ¥è¯´ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;SI : switches) {<br><br>    BasicBlock *CurBlock = SI-&gt;<span class="hljs-built_in">getParent</span>();<br>    BasicBlock *OrigBlock = CurBlock;<br>    Function *  F = CurBlock-&gt;<span class="hljs-built_in">getParent</span>();<br>    <span class="hljs-comment">/* this is the value we are switching on */</span><br>    Value *     Val = SI-&gt;<span class="hljs-built_in">getCondition</span>();<br>    BasicBlock *Default = SI-&gt;<span class="hljs-built_in">getDefaultDest</span>();<br>    <span class="hljs-type">unsigned</span>    bitw = Val-&gt;<span class="hljs-built_in">getType</span>()-&gt;<span class="hljs-built_in">getIntegerBitWidth</span>();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        if (!be_quiet)</span><br><span class="hljs-comment">          errs() &lt;&lt; "switch: " &lt;&lt; SI-&gt;getNumCases() &lt;&lt; " cases " &lt;&lt; bitw</span><br><span class="hljs-comment">                 &lt;&lt; " bit\n";</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-comment">/* If there is only the default destination or the condition checks 8 bit or</span><br><span class="hljs-comment">     * less, don't bother with the code below. */</span><br>    <span class="hljs-keyword">if</span> (SI-&gt;<span class="hljs-built_in">getNumCases</span>() &lt; <span class="hljs-number">2</span> || bitw % <span class="hljs-number">8</span> || bitw &gt; <span class="hljs-number">64</span>) {<br><br>      <span class="hljs-comment">// if (!be_quiet) errs() &lt;&lt; "skip switch..\n";</span><br>      <span class="hljs-keyword">continue</span>;<br><br>    }<br><br>    <span class="hljs-comment">/* Create a new, empty default block so that the new hierarchy of</span><br><span class="hljs-comment">     * if-then statements go to this and the PHI nodes are happy.</span><br><span class="hljs-comment">     * if the default block is set as an unreachable we avoid creating one</span><br><span class="hljs-comment">     * because will never be a valid target.*/</span><br>    BasicBlock *NewDefault = <span class="hljs-literal">nullptr</span>;<br>    NewDefault = BasicBlock::<span class="hljs-built_in">Create</span>(SI-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-string">"NewDefault"</span>, F, Default); <span class="hljs-comment">// åœ¨åŸºæœ¬å—Defaultå‰é¢æ’å…¥ä¸€ä¸ªåä¸ºNewDefaultçš„åŸºæœ¬å—ã€‚åˆ›å»ºæ–°åŸºæœ¬å—çš„ç›®çš„æ˜¯å•¥ï¼Ÿ</span><br>    BranchInst::<span class="hljs-built_in">Create</span>(Default, NewDefault);  <span class="hljs-comment">// åˆ›å»º NewDefault ==&gt; Default çš„æ§åˆ¶æµ</span><br><br>    <span class="hljs-comment">/* Prepare cases vector. */</span><br>    CaseVector Cases;<br>    <span class="hljs-keyword">for</span> (SwitchInst::CaseIt i = SI-&gt;<span class="hljs-built_in">case_begin</span>(), e = SI-&gt;<span class="hljs-built_in">case_end</span>(); i != e;<br>         ++i)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &gt;= 5</span><br>      Cases.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CaseExpr</span>(i-&gt;<span class="hljs-built_in">getCaseValue</span>(), i-&gt;<span class="hljs-built_in">getCaseSuccessor</span>()));  <span class="hljs-comment">// getCaseSuccessor() è·å–ä¸caseç›¸å…³è”çš„åŸºæœ¬å—æŒ‡é’ˆ</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      Cases.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CaseExpr</span>(i.<span class="hljs-built_in">getCaseValue</span>(), i.<span class="hljs-built_in">getCaseSuccessor</span>()));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">/* bugfix thanks to pbst</span><br><span class="hljs-comment">     * round up bytesChecked (in case getBitWidth() % 8 != 0) */</span><br>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-title">bytesChecked</span><span class="hljs-params">((<span class="hljs-number">7</span> + Cases[<span class="hljs-number">0</span>].Val-&gt;getBitWidth()) / <span class="hljs-number">8</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-literal">false</span>)</span></span>;<br>    BasicBlock *      SwitchBlock =<br>        switchConvert(Cases, bytesChecked, OrigBlock, NewDefault, Val, <span class="hljs-number">0</span>);  <span class="hljs-comment">// è°ƒç”¨switchConvert()</span><br><br>    <span class="hljs-comment">/* Branch to our shiny new if-then stuff... */</span><br>    BranchInst::<span class="hljs-built_in">Create</span>(SwitchBlock, OrigBlock);<span class="hljs-comment">// åˆ›å»ºæ–°çš„æ§åˆ¶æµï¼Œæ–°åˆ›å»ºçš„SwitchBlockå— --&gt; OrigBlock</span><br><br>    <span class="hljs-comment">/* We are now done with the switch instruction, delete it. */</span><br>    CurBlock-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">erase</span>(SI);<span class="hljs-comment">// åˆ é™¤åŸswitchè¯­å¥ï¼Ÿ ä¹Ÿå°±æ˜¯å°†åŸswitchæ›¿æ¢ä¸ºSwitchBlock</span><br><br>    <span class="hljs-comment">/* we have to update the phi nodes! */</span><span class="hljs-comment">// æ›´æ–°phièŠ‚ç‚¹ï¼Ÿ</span><br>    <span class="hljs-keyword">for</span> (BasicBlock::iterator I = Default-&gt;<span class="hljs-built_in">begin</span>(); I != Default-&gt;<span class="hljs-built_in">end</span>(); ++I) {<br><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isa</span>&lt;PHINode&gt;(&amp;*I)) { <span class="hljs-keyword">continue</span>; }<br>      PHINode *PN = <span class="hljs-built_in">cast</span>&lt;PHINode&gt;(I);<br><br>      <span class="hljs-comment">/* Only update the first occurrence. */</span><br>      <span class="hljs-type">unsigned</span> Idx = <span class="hljs-number">0</span>, E = PN-&gt;<span class="hljs-built_in">getNumIncomingValues</span>();<br>      <span class="hljs-keyword">for</span> (; Idx != E; ++Idx) {<br><br>        <span class="hljs-keyword">if</span> (PN-&gt;<span class="hljs-built_in">getIncomingBlock</span>(Idx) == OrigBlock) {<br><br>          PN-&gt;<span class="hljs-built_in">setIncomingBlock</span>(Idx, NewDefault);<br>          <span class="hljs-keyword">break</span>;<br><br>        }<br><br>      }<br><br>    }<br><br>  }<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>switchConvert()</code>ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">BasicBlock *<span class="hljs-title">SplitSwitchesTransform::switchConvert</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    CaseVector Cases, std::vector&lt;<span class="hljs-type">bool</span>&gt; bytesChecked, BasicBlock *OrigBlock,</span></span><br><span class="hljs-params"><span class="hljs-function">    BasicBlock *NewDefault, Value *Val, <span class="hljs-type">unsigned</span> level)</span> </span>{<br><br>  <span class="hljs-type">unsigned</span>     ValTypeBitWidth = Cases[<span class="hljs-number">0</span>].Val-&gt;<span class="hljs-built_in">getBitWidth</span>();<br>  IntegerType *ValType =<br>      IntegerType::<span class="hljs-built_in">get</span>(OrigBlock-&gt;<span class="hljs-built_in">getContext</span>(), ValTypeBitWidth);<br>  IntegerType *        ByteType = IntegerType::<span class="hljs-built_in">get</span>(OrigBlock-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-number">8</span>);<br>  <span class="hljs-type">unsigned</span>             BytesInValue = bytesChecked.<span class="hljs-built_in">size</span>();<br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; setSizes;<br>  std::vector&lt;std::set&lt;<span class="hljs-type">uint8_t</span>&gt; &gt; <span class="hljs-built_in">byteSets</span>(BytesInValue, std::<span class="hljs-built_in">set</span>&lt;<span class="hljs-type">uint8_t</span>&gt;());<br><br>  <span class="hljs-comment">/* for each of the possible cases we iterate over all bytes of the values</span><br><span class="hljs-comment">   * build a set of possible values at each byte position in byteSets */</span><br>  <span class="hljs-keyword">for</span> (CaseExpr &amp;Case : Cases) {<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; BytesInValue; i++) {<br><br>      <span class="hljs-type">uint8_t</span> byte = (Case.Val-&gt;<span class="hljs-built_in">getZExtValue</span>() &gt;&gt; (i * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>;    <span class="hljs-comment">// è·å–Caseå€¼çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼Œå­˜æ”¾äºbyteSetsä¸­</span><br>      byteSets[i].<span class="hljs-built_in">insert</span>(byte);<br><br>    }<br><br>  }<br><br>  <span class="hljs-comment">/* find the index of the first byte position that was not yet checked. then</span><br><span class="hljs-comment">   * save the number of possible values at that byte position */</span><br>  <span class="hljs-type">unsigned</span> smallestIndex = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">unsigned</span> smallestSize = <span class="hljs-number">257</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; byteSets.<span class="hljs-built_in">size</span>(); i++) {  <span class="hljs-comment">// è¿™é‡Œçš„ä»£ç ä¸»è¦ç”¨äºé€’å½’ï¼ï¼ï¼</span><br><br>    <span class="hljs-keyword">if</span> (bytesChecked[i]) <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span> (byteSets[i].<span class="hljs-built_in">size</span>() &lt; smallestSize) {<br><br>      smallestIndex = i;<br>      smallestSize = byteSets[i].<span class="hljs-built_in">size</span>();<br><br>    }<br><br>  }<br><br>  <span class="hljs-built_in">assert</span>(bytesChecked[smallestIndex] == <span class="hljs-literal">false</span>);<br><br>  <span class="hljs-comment">/* there are only smallestSize different bytes at index smallestIndex */</span><br><br>  Instruction *Shift, *Trunc;<br>  Function *   F = OrigBlock-&gt;<span class="hljs-built_in">getParent</span>();<br>  BasicBlock * NewNode = BasicBlock::<span class="hljs-built_in">Create</span>(Val-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-string">"NodeBlock"</span>, F);<br>  Shift = BinaryOperator::<span class="hljs-built_in">Create</span>(Instruction::LShr, Val,<br>                                 ConstantInt::<span class="hljs-built_in">get</span>(ValType, smallestIndex * <span class="hljs-number">8</span>));  <span class="hljs-comment">// conditioné€»è¾‘å³ç§»</span><br>  NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Shift);<br><br>  <span class="hljs-keyword">if</span> (ValTypeBitWidth &gt; <span class="hljs-number">8</span>) {<br><br>    Trunc = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TruncInst</span>(Shift, ByteType);  <span class="hljs-comment">// æˆªæ–­</span><br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Trunc);<br><br>  } <span class="hljs-keyword">else</span> {<br><br>    <span class="hljs-comment">/* not necessary to trunc */</span><br>    Trunc = Shift;<br><br>  }<br><br>  <span class="hljs-comment">/* this is a trivial case, we can directly check for the byte,</span><br><span class="hljs-comment">   * if the byte is not found go to default. if the byte was found</span><br><span class="hljs-comment">   * mark the byte as checked. if this was the last byte to check</span><br><span class="hljs-comment">   * we can finally execute the block belonging to this case */</span><br><br>  <span class="hljs-keyword">if</span> (smallestSize == <span class="hljs-number">1</span>) {<br><br>    <span class="hljs-type">uint8_t</span> byte = *(byteSets[smallestIndex].<span class="hljs-built_in">begin</span>());<br><br>    <span class="hljs-comment">/* insert instructions to check whether the value we are switching on is</span><br><span class="hljs-comment">     * equal to byte */</span><br>    ICmpInst *Comp =<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">ICmpInst</span>(ICmpInst::ICMP_EQ, Trunc, ConstantInt::<span class="hljs-built_in">get</span>(ByteType, byte),<br>                     <span class="hljs-string">"byteMatch"</span>);<br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Comp);<br><br>    bytesChecked[smallestIndex] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-type">bool</span> allBytesAreChecked = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">for</span> (std::vector&lt;<span class="hljs-type">bool</span>&gt;::iterator BCI = bytesChecked.<span class="hljs-built_in">begin</span>(),<br>                                     E = bytesChecked.<span class="hljs-built_in">end</span>();<br>         BCI != E; ++BCI) {<br><br>      <span class="hljs-keyword">if</span> (!*BCI) {<br><br>        allBytesAreChecked = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      }<br><br>    }<br><br>    <span class="hljs-comment">//    if (std::all_of(bytesChecked.begin(), bytesChecked.end(),</span><br>    <span class="hljs-comment">//                    [](bool b) { return b; })) {</span><br><br>    <span class="hljs-keyword">if</span> (allBytesAreChecked) {<br><br>      <span class="hljs-built_in">assert</span>(Cases.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>);<br>      BranchInst::<span class="hljs-built_in">Create</span>(Cases[<span class="hljs-number">0</span>].BB, NewDefault, Comp, NewNode);<br><br>      <span class="hljs-comment">/* we have to update the phi nodes! */</span><br>      <span class="hljs-keyword">for</span> (BasicBlock::iterator I = Cases[<span class="hljs-number">0</span>].BB-&gt;<span class="hljs-built_in">begin</span>();<br>           I != Cases[<span class="hljs-number">0</span>].BB-&gt;<span class="hljs-built_in">end</span>(); ++I) {<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isa</span>&lt;PHINode&gt;(&amp;*I)) { <span class="hljs-keyword">continue</span>; }<br>        PHINode *PN = <span class="hljs-built_in">cast</span>&lt;PHINode&gt;(I);<br><br>        <span class="hljs-comment">/* Only update the first occurrence. */</span><br>        <span class="hljs-type">unsigned</span> Idx = <span class="hljs-number">0</span>, E = PN-&gt;<span class="hljs-built_in">getNumIncomingValues</span>();<br>        <span class="hljs-keyword">for</span> (; Idx != E; ++Idx) {<br><br>          <span class="hljs-keyword">if</span> (PN-&gt;<span class="hljs-built_in">getIncomingBlock</span>(Idx) == OrigBlock) {<br><br>            PN-&gt;<span class="hljs-built_in">setIncomingBlock</span>(Idx, NewNode);<br>            <span class="hljs-keyword">break</span>;<br><br>          }<br><br>        }<br><br>      }<br><br>    } <span class="hljs-keyword">else</span> {<br><br>      BasicBlock *BB = switchConvert(Cases, bytesChecked, OrigBlock, NewDefault,<br>                                     Val, level + <span class="hljs-number">1</span>);<br>      BranchInst::<span class="hljs-built_in">Create</span>(BB, NewDefault, Comp, NewNode);<br><br>    }<br><br>  }<br><br>  <span class="hljs-comment">/* there is no byte which we can directly check on, split the tree */</span><br>  <span class="hljs-keyword">else</span> {<br><span class="hljs-comment">// äºŒåˆ†æ³• åˆ†è€Œæ²»ä¹‹ï¼</span><br>    std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; byteVector;<br>    std::<span class="hljs-built_in">copy</span>(byteSets[smallestIndex].<span class="hljs-built_in">begin</span>(), byteSets[smallestIndex].<span class="hljs-built_in">end</span>(),<br>              std::<span class="hljs-built_in">back_inserter</span>(byteVector));<br>    std::<span class="hljs-built_in">sort</span>(byteVector.<span class="hljs-built_in">begin</span>(), byteVector.<span class="hljs-built_in">end</span>());<br>    <span class="hljs-type">uint8_t</span> pivot = byteVector[byteVector.<span class="hljs-built_in">size</span>() / <span class="hljs-number">2</span>];<br><br>    <span class="hljs-comment">/* we already chose to divide the cases based on the value of byte at index</span><br><span class="hljs-comment">     * smallestIndex the pivot value determines the threshold for the decicion;</span><br><span class="hljs-comment">     * if a case value</span><br><span class="hljs-comment">     * is smaller at this byte index move it to the LHS vector, otherwise to the</span><br><span class="hljs-comment">     * RHS vector */</span><br><br>    CaseVector LHSCases, RHSCases;<br><br>    <span class="hljs-keyword">for</span> (CaseExpr &amp;Case : Cases) {<br><br>      <span class="hljs-type">uint8_t</span> byte = (Case.Val-&gt;<span class="hljs-built_in">getZExtValue</span>() &gt;&gt; (smallestIndex * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>;<br><br>      <span class="hljs-keyword">if</span> (byte &lt; pivot) {<br><br>        LHSCases.<span class="hljs-built_in">push_back</span>(Case);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        RHSCases.<span class="hljs-built_in">push_back</span>(Case);<br><br>      }<br><br>    }<br><br>    BasicBlock *LBB, *RBB;<br>    LBB = switchConvert(LHSCases, bytesChecked, OrigBlock, NewDefault, Val,<br>                        level + <span class="hljs-number">1</span>);<br>    RBB = switchConvert(RHSCases, bytesChecked, OrigBlock, NewDefault, Val,<br>                        level + <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* insert instructions to check whether the value we are switching on is</span><br><span class="hljs-comment">     * equal to byte */</span><br>    ICmpInst *Comp =<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">ICmpInst</span>(ICmpInst::ICMP_ULT, Trunc,<br>                     ConstantInt::<span class="hljs-built_in">get</span>(ByteType, pivot), <span class="hljs-string">"byteMatch"</span>);<br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Comp);<br>    BranchInst::<span class="hljs-built_in">Create</span>(LBB, RBB, Comp, NewNode);<br><br>  }<br><br>  <span class="hljs-keyword">return</span> NewNode;<br><br>}<br><br></code></pre></td></tr></tbody></table></figure><ul><li>ç®€å•æ¥è¯´ï¼Œå…¶åŠŸèƒ½å°±æ˜¯å°†switchåˆ†æ”¯ç»†ç²’åº¦åŒ–ï¼Œæ¯”å¦‚ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// before spliting switches...</span><br>{<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> x;<br>    <span class="hljs-keyword">switch</span>(x){<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x12345678</span>:<br>            <span class="hljs-built_in">do_something1</span>();<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x78563412</span>:<br>            <span class="hljs-built_in">do_something2</span>();<br>    }<br>    <br>}<br><span class="hljs-comment">// after spliting switches...</span><br>{<br>    <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">0</span>] == <span class="hljs-number">0x78</span>)<br>        <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">1</span>] == <span class="hljs-number">0x56</span>))<br>            <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">2</span>] == <span class="hljs-number">0x34</span>))<br>                <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">3</span>] == <span class="hljs-number">0x12</span>))<br>                    <span class="hljs-built_in">do_something1</span>();<br>    <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">0</span>] == <span class="hljs-number">0x12</span>)<br>        <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">1</span>] == <span class="hljs-number">0x34</span>))<br>            <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">2</span>] == <span class="hljs-number">0x56</span>))<br>                <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">3</span>] == <span class="hljs-number">0x78</span>))<br>                    <span class="hljs-built_in">do_something2</span>();<br>}<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="afl-complier-rt-o-c"><a href="#afl-complier-rt-o-c" class="headerlink" title="afl-complier-rt.o.c"></a>afl-complier-rt.o.c</h3><ul><li>ä»¥ <code>__cmplog_ins_hook1</code> ä¸ºä¾‹ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> __cmplog_ins_hook1(<span class="hljs-type">uint8_t</span> arg1, <span class="hljs-type">uint8_t</span> arg2, <span class="hljs-type">uint8_t</span> attr) {<br><br>  <span class="hljs-comment">// fprintf(stderr, "hook1 arg0=%02x arg1=%02x attr=%u\n",</span><br>  <span class="hljs-comment">//         (u8) arg1, (u8) arg2, attr);</span><br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">unlikely</span>(!__afl_cmp_map || arg1 == arg2)) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// Oops? got it!</span><br><br>  <span class="hljs-type">uintptr_t</span> k = (<span class="hljs-type">uintptr_t</span>)__builtin_return_address(<span class="hljs-number">0</span>); <span class="hljs-comment">// __builtin_return_address()è¿”å›è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€ï¼Œ0è¡¨ç¤ºå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼Œ1è¡¨ç¤ºå½“å‰å‡½æ•°çš„è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼Œä»¥æ­¤ç±»æ¨ï¼Œkä¸ºå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ã€‚ç›®çš„æ˜¯å•¥ï¼Ÿ</span><br>  k = (<span class="hljs-type">uintptr_t</span>)(<span class="hljs-built_in">default_hash</span>((u8 *)&amp;k, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uintptr_t</span>)) &amp; (CMP_MAP_W - <span class="hljs-number">1</span>));  <span class="hljs-comment">//æŒ‡é’ˆï¼ˆè¿”å›åœ°å€ï¼‰è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼Œç„¶åä¸ä¸ŠCMP_MAPå¤§å°ï¼š65536</span><br><br>  u32 hits;<br><br>  <span class="hljs-keyword">if</span> (__afl_cmp_map-&gt;headers[k].type != CMP_TYPE_INS) {  <span class="hljs-comment">// é¦–å…ˆå‘½ä¸­ï¼Ÿ</span><br><br>    __afl_cmp_map-&gt;headers[k].type = CMP_TYPE_INS;       <span class="hljs-comment">// typeèµ‹å€¼</span><br>    hits = <span class="hljs-number">0</span>; <span class="hljs-comment">// åˆå§‹åŒ–hitså€¼</span><br>    __afl_cmp_map-&gt;headers[k].hits = <span class="hljs-number">1</span>; <span class="hljs-comment">// å‘½ä¸­å€¼hitsåˆå§‹åŒ–ä¸º1</span><br>    __afl_cmp_map-&gt;headers[k].shape = <span class="hljs-number">0</span>; <span class="hljs-comment">// ï¼Ÿ</span><br><br>  } <span class="hljs-keyword">else</span> {<br><br>    hits = __afl_cmp_map-&gt;headers[k].hits++;  <span class="hljs-comment">// å‘½ä¸­å€¼hits++ï¼Œå°†åŸæ¥å‘½ä¸­å€¼èµ‹å€¼ç»™å±€éƒ¨å˜é‡hits</span><br><br>  }<br><br>  __afl_cmp_map-&gt;headers[k].attribute = attr;  <span class="hljs-comment">// attributeï¼Ÿè²Œä¼¼æ˜¯1ï¼Ÿ</span><br><br>  hits &amp;= CMP_MAP_H - <span class="hljs-number">1</span>;  <span class="hljs-comment">// è®°å½•å‰ CMP_MAP_Hï¼ˆ32ï¼‰æ¬¡çš„å€¼ï¼Œè¶…è¿‡ CMP_MAP_H ä¼šæ›¿æ¢å‰é¢çš„å€¼</span><br>  __afl_cmp_map-&gt;log[k][hits].v0 = arg1;<br>  __afl_cmp_map-&gt;log[k][hits].v1 = arg2;<br><br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="2-Redqueen"><a href="#2-Redqueen" class="headerlink" title="2. Redqueen"></a>2. Redqueen</h2><h3 id="afl-fuzz-redqueen-c"><a href="#afl-fuzz-redqueen-c" class="headerlink" title="afl-fuzz-redqueen.c"></a>afl-fuzz-redqueen.c</h3><ul><li><p><code>colorization()</code> å¡«è‰²å‡½æ•° ==&gt; ç”Ÿæˆæ±¡ç‚¹ä¿¡æ¯</p><ul><li>é€šè¿‡<code>type_replace()</code>å‡½æ•°å¯¹è¾“å…¥çš„æ¯ä¸€ä¸ªå­—èŠ‚è¿›è¡ŒåŒç±»å‹çš„æ›¿æ¢ï¼Œe.g. è¯¥å­—èŠ‚ä¸ºå¤§å†™å­—æ¯ï¼Œé‚£ä¹ˆå°±å°†å…¶æ›¿æ¢ä¸ºå…¶ä»–å¤§å†™å­—æ¯</li><li><code>pop_biggest_range()</code>å¾—åˆ°ranges [åŒå‘é“¾è¡¨ï¼Œç”¨æ¥å­˜å‚¨å½“å‰è¾“å…¥çš„åˆ‡å‰²èŒƒå›´] æœ€å¤§çš„èŒƒå›´ï¼Œåˆ¤æ–­å¯¹å½“å‰èŒƒå›´çš„å­—èŠ‚æ”¹å˜æ˜¯å¦ä¼šå½±å“åˆ°è·¯å¾„çš„å˜åŒ–</li><li>æœ€ç»ˆå¾—åˆ°çš„rangesé“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŒƒå›´è¡¨ç¤ºå¯¹è¯¥èŒƒå›´è¿›è¡Œå˜å¼‚å¤§æ¦‚ç‡èƒ½å¤Ÿå¼•èµ·è¦†ç›–ç‡å˜åŒ–ï¼Œç”±æ­¤ç”Ÿæˆtaintä¿¡æ¯</li></ul></li><li><p><code>colorization()</code>åå¾—åˆ°ä¸€ä¸ªæ±¡ç‚¹åçš„è¾“å…¥bufå’ŒåŸå§‹è¾“å…¥orig_bufï¼Œç„¶ååˆ†åˆ«è¿è¡Œè¿™ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå°†cmpè¦†ç›–ç‡ä¿¡æ¯ä¿å­˜ä»¥è¿›è¡Œåç»­åˆ†æï¼š</p><ul><li><strong>input-to-state</strong>é˜¶æ®µï¼šè°ƒç”¨<code>cmp_fuzz()</code>  TODO!</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFLplusplusè‡ªå®šä¹‰å˜å¼‚å™¨â€”æºç ç»†èŠ‚</title>
    <link href="/2023/03/09/AFLplusplus%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8%E2%80%94%E6%BA%90%E7%A0%81%E7%BB%86%E8%8A%82/"/>
    <url>/2023/03/09/AFLplusplus%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8%E2%80%94%E6%BA%90%E7%A0%81%E7%BB%86%E8%8A%82/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-è‡ªå®šä¹‰å˜å¼‚å™¨"><a href="#AFL-è‡ªå®šä¹‰å˜å¼‚å™¨" class="headerlink" title="AFL++è‡ªå®šä¹‰å˜å¼‚å™¨"></a>AFL++è‡ªå®šä¹‰å˜å¼‚å™¨</h1><ul><li>æ”¯æŒC/C++åº“å’ŒPythonæ¨¡å¼<ul><li>C/C++ library (<code>*.so</code>)</li><li>Python module</li></ul></li></ul><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p><strong>ç›¸å…³æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ol><li><code>custom_mutator_stage</code>åœ¨ç¡®å®šæ€§å˜å¼‚ä¹‹åå¯ç”¨ï¼›</li><li>åœ¨ä½¿ç”¨C/C++æ¥å£æ—¶ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼ˆåŠ¨æ€åº“è·¯å¾„å­˜æ”¾åœ¨ç¯å¢ƒå˜é‡<code>AFL_CUSTOM_MUTATOR_LIBRARY</code>ä¸­ï¼‰ï¼Œè¯¥åº“ï¼ˆéƒ¨åˆ†ï¼‰å®šä¹‰AFL++æš´éœ²å‡ºæ¥çš„æ¥å£</li></ol><p>å¯å‚è€ƒ <code>custom_mutators/examples</code> ç›®å½•ä¸‹çš„ç¤ºä¾‹æ–‡ä»¶</p><hr><h2 id="2-APIs"><a href="#2-APIs" class="headerlink" title="2. APIs"></a>2. APIs</h2><h3 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h3><p><strong>C/C++ï¼š</strong></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">afl_custom_init</span><span class="hljs-params">(<span class="hljs-type">afl_state_t</span> *afl, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seed)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">afl_custom_fuzz_count</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">afl_custom_splice_optout</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_fuzz</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *add_buf, <span class="hljs-type">size_t</span> add_buf_size, <span class="hljs-type">size_t</span> max_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title">afl_custom_describe</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">size_t</span> max_description_len)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_post_process</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf)</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">afl_custom_init_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf)</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">afl_custom_post_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> success)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_havoc_mutation</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf, <span class="hljs-type">size_t</span> max_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">afl_custom_havoc_mutation_probability</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">afl_custom_queue_get</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *filename)</span></span>;<br><span class="hljs-built_in">void</span> (*afl_custom_fuzz_send)(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> u8 *buf, <span class="hljs-type">size_t</span> buf_size);<br><span class="hljs-function">u8 <span class="hljs-title">afl_custom_queue_new_entry</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *filename_new_queue, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *filename_orig_queue)</span></span>;<br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">afl_custom_introspection</span><span class="hljs-params">(<span class="hljs-type">my_mutator_t</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">afl_custom_deinit</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br></code></pre></td></tr></tbody></table></figure><p><strong>pythonï¼š</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">seed</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz_count</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> cnt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">splice_optout</span>()<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz</span>(<span class="hljs-params">buf, add_buf, max_size</span>):<br>    <span class="hljs-keyword">return</span> mutated_out<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">describe</span>(<span class="hljs-params">max_description_length</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"description_of_current_mutation"</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_process</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> out_buf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_trim</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> cnt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">trim</span>():<br>    <span class="hljs-keyword">return</span> out_buf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_trim</span>(<span class="hljs-params">success</span>):<br>    <span class="hljs-keyword">return</span> next_index<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">havoc_mutation</span>(<span class="hljs-params">buf, max_size</span>):<br>    <span class="hljs-keyword">return</span> mutated_out<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">havoc_mutation_probability</span>():<br>    <span class="hljs-keyword">return</span> probability <span class="hljs-comment"># int in [0, 100]</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_get</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz_send</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_new_entry</span>(<span class="hljs-params">filename_new_queue, filename_orig_queue</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">introspection</span>():<br>    <span class="hljs-keyword">return</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deinit</span>():  <span class="hljs-comment"># optional for Python</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></tbody></table></figure><h3 id="ç»†èŠ‚ï¼ˆC-x2F-C-ï¼‰"><a href="#ç»†èŠ‚ï¼ˆC-x2F-C-ï¼‰" class="headerlink" title="ç»†èŠ‚ï¼ˆC/C++ï¼‰"></a>ç»†èŠ‚ï¼ˆC/C++ï¼‰</h3><p><strong>å˜å¼‚éƒ¨åˆ†</strong>ï¼š</p><ul><li><code>afl_custom_queue_get</code>ï¼šç”¨äºç§å­è°ƒåº¦ï¼Œå†³å®šè¯¥ç§å­æ˜¯å¦è¢«æ¨¡ç³Šæµ‹è¯•ï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 393 in afl-fuzz-one.c</span><br><span class="hljs-keyword">if</span> (unlikely(afl-&gt;custom_mutators_count)) {<br><br>    <span class="hljs-comment">/* The custom mutator will decide to skip this test case or not. */</span><br><br>    LIST_FOREACH(&amp;afl-&gt;custom_mutator_list, <span class="hljs-keyword">struct</span> custom_mutator, {<br><br>      <span class="hljs-keyword">if</span> (el-&gt;afl_custom_queue_get &amp;&amp;<br>          !el-&gt;afl_custom_queue_get(el-&gt;data, afl-&gt;queue_cur-&gt;fname)) {<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>      }<br><br>    });<br><br>  }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_fuzz_count</code>ï¼šfuzzæ¬¡æ•°ï¼Œç›¸å½“äºstage_maxï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1883 in afl-fuzz-one.c</span><br>      <span class="hljs-keyword">if</span> (el-&gt;afl_custom_fuzz_count) {<br><br>        afl-&gt;stage_max = el-&gt;afl_custom_fuzz_count(el-&gt;data, out_buf, len);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        afl-&gt;stage_max = saved_max;<br><br>      }<br>  ...<br><span class="hljs-comment">// Line 1905 in afl-fuzz-one.c</span><br>      <span class="hljs-keyword">if</span> (!el-&gt;afl_custom_fuzz_count) {<br><br>              <span class="hljs-comment">/* If we're finding new stuff, let's run for a bit longer, limits</span><br><span class="hljs-comment">                permitting. */</span><br><br>              <span class="hljs-keyword">if</span> (afl-&gt;queued_items != havoc_queued) {<br><br>                <span class="hljs-keyword">if</span> (perf_score &lt;= afl-&gt;havoc_max_mult * <span class="hljs-number">100</span>) {<br><br>                  afl-&gt;stage_max *= <span class="hljs-number">2</span>;<br>                  perf_score *= <span class="hljs-number">2</span>;<br><br>                }<br><br>                havoc_queued = afl-&gt;queued_items;<br><br>              }<br><br>            }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_fuzz</code>ï¼šæ‰§è¡Œç‰¹å®šçš„å˜å¼‚æ“ä½œï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1932 in afl-fuzz-one.c</span><br>          <span class="hljs-type">size_t</span> mutated_size =<br>              el-&gt;afl_custom_fuzz(el-&gt;data, out_buf, len, &amp;mutated_buf, new_buf, target_len, max_seed_size);<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_havoc_mutation_probability</code>ï¼šè¡¨ç¤º<code>afl_custom_havoc_mutation</code>è¢«è°ƒç”¨çš„æ¦‚ç‡</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2041 in afl-fuzz-one.c</span><br><span class="hljs-keyword">if</span> (el-&gt;stacked_custom &amp;&amp; el-&gt;afl_custom_havoc_mutation_probability) {<br><br>        el-&gt;stacked_custom_prob =<br>            el-&gt;afl_custom_havoc_mutation_probability(el-&gt;data);<br>        <span class="hljs-keyword">if</span> (el-&gt;stacked_custom_prob &gt; <span class="hljs-number">100</span>) {<br><br>          FATAL(<br>              <span class="hljs-string">"The probability returned by "</span><br>              <span class="hljs-string">"afl_custom_havoc_mutation_propability "</span><br>              <span class="hljs-string">"has to be in the range 0-100."</span>);<br><br>        }<br><br>      }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_havoc_mutation</code>ï¼šè‡ªå®šä¹‰<code>havoc</code>å˜å¼‚æ“ä½œï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2106 in afl-fuzz-one.c</span><br>    <span class="hljs-keyword">if</span> (afl-&gt;custom_mutators_count) {<br><br>        LIST_FOREACH(&amp;afl-&gt;custom_mutator_list, <span class="hljs-keyword">struct</span> custom_mutator, {<br><br>          <span class="hljs-keyword">if</span> (el-&gt;stacked_custom &amp;&amp;<br>              rand_below(afl, <span class="hljs-number">100</span>) &lt; el-&gt;stacked_custom_prob) {<br><br>            u8    *custom_havoc_buf = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-type">size_t</span> new_len = el-&gt;afl_custom_havoc_mutation(<br>                el-&gt;data, out_buf, temp_len, &amp;custom_havoc_buf, MAX_FILE);<br>            <span class="hljs-keyword">if</span> (unlikely(!custom_havoc_buf)) {<br><br>              FATAL(<span class="hljs-string">"Error in custom_havoc (return %zu)"</span>, new_len);<br><br>            }<br><br>            <span class="hljs-keyword">if</span> (likely(new_len &gt; <span class="hljs-number">0</span> &amp;&amp; custom_havoc_buf)) {<br><br>              temp_len = new_len;<br>              <span class="hljs-keyword">if</span> (out_buf != custom_havoc_buf) {<br><br>                out_buf = afl_realloc(AFL_BUF_PARAM(out), temp_len);<br>                <span class="hljs-keyword">if</span> (unlikely(!afl-&gt;out_buf)) { PFATAL(<span class="hljs-string">"alloc"</span>); }<br>                <span class="hljs-built_in">memcpy</span>(out_buf, custom_havoc_buf, temp_len);<br><br>              }<br><br>            }<br><br>          }<br><br>        });<br><br>      }<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>åˆå§‹åŒ–/æ¸…ç†éƒ¨åˆ†</strong>ï¼š</p><ul><li><code>afl_custom_init</code>ï¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œmaybe? åˆå§‹åŒ–ä¸€äº›dataæ•°æ®ï¼Ÿ<code>mutator-&gt;data</code>ä¸ºvoidç±»å‹æ•°æ®ï¼Œå¯ä»¥å­˜æ”¾ä¸€äº›è‡ªå®šä¹‰çš„ä¸œè¥¿ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1838 in afl-fuzz.c</span><br>  setup_custom_mutators(afl);<br><span class="hljs-comment">// -------------------------------------</span><br><span class="hljs-comment">// Line 335 in afl-fuzz-mutators.c </span><br>  <span class="hljs-comment">/* Initialize the custom mutator */</span><br>  <span class="hljs-keyword">if</span> (mutator-&gt;afl_custom_init) {<br><br>    mutator-&gt;data = mutator-&gt;afl_custom_init(afl, rand_below(afl, <span class="hljs-number">0xFFFFFFFF</span>));<br><br>  }<br></code></pre></td></tr></tbody></table></figure><p>è°ƒç”¨é“¾ï¼šafl-fuzz.c main ==&gt; setup_custom_mutators ==&gt; load_custom_mutator ==&gt; afl_custom_init</p><ul><li><code>afl_custom_deinit</code>ï¼šè¿›è¡Œmutatorçš„ä¸€äº›æ¸…ç†ç¨‹åº</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2648 in afl-fuzz.c </span><br>  destroy_custom_mutators(afl);<br></code></pre></td></tr></tbody></table></figure><p>è°ƒç”¨é“¾ï¼š afl-fuzz.c main ==&gt; destroy_custom_mutators ==&gt; afl_custom_deinit</p><hr><p><strong>Trimç›¸å…³ï¼š</strong></p><p><span class="github-emoji"><span>ğŸ–</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f356.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°è£…åœ¨<code>trim_case_custom</code>å‡½æ•°ä¸­ï¼ˆLine 350 in afl-fuzz-mutators.cä¸­ï¼‰</p><p>å®Œæ•´è°ƒç”¨é“¾ï¼šafl-fuzz-run.c (trim_case: 811) ==&gt; trim_case_custom ==&gt; xxx</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 823 in afl-fuzz-run.c</span><br>  <span class="hljs-keyword">if</span> (el-&gt;afl_custom_trim) {<br><br>        trimmed_case = trim_case_custom(afl, q, in_buf, el);<br>        custom_trimmed = <span class="hljs-literal">true</span>;<br><br>      }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_init_trim</code>ï¼šåˆå§‹åŒ–æ“ä½œï¼Ÿå¯ä»¥å®šä¹‰trimmingæ­¥é•¿ ==&gt; stage_maxï¼Ÿè¿”å›trimæ¬¡æ•°ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 365 in afl-fuzz-mutators.c (trim_case_custom())</span><br> afl-&gt;stage_cur = <span class="hljs-number">0</span>;<br> s32 retval = mutator-&gt;afl_custom_init_trim(mutator-&gt;data, in_buf, q-&gt;len);<br> <span class="hljs-keyword">if</span> (unlikely(retval) &lt; <span class="hljs-number">0</span>) {<br><br>   FATAL(<span class="hljs-string">"custom_init_trim error ret: %d"</span>, retval);<br><br> } <span class="hljs-keyword">else</span> {<br><br>   afl-&gt;stage_max = retval;  <span class="hljs-comment">// &lt;============ trimming step!</span><br><br> }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_trim</code>ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„ç²¾ç®€æ“ä½œï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 384 in afl-fuzz-mutators.c (trim_case_custom())</span><br><span class="hljs-keyword">while</span> (afl-&gt;stage_cur &lt; afl-&gt;stage_max) {<br><br>    u8 *retbuf = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">sprintf</span>(afl-&gt;stage_name_buf, <span class="hljs-string">"ptrim %s"</span>,<br>            u_stringify_int(val_buf, trim_exec));<br><br>    u64 cksum;<br><br>    <span class="hljs-type">size_t</span> retlen = mutator-&gt;afl_custom_trim(mutator-&gt;data, &amp;retbuf);<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_post_trim</code>ï¼šä¿®å‰ªåå¤„ç†æ“ä½œï¼Ÿåˆ¤æ–­ä¿®å‰ªæ˜¯å¦æˆåŠŸï¼Ÿå¹¶æ›´æ”¹ä¸€äº›å‚æ•°å€¼ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 476 in afl-fuzz-mutators.c (trim_case_custom())</span><br>afl-&gt;stage_cur = mutator-&gt;afl_custom_post_trim(mutator-&gt;data, <span class="hljs-number">1</span>);<br>  ...<br><span class="hljs-comment">// Line 488 in afl-fuzz-mutators.c (trim_case_custom())</span><br>s32 retval2 = mutator-&gt;afl_custom_post_trim(mutator-&gt;data, <span class="hljs-number">0</span>);<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>å…¶ä»–ï¼š</strong></p><ul><li><code>afl_custom_post_process</code>ï¼špost-processingå‡½æ•°ï¼Œåœ¨AFLå°†æµ‹è¯•ç”¨ä¾‹å†™åˆ°ç£ç›˜ä¹‹å‰è°ƒç”¨ï¼ˆwrite_to_testcase?ï¼‰ï¼Œä»¥ä¾¿æ‰§è¡Œè¢«æµ‹ç›®æ ‡</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 67 in afl-fuzz-run.c</span><br>u32 __attribute__((hot))<br>write_to_testcase(<span class="hljs-type">afl_state_t</span> *afl, <span class="hljs-type">void</span> **mem, u32 len, u32 fix) {<br>...<br>    <span class="hljs-comment">// Line 87 in afl-fuzz-run.c</span><br>    <span class="hljs-keyword">if</span> (el-&gt;afl_custom_post_process) {<br><br>        new_size =<br>            el-&gt;afl_custom_post_process(el-&gt;data, new_mem, new_size, &amp;new_buf);<br><br>        <span class="hljs-keyword">if</span> (unlikely(!new_buf || new_size &lt;= <span class="hljs-number">0</span>)) {<br><br>          new_size = <span class="hljs-number">0</span>;<br>          new_buf = new_mem;<br>          <span class="hljs-comment">// FATAL("Custom_post_process failed (ret: %lu)", (long</span><br>          <span class="hljs-comment">// unsigned)new_size);</span><br><br>        } <span class="hljs-keyword">else</span> {...}<br>...<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p><code>afl_custom_queue_new_entry</code>ï¼šå…è®¸é¢å¤–çš„åˆ†æï¼ˆä¾‹å¦‚ï¼Œè°ƒç”¨ä¸€ä¸ªä¸åŒçš„å·¥å…·ï¼Œåšä¸€ä¸ªä¸åŒçš„è¦†ç›–ç‡ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨è‡ªå®šä¹‰å˜å¼‚å™¨ä¸­ï¼‰</p><p>è°ƒç”¨é“¾ï¼šafl-fuzz-init.c (pivot_inputs()) ==&gt; run_afl_custom_queue_new_entry() ==&gt; afl_custom_queue_new_entry()</p></li><li><p><code>afl_custom_describe</code>ï¼šç»™ä¿å­˜çš„æ–‡ä»¶åæ·»åŠ é¢å¤–çš„æè¿°</p></li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 340 in afl-fuzz-bitmap.c(describe_op())</span><br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span> *custom_description = afl-&gt;current_custom_fuzz-&gt;afl_custom_describe(afl-&gt;current_custom_fuzz-&gt;data, size_left);<br>      <span class="hljs-keyword">if</span> (!custom_description || !custom_description[<span class="hljs-number">0</span>]) {<br><br>        DEBUGF(<span class="hljs-string">"Error getting a description from afl_custom_describe"</span>);<br>        <span class="hljs-comment">/* Take the stage name as description fallback */</span><br>        <span class="hljs-built_in">sprintf</span>(ret + len_current, <span class="hljs-string">"op:%s"</span>, afl-&gt;stage_short);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        <span class="hljs-comment">/* We got a proper custom description, use it */</span><br>        <span class="hljs-built_in">strncat</span>(ret + len_current, custom_description, size_left);  <span class="hljs-comment">// &lt;==== add describe here!</span><br><br>      }<br></code></pre></td></tr></tbody></table></figure><h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3. æ€»ç»“"></a>3. æ€»ç»“</h2><ol><li><p>AFL++ custom mutatorsæœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œè€Œæ˜¯åœ¨AFL++æ¨¡ç³Šæµ‹è¯•é˜¶æ®µè®¾ç½®äº†è‹¥å¹²å‡½æ•°ç«¯ç‚¹ï¼Œå¹¶ä»¥C/C++æ¥å£æˆ–è€…Pythonæ¥å£çš„æ–¹å¼æš´éœ²ç»™ç”¨æˆ·ï¼Œå¹¶æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œæ—¨åœ¨<strong>æé«˜æ¨¡ç³Šå™¨çš„åŠŸèƒ½æ€§</strong></p></li><li><p>å¤šå‚æ•°é¡¹ç›®å¯¹<code>fuzz_one()</code>è¿›è¡Œäº†å¤§æ”¹ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ªéƒ¨åˆ†ä»jsonæ–‡ä»¶ä¸­è¯»å…¥å‚æ•°è§„èŒƒï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†æ˜¯æ ¹æ®å‚æ•°ç±»å‹é€‰æ‹©ç‰¹å®šçš„å˜å¼‚æ“ä½œï¼ŒAFL++ custom mutatorsè™½ç„¶æä¾›äº†å˜å¼‚æ–¹æ³•ï¼Œä½†è¯¥æ–¹æ³•æ˜¯åœ¨ç¡®å®šæ€§å˜å¼‚åã€havocå˜å¼‚ä¹‹å‰æ‰§è¡Œçš„ï¼Œæ­¤å¤–è¿˜å¯ä»¥åœ¨havocé˜¶æ®µæ·»åŠ havoc_mutatorï¼Œä½†ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¤šå‚æ•°é¡¹ç›®æ‹†è§£äº†ç¡®å®šæ€§å˜å¼‚å’Œhavocï¼Œæ ¹æ®å‚æ•°çš„ç±»å‹æ¥pické€‚å½“çš„å˜å¼‚æ“ä½œï¼Œå› æ­¤å°†å¤šå‚æ•°å˜å¼‚æ·»åŠ åˆ°custom mutatorsé‡Œä¸ä¼šæœ‰å•¥æ•ˆæœï¼›</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> AFL++ custom mutatorsçš„æµç¨‹æ˜¯ï¼šåœ¨è¿›è¡Œç¡®å®šæ€§å˜å¼‚ä¹‹åï¼Œå¦‚æœå®šä¹‰äº†custom_mutatorï¼Œé‚£ä¹ˆå°±æ‰§è¡Œcustom_mutatorå®šä¹‰çš„å˜å¼‚ï¼Œå¦åˆ™è·³è½¬åˆ°è¿›è¡Œhavocå˜å¼‚ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯åŸç”ŸAFL++å¯¹äºå•ä¸ªè¾“å…¥çš„é¡ºåºå˜å¼‚æ–¹å¼ï¼Œå¹¶æ²¡æœ‰ä½“ç°å¤šå‚æ•°çš„æ€§è´¨ã€‚å› æ­¤å¦‚æœè¦å®ç°å¤šå‚æ•°ï¼Œè¿˜æ˜¯éœ€è¦å¯¹å¼•æ“è¿›è¡Œä¿®æ”¹ï¼›</p><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è§£æå‚æ•°è§„èŒƒçš„éƒ¨åˆ†è²Œä¼¼æ— æ³•æ·»åŠ åˆ°åˆé€‚çš„æ¥å£ä¸Šï¼›</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReZZan:Efficient Greybox Fuzzing to Detect Memory Errors</title>
    <link href="/2023/01/10/ReZZan/"/>
    <url>/2023/01/10/ReZZan/</url>
    
    <content type="html"><![CDATA[<h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1. å¼•è¨€"></a>1. å¼•è¨€</h2><ul><li><p>å†…å­˜é”™è¯¯æ˜¯å®‰å…¨æ¼æ´çš„å¸¸è§æ¥æº</p><ul><li>èµ‹äºˆæ”»å‡»è€…æ›´æ”¹å†…å­˜å†…å®¹çš„èƒ½åŠ›ï¼Œå¯èƒ½ä¼šæ„æˆä¿¡æ¯æ³„éœ²å’Œæ§åˆ¶æµåŠ«æŒ</li></ul></li><li><p>å†…å­˜é”™è¯¯çš„é™é»˜æ€§ï¼š</p><ul><li>å†…å­˜é”™è¯¯ä¸ä¸€å®šä¼šå¯¼è‡´ç¨‹åºç«‹å³å´©æºƒ</li><li>è¿›è¡Œæ’æ¡©ç›‘æ§å†…å­˜æƒ…å†µï¼šSanitizerï¼ˆe.g. AddressSanitizerï¼‰</li></ul></li><li><p>forkæ¨¡å¼çš„æ¨¡ç³Šæµ‹è¯• + å†…å®¹é”™è¯¯sanitizers = æ˜¾è‘—çš„æ€§èƒ½å¼€é”€</p><ul><li>AFL+AddressSanitizerï¼šååé‡é™ä½äº†çº¦58%</li><li>æ€§èƒ½ä¸‹é™çš„åŸå› ï¼š<strong>sanitizerçš„å®ç°ä¸æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¹‹é—´çš„ä¸åˆ©äº¤äº’</strong><ul><li>ä¼ ç»Ÿsanitizerä½¿ç”¨<strong>disjoint metadata</strong>æ¥è·Ÿè¸ªå†…å­˜çŠ¶æ€</li><li>ç»´æŠ¤disjoint metadataä¼šå¼•å…¥é¢å¤–çš„å¼€é”€</li></ul></li></ul></li><li><p>åŸºäºLBCå’ŒRESTç­‰å·¥å…·é¦–åˆ›çš„éšæœºåŒ–åµŒå…¥å¼ä»¤ç‰Œï¼ˆRETï¼‰çš„æ€æƒ³æ¥å¯¹å†…å­˜sanitizerè¿›è¡Œè®¾è®¡</p></li><li><p>ReZZan = REt + fuZZing + sANitizer</p><ul><li>åœ¨forkæ¨¡å¼çš„æ¨¡ç³Šæµ‹è¯•ä¸‹é€Ÿåº¦æ˜æ˜¾æ›´å¿«</li><li>1.27 Ã— åŸç”ŸAFLçš„è¿è¡Œï¼ˆAddressSanitizer 2.36 x ï¼‰</li><li>é¢å¤–æä¾›ä¸€ç§ç®€åŒ–é…ç½®ï¼Œæ— éœ€ç²¾ç¡®çš„è¾¹ç•Œæ£€æŸ¥ï¼Œå¼€é”€ä¸º1.14 x</li></ul></li></ul><h3 id="1-1-è´¡çŒ®"><a href="#1-1-è´¡çŒ®" class="headerlink" title="1.1 è´¡çŒ®"></a>1.1 è´¡çŒ®</h3><ul><li><p>æå‡ºäº†ä¸€ç§åŸºäºéšæœºåµŒå…¥ä»¤ç‰Œï¼ˆRETï¼‰æ¦‚å¿µçš„å†…å­˜é”™è¯¯sanitizerçš„è®¾è®¡</p></li><li><p>è°ƒæ•´è®¾è®¡ï¼Œæ— éœ€ä½¿ç”¨disjoint metadataï¼›æ­¤å¤–ä»‹ç»äº†åœ¨åŸºäºRETçš„è®¾è®¡ä¸‹ç”¨äºå­—èŠ‚ç²¾ç¡®å†…å­˜é”™è¯¯æ£€æµ‹çš„ç²¾ç»†è¾¹ç•Œæ£€æŸ¥çš„æ¦‚å¿µ</p></li><li><p>ä»¥ReZZanå·¥å…·çš„å½¢å¼å®ç°äº†è¯¥è®¾è®¡ï¼Œå¹¶å°†ReZZanä¸æµè¡Œçš„ç°ç›’æ¨¡ç³Šå™¨é›†æˆåœ¨ä¸€èµ·</p></li><li><p>å¯¹ASANå’ŒFuZZanè¿›è¡Œæ¯”è¾ƒï¼Œæ˜¾ç¤ºè¯¥æ–¹æ³•çš„ä¼˜è¶Šæ€§</p></li><li><p>é¡¹ç›®<strong>å¼€æº</strong>ï¼š<a href="https://github.com/bajinsheng/ReZZan">https://github.com/bajinsheng/ReZZan</a></p></li></ul><h2 id="2-èƒŒæ™¯"><a href="#2-èƒŒæ™¯" class="headerlink" title="2. èƒŒæ™¯"></a>2. èƒŒæ™¯</h2><p><strong>æ¨¡ç³Šæµ‹è¯•ï¼š</strong></p><ul><li>fork serverï¼š</li></ul><p><img src="/2023/01/10/ReZZan/1.png"></p><hr><p><strong>å†…å­˜é”™è¯¯Sanitizersï¼š</strong></p><p><img src="/2023/01/10/ReZZan/2.png"></p><ul><li><p>ä¸“ç”¨Sanitizerå’Œé€šç”¨Sanitizer</p><p>ä¸“ç”¨Sanitizerï¼š</p><ul><li>Stacké‡‘ä¸é›€ä¸“é—¨ç”¨äºå †æ ˆç¼“å†²åŒºæº¢å‡º</li><li>LowFatå’Œè½»é‡çº§è¾¹ç•Œæ£€æŸ¥ï¼ˆLBCï¼‰ä¸“é—¨ç”¨äºæº¢å‡º/ä¸‹æº¢</li><li>FreeSentryä¸“é—¨ç”¨äºUAF</li></ul><p>é€šç”¨Sanitizerï¼š</p><ul><li>AddressSanitizerï¼šå­—èŠ‚çº§ç²¾åº¦æ£€æµ‹æ‰€æœ‰ç±»å‹çš„å†…å­˜é”™è¯¯</li></ul></li><li><p>å†…å­˜é”™è¯¯æ£€æµ‹å¯èƒ½æ˜¯éƒ¨åˆ†æ£€æµ‹æˆ–ä¸ç²¾ç¡®æ£€æµ‹ï¼š</p><ul><li>GWP-ASANä»…å¯¹éšæœºé€‰æ‹©çš„å †å¯¹è±¡åº”ç”¨ä¿æŠ¤</li><li>LowFat/RESTå…è®¸å°çš„æº¢å‡ºï¼ˆä¸ä¸å…¶ä»–å¯¹è±¡ç›¸äº¤ï¼Œå³ä¸å½±å“å…¶ä»–å¯¹è±¡å˜é‡å€¼ï¼‰</li></ul></li><li><p>AddressSanitizerï¼š</p><ul><li><p>å®æ–½ä¸€ç§<strong>å†…å­˜æŠ•æ¯’</strong>ï¼ˆ<em>memory poisoning</em>ï¼‰çš„æ–¹æ³•ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼šå½“ä½¿ç”¨ä¸€ä¸ªå†…å­˜é”™è¯¯èƒ½å¤Ÿè®¿é—®è¯¥å†…å­˜æ—¶ï¼Œè¯¥å†…å­˜åˆ™åˆ«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¯¹æ¯ä¸ªæœ‰æ•ˆåˆ†é…å¯¹è±¡ä¹‹é—´æ’å…¥çš„å°çš„<strong>REDZONE</strong>åŒºåŸŸè¿›è¡Œæ ‡è®°ï¼Œè¯¥åŒºåŸŸç”¨äºæ£€æµ‹å¯¹è±¡è¾¹ç•Œæº¢å‡º/ä¸‹æº¢é”™è¯¯</li><li>å¯¹<code>free()</code>çš„å†…å­˜è¿›è¡Œæ ‡è®°æ¥æ£€æµ‹UAFé”™è¯¯</li></ul></li><li><p>ä½¿ç”¨è¿è¡Œæ—¶æ”¯æŒåº“æ¥<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨å·²åˆ†é…å¯¹è±¡ä¹‹é—´æ’å…¥redzoneå¹¶å¯¹å…¶æ ‡è®°ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹<code>free()</code>çš„å†…å­˜è¿›è¡Œæ ‡è®°</p></li><li><p>å¯¹æ‰€æœ‰å†…å­˜è®¿é—®æ“ä½œè¿›è¡Œæ’æ¡©ï¼Œä»¥æ£€æµ‹å†…å­˜æ˜¯å¦ä¸­æ¯’ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( poisoned ( p )) <span class="hljs-comment">// Instrumentation</span><br>error ();<br>* p = v ; <span class="hljs-comment">/* or */</span> v = * p ; <span class="hljs-comment">// Access </span><br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>AddressSanitizerçš„å†…å­˜æŠ•æ¯’</strong>ï¼š</p><ul><li><p>å°†ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†æ¥å®ç°å†…å­˜æŠ•æ¯’ï¼šåº”ç”¨ç¨‹åºå†…å­˜(application memory) å’Œ å½±å­å†…å­˜(shadow memory)</p></li><li><p>å½±å­å†…å­˜ç”¨ä»¥è·Ÿè¸ªåº”ç”¨ç¨‹åºå†…å­˜ä¸­æ¯ä¸ªå­—èŠ‚çš„ä¸­æ¯’æƒ…å†µã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºå†…å­˜æ¯8ä¸ªå­—èŠ‚éƒ½å°†æ˜ å°„åˆ°ç›¸åº”çš„å½±å­å­—èŠ‚ï¼Œi.e. $addr_{shadow}=offset_{shadow}+(addr/8)$ï¼Œè¿™é‡Œçš„å½±å­å†…å­˜å…¶å®å°±æ˜¯<strong>disjoint metadata</strong>çš„ä¸€ç§è¡¨ç°</p></li><li><p><strong>disjoint metadata</strong>ï¼ˆi.e. ä¸€ç§é¢å¤–çš„metadataï¼‰ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”±Sanitizerç»´æŠ¤ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸åº”ç”¨ç¨‹åºå†…å­˜/æ•°æ®åˆ†ç¦»</p><ul><li>ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€</li><li>å½±å“äº†å†…å­˜ä½ç½®ï¼ˆi.e. åº”ç”¨ç¨‹åºå’Œå½±å­å†…å­˜æ˜¯åˆ†ç¦»çš„ï¼‰</li></ul></li></ul></li><li><p>å†…å­˜æŠ•æ¯’çš„æ›¿ä»£å®ç°â€”â€”<strong>RETï¼ˆéšæœºåŒ–åµŒå…¥ä»¤ç‰Œï¼‰</strong>ï¼š</p><ul><li><p>poisonedå†…å­˜ç”±ä¸€ä¸ªç‰¹æ®Šçš„<strong>ä»¤ç‰Œ</strong>è¡¨ç¤ºï¼Œè¯¥ä»¤ç‰Œåˆå§‹åŒ–ä¸ºæŸä¸ªé¢„å®šçš„éšæœºæ•°å€¼ï¼Œå¦‚æœå†…å­˜ç›´æ¥å­˜å‚¨è¯¥éšæœºå€¼ï¼Œåˆ™è®¤ä¸ºå†…å­˜â€œä¸­æ¯’â€äº†</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">poisoned(p)=(*(p-p%<span class="hljs-keyword">sizeof</span>(Token))==NONCE)<br></code></pre></td></tr></tbody></table></figure></li><li><p>å¦‚æœNONCEå€¼ä¸ç¨‹åºæ­£å¸¸æ‰§è¡ŒæœŸé—´åˆ›å»ºçš„åˆæ³•å€¼å†²çªï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯çš„æ£€æµ‹</p></li><li><p><strong>REST</strong>ä½¿ç”¨ä¸€ä¸ªéå¸¸å¤§çš„ä»¤ç‰Œå¤§å°ï¼ˆæ•´ä¸ª512ä½ç¼“å­˜çº¿ï¼‰å’Œä¸€ä¸ªå¼ºå¤§çš„ä¼ªéšæœºæº</p><ul><li><p>å¤§å‹ï¼ˆå¤šå­—èŠ‚ï¼‰ä»¤ç‰Œä¼šå¯¼è‡´å†…å­˜é”™è¯¯æ£€æµ‹ç²’åº¦é™ä½ï¼ˆç²—ç²’åº¦ï¼‰</p></li><li><p>e.g. ç»™å®šREST 512ä½ï¼ˆ64å­—èŠ‚ï¼‰ä»¤ç‰Œï¼Œå¯¹malloc(27)çš„è°ƒç”¨å°†ï¼š</p><p>(1) å°†åˆ†é…å¤§å°å¢åŠ  64 - 27 = 37 å­—èŠ‚</p><p>(2) åˆ†é…å·²å¯¹é½äº†ä¸€ä¸ª64å­—èŠ‚çš„å¯¹è±¡</p><p>(3) åœ¨64..127å­—èŠ‚å¤„å­˜å‚¨ä¸€ä¸ªtokenå€¼æ¥å®ç°redzone</p><p>i.e. 27..63å­—èŠ‚çš„æº¢å‡ºéƒ½ä¸ä¼šè®¿é—®ä»¤ç‰Œï¼Œå³ä¸ä¼šåˆ¤æ–­ä¸ºå†…å­˜é”™è¯¯ï¼Œå› æ­¤<strong>RESTä¸æ˜¯å­—èŠ‚ç²¾ç¡®çš„</strong></p></li></ul></li><li><p>RETæ€æƒ³æœ€æ—©è¢«<strong>LBC</strong>æ‰€ä½¿ç”¨ï¼Œä¸åƒRESTï¼ŒLBCä½¿ç”¨å•å­—èŠ‚ï¼ˆ8ä½ï¼‰ä»¤ç‰Œå¤§å°ï¼Œå…è®¸è¿›è¡Œå­—èŠ‚ç²¾ç¡®çš„å†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€ç¢°æ’ä¸å¯é¿å…ï¼›ä¸ºäº†é¿å…ç¢°æ’ï¼ŒLBCå®ç°äº†ä¸€ç§æ··åˆæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¿ç•™äº†<strong>disjoint metadata</strong>ï¼Œä»¥åŒºåˆ†å†²çªå’Œåˆæ³•çš„å†…å­˜é”™è¯¯</p></li></ul></li></ul><hr><p><strong>é—®é¢˜æè¿°ï¼š</strong></p><ul><li><p>ç°è±¡ï¼šæ¨¡ç³Šæµ‹è¯•å’ŒSanitizeråº”è¯¥ååŒå·¥ä½œï¼Œä½†åœ¨å®è·µä¸­ï¼Œæ¨¡ç³Šæµ‹è¯•å’ŒSanitizerçš„ç»„åˆæ€§èƒ½è¾ƒå·®</p></li><li><p>æ ¹æœ¬åŸå› ï¼šfork()ç³»ç»Ÿè°ƒç”¨çš„å†™æ—¶å¤åˆ¶ï¼ˆ<em>copy-on-write</em> COWï¼‰è¯­ä¹‰ä¸Sanitizerå¯¹äºä»»ä½•<strong>disjoint metadata</strong>çš„åˆå§‹åŒ–/ä½¿ç”¨ä¹‹é—´çš„äº¤äº’</p><ul><li>å­è¿›ç¨‹å› å‘ç”Ÿé¡µé¢é”™è¯¯è€Œæ‹·è´é¡µ</li><li>fuzzing + sanitizerä¼šå¯¼è‡´é¡µé¢é”™è¯¯çš„æ¿€å¢ï¼šä¸€ä¸ªç”¨äºå·²åˆ†é…çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªç”¨äº<strong>disjoint metadata</strong></li></ul></li><li><p>AddressSanitizerè¿˜å¼•å…¥äº†ä¸fork()ç›¸å…³çš„å…¶ä»–å¼€é”€ï¼Œe.g.å¤åˆ¶å†…æ ¸æ•°æ®ç»“æ„ï¼ˆåŒ…æ‹¬è™šæ‹Ÿå†…å­˜VMAã€é¡µè¡¨å’Œç›¸å…³æ‹†å¸å¼€é”€ï¼‰</p></li></ul><hr><p><strong>è§£å†³åŠæ³•</strong>ï¼š</p><ul><li>ä¸€ä¸ªæƒ³æ³•æ˜¯é€‰æ‹©ä¸€ä¸ªå…·æœ‰ä½å†…å­˜å¼€é”€å’Œé«˜å±€éƒ¨æ€§çš„å†…å­˜é”™è¯¯Sanitizer</li><li>å¦ä¸€ä¸ªæƒ³æ³•æ˜¯ä¼˜åŒ–<strong>disjoint metadata</strong>çš„è¡¨ç¤º</li></ul><h3 id="2-1-æˆ‘ä»¬çš„è®¾è®¡"><a href="#2-1-æˆ‘ä»¬çš„è®¾è®¡" class="headerlink" title="2.1 æˆ‘ä»¬çš„è®¾è®¡"></a>2.1 æˆ‘ä»¬çš„è®¾è®¡</h3><ul><li><p>æå‡ºä¸€ç§åŸºäºéšæœºåŒ–åµŒå…¥ä»¤ç‰Œï¼ˆRETï¼‰çš„å˜ä½“ï¼Œè¯¥å˜ä½“ä¸ä½¿ç”¨å½±å­å†…å­˜æˆ–å…¶ä»–disjoint metadataè¡¨ç¤º</p></li><li><p>å…³é”®æ€æƒ³æ˜¯é€šè¿‡ä½¿ç”¨å†…å­˜æœ¬èº«è·Ÿè¸ªä¸­æ¯’çŠ¶æ€</p><ul><li>é¿å…ä»»ä½•çš„å…¶ä»–é¡µé”™è¯¯ï¼ˆç”±disjoint metadataçš„åˆå§‹åŒ–æˆ–è®¿é—®å¯¼è‡´çš„ï¼‰</li><li>æ’æ¡©æ£€æŸ¥å’Œç›¸åº”çš„å†…å­˜æ“ä½œä¸ä¼šå¸¦æ¥é¢å¤–çš„é¡µé”™è¯¯</li></ul></li><li><p>è®¾è®¡çš„ä¸»è¦å…ƒç´ æ€»ç»“å¦‚ä¸‹ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>ä»¤ç‰Œå¤§å°</strong></p><ul><li>æŸäº›ç°æœ‰çš„å·¥å…·åŸºäºRETè®¾è®¡ï¼Œå¦‚RESRï¼ˆä»¤ç‰Œå¤§å°512ä½ï¼‰å’ŒLBCï¼ˆä»¤ç‰Œå¤§å°8ä½ï¼‰</li><li>è§è§£ï¼šå¯¹äºæ¨¡ç³Šæµ‹è¯•åº”ç”¨ï¼Œå¯ä»¥å®¹å¿ä¸€äº›å°çº§åˆ«çš„é”™è¯¯æ£€æµ‹<ul><li>medium ä»¤ç‰Œå¤§å°ï¼š64ä½</li><li>ä½¿ç”¨ä¸åŒçš„éšæœºåŒ–NONCEå€¼é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¯ä»¥åœ¨ä¸€å®šç¨‹åºä¸Šå‡è½»é”™è¯¯æ£€æµ‹çš„å¼€é”€</li></ul></li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>å†…å­˜é”™è¯¯æ£€æµ‹ç²’åº¦</strong></p><ul><li>åœ¨åŸºæœ¬çš„RETè®¾è®¡ä¸‹ï¼Œtokenséœ€è¦å­˜å‚¨åœ¨tokenå¤§å°å¯¹é½çš„è¾¹ç•Œä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´64ä½tokenséœ€è¦è¿›è¡Œ8å­—èŠ‚å¯¹é½</li><li>å¯¹RETè¿›è¡Œæ”¹è¿›ï¼šå¯¹è±¡è¾¹ç•Œä¿¡æ¯ç›´æ¥<strong>ç¼–ç </strong>åˆ°ä»¤ç‰Œè¡¨ç¤ºæœ¬èº«ä¸­</li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>ç¡¬ä»¶</strong></p><ul><li>RESTï¼šæ— æ ‡å‡†ç¡¬ä»¶æ‰©å±•ï¼›LBCï¼š32ä½x86ç³»ç»Ÿ</li><li>æœ¬æ–‡æå‡ºçš„åŸºäºRETçš„è®¾è®¡ï¼šé’ˆå¯¹æ ‡å‡†ç¡¬ä»¶ï¼ˆx86_64ï¼‰å’Œæ ‡å‡†æ¨¡ç³Šå™¨è®¾è®¡</li></ul></li></ul><h2 id="3-åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹"><a href="#3-åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹" class="headerlink" title="3. åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹"></a>3. åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹</h2><ul><li>ä½¿ç”¨ä»¥ä¸‹ç»“æ„ç±»å‹æ¥å®šä¹‰RETï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Token</span> {</span> <span class="hljs-type">uint64_t</span> random; };<br></code></pre></td></tr></tbody></table></figure><hr><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>æ’æ¡©æ¨¡å¼ï¼š</strong></p><ul><li>åŸºæœ¬æ–¹æ³•ï¼šè½¬æ¢ç¨‹åºï¼ˆe.g.ä½¿ç”¨ä¸€ä¸ªLLVMç¼–è¯‘å™¨åŸºç¡€è®¾æ–½<strong>pass</strong>ï¼‰æ¥åœ¨æ¯ä¸ªå†…å­˜è®¿é—®ä¹‹å‰æ’å…¥æ’æ¡©ä»£ç </li><li>æ’æ¡©å†…å®¹ï¼šæ£€æŸ¥æ˜¯å¦è¿åç»™å®šçš„å®‰å…¨å±æ€§ï¼ˆåœ¨è®¾è®¡çš„sanitizerä¸­ï¼Œè¯¥å®‰å…¨å±æ€§æ˜¯ç›¸åº”è®¿é—®çš„å†…å®¹æ˜¯å¦è¢«poisonedï¼‰</li></ul><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>:</p><p><img src="/2023/01/10/ReZZan/3.png"></p><ul><li><img src="/2023/01/10/ReZZan/4.png"></li></ul><blockquote><p>ç¬¬4è¡Œå†…å­˜é—´æ¥å¼•ç”¨ä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–é¡µé”™è¯¯ï¼Œè€Œç¬¬5-6è¡Œçš„é”™è¯¯æ£€æŸ¥è®¿é—®å†…å­˜ä»¥æ£€ç´¢å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­çš„NONCEå€¼ï¼Œè€ŒNONCEå­˜å‚¨åœ¨å•ä¸ªä½ç½®ï¼Œå› æ­¤è¿™é‡Œ<strong>æœ€å¤šä¼šé¢å¤–äº§ç”Ÿä¸€ä¸ªé¡µé”™è¯¯</strong></p></blockquote><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>è¿è¡Œæ—¶æ”¯æŒï¼š</strong></p><ul><li><p>åŠ å¼ºå†…å­˜å®‰å…¨ï¼Œä¿®æ”¹äº†è¿è¡Œæ—¶ç¯å¢ƒä»¥æ¯’åŒ–redzoneå’Œfreeå†…å­˜</p></li><li><p>æ¯ä¸€ä¸ªå¯¹è±¡ç±»å¤„ç†æ–¹å¼ä¸åŒï¼š</p><p><strong>å †åˆ†é…å¯¹è±¡</strong>ï¼še.g. <code>malloc</code>, <code>realloc</code>, <code>new</code>ç­‰éƒ½è¢«æ›¿æ¢æˆä¸ºæ¯ä¸€ä¸ªåˆ†é…ç›®æ ‡åæ·»åŠ äº†redzoneçš„ç‰ˆæœ¬ï¼Œredzonesçš„å®ç°ä¸å…¶ä»–å†…å­˜é”™è¯¯sanitizerç›¸ä¼¼ï¼Œä½†ä¹Ÿæœ‰ä¸åŒï¼š</p><ol><li>Poisoningæ˜¯é€šè¿‡å°†NONCE-åˆå§‹åŒ–ä»¤ç‰Œç›´æ¥å†™å…¥redzoneå†…å­˜æ¥å®ç°çš„</li><li>redzoneçš„å¤§å°æ˜¯1ä¸ªæˆ–è€…2ä¸ªtokensï¼ˆå–å†³äºå¯¹é½ï¼‰</li><li>redzoneæ”¾ç½®åœ¨ç›®æ ‡çš„æœ€åï¼Œé€šè¿‡å‰ä¸€ä¸ªå¯¹è±¡çš„redzoneæ¥æ£€æµ‹Underflows</li></ol><p>å®ç°äº†ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨ï¼šè¿ç»­åˆ†é…ç›®æ ‡</p><p>å †å†…å­˜é‡Šæ”¾ï¼šé‡Šæ”¾çš„ç›®æ ‡ç›¸åº”å†…å­˜å¡«å……ä¸ºä¸€ä¸ªNONCE-åˆå§‹åŒ–çš„tokenï¼›ç»´æŠ¤äº†ä¸€ä¸ªéš”ç¦»åŒºï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼‰ï¼Œéš”ç¦»åŒºå­˜æ”¾äº†é‡Šæ”¾çš„å†…å­˜ç›®æ ‡ï¼Œç›®çš„æ˜¯å»¶è¿Ÿé‡æ–°åˆ†é…ï¼Œä»è€Œæ›´å¯èƒ½æ£€æµ‹åˆ°<code>reuse-after-free</code>ã€‚ä»éš”ç¦»åŒºåˆ é™¤å¯¹è±¡ä»¥ä¾¿é‡æ–°åˆ†é…ï¼Œç›¸åº”çš„å†…å­˜åœ¨ä½¿ç”¨å‰æ¸…é›¶ä»¥â€œunpoisonâ€è¯¥å†…å­˜ã€‚</p><hr><p><strong>æ ˆåˆ†é…å¯¹è±¡</strong>ï¼šä½¿ç”¨LLVM passå®ç°è½¬æ¢</p><ol><li>ä¿®æ”¹åˆ†é…å¤§å°ï¼šåŒ…å«åŸå§‹åˆ†é…çš„å¤§å°å’Œä¸€ä¸ªredzoneå†…å­˜</li><li>redzoneå†…å­˜å°†å†™å…¥ä¸€ä¸ªNONCE-åˆå§‹åŒ–tokenï¼Œå‰©ä½™å†…å­˜å…¨éƒ¨ç½®0</li></ol><hr><p><strong>å…¨å±€å˜é‡</strong>ï¼š ä½¿ç”¨LLVM passå®ç°è½¬æ¢</p><p>å…·ä½“æ“ä½œå’Œæ ˆåˆ†é…å¯¹è±¡ç›¸ä¼¼ï¼Œä¸å†èµ˜è¿°</p></li></ul><h2 id="4-æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥"><a href="#4-æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥" class="headerlink" title="4. æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥"></a>4. æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥</h2><ul><li><p>åŸºæœ¬æ€æƒ³ï¼šé™¤äº†éšæœºåŒ–çš„NONCEä¹‹å¤–ï¼Œè¿˜å°†å¯¹è±¡è¾¹ç•Œä¿¡æ¯<strong>ç¼–ç </strong>å­˜è¿›åµŒå…¥ä»¤ç‰Œä¸­ï¼Œè¯¥è¾¹ç•Œä¿¡æ¯å¯ä»¥åœ¨è¿è¡Œæ—¶æ£€ç´¢</p></li><li><p>åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼š</p><ul><li><em>random</em>ï¼šNONCEå€¼</li><li>boundaryï¼šç›®æ ‡è¾¹ç•Œçš„ç¼–ç å½¢å¼ï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">size mod <span class="hljs-title function_">sizeof</span><span class="hljs-params">(Token)</span>  <span class="hljs-comment">// sizeæ˜¯ç›®æ ‡çš„å¤§å°</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>æ”¹è¿›çš„ä»¤ç‰Œæ˜¯ç”±å…·æœ‰ä¸¤ä¸ªä½å­—æ®µçš„ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Token</span> {</span><br><span class="hljs-type">uint64_t</span> random :<span class="hljs-number">61</span>; <span class="hljs-comment">// NONCE</span><br><span class="hljs-type">uint64_t</span> boundary :<span class="hljs-number">3</span>; <span class="hljs-comment">// Boundary encoding</span><br>};<br></code></pre></td></tr></tbody></table></figure><p><em>boundary</em>å­—æ®µè‡³å°‘éœ€è¦<strong>3ä½</strong>æ¥è¡¨ç¤ºæ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œå€¼ï¼Œé‚£ä¹ˆ<em>random</em>å­—æ®µå°±åªèƒ½ç¼©å‡ä¸º<strong>61ä½</strong>ï¼ˆ64-3ï¼‰</p></li></ul><hr><ul><li>ä½¿ç”¨é¢å¤–çš„è¾¹ç•Œæ£€æŸ¥å¯¹å†…å­˜è®¿é—®è¿›è¡Œæ’æ¡©ï¼ŒåŸºæœ¬æ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul><p><img src="/2023/01/10/ReZZan/5.png"></p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å‡è®¾ç›®æ ‡å¤§å°ä¸æ˜¯ä¸€ä¸ªä»¤ç‰Œå¤§å°ï¼ˆ8å­—èŠ‚ï¼‰çš„æ•´æ•°å€ï¼Œe.g. (<em>size</em> mod sizeof(Token)) = 5ï¼Œä¹Ÿå°±æ˜¯è¦ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„sizeof(Token)-5=3å­—èŠ‚çš„<strong>å¡«å……</strong>ï¼Œåœ¨è¯¥å¡«å……ä¸­çš„æº¢å‡ºæ— æ³•è¢«åŸºæœ¬çš„RETæ£€æµ‹åˆ°ï¼Œä¸ºäº†æ£€æµ‹åˆ°è¿™ç§æº¢å‡ºï¼Œæˆ‘ä»¬å¯¹å†…å­˜è®¿é—®è¿›è¡Œæ’æ¡©ä»¥å®æ–½ä¸€ä¸ªé¢å¤–çš„è¾¹ç•Œæ£€æµ‹ï¼š</p><ol><li><p>æ£€æŸ¥å†…å­˜ä¸­å½“å‰wordçš„ä¸‹ä¸€ä¸ªword[8å­—èŠ‚]</p></li><li><p>å¦‚æœä¸‹ä¸€ä¸ªwordä¸æ˜¯ä¸€ä¸ªtoken(i.e.éšæœºæ¯”ç‰¹ä¸NONCEä¸ç›¸åŒ)ï¼Œé‚£ä¹ˆå†…å­˜è®¿é—®æ˜¯å…è®¸çš„</p></li><li><p>å¦åˆ™ï¼Œæ£€ç´¢è¾¹ç•Œå­—æ®µå¹¶å°†å…¶ä½™å†…å­˜è®¿é—®èŒƒå›´ $lbâ€¦ub$ è¿›è¡Œæ¯”è¾ƒï¼Œå½“ä¸‹é¢æ¡ä»¶ä¸æˆç«‹æ—¶ï¼Œå³å‘ç”Ÿäº†è¶Šç•Œæ“ä½œï¼š</p><p><img src="/2023/01/10/ReZZan/6.png"></p></li></ol><p>ç”±äºæ£€æŸ¥çš„æ˜¯ä¸‹ä¸€ä¸ªwordï¼Œå› æ­¤åŸºæœ¬ä¸Šç»•è¿‡äº†å¡«å……ç©ºé—´ä¸è¶³çš„é—®é¢˜ï¼Œåœ¨å›¾3çš„ç¤ºä¾‹ä¸­ï¼Œä»»ä½•ä¸å¡«å……é‡å çš„å†…å­˜è®¿é—®éƒ½ä¸ä¼šæ»¡è¶³ï¼Œå› æ­¤å¯ä»¥æ£€æµ‹åˆ°æº¢å‡º</p><hr><p><strong>æ’æ¡©æ¨¡å¼ï¼š</strong></p><p><img src="/2023/01/10/ReZZan/3.png"></p><ul><li>å›¾2çš„ç¬¬9-13è¡Œä¸ºè¾¹ç•Œæ£€æŸ¥çš„æ’æ¡©ï¼Œè¿™é‡Œå‡è®¾è¯¥å†…å­˜è®¿é—®å·²ç»é€šè¿‡RETæ£€æŸ¥ï¼Œä¿è¯äº†ubä¸åŒ…å«token</li></ul><blockquote><p>ä¸‹ä¸€ä¸ªwordå¯èƒ½ä½äºä¸åŒçš„é¡µé¢ï¼Œå› æ­¤å¯èƒ½æ— æ³•è®¿é—®ã€‚è¿™å¯ä»¥é€šè¿‡ç¦ç”¨å¯¹é¡µè¾¹ç•Œçš„ç²¾ç¡®æ£€æŸ¥æ¥è¿›è¡Œå¤„ç†ï¼Œéšä¹‹å¸¦æ¥çš„å°±æ˜¯ç²¾ç¡®åº¦çš„é™ä½ï¼›æˆ–è€…æ‰€æœ‰æ˜ å°„éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªNONCE-åˆå§‹åŒ–é¡µè¿›è¡Œæ‰©å±•ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ä¿¡å·å¤„ç†å™¨æ¥æ£€æµ‹è¾¹ç•Œæ£€æŸ¥å¼•èµ·çš„æ•…éšœï¼Œç„¶åâ€œæŒ‰éœ€â€æ‰©å±•ç›¸åº”çš„æ˜ å°„æ¥å®ç°</p></blockquote><h2 id="5-å®éªŒè®¾ç½®"><a href="#5-å®éªŒè®¾ç½®" class="headerlink" title="5. å®éªŒè®¾ç½®"></a>5. å®éªŒè®¾ç½®</h2><ul><li><p>x86_64ä¸Šå®ç°äº†REt+fuZZing+sANitzerï¼ˆReZZanï¼‰ï¼š</p><ul><li>ReZZanï¼šç»†ç²’åº¦å†…å­˜é”™è¯¯æ£€æµ‹ï¼ŒåŒ…æ‹¬RETï¼ˆç¬¬ä¸‰èŠ‚ï¼‰å’Œå­—èŠ‚å‡†ç¡®çš„è¾¹ç•Œæ£€æµ‹ï¼ˆç¬¬å››èŠ‚ï¼‰</li><li>ReZZan<sub>lite</sub>ï¼šå‡å¼±ç²’åº¦çš„å†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä»…åŒ…æ‹¬RETã€‚æ­¤ç‰ˆæœ¬é€Ÿåº¦æ›´å¿«ï¼Œä½†æ— æ³•æ£€æµ‹åˆ°å¯¹è±¡å¡«å……ä¸­çš„æŸäº›æº¢å‡º</li></ul></li><li><p>ReZZançš„å®ç°åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>LLVM Passï¼š<ul><li>è½¬æ¢æ‰€æœ‰å†…å­˜æ“ä½œï¼ˆe.g. <code>load/store</code>ï¼‰ä»¥æ’å…¥RETå’Œè¾¹ç•Œæ£€æŸ¥æ’æ¡©ã€‚å¯¹äºReZZan<sub>lite</sub>æ¥è¯´ï¼Œè¾¹ç•Œæ£€æŸ¥å°†è¢«å¿½ç•¥</li><li>å°†æ‰€æœ‰æ ˆåˆ†é…æ“ä½œï¼ˆe.g. <code>alloca</code>ï¼‰å’Œå…¨å±€å˜é‡è½¬æ¢ä¸ºä½¿ç”¨redzoneä¿æŠ¤çš„æ–°ç‰ˆæœ¬</li></ul></li><li>è¿è¡Œæ—¶åº“ï¼š<ul><li>å®ç°äº†æ›¿æ¢å †åˆ†é…å‡½æ•°ï¼ˆä¾‹å¦‚<code>malloc</code>ã€<code>free</code>ç­‰ï¼‰ï¼Œæ›¿æ¢çš„å‡½æ•°å¯ä»¥æ’å…¥redzoneä»¥åŠpoisoné‡Šæ”¾çš„å†…å­˜</li></ul></li></ul></li></ul><hr><h3 id="ç ”ç©¶é—®é¢˜"><a href="#ç ”ç©¶é—®é¢˜" class="headerlink" title="ç ”ç©¶é—®é¢˜"></a>ç ”ç©¶é—®é¢˜</h3><ul><li><p>ä¸»è¦å‡è¯´ï¼šåŸºäºRETçš„æ¶ˆæ¯’å‰‚è®¾è®¡å¯ä»¥</p><ol><li>åœ¨æ¨¡ç³Šæµ‹è¯•ç¯å¢ƒä¸‹è¡¨ç°å‡ºè¾ƒä½çš„æ€§èƒ½å¼€é”€</li><li>å®ç°ä¸æ›´ä¼ ç»Ÿçš„Sanitizerè®¾è®¡ï¼ˆå¦‚ASANï¼‰ç±»ä¼¼çš„å†…å­˜é”™è¯¯æ£€æµ‹èƒ½åŠ›</li></ol></li><li><p>å…­ä¸ªç ”ç©¶é—®é¢˜ï¼š</p></li></ul><table><thead><tr><th>åºå·</th><th>æè¿°</th></tr></thead><tbody><tr><td>RQ1 - æ£€æµ‹èƒ½åŠ›</td><td>ReZZanæ˜¯å¦æ£€æµ‹åˆ°ä¸ASanç›¸åŒç±»å‹çš„å†…å­˜é”™è¯¯ï¼Ÿ</td></tr><tr><td>RQ2 - æ‰§è¡Œé€Ÿåº¦</td><td>åœ¨æ¨¡ç³Šæµ‹è¯•ç¯å¢ƒä¸‹ï¼ŒReZZanæ¯”ASanå¿«å¤šå°‘ï¼Ÿ</td></tr><tr><td>RQ3 - åˆ†æ”¯è¦†ç›–</td><td>ReZZançš„åˆ†æ”¯è¦†ç›–èŒƒå›´ä¸ASanç›¸æ¯”å¦‚ä½•ï¼Ÿ</td></tr><tr><td>RQ4 - æ¼æ´å‘ç°æœ‰æ•ˆæ€§</td><td>ä¸ASanç›¸æ¯”ï¼ŒReZZanå¯ä»¥æ›´å¿«åœ°æš´éœ²bugå—ï¼Ÿ</td></tr><tr><td>RQ5 - çµæ´»æ€§</td><td>ReZZanå¯ä»¥ç”¨æ¥æ¨¡ç³Šå¤§å‹ç¨‹åºå—ï¼ŸReZZanä¸å…¶ä»–æ¨¡ç³Šå™¨å…¼å®¹å—ï¼Ÿ</td></tr><tr><td>RQ6 - è¯¯æŠ¥</td><td>ReZZanåœ¨å®é™…æ‰§è¡Œç¯å¢ƒä¸­çš„é”™è¯¯æ£€æµ‹ç‡æ˜¯å¤šå°‘ï¼Ÿ</td></tr></tbody></table><h3 id="åŸºç¡€è®¾æ–½"><a href="#åŸºç¡€è®¾æ–½" class="headerlink" title="åŸºç¡€è®¾æ–½"></a>åŸºç¡€è®¾æ–½</h3><p><strong>å®éªŒç¯å¢ƒï¼š</strong></p><ul><li>Intel Xeon CPU E5-2660v3ï¼š28ä¸ªç‰©ç†å†…æ ¸ã€56ä¸ªé€»è¾‘å†…æ ¸ï¼Œ2.4GHz</li><li>64GB RAM</li><li>Ubuntu 16.04ï¼ˆ64ä½ï¼‰LTSï¼ˆæœ€å¤§åˆ©ç”¨ç‡ä¸º26ä¸ªå†…æ ¸ï¼‰</li></ul><hr><p><strong>åŸºçº¿ï¼š</strong></p><ul><li>ASanï¼ˆLLVM-12ï¼‰ã€FuZZanï¼ˆå…·æœ‰åŠ¨æ€å…ƒæ•°æ®ç»“æ„åˆ‡æ¢æ¨¡å¼ï¼‰</li><li>ASanå’ŒFuZZanéƒ½ï¼š<ol><li>ä»åœ¨ç»´æŠ¤</li><li>æ”¯æŒx86_64</li><li>å¯ä»¥ä¸ç°æœ‰çš„æ¨¡ç³Šå™¨é›†æˆ</li></ol></li></ul><hr><p><strong>æ¨¡ç³Šæµ‹è¯•å¼•æ“</strong>ï¼š</p><ul><li>AFLï¼ˆv2.57bï¼‰<ul><li>æ˜¯å¤§å¤šæ•°ç°ä»£æ¨¡ç³Šå™¨çš„åŸºç¡€</li><li>è¯„ä¼°æ‰€ä½¿ç”¨çš„æ‰€æœ‰sanitizeréƒ½æ”¯æŒ</li></ul></li></ul><hr><p><strong>åŸºå‡†å¥—ä»¶</strong>ï¼š</p><ul><li>RQ1ï¼šJulietåŸºå‡†å¥—ä»¶</li><li>RQ2/RQ3ï¼šcxxfiltã€nmã€objdumpã€sizeï¼ˆå‡æ¥è‡ªbinutils-2.31ï¼‰ã€fileï¼ˆæ¥è‡ªcoreutilsç‰ˆæœ¬5.35ï¼‰ã€jerryscriptï¼ˆç‰ˆæœ¬2.4.0ï¼‰ã€mupdfï¼ˆç‰ˆæœ¬1.19.0ï¼‰ã€ï¼Œlibpngï¼ˆç‰ˆæœ¬1.6.38ï¼‰ã€opensslï¼ˆç‰ˆæœ¬1.0.1fï¼‰ã€sqlite3ï¼ˆç‰ˆæœ¬3.36.0ï¼‰å’Œtcpdumpï¼ˆç‰ˆæœ¬4.10.0ï¼‰</li><li>RQ4ï¼šè°·æ­Œçš„fuzzer-test-suite2</li></ul><p>é€‰æ‹©ç›¸åŒçš„åˆå§‹ç§å­è¯­æ–™åº“ï¼Œå¦‚æœæ²¡æœ‰æä¾›è¾“å…¥åˆ™ä½¿ç”¨ç©ºæ–‡ä»¶</p><hr><p><strong>å®éªŒè®¾ç½®ï¼š</strong></p><ul><li>æ¯ä¸ªå®éªŒè¿›è¡Œ24å°æ—¶ï¼Œé‡å¤20æ¬¡</li></ul><h2 id="6-è¯„ä¼°ç»“æœ"><a href="#6-è¯„ä¼°ç»“æœ" class="headerlink" title="6. è¯„ä¼°ç»“æœ"></a>6. è¯„ä¼°ç»“æœ</h2><h3 id="RQ-one-æ£€æµ‹èƒ½åŠ›"><a href="#RQ-one-æ£€æµ‹èƒ½åŠ›" class="headerlink" title="RQ:one: æ£€æµ‹èƒ½åŠ›"></a>RQ<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ£€æµ‹èƒ½åŠ›</h3><p><img src="/2023/01/10/ReZZan/7.png"></p><ul><li>ReZZanå’ŒReZZan<sub>lite</sub>å¯¹äºunderflow detectionçš„æ£€æµ‹æ€§èƒ½ç•¥ä½äºASanï¼Œè¿™æ˜¯å› ä¸ºASané»˜è®¤ä¸ºå †æ ˆå¯¹è±¡ä½¿ç”¨double-wideï¼ˆ32å­—èŠ‚ï¼‰çº¢åŒºã€‚å½“ReZZané…ç½®ç±»ä¼¼æ—¶ï¼Œä¹Ÿèƒ½100%æ£€æµ‹ä¸‹æº¢é”™è¯¯</li></ul><p><img src="/2023/01/10/ReZZan/8.png"></p><blockquote><p>å¯¹äºJulietæµ‹è¯•å¥—ä»¶ä¸­çš„å†…å­˜é”™è¯¯é”™è¯¯ï¼ˆCWE 121ã€122ã€124ã€126ã€127ã€416ï¼‰ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>åˆ†åˆ«é€šè¿‡99.04%å’Œ87.89%çš„åæµ‹è¯•ç”¨ä¾‹</p></blockquote><h3 id="RQ-two-æ‰§è¡Œé€Ÿåº¦"><a href="#RQ-two-æ‰§è¡Œé€Ÿåº¦" class="headerlink" title="RQ:two: æ‰§è¡Œé€Ÿåº¦"></a>RQ<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ‰§è¡Œé€Ÿåº¦</h3><p><img src="/2023/01/10/ReZZan/9.png"></p><p><img src="/2023/01/10/ReZZan/10.png"></p><ul><li>é¡µé”™è¯¯</li></ul><p><img src="/2023/01/10/ReZZan/11.png"></p><blockquote><p>å½“ä¸æ¨¡ç³Šæµ‹è¯•ç›¸ç»“åˆæ—¶ï¼ŒReZZanï¼ˆ1.27Ã—ï¼‰å’ŒReZZan<sub>lite</sub>ï¼ˆ1.14Ã—ï¼‰çš„å¼€é”€ä½äºä¼ ç»Ÿçš„Sanitizer ASanï¼ˆ2.36Ã—ï¼‰å’ŒFuZZanï¼ˆ2.00Ã—ï¼‰ã€‚ReZZanå’ŒReZZan<sub>lite</sub>çš„æ€§èƒ½ä¸æ²¡æœ‰ä»»ä½•å†…å­˜é”™è¯¯sanitizationçš„æ¨¡ç³Šæµ‹è¯•ç›¸å½“ï¼Œé¡µé¢é”™è¯¯çš„æ•°é‡ä¹Ÿæ˜¯å¦‚æ­¤.</p></blockquote><h3 id="RQ-three-åˆ†æ”¯è¦†ç›–"><a href="#RQ-three-åˆ†æ”¯è¦†ç›–" class="headerlink" title="RQ:three: åˆ†æ”¯è¦†ç›–"></a>RQ<span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ†æ”¯è¦†ç›–</h3><p><img src="/2023/01/10/ReZZan/12.png"></p><blockquote><p>å¹³å‡è€Œè¨€ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>å®ç°äº†ä¸Nativeç±»ä¼¼çš„åˆ†æ”¯è¦†ç›–ã€‚ReZZançš„æ¨¡ç³ŠåŒ–æ´»åŠ¨åœ¨24å°æ—¶å†…æ¢ç´¢äº†æ¯”ASanå¤š5.54%çš„ä»£ç åˆ†æ”¯ã€‚</p></blockquote><h3 id="RQ-four-æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§"><a href="#RQ-four-æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§" class="headerlink" title="RQ:four: æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§"></a>RQ<span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§</h3><p><img src="/2023/01/10/ReZZan/13.png"></p><blockquote><p>ReZZanæ¯”ASanå¿«3.68å€ã€‚åœ¨å®è·µä¸­ï¼ŒReZZanè¿˜å¯ä»¥æ£€æµ‹åˆ°æ¯”ReZZan<sub>lite</sub>æ›´å¤šçš„é”™è¯¯ã€‚</p></blockquote><h3 id="RQ-five-çµæ´»æ€§"><a href="#RQ-five-çµæ´»æ€§" class="headerlink" title="RQ:five: çµæ´»æ€§"></a>RQ<span class="github-emoji"><span>5âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0035-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çµæ´»æ€§</h3><ul><li><p><strong>æ¨¡ç³Šå™¨çš„æ”¯æŒï¼š</strong></p><ul><li>ä¸AFL++é›†æˆï¼š</li></ul><p><img src="/2023/01/10/ReZZan/14.png"></p></li><li><p><strong>æŒä¹…æ¨¡å¼æ¨¡ç³Šæµ‹è¯•ï¼š</strong></p><ul><li>FuzzBenchæä¾›çš„harnessä½œä¸ºæµ‹è¯•å¯¹è±¡</li><li>ReZZanå’ŒReZZan<sub>lite</sub>çš„æ€§èƒ½ç•¥æœ‰ä¸‹é™</li><li>ç»“æœè¡¨æ˜ï¼š1. ReZZanå¯ä»¥åº”ç”¨äºforkæ¨¡å¼å’ŒæŒä¹…æ¨¡å¼ï¼›2. ReZZenåœ¨è¾ƒé•¿è¿è¡Œæ—¶é—´å†…çš„å…¶æ€§èƒ½æœ€ç»ˆå°†æ¥è¿‘ASan</li></ul></li><li><p><strong>å¯æ‰©å±•æ€§ï¼š</strong></p><p><img src="/2023/01/10/ReZZan/15.png"></p><ul><li><p>è€ƒè™‘åˆ°Firefoxçš„è§„æ¨¡ï¼Œä¸å…¶ä»–åŸºå‡†ç›¸æ¯”ï¼Œæ€»ä½“æ¨¡ç³Šååé‡è¦æ…¢å¾—å¤šã€‚å°½ç®¡å¦‚æ­¤ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>ä»ä»¥112.60%å’Œ114.86%çš„æ”¹å–„ç‡ä¼˜äºASan</p></li><li><p>è¯æ˜ReZZanæ˜¯å¯æ‰©å±•çš„</p></li></ul></li></ul><h3 id="RQ-six-è¯¯æŠ¥"><a href="#RQ-six-è¯¯æŠ¥" class="headerlink" title="RQ:six: è¯¯æŠ¥"></a>RQ<span class="github-emoji"><span>6âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0036-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯¯æŠ¥</h3><ul><li>ReZZanè®¾è®¡å…è®¸å°‘é‡è¯¯æŠ¥</li><li>å®éªŒåŒ…æ‹¬è¶…è¿‡19200å°æ—¶ï¼ˆâ‰ˆ2.2å¹´ï¼‰CPUæ—¶é—´ï¼Œåœ¨æ­¤æœŸé—´æ²¡æœ‰è§‚å¯Ÿåˆ°è¯¯æŠ¥</li><li>é¢„æœŸæ˜¯æ•°åå¹´çš„CPUæ—¶é—´æ‰å¯èƒ½è§‚å¯Ÿåˆ°ç¬¬ä¸€æ¬¡è¯¯æŠ¥</li></ul><h2 id="æˆ‘çš„çœ‹æ³•"><a href="#æˆ‘çš„çœ‹æ³•" class="headerlink" title="æˆ‘çš„çœ‹æ³•"></a>æˆ‘çš„çœ‹æ³•</h2><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> äº®ç‚¹ï¼š</p><ul><li>è®ºæ–‡åˆ†æäº†ç°æœ‰Sanitizerä¸åŸºäºforkæ¨¡å¼çš„æ¨¡ç³Šå™¨ç»“åˆæ—¶å¯¹æ¨¡ç³Šæµ‹è¯•æ€§èƒ½çš„å½±å“ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š1. COWæœºåˆ¶å¯¼è‡´é¢‘ç¹çš„é¡µé”™è¯¯ï¼›2.disjoint metadataï¼Œå› æ­¤ä¸fork()å…¼å®¹æ€§ä¸å¥½</li><li>è®ºæ–‡æå‡ºäº†åŸºäºRETå’Œæ”¹è¿›çš„ç»†ç²’åº¦è¾¹ç•Œæ£€æµ‹çš„Sanitizerâ€”â€”ReZZanï¼Œå¹¶é€šè¿‡è¯¦ç»†çš„å®éªŒè®ºè¯ReZZançš„æ€§èƒ½</li><li>å®éªŒéƒ¨åˆ†å¾ˆè¯¦ç»†</li><li>é¡¹ç›®å¼€æºï¼š<a href="https://github.com/bajinsheng/ReZZan">https://github.com/bajinsheng/ReZZan</a></li></ul><p>ä¸è¶³ï¼š</p><ul><li>ä»…æ”¯æŒllvm-12ï¼Œè€Œä¸”wrapperçš„ä¸€äº›ç»†èŠ‚å¤„ç†ä¸æ˜¯å¾ˆå¥½</li><li><strong>ç›®æµ‹</strong>åº”è¯¥ä¸ä¼šæœ‰ASané‚£ä¹ˆè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šï¼Œä¹Ÿå°±æ˜¯è¯´ReZZanä»…ä¼šå¼‚å¸¸ç»“æŸç¨‹åºï¼Œè¿˜éœ€è¦ä½¿ç”¨ASanæŸ¥çœ‹å…·ä½“æ˜¯ä½•ç§æ¼æ´ç±»å‹ï¼ˆå¾…éªŒè¯ï¼‰</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>è®ºæ–‡é˜…è¯»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥æµ…å‡ºAFLæ’æ¡©</title>
    <link href="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/"/>
    <url>/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/</url>
    
    <content type="html"><![CDATA[<h1 id="AFLæ’æ¡©å‰–æ"><a href="#AFLæ’æ¡©å‰–æ" class="headerlink" title="AFLæ’æ¡©å‰–æ"></a>AFLæ’æ¡©å‰–æ</h1><h2 id="I-å‰ç½®çŸ¥è¯†"><a href="#I-å‰ç½®çŸ¥è¯†" class="headerlink" title="I. å‰ç½®çŸ¥è¯†"></a>I. å‰ç½®çŸ¥è¯†</h2><ul><li>ç¼–è¯‘å™¨äº§ç”Ÿå¯æ‰§è¡Œæ–‡ä»¶çš„æµç¨‹å¦‚ä¸‹å›¾1ã€2æ‰€ç¤ºï¼ˆä»¥gccç¼–è¯‘å™¨ä¸ºä¾‹ï¼ŒclangåŒç†ï¼‰ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/1.png"></p><center>å›¾1 gccç¼–è¯‘å™¨å·¥ä½œæµç¨‹ï¼ˆé¡¶å±‚æ¶æ„ï¼‰</center><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/2.png"></p><center>å›¾2 clangç¼–è¯‘å™¨å·¥ä½œæµç¨‹ï¼ˆé¡¶å±‚æ¶æ„ï¼‰</center><ul><li>ä¸»æµçš„ç¼–è¯‘å™¨ã€å›¾1ä¸­ç¬¬äºŒä¸ªé˜¶æ®µã€‘åŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š<strong>å‰ç«¯</strong>ã€<strong>ä¸­é—´ç«¯</strong>å’Œ<strong>åç«¯</strong> [1]<ul><li>å‰ç«¯ï¼šè¯»å–æºæ–‡ä»¶å¹¶å¯¹å…¶è¿›è¡Œåˆ†æï¼Œé€šå¸¸æ˜¯å°†æºç è½¬åŒ–ä¸ºæ ‡å‡†æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰</li><li>ä¸­é—´ç«¯ï¼šè¿›è¡Œæºç ä¼˜åŒ–ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ç”Ÿæˆçš„æŸç§ä¸­é—´è¡¨ç¤ºã€GCCä¸­æ˜¯GIMPLE/RTLï¼›Clangä¸­æ˜¯IRã€‘ï¼Œå¹¶æ ¹æ®è¯¥ä¸­é—´è¡¨ç¤ºè¿›è¡Œä¼˜åŒ–</li><li>åç«¯ï¼šä½¿ç”¨ä¼˜åŒ–åçš„ä¸­é—´è¡¨ç¤ºæ¥ç”Ÿæˆå¯¹åº”ç›®æ ‡æ¶æ„çš„æ±‡ç¼–ä»£ç </li></ul></li></ul><h3 id="1-GCC"><a href="#1-GCC" class="headerlink" title="1. GCC"></a>1. GCC</h3><ul><li>GCC 4.1æ¶æ„å›¾ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/4.png"></p><center>å›¾3 GCC 4.1æ¶æ„å›¾</center><h4 id="å››ä¸ªé˜¶æ®µ"><a href="#å››ä¸ªé˜¶æ®µ" class="headerlink" title="å››ä¸ªé˜¶æ®µ"></a>å››ä¸ªé˜¶æ®µ</h4><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/5.png"></p><center>å›¾4 ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é“¾æ¥æ—¶çš„å…·ä½“æµç¨‹[8]</center><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc -E afl_inst_test.c <span class="hljs-comment"># é¢„å¤„ç†</span><br>$ gcc -S afl_inst_test.c <span class="hljs-comment"># ç¼–è¯‘</span><br>$ gcc -c afl_inst_test.c <span class="hljs-comment"># æ±‡ç¼– =&gt; ç›®æ ‡æ–‡ä»¶ or as afl_inst_test.s -o afl_inst_test.o</span><br>$ ld -plugin /usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper -plugin-opt=-fresolution=/tmp/cclTw8TB.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/7/crtbeginS.o -L/usr/lib/gcc/x86_64-linux-gnu/7 -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/7/../../.. ./afl_inst_test.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/7/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crtn.o -o afl_inst_test <span class="hljs-comment"># é“¾æ¥ï¼[10]</span><br>$ afl_inst_test<br>This is a <span class="hljs-built_in">test</span>!<br>Please give me an input number:-1<br>-1 is a negative number~<br></code></pre></td></tr></tbody></table></figure><h4 id="å‰ç«¯åˆ†æ"><a href="#å‰ç«¯åˆ†æ" class="headerlink" title="å‰ç«¯åˆ†æ"></a>å‰ç«¯åˆ†æ</h4><ul><li><p>å¯¹æºä»£ç è¿›è¡Œ<strong>é¢„å¤„ç†</strong>ã€<strong>è¯­æ³•åˆ†æ</strong>ã€<strong>è¯­ä¹‰åˆ†æ</strong>ï¼ŒåŒæ—¶ä¼šç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘<strong>AST</strong></p></li><li><p>parse the source code  <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>  å³å°†æºä»£ç è½¬åŒ–ä¸ºæœ‰æ„ä¹‰çš„æ•°æ®ï¼ˆæœ‰æ„ä¹‰æ˜¯é’ˆå¯¹æœºå™¨æ¥è¯´çš„ï¼‰ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¯è¯»çš„æºä»£ç ç©¶ç«Ÿæƒ³è¦è¡¨è¾¾å•¥</p></li></ul><hr><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>GCCæœ¬èº«æ— æ³•è¾“å‡ºç”Ÿæˆçš„AST [2]ï¼Œè¿™é‡Œæˆ‘ä»¬å±•ç¤ºGCCç¼–è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆçš„CFG [3]</strong> ï¼š</p><ol start="0"><li>æºä»£ç ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// afl_inst_test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span>{<br><span class="hljs-keyword">if</span>(a &gt; <span class="hljs-number">0</span>){<br><span class="hljs-keyword">return</span> -a;<br>}<br><span class="hljs-keyword">return</span> a;<br>}<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span>{<br><span class="hljs-type">int</span> a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"This is a test!\nPlease give me an input number:"</span>);<br><span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;a);<br><span class="hljs-comment">/* simulating branches */</span><br><span class="hljs-keyword">if</span>(a &gt; <span class="hljs-number">0</span>){<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d is a positive number~"</span>, a);<br>}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a &lt; <span class="hljs-number">0</span>){<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d is a negative number~"</span>, a);<br>}<span class="hljs-keyword">else</span> {<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"zero detected!"</span>);<br>}<br><span class="hljs-comment">/* simulating a function call */</span><br>fun(a);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><ol><li>äº§ç”ŸASTå¯¹åº”çš„<code>.dot</code>æ–‡ä»¶ï¼š</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-all-graph<br>$ <span class="hljs-built_in">ls</span><br>afl_inst_test.c<br>afl_inst_test.c.001t.tu<br>afl_inst_test.c.002t.class<br>afl_inst_test.c.003t.original<br>...<br>afl_inst_test.c.227t.optimized<br>afl_inst_test.c.227t.optimized.dot<br>afl_inst_test.c.311t.statistics<br>a.out<br></code></pre></td></tr></tbody></table></figure><ol start="2"><li>ä½¿ç”¨<code>dot</code>ç¨‹åºå°†mainå‡½æ•°å¯¹åº”<code>.dot</code>è½¬åŒ–ä¸ºå¯è§†å›¾ï¼š</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ dot -Tpng afl_inst_test.c.011t.cfg.dot -o main.png<br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/3.png"></p><center>å›¾5 ç¤ºä¾‹CFG</center><h4 id="ä¸­é—´ç«¯ä¼˜åŒ–"><a href="#ä¸­é—´ç«¯ä¼˜åŒ–" class="headerlink" title="ä¸­é—´ç«¯ä¼˜åŒ–"></a>ä¸­é—´ç«¯ä¼˜åŒ–</h4><ul><li>GCCä¸­é—´ç«¯åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>GIMPLE</strong> å’Œ <strong>RTL</strong></li></ul><hr><p><strong>GIMPLEï¼š</strong></p><ul><li><p>æ´¾ç”Ÿè‡ªGCC <strong>GENERIC</strong>ï¼ˆä¹Ÿæ˜¯ä¸€ç§ä¸­é—´è¡¨ç¤ºï¼›æœ€åˆï¼Œä¸åŒçš„GCCå‰ç«¯ä¼šç”Ÿæˆä¾èµ–äºæ¶æ„çš„æ ‘è¡¨ç¤ºï¼Œè€ŒGENERICæ˜¯ä½œä¸ºä¸å¹³å°æ— å…³çš„æ ‘è¡¨ç¤ºè€Œå¼•å…¥çš„ï¼Œä»¥ç®€åŒ–å‰ç«¯å¼€å‘è¿‡ç¨‹ã€‚<strong>GENERIC</strong>çš„ç›®æ ‡æ˜¯ç”Ÿæˆ<strong>GIMPLE</strong> [5]ï¼‰</p></li><li><p>three-addressè¡¨ç¤ºï¼š</p><ul><li>å°†<strong>GENERIC</strong>è¡¨è¾¾å¼æ‹†æˆä¸è¶…è¿‡3ä¸ªæ“ä½œæ•°çš„å…ƒç»„ï¼ˆé™¤äº†å‡½æ•°è°ƒç”¨ï¼‰</li></ul></li><li><p>å¼•å…¥<strong>æš‚å­˜å™¨</strong>æ¥ä¿å­˜è®¡ç®—å¤æ‚è¡¨è¾¾å¼æ‰€éœ€çš„ä¸­é—´å€¼ï¼ŒGENERICä¸­ä½¿ç”¨çš„æ§åˆ¶ç»“æ„é™çº§ä¸º<strong>æ¡ä»¶è·³è½¬</strong>ï¼Œè¯æ³•<strong>ä½œç”¨åŸŸè¢«ç§»é™¤</strong>ï¼Œè€Œå¼‚å¸¸åŒºåŸŸåˆ™è¢«è½¬æ¢ä¸ºè¾¹ä¸Šçš„å¼‚å¸¸åŒºåŸŸæ ‘</p></li><li><p>ä½¿ç”¨ä¸€ä¸ªâ€gimplifierâ€å°†<strong>GENERIC</strong>è½¬åŒ–ä¸º<strong>GIMPLE</strong></p></li><li><p>åŒ…æ‹¬â€<strong>High GIMPLE</strong>â€œå’Œâ€<strong>Low GIMPLE</strong>â€œ</p><ul><li>High GIMPLEåŒ…å«ä¸€äº›å®¹å™¨è¯­å¥ï¼Œå¦‚è¯æ³•èŒƒå›´å’ŒåµŒå¥—è¡¨è¾¾å¼ï¼Œæ´¾ç”Ÿè‡ª<strong>å‰ç«¯ASTæ ‘</strong>æˆ–<strong>GENERIC</strong>ï¼Œç„¶ååŸºäºHigh GIMPLEç”ŸæˆLow GIMPLE</li><li>Low GIMPLEåˆ™æ˜¾ç¤ºæ‰€æœ‰æ§åˆ¶å’Œå¼‚å¸¸è¡¨è¾¾å¼çš„éšå«è·³è½¬</li></ul></li><li><p>Cå’ŒC++å‰ç«¯ç›´æ¥ä»å‰ç«¯ASTæ ‘è½¬åŒ–ä¸º<strong>GIMPLE</strong>ï¼Œè€Œä¸æ˜¯è½¬åŒ–ä¸º<strong>GENERIC</strong></p></li><li><p>ä½¿ç”¨æ ‡å¿—<code>-fdump-tree-gimple</code>æ¥ç”Ÿæˆç±»Cçš„è¡¨ç¤º</p></li></ul><p><span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯´ç™½äº†ï¼Œ<strong>GIMPLE</strong>å°±æ˜¯å¹²äº†ä¸¤ä»¶äº‹ï¼š</p><p>â€‹<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ é™¤é«˜çº§ç»“æ„ï¼Œå¦‚forï¼Œwhileå¾ªç¯ã€ç”¨gotoå’Œè·³è½¬æ›¿æ¢ã€‘</p><p>â€‹<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç®€åŒ–è¡¨è¾¾å¼ï¼ˆé€šè¿‡å¼•å…¥ä¸´æ—¶å˜é‡ï¼‰</p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯ä»¥åœ¨Low GIMPLEå®ç°GIMPLEå±‚çº§çš„Passï¼</p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code> if (a || b) stmt;</code>  ==&gt;</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (a) <span class="hljs-keyword">goto</span> L1;<br><span class="hljs-keyword">if</span> (b) <span class="hljs-keyword">goto</span> L1; <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> L2;<br>L1:<br>stmt;<br>L2:<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>GCCç”ŸæˆGIMPLE</strong>ï¼š</p><p>Low GIMPLE:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-gimple<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.004t.gimple <br>fun (int a)<br>{<br>  int D.2258;<br><br>  <span class="hljs-keyword">if</span> (a &gt; 0) goto &lt;D.2256&gt;; <span class="hljs-keyword">else</span> goto &lt;D.2257&gt;;<br>  &lt;D.2256&gt;:<br>  D.2258 = -a;<br>  <span class="hljs-built_in">return</span> D.2258;<br>  &lt;D.2257&gt;:<br>  D.2258 = a;<br>  <span class="hljs-built_in">return</span> D.2258;<br>}<br>...<br></code></pre></td></tr></tbody></table></figure><p>High GIMPLE:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-gimple-raw<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.004t.gimple<br>fun (int a)<br>gimple_bind &lt;<br>  int D.2258;<br><br>  gimple_cond &lt;gt_expr, a, 0, &lt;D.2256&gt;, &lt;D.2257&gt;&gt;<br>  gimple_label &lt;&lt;<span class="hljs-string">D.2256&gt;&gt;</span><br><span class="hljs-string">  gimple_assign &lt;negate_expr, D</span>.2258, a, NULL, NULL&gt;<br>  gimple_return &lt;D.2258 NULL&gt;<br>  gimple_label &lt;&lt;<span class="hljs-string">D.2257&gt;&gt;</span><br><span class="hljs-string">  gimple_assign &lt;parm_decl, D</span>.2258, a, NULL, NULL&gt;<br>  gimple_return &lt;D.2258 NULL&gt;<br>&gt;<br>...<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>RTL:</strong></p><ul><li>å¯„å­˜å™¨è½¬æ¢è¯­è¨€ <em>Register Transfer Language</em>ï¼Œä¸æ±‡ç¼–è¯­è¨€å¾ˆæ¥è¿‘</li><li>è¡¨ç¤ºä¸€ä¸ªå…·æœ‰æ— é™æ•°é‡å¯„å­˜å™¨çš„æŠ½è±¡æœºå™¨ï¼Œç»“æ„ç±»ä¼¼äºLispå’ŒCè¯­è¨€çš„æ··åˆ</li><li>åœ¨ç”Ÿæˆ<strong>RTL</strong>ä»£ç åï¼ŒGCCç¼–è¯‘å™¨åœ¨å°†å…¶è½¬æ¢åˆ°æ±‡ç¼–è¯­è¨€ä¹‹å‰è¿›è¡Œäº†ä¸åŒçš„<strong>åº•å±‚ä¼˜åŒ–</strong> [7]</li><li>ç”±äº<strong>RTL</strong>è¡¨ç¤ºçš„ç”Ÿæˆå’Œä¼˜åŒ–çš„ç¨‹åºåœ¨ç¼–è¯‘è¿‡ç¨‹çš„åç«¯ï¼Œè¿™æ„å‘³ç€å®ƒä¾èµ–äºç¡¬ä»¶ï¼Œè€Œä¸åŒ…å«ç¨‹åºçš„æ‰€æœ‰ä¿¡æ¯</li></ul><p><span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯´ç™½äº†ï¼Œ<strong>RTL</strong>å°±æ˜¯å¹²äº†ä¸¤ä»¶äº‹ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†<strong>GIMPLE</strong>è½¬åŒ–ä¸ºä¸ç¡¬ä»¶ç›¸å…³çš„RTLè¯­è¨€</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨RTLåŸºç¡€ä¸Šè¿›è¡Œ<strong>åº•å±‚ä¼˜åŒ–</strong></p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°åŸºäºRTLå±‚çº§çš„Passï¼</p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>b = a - 1</code>  ==&gt;</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">(set (reg/v:SI 59 [ b ])<br>     (plus:SI (reg/v:SI 60 [ a ]<br>              (const_int -1 [0xffffffff]))))<br></code></pre></td></tr></tbody></table></figure><ul><li>RTLä¸­çš„ä¸€äº›ä¼˜åŒ–Passesï¼š</li></ul><table><thead><tr><th>Name</th></tr></thead><tbody><tr><td>RTL generation</td></tr><tr><td>Loop optimization</td></tr><tr><td>Jump bypassing</td></tr><tr><td>If conversion</td></tr><tr><td>Instruction combination</td></tr><tr><td>Register movement</td></tr><tr><td>Instruction scheduling</td></tr><tr><td>Register allocation</td></tr><tr><td>Final</td></tr></tbody></table><hr><p><strong>GCCç”ŸæˆRTLï¼š</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-rtl-all<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.310r.dfinish <br><br>;; Function fun (fun, funcdef_no=0, decl_uid=2248, cgraph_uid=0, symbol_order=0)<br><br>(note 1 0 4 NOTE_INSN_DELETED)<br>(note 4 1 28 2 [bb 2] NOTE_INSN_BASIC_BLOCK)<br>(insn/f 28 4 29 2 (<span class="hljs-built_in">set</span> (mem:DI (pre_dec:DI (reg/f:DI 7 sp)) [0  S8 A8])<br>        (reg/f:DI 6 bp)) <span class="hljs-string">"afl_inst_test.c"</span>:3 57 {*pushdi2_rex64}<br>     (nil))<br>(insn/f 29 28 30 2 (<span class="hljs-built_in">set</span> (reg/f:DI 6 bp)<br>        (reg/f:DI 7 sp)) <span class="hljs-string">"afl_inst_test.c"</span>:3 81 {*movdi_internal}<br>     (nil))<br>...<br></code></pre></td></tr></tbody></table></figure><h4 id="åç«¯ç”Ÿæˆ"><a href="#åç«¯ç”Ÿæˆ" class="headerlink" title="åç«¯ç”Ÿæˆ"></a>åç«¯ç”Ÿæˆ</h4><ul><li>åç«¯ä¸ºæŒ‡å®šçš„ç›®æ ‡å¹³å°ç”Ÿæˆæ±‡ç¼–ä»£ç </li></ul><p>GCCç”Ÿæˆç›®æ ‡å¹³å°æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc -S afl_inst_test.c<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.s<br></code></pre></td></tr></tbody></table></figure><h3 id="2-Clang"><a href="#2-Clang" class="headerlink" title="2. Clang"></a>2. Clang</h3><h4 id="å››ä¸ªé˜¶æ®µ-1"><a href="#å››ä¸ªé˜¶æ®µ-1" class="headerlink" title="å››ä¸ªé˜¶æ®µ"></a>å››ä¸ªé˜¶æ®µ</h4><ul><li>ä¸GCCç±»ä¼¼ï¼Œä¸å†èµ˜è¿°</li></ul><h4 id="å‰ç«¯åˆ†æ-1"><a href="#å‰ç«¯åˆ†æ-1" class="headerlink" title="å‰ç«¯åˆ†æ"></a>å‰ç«¯åˆ†æ</h4><ul><li>Clang<strong>å‰ç«¯ç®¡çº¿</strong>ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/6.png"></p><center>å›¾6 Clangå‰ç«¯æµæ°´çº¿</center><p><strong>é¢„å¤„ç†</strong>ï¼š</p><ul><li>C/C++é¢„å¤„ç†å™¨åœ¨<strong>è¯æ³•åˆ†æä¹‹å‰</strong>æ‰§è¡Œï¼Œä¸»è¦åŠŸèƒ½æ˜¯<ul><li>å±•å¼€å®</li><li>å±•å¼€åŒ…å«æ–‡ä»¶</li><li>æ ¹æ®å„ç§ä»¥#å¼€å¤´çš„é¢„å¤„ç†å™¨æŒ‡ç¤ºç•¥å»éƒ¨åˆ†ä»£ç </li></ul></li></ul><hr><p><strong>è¯æ³•åˆ†æï¼š</strong></p><ul><li>å¤„ç†æºä»£ç çš„æ–‡æœ¬è¾“å…¥ï¼Œå°†è¯­è¨€ç»“æ„åˆ†è§£ä¸ºä¸€ç»„å•è¯å’Œæ ‡è®°ï¼Œå»é™¤æ³¨é‡Šã€ç©ºç™½ã€åˆ¶è¡¨ç¬¦ç­‰</li><li>clangè¯æ³•åˆ†æè¾“å‡ºç»“æœï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang -cc1 -dump-tokens afl_inst_test.c<br>...<br></code></pre></td></tr></tbody></table></figure><p>ä¾‹å¦‚ï¼Œåœ¨<code>fun()</code>[Line 4-6] å‡½æ•°å†…çš„ifè¯­å¥é«˜äº®è¾“å‡ºæ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> <span class="hljs-string">'if'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">2</span>&gt;<br>l_paren <span class="hljs-string">'('</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">4</span>&gt;<br>identifier <span class="hljs-string">'a'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">5</span>&gt;<br>greater <span class="hljs-string">'&gt;'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">7</span>&gt;<br>numeric_constant <span class="hljs-string">'0'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">9</span>&gt;<br>r_paren <span class="hljs-string">')'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">10</span>&gt;<br>l_brace <span class="hljs-string">'{'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">11</span>&gt;<br><span class="hljs-keyword">return</span> <span class="hljs-string">'return'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">3</span>&gt;<br>minus <span class="hljs-string">'-'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">10</span>&gt;<br>identifier <span class="hljs-string">'a'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">11</span>&gt;<br>semi <span class="hljs-string">';'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">12</span>&gt;<br>r_brace <span class="hljs-string">'}'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">6</span>:<span class="hljs-number">2</span>&gt;<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>è¯­æ³•åˆ†æï¼š</strong></p><ul><li><p>å°†è¯æ³•åˆ†æäº§ç”Ÿçš„æ ‡è®°æµä½œä¸ºè¾“å‡ºï¼Œè¾“å‡ºè¯­æ³•æ ‘ï¼ˆASTï¼‰</p></li><li><p>ä¸€ä¸ªASTèŠ‚ç‚¹è¡¨æ˜å£°æ˜ã€è¯­å¥å’Œç±»å‹</p></li><li><p>è¯­æ³•è§£æå™¨æ¥å—å¹¶å¤„ç†åœ¨è¯æ³•é˜¶æ®µç”Ÿæˆçš„æ ‡è®°åºåˆ—ï¼Œæ¯å½“å‘ç°ä¸€ç»„è¦æ±‚çš„æ ‡è®°åœ¨ä¸€èµ·çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ªASTèŠ‚ç‚¹</p><ul><li><p>å¦‚æ¯å½“å‘ç°ä¸€ä¸ªæ ‡è®°tok::kw_ifæ—¶ï¼Œå°±ä¼šè°ƒç”¨<code>ParseIfStatement()</code>å‡½æ•°å¤„ç†ifè¯­å¥ä½“ä¸­çš„æ‰€æœ‰æ ‡è®°ï¼Œå¹¶ä¸ºå®ƒä»¬ç”Ÿæˆæ‰€å¿…é¡»çš„å­©å­ASTèŠ‚ç‚¹å’Œä¸€ä¸ªIfStmtæ ¹èŠ‚ç‚¹</p></li><li><pre><code class="c">// lib/Parse/ParseStmt.cpp...  case tok::kw_if:                  // C99 6.8.4.1: if-statement    return ParseIfStatement(TrailingElseLoc);  case tok::kw_switch:              // C99 6.8.4.2: switch-statement    return ParseSwitchStatement(TrailingElseLoc);...<figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">* </span>Clangå¹¶ä¸åœ¨è§£æä¹‹åéå†ASTï¼Œè€Œæ˜¯åœ¨ASTèŠ‚ç‚¹ç”Ÿæˆè¿‡ç¨‹ä¸­å³æ—¶æ£€æŸ¥ç±»å‹<br><br><span class="hljs-bullet">* </span>è¯­æ³•åˆ†æ<span class="hljs-strong">**è¯†åˆ«è§£æé”™è¯¯**</span><br><br><span class="hljs-bullet">* </span>Clangç”Ÿæˆ<span class="hljs-strong">**AST**</span>æ ‘ï¼š<br><br><span class="hljs-code">```bash</span><br><span class="hljs-code">$ clang -fsyntax-only -Xclang -ast-dump afl_inst_test.c</span><br><span class="hljs-code"># or clang -cc1 -ast-dump afl_inst_test.c [9]</span><br></code></pre></td></tr></tbody></table></figure></code></pre></li></ul></li><li><p>ASTæ ‘çš„å¯è§†åŒ–ç•Œé¢ï¼š</p></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang -fsyntax-only -Xclang -ast-view afl_inst_test.c<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>ç”ŸæˆLLVM IR</strong></p><ul><li><p>ç»è¿‡è¯æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æçš„è”åˆå¤„ç†ä¹‹åï¼ŒClangä¼šè°ƒç”¨<code>CodeGenAction()</code>ç¼–è¯‘<strong>AST</strong>ä»¥ç”Ÿæˆ<strong>LLVM IR</strong></p></li><li><p>å‰ç«¯æµæ°´çº¿ç»“æŸï¼</p></li></ul><h4 id="ä¸­é—´ç«¯ä¼˜åŒ–-11"><a href="#ä¸­é—´ç«¯ä¼˜åŒ–-11" class="headerlink" title="ä¸­é—´ç«¯ä¼˜åŒ–[11]"></a>ä¸­é—´ç«¯ä¼˜åŒ–<sup>[11]</sup></h4><ul><li><p>LLVMä¸­é—´è¡¨ç¤ºIRæ˜¯è¿æ¥å‰ç«¯å’Œåç«¯çš„ä¸­æ¢ï¼Œè®©LLVMèƒ½å¤Ÿè§£æå¤šç§æºè¯­è¨€ï¼Œä¸ºå¤šç§ç›®æ ‡ç”Ÿæˆä»£ç </p></li><li><p>å‰ç«¯äº§ç”ŸIRï¼Œåç«¯ä¹Ÿæ¥æ”¶IR</p></li><li><p>å¼•å…¥IRçš„å‡ºå‘ç‚¹ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è§£å†³ä¸åŒè¯­è¨€æºä»£ç çš„å·®å¼‚æ€§ï¼› <span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¾¿äºç”Ÿæˆä¸åŒå¹³å°ç›¸å¼‚çš„æœºå™¨æŒ‡ä»¤é›†</p><ul><li>é€šç”¨æ€§</li><li>é«˜çº§IRèƒ½å¤Ÿè®©ä¼˜åŒ–å™¨è½»æ¾æç‚¼å‡ºåŸå§‹æºä»£ç çš„æ„å›¾ï¼›ä½çº§IRè®©ç¼–è¯‘å™¨èƒ½å¤Ÿæ›´å®¹æ˜“ç”Ÿæˆä¸ºç‰¹å®šç¡¬ä»¶ä¼˜åŒ–çš„ä»£ç </li></ul></li><li><p>IRçš„ä¸‰ç§ç­‰ä»·å½¢å¼ï¼š</p><ul><li>é©»ç•™å†…å­˜çš„è¡¨ç¤ºï¼ˆæŒ‡ä»¤ç±»ç­‰ï¼‰</li><li>ç£ç›˜ä¸Šä»¥ç©ºé—´é«˜æ•ˆæ–¹å¼ç¼–ç çš„ä½è¡¨ç¤ºï¼ˆbitcodeæ–‡ä»¶ï¼‰</li><li>ç£ç›˜ä¸Šçš„äººç±»å¯è¯»æ–‡æœ¬è¡¨ç¤ºï¼ˆLLVMæ±‡ç¼–æ–‡ä»¶ï¼‰</li></ul></li><li><p>IRçš„å·¥ä½œæµå›¾ï¼š</p></li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/7.png"></p><center>å›¾7 LLVM IRå·¥ä½œæµå›¾</center><hr><p><strong>Clangç”ŸæˆIRï¼š</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// sum.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {<br>  <span class="hljs-keyword">return</span> a+b;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>ç”Ÿæˆbitcodeï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang sum.c -emit-llvm -c -o sum.bc<br></code></pre></td></tr></tbody></table></figure><ul><li>ç”Ÿæˆæ±‡ç¼–è¡¨ç¤ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang sum.c -emit-llvm -S -c -o sum.ll<br></code></pre></td></tr></tbody></table></figure><ul><li>æ±‡ç¼–LLVM IRæ±‡ç¼–æ–‡æœ¬ä»¥ç”Ÿæˆbitcodeï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-as sum.ll -o sum.bc<br></code></pre></td></tr></tbody></table></figure><ul><li>åç¼–è¯‘bitcodeä¸ºIRæ±‡ç¼–ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-dis sum.bc -o sum.ll<br></code></pre></td></tr></tbody></table></figure><ul><li>llvm-extractå·¥å…·æå–IRå‡½æ•°ã€å…¨å±€å˜é‡ï¼Œè¿˜èƒ½ä»IRæ¨¡å—ä¸­åˆ é™¤å…¨å±€å˜é‡ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-extract -func=<span class="hljs-built_in">sum</span> sum.bc -o sum-fn.bc<br></code></pre></td></tr></tbody></table></figure><h4 id="åç«¯ç”Ÿæˆ-12"><a href="#åç«¯ç”Ÿæˆ-12" class="headerlink" title="åç«¯ç”Ÿæˆ[12]"></a>åç«¯ç”Ÿæˆ<sup>[12]</sup></h4><ul><li>åç«¯ä¸»è¦çš„æ­¥éª¤å°±æ˜¯å°†LLVM IRè½¬æ¢ä¸ºç›®æ ‡æ±‡ç¼–ä»£ç ï¼Œå…·ä½“æ­¥éª¤å¦‚å›¾8æ‰€ç¤ºï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/8.png"></p><center>å›¾8 LLVM IRåˆ°ç›®æ ‡æ±‡ç¼–ä»£ç çš„æµç¨‹</center><ul><li><p>ç®€è¦æè¿°ä¸Šè¿°ä»£ç ç”Ÿæˆçš„å„ä¸ªé˜¶æ®µï¼š</p><ul><li><p><strong>æŒ‡ä»¤é€‰æ‹©</strong>ï¼ˆinstruction selectionï¼‰ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†å†…å­˜ä¸­çš„IRè¡¨ç¤ºå˜æ¢ä¸ºç›®æ ‡ç‰¹å®šçš„selectionDAGèŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªDAGè¡¨ç¤ºå•ä¸€åŸºæœ¬å—çš„è®¡ç®—</p><p>ä½ å¯ä»¥ä½¿ç”¨debugç‰ˆæœ¬çš„llcæ¥ç”ŸæˆselectionDAGèŠ‚ç‚¹ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -debug sum.bc <span class="hljs-comment"># è¿™é‡Œä½¿ç”¨debugç‰ˆæœ¬çš„clangï¼</span><br>...<br>SelectionDAG has 18 nodes:<br>  t0: ch = EntryToken<br>  t6: i64 = Constant&lt;0&gt;<br>      t2: i32,ch = CopyFromReg t0, Register:i32 %0<br>    t8: ch = store&lt;ST4[%a.addr]&gt; t0, t2, FrameIndex:i64&lt;0&gt;, undef:i64<br>    t4: i32,ch = CopyFromReg t0, Register:i32 %1<br>  t10: ch = store&lt;ST4[%b.addr]&gt; t8, t4, FrameIndex:i64&lt;1&gt;, undef:i64<br>      t11: i32,ch = load&lt;LD4[%a.addr](dereferenceable)&gt; t10, FrameIndex:i64&lt;0&gt;, undef:i64<br>      t12: i32,ch = load&lt;LD4[%b.addr](dereferenceable)&gt; t10, FrameIndex:i64&lt;1&gt;, undef:i64<br>    t13: i32 = add nsw t11, t12<br>  t16: ch,glue = CopyToReg t10, Register:i32 %eax, t13<br>  t17: ch = X86ISD::RET_FLAG t16, TargetConstant:i32&lt;0&gt;, Register:i32 %eax, t16:1<br>...<br></code></pre></td></tr></tbody></table></figure><p>æ­¤å¤–ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç”ŸæˆselectionDAGå›¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-dag-combine1-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/9.png"></p><center>å›¾9 sumå‡½æ•°çš„SelectionDAGå›¾</center><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ©ç”¨<strong>æ¨¡å¼åŒ¹é…</strong>å°†ç›®æ ‡æ— å…³çš„èŠ‚ç‚¹è½¬æ¢ä¸ºç›®æ ‡ç‰¹å®šçš„èŠ‚ç‚¹ï¼Œè€ŒæŒ‡ä»¤é€‰æ‹©çš„ç®—æ³•æ˜¯å±€éƒ¨çš„ï¼Œæ¯æ¬¡ä½œç”¨SelectionDAGï¼ˆåŸºæœ¬å—ï¼‰çš„å®ä¾‹</p><p>å¯ä»¥æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ç”ŸæˆæŒ‡ä»¤é€‰æ‹©åçš„SelectionDAGå›¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-sched-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/10.png"></p><center>å›¾10 æŒ‡ä»¤é€‰æ‹©åçš„sumå‡½æ•°çš„SelectionDAGå›¾</center><p>ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æŒ‡ä»¤é€‰æ‹©ä¹‹åï¼ŒåŸå…ˆDAGå›¾ä¸­çš„addèŠ‚ç‚¹è¢«æ›¿æ¢æˆADD32rrï¼ŒX86ISD::RET_FLAGè¢«æ›¿æ¢ä¸ºRETï¼Œloadè¢«æ›¿æ¢ä¸ºMOV32rmï¼Œstoreè¢«æ›¿æ¢ä¸ºMOV32mr</p></li><li><p><strong>æŒ‡ä»¤è°ƒåº¦</strong>ï¼ˆinstruction schedulingï¼‰ï¼š</p><ul><li>æŒ‡ä»¤å»¶è¿Ÿè¡¨ï¼šæ ¹æ®å…·ä½“ç¡¬ä»¶ä¿¡æ¯æ¥æé«˜æŒ‡ä»¤çº§å¹¶è¡Œï¼Œä»è€Œæé«˜åœ¨è®¡ç®—æœºä¸ŠæŒ‡ä»¤æµæ°´çº¿çš„æ€§èƒ½ [14]</li><li>é£é™©æ£€æµ‹ä¸è¯†åˆ«</li><li>è°ƒåº¦å•å…ƒ</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-sunit-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/11.png"></p><center>å›¾11 è°ƒåº¦å•å…ƒå›¾</center></li><li><p><strong>å¯„å­˜å™¨åˆ†é…</strong>ï¼ˆRegister allocationï¼‰</p><ul><li><p>ä½œç”¨åœ¨<strong>æœºå™¨æŒ‡ä»¤</strong>ä¸Šï¼š</p><ul><li>åœ¨æŒ‡ä»¤è°ƒåº¦ä¹‹åï¼ŒInstrEmitter Passä¼šè¢«è¿è¡Œï¼Œå®ƒå°†<code>SDNode</code>æ ¼å¼è½¬æ¢ä¸º<code>MachineInstr</code>æ ¼å¼</li><li>è¯¥è¡¨ç¤ºç›¸è¾ƒäºIRæŒ‡ä»¤æ›´æ¥è¿‘å®é™…çš„ç›®æ ‡æŒ‡ä»¤</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -march=sparc -print-machineinstrs sum.bc<br>...<br><span class="hljs-comment"># After Instruction Selection:</span><br><span class="hljs-comment"># Machine code for function sum: IsSSA, TracksLiveness</span><br>Frame Objects:<br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#0: size=4, align=4, at location [SP]</span><br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#1: size=4, align=4, at location [SP]</span><br>Function Live Ins: %i0 <span class="hljs-keyword">in</span> %0, %i1 <span class="hljs-keyword">in</span> %1<br><br>%bb.0: derived from LLVM BB %entry<br>    Live Ins: %i0 %i1<br>%1:intregs = COPY %i1; IntRegs:%1<br>%0:intregs = COPY %i0; IntRegs:%0<br>%3:intregs = COPY %1; IntRegs:%3,%1<br>%2:intregs = COPY %0; IntRegs:%2,%0<br>STri %stack.0.a.addr, 0, %0; mem:ST4[%a.addr] IntRegs:%0<br>STri %stack.1.b.addr, 0, %1; mem:ST4[%b.addr] IntRegs:%1<br>%4:intregs = LDri %stack.0.a.addr, 0; mem:LD4[%a.addr](dereferenceable) IntRegs:%4<br>%5:intregs = LDri %stack.1.b.addr, 0; mem:LD4[%b.addr](dereferenceable) IntRegs:%5<br>%6:intregs = ADDrr killed %4, killed %5; IntRegs:%6,%4,%5<br>%i0 = COPY %6; IntRegs:%6<br>RETL 8, implicit %i0<br>...<br></code></pre></td></tr></tbody></table></figure></li><li><p><strong>åŸºæœ¬ä»»åŠ¡ï¼š</strong>å°†æ— é™æ•°é‡çš„è™šæ‹Ÿå¯„å­˜å™¨è½¬æ¢ä¸ºæœ‰é™çš„ç‰©ç†å¯„å­˜å™¨</p></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -print-after=greedy sum.bc<br><span class="hljs-comment"># *** IR Dump After Greedy Register Allocator ***:</span><br><span class="hljs-comment"># Machine code for function sum: NoPHIs, TracksLiveness</span><br>Frame Objects:<br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#0: size=4, align=4, at location [SP+8]</span><br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#1: size=4, align=4, at location [SP+8]</span><br>Function Live Ins: %edi <span class="hljs-keyword">in</span> %0, %esi <span class="hljs-keyword">in</span> %2<br><br>0B%bb.0: derived from LLVM BB %entry<br>    Live Ins: %edi %esi<br>16B%3:gr32 = COPY %esi; GR32:%3<br>32B%1:gr32 = COPY %edi; GR32:%1<br>80BMOV32mr %stack.0.a.addr, 1, %noreg, 0, %noreg, %1; mem:ST4[%a.addr] GR32:%1<br>96BMOV32mr %stack.1.b.addr, 1, %noreg, 0, %noreg, %3; mem:ST4[%b.addr] GR32:%3<br>112B%7:gr32 = MOV32rm %stack.0.a.addr, 1, %noreg, 0, %noreg; mem:LD4[%a.addr] GR32:%7<br>144B%7:gr32 = ADD32rm %7, %stack.1.b.addr, 1, %noreg, 0, %noreg, implicit-def dead %eflags; mem:LD4[%b.addr] GR32:%7<br>160B%eax = COPY %7; GR32:%7<br>176BRETQ implicit %eax<br><br><span class="hljs-comment"># End machine code for function sum.</span><br><br></code></pre></td></tr></tbody></table></figure><ul><li>å¯„å­˜å™¨åˆå¹¶å™¨ã€è™šæ‹Ÿå¯„å­˜å™¨é‡å†™å’Œç›®æ ‡é’©å­</li></ul></li></ul></li></ul><h2 id="II-AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ"><a href="#II-AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ" class="headerlink" title="II. AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ"></a>II. AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ</h2><ul><li><p>åŸç”ŸAFLæœ‰<strong>ä¸¤ç§æ’æ¡©æ–¹å¼</strong></p><ul><li><p>åŸºäºç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©</p><ul><li>å…³é”®æ–‡ä»¶æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>afl-gcc.c</code>å’Œ<code>afl-as.c</code></li><li><code>afl-gcc/g++/clang/clang++/gcj</code>ï¼šç¼–è¯‘å™¨ï¼ˆgccã€clangã€gcjï¼‰çš„ä¸€ä¸ªwrapper <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç¼–è¯‘å™¨äº§ç”Ÿæ±‡ç¼–æ–‡ä»¶</li><li><code>afl-as</code>ï¼šæ±‡ç¼–å™¨ï¼ˆasï¼‰çš„ä¸€ä¸ªwrapper <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹ç¼–è¯‘å™¨äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ’æ¡©ï¼Œç„¶åè°ƒç”¨<code>as</code>ç”Ÿæˆç›®æ ‡æ–‡</li></ul><p>å›¾è§£ï¼š</p><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/12.png"></p><center>å›¾12 åŸºäºç¼–è¯‘å™¨çš„AFLæ’æ¡©æµç¨‹</center></li><li><p>åŸºäºLLVMæ¨¡å¼çš„æ’æ¡©</p><ul><li>å…³é”®æ–‡ä»¶å³<code>llvm_mode</code>æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</li></ul></li></ul></li></ul><h3 id="a-åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©"><a href="#a-åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©" class="headerlink" title="a. åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©"></a>a. åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©</h3><h4 id="1-afl-gcc-c"><a href="#1-afl-gcc-c" class="headerlink" title="1. afl-gcc.c"></a>1. afl-gcc.c</h4><ul><li><p>æ˜¯ä¸»æµç¼–è¯‘å™¨çš„ä¸€ä¸ªwrapperï¼Œæ ¹æ®å…·ä½“è°ƒç”¨çš„<code>afl-xxx</code>ç¼–è¯‘å™¨åæ¥è¿›è¡Œåˆ†æµï¼š</p><ul><li><p><code>afl-xxx</code>ç¼–è¯‘å™¨éƒ½æ˜¯<code>afl-gcc</code>çš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-gcc afl-g++ afl-clang afl-clang++<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-clang -&gt; afl-gcc*<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-clang++ -&gt; afl-gcc*<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-g++ -&gt; afl-gcc*<br>-rwxrwxr-x 1 chan chan 22976 Nov  3 23:52 afl-gcc*<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p>ä¸<code>afl-as</code>çš„ç»“åˆä½¿ç”¨ï¼šä½¿ç”¨<code>gcc/clang</code> <code>-B</code>é€‰é¡¹æ¥æŒ‡å®šæ±‡ç¼–å™¨è·¯å¾„ï¼Œå³AFLæœ¬èº«çš„è·¯å¾„</p><p>æ¢è¨€ä¹‹ï¼Œ<code>afl-gcc</code>æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨çš„åŸæ¥çš„ç¼–è¯‘å™¨ï¼Œåªä¸è¿‡å°†æ±‡ç¼–å™¨æ›¿æ¢ä¸ºäº†<code>afl-as</code>ï¼ˆè€Œ<code>afl-as</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿›è¡Œæ’æ¡©ï¼ï¼‰</p></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><ul><li><p><code>find_as()</code>ï¼šåœ¨ç¯å¢ƒå˜é‡<code>AFL_PATH</code>ã€AFLæœ¬èº«çš„è·¯å¾„ã€‘æä¾›â€å‡çš„â€GNUæ±‡ç¼–å™¨ï¼Œå³<code>AFL_PATH/as</code>ï¼›æˆ–è€…æ ¹æ®<code>argv[0]</code>çš„è·¯å¾„è¿›è¡Œæ´¾ç”Ÿã€‚<span class="github-emoji"><span>ğŸ““</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ³¨ï¼šè¿™é‡Œçš„<code>as</code>æœ¬èº«ä¹Ÿæ˜¯<code>afl-as</code>çš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-as as<br>-rwxrwxr-x 1 chan chan 37544 Nov  3 23:52 afl-as*<br>lrwxrwxrwx 1 chan chan     6 Nov  3 23:52 as -&gt; afl-as*<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ–°çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå³å°†<code>argv</code>ä¸­çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ä¸­ï¼ŒåŒæ—¶æä¾›ä¸€äº›å¿…è¦çš„ç¼–è¾‘ï¼š</p><ul><li><p>é¦–å…ˆå¯¹<code>argv[0]</code>è¿›è¡ŒåŒ¹é…ï¼Œå³è¿›è¡Œåˆ†æµï¼š</p><p><code>afl-clang</code> =&gt; <code>clang</code>; </p><p><code>afl-clang++</code> =&gt; <code>clang++</code>; </p><p><code>afl-g++</code> =&gt; <code>g++</code>; </p><p><code>afl-gcj</code> =&gt; <code>gcj</code>; </p><p><code>afl-gcc</code> =&gt; <code>gcc</code></p></li><li><p>ç„¶åå°†<code>argv</code>ä¸­å…¶ä»–çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¸€äº›é€‰é¡¹è¿›è¡Œå¤„ç†ï¼š</p><ul><li><code>-B</code>å°†è¢«è¦†å†™</li><li><code>-integrated-as</code>ã€<code>-pipe</code>ã€å°†è¢«åˆ é™¤</li><li>å¦‚æœé‡åˆ°<code>-fsanitize=address</code>æˆ–<code>-fsanitize=memory</code>æ—¶ï¼Œå°†<code>asan_set</code>æ ‡å¿—å˜é‡è®¾ç½®ä¸º1ï¼Œå°†é€‰é¡¹æ·»åŠ åˆ°<code>cc_params</code></li><li>å¦‚æœé‡åˆ°<code>FORTIFY_SOURCE</code>è®¾ç½®é¡¹ï¼Œåˆ™å°†<code>fortify_set</code>æ ‡å¿—å˜é‡è®¾ç½®ä¸º1ï¼Œå°†é€‰é¡¹æ·»åŠ åˆ°<code>cc_params</code>  <em># ç¼–è¯‘å™¨çš„ä¸€ç§å®‰å…¨æ£€æµ‹æœºåˆ¶ï¼Œé˜²æº¢å‡º</em></li></ul></li><li><p>ç„¶åæ·»åŠ -Bé€‰é¡¹ï¼Œå³<code>-B as_path</code>ï¼Œ<code>as_path</code>ä¸º<code>find_as()</code>å‡½æ•°è®¾ç½®çš„æ±‡ç¼–å™¨è·¯å¾„ã€‚æ¥ç€è¿›è¡Œ5ä¸ªåˆ¤æ–­ï¼š</p><ul><li><p>å¦‚æœæ˜¯<code>clang_mode</code>ï¼Œæ·»åŠ <code>-no-integrated-as</code>é€‰é¡¹ä»¥é¿å…ä½¿ç”¨clangé›†æˆçš„æ±‡ç¼–å™¨</p></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_HARDEN</code>ï¼Œåˆ™æ·»åŠ  <code>-fstack-protector-all</code> [15] å’Œ <code>-D_FORTIFY_SOURCE=2</code></p></li><li><p>å¦‚æœ<code>asan_set == 1</code>ï¼Œåˆ™å°†ç¯å¢ƒå˜é‡<code>AFL_USE_ASAN</code>è®¾ç½®ä¸º1ï¼›å¦åˆ™ï¼Œåˆ¤æ–­æ˜¯å¦è®¾ç½®äº†<code>AFL_USE_ASAN</code>æˆ–<code>AFL_USE_MSAN</code>ï¼Œå¹¶æ£€æŸ¥ç›¸åº”çš„äº’æ–¥æ€§å’Œæ·»åŠ ç›¸åº”çš„é€‰é¡¹ï¼ˆ<code>-U_FORTIFY_SOURCE</code> å’Œ <code>-fsanitize=address/memory</code>ï¼‰</p></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_DONT_OPTIMIZE</code>ï¼Œé‚£ä¹ˆå°†ä¸è¿›è¡Œä¼˜åŒ–æ“ä½œï¼Œå¦åˆ™å°†æ·»åŠ ä¸‹è¿°é€‰é¡¹ï¼š</p><table><thead><tr><th>é€‰é¡¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>-g</td><td>å…¨å±€ç»‘å®šï¼Œä¸»è¦ç”¨äºdebug</td></tr><tr><td>-O3</td><td>O3çº§ä¼˜åŒ–</td></tr><tr><td>-funroll-loops</td><td>é¿å…ä¼˜åŒ–å™¨å±•å¼€å¾ªç¯ï¼Œå…¶ä¸»è¦ç›®çš„æœ‰ä¸¤ä¸ªï¼š<br><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¾¿äºå¯¹å¾ªç¯ä½“çš„è¾¹è¿›è¡Œè·Ÿè¸ª<br><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é¿å…å¾ªç¯ä½“å†…å…¶ä»–è¾¹çš„æ•°é‡çˆ†ç‚¸ï¼ˆå¾ªç¯å±•å¼€åä¼šäº§ç”Ÿå†—ä½™è¾¹ï¼‰</td></tr><tr><td>-D__AFL_COMPILER=1</td><td># ä¸æ˜¯ç¼–è¯‘å™¨æœ¬èº«çš„é€‰é¡¹<br>åœ¨ChangeLogä¸­ï¼Œè¯¥å˜é‡ç”¨æ¥æŒ‡ç¤ºè¯¥ç¨‹åºæ˜¯åœ¨afl-gcc / afl-clang / afl-clang-fastä¸‹æ„å»ºçš„ï¼Œå¹¶ä¸”å…è®¸è‡ªå®šä¹‰çš„ä¼˜åŒ–</td></tr><tr><td>-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</td><td>-</td></tr></tbody></table></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_NO_BUILTIN</code>ï¼Œé‚£ä¹ˆå°†ä¸è¿›è¡Œç›¸å…³å‡½æ•°çš„å†…ç½®æ›¿æ¢ï¼ˆå³æ±‡ç¼–å¤„å°†ä½¿ç”¨<code>call</code>ç›¸å…³å‡½æ•°ï¼Œå¯¹äº<code>AFLæ’æ¡©</code>æ¥è¯´ï¼Œè¿™å°†å¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤é»˜è®¤è¿›è¡Œ<code>builtin</code>ï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œé€šè¿‡æ·»åŠ ä¸‹è¿°é€‰é¡¹æ¥å®ç°ï¼š</p><table><thead><tr><th align="center">é€‰é¡¹</th></tr></thead><tbody><tr><td align="center">-fno-builtin-strcmp</td></tr><tr><td align="center">-fno-builtin-strncmp</td></tr><tr><td align="center">-fno-builtin-strcasecmp</td></tr><tr><td align="center">-fno-builtin-strncasecmp</td></tr><tr><td align="center">-fno-builtin-memcmp</td></tr><tr><td align="center">-fno-builtin-strstr</td></tr><tr><td align="center">-fno-builtin-strcasestr</td></tr></tbody></table></li></ul></li></ul></li><li><p><code>execvp()</code>ï¼šæ‰§è¡Œæ„é€ çš„å‘½ä»¤è¡Œï¼Œå³<code>cc_params</code>ã€‚è¯¥å‘½ä»¤è¡Œå°†è°ƒç”¨ç¼–è¯‘å™¨ç”Ÿæˆç›¸åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­£å¦‚å‰æ‰€è¿°ï¼Œ<code>-B</code>æŒ‡å®šäº†<code>afl</code>çš„æ±‡ç¼–å™¨è¿›è¡Œæ’æ¡©æ“ä½œï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»<code>afl-as.c</code>çš„å…·ä½“æµç¨‹ã€‚</p></li></ul></li></ul><h4 id="2-afl-as-c"><a href="#2-afl-as-c" class="headerlink" title="2. afl-as.c"></a>2. afl-as.c</h4><ul><li><p>ç”±å‰æ‰€è¿°ï¼Œ<code>afl-gcc/clang/g++/clang++/gcj</code>é€šè¿‡<code>-B</code>å‚æ•°æŒ‡å®šäº†<code>AFLçš„æ±‡ç¼–å™¨</code>è·¯å¾„ï¼Œé‚£ä¹ˆåœ¨gcc/g++/clang/clang++/gcjç”Ÿæˆç›®æ ‡æ–‡ä»¶/å¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå°†ä½¿ç”¨afl-asä½œä¸ºå…¶ç¼–è¯‘å™¨ï¼Œè€Œafl-asæœ¬èº«ä¹Ÿæ˜¯asä¸€ä¸ªwrapperï¼š</p><ul><li>å…ˆå¯¹ç¼–è¯‘å™¨äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œ<strong>æ’æ¡©</strong></li><li>ç„¶åå†è°ƒç”¨ç³»ç»Ÿçš„<code>as</code>æ¥<strong>ç”Ÿæˆç›¸åº”çš„æœºå™¨ç </strong></li></ul></li><li><p><span class="github-emoji"><span>ğŸ’­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä½†æ˜¯è¿™æ ·ä¸€æ¥æ— æ³•å¯¹<code>afl-as</code>è¿›è¡Œè°ƒè¯•ï¼Ÿ</p><ul><li><p>ç»è¿‡å¯¹<code>afl-as</code>çš„ç®€å•åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡<code>afl-gcc -S</code>ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶ï¼Œç„¶åå°†æ±‡ç¼–æ–‡ä»¶æ”¾ç½®åœ¨<code>tmp</code>ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ afl-gcc -S afl_inst_test.c -o afl_inst_test.s<br>afl-cc 2.57b by &lt;lcamtuf@google.com&gt;<br>afl_inst_test.c: In <span class="hljs-keyword">function</span> â€˜mainâ€™:<br>afl_inst_test.c:12:2: warning: ignoring <span class="hljs-built_in">return</span> value of â€˜scanfâ€™, declared with attribute warn_unused_result [-Wunused-result]<br>  scanf(<span class="hljs-string">"%d"</span>, &amp;a);<br>  ^~~~~~~~~~~~~~~<br>$ <span class="hljs-built_in">mv</span> afl_inst_test.s /tmp<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä½¿ç”¨<code>afl-as</code>å¯¹ä¸Šè¿°äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ±‡ç¼–æ“ä½œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /home/chan/some_c_test/AFLAPI/afl-as -o afl_inst_test.o /tmp/afl_inst_test.s<br>afl-as 2.57b by &lt;lcamtuf@google.com&gt;<br>[+] Instrumented 4 locations (64-bit, non-hardened mode, ratio 100%).<br></code></pre></td></tr></tbody></table></figure><p>:happy:ç”±ä¸Šè¿°çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¯¥æ±‡ç¼–æ–‡ä»¶å·²ç»æˆåŠŸæ’æ¡©äº†ã€‚ä½†è¿™é‡Œæˆ‘ä»¬æ— æ³•æ•è·åˆ°æ’æ¡©åçš„æ±‡ç¼–æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦å¯¹<code>afl-as</code>è¿›è¡Œdebugã€‚</p></li></ul></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><p>ä¸€äº›å±€éƒ¨å˜é‡ï¼šinst_ratio_str =&gt; <strong>inst_ratio</strong> [é»˜è®¤ä¸º100ï¼Œæ’æ¡©ç‡ 0~100]ï¼›<strong>sanitizer</strong> [æ˜¯å¦å¯ç”¨ASAN/MSAN?] </p><ul><li><p><code>srandom()</code>ï¼šç½®æ—¶é—´ç§å­ï¼Œç§å­ç”±å½“å‰æ—¶é—´çš„ç§’ã€å¾®ç§’å’Œè¿›ç¨‹pidå¼‚æˆ–å¾—åˆ°</p></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ±‡ç¼–æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œ</p><ul><li><p>ç¯å¢ƒå˜é‡<code>TMPDIR</code>å¯ä»¥è‡ªå®šä¹‰ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œæ­¤å¤–ï¼Œç¯å¢ƒå˜é‡<code>TEMP</code>å’Œ<code>TMP</code>åŒæ ·æœ‰ç›¸åŒçš„åŠŸèƒ½ï¼Œå¦åˆ™<code>tmp_dir</code>é»˜è®¤ä¸ºâ€<code>/tmp</code>â€œï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¹‹å‰å°†æ±‡ç¼–æ–‡ä»¶æ”¾ç½®åœ¨<code>tmp</code>ç›®å½•ä¸‹çš„åŸå›  <span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p></li><li><p>ç„¶åå°†åŸ<code>argv</code>ã€å‰ <code>argc-1</code> ä¸ªé€‰é¡¹ã€‘æ‹·è´åˆ°<code>as_params[]</code>ä¸­ã€‚è¿™é‡Œæ£€æµ‹åŸå‘½ä»¤è¡Œä¸­æ˜¯å¦å‡ºç°<code>"--64"</code> / <code>"--32"</code>  =&gt; å°†<code>use_64bit</code>æ ‡å¿—å˜é‡ç›¸åº”çš„è®¾ç½®ä¸º1 / 0</p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ³¨ï¼šåœ¨è°ƒç”¨<code>afl-as</code>æ—¶ï¼Œå¿…é¡»å°†è¾“å…¥æ–‡ä»¶æ”¾ç½®åœ¨æœ€åï¼Œå³<code>afl-as -o xxx.o xxx.s</code><span class="github-emoji"><span>âœ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼Œ<code>afl-as xxx.s -o xxx.o</code><span class="github-emoji"><span>âŒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </p><p><code>input_file = argv[argc - 1] // xxx.s</code></p></li><li><p>åˆ¤æ–­<code>input_file</code>æ˜¯å¦åœ¨<code>/tmp</code>æˆ–<code>/var/tmp</code>ï¼Œå¦‚æœä¸å†åˆ™å°†<code>pass_thru</code>ç½®ä¸º1ã€è¿™ä¼šå¯¼è‡´åé¢ä¸è¿›è¡Œæ’æ¡©æ“ä½œã€‘</p><p><code>modified_file</code>ä¸ºæ’æ¡©åæ±‡ç¼–æ–‡ä»¶ï¼Œè¿™é‡Œæ ¹æ®æ—¶é—´å’Œpidéšæœºåˆ†é…ä¸€ä¸ªåå­—ï¼Œå¦‚<code>/tmp/.afl-4270-1669033267.s</code></p><p>ç„¶åå°†<code>modified_file</code>æ·»åŠ åˆ°<code>as_params</code>æœ€åï¼Œä½œä¸ºæ±‡ç¼–å™¨çš„è¾“å…¥æ–‡ä»¶ï¼</p></li></ul></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_USE_ASAN</code>æˆ–<code>AFL_USE_MSAN</code>ï¼Œå°†sanitizerç½®ä¸º1ï¼Œä¸”å°†<strong>æ’æ¡©ç‡inst_ratioé™¤ä»¥3</strong></p><p><span class="github-emoji"><span>â“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œä¸ºå•¥è¦å°†<code>inst_ratio</code>é™¤ä»¥3ï¼Ÿ</p><blockquote><p>æºç æ³¨é‡Šä¸­ä½œè€…è¿™æ ·æè¿°ï¼š</p><p>â€œåœ¨ä½¿ç”¨ASANç¼–è¯‘æ—¶ï¼Œæ²¡æœ‰ä¸€ä¸ªç‰¹åˆ«ä¼˜é›…çš„æ–¹æ³•è·³è¿‡ASANç‰¹æœ‰çš„åˆ†æ”¯ï¼Œä½†å¯ä»¥é€šè¿‡æ’æ¡©ç‡ä¸Šè¿›è¡Œè¡¥å¿â€¦â€</p><p>è§è§£ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ASANä¼šå¼•å…¥ç”±ASANæ‰€å¯¼è‡´çš„ç‰¹å®šåˆ†æ”¯ï¼Œè€Œå¦‚å‰æ‰€è¿°ï¼ŒASANæ’æ¡©æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹å®Œæˆçš„ï¼Œè€ŒAFLåœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–åŸºç¡€ä¸Šè¿›è¡Œæ’æ¡©ï¼Œå› æ­¤ä¼šå¯¹ASANæœ¬èº«ç‰¹å®šçš„åˆ†æ”¯è¿›è¡Œæ’æ¡©ã€‚æ¦‚ç‡æ’æ¡©ï¼ˆ33%ï¼‰åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿåæ˜ è½¯ä»¶çš„çœŸå®è¦†ç›–ç‡å¤§å°ã€‚</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ASANçš„æ’æ¡©æ˜¯<strong>é‡é‡çº§</strong>çš„ï¼Œå› æ­¤ASANå¼•å…¥çš„è¾¹å¯èƒ½ä¼šå¯¼è‡´æ¯”ç‰¹ä½å›¾ç¢°æ’æ€§æå‡ï¼Œè€Œæ¦‚ç‡æ’æ¡©èƒ½å¤Ÿè§£å†³è¿™ä¸€é—®é¢˜</p></blockquote></li><li><p><code>add_instrumentation()</code>ï¼šå¯¹æ±‡ç¼–æ–‡ä»¶è¿›è¡Œ<strong>æ’æ¡©</strong>ï¼ˆåˆ†æ”¯å¤„æ’æ¡© + ç›¸å…³è°ƒç”¨å‡½æ•°ï¼‰</p><ul><li><p>å¦‚æœ<code>input_file</code>æ–‡ä»¶ä¸èƒ½æ‰“å¼€ï¼Œåˆ™å°†<code>stdin</code>ä½œä¸ºè¾“å…¥ï¼›<code>modified_file</code>ä½œä¸ºè¾“å‡ºæ–‡ä»¶ï¼›</p></li><li><p>ã€<strong>åˆ†æ”¯å¤„æ’æ¡©</strong>ã€‘è¯»å–<code>input_file</code>ä¸­çš„æ¯ä¸€è¡Œï¼Œå¹¶åšä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼Œå…¶ä¸»è¦æ‰¾åˆ°ä¸‰ä¸ªä½ç½®ï¼š</p><ul><li><strong>å‡½æ•°å¤´ï¼š</strong></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">function_name:<br>.LFB23:<br>.file 1 "afl_inst_test.c"<br>.loc 1 3 0<br>.cfi_startproc<br>.LVL0:<br>.loc 1 5 0<br># &lt;&lt;======== instrumentation here<br>movl%edi, %eax<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>jx/jxxçš„ä¸¤æ¡åˆ†æ”¯ï¼š</strong></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># branch 1<br>.LVL7:<br>.loc 1 14 0<br>movl4(%rsp), %edx<br>cmpl$0, %edx<br>jg.L11<br># &lt;&lt;======== instrumentation here<br>.loc 1 16 0<br>jne.L12<br># &lt;&lt;======== instrumentation here<br>...<br># branch 2<br>.L11:<br>.cfi_restore_state<br>.LVL10:<br>.LBB26:<br>.LBB27:<br>.loc 2 104 0<br># &lt;&lt;======== instrumentation here<br>leaq.LC2(%rip), %rsi<br>movl$1, %edi<br>xorl%eax, %eax<br>call__printf_chk@PLT<br>.LVL11:<br>jmp.L7<br>.LVL12:<br>.L12:<br>.LBE27:<br>.LBE26:<br>.LBB28:<br>.LBB29:<br># &lt;&lt;======== instrumentation here<br>leaq.LC3(%rip), %rsi<br>movl$1, %edi<br>xorl%eax, %eax<br>call__printf_chk@PLT<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ±‡ç¼–ä¸­<code>.</code>å¼€å¤´æ ‡è¯†çš„æ„ä¹‰ [16]ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>.loc</code>ï¼š**Line Of Code [-g?]**ï¼Œæ ¼å¼ä¸º <code>.loc æ–‡ä»¶åºå· è¡Œåºå· [åˆ—] [é€‰é¡¹]</code>ï¼Œåœ¨ä¸Šç¤ºä¾‹ä¸­ï¼Œ<code>.loc 1 14 0</code>è¡¨ç¤ºfile 1ï¼šafl_inst_test.cï¼Œç¬¬14è¡Œç¬¬0åˆ— [17]</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> GCCä½¿ç”¨<code>.L</code>ç”¨äº<strong>æœ¬åœ°æ ‡ç­¾</strong></p><blockquote><p>æœ¬åœ°ç¬¦å·æ˜¯ä»¥æŸç§æœ¬åœ°æ ‡ç­¾å‰ç¼€å¼€å¤´çš„ä»»ä½•ç¬¦å·ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒELFç³»åˆ—çš„æœ¬åœ°æ ‡ç­¾å‰ç¼€æ˜¯â€œ.Lâ€</p><p>æœ¬åœ°ç¬¦å·åœ¨æ±‡ç¼–å™¨ä¸­è¢«å®šä¹‰å’Œä½¿ç”¨ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸è¢«ä¿å­˜åœ¨ç›®æ ‡æ–‡ä»¶ä¸­ã€‚å› æ­¤åœ¨è°ƒè¯•æ—¶å®ƒä»¬æ˜¯ä¸å¯è§çš„ã€‚å¯ä»¥ä½¿ç”¨<code>-L</code>é€‰é¡¹ä¿ç•™ç›®æ ‡æ–‡ä»¶ä¸­çš„æœ¬åœ°ç¬¦å· [18]</p><p>e.g.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt;/tmp$ as -c -L afl_inst_test.s <span class="hljs-comment"># you can also use `as --keep-locals -c afl_inst_test.s`</span><br>&gt;/tmp$ nm a.out<br>&gt;0000000000000000 T fun<br>      U _GLOBAL_OFFSET_TABLE_<br>      U __isoc99_scanf<br>&gt;000000000000006d t .L11<br>&gt;0000000000000082 t .L12<br>&gt;0000000000000097 t .L13<br>&gt;...<br>&gt;/tmp$ as -c afl_inst_test.s <br>&gt;/tmp$ nm a.out<br>&gt;0000000000000000 T fun<br>      U _GLOBAL_OFFSET_TABLE_<br>      U __isoc99_scanf<br>&gt;0000000000000000 r .LC0<br>&gt;0000000000000000 r .LC1<br>&gt;0000000000000003 r .LC2<br>&gt;000000000000001c r .LC3<br>&gt;0000000000000035 r .LC4<br>&gt;0000000000000000 T main<br>      U __printf_chk<br>      U __stack_chk_fail<br>&gt;/tmp$ <br></code></pre></td></tr></tbody></table></figure></blockquote><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>.L</code><strong>å‰ç¼€</strong>ï¼ˆæ˜¯DWARFè°ƒè¯•ä¿¡æ¯ï¼Œä¸é‡è¦ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUNC_BEGIN_LABEL  <span class="hljs-string">"LFB"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUNC_END_LABEL    <span class="hljs-string">"LFE"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_BEGIN_LABEL <span class="hljs-string">"LBB"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_END_LABEL   <span class="hljs-string">"LBE"</span></span><br>ASM_GENERATE_INTERNAL_LABEL (loclabel, <span class="hljs-string">"LVL"</span>, loclabel_num);<br></code></pre></td></tr></tbody></table></figure><p>LFBï¼šå‡½æ•°å¼€å§‹ï¼› LFEï¼šå‡½æ•°ç»“æŸï¼›LBBï¼šå—å¼€å§‹ï¼›LBEï¼šå—ç»“æŸï¼›LVLï¼šå°šä¸çŸ¥</p><p>è¯¦è§ [19]</p></li><li><p>ã€ç›¸å…³è°ƒç”¨å‡½æ•°çš„é™„åŠ ã€‘æœ€åï¼Œå°†<code>main_payload_64</code>æˆ–<code>main_payload_32</code>æ·»åŠ åˆ°æ±‡ç¼–æ–‡ä»¶çš„æœ«å°¾å¤„ã€‚è‡³æ­¤ï¼Œæ‰€æœ‰çš„æ’æ¡©è¿‡ç¨‹å‡å·²å®Œæˆï¼</p></li></ul></li><li><p><code>execvp()</code>ï¼š<code>fork</code>ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œæ„é€ çš„æ–°çš„<code>as_params</code>ï¼Œå³å¯¹æ’æ¡©åçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ±‡ç¼–æ“ä½œã€‚æœ€ååˆ é™¤ä¸´æ—¶æ–‡ä»¶ [<code>modified_file</code>]ï¼Œè‡³æ­¤ï¼Œæ±‡ç¼–ä»»åŠ¡å®Œæˆ</p></li></ul></li></ul><h4 id="3-afl-as-h-æ¡©ä»£ç è§£æ"><a href="#3-afl-as-h-æ¡©ä»£ç è§£æ" class="headerlink" title="3. afl-as.h (æ¡©ä»£ç è§£æ)"></a>3. afl-as.h (æ¡©ä»£ç è§£æ)</h4><ul><li>ä¸»è¦æœ‰ä¸¤ä¸ªæ¡©ä»£ç ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>trampoline_fmt_64/trampoline_fmt_32</code>ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>main_payload_64/main_payload_32</code>ï¼›</li></ul><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>trampoline_fmt_64/trampoline_fmt_32</code>ï¼ˆä»¥64ä½ä¸ºä¾‹ï¼‰ï¼š</p><ul><li>æ±‡ç¼–ç ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* --- AFL TRAMPOLINE (64-BIT) --- */<br><br>.align 4<br><br>leaq -(128+24)(%rsp), %rsp # åˆ†é…152å­—èŠ‚çš„æ ˆç©ºé—´<br>movq %rdx,  0(%rsp) # ä¿å­˜ç°åœº<br>movq %rcx,  8(%rsp)<br>movq %rax, 16(%rsp)<br>movq $0x%08x, %rcx    /* %08xæ˜¯ä¸€ä¸ªæ¯”ç‰¹ä½å›¾å¤§å°å†…çš„éšæœºæ•° */<br>call __afl_maybe_log<br>movq 16(%rsp), %rax # æ¢å¤ç°åœº<br>movq  8(%rsp), %rcx<br>movq  0(%rsp), %rdx<br>leaq (128+24)(%rsp), %rsp # å¤åŸæ ˆ<br><br>/* --- END --- */<br></code></pre></td></tr></tbody></table></figure><ul><li>ä¸Šè¿°æ±‡ç¼–ç è°ƒç”¨äº†<code>__afl_maybe_log(%rcx[i.e.å½“å‰åˆ†æ”¯å¯¹åº”çš„éšæœºæ•°])</code>æ¥è®°å½•è¾¹çš„æƒ…å†µ</li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>main_payload_64/main_payload_32</code>ï¼ˆä»¥64ä½ä¸ºä¾‹ï¼‰ï¼š</p><ul><li>æ±‡ç¼–ç ä¸»è¦åŒ…æ‹¬10ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>__afl_maybe_log</code>ã€<code>__afl_store</code>ã€<code>__afl_return</code>ã€<code>__afl_setup</code>ã€<code>__afl_setup_first</code>ã€<code>__afl_forkserver</code>ã€<code>__afl_fork_wait_loop</code>ã€<code>__afl_fork_resume</code>ã€<code>__afl_die</code>ã€<code>__afl_setup_abort</code></li><li><code>__afl_maybe_log</code>ã€<code>__afl_store</code>ã€<code>__afl_return</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_maybe_log:<br><br>  lahf   # save other flags to AH<br>  seto  %al   # set OF to al<br><br>  /* Check if SHM region is already mapped. */<br><br>  movq  __afl_area_ptr(%rip), %rdx # __afl_area_ptræ˜¯å…±äº«çš„bitmapä½å›¾å†…å­˜å—<br>  testq %rdx, %rdx<br>  je    __afl_setup   # je =&gt; jz å³åˆ¤æ–­è¯¥åœ°å€æ˜¯å¦ä¸º0ï¼›å¦‚æœä¸º0ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–<br>  <br>__afl_store:<br><br>  /* Calculate and store hit for the code location specified in rcx. */<br><br>  xorq __afl_prev_loc(%rip), %rcx  # %rcx = pre ^ cur<br>  xorq %rcx, __afl_prev_loc(%rip)  # __afl_prev_loc = pre ^ cur ^ pre = cur<br>  shrq $1, __afl_prev_loc(%rip)    # __afl_prev_loc = cur &gt;&gt; 1<br>  # (pre &gt;&gt; 1) ^ cur<br>  incb (%rdx, %rcx, 1)             # __afl_area_ptr[%rcx] = __afl_area_ptr[%rcx] + 1<br><br>__afl_return:<br><br>  addb $127, %al   # restore OF (if OF=1, al+127=128 =&gt; OF=1 else OF=0)<br>  sahf   # restore other flags<br>  ret<br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.align 8<br><br>__afl_setup:<br><br>  /* Do not retry setup if we had previous failures. */<br><br>  cmpb $0, __afl_setup_failure(%rip)  # å˜é‡__afl_setup_failureå¦‚æœä¸º0ï¼Œè¡¨ç¤ºä¹‹å‰é…ç½®æ²¡é—®é¢˜ï¼Œå¦åˆ™è¡¨ç¤ºä¹‹å‰å‡ºé”™äº†ï¼Œé‚£ä¹ˆè¿”å›<br>  jne __afl_return<br><br>  /* Check out if we have a global pointer on file. */<br><br>  movq  __afl_global_area_ptr@GOTPCREL(%rip), %rdx  # å°†__afl_global_area_ptrç§»é€åˆ°%rdx<br>  movq  (%rdx), %rdx    # å°†%rdxæŒ‡å‘çš„å€¼èµ‹å€¼ç»™%rdx<br>  testq %rdx, %rdx# åˆ¤æ–­%rdxæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œè¡¨æ˜æœªè¿›è¡Œåˆå§‹åŒ–æ“ä½œ<br>  je    __afl_setup_first# è·³è½¬åˆ°__afl_setup_firstè¿›è¡Œåˆå§‹åŒ–æ“ä½œ<br><br>  movq %rdx, __afl_area_ptr(%rip)# å°†å…¨å±€æŒ‡é’ˆèµ‹å€¼ç»™__afl_area_ptr<br>  jmp  __afl_store# æ›´æ–°å…¨å±€è¾¹è®¡æ•°<br><br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup_first</code>ã€<code>__afl_forkserver</code>ã€<code>__afl_fork_resume</code>å’Œ<code>__afl_die</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_setup_first:<br><br>  /* Save everything that is not yet saved and that may be touched by<br>     getenv() and several other libcalls we'll be relying on. */<br><br>  leaq -352(%rsp), %rsp<br>  <br>  # ä¿æŠ¤ç°åœº<br>  movq %rax,   0(%rsp)<br>  movq %rcx,   8(%rsp)<br>  movq %rdi,  16(%rsp)<br>  movq %rsi,  32(%rsp)<br>  movq %r8,   40(%rsp)<br>  movq %r9,   48(%rsp)<br>  movq %r10,  56(%rsp)<br>  movq %r11,  64(%rsp)<br><br>  movq %xmm0,  96(%rsp)<br>  movq %xmm1,  112(%rsp)<br>  movq %xmm2,  128(%rsp)<br>  movq %xmm3,  144(%rsp)<br>  movq %xmm4,  160(%rsp)<br>  movq %xmm5,  176(%rsp)<br>  movq %xmm6,  192(%rsp)<br>  movq %xmm7,  208(%rsp)<br>  movq %xmm8,  224(%rsp)<br>  movq %xmm9,  240(%rsp)<br>  movq %xmm10, 256(%rsp)<br>  movq %xmm11, 272(%rsp)<br>  movq %xmm12, 288(%rsp)<br>  movq %xmm13, 304(%rsp)<br>  movq %xmm14, 320(%rsp)<br>  movq %xmm15, 336(%rsp)<br><br>  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */<br><br>  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the<br>     original stack ptr in the callee-saved r12. */<br><br>  pushq %r12<br>  movq  %rsp, %r12# å°†%rspæš‚å­˜åˆ°%r12ä¸­<br>  subq  $16, %rsp# ä¸º%rspåˆ†é…16å­—èŠ‚çš„ç©ºé—´<br>  andq  $0xfffffffffffffff0, %rsp   # %rspæœ€åå››ä½æ¸…ç©ºå˜ä¸º0 ==&gt; æ ˆåœ°å€å¯¹é½åˆ°16å­—èŠ‚ï¼ˆåœ°å€æ˜¯16çš„æ•´æ•°å€ï¼‰<br><br>  leaq .AFL_SHM_ENV(%rip), %rdi# å°†å­—ç¬¦ä¸²"__AFL_SHM_ID"åœ°å€ä¿å­˜åˆ°%rdi<br>call getenv@PLT# è°ƒç”¨getenvï¼Œå³getenv("__AFL_SHM_ID")<br><br>  testq %rax, %rax# getenvè¿”å›å€¼å°†ç§»é€åˆ°$raxï¼Œè¿™é‡Œåˆ¤æ–­raxæ˜¯å¦ä¸º0ï¼Œå¦‚æœè¿”å›å€¼ä¸º0åˆ™è·³è½¬åˆ°__afl_setup_abort<br>  je    __afl_setup_abort<br><br>  movq  %rax, %rdi# å°†getenvè¿”å›çš„å­—ç¬¦ä¸²åœ°å€ç§»é€åˆ°%rdi(ç¬¬ä¸€ä¸ªå‚æ•°)<br>call atoi@PLT# è°ƒç”¨atoiå°†ç¯å¢ƒå˜é‡__AFL_SHM_IDçš„å€¼è½¬ä¸ºæ•´å‹ï¼Œè¿”å›çš„æ•´å‹å€¼ä¿å­˜åœ¨%raxä¸­<br><br>  xorq %rdx, %rdx   /* shmat flags    */<br>  xorq %rsi, %rsi   /* requested addr */<br>  movq %rax, %rdi   /* SHM ID         */<br>call shmat@PLT# è°ƒç”¨shmat(shmid --&gt; %rdi = %rax[atoiè¿”å›å€¼], shmaddr --&gt; %rsi = 0, shmflg --&gt; %rdx = 0)<br><br>  cmpq $-1, %rax# è¿”å› -1 è¡¨ç¤ºshmatè°ƒç”¨å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°__afl_setup_abort<br>  je   __afl_setup_abort<br><br>  /* Store the address of the SHM region. */<br><br>  movq %rax, %rdx# %raxä¿å­˜ç€è¿”å›çš„å…±äº«åœ°å€<br>  movq %rax, __afl_area_ptr(%rip)   # %raxä¿å­˜åˆ°__afl_area_ptrå˜é‡ä¸­<br><br>  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx  # __afl_global_area_ptræŒ‡é’ˆç§»é€åˆ°%rdx<br>  movq %rax, (%rdx)# å°†è¿”å›çš„å…±äº«åœ°å€ç§»é€åˆ°__afl_global_area_ptræŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼<br>  movq %rax, %rdx# å°†è¿”å›çš„åœ°å€ä¿å­˜åˆ°%rdxä¸­<br>  <br>__afl_forkserver:<br>  /* Enter the fork server mode to avoid the overhead of execve() calls. We<br>     push rdx (area ptr) twice to keep stack alignment neat. */<br><br>  pushq %rdx<br>  pushq %rdx<br><br>  /* Phone home and tell the parent that we're OK. (Note that signals with<br>     no SA_RESTART will mess it up). If this fails, assume that the fd is<br>     closed because we were execve()d from an instrumented binary, or because<br>     the parent doesn't want to use the fork server. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi       /* file desc */<br>call write@PLT# è°ƒç”¨write(198, __afl_temp, 4)<br><br>  cmpq $4, %rax# è¿”å›å€¼ä¿å­˜åˆ°%raxä¸­ï¼Œå¦‚æœ%rax == 4ï¼Œè¡¨æ˜å†™å…¥æˆåŠŸ<br>  jne  __afl_fork_resume# å¦‚æœé€šä¿¡å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°__afl_fork_resume<br><br>__afl_fork_wait_loop:<br><br>  /* Wait for parent by reading from the pipe. Abort if read fails. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $198, %rdi             /* file desc */<br>call read@PLT# è°ƒç”¨read(198, __afl_temp, 4)<br>  cmpq $4, %rax# è¿”å›å€¼ä¿å­˜åˆ°%raxä¸­ï¼Œå¦‚æœ%rax == 4ï¼Œè¡¨æ˜è¯»å…¥æˆåŠŸ<br>  jne  __afl_die# å¦åˆ™è·³è½¬åˆ°__afl_dieä¸­<br><br>  /* Once woken up, create a clone of our process. This is an excellent use<br>     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly<br>     caches getpid() results and offers no way to update the value, breaking<br>     abort(), raise(), and a bunch of other things :-( */<br><br>call fork@PLT# è°ƒç”¨fork()<br>  cmpq $0, %rax# åˆ¤æ–­fork()çš„è¿”å›å€¼ (=0 ==&gt; å­è¿›ç¨‹ï¼Œ &lt;0 ==&gt; å¤±è´¥ï¼Œ &gt;0 ==&gt; åœ¨ä¸»è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹PID)<br>  jl   __afl_die# å¦‚æœ&lt;0(å¤±è´¥) åˆ™è·³è½¬åˆ°__afl_dieä¸­<br>  je   __afl_fork_resume# å¦‚æœ=0() ä½äºå­è¿›ç¨‹ä¸­ï¼Œåˆ™è·³è½¬åˆ°__afl_fork_resume<br><br>  /* In parent process: write PID to pipe, then wait for child. */<br><br>  movl %eax, __afl_fork_pid(%rip)# ã€è¯¥åˆ†æ”¯ä½äºçˆ¶è¿›ç¨‹ä¸­ã€‘ %eaxä¸ºfork()è¿”å›çš„å­è¿›ç¨‹PIDå€¼ï¼Œä¿å­˜åˆ°__afl_fork_pidä¸­<br><br>  movq $4, %rdx                   /* length    */<br>  leaq __afl_fork_pid(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi             /* file desc */<br>call write@PLT# è°ƒç”¨write(199, &amp;__afl_fork_pid, 4);<br><br>  movq $0, %rdx                   /* no flags  */<br>  leaq __afl_temp(%rip), %rsi     /* status    */<br>  movq __afl_fork_pid(%rip), %rdi /* PID       */<br>call waitpid@PLT# è°ƒç”¨waitpid(__afl_fork_pid, __afl_temp, 0);<br>  cmpq $0, %rax# waitpid()è¿”å›å€¼è‹¥â‰¤0ï¼Œåˆ™è·³è½¬åˆ°__afl_die<br>  jle  __afl_die<br><br>  /* Relay wait status to pipe, then loop back. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi         /* file desc */<br>call write@PLT# è°ƒç”¨write(199, &amp;__afl_temp, 4);<br><br>  jmp  __afl_fork_wait_loop# å›åˆ°å¾ªç¯é¦–<br>  <br>__afl_fork_resume:# è¯¥åˆ†æ”¯ä¸ºå­è¿›ç¨‹æ“ä½œ<br><br>  /* In child process: close fds, resume execution. */<br><br>  movq $198, %rdi<br>call close@PLT# è°ƒç”¨close(198)<br><br>  movq $(198 + 1), %rdi<br>call close@PLT# è°ƒç”¨close(199)<br>  # æ¢å¤ç°åœºï¼ï¼<br>  popq %rdx<br>  popq %rdx<br><br>  movq %r12, %rsp<br>  popq %r12<br><br>  movq  0(%rsp), %rax<br>  movq  8(%rsp), %rcx<br>  movq 16(%rsp), %rdi<br>  movq 32(%rsp), %rsi<br>  movq 40(%rsp), %r8<br>  movq 48(%rsp), %r9<br>  movq 56(%rsp), %r10<br>  movq 64(%rsp), %r11<br><br>  movq  96(%rsp), %xmm0<br>  movq 112(%rsp), %xmm1<br>  movq 128(%rsp), %xmm2<br>  movq 144(%rsp), %xmm3<br>  movq 160(%rsp), %xmm4<br>  movq 176(%rsp), %xmm5<br>  movq 192(%rsp), %xmm6<br>  movq 208(%rsp), %xmm7<br>  movq 224(%rsp), %xmm8<br>  movq 240(%rsp), %xmm9<br>  movq 256(%rsp), %xmm10<br>  movq 272(%rsp), %xmm11<br>  movq 288(%rsp), %xmm12<br>  movq 304(%rsp), %xmm13<br>  movq 320(%rsp), %xmm14<br>  movq 336(%rsp), %xmm15<br><br>  leaq 352(%rsp), %rsp<br><br>  jmp  __afl_store  # è·³è½¬åˆ°__afl_storeå»æ‰§è¡Œè¾¹çš„è®°å½•<br><br>__afl_die:<br><br>  xorq %rax, %rax<br>call _exit@PLT# è°ƒç”¨exit(0)<br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup_abort</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_setup_abort:<br><br>  /* Record setup failure so that we don't keep calling<br>     shmget() / shmat() over and over again. */<br><br>  incb __afl_setup_failure(%rip)  # __afl_setup_failure++;<br>  # æ¢å¤ç°åœº<br>  movq %r12, %rsp<br>  popq %r12<br><br>  movq  0(%rsp), %rax<br>  movq  8(%rsp), %rcx<br>  movq 16(%rsp), %rdi<br>  movq 32(%rsp), %rsi<br>  movq 40(%rsp), %r8<br>  movq 48(%rsp), %r9<br>  movq 56(%rsp), %r10<br>  movq 64(%rsp), %r11<br><br>  movq  96(%rsp), %xmm0<br>  movq 112(%rsp), %xmm1<br>  movq 128(%rsp), %xmm2<br>  movq 144(%rsp), %xmm3<br>  movq 160(%rsp), %xmm4<br>  movq 176(%rsp), %xmm5<br>  movq 192(%rsp), %xmm6<br>  movq 208(%rsp), %xmm7<br>  movq 224(%rsp), %xmm8<br>  movq 240(%rsp), %xmm9<br>  movq 256(%rsp), %xmm10<br>  movq 272(%rsp), %xmm11<br>  movq 288(%rsp), %xmm12<br>  movq 304(%rsp), %xmm13<br>  movq 320(%rsp), %xmm14<br>  movq 336(%rsp), %xmm15<br><br>  leaq 352(%rsp), %rsp<br><br>  jmp __afl_return<br><br></code></pre></td></tr></tbody></table></figure><p><code>__afl_maybe_log()</code>ä¼ªä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64* __afl_area_ptr;<br>__int64 __afl_prev_loc;<br><span class="hljs-type">int</span> __afl_fork_pid;<br><span class="hljs-type">int</span> __afl_temp;<br>__int8 __afl_setup_failure;<br>__int64* __afl_global_area_ptr;<br><br><span class="hljs-type">void</span> _afl_maybe_log(__int64 random)<br>{<br>    <br>  __int64 flags;<br>  <span class="hljs-type">void</span>* shmaddr;<br>  <br>  v5 = v4;<br>  v6 = __afl_area_ptr;<br>  <span class="hljs-keyword">if</span> ( !__afl_area_ptr )<br>  {<br>    <span class="hljs-keyword">if</span> ( __afl_setup_failure )<br>      <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ( __afl_global_area_ptr )<br>    {<br>      __afl_area_ptr = __afl_global_area_ptr;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-type">char</span>* id = getenv(<span class="hljs-string">"__AFL_SHM_ID"</span>);<br>      <span class="hljs-keyword">if</span> ( !id || __afl_area_ptr = shmat(atoi(id), shmaddr, flags) )<br>      {<br>        __afl_setup_failure++;<br>        <span class="hljs-keyword">return</span>;<br>      }<br>      __afl_global_area_ptr = __afl_area_ptr;<br>      <span class="hljs-keyword">if</span> ( write(<span class="hljs-number">199</span>, &amp;_afl_temp, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span> )<br>      {<br>        <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>        {<br>          <span class="hljs-type">int</span> pid = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">198</span>, &amp;_afl_temp, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span> )<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-keyword">if</span> ( __afl_fork_pid = fork() &lt; <span class="hljs-number">0</span> )<br>             <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// é€€å‡º</span><br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !__afl_fork_pid ){<br>            <span class="hljs-comment">// å­è¿›ç¨‹</span><br>            close(<span class="hljs-number">198</span>);  <span class="hljs-comment">// å…³é—­è¿™ä¸¤ä¸ªç®¡é“</span><br>      close(<span class="hljs-number">199</span>);<br>__afl_area_ptr[random ^ __afl_prev_loc]++;<br>            __afl_prev_loc = random &gt;&gt; <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">return</span>;<br>          }<span class="hljs-keyword">else</span>{<br>            <span class="hljs-comment">// çˆ¶è¿›ç¨‹ï¼ˆforkserverï¼‰</span><br>          write(<span class="hljs-number">199</span>, &amp;__afl_fork_pid, <span class="hljs-number">4</span>);  <span class="hljs-comment">// å°†pidå†™å…¥ç®¡é“? ä½œç”¨æ˜¯å•¥?</span><br>          <span class="hljs-keyword">if</span> ( waitpid(__afl_fork_pid, &amp;__afl_temp, <span class="hljs-number">0</span>) &lt;= <span class="hljs-number">0</span> )<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// é€€å‡º</span><br>          write(<span class="hljs-number">199</span>, &amp;__afl_temp, <span class="hljs-number">4</span>);     <span class="hljs-comment">// è¿™é‡Œå°†__afl_tempå†™å›æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</span><br>          }<br>        }<br>      }<br>    }<br>  }<span class="hljs-keyword">else</span>{<br>      __afl_area_ptr[random ^ __afl_prev_loc]++;<br>      __afl_prev_loc = random &gt;&gt; <span class="hljs-number">1</span>;<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸Šè¿°æ’æ¡©æ®‹ç•™ä¸€ä¸ªé—®é¢˜ï¼š</p><p>â€‹çˆ¶è¿›ç¨‹çš„ä¸»è¦ä½œç”¨æ˜¯ç»´æŒä¸€ä¸ª<code>fork-server</code>ï¼Œé‚£å®ƒä¸AFLä¹‹é—´é€šè¿‡ä¸€ä¸ªç®¡é“è¿›è¡Œé€šä¿¡ï¼Œä½†é€šä¿¡çš„å…·ä½“ç»†èŠ‚æ˜¯å•¥å‘¢ï¼Ÿ</p><h4 id="4-ä¸AFLé€šä¿¡"><a href="#4-ä¸AFLé€šä¿¡" class="headerlink" title="4. ä¸AFLé€šä¿¡"></a>4. ä¸AFLé€šä¿¡</h4><ul><li><p>åœ¨AFLä¸­ï¼Œ<code>afl-fuzz</code>ä¸­<code>init_forkserver()</code>æ˜¯åˆå§‹åŒ–forkserverçš„å‡½æ•°ï¼š</p><ul><li>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œ<code>afl-fuzz</code>ä¼š<code>fork</code>å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸ºç®¡é“åˆ†é…æ–°çš„fdï¼ˆ198 ==&gt; æ§åˆ¶ç®¡é“<code>ctl_pipe[0]</code>ï¼Œ199 ==&gt; çŠ¶æ€ç®¡é“<code>st_pipe[0]</code>ï¼‰ã€‚è€Œè¿™ä¸ªå­è¿›ç¨‹<code>execv</code>ä¸€ä¸ªè¢«æµ‹ç¨‹åºï¼Œè¿™ä¸ªè¢«æµ‹ç¨‹åºï¼ˆi.e. fork-serverï¼‰åœ¨è°ƒç”¨ç¬¬ä¸€ä¸ª<code>__afl_maybe_log()</code>å‡½æ•°æ—¶ï¼Œé¦–å…ˆä¼šå‘çŠ¶æ€ç®¡é“å†™å…¥4å­—èŠ‚çš„ä»»æ„æ•°æ®ï¼Œç„¶åå°†åœ¨whileå¾ªç¯ä¸­çš„ç¬¬ä¸€ä¸ª<code>read(198, &amp;_afl_temp, 4)</code>å¤„é˜»å¡ï¼Œç­‰å¾…<code>AFL-fuzzer</code>å‘æ¥ä¿¡æ¯ï¼›</li><li>è€Œåœ¨<code>afl-fuzz</code>çˆ¶è¿›ç¨‹ä¸­ï¼Œé€šè¿‡è¯»å–çŠ¶æ€ç®¡é“4å­—èŠ‚çš„æ•°æ®æ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸå¯ç”¨<code>fork-server</code></li></ul></li><li><p>åœ¨AFLä¸­ï¼Œ<code>run_target()</code>å°†é€šçŸ¥<code>fork-server</code>å‡ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥è·‘æ¨¡ç³Šæµ‹è¯•ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ï¼š</p><ul><li><code>afl-fuzz</code>è¿›ç¨‹å°†4ä¸ªå­—èŠ‚çš„è¶…æ—¶æ—¶é—´å†™å…¥åˆ°æ§åˆ¶ç®¡é“</li><li><code>fork-server</code>åœ¨è¯»å–åˆ°4ä¸ªå­—èŠ‚ï¼ˆ0ï¼‰ä¹‹åï¼Œå°†åœæ­¢é˜»å¡ã€‚ç„¶å<code>fork()</code>å‡ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥è·‘å®é™…çš„è¢«æµ‹ç›®æ ‡ï¼Œ<code>pid</code>å°†é€šè¿‡çŠ¶æ€ç®¡é“é€å›ç»™<code>afl-fuzzer</code>ï¼Œç„¶åæ”¶é›†è¦†ç›–ç‡ä¿¡æ¯ã€‚è¿™é‡Œ<code>fork-server</code>å°†è¿™è¯»å…¥çš„å››å­—èŠ‚0ç”¨äº<code>waitpid()</code>çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç„¶åç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<code>fork-server</code>å†å‘çŠ¶æ€ç®¡é“å†™å…¥4å­—èŠ‚ï¼Œè¡¨æ˜è¢«æµ‹ç¨‹åºæ‰§è¡Œå®Œæ¯•</li><li><code>afl-fuzz</code>æ ¹æ®<code>fork</code>å‡ºæ¥çš„è¢«æµ‹ç¨‹åº<code>pid</code>çš„ç»“æŸä¿¡å·å’Œè¦†ç›–ç‡ä¿¡æ¯åšè¿›ä¸€æ­¥çš„åˆ†æå¤„ç†</li></ul></li><li><p>æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­ â‘ â†’â‘¡â†’â‘¢ ä¸ºåˆ›å»º<code>fork-server</code>çš„è¿‡ç¨‹ï¼Œâ‘£â†’â‘¤â†’â‘¥â†’â‘¦â†’â‘§â†’â‘¨ ä¸ºä¸€æ¬¡å®Œæ•´çš„<code>run_target()</code>çš„è¿‡ç¨‹ã€‚</p></li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/13.png"></p><center name="pic13">å›¾13 AFLä¸fork-serveré€šä¿¡æµç¨‹å›¾</center><h3 id="b-åŸºäºLLVMçš„æ’æ¡©"><a href="#b-åŸºäºLLVMçš„æ’æ¡©" class="headerlink" title="b. åŸºäºLLVMçš„æ’æ¡©"></a>b. åŸºäºLLVMçš„æ’æ¡©</h3><ul><li>afl-clang-fastã€afl-clang-fast++</li><li>åŸºäºLLVM <strong>Pass</strong>å®ç°</li></ul><h4 id="1-afl-clang-fast-c"><a href="#1-afl-clang-fast-c" class="headerlink" title="1. afl-clang-fast.c"></a>1. afl-clang-fast.c</h4><ul><li><p>æ˜¯clangå’Œclang++çš„ä¸€ä¸ªwrapperï¼Œæ ¹æ®å…·ä½“è°ƒç”¨çš„afl-clang-fast(++)æ¥åŒºåˆ†</p><ul><li>afl-clang-fast++æ˜¯afl-clang-fastçš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-clang-fast afl-clang-fast++<br>-rwxrwxr-x 1 chan chan 24608 Nov 28 18:36 afl-clang-fast*<br>lrwxrwxrwx 1 chan chan    14 Nov 28 18:36 afl-clang-fast++ -&gt; afl-clang-fast*<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä¸<strong>llvm Pass</strong>ï¼ˆ<code>afl-llvm-pass.so</code>ï¼‰ç»“åˆä½¿ç”¨ï¼šä½¿ç”¨<code>-Xclang</code>è®©clangè¿è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„<strong>Pass</strong></p><ul><li>ä¸<code>afl-gcc</code>çš„åŒºåˆ«ï¼šPassåœ¨<strong>ç¼–è¯‘å™¨è¿è¡Œæ—¶</strong>è¿›è¡Œæ’æ¡©ï¼Œè€Œ<code>afl-gcc</code>å¯¹<strong>ç¼–è¯‘å™¨è¿è¡Œç»“æŸå</strong>ç”Ÿæˆçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ’æ¡©</li></ul></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><ul><li><p><code>find_obj()</code>ï¼šå¯»æ‰¾<code>afl-llvm-rt.o</code>ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶å°†AFLè·¯å¾„ä¿å­˜åˆ°<code>obj_path</code>å˜é‡ä¸­</p></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ–°çš„ç¼–è¯‘å‘½ä»¤è¡Œé€‰é¡¹<code>cc_params</code>ï¼Œå°†<code>argv</code>ä¸­çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ä¸­ï¼ŒåŒæ—¶æä¾›ä¸€äº›å¿…è¦çš„ç¼–è¾‘ï¼š</p><ul><li><p>é¦–å…ˆå¯¹<code>argv[0]</code>è¿›è¡ŒåŒ¹é…ï¼Œå³è¿›è¡Œåˆ†æµï¼š</p><p><code>afl-clang-fast++</code> =&gt; <code>clang++</code></p><p><code>afl-clang-fast</code> =&gt; <code>clang</code></p></li><li><p>å¦‚æœä½¿ç”¨<code>trace_pc</code>æ¨¡å¼ï¼Œåˆ™åœ¨<code>cc_params</code>åè¿½åŠ <code>-fsanitize-coverage=trace-pc-guard</code>ï¼›å¦åˆ™è¿½åŠ ä¸¤ä¸ªé€‰é¡¹ï¼š<code>-Xclang -load</code>ï¼ˆåŠ è½½åŒ…å«æ’ä»¶æ³¨å†Œè¡¨çš„åŠ¨æ€åº“ï¼‰å’Œ<code>-Xclang obj_path/afl-llvm-pass.so</code>ã€‚æ­¤å¤–ï¼Œè¿˜è¦é¢å¤–è¿½åŠ ä¸€ä¸ª<code>-Qunused-arguments</code> [20] é€‰é¡¹æ¥é™é»˜å…³äºæœªä½¿ç”¨å‚æ•°çš„è­¦å‘Šã€‚</p></li><li><p>å°†<code>argv[]</code>ä¸­å…¶ä»–çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ï¼Œåœ¨æ­¤æœŸé—´å°†æ›´æ–°ä¸€äº›å˜é‡å€¼</p></li></ul><table><thead><tr><th>é€‰é¡¹</th><th>å˜é‡</th></tr></thead><tbody><tr><td>-m32ã€armv7a-linux-androideabi</td><td>bit_mode = 32</td></tr><tr><td>-m64</td><td>bit_mode = 64</td></tr><tr><td>-x &lt;language&gt; (å°†è¾“å…¥æ–‡ä»¶è¯•ä¸ºæŸä¸€è¯­è¨€çš„æ–‡ä»¶)</td><td>x_set = 1 ==&gt; â€œ-x noneâ€</td></tr><tr><td>-fsanitize=addressã€-fsanitize=memory</td><td>asan_set = 1</td></tr><tr><td>FORTIFY_SOURCE</td><td>fortify_set = 1</td></tr><tr><td>-Wl,-z,defs</td><td>ä¸è¿½åŠ åˆ°<code>cc_params</code>ä¸­</td></tr><tr><td>-Wl,â€“no-undefined</td><td>ä¸è¿½åŠ åˆ°<code>cc_params</code>ä¸­</td></tr></tbody></table><ul><li>åé¢è¿½åŠ çš„ä¸€äº›é€‰é¡¹ä¸<code>afl-gcc</code>ç›¸ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†<code>trace pc</code>æ¨¡å¼ï¼Œ<code>AFL_INST_RATIO</code>å°†ä¸å¯ä½¿ç”¨ã€‚<code>afl-clang-fast</code>ä½¿ç”¨<code>-D</code>é€‰é¡¹å‘<code>cc_params</code>è¿½åŠ äº†ä¸€äº›éšå¼çš„<code>#define</code>ï¼Œåˆ†åˆ«æ˜¯ï¼š</li></ul><table><thead><tr><th>å€¼</th></tr></thead><tbody><tr><td>__AFL_HAVE_MANUAL_CONTROL=1</td></tr><tr><td>__AFL_COMPILER=1</td></tr><tr><td>FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</td></tr><tr><td>__AFL_LOOP(_A)=({ static volatile char *_B __attribute__((used)); _B = (char*) â€œ##SIG_AFL_PERSISTENT##â€; __attribute__((visibility("default"))) int _L(unsigned int) __asm__("__afl_persistent_loop"); _L(_A); })</td></tr><tr><td>__AFL_INIT()=do  { static volatile char *_A __attribute__((used));   _A = (char*) â€œ##SIG_AFL_DEFER_FORKSRV##â€; __attribute__((visibility("default")))  void _I(void) __asm__("__afl_manual_init"); _I(); } while (0)</td></tr></tbody></table><ul><li>æœ€åï¼Œæ ¹æ®<code>bit_mode</code>å‘<code>cc_params</code>åè¿½åŠ å¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ [ é»˜è®¤ä¸º <code>afl-llvm-rt.o</code>ï¼Œ32ä½ <code>afl-llvm-rt-32.o</code>ï¼Œ64ä½ <code>afl-llvm-rt-64.o</code> ]</li></ul></li><li><p><code>execvp()</code>ï¼šæ‰§è¡Œæ„é€ çš„å‘½ä»¤è¡Œï¼Œå³<code>cc_params</code>ã€‚è¯¥å‘½ä»¤è¡Œé€šè¿‡<code>-Xclang</code>è¿è¡Œ<strong>Pass</strong>ï¼Œç„¶åå°†<code>afl-llvm-rt.o</code>ç›®æ ‡æ–‡ä»¶é“¾æ¥åˆ°æœ€ç»ˆç”Ÿæˆçš„<code>afl-clang-fast</code>ã€‚</p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œ<code>afl-llvm-pass.so.cc</code>çš„ä½œç”¨æ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯æ„é€ æ‰§è¡Œ<strong>Pass</strong>æ’æ¡©çš„åŠ¨æ€é“¾æ¥åº“ï¼Œä½†ç›®æ ‡æ–‡ä»¶<code>afl-llvm-rt.o</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p></li></ul></li></ul><h4 id="2-afl-llvm-pass-so-cc"><a href="#2-afl-llvm-pass-so-cc" class="headerlink" title="2. afl-llvm-pass.so.cc"></a>2. afl-llvm-pass.so.cc</h4><ul><li><p>ç”Ÿæˆæ‰§è¡Œæ’æ¡©<strong>Pass</strong>çš„åŠ¨æ€é“¾æ¥åº“</p></li><li><p><code>AFLCoverage::runOnModule</code>ï¼šç”¨äºæ‰§è¡Œè½¬æ¢ï¼ˆæ’æ¡©ï¼‰</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ›å»ºä¸¤ä¸ªå…¨å±€å˜é‡ï¼š</p><p><code>__afl_area_ptr</code> ç”¨äºä¿å­˜å…±äº«å†…å­˜åŒºåŸŸçš„åœ°å€ï¼›<code>__afl_prev_loc</code>ç”¨äºå­˜æ”¾å‰ä¸€ä¸ªåŸºæœ¬å—IDå³ç§»ä¸€ä½çš„å€¼</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> éå†æ‰€æœ‰åŸºæœ¬å—BBï¼š</p><ul><li>éšæœºç”Ÿæˆä¸€ä¸ªåŸºæœ¬å—IDå€¼<code>cur_loc</code></li><li>è½½å…¥å…¨å±€å˜é‡<code>__afl_prev_loc</code></li><li>è½½å…¥å…¨å±€å…±äº«å†…å­˜åŒºåŸŸæŒ‡é’ˆ<code>__afl_area_ptr</code>ï¼Œè®¡ç®—å€¼<code>cur_loc xor __afl_prev_loc</code></li><li>æ›´æ–°æ¯”ç‰¹ä½å›¾ï¼šå°†ä¸Šè¿°è®¡ç®—å€¼ä½œä¸ºç´¢å¼•ï¼Œåœ¨<code>__afl_area_ptr</code>ä¸­å¯»å€ï¼Œè®©å¯¹åº”çš„å­—èŠ‚å€¼+1</li><li>æ›´æ–°<code>__afl_prev_loc</code>çš„å€¼ï¼š<code>__afl_prev_loc = cur_loc &gt;&gt; 1</code></li></ul></li><li><p><code>registerAFLPass</code>ç”¨æ¥æ³¨å†Œè¯¥<strong>AFLCoverage Pass</strong>ç±»</p></li></ul><h4 id="3-afl-llvm-rt-o-c"><a href="#3-afl-llvm-rt-o-c" class="headerlink" title="3. afl-llvm-rt.o.c"></a>3. afl-llvm-rt.o.c</h4><ul><li><p>è¯¥æ–‡ä»¶çš„ä¸»è¦ä½œç”¨æœ‰ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨è¢«æµ‹ç›®æ ‡ç¨‹åºæ‰§è¡Œä¹‹å‰è°ƒç”¨<code>__afl_auto_init()</code>åˆå§‹åŒ–å‡½æ•°ï¼š</p><ul><li>ä½¿ç”¨<code>__attribute__((constructor(CONST_PRIO)))</code>å…³é”®å­—ï¼Œè®©è¯¥å‡½æ•°åœ¨è¢«æµ‹ç›®æ ‡ç¨‹åºè°ƒç”¨<code>main()</code>å‡½æ•°ä¹‹å‰æ‰§è¡Œ [21]</li><li>è°ƒç”¨<code>__afl_manual_init()</code>å‡½æ•°ï¼š<ul><li><code>__afl_map_shm()</code>å‡½æ•°ç”¨æ¥è·å–å…±äº«å†…å­˜åŒºåŸŸåœ°å€</li><li><code>__afl_start_forkserver()</code>å‡½æ•°ç”¨æ¥å¯åŠ¨<code>fork-server</code>ï¼Œå…¶æ•´ä½“é€»è¾‘ä¸<a href="#pic13">å›¾13</a>ä¸€æ ·ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€æ³¨ï¼šè¿™é‡Œæ˜¯æ­»å¾ªç¯ï¼Œç”¨æ¥<code>fork</code>å­è¿›ç¨‹ã€‘</li></ul></li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Persistent mode</strong></p><ul><li><p>åœ¨æºæ–‡ä»¶ä¸­è®¾ç½®<code>__AFL_LOOP(int)</code>åå¯ç”¨</p></li><li><p>å¦‚å‰æ‰€è¿°ï¼Œ<code>afl-clang-fast</code>åœ¨ç¼–è¯‘ç›®æ ‡ç¨‹åºæ—¶ï¼Œä¼šä½¿ç”¨<code>-D</code>é€‰é¡¹å¼•å…¥ä¸€ä¸ª<code>#define __AFL_LOOP(_A)</code>çš„å®å®šä¹‰ï¼Œè¯¥å®å®šä¹‰ä¼šå°†æºä»£ç ä¸­çš„<code>__AFL_LOOP(int)</code>æ›¿æ¢ä¸º<code>__afl_persistent_loop(int)</code>ã€é€šå¸¸<code>__AFL_LOOP()</code>ä¸<code>while()</code>ç»“åˆä½¿ç”¨ã€‘</p></li><li><p><code>int __afl_persistent_loop(unsigned int max_cnt)</code>ï¼š</p><ul><li>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œè¯¥å‡½æ•°ä¼šæ¸…ç©º<code>__afl_area_ptr</code>çš„å€¼ï¼Œå³æ¸…ç©ºè¦†ç›–ç‡è·Ÿè¸ªä½å›¾ä¿¡æ¯ï¼ˆåœ¨è¾¾åˆ°<code>__AFL_LOOP()</code>ä¹‹å‰çš„æ‰€æœ‰è¦†ç›–ç‡ä¿¡æ¯éƒ½å°†è¢«æ¸…ç©ºï¼‰ï¼Œç„¶åå°†<code>__afl_area_ptr[0]</code>ç½®ä¸º1ï¼Œ<code>__afl_prev_loc</code>ç½®ä¸º0</li><li>åœ¨éç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼ˆå¦‚ä¸<code>while()</code>å¾ªç¯ä¸€èµ·ä½¿ç”¨æ—¶ï¼‰ï¼Œè¯´æ˜å‰ä¸€è½®çš„è¦†ç›–ç‡ä¿¡æ¯å·²ç»ç»Ÿè®¡å®Œæˆï¼Œåœ¨è½®æ•°ä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œé¦–å…ˆ<code>raise(SIGSTOP)</code>ï¼Œè¡¨ç¤ºç¨‹åºæš‚åœï¼Œç„¶å<code>fork-server</code>çš„<code>waitpid</code>å°†ç›´æ¥è¿”å›ï¼Œç¨‹åºä»åœ¨è¿è¡Œä¸­ï¼Œç„¶åè¯¥è¦†ç›–ç‡ä¿¡æ¯å°†è¢«AFLå¤„ç†ï¼ŒåŒæ—¶ç”Ÿæˆä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æŠ•å–‚ç»™ç›®æ ‡ç¨‹åº</li><li><code>fork-server</code>å†æ¥æ”¶åˆ°AFLç”Ÿæˆäº†æ–°çš„æµ‹è¯•ç”¨ä¾‹å¹¶éœ€è¦è¿è¡Œç›®æ ‡ç¨‹åºçš„æ¶ˆæ¯ä¹‹åï¼Œç”±äºå…ˆå‰çš„ç¨‹åºå¤„äºæš‚åœçŠ¶æ€ï¼Œ<code>fork-server</code>å°†ä¸ä¼š<code>fork()</code>ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œè€Œæ˜¯å‘ä¹‹å‰æš‚åœçš„å­è¿›ç¨‹å‘é€<code>SIGCONT</code>ï¼ˆç»§ç»­è¿è¡Œï¼‰çš„ä¿¡å·ï¼Œç„¶ååˆå›åˆ°ä¸Šä¸€æ­¥çš„å¾ªç¯ä¸­ï¼Œç›´åˆ°å¾ªç¯æ¬¡æ•°ç»“æŸ</li><li>å¾ªç¯æ¬¡æ•°ç»“æŸåï¼Œ<code>__afl_area_ptr</code>ä¼šé‡å®šå‘åˆ°ä¸€ä¸ªè™šå‡çš„ä½å›¾<code>__afl_area_initial</code>ä¸­ï¼Œé¿å…æ”¶é›†<code>__AFL_LOOP()</code>åé¢æ‰§è¡Œçš„ä»£ç è¦†ç›–ç‡</li></ul></li><li><p>ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span>(__AFL_LOOP(<span class="hljs-number">1000</span>)) {<br>   <span class="hljs-comment">// AFLåªä¼šç»Ÿè®¡è¯¥å¾ªç¯ä¸­çš„ä»£ç è¦†ç›–ç‡</span><br>    <span class="hljs-comment">// ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼Œé¿å…é¢‘ç¹çš„è°ƒç”¨ç¨‹åºçš„åˆå§‹åŒ–æ“ä½œï¼›</span><br>    <span class="hljs-comment">//      èƒ½å¤Ÿé€šè¿‡ä¸€å®šæ•°é‡è¾“å…¥çš„æŠ•å–‚ä½¿å¾—ç¨‹åºåˆ°è¾¾æŸä¸€çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥è¦†ç›–åˆ°æ›´æ·±å±‚æ¬¡çš„ä»£ç ï¼ˆè¿™å¯¹äºç½‘ç»œç¨‹åºæ¥è¯´å…·æœ‰å¥‡æ•ˆï¼‰</span><br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>æµç¨‹å›¾ï¼š</p><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/14.png"></p><center>å›¾14 persistent modeæµç¨‹å›¾</center></li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Deferred forkserveræ¨¡å¼</strong>ï¼š</p><ul><li><p>ç”±ç¯å¢ƒå˜é‡<code>__AFL_DEFER_FORKSRV</code>æ§åˆ¶ï¼Œç”¨äºæ§åˆ¶åœ¨ä½•æ—¶å¯åŠ¨forkserverï¼Œé¿å…ä¸€äº›é•¿æ—¶é—´çš„åˆå§‹åŒ–æ“ä½œå½±å“ååé‡</p></li><li><pre><code class="c">__AFL_INIT(); // the forkserver will be raised here!// do something ...</code></pre></li></ul><p><span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>trace_pc_guardæ¨¡å¼</strong>ï¼š</p><ul><li><p>trace_pc_guardæ¨¡å¼å¯¹æ‰€æœ‰çš„è¾¹è¿›è¡Œæ’æ¡©ï¼Œæ’æ¡©å€¼ä¸ºguard</p></li><li><p><code>__sanitizer_cov_trace_pc_guard_init(start, stop)</code>ï¼š</p><ul><li>æ›¿æ¢æ¯ä¸ª<code>trace_pc</code>å¤„çš„<code>guard</code>å€¼ï¼ˆéšæœºæ•°ï¼‰ï¼Œä¸è¿›è¡Œæ’æ¡©çš„<code>guard</code>å€¼è®¾ç½®ä¸º0</li></ul></li><li><p><code>__sanitizer_cov_trace_pc_guard(guard)</code>ï¼š</p><ul><li>æ›´æ–°å…±äº«å†…å­˜æ•°æ®ï¼šå¯¹æ¯”ç‰¹ä½å›¾ä¸­ç´¢å¼•ä¸º<code>guard</code>çš„å­—èŠ‚+1</li></ul></li></ul><p>trace_pc_guardç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼š</p><ol><li><p>makefile ä¸­å®šä¹‰ <code>AFL_TRACE_PC = 1</code></p></li><li><p>å¦‚æœè¾“å‡ºå¦‚ä¸‹æ˜¾ç¤ºï¼Œåˆ™å°†afl-clang-fast.c çš„ç¬¬133è¡Œæ›¿æ¢ä¸ºï¼š<code>c_params[cc_par_cnt++] = "-sanitizer-coverage-level=0";</code> </p><blockquote><p>clang (LLVM option parsing): Unknown command line argument â€˜-sanitizer-coverage-block-threshold=0â€™.  Try: â€˜clang (LLVM option parsing) -helpâ€™<br>clang (LLVM option parsing): Did you mean â€˜-sanitizer-coverage-pc-table=0â€™?</p></blockquote></li></ol></li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h2><ol><li><p><a href="https://en.wikibooks.org/wiki/GNU_C_Compiler_Internals/Print_version">GNU C ç¼–è¯‘å™¨å†…éƒ¨/æ‰“å°ç‰ˆ - ç»´åŸºæ•™ç§‘ä¹¦ï¼Œå¼€æ”¾ä¸–ç•Œçš„å¼€æ”¾ä¹¦ç± (wikibooks.org)</a></p></li><li><p><a href="https://stackoverflow.com/questions/34502255/ast-from-c-code-with-preprocessor-directives">gcc - AST from c code with preprocessor directives - Stack Overflow</a></p></li><li><p><a href="https://stackoverflow.com/questions/15800230/how-can-i-dump-an-abstract-syntax-tree-generated-by-gcc-into-a-dot-file">graphviz - How can I dump an abstract syntax tree generated by gcc into a .dot file? - Stack Overflow</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gccint/GIMPLE.html">GIMPLE (GNU Compiler Collection (GCC) Internals)</a></p></li><li><p><a href="https://wiki.aalto.fi/pages/viewpage.action?pageId=55374641">GCC GENERIC - Advanced course on compilers - Aalto University Wiki</a></p></li><li><p><a href="https://blog.csdn.net/qq_36287943/article/details/105458166">GCC - GIMPLE IR å­¦ä¹ ä¸€_zhugl0çš„åšå®¢-CSDNåšå®¢_gimple</a></p></li><li><p><a href="https://wiki.aalto.fi/pages/viewpage.action?pageId=55375140">GCC RTL - Advanced course on compilers - Aalto University Wiki</a></p></li><li><p><a href="https://www.cs.nmsu.edu/~rth/cs/cs271/notes/Compiling.html">CS271: Compiling (nmsu.edu)</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch04.html">ç¬¬4ç«  å‰ç«¯ â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://stackoverflow.com/questions/14163208/how-to-link-c-object-files-with-ld">linker - How to link C++ object files with ld - Stack Overflow</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch05.html">ç¬¬5ç«  LLVMä¸­é—´è¡¨ç¤º â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html">ç¬¬6ç«  åç«¯ â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://discourse.llvm.org/t/llc-view-dag-combine1-dags/1876/5">LLC -view-dag-combine1-dags - Beginners - LLVM Discussion Forums</a></p></li><li><p><a href="https://blog.csdn.net/weixin_46222091/article/details/104414187">æŒ‡ä»¤è°ƒåº¦æ¦‚å¿µåŸç†ä»‹ç»_ronnie88597çš„åšå®¢-CSDNåšå®¢</a></p></li><li><p><a href="https://mudongliang.github.io/2016/05/24/stack-protector.html">GCC Stack Protector options (mudongliang.github.io)</a></p></li><li><p><a href="https://stackoverflow.com/questions/24787769/what-are-lfb-lbb-lbe-lvl-loc-in-the-compiler-generated-assembly-code">c - What are .LFB .LBB .LBE .LVL .loc in the compiler generated assembly code - Stack Overflow</a></p></li><li><p><a href="https://sourceware.org/binutils/docs-2.18/as/LNS-directives.html#LNS-directives">LNS directives - Using as (sourceware.org)</a></p></li><li><p><a href="https://sourceware.org/binutils/docs-2.18/as/Symbol-Names.html">Symbol Names - Using as (sourceware.org)</a></p></li><li><p><a href="https://github.com/gcc-mirror/gcc/blob/master/gcc/dwarf2out.cc">gcc/gcc at master Â· gcc-mirror/gcc (github.com)</a></p></li><li><p><a href="https://clang.llvm.org/docs/genindex.html">Index â€” Clang 16.0.0git documentation (llvm.org)</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-6.2.0/gcc/Common-Function-Attributes.html">Common Function Attributes - Using the GNU Compiler Collection (GCC)</a></p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Boofuzzæºç è§£æ</title>
    <link href="/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="boofuzzæºç åˆ†æ"><a href="#boofuzzæºç åˆ†æ" class="headerlink" title="boofuzzæºç åˆ†æ"></a>boofuzzæºç åˆ†æ</h1><p>ä»¥<code>ftp_simple.py</code>ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">session = Session(target=Target(connection=TCPSocketConnection(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">21</span>)))  <span class="hljs-comment"># åˆ›å»ºsession</span><br><br>define_proto(session=session)  <span class="hljs-comment"># å®šä¹‰proto</span><br><br>session.fuzz()<span class="hljs-comment"># å¼€å§‹æ¨¡ç³Šæµ‹è¯•</span><br></code></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ï¼Œ<code>define_proto()</code> å°†è°ƒç”¨<code>session.connect()</code>æ„é€ è°ƒç”¨æµå›¾ã€‚å¦‚æœ<code>connect(node1)</code>çš„å‚æ•°åªæœ‰åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°†ä¿å­˜åœ¨<code>self.nodes</code>å˜é‡ä¸­ï¼ŒåŒæ—¶ä¼šåˆ›å»º<code>self.root</code>åˆ°è¯¥èŠ‚ç‚¹çš„è¾¹ï¼›å¦‚æœ<code>connect(node1, node2)</code>ï¼Œnode1å’Œnode2èŠ‚ç‚¹ä¿¡æ¯éƒ½å°†ä¿å­˜åœ¨<code>self.nodes</code>å˜é‡ä¸­ï¼ŒåŒæ—¶ä¼šåˆ›å»ºnode1åˆ°node2çš„è¾¹</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">session.connect(user)<br>   session.connect(user, passw)<br>   session.connect(passw, stor)<br>   session.connect(passw, retr)<br></code></pre></td></tr></tbody></table></figure><p><code>session.fuzz()</code>æ ¸å¿ƒä»£ç åœ¨<code>_main_fuzz_loop</code>ä¸­</p><p>åœ¨<code>_main_fuzz_loop</code>ä¸­ï¼š</p><p><code>self.server_init()</code>ï¼šå¯åŠ¨<code>web_interface_thread</code>ï¼ˆç½‘ç»œæ¥å£çº¿ç¨‹ï¼šé»˜è®¤ä¸ºlocalhost:26000ï¼‰</p><p><code>self._start_target()</code>ï¼šå¯åŠ¨ä¸€ä¸ªboofuzz.sessions.Targetå®ä¾‹</p><p>ç›¸å…³å˜é‡</p><table><thead><tr><th>å˜é‡å</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>self.num_cases_actually_fuzzed</td><td>å®é™…fuzzçš„æµ‹è¯•ç”¨ä¾‹æ•°</td></tr><tr><td>mutation_context</td><td>å˜å¼‚ä¸Šä¸‹æ–‡</td></tr><tr><td>fuzz_case_iterator</td><td>fuzzæµ‹è¯•ç”¨ä¾‹è¿­ä»£å™¨</td></tr></tbody></table><p>éå†<code>fuzz_case_iterator</code>ä¸­çš„<code>mutation_context</code>ï¼Œ</p><ul><li><p>å¦‚æœè®¾ç½®äº†<code>restart_interval</code>ï¼Œè¡¨æ˜æ¯æ¬¡è¿è¡Œ<code>restart_interval</code>ä¸ªæµ‹è¯•ç”¨ä¾‹åé‡å¯target</p></li><li><p><code>_fuzz_current_case()</code>å‡½æ•°å¯¹å½“å‰çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œè€Œè¯¥æµ‹è¯•ç”¨ä¾‹ç”±<code>fuzz_case_iterator</code>æ§åˆ¶ï¼š</p><ul><li><p><code>_pause_if_pause_flag_is_set()</code>å‡½æ•°<code>pause flag</code>æ˜¯å¦è¢«å”¤èµ·ï¼Œå¦‚æœè¢«å”¤èµ·ï¼Œåˆ™è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ç­‰å¾…å…¶å˜ä¸ºFalseï¼ˆWhyï¼Ÿï¼‰</p></li><li><p><code>self._test_case_name()</code>å‡½æ•°ç”¨äºæ„é€ æµ‹è¯•ç”¨ä¾‹åï¼Œæµ‹è¯•ç”¨ä¾‹åå­—æ ¼å¼ä¸ºï¼š<code>message_path:[qualified_name1:mutation.index1,  qualified_name2:mutation.index2, ...]</code>ï¼Œä¾‹å¦‚<code>user:[user.key:0]</code></p></li><li><p><code>self._fuzz_data_logger.open_test_case()</code>è®°å½•æµ‹è¯•ç”¨ä¾‹ï¼Œé»˜è®¤æ˜¯è®²ä¿å­˜æ’å…¥æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯çš„sqlè¯­å¥æ·»åŠ åˆ°<code>self._queue</code>é˜Ÿåˆ—ä¸­ã€‚ï¼ˆåœ¨ä½•å¤„æ‰§è¡Œï¼Ÿåœ¨<a href="#logger_close">æ­¤å¤„</a>æ‰§è¡Œï¼‰</p></li><li><p><code>self._open_connection_keep_trying()</code>å°è¯•ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥ï¼ˆå»ºç«‹<strong>å¥—æ¥å­—</strong>å¹¶<strong>è¿æ¥</strong>ï¼‰ï¼Œå¦‚æœæ˜¯å› ä¸ºå¯ç”¨å¥—æ¥å­—æ•°ä¸å¤Ÿå¯¼è‡´çš„é”™è¯¯ï¼Œé‚£å°±å†è¿›è¡Œ50è½®*5sçš„åˆ¤æ–­ã€å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æœ‰å¯ä»¥åˆ›å»ºå¥—æ¥å­—ï¼Œåˆ™ç»§ç»­è¿›è¡Œï¼Œå¦åˆ™å°†æŠ¥é”™ã€‘ã€‚</p></li><li><p><code>self._pre_send(target)</code>ï¼šä¸çŸ¥é“å¹²å•¥çš„</p></li><li><p><code>self.transmit_fuzz()</code>ï¼š</p><ul><li><code>self.fuzz_node.render()</code>ï¼šæ¸²æŸ“æ¨¡ç³Šæµ‹è¯•èŠ‚ç‚¹æ•°æ®</li><li>æ¸²æŸ“å®Œæˆåï¼Œç”±self.targets[0]æ¥<strong>å‘é€</strong>è¯¥æ•°æ®</li><li>å¦‚æœ<code>self._receive_data_after_fuzz</code>ä¸º<code>True</code>ï¼Œåˆ™å°†è¿”å›çš„ä¿¡æ¯ä¿å­˜åˆ°receivedå˜é‡ä¸­</li></ul></li><li><p><code>self._check_for_passively_detected_failures()</code>ï¼šè¢«åŠ¨æ£€æŸ¥é”™è¯¯ã€‚é¦–å…ˆï¼Œéœ€è¦éå†<code>target.monitors</code>è¯¥æ•°ç»„ä¸¤éï¼Œç¬¬ä¸€éæ£€æŸ¥æ‰€æœ‰çš„monitorï¼Œåˆ¤æ–­å…¶æ˜¯å¦æŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœæŠ¥å‘Šäº†é”™è¯¯ï¼Œé‚£ä¹ˆéœ€è¦æ”¶é›†ä¸€ä¸ªå´©æºƒä¿¡æ¯ã€ä¸ç¡®å®šæ˜¯å¦monitorä¸€å®šä¼šæä¾›ä¸€ä¸ªå´©æºƒä¿¡æ¯ï¼Œä½†ä»¥é˜²ä¸‡ä¸€è¿˜æ˜¯è¦æ£€æŸ¥ä¸€ä¸‹ã€‘ï¼›åœ¨ç¬¬äºŒéï¼Œæˆ‘ä»¬å°è¯•ä»æœªæ£€æµ‹åˆ°å´©æºƒçš„ç›‘è§†å™¨ä¸­è·å–å´©æºƒæ¦‚è¦ä½œä¸ºè¡¥å……ä¿¡æ¯ã€‚å¦‚æœæœªæ£€æµ‹åˆ°é”™è¯¯ï¼Œåˆ™è¾“å‡ºâ€No crash detected.â€ï¼Œå¹¶è¿”å›æ˜¯å¦å´©æºƒçš„æ ‡å¿—</p></li><li><p>å¦‚æœ<code>self._reuse_target_connection</code>ï¼ˆé‡ç”¨ç›®æ ‡è¿æ¥ï¼‰ä¸ºå‡ï¼Œé‚£ä¹ˆç›´æ¥å…³é—­è¿æ¥</p></li><li><p>æœ€åè¿›è¡Œä¸‰ä¸ªæ“ä½œï¼š<code>self._process_failures()</code>ã€å¤„ç†é”™è¯¯ã€‘ã€<span id="logger_close"><code>self._fuzz_data_logger.close_test_case()</code></span>ã€å°†æ—¥å¿—å†™åˆ°æ•°æ®åº“ä¸­ã€‘å’Œ<code>self.export_file()</code>ã€å°†å¯¹è±¡å€¼å¯¼å‡ºåˆ°æœ¬åœ°ç£ç›˜/éœ€è¦è®¾ç½®<code>self.session_filename</code>ã€‘</p></li></ul></li></ul><hr><p>è¯¦è§£<code>fuzz_case_iterator</code>ï¼š</p><ul><li>æœ€å…ˆä¼ å…¥çš„æ˜¯<code>self._generate_mutations_indefinitely(max_depth=max_depth)</code> ã€é»˜è®¤ max_depth ä¸º <strong>None</strong> ã€‘</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_mutations_indefinitely</span>(<span class="hljs-params">self, max_depth=<span class="hljs-literal">None</span>, path=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations per message over all messages, with n increasing indefinitely."""</span><br>    depth = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> max_depth <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> depth &lt;= max_depth:  <span class="hljs-comment"># å½“max_depthä¸ºNoneæ—¶ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯</span><br>        valid_case_found_at_this_depth = <span class="hljs-literal">False</span>  <span class="hljs-comment"># ä¸€ä¸ªæ ‡å¿—ä½ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è¯¥æ·±åº¦æ‰¾åˆ°åˆæ³•çš„æµ‹è¯•ç”¨ä¾‹</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self._generate_n_mutations(depth=depth, path=path): <span class="hljs-comment"># è°ƒç”¨_generate_n_mutations()ç”Ÿæˆå¯è¿­ä»£æ•°æ®</span><br>            valid_case_found_at_this_depth = <span class="hljs-literal">True</span> <span class="hljs-comment"># å°†æ˜¯å¦åœ¨è¯¥æ·±åº¦æ‰¾åˆ°åˆæ³•çš„æµ‹è¯•ç”¨ä¾‹çš„æ ‡å¿—ä½è®¾ç½®ä¸º1</span><br>            <span class="hljs-keyword">yield</span> m  <span class="hljs-comment"># ç”Ÿæˆå™¨è¿”å›m</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_case_found_at_this_depth: <span class="hljs-comment"># è¡¨ç¤ºè¯¥å±‚æ²¡æœ‰ç”Ÿæˆä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œåˆ™é€€å‡ºå¾ªç¯</span><br>            <span class="hljs-keyword">break</span><br>        depth += <span class="hljs-number">1</span> <span class="hljs-comment"># æ·±åº¦++</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æ¥ç€å°±æ˜¯åˆ†æå†…å±‚ç”Ÿæˆå™¨ï¼Œi.e. <code>self._generate_n_mutations(depth=depth, path=path)</code>ï¼š</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations</span>(<span class="hljs-params">self, depth, path</span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations per message over all messages."""</span><br>    <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths(path=path):  <span class="hljs-comment"># éå†pathï¼ˆæ¶ˆæ¯ï¼‰</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path(path, depth=depth): <span class="hljs-comment"># ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œnæ¬¡å˜å¼‚</span><br>            <span class="hljs-keyword">yield</span> m<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>self._iterate_protocol_message_paths(path=path)</code>ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_iterate_protocol_message_paths</span>(<span class="hljs-params">self, path=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Iterates over protocol and yields a path (list of Connection) leading to a given message).</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        path (list of Connection): Provide a specific path to yield only that specific path.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        list of Connection: List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Raises:</span><br><span class="hljs-string">        exception.SulleyRuntimeError: If no requests defined or no targets specified</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># we can't fuzz if we don't have at least one target and one request.</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.targets:<br>        <span class="hljs-keyword">raise</span> exception.SullyRuntimeError(<span class="hljs-string">"No targets specified in session"</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.edges_from(self.root.<span class="hljs-built_in">id</span>):<br>        <span class="hljs-keyword">raise</span> exception.SullyRuntimeError(<span class="hljs-string">"No requests specified in session"</span>)<br><br>    <span class="hljs-keyword">if</span> path <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">yield</span> path<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths_recursive(this_node=self.root, path=[]):  <span class="hljs-comment"># æœ€å…³é”®çš„æ˜¯è¯¥å‡½æ•°</span><br>            <span class="hljs-keyword">yield</span> x<br></code></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°<code>self._iterate_protocol_message_paths_recursive</code>çš„ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªä»¥è¾¹æ„æˆçš„è·¯å¾„ï¼ˆè¯·æ±‚åºåˆ—ï¼‰</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_iterate_protocol_message_paths_recursive</span>(<span class="hljs-params">self, this_node, path</span>):<br>    <span class="hljs-string">"""Recursive helper for _iterate_protocol.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        this_node (node.Node): Current node that is being fuzzed.</span><br><span class="hljs-string">        path (list of Connection): List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        list of Connection: List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># step through every edge from the current node.</span><br>    <span class="hljs-keyword">for</span> edge <span class="hljs-keyword">in</span> self.edges_from(this_node.<span class="hljs-built_in">id</span>): <span class="hljs-comment"># éå†è¯·æ±‚ä¾èµ–æµå›¾ä¸­ä»¥this_node.idèµ·å§‹çš„è¾¹ï¼ˆä»rootå¼€å§‹ï¼‰</span><br>        <span class="hljs-comment"># keep track of the path as we fuzz through it, don't count the root node.</span><br>        <span class="hljs-comment"># we keep track of edges as opposed to nodes because if there is more then one path through a set of</span><br>        <span class="hljs-comment"># given nodes we don't want any ambiguity.</span><br>        path.append(edge)<br><br>        message_path = self._message_path_to_str(path)<br>        logging.debug(<span class="hljs-string">"fuzzing: {0}"</span>.<span class="hljs-built_in">format</span>(message_path))<br>        self.fuzz_node = self.nodes[path[-<span class="hljs-number">1</span>].dst] <span class="hljs-comment"># ä¸this_nodeè¿æ¥çš„è¾¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¯¥èŠ‚ç‚¹ä¸ºfuzzèŠ‚ç‚¹ï¼‰</span><br><br>        <span class="hljs-keyword">yield</span> path<br><br>        <span class="hljs-comment"># recursively fuzz the remainder of the nodes in the session graph.</span><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths_recursive(self.fuzz_node, path):<br>            <span class="hljs-keyword">yield</span> x<br><br>    <span class="hljs-comment"># finished with the last node on the path, pop it off the path stack.</span><br>    <span class="hljs-keyword">if</span> path:<br>        path.pop()<br></code></pre></td></tr></tbody></table></figure><p>ä»¥boofuzzçš„æä¾›çš„ftpè„šæœ¬<code>ftp_simple.py</code>ä¸ºä¾‹ï¼Œå…¶è¯·æ±‚ä¾èµ–æµå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=" mermaid">graph TBa((root))--&gt;b((user))--&gt;c((pass))--&gt;d((stor))c--&gt;e((retr))</code></pre><p><code>_iterate_protocol_message_paths_recursive</code>ç”Ÿæˆå™¨å°†ä¼šç”Ÿæˆpathæœ‰ï¼š<code>[user]</code>, <code>[user, pass]</code>, <code>[user, pass, stor]</code>, <code>[user, pass, retr]</code></p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>self._generate_n_mutations_for_path(path, depth=depth)</code>ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations_for_path</span>(<span class="hljs-params">self, path, depth</span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations for a specific message.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        path (list of Connection): Nodes (Requests) along the path to the current one being fuzzed.</span><br><span class="hljs-string">        depth (int): Yield sets of depth mutations.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        MutationContext: A MutationContext containing one mutation.</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-keyword">for</span> mutations <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._mutations_contain_duplicate(mutations):<br>            self.total_mutant_index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">yield</span> MutationContext(message_path=path, mutations={n.qualified_name: n <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> mutations})<br></code></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°<code>self._generate_n_mutations_for_path_recursive</code>çš„ä½œç”¨æ˜¯</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations_for_path_recursive</span>(<span class="hljs-params">self, path, depth, skip_elements=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> skip_elements <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        skip_elements = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">if</span> depth == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">yield</span> []<br>        <span class="hljs-keyword">return</span><br>    new_skip = skip_elements.copy()<br>    <span class="hljs-keyword">for</span> mutations <span class="hljs-keyword">in</span> self._generate_mutations_for_request(path=path, skip_elements=skip_elements):<br>        new_skip.update(m.qualified_name <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> mutations)<br>        <span class="hljs-keyword">for</span> ms <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth - <span class="hljs-number">1</span>, skip_elements=new_skip):<br>            <span class="hljs-keyword">yield</span> mutations + ms<br></code></pre></td></tr></tbody></table></figure><p><code>self._generate_mutations_for_request</code> â€“&gt; <code>self.fuzz_node.get_mutations</code> â€“&gt; <code>self.mutations</code> â€“&gt; <code>item.get_mutations()</code>â€“&gt;<code>mutations() [in string.py]</code>ï¼Œ</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>boofuzz/primitives/string.py</code>ä¸­å®šä¹‰äº†ä¸€äº›å­—å…¸å€¼ï¼Œå­˜æ”¾åœ¨å˜é‡<code>self._fuzz_library</code>ä¸­</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># store fuzz_library as a class variable to avoid copying the ~70MB structure across each instantiated primitive.</span><br>    <span class="hljs-comment"># Has to be sorted to avoid duplicates</span><br>    _fuzz_library = [<br>        <span class="hljs-string">"!@#$%%^#$%#$@#$%$$@#$%^^**(()"</span>,<br>        <span class="hljs-string">""</span>,  <span class="hljs-comment"># strings ripped from spike (and some others I added)</span><br>        <span class="hljs-string">"$(reboot)"</span>,<br>        <span class="hljs-string">"$;reboot"</span>,<br>        ...<br>        <span class="hljs-string">"|touch /tmp/SULLEY"</span>,  <span class="hljs-comment"># command injection.</span><br>        <span class="hljs-string">"||reboot;"</span>,<br>        <span class="hljs-string">"||reboot|"</span>,<br>    ]<br></code></pre></td></tr></tbody></table></figure><p>è¯¥è°ƒç”¨é“¾æ¯æ¬¡ä¼šæ„é€ ä¸€ä¸ªå˜å¼‚ç±»ï¼Œç„¶ååœ¨<code>_main_fuzz_loop</code>æ¨¡ç³Šæµ‹è¯•å¤§å¾ªç¯ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_main_fuzz_loop</span>(<span class="hljs-params">self, fuzz_case_iterator</span>):<br>...<br>            <span class="hljs-keyword">for</span> mutation_context <span class="hljs-keyword">in</span> fuzz_case_iterator:  <span class="hljs-comment"># fuzz_case_iterator --&gt; å˜å¼‚äº§ç”Ÿè¿­ä»£å™¨</span><br>            ...<br></code></pre></td></tr></tbody></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç®€å•æ¥è¯´ï¼Œboofuzzæ€»ä½“æµç¨‹æ˜¯ï¼š1. <strong>éå†è¯·æ±‚åºåˆ—æµå›¾ï¼ˆæ ‘ï¼‰å¹¶æ„é€ åºåˆ—</strong>ï¼›2. <strong>äº§ç”Ÿå˜å¼‚æ•°æ®</strong>ï¼›3. <strong>å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨</strong></p><p>boofuzzæ•´ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>åè®®fuzz</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GraphFuzzæºç è§£æ</title>
    <link href="/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="GraphFuzzæºç è§£æ"><a href="#GraphFuzzæºç è§£æ" class="headerlink" title="GraphFuzzæºç è§£æ"></a>GraphFuzzæºç è§£æ</h1><ul><li>æ ¸å¿ƒä»£ç ä½äº<code>core</code>ç›®å½•ä¸‹<ul><li><code>graph.hpp</code>ä¸ºå›¾ç»“æ„ä½“å¤´æ–‡ä»¶ï¼Œä¸»è¦åŒ…å«ä¸€ä¸ªç»“æ„ä½“<code>NodeLink</code>å’Œä¸€ä¸ªç±»<code>TGraph</code></li><li><code>schema.hpp</code>å£°æ˜äº†ä¸€ä¸ªç±»<code>Schema</code>ï¼ŒåŒæ—¶åŒ…å«<code>ScopeDef</code>ã€<code>Signature</code>ï¼Œ<code>hash</code>ï¼Œ<code>ScopeTree</code>å’Œ<code>TypeTree</code>è¿™äº”ä¸ªç»“æ„ä½“</li><li><code>harness.cpp</code>ä¸ºç”Ÿæˆçš„<code>harness</code>æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è°ƒç”¨<code>libfuzzer</code>çš„æ¥å£æ¥å®ç°ç›¸å…³åŠŸèƒ½</li></ul></li></ul><h2 id="harness-cpp"><a href="#harness-cpp" class="headerlink" title="harness.cpp"></a>harness.cpp</h2><ul><li><p><code>LLVMFuzzerInitialize()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºè¿›è¡Œæ¨¡ç³Šæµ‹è¯•å‰çš„åˆå§‹åŒ–æ“ä½œï¼š</p><ul><li>forå¾ªç¯ä½“å†…å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; *argc; ++i) {<br>    <span class="hljs-comment">// do something to parse cmd line</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>å…±æœ‰14ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ï¼š</p><table><thead><tr><th>æ”¯æŒçš„å‘½ä»¤è¡Œé€‰é¡¹</th><th>æè¿°</th></tr></thead><tbody><tr><td>â€“graphfuzz_debug</td><td>æ˜¯å¦å¯ç”¨debug</td></tr><tr><td>â€“graphfuzz_skip_validation</td><td>æ˜¯å¦è·³è¿‡æœ‰æ•ˆæ€§éªŒè¯</td></tr><tr><td>â€“graphfuzz_prune_cache</td><td>æ˜¯å¦ç²¾ç®€ç¼“å­˜</td></tr><tr><td>â€“graphfuzz_enable_soft_execution</td><td>æ˜¯å¦å¯ç”¨è½¯æ‰§è¡Œï¼ˆæœ‰ç‚¹ç±»ä¼¼äºforkserverï¼‰</td></tr><tr><td>â€“graphfuzz_ignore_invalid</td><td>æ˜¯å¦å¿½ç•¥æ— æ•ˆçš„æ¨¡å¼ï¼ˆé»˜è®¤falseï¼‰</td></tr><tr><td>â€“graphfuzz_trace_mutations</td><td>æ˜¯å¦è·Ÿè¸ªå˜å¼‚ï¼Œå¦‚æœå¯ç”¨ï¼Œåˆ™ä¼šä¿å­˜ç›¸å…³æ—¥å¿—</td></tr><tr><td>â€“graphfuzz_catch=</td><td>æ•è·é‚£äº›å¼‚å¸¸ä¿¡å·ï¼Œå€¼ä¸ºè‹¥å¹²ä¸ªä¿¡å·ç¼–å·ï¼Œç”¨é€—å·éš”å¼€</td></tr><tr><td>â€“graphfuzz_scope_max_depth=</td><td>è®¾ç½®æœ€å¤§scope_max_depthï¼Œé»˜è®¤å€¼ä¸º10</td></tr><tr><td>â€“graphfuzz_context_mutation_prob=</td><td>å¯¹ä¸Šä¸‹æ–‡å˜é‡è¿›è¡Œå˜å¼‚çš„æ¦‚ç‡ï¼Œé»˜è®¤ä¸º0.95</td></tr><tr><td>â€“graphfuzz_max_nodes=</td><td>æ¯ä¸ªå›¾æœ€å¤§èŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º200</td></tr><tr><td>â€“graphfuzz_schema=</td><td>æ¨¡å¼æ–‡ä»¶é‡å‘½åï¼Œé»˜è®¤ä¸ºâ€schema.jsonâ€</td></tr><tr><td>â€“graphfuzz_mutate_one</td><td>â€“graphfuzz_mutate_one &lt;seed&gt; &lt;input&gt; &lt;output&gt;<br>åœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹ç§å­è¿›è¡Œä¸€æ¬¡å˜å¼‚</td></tr><tr><td>â€“graphfuzz_init_corpus</td><td>â€“graphfuzz_init_corpus &lt;corpus&gt;<br>åˆå§‹åŒ–ç§å­</td></tr></tbody></table><ul><li><p><code>Schema::FromFile()</code>ä»<code>schema.json</code>ä¸­è¯»å–æ¨¡å¼æ–‡ä»¶å¹¶ä¿å­˜åˆ°<code>Schema *global_schema</code>å˜é‡ä¸­</p></li><li><p>è°ƒç”¨<code>Schema::Validate()</code>å‡½æ•°æ¥éªŒè¯<code>schema</code>æ˜¯å¦æœ‰æ•ˆï¼Œä¸»è¦æ£€æŸ¥æ¯ä¸ªç±»æ˜¯å¦åŒ…å«æ„é€ æˆ–ææ„å‡½æ•°</p></li><li><p><code>register_signals()</code>ï¼šæ³¨å†Œä¿¡å·ï¼Œä¸»è¦ä¸º <code>graphfuzz_catch</code> å˜é‡æŒ‡å®šçš„éœ€è¦æ•è·çš„ä¿¡å·æ·»åŠ å¥æŸ„å‡½æ•°<code>sig_handler</code>ï¼Œè¯¥å‡½æ•°ä½¿ç”¨<code>siglongjmp()</code>å‡½æ•°è®©ç¨‹åº<strong>è·³è½¬åˆ°å…ˆå‰é…ç½®çš„è·³è½¬ç‚¹</strong></p></li><li><p>å¯¹ç§å­/è¯­æ–™åº“è¿›è¡Œå˜å¼‚æˆ–åˆå§‹åŒ–æ“ä½œï¼ˆäºŒé€‰ä¸€ï¼‰</p></li><li><p><code>global_init(orig_argc, orig_argv)</code>æ‰§è¡Œ<code>fuzz_exec.cpp</code>å®šä¹‰çš„ç›¸å…³æ–¹æ³•ï¼Œç”¨äºå¯¹å‚æ•°è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç©º</p></li></ul></li></ul><hr><ul><li><code>MutateOne()</code>ï¼š<ul><li>è°ƒç”¨<code>LLVMFuzzerCustomMutator()</code>å¯¹ç§å­è¿›è¡Œå˜å¼‚ï¼Œç„¶åå°†å˜å¼‚åçš„ä¿¡æ¯ä¿å­˜åˆ°<code>--graphfuzz_mutate_one</code>æŒ‡å®šçš„outputä¸­</li></ul></li></ul><hr><ul><li><p><code>LLVMFuzzerCustomMutator()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºè¿›è¡Œè‡ªå®šä¹‰çš„å˜å¼‚ï¼š</p><ul><li><p>é¦–å…ˆæ ¹æ®æ¨¡å¼æ„å»º<code>TGraph</code>å˜é‡gï¼Œç„¶ågè¯»å…¥ç§å­æ•°æ®å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§</p><ul><li>å¦‚æœè¯»å…¥å¤±è´¥æˆ–æ— æ³•é€šè¿‡æœ‰æ•ˆæ€§éªŒè¯ï¼Œåˆ™æ ¹æ®ç§å­é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å›¾</li><li>å¦åˆ™ï¼Œåˆ™è°ƒç”¨<code>TGraph::Mutate</code>æ–¹æ³•è¿›è¡Œå›¾å˜å¼‚ï¼ˆåé€‰ä¸€ï¼‰</li></ul></li><li><p>å°†ç”Ÿæˆçš„å›¾åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å˜å¼‚åçš„æ•°æ®æ›´æ–°å›ç¼“å†²åŒº</p></li></ul></li></ul><hr><ul><li><p><code>LLVMFuzzerCustomCrossOver()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºä¸¤ä¸ªç§å­ä¹‹é—´è‡ªå®šä¹‰äº¤å‰å˜å¼‚</p></li></ul><hr><ul><li><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>LLVMFuzzerTestOneInput()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œä¸º<code>libfuzzer</code>ä¸»æ¨¡ç³Šæµ‹è¯•æ¨¡å—ï¼Œç”¨äºå°†ç”Ÿæˆçš„æ•°æ®æŠ•å–‚ç»™ç›®æ ‡</p><ul><li><p><code>sigsetjmp()</code>å‡½æ•°åœ¨<code>LLVMFuzzerTestOneInput()</code>èµ·å§‹å¤„è®¾ç½®è·³è½¬ç‚¹</p></li><li><p>è°ƒç”¨<code>shim_init()</code>å‡½æ•°ï¼Œç¡®ä¿å·²ç»è·å¾—è¦†ç›–ä¿¡æ¯</p></li><li><p>æ„å»ºä¸€ä¸ª<code>TGraph</code>ï¼ˆæ¨¡æ¿å›¾ï¼‰çš„å˜é‡gï¼Œç„¶åè¯»å…¥ç”Ÿæˆçš„æ•°æ®ï¼ˆæ˜¯å¦æˆåŠŸè¯»å…¥ï¼‰ï¼Œå¹¶æ£€éªŒå…¶åˆæ³•æ€§ï¼ˆæ˜¯å¦æœ‰æ„é€ å’Œææ„ï¼‰</p></li><li><p>è°ƒç”¨<code>TGraph</code>ç±»çš„<code>GetOrderedNodes()</code>æ–¹æ³•å¾—åˆ°layeré€’å¢çš„èŠ‚ç‚¹åºåˆ—ï¼Œç„¶åéå†æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> *ref[nodes.<span class="hljs-built_in">size</span>()][MAX_CONN]; <span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ªäºŒç»´æŒ‡é’ˆæ•°ç»„</span><br></code></pre></td></tr></tbody></table></figure><ul><li>é¦–å…ˆè½½å…¥è¾“å…¥ï¼Œå…·ä½“æ¥è¯´ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> *in_ref[n.<span class="hljs-built_in">in_ref_size</span>()];<br><span class="hljs-comment">// ...</span><br>in_ref[i] = ref[n.<span class="hljs-built_in">index</span>()][i]; <span class="hljs-comment">// å°†æŒ‡é’ˆå€¼èµ‹å€¼ç»™in_ref[i]ï¼Œæ˜¾ç„¶é»˜è®¤ä¸º0</span><br></code></pre></td></tr></tbody></table></figure><ul><li>ç„¶åè°ƒç”¨å‡½æ•°ç«¯ç‚¹ï¼Œ</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">void</span> (*func)(<span class="hljs-type">void</span> **, <span class="hljs-type">void</span> **, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = FUZZER_SHIMS[n.<span class="hljs-built_in">type</span>()];<br><span class="hljs-built_in">func</span>(in_ref, out_ref, context); <span class="hljs-comment">// å°†in_ref, out_refå’ŒcontextæŠ•å–‚ç»™ç«¯ç‚¹</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æœ€åï¼Œå°†è¾“å‡ºæ‹·è´åˆ°ç»“æœä¸­ï¼ˆæ³¨ï¼šç»“æœåœ¨å‡½æ•°ç«¯ç‚¹è°ƒç”¨æ—¶å·²ç»å†™åˆ°out_refä¸­ï¼‰ï¼Œ</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n.<span class="hljs-built_in">out_ref_size</span>(); ++i) {<br>    NodeRef r = n.<span class="hljs-built_in">out_ref</span>(i);<br>    ref[r.<span class="hljs-built_in">node_idx</span>()][r.<span class="hljs-built_in">conn_idx</span>()] = out_ref[i]; <span class="hljs-comment">// å¦‚æœå½“å‰è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªè¿æ¥èŠ‚ç‚¹çš„è¾“å…¥ï¼Œé‚£ä¹ˆæ›´æ–°refæ•°ç»„</span><br>    <span class="hljs-keyword">if</span> (graphfuzz_debug) {<br>        cout &lt;&lt; <span class="hljs-string">"Got output: "</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">" :: "</span> &lt;&lt; out_ref[i] &lt;&lt; endl;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/o5.png"></p></li><li><p>è°ƒç”¨<code>shim_finalize()</code></p></li></ul></li></ul><hr><ul><li><code>graphfuzz_try()</code>ï¼š<ul><li>ç”¨äºå®ç°è½¯æ‰§è¡Œï¼Œåœ¨ä¸»æ¨¡ç³Šæµ‹è¯•æµç¨‹ä¸­æœªä½¿ç”¨</li></ul></li></ul><h2 id="graph-hpp"><a href="#graph-hpp" class="headerlink" title="graph.hpp"></a>graph.hpp</h2><ul><li>è¯¥å¤´æ–‡ä»¶å®šä¹‰äº†ä¸€äº›å›¾ç›¸å…³çš„ç»“æ„ä½“å’Œæ–¹æ³•ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯<code>Mutate()</code>æ–¹æ³•</li></ul><hr><ul><li><p><code>Mutate()</code>ï¼š</p><p>è°ƒç”¨é“¾<span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> â€“ <strong>harness.cpp</strong>ï¼š<code>MutateOne()</code> $\rightarrow$ <code>LLVMFuzzerCustomMutator()</code> $\rightarrow$ <code>TGraph::Mutate()</code></p><p>åˆ†ä¸ºä¸¤ç±»å˜å¼‚ï¼š</p><ul><li>ä¸Šä¸‹æ–‡å˜å¼‚<code>MutateContext()</code>ã€æ¦‚ç‡ï¼šé»˜è®¤ä¸º0.95ã€‘</li><li>åŸºäºå›¾å˜å¼‚ï¼ˆä¹é€‰ä¸€ï¼‰ã€å…·ä½“è¯¦è§è®ºæ–‡ã€‘ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">switch</span> (mut_choice) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-built_in">MutateCrosslink</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-built_in">MutateTruncateDestructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-built_in">MutateTruncateConstructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-built_in">MutateLayerIndex</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-built_in">MutateSwapEquivalent</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-built_in">MutateExtendDestructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: <span class="hljs-built_in">MutateExtendConstructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: <span class="hljs-built_in">MutateSpliceIn</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>: <span class="hljs-built_in">MutateSpliceOut</span>(); <span class="hljs-keyword">break</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å­˜åœ¨é—®é¢˜ï¼šå˜å¼‚æ–¹æ³•è°ƒåº¦ä»…ä½¿ç”¨æ¦‚ç‡ï¼Œå¯èƒ½å­˜åœ¨æŸç§harnessåºåˆ—ä¸Šä¸‹æ–‡è¿‡åº¦å˜å¼‚ã€åŒæ—¶å¯èƒ½ä¼šå¯¼è‡´å›¾å˜å¼‚é¥¿æ­»ã€‘æˆ–è€…ä¸Šä¸‹æ–‡å˜å¼‚ä¸è¶³ã€å¯¼è‡´bugé—æ¼ï¼Œå¯èƒ½ä¼šåœ¨åé¢å›¾å˜å¼‚ç”Ÿæˆç›¸åŒçš„å˜å¼‚æ¨¡å¼ï¼ˆæˆ–ç±»ä¼¼çš„å˜å¼‚æ¨¡å¼ï¼Ÿï¼‰ã€‘</p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFL++æºç æµ…æ</title>
    <link href="/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/"/>
    <url>/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-æºç è§£æ"><a href="#AFL-æºç è§£æ" class="headerlink" title="AFL++æºç è§£æ"></a>AFL++æºç è§£æ</h1><h2 id="afl-fuzz-c"><a href="#afl-fuzz-c" class="headerlink" title="afl-fuzz.c"></a>afl-fuzz.c</h2><h3 id="mainå‡½æ•°"><a href="#mainå‡½æ•°" class="headerlink" title="mainå‡½æ•°"></a><strong>mainå‡½æ•°</strong></h3><ul><li><code>rand_set_seed()</code>è®¾ç½®å››ä¸ªç§å­ï¼šafl-&gt;init_seed, afl-&gt;rand_seed[0-2]</li><li>whileå¾ªç¯å¯¹é€‰é¡¹è¿›è¡Œåˆ¤æ–­ï¼Œæ”¯æŒçš„é€‰é¡¹æœ‰ï¼š<code>"+Ab:B:c:CdDe:E:hi:I:f:F:g:G:l:L:m:M:nNOo:p:RQs:S:t:T:UV:WXx:YZ"</code>ï¼š</li></ul><table><thead><tr><th>é€‰é¡¹</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>-i dir</code></td><td>æµ‹è¯•ç”¨ä¾‹è¾“å…¥ç›®å½•</td></tr><tr><td><code>-o dir</code></td><td>æ¨¡ç³Šæµ‹è¯•å‘ç°çš„è¾“å‡ºç›®å½•</td></tr><tr><td><code>-p schedule</code></td><td>èƒ½é‡è°ƒåº¦è®¡ç®—ä¸€ä¸ªç§å­è¡¨ç°åˆ†æ•°ï¼šfastï¼ˆé»˜è®¤ï¼‰ï¼Œexploreï¼Œexploitï¼Œseekï¼Œrareï¼Œmmoptï¼Œcoeï¼Œlinï¼Œquad</td></tr><tr><td><code>-f file</code></td><td>ç›®æ ‡ç¨‹åºè¯»å…¥æ•°æ®çš„ä½ç½®ï¼ˆé»˜è®¤ï¼šstdin æˆ– @@ï¼‰</td></tr><tr><td><code>-t msec</code></td><td>æ¯è½®çš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 1000 msï¼‰ï¼Œæ·»åŠ â€™+â€™æ¥è‡ªåŠ¨è®¡ç®—è¶…æ—¶æ—¶é—´</td></tr><tr><td><code>-m megs</code></td><td>å­è¿›ç¨‹å†…å­˜é™åˆ¶ï¼ˆ0 MBï¼Œ0=æ— é™åˆ¶ [é»˜è®¤]ï¼‰</td></tr><tr><td><code>-A</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆARM CoreSight modeï¼‰</td></tr><tr><td><code>-O</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆFRIDA modeï¼‰</td></tr><tr><td><code>-Q</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆQEMU modeï¼‰</td></tr><tr><td><code>-U</code></td><td>ä½¿ç”¨åŸºäºunicornçš„æ’æ¡©ï¼ˆUnicorn modeï¼‰</td></tr><tr><td><code>-W</code></td><td>ä½¿ç”¨åŸºäºqemuçš„Wineæ’æ¡©ï¼ˆWine modeï¼‰</td></tr><tr><td><code>-X</code></td><td>ä½¿ç”¨VMæ¨¡ç³Šæµ‹è¯•ï¼ˆNYX mode - standalone modeï¼‰</td></tr><tr><td><code>-Y</code></td><td>ä½¿ç”¨VMæ¨¡ç³Šæµ‹è¯•ï¼ˆNYX mode - multiple instances modeï¼‰</td></tr><tr><td><code>-g minlength</code></td><td>è®¾ç½®ç”Ÿæˆæ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„æœ€å°é•¿åº¦ï¼ˆé»˜è®¤1ï¼‰</td></tr><tr><td><code>-G maxlength</code></td><td>è®¾ç½®ç”Ÿæˆæ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤ 1*1024*1024ï¼‰</td></tr><tr><td><code>-D</code></td><td>å¯ç”¨ç¡®å®šæ€§æ¨¡ç³Šæµ‹è¯•ï¼ˆä¸€ä¸ªé˜Ÿåˆ—ä»…è¿›è¡Œä¸€æ¬¡ï¼‰</td></tr><tr><td><span id="-L"><code>-L minutes</code></span></td><td>ä½¿ç”¨MOptï¼ˆimizeï¼‰æ¨¡å¼å¹¶è®¾ç½®è¿›å…¥pacemakeræ¨¡å¼çš„æ—¶é—´é™åˆ¶ï¼ˆæ— æ–°å‘ç°çš„æ—¶é—´ï¼‰ï¼Œ0=ç«‹å³ï¼Œ-1=ç«‹å³å¹¶è¿›è¡Œæ­£å¸¸å˜å¼‚</td></tr><tr><td><code>-c program</code></td><td>æŒ‡å®šä¸€ä¸ªç¼–è¯‘çš„äºŒè¿›åˆ¶æ¥å¯ç”¨CmpLogã€‚å¦‚æœä½¿ç”¨QEMU/FRIDAæˆ–æ¨¡ç³Šæµ‹è¯•ç›®æ ‡å·²ä½¿ç”¨CmpLogç¼–è¯‘ï¼Œé‚£ä¹ˆä½¿ç”¨<code>-c 0</code>.</td></tr><tr><td><code>-l cmplog_opts</code></td><td>CmpLogé…ç½®å€¼ï¼ˆå¦‚â€œ2ATâ€ï¼‰ï¼š1=å°æ–‡ä»¶ï¼Œ 2=å¤§æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰ï¼Œ3=æ‰€æœ‰æ–‡ä»¶ï¼ŒA=ç®—æ³•æ±‚è§£ï¼ŒT=transformationalæ±‚è§£</td></tr><tr><td><code>-Z</code></td><td>åºåˆ—é˜Ÿåˆ—é€‰æ‹©ï¼Œè€Œä¸æ˜¯éšæœºæƒé‡</td></tr><tr><td><code>-N</code></td><td>ä¸è§£é™¤æ¨¡ç³Šæµ‹è¯•æ–‡ä»¶çš„é“¾æ¥</td></tr><tr><td><code>-n</code></td><td>æ— æ’æ¡©æ¨¡ç³Šæµ‹è¯•ï¼ˆnon-instrumented modeï¼‰</td></tr><tr><td><code>-x dict_file</code></td><td>æ¨¡ç³Šå™¨å­—å…¸</td></tr><tr><td><code>-s seed</code></td><td>ä¸ºRNGä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ç§å­</td></tr><tr><td><code>-V seconds</code></td><td>æ¨¡ç³Šæµ‹è¯•ç‰¹å®šçš„æ—¶é—´ä¹‹åç»“æŸ</td></tr><tr><td><code>-E execs</code></td><td>æ‰§è¡Œä¸€ä¸ªè¿‘ä¼¼å¤šå°‘æ¬¡æ‰§è¡Œåç»ˆæ­¢æ¨¡ç³Šæµ‹è¯•</td></tr><tr><td><code>-M/-S id</code></td><td>åˆ†å¸ƒå¼æ¨¡å¼ï¼Œ-M auto-sets -Dï¼Œ-Zï¼ˆä½¿ç”¨-dç¦ç”¨-Dï¼‰å¹¶ä¸è¿›è¡Œtrimming</td></tr><tr><td><code>-F path</code></td><td>åŒæ­¥åˆ°ä¸€ä¸ªå¤–éƒ¨æ¨¡ç³Šå™¨é˜Ÿåˆ—ç›®å½•ï¼ˆéœ€è¦-Mï¼Œæœ€å¤šå¯ä»¥æŒ‡å®š32æ¬¡ï¼‰</td></tr><tr><td><code>-T text</code></td><td>åœ¨å±å¹•ä¸Šå±•ç¤ºtext banner</td></tr><tr><td><code>-I command</code></td><td>å½“ä¸€ä¸ªæ–°çš„crashå‘ç°æ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªç‰¹å®šçš„å‘½ä»¤æˆ–è„šæœ¬</td></tr><tr><td><code>-C</code></td><td>crashæ¢ç´¢æ¨¡å¼</td></tr><tr><td><code>-b cpu_id</code></td><td>å°†æ¨¡ç³Šæµ‹è¯•è¿›ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„CPUæ ¸å¿ƒä¸Šï¼ˆ0-â€¦ï¼‰</td></tr><tr><td><code>-e ext</code></td><td>æ¨¡ç³Šæµ‹è¯•è¾“å…¥æ–‡ä»¶çš„æ–‡ä»¶æ‰©å±•ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰</td></tr><tr><td><code>-h</code></td><td>å±•ç¤ºé€‰é¡¹ä¿¡æ¯</td></tr></tbody></table><ul><li><code>setup_signal_handlers()</code>è®¾ç½®ä¿¡å·å¥æŸ„</li><li><code>check_asan_opts()</code>æ£€æŸ¥asané€‰é¡¹ï¼šè·å–ç¯å¢ƒå˜é‡<code>ASAN_OPTIONS</code>å¹¶æ£€æŸ¥ç›¸å…³é€‰é¡¹è®¾ç½®æ˜¯å¦æ­£ç¡®</li><li>afl-&gt;scheduleè®°å½•äº†aflèƒ½é‡è°ƒåº¦æ¨¡å¼ï¼Œé»˜è®¤ä¸ºfastï¼›å¦‚æœafl-scheduleåŸºäºfastå®ç°ï¼Œåˆ™éœ€è¦ä¸ºå…¶åŠ¨æ€åˆ†é…å†…å­˜ç”¨äºè®°å½•AFLFastè°ƒåº¦ä¿¡æ¯</li><li><code>check_crash_handling()</code>ç¡®ä¿æ ¸å¿ƒè½¬å‚¨ä¸ä¼šè¿›å…¥ä¸€ä¸ªç¨‹åºä¸­ã€‚</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">echo</span> core &gt;/proc/sys/kernel/core_pattern<br></code></pre></td></tr></tbody></table></figure><ul><li><p><code>check_cpu_governor()</code>ï¼šæ£€æŸ¥CPU governorï¼Œä¸»è¦æ£€æŸ¥linuxå†…æ ¸CPUè°ƒé¢‘æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚</p></li><li><p><code>save_cmdline()</code>ï¼šå°†å‘½ä»¤è¡Œä¿å­˜åˆ°afl-&gt;orig_cmdlineå˜é‡ä¸­</p></li><li><p><code>check_if_tty</code>ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ttyã€‚å…·ä½“é€šè¿‡<code>ioctl(1, TIOCGWINSZ, &amp;ws)</code>è·å–ç»ˆç«¯ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦ä¸ºttyç»ˆç«¯</p></li><li><p><code>get_core_count()</code>ï¼šè·å–CPUæ ¸å¿ƒæ•°</p></li><li><p><code>setup_dirs_fds()</code>ï¼šåˆ›å»ºç›¸å…³æ–‡ä»¶æè¿°ç¬¦</p></li><li><p><code>bind_to_free_cpu()</code>ï¼šæ„å»ºç»‘å®šåˆ°æ ¸å¿ƒçš„è¿›ç¨‹åˆ—è¡¨</p></li><li><p><code>init_count_class16()</code>ï¼šç”±count_class_lookup8æ¡¶æ„é€ count_class_lookup16æ•°ç»„</p></li><li><p><code>setup_custom_mutators()</code>ï¼šè®¾ç½®ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨ï¼Œè¯¦è§<a href="./AFL++%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8.md">AFL++è‡ªå®šä¹‰å˜å¼‚å™¨</a></p></li><li><p><code>setup_cmdline_file()</code>ï¼šå°†å‘½ä»¤è¡Œä¿å­˜åˆ°default/cmdlineæ–‡ä»¶ä¸­</p></li><li><p><code>read_testcases()</code>ï¼šä»è¾“å…¥ç›®å½•ä¸­è¯»å–æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œç„¶åå°†å…¶æ”¾ç½®åœ¨é˜Ÿåˆ—ä¸­</p></li><li><p><code>pivot_inputs()</code>ï¼šä¸ºè¾“å‡ºç›®å½•çš„è¾“å…¥æµ‹è¯•ç”¨ä¾‹åˆ›å»ºç¡¬é“¾æ¥ï¼Œé€‰æ‹©ä¸€ä¸ªå¥½çš„åå­—å¹¶å°†å…¶è½¬ç§»åˆ°æ–°é˜Ÿåˆ—å®ä½“ä¸­</p></li><li><p><code>setup_stdio_file()</code>ï¼šä¸ºæ¨¡ç³Šæµ‹è¯•æ•°æ®åˆ›å»ºè¾“å…¥æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºdefault/.cur_inputï¼Œå¦‚æœåŒ…å«æ‰©å±•åï¼Œåˆ™ä¸ºdefault/.cur_input.(æ‰©å±•å)</p></li><li><p><code>check_binary()</code>ï¼šå¯¹PATHè·¯å¾„è¿›è¡Œæœç´¢æ¥å¯»æ‰¾ç›®æ ‡äºŒè¿›åˆ¶ï¼ŒåŒæ—¶ç¡®ä¿å…¶ä¸æ˜¯ä¸€ä¸ªshellè„šæœ¬ï¼ŒåŒæ—¶æ£€æŸ¥å…¶æ˜¯å¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ELFå¤´å¹¶åˆ¤æ–­æ˜¯å¦è¿›è¡Œäº†æ’æ¡©ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡<code>__AFL_SHM_ID</code>è¿›è¡Œåˆ¤æ–­ï¼‰ã€‚æ­¤å¤–ï¼Œè¯¥å‡½æ•°è¿˜æ£€æŸ¥ä¸€äº›ç¯å¢ƒå˜é‡å¹¶è®¾ç½®ç›¸å…³å‚æ•°</p></li><li><p><code>setup_testcase_shmem()</code>ï¼šè®¾ç½®æ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„å…±äº«å†…å­˜ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡<code>__AFL_SHM_FUZZ_ID</code>ä¼ é€’ç»™forkserver</p></li><li><p><code>load_auto()</code>ï¼šè‡ªåŠ¨è½½å…¥ç”Ÿæˆçš„extras</p></li><li><p><code>deunicode_extras()</code>ï¼šæœ‰æ—¶å€™extrasä¸­çš„å­—ç¬¦ä¸²åœ¨å†…éƒ¨è½¬åŒ–ä¸ºunicodeç ï¼Œå› æ­¤æ¨¡ç³Šæµ‹è¯•æ—¶éœ€è¦å°†çœ‹èµ·æ¥åƒunicodeçš„å­—ç¬¦ä¸²è¿›è¡Œunicodeè§£ç æ“ä½œ</p></li><li><p><code>dedup_extras()</code>ï¼šä»è½½å…¥çš„extrasä¸­åˆ é™¤é‡å¤ï¼ˆåœ¨å¤šä¸ªæ–‡ä»¶è½½å…¥æ—¶å¯èƒ½ä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ï¼‰</p></li><li><p>å°†<code>virgin_bits</code>ã€<code>virgin_tmout</code>å’Œ<code>virgin_tmout</code>æ•°ç»„çš„æ¯”ç‰¹å…¨éƒ¨è®¾ç½®ä¸º1</p></li><li><p><code>perform_dry_run()</code>ï¼šå¯¹æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é¢„è¿è¡Œä»¥ç¡®ä¿ç¨‹åºæŒ‰æœŸæœ›é‚£æ ·è¿è¡Œã€‚è¯¥æ“ä½œä»…åœ¨åˆå§‹è¾“å…¥é˜¶æ®µå®Œæˆå¹¶åªæ‰§è¡Œä¸€æ¬¡</p></li><li><p><span id="cullqueue"><code>cull_queue()</code>ï¼šç²¾ç®€é˜Ÿåˆ—ã€è´ªå¿ƒç®—æ³•ã€‘ï¼Œé€šè¿‡éå†top_rated[]ä¸­çš„queueå®ä½“ï¼Œæå–å‡ºèƒ½å¤Ÿå‘ç°æ–°è¾¹çš„å®ä½“ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸º<code>favored</code>ã€‚åœ¨ä¸‹æ¬¡éå†é˜Ÿåˆ—æ—¶ï¼Œè¿™äº›<code>favored</code>å®ä½“èƒ½å¤Ÿè·å¾—æ›´å¤šæ‰§è¡Œæ¨¡ç³Šæµ‹è¯•çš„æœºä¼šã€‚</span></p></li><li><p><code>show_init_stats()</code>ï¼šæ‰“å°å‡ºåˆå§‹çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></li></ul><p><img src="/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/3.png"></p><ul><li><code>save_auto()</code>ï¼šè‡ªåŠ¨ä¿å­˜ç”Ÿæˆçš„extras</li></ul><hr><h3 id="æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯"><a href="#æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯" class="headerlink" title="æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯"></a>æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// main fuzzy loop</span><br><span class="hljs-keyword">while</span> (<span class="hljs-built_in">likely</span>(!afl-&gt;stop_soon)) {<br><span class="hljs-comment">// fuzzing stage</span><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p><a href="#cullqueue"><code>cull_queue()</code></a></p></li><li><p><code>afl-&gt;cycle_schedules</code>ä¸ºå‘¨æœŸæ›´æ¢è°ƒåº¦ç®—æ³•çš„æ ‡å¿—ï¼Œæ›´æ¢è°ƒåº¦ç®—æ³•åï¼Œéœ€è¦é‡æ–°è®¡ç®—é˜Ÿåˆ—æ‰€æœ‰å®ä½“çš„åˆ†æ•°</p></li><li><p><code>runs_in_current_cycle</code>ä¸ºè¡¨ç¤ºå½“å‰å¾ªç¯çš„å˜é‡</p></li><li><p><code>create_alias_table()</code>ï¼šåˆ›å»ºåˆ«åè¡¨ï¼Œå…è®¸æƒé‡éšæœºé€‰æ‹©ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰</p><ul><li><code>static inline void *afl_realloc(void **buf, size_t size_needed)</code>ï¼š<ul><li>è¯¥å‡½æ•°ä¸ºreallocçš„ä¸€ä¸ªwrapperï¼Œå…¶ä¸»è¦æ˜¯ç¡®ä¿åœ¨è°ƒç”¨è¯¥å‡½æ•°åï¼Œbufçš„çœŸå®å¤§å°å§‹ç»ˆ &gt; size_neededï¼Œ<strong>é¿å…é¢‘ç¹è°ƒç”¨realloc</strong>ã€‚è¯¥buf sizeä½¿ç”¨<strong>æŒ‡æ•°å¢é•¿</strong>ã€‚</li></ul></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">afl_alloc_buf</span> {<br>  <span class="hljs-comment">/* The complete allocated size, including the header of len</span><br><span class="hljs-comment">   * AFL_ALLOC_SIZE_OFFSET */</span><br>  <span class="hljs-type">size_t</span> complete_size;<br>  <span class="hljs-comment">/* ptr to the first element of the actual buffer */</span><br>  u8 buf[<span class="hljs-number">0</span>];<br><br>};<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl-&gt;alias_table</code>ã€<code>afl-&gt;alias_probability</code>ä¸º<code>struct afl_alloc_buf</code>å‹æŒ‡é’ˆï¼Œåˆ†åˆ«è¡¨ç¤ºåˆ«åè¡¨å’Œç›¸åº”çš„æ¦‚ç‡</li><li>æ¥ä¸‹æ¥è¿›è¡Œä¸€ç³»åˆ—çš„æ¦‚ç‡è®¡ç®—ï¼Œå…¶ç»“æœæ›´æ–°åˆ°<code>afl-&gt;alias_probability</code>ä¸­</li></ul></li><li><p><code>select_next_queue_entry()</code>ï¼šåŸºäºåˆ«åé‡‡æ ·ç®—æ³•é€‰æ‹©ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å®ä½“</p></li></ul><h4 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one()"></a>fuzz_one()</h4><ul><li><p>è¯¥fuzz_one()å‡½æ•°ä½äº<code>afl-fuzz-one.c</code>ä¸­ï¼Œè¯¥å‡½æ•°å®é™…ä¸Šä¸ºä¸€ä¸ªwrapperï¼Œæ—¨åœ¨å®ç°MOPTã€‚åŸå§‹çš„<code>fuzz_one()</code>å‡½æ•°è¢«é‡å‘½åä¸º<code>fuzz_one_original()</code></p></li><li><p>è¿™é‡Œä½¿ç”¨<code>afl-&gt;limit_time_sig</code>å‚æ•°å€¼è¿›è¡Œ<code>fuzz_one()</code>å‡½æ•°çš„åˆ†æµï¼š</p><ul><li><code>afl-&gt;limit_time_sig</code>ç”±<a href="#-L">-Lå‚æ•°</a>ç¡®å®šï¼Œ-Lå‚æ•°çš„<code>minute</code>ä¼ é€’ç»™<code>afl-&gt;limit_time_puppet</code>ï¼Œè¯¥å€¼ä»…èƒ½æ˜¯0åˆ°2000000 æˆ– -1</li><li><code>afl-&gt;limit_time_puppet == -1</code> <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>afl-&gt;limit_time_sig = -1</code> &amp;&amp; <code>afl-&gt;limit_time_sig = 0</code>ï¼›å¦åˆ™ <code>afl-&gt;limit_time_sig = 1</code></li></ul><hr><ul><li><pre><code class="c++">/* ä¼ªä»£ç  */if (afl-&gt;limit_time_sig &lt;= 0) { // afl-&gt;limit_time_sig = 0 è¡¨ç¤ºä¸å¯ç”¨ MOPT    fuzz_one_original();}if (afl-&gt;limit_time_sig != 0) { // å¯ç”¨ MOPT    if (afl-&gt;limit_time_sig &lt;= 0)  pilot_fuzzing();    else if (afl-&gt;key_module == 1)  core_fuzzing();    else if (afl-&gt;key_module == 2)  pso_updating();}</code></pre></li></ul></li></ul><hr><h4 id="fuzz-one-original"><a href="#fuzz-one-original" class="headerlink" title="fuzz_one_original()"></a>fuzz_one_original()</h4><p>ä»é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªå®ä½“ï¼Œå¹¶è¿›è¡Œä¸€æ®µæ—¶é—´çš„æ¨¡ç³Šæµ‹è¯•ã€‚è¿”å›0è¡¨ç¤ºæˆåŠŸè¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œè¿”å›1è¡¨ç¤ºè·³è¿‡æˆ–æ”¾å¼ƒæ¨¡ç³Šæµ‹è¯•</p><ul><li><p>å¦‚æœè®¾ç½®äº†ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨ï¼Œå³<code>afl-&gt;custom_mutators_count = 1</code>ï¼Œé‚£ä¹ˆç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨å°†å†³å®šè·³è¿‡å“ªäº›æµ‹è¯•ç”¨ä¾‹</p></li><li><p>æ ¹æ®<code>afl-&gt;pending_favored</code>æ ‡å¿—æ¥åˆ¤æ–­åœ¨é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ–°çš„favoredã€æ²¡æœ‰æ¨¡ç³Šæµ‹è¯•è¿‡çš„ç§å­ï¼Œå¦‚æœæœ‰ä¸”å½“å‰ç§å­å·²ç»è¢«æ¨¡ç³Šæµ‹è¯•è¿‡æˆ–ä¸æ˜¯favoredï¼Œé‚£ä¹ˆæœ‰99%æ¦‚ç‡è·³è¿‡è¯¥ç§å­çš„æ¨¡ç³Šæµ‹è¯•ï¼›å¦‚æœ<code>afl-&gt;pending_favored</code>æ ‡å¿—ä¸º<code>false</code>ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰æ¨¡ç³Šæµ‹è¯•ä¸ºæ’æ¡©æ¨¡å¼ã€å½“å‰ç§å­ä¸æ˜¯favoredä¸”ç§å­é˜Ÿåˆ—æ•°&gt;10ï¼Œå¦‚æœé˜Ÿåˆ—å‘¨æœŸå¤§äº1ä¸”å½“å‰ç§å­æœªè¿›è¡Œè¿‡æ¨¡ç³Šæµ‹è¯•ï¼ˆæ–°å‘¨æœŸå†…äº§ç”Ÿçš„ç§å­ï¼Œä½†ä¸æ˜¯favoredçš„ï¼‰ï¼Œ75%çš„æ¦‚ç‡è·³è¿‡ï¼›å¦åˆ™æœ‰95%çš„æ¦‚ç‡è·³è¿‡å¯¹è¯¥ç§å­çš„æ¨¡ç³Šæµ‹è¯•</p></li><li><p><code>queue_testcase_get()</code>ï¼šé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Œå¦‚æœæœªå¯ç”¨ç¼“å­˜ï¼Œåˆ™ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®å¹¶è¿”å›ï¼›å¦åˆ™ï¼Œåˆ¤æ–­è¯¥æµ‹è¯•ç”¨ä¾‹æ˜¯å¦å·²ç»ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœå·²è¢«ç¼“å­˜ï¼Œåˆ™ç›´æ¥ä»å†…å­˜ä¸­å–å‡ºå³å¯ï¼Œå¦åˆ™å°†è¯¥æµ‹è¯•ç”¨ä¾‹ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œè¿”å›æŒ‡é’ˆ<code>afl-&gt;queue_cur-&gt;testcase_buf</code>ã€‚</p><p>å¦‚æœå½“å‰æµ‹è¯•ç”¨ä¾‹æ— æ³•æ»¡è¶³æ”¾å…¥ç¼“å­˜çš„æ¡ä»¶ï¼ˆè¶…è¿‡ç¼“å­˜ç¼“å­˜å¤§å°/è¶…è¿‡æœ€å¤§ç¼“å­˜æ•°ï¼‰ï¼Œåˆ™è¿›è¡Œ<strong>ä¸€ä¸ªè‡ªé€‚åº”ç¼“å­˜å†²çªç®—æ³•</strong>ï¼Œå…·ä½“æ¥è¯´ï¼š</p><ul><li><code>afl-&gt;q_testcase_cache_size</code>ï¼šå½“å‰ç§å­æµ‹è¯•ç”¨ä¾‹ç¼“å­˜å¤§å°</li><li><code>afl-&gt;q_testcase_max_cache_size</code>ï¼šèƒ½å¤Ÿç¼“å­˜çš„æœ€å¤§ç§å­æµ‹è¯•ç”¨ä¾‹å¤§å°</li><li><code>afl-&gt;q_testcase_cache_count</code>ï¼šå½“å‰å·²ç¼“å­˜ç§å­ä¸ªæ•°</li><li><code>afl-&gt;q_testcase_max_cache_entries</code>ï¼šèƒ½å¤Ÿç¼“å­˜çš„æœ€å¤§çš„ç§å­æ•°</li><li><code>afl-&gt;q_testcase_max_cache_count</code>ï¼šå½“ç›®å‰ä¸ºæ­¢çš„æœ€å¤§ç¼“å­˜æ•°</li><li><code>afl-&gt;q_testcase_cache[]</code>ï¼šè¯¥æ•°ç»„ç»´æŠ¤äº†ä¸€ä¸ªå·²ç¼“å­˜çš„ç§å­åˆ—è¡¨</li></ul><p>ä¸€å…±æœ‰ä¸¤ç§æƒ…å†µï¼Œ<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ã€è¯¥æ“ä½œåªè¿›è¡Œä¸€æ¬¡ã€‘ æ˜¯ç¼“å­˜ç§å­æ•°æœªè¾¾åˆ°æœ€å¤§ç§å­ç¼“å­˜æ•°ï¼Œä»…ä»…æ˜¯ç¼“å­˜ç©ºé—´ä¸å¤Ÿäº†ï¼Œé‚£ä¹ˆå°†ç¼“å­˜çš„æœ€å¤§ç§å­æ•°<code>q_testcase_max_cache_entries</code>è®¾ç½®ä¸º max(afl-&gt;q_testcase_cache_count, afl-&gt;q_testcase_max_cache_count) + 1ï¼Œç„¶åé‡æ–°åˆ†é…<code>afl-&gt;q_testcase_cache</code>ã€è¯¥æ•°ç»„è®°å½•è¢«ç¼“å­˜çš„ç§å­ã€‘çš„ç©ºé—´ï¼ˆå½“å‰ç¼“å­˜ç§å­æ•°/å†å²æœ€å¤§ç§å­ç¼“å­˜æ•°+2ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼“å­˜ç©ºé—´æº¢å‡ºï¼Œè¿˜éœ€è¦å°†å½“å‰ç¼“å­˜ç©ºé—´çš„ä¸€ä¸ªæˆ–å¤šä¸ªç¼“å­˜æ›¿æ¢ä¸ºå½“å‰ç§å­æµ‹è¯•ç”¨ä¾‹ï¼Œè§<a href="#case2">æƒ…å†µ2</a></p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”±äºæµ‹è¯•ç”¨ä¾‹è¿‡å¤§ï¼Œå¯èƒ½ä¸éœ€è¦è¿™ä¹ˆå¤§çš„ç¼“å­˜ç§å­æ•°ï¼ˆå› ä¸ºè¾ƒå¤§çš„æµ‹è¯•ç”¨ä¾‹ä¼šå¾ˆå¿«å¡«å……ç¼“å­˜ç©ºé—´ï¼‰ï¼Œè¿™æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§è‡ªé€‚åº”çš„ç¼“å­˜é…ç½®ã€‚</p><p><span id="case2"><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </span>ç¼“å­˜ç§å­æ•°å³å°†è¾¾åˆ°äº†æœ€å¤§ç§å­ç¼“å­˜æ•°ï¼ˆå³ä»…å‰©ä¸‹æœ€åä¸€ä¸ªç¼“å­˜ç©ºä½ï¼‰ï¼Œé‚£ä¹ˆåœ¨<code>afl-&gt;q_testcase_cache</code>æ•°ç»„ä¸­ä¸æ˜¯ç©ºä¸”ä¸æ˜¯æŒ‡å‘å½“å‰ç§å­çš„ä½ç½®ï¼Œé‡Šæ”¾è¯¥ç§å­çš„ç¼“å­˜ï¼Œå³afl-&gt;q_testcase_cache[tid]<strong>-&gt;testcase_buf</strong>ï¼Œå¹¶æ›´æ–°ç›¸å…³å˜é‡å€¼ã€‚åå¤è¿›è¡Œä¸Šè¿°æ“ä½œï¼Œç›´åˆ°ç¼“å­˜èƒ½å¤Ÿæ”¾ä¸‹å½“å‰ç§å­ä¸ºæ­¢ã€‚</p><p>ç„¶åå°†æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®è¯»å…¥åˆ°<code>q-&gt;testcase_buf</code>ï¼Œå¹¶æ›´æ–°ç›¸å…³å˜é‡å€¼ã€‚</p></li><li><p><code>calibrate_case()</code>ï¼šæ ¡å‡†ä¸€ä¸ªæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨å¤„ç†è¾“å…¥ç›®å½•æ—¶å®Œæˆï¼Œä»¥ä¾¿åœ¨æ—©æœŸè­¦å‘Šæœ‰é—®é¢˜çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶åœ¨å‘ç°æ–°è·¯å¾„æ—¶æ£€æµ‹å˜é‡è¡Œä¸ºç­‰</p></li><li><p><code>trim_case()</code>ï¼šå¦‚æœæ˜¯æ’æ¡©æ¨¡å¼ã€trim_doneæœªè¿›è¡Œè¿‡ä¸”å¯ç”¨äº†trimï¼Œåˆ™å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œä¿®å‰ªæ“ä½œã€‚ä¿®å‰ªæ“ä½œçš„ç›®çš„æ˜¯å°½å¯èƒ½å‡å°‘è¾“å…¥æµ‹è¯•ç”¨ä¾‹çš„å¤§å°ï¼Œå› ä¸ºæµ‹è¯•ç”¨ä¾‹çš„å¤§å°ä¼šå½±å“æ¨¡ç³Šæµ‹è¯•çš„é€Ÿåº¦ã€‚è¯¥æ“ä½œè¿›è¡ŒæŒ‡å®šæ­¥é•¿çš„åˆ é™¤æ“ä½œï¼Œç„¶åå°†åˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œè¿è¡Œï¼Œå¦‚æœtrace_bitsç›¸åŒï¼ˆåˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹å’ŒåŸæµ‹è¯•ç”¨ä¾‹è§¦å‘ç›¸åŒçš„ç¨‹åºçŠ¶æ€ï¼Œä½†åˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹å…·æœ‰æ›´å°çš„å¤§å°ï¼‰ï¼Œåˆ™å°†è¯¥åˆ é™¤æ“ä½œå†™å…¥åˆ°æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ä¸­ã€‚æ³¨ï¼šè¿™é‡Œéœ€è¦åŒæ—¶æ›´æ–°ç¼“å­˜çš„æ•°æ®ã€‚</p></li><li><p><code>calculate_score()</code>ï¼šæ ¹æ®æ‰§è¡Œæ—¶é—´ã€bitmapå¤§å°ã€handicapï¼ˆåæ¥è€…å…è®¸è¿è¡Œæ›´é•¿çš„æ—¶é—´ï¼‰ã€ç§å­æ·±åº¦ã€èƒ½é‡è°ƒåº¦ï¼ˆå†³å®šfactorï¼‰ã€MOPTæ¨¡å¼çš„ä¸€äº›æŒ‡æ ‡ç­‰è®¡ç®—ç§å­å¾—åˆ†</p></li><li><p><strong>ç¡®å®šæ€§å˜å¼‚é˜¶æ®µ</strong>ï¼šå¦‚æœç»™å®šäº†<code>-d</code>ï¼Œåˆ™è·³è¿‡ç¡®å®šæ€§å˜å¼‚é˜¶æ®µï¼›å¦‚æœå…ˆå‰å·²ç»è¿›è¡Œäº†ç¡®å®šæ€§å˜å¼‚ï¼ˆpassed_det=1ï¼‰æˆ–è€…ç§å­å¾—åˆ†æ»¡è¶³æŸä¸ªæ¡ä»¶[å¯¹è¯¥ç§å­è¿›è¡Œç¡®å®šæ€§å˜å¼‚æ€§ä»·æ¯”ä¸é«˜]ï¼Œåˆ™ä¹Ÿéœ€è¦è·³è¿‡ç¡®å®šæ€§å˜å¼‚</p></li><li><p>è·³è¿‡ç¡®å®šæ€§å˜å¼‚åï¼Œå…ˆæ‰§è¡Œ<strong>ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚é˜¶æ®µ</strong>ï¼Œä¹‹åè¿›å…¥<strong>havocé˜¶æ®µ</strong>ã€‚</p></li><li><p>havocé˜¶æ®µç»“æŸåï¼Œå¯èƒ½ä¼šè¿›å…¥spliceé˜¶æ®µï¼Œè¯¥é˜¶æ®µç”±<code>afl-&gt;ready_for_splicing_count(&gt;1)</code>å†³å®šï¼Œè¯¥å€¼åœ¨<code>add_to_queue()</code>å‡½æ•°ä¸­è¢«æ›´æ–°ï¼Œå½“ç§å­å¤§å°&gt;4æ—¶ï¼Œ<code>afl-&gt;ready_for_splicing_count++</code></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GraphFuzzä½¿ç”¨è¯´æ˜</title>
    <link href="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"/>
    <url>/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="GraphFuzzä½¿ç”¨è¯´æ˜"><a href="#GraphFuzzä½¿ç”¨è¯´æ˜" class="headerlink" title="GraphFuzzä½¿ç”¨è¯´æ˜"></a>GraphFuzzä½¿ç”¨è¯´æ˜</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><ul><li><p>GraphFuzzæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç»“æ„æ„ŸçŸ¥ã€åº“APIæ¨¡ç³Šå™¨çš„å®éªŒæ€§æ¡†æ¶</p></li><li><p>è®ºæ–‡ï¼š</p><p>ã€ŠGraphFuzz: Library API Fuzzing with Lifetime-aware Dataflow Graphsã€‹</p></li><li><p>GraphFuzzåŒ…å«ï¼š</p><ul><li><code>gfuzz</code>ï¼šå‘½ä»¤è¡Œå·¥å…·ç”¨æ¥åˆæˆharness</li><li><code>libgraphfuzz</code>ï¼šä¸€ä¸ªè¿è¡Œæ—¶å›¾å˜å¼‚å¼•æ“</li></ul></li><li><p>æ–‡æ¡£ï¼š<a href="https://hgarrereyn.github.io/GraphFuzz">hgarrereyn.github.io/GraphFuzz</a></p></li></ul><h2 id="2-å·¥ä½œæµç¨‹"><a href="#2-å·¥ä½œæµç¨‹" class="headerlink" title="2. å·¥ä½œæµç¨‹"></a>2. å·¥ä½œæµç¨‹</h2><ul><li><p>éœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡å¼ï¼ˆ**<code>schema</code>**ï¼‰æ¥æè¿°ç›®æ ‡åº“API</p></li><li><p>æ¨¡å¼ä½¿ç”¨äººå¯è¯»çš„TAMLæ ¼å¼ç¼–å†™ï¼Œå¹¶åŒ…å«ä¸€ç³»åˆ—éœ€è¦è¿›è¡Œæ¨¡ç³Šæµ‹è¯•çš„å‡½æ•°ã€ç±»å’Œç»“æ„ä½“</p><hr><p><strong>schema.yaml</strong>ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">foo(int</span> <span class="hljs-string">x,</span> <span class="hljs-string">int</span> <span class="hljs-string">y,</span> <span class="hljs-string">float</span> <span class="hljs-string">z)</span><br><span class="hljs-attr">Bar:</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Bar(Foo</span> <span class="hljs-string">*,</span> <span class="hljs-string">int)</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">~Bar()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">bar(int</span> <span class="hljs-string">x)</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>åœ¨è¿è¡Œæ—¶ï¼ŒGraphFuzzå°†ä½¿ç”¨ä¸åŒé¡ºåºå’Œä¸åŒçš„å‚æ•°è°ƒç”¨åº“çš„APIä»¥ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒGraphFuzzå°†æ˜ç¡®è·Ÿè¸ªç›®æ ‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½éµå®ˆç”±æ¨¡å¼å®šä¹‰çš„APIè§„èŒƒ</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++">{ <span class="hljs-comment">// Example 1</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    Bar *v1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">1000</span>);<br>    v1-&gt;<span class="hljs-built_in">bar</span>(<span class="hljs-number">123</span>);<br>    del v1;<br>    del v0;<br>}<br>{ <span class="hljs-comment">// Example 2</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    del v0;<br>}<br>{ <span class="hljs-comment">// Example 3</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    Bar *v1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">1000</span>);<br>    Bar *v2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">0</span>);<br>    del v2;<br>    del v1;<br>    del v0;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä¸Šè¿°çš„æµ‹è¯•ç”¨ä¾‹å°†è¡¨ç¤ºä¸ºC++æºä»£ç ã€‚ä½†åœ¨GraphFuzzå†…éƒ¨ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹è¡¨ç¤ºä¸ºä¸€ä¸ª<span style="background-color:#ffed99;font-weight:bold">æ•°æ®æµå›¾</span>ï¼Œè¯¥æ•°æ®æµå›¾çš„é¡¶ç‚¹è¡¨ç¤ºä¸ºå‡½æ•°ï¼Œè¾¹è¡¨ç¤ºä¸ºå¯¹è±¡ä¹‹é—´çš„ä¾èµ–ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGraphFuzzæ— éœ€ä»£ç åˆ†ææˆ–é‡ç¼–è¯‘ä¾¿å¯æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼›ç›¸åï¼Œå®ƒåŠ¨æ€éå†æ¯ä¸€ä¸ªå›¾ï¼Œè°ƒç”¨æ¯ä¸ªé¡¶ç‚¹çš„ä¸€ä¸ªç«¯ç‚¹</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o1.png"></p></li></ul><h2 id="3-å®‰è£…GraphFuzz"><a href="#3-å®‰è£…GraphFuzz" class="headerlink" title="3. å®‰è£…GraphFuzz"></a>3. å®‰è£…GraphFuzz</h2><ul><li>å°†æºç ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶å®‰è£…ç›¸å…³ä¾èµ–ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/ForAllSecure/GraphFuzz.git<br>$ sudo apt-get install libprotobuf-dev protobuf-compiler python3-venv python3-pip<br>$ curl -sSL https://install.python-poetry.org | python3 -<br>$ <span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>: ** the root path to poetry ** (e.g. /home/chan/.local/bin)<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>libgraphfuzzï¼š</strong></p><ul><li>libgraphfuzzæ˜¯é“¾æ¥åˆ°ä½ çš„æ¨¡ç³Šå™¨harnessçš„ä¸€ä¸ªè¿è¡Œæ—¶å›¾å˜å¼‚åº“ï¼Œå…¶ç”¨C++ç¼–å†™å¹¶ä½¿ç”¨æ ‡å‡†çš„CMakeè¿›è¡Œæ„å»ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> GraphFuzz<br>$ <span class="hljs-built_in">mkdir</span> build<br>$ <span class="hljs-built_in">cd</span> build<br>$ cmake ..<br>$ make<br>$ sudo make install<br></code></pre></td></tr></tbody></table></figure><hr><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>gfuzzï¼š</strong></p><ul><li>gfuzzæ˜¯ä¸€ä¸ªpythonå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥æ„å»ºharnessæ–‡ä»¶å¹¶æ‰§è¡Œå„ç§å„æ ·å…¶ä»–çš„åŠŸèƒ½ï¼ˆå¦‚å›¾æœ€å°åŒ–ï¼‰ã€‚å…¶ä½¿ç”¨Pythonç¼–å†™ï¼Œä½¿ç”¨Poetryæ¥æ„å»ºç³»ç»Ÿï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> .. &amp;&amp; <span class="hljs-built_in">cd</span> cli<br>$ poetry build<br>$ poetry <span class="hljs-built_in">export</span> &gt; dist/requirements.txt<br>$ python3 -m pip install -r dist/requirements.txt<br>$ python3 -m pip install ./dist/gfuzz-*.whl<br></code></pre></td></tr></tbody></table></figure><h2 id="4-åŸºæœ¬ç”¨æ³•"><a href="#4-åŸºæœ¬ç”¨æ³•" class="headerlink" title="4. åŸºæœ¬ç”¨æ³•"></a><span id="basicusage">4. åŸºæœ¬ç”¨æ³•</span></h2><ul><li>æ„å»ºå®éªŒæµ‹è¯•ç¯å¢ƒï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo apt-get install docker-ce docker-ce-cli containerd.io<br>$ <span class="hljs-built_in">cd</span> .. &amp;&amp; <span class="hljs-built_in">cd</span> experiments<br>$ sudo ./build base<br>$ sudo ./build hello_graphfuzz<br>$ sudo ./run hello_graphfuzz<br></code></pre></td></tr></tbody></table></figure><ul><li><code>hello_graphfuzz</code>æ˜¯ä¸€ä¸ªç®€å•æµ‹è¯•é¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç®€å•çš„C++ç›®æ ‡æ–‡ä»¶<code>lib.h</code>ã€ä¸€ä¸ªæ¨¡å¼é…ç½®æ–‡ä»¶<code>schema.yaml</code></li><li>ä¸€ä¸ªç®€å•çš„C++ç›®æ ‡æ–‡ä»¶<code>lib.h</code>ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>(): <span class="hljs-built_in">buffer</span>(<span class="hljs-number">0</span>) {}<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">char</span> val)</span> </span>{<br>        buffer.<span class="hljs-built_in">push_back</span>(val);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">if</span> (buffer.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-number">4</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">0</span>] == <span class="hljs-string">'F'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">1</span>] == <span class="hljs-string">'U'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">2</span>] == <span class="hljs-string">'Z'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">3</span>] == <span class="hljs-string">'Z'</span><br>        ) {<br>            __builtin_trap();<br>        }<br>    }<br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;<span class="hljs-type">char</span>&gt; buffer;<br>};<br></code></pre></td></tr></tbody></table></figure><ul><li>åœ¨è¿™ä¸ªç›®æ ‡ä¸­ï¼Œæ— æ³•åˆ›å»ºä½¿ç”¨æ ‡å‡†<code>LLVMFuzzerTestOneInput</code>ç±»å‹çš„å•ä¸ªå‡½æ•°çš„harnessã€‚ä½†ä½ å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ–¹æ³•æ„é€ ä¸€ä¸ªäº‹å®ä¸Šçš„APIæ¨¡ç³Šå™¨ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *Data, <span class="hljs-type">size_t</span> Size)</span> </span>{<br>    Foo foo;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; Size; ++i) {<br>        foo.<span class="hljs-built_in">write</span>(Data[i]);<br>    }<br>    foo.<span class="hljs-built_in">check</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p>ä¸Šè¿°ç±»å‹çš„harnessæ„é€ éœ€è¦ä¸€äº›å…³äºAPIçš„åŸŸçŸ¥è¯†ï¼Œä½†å¯¹æ¨¡ç³Šå™¨çš„æœç´¢ç©ºé—´è¿›è¡Œäº†é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªbugéœ€è¦åœ¨Foo::checkä¹‹åè°ƒç”¨Foo::writeæˆ–å¤šæ¬¡è°ƒç”¨Foo::checkæ‰èƒ½è§¦å‘ï¼Œé‚£è¯¥å¦‚ä½•æ“ä½œï¼Ÿå› æ­¤ä¸Šè¿°<span style="background-color:#ffed99;font-weight:bold">åŸºäºæ ‡å‡†<code>LLVMFuzzerTestOneInput</code>å­˜åœ¨å±€é™æ€§</span>ï¼Œä¸»è¦çš„é—®é¢˜æ˜¯å…¶è°ƒç”¨åºåˆ—ä¸å˜ï¼Œå› æ­¤ä¸èƒ½è§¦å‘æ›´æ·±å±‚æ¬¡çš„æ¼æ´ã€‚éšç€API surfaceçš„æ‰©å¤§ï¼Œå‡½æ•°çš„äº¤äº’æ–¹å¼ä¹Ÿå‘ˆæŒ‡æ•°çº§å¢åŠ ï¼Œç”Ÿæˆè¿™äº›â€œäº‹å®ä¸Šâ€çš„harnesså˜å¾—æ›´åŠ å›°éš¾ã€‚</p></li><li><p>åœ¨GraphFuzzä¸­ï¼Œä¸€ä¸ªé©±åŠ¨è§è§£æ˜¯ä½¿æ¨¡ç³Šå™¨å¼•æ“æ ¹æ®è¦†ç›–ç‡å¼•å¯¼å˜å¼‚è‡ªè¡Œå‘ç°<span style="background-color:#ffed99;font-weight:bold">APIä½¿ç”¨æ¨¡å¼</span>ï¼šé€šè¿‡å®šä¹‰ä¸€ä¸ªæ¨¡å¼ï¼Œæè¿°æˆ‘ä»¬æƒ³è¦æ¨¡ç³Šæµ‹è¯•çš„æ‰€æœ‰APIç«¯ç‚¹ï¼Œè®©æ¨¡ç³Šå™¨æ„å»ºæµ‹è¯•ç”¨ä¾‹ã€‚</p></li><li><p>schema.yamlï¼š</p></li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check()</span><br></code></pre></td></tr></tbody></table></figure><ul><li><p>è¯¥æ¨¡å¼æè¿°äº†ä¸€ä¸ªåº“APIä¸­ä¸€ä¸ªå¯¹è±¡<code>struct Foo</code>å’Œå››ä¸ªç«¯ç‚¹ï¼š</p><ul><li><p><code>Foo::Foo()</code>ï¼ˆä¸€ä¸ªæ„é€ å‡½æ•°ï¼‰</p></li><li><p><code>Foo::~Foo()</code> (ä¸€ä¸ªææ„å‡½æ•°)</p></li><li><p><code>Foo::write(char)</code></p></li><li><p><code>Foo::check()</code></p></li></ul></li><li><p>åœ¨æ¨¡å¼ä¸­ï¼Œä»…ç»™å‡ºå‡½æ•°ç­¾åï¼Œä½†GraphFuzzå°è¯•å»æ¨æ–­è¯­ä¹‰ï¼ˆä¾‹å¦‚ï¼ŒFoo:Fooæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼‰ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯¥æ¨æ–­æ˜¯å®Œç¾çš„ï¼›ä½†ä¹Ÿç¡®å®é‡åˆ°äº†å¯¹å‚æ•°æœ‰éšå«çº¦æŸçš„å‡½æ•°æˆ–éæ ‡å‡†çš„APIç»“æ„ã€‚å› æ­¤ï¼ŒGraphFuzzä¹Ÿæ”¯æŒä¸€ç§æ›´ç²—ç•¥ã€æ›´çµæ´»çš„ç«¯ç‚¹å£°æ˜ï¼Œç§°ä¸ºè‡ªå®šä¹‰ç«¯ç‚¹ã€‚</p></li></ul><hr><ul><li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>gfuzz</code>å·¥å…·å»åˆæˆå®é™…çš„C++ harnessæ–‡ä»¶ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Usage: gfuzz gen [lang] [schema] [output directory]</span><br>$ gfuzz gen cpp schema.yaml .<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿™å°†ä¼šäº§ç”Ÿ3ä¸ªæ–‡ä»¶ï¼š<ul><li><code>fuzz_exec.cpp</code>ï¼šä¸»æ¨¡ç³Šå™¨harness</li><li><code>fuzz_write.cpp</code>ï¼šä¸€ä¸ªé•œåƒharnessï¼Œç”¨äºå°†æ•°æ®æµå›¾è½¬åŒ–ä¸ºæºä»£ç </li><li><code>schema.json</code>ï¼šåœ¨è¿è¡Œæ—¶è¢«GraphFuzzæ‰€ä½¿ç”¨çš„ç±»å‹å…ƒæ•°æ®</li></ul></li></ul><p>:happy: ç”Ÿæˆæ–‡ä»¶å†…å®¹è¯¦è§<a href="#fl1">é™„å½•</a></p><ul><li>æœ€åï¼Œæˆ‘ä»¬ç¼–è¯‘æ¨¡ç³Šå™¨harnessï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang++ -o fuzz_exec fuzz_exec.cpp -fsanitize=fuzzer -lprotobuf -lgraphfuzz<br></code></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼šGraphFuzzé€šè¿‡hookçš„æ–¹å¼ä½¿ç”¨libFuzzerï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨libFuzzerçš„åŠŸèƒ½å¦‚ <code>user_value_profile</code>, <code>fork</code>, <code>dict</code> ç­‰ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./fuzz_exec -use_value_profile=1<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o2.png"></p><ul><li>æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ–‡ä»¶è¡¨ç¤ºä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®æµå›¾ï¼Œå› æ­¤æˆ‘ä»¬æŸ¥çœ‹crashæ˜¯ä¸å¯è¯»çš„ï¼š</li></ul><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o3.png"></p><ul><li>ä¸ºäº†ä½¿å…¶å¯è¯»ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>fuzz_write</code> harnessä»å›¾ä¸­åˆæˆæºä»£ç ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang++ -o fuzz_write fuzz_write.cpp -fsanitize=fuzzer -lprotobuf -lgraphfuzz<br></code></pre></td></tr></tbody></table></figure><ul><li>ç„¶åè¿è¡Œ<code>fuzz_write</code>æ¥åˆæˆharnessï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./fuzz_write crash-402bbad640a94933571939f685ea1e9dc4b937f8<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib.h"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE(t) static_cast<span class="hljs-string">&lt;t *&gt;</span>(calloc(sizeof(t), 1))</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GFUZZ_BUNDLE</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">void</span> *active;<br>    <span class="hljs-type">void</span> *inactive;<br>    <span class="hljs-built_in">GFUZZ_BUNDLE</span>(<span class="hljs-type">void</span> *_active, <span class="hljs-type">void</span> *_inactive): <span class="hljs-built_in">active</span>(_active), <span class="hljs-built_in">inactive</span>(_inactive) {}<br>};<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUNDLE(a,b) new GFUZZ_BUNDLE((void *)a, (void *)b)</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    Foo *var_0;<br>    { <span class="hljs-comment">// begin shim_0</span><br>        var_0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>        Foo ref = <span class="hljs-built_in">Foo</span>();<br>        *var_0 = ref;<br>    } <span class="hljs-comment">// end shim_0</span><br>    Foo *var_1;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_0-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">70</span>); <span class="hljs-comment">// ascii 'F'</span><br>        var_1 = var_0;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_2;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_1-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">85</span>); <span class="hljs-comment">// ascii 'U'</span><br>        var_2 = var_1;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_3;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_2-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_3 = var_2;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_4;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_3-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_4 = var_3;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_5;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_4-&gt;<span class="hljs-built_in">check</span>(); <span class="hljs-comment">// __builtin_trap</span><br>        var_5 = var_4;<br>    } <span class="hljs-comment">// end shim_3</span><br>    Foo *var_6;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_5-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">5</span>);<br>        var_6 = var_5;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_7;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_6-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>);<br>        var_7 = var_6;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_8;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_7-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>);<br>        var_8 = var_7;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_9;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_8-&gt;<span class="hljs-built_in">check</span>();<br>        var_9 = var_8;<br>    } <span class="hljs-comment">// end shim_3</span><br>    { <span class="hljs-comment">// begin shim_1</span><br>        <span class="hljs-built_in">free</span>(var_9);<br>    } <span class="hljs-comment">// end shim_1</span><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥crashåœ¨å†…éƒ¨ä»è¢«è¡¨ç¤ºä¸ºæ•°æ®æµå›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŒæ ·çš„æ¨¡ç³Šå™¨æ¦‚å¿µæ¥è¿›è¡Œå›¾æ„ŸçŸ¥çš„æœ€å°åŒ–</li></ul><blockquote><p><span class="github-emoji"><span>ğŸ““</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç›®å‰libFuzzerä¸æ”¯æŒè‡ªå®šä¹‰minimize_crashé€‰é¡¹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šå°è¯•æ‰§è¡Œå­—èŠ‚æ„ŸçŸ¥çš„æœ€å°åŒ–ï¼Œå› æ­¤æä¾›äº†ä¸€ä¸ªå›¾æ„ŸçŸ¥æœ€å°åŒ–å·¥å…·ä½œä¸º<code>gfuzz</code>çš„ä¸€éƒ¨åˆ†</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Usage: gfuzz min [fuzzer] [crash]</span><br>$ gfuzz min ./fuzz_exec crash-402bbad640a94933571939f685ea1e9dc4b937f8<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o4.png"></p><ul><li>ç„¶åæˆ‘ä»¬æŸ¥çœ‹æœ€å°åŒ–åçš„æµ‹è¯•ç”¨ä¾‹ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./fuzz_write crash-402bbad640a94933571939f685ea1e9dc4b937f8.min<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib.h"</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE(t) static_cast<span class="hljs-string">&lt;t *&gt;</span>(calloc(sizeof(t), 1))</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GFUZZ_BUNDLE</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">void</span> *active;<br>    <span class="hljs-type">void</span> *inactive;<br>    <span class="hljs-built_in">GFUZZ_BUNDLE</span>(<span class="hljs-type">void</span> *_active, <span class="hljs-type">void</span> *_inactive): <span class="hljs-built_in">active</span>(_active), <span class="hljs-built_in">inactive</span>(_inactive) {}<br>};<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUNDLE(a,b) new GFUZZ_BUNDLE((void *)a, (void *)b)</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    Foo *var_0;<br>    { <span class="hljs-comment">// begin shim_0</span><br>        var_0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>        Foo ref = <span class="hljs-built_in">Foo</span>();<br>        *var_0 = ref;<br>    } <span class="hljs-comment">// end shim_0</span><br>    Foo *var_1;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_0-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">70</span>); <span class="hljs-comment">// ascii 'F'</span><br>        var_1 = var_0;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_2;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_1-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">85</span>); <span class="hljs-comment">// ascii 'U'</span><br>        var_2 = var_1;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_3;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_2-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_3 = var_2;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_4;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_3-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_4 = var_3;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_5;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_4-&gt;<span class="hljs-built_in">check</span>(); <span class="hljs-comment">// __builtin_trap</span><br>        var_5 = var_4;<br>    } <span class="hljs-comment">// end shim_3</span><br>    { <span class="hljs-comment">// begin shim_1</span><br>        <span class="hljs-built_in">free</span>(var_5);<br>    } <span class="hljs-comment">// end shim_1</span><br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸Šè¿°ç»“æœåˆ é™¤äº†å†—ä½™çš„ä»£ç </p><h2 id="5-ç«¯ç‚¹"><a href="#5-ç«¯ç‚¹" class="headerlink" title="5. ç«¯ç‚¹"></a>5. ç«¯ç‚¹</h2><ul><li>ç«¯ç‚¹æ˜¯ä¸€ä¸ªGraphFuzz harnessåŸºæœ¬æ„å»ºå—ï¼ˆæ•°æ®æµå›¾çš„é¡¶ç‚¹ï¼‰ï¼Œæœ¬èŠ‚ä¸»è¦æ¢ç´¢å®Œæ•´çš„ç«¯ç‚¹å®šä¹‰è¯­æ³•ï¼š</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>    <span class="hljs-string">...</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-string">...</span><br>    <span class="hljs-comment"># Endpoint name.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">myEndpoint:</span><br>        <span class="hljs-comment"># List of "live" inputs.</span><br>        <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>, <span class="hljs-string">'Bar'</span>]<br><br>        <span class="hljs-comment"># List of "live" outputs.</span><br>        <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Bar'</span>]<br><br>        <span class="hljs-comment"># Additional fuzzable parameters.</span><br>        <span class="hljs-attr">args:</span> [<span class="hljs-string">'int'</span>, <span class="hljs-string">'char[10]'</span>]<br><br>        <span class="hljs-comment"># Endpoint code. (<span class="hljs-doctag">note:</span> "exec: |" is YAML syntax for a multiline string)</span><br>        <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">            // Arbitrary C/C++ code here</span><br><span class="hljs-string">            for (int i = 0; i &lt; 10; ++i) {</span><br><span class="hljs-string">                $a1[i] &amp;= 0x7f;</span><br><span class="hljs-string">            }</span><br><span class="hljs-string">            $i1-&gt;doFunction($i0, $a0, $a1);</span><br><span class="hljs-string">            $o0 = $i1;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>å¯ä»¥å°†ç«¯ç‚¹å®šä¹‰æŠ½è±¡ä¸ºä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œå¯¹ç”¨æ³•æœ‰ä¸€å®šçš„è¦æ±‚ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// [å‰ææ¡ä»¶:]</span><br><span class="hljs-comment">// $i0 is a live Foo *</span><br><span class="hljs-comment">// $i1 is a live Bar *</span><br><span class="hljs-comment">// $a0 is an int</span><br><span class="hljs-comment">// $a1 is a char[10]</span><br>{<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {<br>        $a1[i] &amp;= <span class="hljs-number">0x7f</span>;<br>    }<br>    $i1-&gt;<span class="hljs-built_in">doFunction</span>($i0, $a0, $a1);<br>    $o0 = $i1;<br>}<br><span class="hljs-comment">// [å‰ææ¡ä»¶:]</span><br><span class="hljs-comment">// $o0 is a live Bar *</span><br></code></pre></td></tr></tbody></table></figure><p>æ³¨ï¼šä¸ºäº†è¿è¡Œæ­¤ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å¤šä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬å®æ—¶æ•°æ®ç±»å‹ã€‚è¿è¡Œæ­¤ä»£ç åï¼Œå°†å‰©ä¸‹ä¸€ä¸ªå¯¹è±¡ï¼ˆBar *ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç†è¯¥å¯¹è±¡</p><ul><li>æ¨¡ç³Šæµ‹è¯•å¼•æ“å°†é€šè¿‡è°ƒç”¨æ„é€ å¿…è¦å¯¹è±¡å¹¶ææ„ç»“æœå¯¹è±¡çš„å…¶ä»–ç«¯ç‚¹æ¥è‡ªåŠ¨è¯†åˆ«å¦‚ä½•è°ƒç”¨æ­¤ç«¯ç‚¹</li></ul><hr><ul><li>åœ¨<a href="#basicusage">åŸºæœ¬ç”¨æ³•</a>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼æ¥è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„ç«¯ç‚¹å®šä¹‰</li></ul><p><strong>schema.yamlï¼š</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check()</span><br></code></pre></td></tr></tbody></table></figure><ul><li>åœ¨å†…éƒ¨ï¼ŒGraphFuzzç”Ÿæˆäº†ä¸€ä¸ªå®Œæ•´çš„æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo():</span><br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $o0 = new Foo();</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo():</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        delete $i0;</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val):</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">args:</span> [<span class="hljs-string">'char'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;write($a0);</span><br><span class="hljs-string">        $o0 = $i0;</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check():</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;check();</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æ¥ä¸‹æ¥ä¸€ä¸€åˆ†æç«¯ç‚¹ï¼š</li></ul><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::Foo()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Foo():</span><br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br>        <span class="hljs-string">$o0</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Foo();</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ— è¾“å…¥å’Œä¸Šä¸‹æ–‡å‚æ•°ï¼ˆç›´æ¥çœç•¥è¿™äº›å­—æ®µï¼‰ã€‚å› ä¸ºè¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå…¶äº§ç”Ÿä¸€ä¸ª<code>Foo</code>ç±»å‹çš„è¾“å‡ºã€‚åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬ç¼–å†™è¾“å‡ºå¯¹è±¡çš„ç±»å‹åç§°ã€‚åœ¨<code>exec</code>æ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®é™…è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°ã€‚å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¿é—®æ¨¡æ¿å˜é‡**$o0**ï¼ˆç¬¬0ä¸ªè¾“å‡ºï¼‰ï¼Œè¯¥å˜é‡å°†å¡«å……ä¸ºä¸€ä¸ª<code>Foo *</code>æŒ‡é’ˆã€‚</li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::~Foo()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">~Foo():</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br>        <span class="hljs-string">delete</span> <span class="hljs-string">$i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªææ„å‡½æ•°ã€‚ä¸ºäº†è°ƒç”¨ææ„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼›å› æ­¤ï¼Œæˆ‘ä»¬åœ¨<code>inputs</code>æ•°ç»„ä¸­æŒ‡å®šä¸€ä¸ª<code>Foo</code>å¯¹è±¡ã€‚å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªè¾“å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¿é—®æ¨¡æ¿å˜é‡**$i0**ï¼ˆç¬¬0ä¸ªè¾“å…¥ï¼‰ï¼Œå³ä¸€ä¸ª<code>Foo *</code>æŒ‡é’ˆã€‚</li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::check()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check():</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;check();</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ã€‚ä¸ºäº†æ‰§è¡Œä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ã€‚åœ¨æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¹‹åï¼Œè¯¥å¯¹è±¡ä»ç„¶æœ‰æ•ˆï¼Œå› æ­¤å…¶æ˜¯ä¸€ä¸ªè¾“å‡ºã€‚æˆ‘ä»¬åœ¨<code>inputs</code>å’Œ<code>outputs</code>ä¸­æŒ‡å®š<code>Foo</code>å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬æ‰§è¡Œæ¨¡æ¿æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®<strong>$i0</strong>å’Œ<strong>$o0</strong>ã€‚å½“è¿™ä¸ªç«¯ç‚¹è¢«è°ƒç”¨æ—¶ï¼Œ$i0å°†æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„<code>Foo</code>å¯¹è±¡å¹¶ç”±æˆ‘ä»¬è´Ÿè´£å¡«å……**$o0**</li></ul><p><span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::write(char)</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val):</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">'char'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;write($a0);</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>å’Œ<code>Foo::check()</code>ä¸€æ ·ï¼Œè¯¥ç«¯ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œè¯¥æ–¹æ³•æœ‰å¦å¤–ä¸€ä¸ªå‚æ•°ï¼šä¸€ä¸ª<code>char</code>å˜é‡å°†ä¼ é€’ç»™æˆ‘ä»¬çš„ç«¯ç‚¹æ–¹æ³•ã€‚<code>char</code>æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…¶ä¸ä¼šä½œä¸ºæ•°æ®æµå›¾çš„ä¸€éƒ¨åˆ†è¿›è¡Œè·Ÿè¸ªã€‚ç›¸åï¼Œåœ¨ç»™å®šå›¾ä¸­çš„æ¯ä¸ªç«¯ç‚¹å®ä¾‹åŒ…å«ä¸€ä¸ªæ­¤å‚æ•°çš„å•ç‹¬å®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥è¢«æ¨¡ç³Šæµ‹è¯•ã€‚è¿™äº›ä¸Šä¸‹æ–‡ç›¸å…³çš„å‚æ•°è¢«æŒ‡å®šåœ¨<code>args</code>æ•°ç»„ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ¨¡æ¿å˜é‡**$a0**ï¼ˆç¬¬0ä¸ªå‚æ•°ï¼‰æ¥æŒ‡å‘<code>char</code>å˜é‡ã€‚</li></ul><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="A-ç›¸å…³æºä»£ç "><a href="#A-ç›¸å…³æºä»£ç " class="headerlink" title="A. ç›¸å…³æºä»£ç "></a><span id="fl1">A. ç›¸å…³æºä»£ç </span></h3><ul><li><code>fuzz_exec.cpp</code>ä¸­æ ¸å¿ƒä»£ç å—ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* CPPScope(name=(auto) Foo::Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_0</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_o0;<br>    _o0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>    Foo ref = <span class="hljs-built_in">Foo</span>();<br>    *_o0 = ref;<br>    <br>                    <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::~Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_1</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">free</span>(_i0);<br>    <br>                    <br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void write(char val);) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_2</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">char</span> _a0;<br>    <span class="hljs-built_in">memcpy</span>(&amp;_a0, context + <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>));<br>    Foo *_o0;<br>    _i0-&gt;<span class="hljs-built_in">write</span>(_a0);<br>    _o0 = _i0;<br>                        <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void check();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_3</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    Foo *_o0;<br>    _i0-&gt;<span class="hljs-built_in">check</span>();<br>    _o0 = _i0;<br>                        <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br></code></pre></td></tr></tbody></table></figure><hr><ul><li><code>fuzz_write.cpp</code>æ ¸å¿ƒä»£ç ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* CPPScope(name=(auto) Foo::Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_0</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = MAKE(Foo);\n        Foo ref = Foo();\n        *"</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = ref;"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::~Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_1</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        free("</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">");"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void write(char val);) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_2</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">char</span> _a0;<br>    <span class="hljs-built_in">memcpy</span>(&amp;_a0, context + <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>));<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">"-&gt;write("</span> &lt;&lt; (<span class="hljs-type">int</span>)_a0 &lt;&lt; <span class="hljs-string">");\n        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void check();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_3</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">"-&gt;check();\n        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br></code></pre></td></tr></tbody></table></figure><hr><ul><li><code>schema.json</code>å†…å®¹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Foo"</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::Foo();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::~Foo();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::void write(char val);"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::void check();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></tbody></table></figure><h3 id="B-æ¨¡å¼æ ¼å¼ï¼ˆ-star-ï¼‰"><a href="#B-æ¨¡å¼æ ¼å¼ï¼ˆ-star-ï¼‰" class="headerlink" title="B. æ¨¡å¼æ ¼å¼ï¼ˆ:star:ï¼‰"></a>B. æ¨¡å¼æ ¼å¼ï¼ˆ<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼‰</h3><ul><li>â€ä¸€ä¸ª GraphFuzz æ¨¡å¼æ˜¯ç”¨ YAML ç¼–å†™çš„æ¨¡å¼å¯¹è±¡çš„é”®å€¼æ˜ å°„ï¼šâ€</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">object1:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">object1</span><br>    <span class="hljs-string">...</span><br><span class="hljs-attr">object2:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">object2</span><br>    <span class="hljs-string">...</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></tbody></table></figure><h4 id="a-å¯ç”¨å¯¹è±¡"><a href="#a-å¯ç”¨å¯¹è±¡" class="headerlink" title="a. å¯ç”¨å¯¹è±¡"></a>a. å¯ç”¨å¯¹è±¡</h4><h5 id="ç»“æ„ä½“-x2F-ç±»"><a href="#ç»“æ„ä½“-x2F-ç±»" class="headerlink" title="ç»“æ„ä½“/ç±»"></a>ç»“æ„ä½“/ç±»</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">struct_Foo:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span> <span class="hljs-comment"># (or type: class)</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>    <span class="hljs-attr">headers:</span> [<span class="hljs-string">'foo.h'</span>]<br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">~Foo()</span><br>    <span class="hljs-attr">static_methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Foo</span> <span class="hljs-string">*</span> <span class="hljs-string">MakeFoo(int)</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>struct</code> æˆ– <code>class</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>ç±»çš„åå­—ï¼ˆå¦‚ <code>Foo</code>ï¼‰ æˆ–ä¸€ä¸ªæ¨¡æ¿å®ä¾‹çš„åå­—ï¼ˆå¦‚ <code>Foo&lt;int&gt;</code>ï¼‰.</td></tr><tr><td><code>methods</code></td><td><code>List[endpoint]</code></td><td><code>[]</code></td><td>å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨ï¼ˆç­¾åæˆ–ç«¯ç‚¹å¯¹è±¡ï¼‰</td></tr><tr><td><code>static_methods</code></td><td><code>List[endpoint]</code></td><td><code>[]</code></td><td>é™æ€æ–¹æ³•çš„åˆ—è¡¨ï¼ˆç­¾åæˆ–ç«¯ç‚¹å¯¹è±¡ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>åŒ…å«æ‰€æœ‰å°é—­æ–¹æ³•å®šä¹‰çš„C++å¤´æ–‡ä»¶åˆ—è¡¨</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>åŒ…å«æ‰€æœ‰å°é—­æ–¹æ³•å®šä¹‰çš„Cå¤´æ–‡ä»¶åˆ—è¡¨</td></tr><tr><td><code>default_destructor</code></td><td><code>bool</code></td><td><code>false</code></td><td>å¦‚æœä¸º <code>true</code>, åˆ™æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ææ„å‡½æ•°ç«¯ç‚¹ï¼ˆå¦‚ <code>void ~Foo()</code>ï¼‰</td></tr><tr><td><code>alloc_with_new</code></td><td><code>bool</code></td><td><code>false</code></td><td>å¦‚æœä¸º <code>true</code>, é€šè¿‡<code>Foo *f = new Foo()</code> æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæœ¬åœ°åˆ†é…å¹¶ä½¿ç”¨ä¸€ä¸ªå¤åˆ¶æ„é€ å‡½æ•°</td></tr></tbody></table><hr><h5 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">enum_Options:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">enum</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">Options</span><br>    <span class="hljs-attr">headers:</span> [<span class="hljs-string">'options.h'</span>]<br>    <span class="hljs-attr">values:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptA</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptB</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptC</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>enum</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>æšä¸¾åç§°ï¼ˆå¦‚<code>Options</code>ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>è¯¥æšä¸¾æ‰€éœ€çš„C++å¤´æ–‡ä»¶</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>è¯¥æšä¸¾æ‰€éœ€çš„Cå¤´æ–‡ä»¶</td></tr><tr><td><code>values</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>æšä¸¾å€¼åˆ—è¡¨</td></tr></tbody></table><hr><h5 id="Typedef"><a href="#Typedef" class="headerlink" title="Typedef"></a>Typedef</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># E.g.</span><br><span class="hljs-comment"># typedef float MyFoo;</span><br><br><span class="hljs-attr">typedef_foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">typedef</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">MyFoo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">'foo.h'</span>]<br>  <span class="hljs-attr">value:</span> <span class="hljs-string">float</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>typedef</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>æ–°åˆ›å»ºç±»å‹çš„åç§°ï¼ˆå¦‚ <code>MyFoo</code>ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä½¿ç”¨è¯¥ç±»å‹æ‰€éœ€çš„C++å¤´æ–‡ä»¶</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä½¿ç”¨è¯¥ç±»å‹æ‰€éœ€çš„Cå¤´æ–‡ä»¶</td></tr><tr><td><code>value</code></td><td><code>string</code></td><td><code>''</code></td><td>ç±»å‹çš„å€¼</td></tr></tbody></table><hr><h5 id="Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰"><a href="#Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰" class="headerlink" title="Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰"></a>Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">simple_float:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">simple</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">float</span><br>  <span class="hljs-attr">context_size:</span> <span class="hljs-number">4</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>simple</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>å†…ç½®ç±»å‹çš„åç§°ï¼ˆå¦‚ <code>float</code>ï¼‰</td></tr><tr><td><code>context_size</code></td><td><code>int</code></td><td><code>0</code></td><td>è¯¥ç±»å‹å­—èŠ‚å¤§å°</td></tr></tbody></table><h4 id="b-ç«¯ç‚¹å®šä¹‰"><a href="#b-ç«¯ç‚¹å®šä¹‰" class="headerlink" title="b. ç«¯ç‚¹å®šä¹‰"></a>b. ç«¯ç‚¹å®šä¹‰</h4><ul><li>ç«¯ç‚¹æœ‰ä¸¤ç§æŒ‡å®šæ–¹å¼ï¼š<ol><li>ï¼ˆè‡ªåŠ¨ï¼‰æä¾›C/C++å‡½æ•°ç­¾å</li><li>ï¼ˆæ‰‹åŠ¨ï¼‰æä¾›ç«¯ç‚¹å®šä¹‰å¯¹è±¡</li></ol></li></ul><h5 id="è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹"><a href="#è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹"></a>è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">doBar(Bar</span> <span class="hljs-string">*,</span> <span class="hljs-string">int)</span><br></code></pre></td></tr></tbody></table></figure><p>GraphFuzzä½¿ç”¨ä¸‹é¢çš„é€»è¾‘æ¥å†³å®šå¦‚ä½•è§£é‡Šç«¯ç‚¹ç­¾åï¼ˆç±»ä¼¼äºæ­£åˆ™åŒ¹é…ï¼‰ï¼š</p><table><thead><tr><th>condition</th><th>result</th></tr></thead><tbody><tr><td>in <code>methods</code> and matches <code>void &lt;name&gt;(...)</code>?</td><td>standard constructor</td></tr><tr><td>in <code>methods</code> and matches <code>void ~&lt;name&gt;(...)</code>?</td><td>destructor</td></tr><tr><td>in <code>methods</code>?</td><td>instance method</td></tr><tr><td>in <code>static_methods</code> and return type is <code>&lt;name&gt; *</code>?</td><td>static constructor</td></tr><tr><td>in <code>static_methods</code>?</td><td>static function</td></tr></tbody></table><h5 id="æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹"><a href="#æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹" class="headerlink" title="æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹"></a>æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">my_endpoint:</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>, <span class="hljs-string">'Bar'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Bar'</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">'int'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;doFoo($i1, $a0);</span><br><span class="hljs-string">        $o0 = $i1;</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>inputs</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>å®æ—¶è¾“å…¥ç±»å‹çš„åˆ—è¡¨</td></tr><tr><td><code>outputs</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>å®æ—¶è¾“å‡ºç±»å‹çš„åˆ—è¡¨</td></tr><tr><td><code>args</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä¸Šä¸‹æ–‡å‚æ•°åˆ—è¡¨ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨é•¿åº¦å›ºå®šçš„æ•°ç»„ï¼Œå¦‚ <code>int[10]</code> æˆ– <code>char[256]</code>ã€‚</td></tr><tr><td><code>exec</code></td><td><code>string</code></td><td><code>''</code></td><td>æ‰§è¡Œæ¨¡æ¿ (C/C++)ã€‚ <code>$(i/o/a)N</code> å®åˆ†åˆ«å¼•ç”¨ç¬¬Nä¸ªè¾“å…¥/è¾“å‡º/å‚æ•°å¯¹è±¡</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
